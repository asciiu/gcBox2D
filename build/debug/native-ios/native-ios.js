CACHE={"resources/fonts/fontsheetSizeMap.json":"{}","spritesheets/spritesheetSizeMap.json":"{}","spritesheets/map.json":"{\"resources/splash/HOWTO.md\":{},\"resources/icons/icon512.png\":{},\"resources/icons/ios72.png\":{},\"resources/icons/android72.png\":{},\"resources/icons/android96.png\":{},\"resources/icons/metadata.json\":{},\"resources/icons/ios144.png\":{},\"resources/icons/ios57.png\":{},\"resources/icons/ios114.png\":{},\"resources/icons/android36.png\":{},\"resources/icons/android48.png\":{},\"resources/fonts/metadata.json\":{},\"resources/splash/metadata.json\":{}}"};
// Copyright (c) 2010
// Michael Carter (cartermichael@gmail.com)
// Martin Hunt (mghunt@gmail.com)
// 
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
// 
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.

// Initialization of js.io occurs in a closure, preventing local variables
// from entering the global scope.  During execution, the method `jsio` is
// added to the global scope.

;(function() {
	function init(cloneFrom) {
		// We expect this code to be minified before production use, so we may
		// write code slightly more verbosely than we otherwise would.
	
		// Should we parse syntax errors in the browser?
		var DEBUG = true;
	
		// Store a reference to the slice function for converting objects of
		// type arguments to type array.
		var SLICE = Array.prototype.slice;
	
		// js.io supports multiple JavaScript environments such as node.js and
		// most web browsers (IE, Firefox, WebKit).  The ENV object wraps 
		// any utility functions that contain environment-specific code (e.g.
		// reading a file using node's `fs` library or a browser's
		// `XMLHttpRequest`).  Running js.io in other JavaScript environments
		// is as easy as implementing an environment object that conforms to 
		// the abstract interface for an environment (provided below) and 
		// calling `jsio.setEnv()`.
		var ENV;
	
		// Checks if the last character in a string is `/`.
		var rexpEndSlash = /\/|\\$/;

		function getModuleDef (path) {
			path += '.js';
			return jsio.__modules[path] || new ModuleDef(path);
		}
	
		// Creates an object containing metadata about a module.
		function ModuleDef (path) {
			this.path = path;
			this.friendlyPath = path;
			util.splitPath(path, this);
		};

		ModuleDef.prototype.setBase = function (baseMod, basePath) {
			this.baseMod = baseMod;
			this.basePath = basePath;
		};
	
		// Utility functions
		var util = {
				// `util.bind` returns a function that, when called, will execute
				// the method passed in with the provided context and any additional
				// arguments passed to `util.bind`.
				//       util.bind(obj, 'f', a) -> function() { return obj.f(a); }
				//       util.bind(obj, g, a, b, c) -> function() { return g.call(g, a, b, c); }
				bind: function(context, method/*, args... */) {
					var args = SLICE.call(arguments, 2);
					return function() {
						method = (typeof method == 'string' ? context[method] : method);
						return method.apply(context, args.concat(SLICE.call(arguments, 0)));
					};
				},
			
				// `util.addEndSlash` accepts a string.  That string is returned with a `/`
				// appended if the string did not already end in a `/`.
				addEndSlash: function(str) {
					return rexpEndSlash.test(str) ? str : str + '/';
				},
			
				// `util.removeEndSlash` accepts a string.  It removes a trailing `/` if
				// one is found.
				removeEndSlash: function(str) {
					return str.replace(rexpEndSlash, '');
				},
			
				// `util.makeRelativePath` accepts two paths (strings) and returns the first path
				// made relative to the second.  Note: this function needs some work.  It currently
				// handles the most common use cases, but may fail in unexpected edge cases.
				// 
				//  - Simple case: if `path` starts with `relativeTo`, then we can strip `path` 
				// off the `relativeTo` part and we're done.
				//
				//         util.makeRelativePath('abc/def/', 'abc') -> 'def'
				//
				//  - Harder case: `path` starts with some substring of `relativeTo`.  We want to remove this substring and then add `../` for each remaining segment of `relativeTo`.
				//
				//         util.makeRelativePath('abc/def/', 'abc/hij') -> '../def'
				//
				makeRelativePath: function(path, relativeTo) {
					var len = relativeTo.length;
					if (path.substring(0, len) == relativeTo) {
						/* Note: we're casting a boolean to an int by adding len to it */
						return path.slice((path.charAt(len) == ENV.pathSep) + len);
					}
				
					var sA = util.removeEndSlash(path).split(ENV.pathSep),
						sB = util.removeEndSlash(relativeTo).split(ENV.pathSep),
						i = 0;
				
					/* Count how many segments match. */
					while(sA[i] == sB[i]) { ++i; }
				
					if (i) {
						/* If at least some segments matched, remove them.  The result is our new path. */
						path = sA.slice(i).join(ENV.pathSep);
					
						/* Prepend `../` for each segment remaining in `relativeTo`. */
						for (var j = sB.length - i; j > 0; --j) { path = '../' + path; }
					}
				
					return path;
				},
			
				// `buildPath` accepts an arbitrary number of string arguments to concatenate into a path.
				//     util.buildPath('a', 'b', 'c/', 'd/') -> 'a/b/c/d/'
				buildPath: function() {
					var args = Array.prototype.filter.call(arguments, function (x) { return x; });
					return util.resolveRelativePath(args.join('/'));
				},
			
				// `resolveRelativePath` removes relative path indicators.  For example:
				//     util.resolveRelativePath('a/../b') -> b
				resolveRelativePath: function(path) {
					/* If the path starts with a protocol, store it and remove it (add it
					   back later) so we don't accidently modify it. */
					var protocol = path.match(/^(\w+:\/\/)(.*)$/);
					if (protocol) { path = protocol[2]; }
				
					/* Remove multiple slashes and trivial dots (`/./ -> /`). */
					path = path.replace(/\/+/g, '/').replace(/\/\.\//g, '/');
				
					/* Loop to collapse instances of `../` in the path by matching a previous
					   path segment.  Essentially, we find substrings of the form `/abc/../`
					   where abc is not `.` or `..` and replace the substrings with `/`.
					   We loop until the string no longer changes since after collapsing
					   possible instances once, we may have created more instances that can
					   be collapsed.
					*/
					var o;
					while((o = path) != (path = path.replace(/(^|\/)(?!\.?\.\/)([^\/]+)\/\.\.\//g, '$1'))) {}
					/* Don't forget to prepend any protocol we might have removed earlier. */
					return protocol ? protocol[1] + path : path;
				},
			
				resolveRelativeModule: function (modulePath, directory) {
					var result = [],
						parts = modulePath.split('.'),
						len = parts.length,
						relative = (len > 1 && !parts[0]),
						i = relative ? 0 : -1;
				
					while(++i < len) { result.push(parts[i] ? parts[i] : '..'); }
					return util.buildPath(relative ? directory : '', result.join('/'));
				},
				resolveModulePath: function (modulePath, directory) {
					// resolve relative paths
					if (modulePath.charAt(0) == '.') {
						return [getModuleDef(util.resolveRelativeModule(modulePath, directory))];
					}
				
					// resolve absolute paths with respect to jsio packages/
					var pathSegments = modulePath.split('.');
					var baseMod = pathSegments[0];
					var pathString = pathSegments.join('/');
					
					if (jsioPath.cache.hasOwnProperty(baseMod)) {
						return [getModuleDef(util.buildPath(jsioPath.cache[baseMod], pathString))];
					}
				
					var defs = [];
					var paths = jsioPath.get();
					var len = paths.length;
					for (var i = 0; i < len; ++i) {
						var moduleDef = getModuleDef(util.buildPath(paths[i], pathString));
						moduleDef.setBase(baseMod, paths[i]);
						defs.push(moduleDef);
					}
					return defs;
				},
				splitPath: function(path, result) {
					if (!result) { result = {}; }
					var i = path.lastIndexOf('/') + 1;
					result.directory = path.substring(0, i);
					result.filename = path.substring(i);
					return result;
				}
			};
		
		// construct the top-level jsio object
		var jsio = util.bind(this, importer, null, null, null);

		jsio.__util = util;
		jsio.__init__ = init;

		var srcCache;
		jsio.setCache = function(cache) { srcCache = jsio.__srcCache = cache; }
		jsio.setCache(cloneFrom && cloneFrom.__srcCache || {});

		jsio.setCachedSrc = function(path, src) { srcCache[path] = { path: path, src: src }; }
		jsio.getCachedSrc = function(path) { return srcCache[path]; }

		jsio.__filename = 'jsio.js';
		jsio.__cmds = [];
		jsio.__jsio = jsio;
		jsio.__importer = importer;
		jsio.__modules = {preprocessors:{}};
		var jsioPath = {
				set: function(path) { jsioPath.value = (typeof path == 'string' ? [path] : path); },
				get: function() { return jsioPath.value.slice(0); },
				add: function(path) {
					var v = jsioPath.value, len = v.length;
					for (var i = 0; i < len; ++i) {
						if (v[i] == path) { return; }
					}
					v.push(path);
				},
				remove: function(path) {
					var v = jsioPath.value, len = v.length;
					for (var i = 0; i < len; ++i) {
						if (v[i] == path) {
							v.splice(i, 1);
						}
					}
				},
				value: [],
				cache: {}
			};
		
		jsio.path = jsioPath;
		jsio.addPath = util.bind(jsioPath, 'add');
		jsio.addCmd = util.bind(jsio.__cmds, 'push');
		
		jsio.setEnv = function(envCtor) {
			if (!envCtor && cloneFrom) {
				ENV = new cloneFrom.__env.constructor(util);
			} else {
				if (typeof envCtor == 'string') {
					envCtor = ({
							node: ENV_node,
							browser: ENV_browser
						})[envCtor] || ENV_browser;
				}

				ENV = new envCtor(util);
			}

			this.__env = ENV;
			this.__dir = ENV.getCwd();
			this.path.set(ENV.getPath());
		}
		
		if (cloneFrom) {
			jsio.setEnv();
		} else if (typeof process !== 'undefined' && process.version) {
			jsio.setEnv('node');
		} else if (typeof XMLHttpRequest != 'undefined' || typeof ActiveXObject != 'undefined') {
			jsio.setEnv('browser');
		}

		/*
		function ENV_abstract() {
			this.global = null;
			this.getCwd = function() {};
			this.getPath = function() {};
			this.eval = function(code, path) {};
			this.fetch = function(path) { return contentsOfPath; };
			this.log = function(args...) {};
		}
		*/
	
		function ENV_node() {
			var fs = require('fs');
			var path = require('path');
			
			this.name = 'node';
			this.global = GLOBAL;
			this.getCwd = process.cwd;
			this.pathSep = path.sep;

			this.log = function() {
				var msg;
				try {
					msg = Array.prototype.map.call(arguments, function(a) {
							if ((a instanceof Error) && a.message) {
								return 'Error:' + a.message + '\nStack:' + a.stack + '\nArguments:' + a.arguments;
							}
							return (typeof a == 'string' ? a : JSON.stringify(a));
						}).join(' ') + '\n';
				} catch(e) {
					msg = Array.prototype.join.call(arguments, ' ') + '\n';
				}

				process.stderr.write(msg);
				return msg;
			}
			
			this.getPath = function() {
				return path.relative(this.getCwd(), path.dirname(__filename) || '.');
			}
			
			if (process.compile) {
				this.eval = process.compile;
			} else {
				var vm = require('vm');
				this.eval = function (code, path) {
					try {
						return vm.runInThisContext(code, path);
					} catch (e) {
						this.log('In ' + path + ':\n' + e.message);
						throw e;
					}
				}
			}
			
			this.fetch = function (p) {
				p = path.resolve(this.getCwd(), p);

				try {
					var dirname = path.dirname(p);
					var filename = path.basename(p);
					var lowerFilename = filename.toLowerCase();
					var files = fs.readdirSync(dirname);
				} catch (e) {
					return false;
				}

				for (var i = 0, testName; testName = files[i]; ++i) {
					if (testName.toLowerCase() == lowerFilename && testName != filename) {
						throw "Invalid case when importing [" + p + "].  You probably meant" + testName;
					}
				}

				try {
					return fs.readFileSync(p, 'utf8');
				} catch(e) {
					return false;
				}
			}
			
			this.require = require;
		}
	
		function ENV_browser() {
			var XHR = window.XMLHttpRequest || function() { return new ActiveXObject("Msxml2.XMLHTTP"); },
				cwd = null,
				path = null,
				JOIN = Array.prototype.join;
			
			this.name = 'browser';
			this.global = window;
			this.pathSep = "/";

			if (!this.global.jsio) { this.global.jsio = jsio; }
		
			if (window.console && console.log) {
				if (!console.log.apply || /Android|iPhone|iPad|iPod/.test(navigator.userAgent)) {
					this.log = function () {
						var args = JOIN.call(arguments, ' ');
						console.log(args);
						return args;
					}
				} else {
					this.log = function () {
						console.log.apply(console, arguments);
						return JOIN.call(arguments, ' ');
					}
				}
			} else {
				this.log = function () { return JOIN.call(arguments, ' '); }
			}

			this.getCwd = function() {
				if(!cwd) {
					var loc = window.location, path = loc.pathname;
					cwd = loc.protocol + '//' + loc.host + path.substring(0, path.lastIndexOf('/') + 1);
				}
				return cwd;
			}
		
			this.getPath = function() {
				if(!path) {
					try {
						var filename = new RegExp('(.*?)' + jsio.__filename + '(\\?.*)?$'),
							scripts = document.getElementsByTagName('script');
					
						for (var i = 0, script; script = scripts[i]; ++i) {
							var result = script.src.match(filename);
							if (result) {
								path = result[1];
								if (/^[A-Za-z]*:\/\//.test(path)) { path = util.makeRelativePath(path, this.getCwd()); }
								break;
							}
						}
					} catch(e) {}
				
					if(!path) { path = '.'; }
				}
				return path;
			}
		
			this.debugPath = function(path) { return path; }

			// IE6 won't return an anonymous function from eval, so use the function constructor instead
			var rawEval = typeof eval('(function(){})') == 'undefined'
				? function(src, path) { return (new Function('return ' + src))(); }
				: function(src, path) { var src = src + '\n//@ sourceURL=' + path; return window.eval(src); };

			// provide an eval with reasonable debugging
			this.eval = function(code, path, origCode) {
				try {
					return rawEval(code, this.debugPath(path));
				} catch(e) {
					if(e instanceof SyntaxError) {
						ENV.log("a syntax error is preventing execution of " + path);
						if (DEBUG && this.checkSyntax) {
							this.checkSyntax(origCode, path);
						}
					}
					throw e;
				}
			}
		
			this.checkSyntax = function(code, path) {
				try {
					var syntax = jsio('import util.syntax', {suppressErrors: true, dontExport: true}),
						result = syntax(code);
					syntax.display(result, path);
				} catch(e) {}
			}
		
			this.fetch = function(path) {
				var xhr = new XHR();
				try {
					xhr.open('GET', path, false);
					xhr.send(null);
				} catch(e) {
					ENV.log('e:', e);
					return false; // firefox file://
				}
			
				if (xhr.status == 404 || // all browsers, http://
					xhr.status == -1100 || // safari file://
					// XXX: We have no way to tell in opera if a file exists and is empty, or is 404
					// XXX: Use flash?
					//(!failed && xhr.status == 0 && !xhr.responseText && EXISTS)) // opera
					false)
				{
					return false;
				}
			
				return xhr.responseText;
			}
		};
	
		var preprocessorCheck = /^"use (.*?)"\s*;\s*\n/,
			preprocessorFunc = /^(.+)\(.+\)$/,
			failedFetch = {};
	
		function findModule(possibilities, opts) {
			var src;
			for (var i = 0, possible; possible = possibilities[i]; ++i) {
				var path = possible.path,
					cachedVersion = srcCache[path];
				
				if (cachedVersion) {
					possible.src = cachedVersion.src;
					possible.pre = true;
					return possible;
				}
			
				/*if (/^\.\//.test(path)) {
					// remove one path segment for each dot from the cwd 
					path = addEndSlash(ENV.getCwd()) + path;
				}*/
			
				src = ENV.fetch(path);
			
				if (src !== false) {
					possible.src = src;
					return possible;
				} else {
					failedFetch[path] = true;
				}
			}
		
			return false;
		}
	
		// load a module from a file
		function loadModule (fromDir, fromFile, modulePath, opts) {
			var possibilities = util.resolveModulePath(modulePath, fromDir);
			for (var i = 0, p; p = possibilities[i]; ++i) {
				var path = possibilities[i].path;
				if (!opts.reload && (path in jsio.__modules)) {
					return possibilities[i];
				}

				if (path in failedFetch) { possibilities.splice(i--, 1); }
			}
		
			if (!possibilities.length) {
				if (opts.suppressErrors) { return false; }
				var e = new Error('Module failed to load (again)');
				e.jsioLogged = true;
				throw e;
			}
		
			var moduleDef = findModule(possibilities, opts),
				match;
		
			if (!moduleDef) {
				if (opts.suppressErrors) { return false; }
				var paths = [];
				for (var i = 0, p; p = possibilities[i]; ++i) { paths.push(p.path); }
				throw new Error(
					"requested import (" + modulePath + ") not found\n"
					+ "\tlooked in:\n"
						+ "\t\t" + paths.join('\n\t\t') + "\n"
						+ "\tImport Stack:\n"
						+ "\t\t" + importStack.join("\n\t\t"));
			}
		
			// a (potentially) nicer way to refer to a module -- how it was referenced in code when it was first imported
			moduleDef.friendlyPath = modulePath;
			
			// cache the base module's path in the path cache so we don't have to
			// try out all paths the next time we see the same base module.
			if (moduleDef.baseMod && !(moduleDef.baseMod in jsioPath.cache)) {
				jsioPath.cache[moduleDef.baseMod] = moduleDef.basePath;
			}

			// don't apply the standard preprocessors to base.js.  If we're reloading
			// the source code, always apply them.  We also don't want to run them
			// if they've been run once -- moduleDef.pre is set to true already
			// if we're reading the code from the source cache.
			if (modulePath != 'base' && (opts.reload || !opts.dontPreprocess && !moduleDef.pre)) {
				moduleDef.pre = true;

				applyPreprocessors(fromDir, moduleDef, ["import", "cls"], opts);

				// the order here is somewhat arbitrary and might be overly restrictive (... or overly powerful)
				// while (moduleDef.src.charAt(0) == '"' && (match = moduleDef.src.match(preprocessorCheck))) {
				// 	moduleDef.src = moduleDef.src.substring(match[0].length - 1);
				// 	applyPreprocessors(fromDir, moduleDef, match[1].split(','), opts);
				// }
			}

			// any additional preprocessors?
			if (opts.preprocessors) {
				applyPreprocessors(fromDir, moduleDef, opts.preprocessors, opts);
			}

			return moduleDef;
		}
	
		function applyPreprocessors(path, moduleDef, names, opts) {
			for (var i = 0, len = names.length; i < len; ++i) {
				p = getPreprocessor(names[i]);

				// if we have a recursive import and p isn't a function, just
				// skip it (handles the case where a preprocessor imports
				// other modules).
				if (p && typeof p == 'function') {
					p(path, moduleDef, opts);
				}
			}
		}
		
		function getPreprocessor(name) {
			var module = jsio.__modules['preprocessors.' + name];
			return typeof name == 'function'
				? name
				: (module && module.exports
					|| jsio('import preprocessors.' + name, {dontExport: true, dontPreprocess: true}));
		}
	
		function execModuleDef(context, moduleDef) {
			var src = moduleDef.src;
			delete moduleDef.src;

			var code = "(function(_){with(_){delete _;return function $$" + moduleDef.friendlyPath.replace(/[\:\\\/.-]/g, '_') + "(){" + src + "\n}}})";
			var fn = ENV.eval(code, moduleDef.path, src);
			fn = fn(context);
			fn.call(context.exports);
		};
		
		function resolveImportRequest(context, request, opts) {
			var cmds = jsio.__cmds,
				imports = [],
				result = false;
		
			for (var i = 0, imp; imp = cmds[i]; ++i) {
				if ((result = imp(context, request, opts, imports))) { break; }
			}
		
			if (result !== true) {
				throw new (typeof SyntaxError != 'undefined' ? SyntaxError : Error)(String(result || 'invalid jsio command: jsio(\'' + request + '\')'));
			}
		
			return imports;
		};
	
		function makeContext(ctx, modulePath, moduleDef, dontAddBase) {
			if (!ctx) { ctx = {}; }
			if (!ctx.exports) { ctx.exports = {}; }

			ctx.jsio = util.bind(this, importer, ctx, moduleDef.directory, moduleDef.filename);
			ctx.require = function(request, opts) {
				if (!opts) { opts = {}; }
				opts.dontExport = true;
				// opts.suppressErrors = true;
				
				try {
					var ret = ctx.jsio(request, opts);
					if (ret === false) {
						// need this to trigger require attempt due to suppresserrors = true
						throw "module failed to load";
					} else {
						return ret;
					}
				} catch(e) {
					ENV.log('Error loading request ' + request + ':');
					ENV.log(e);
				}
			};
			
			ctx.module = {id: modulePath, exports: ctx.exports};
			if (!dontAddBase && modulePath != 'base') {
				ctx.jsio('from base import *', {dontPreprocess: true});
				ctx.logging.__create(modulePath, ctx);
			}
		
			// TODO: FIX for "trailing ." case
			ctx.jsio.__jsio = jsio;
			ctx.jsio.__env = jsio.__env;
			ctx.jsio.__dir = moduleDef.directory;
			ctx.jsio.__filename = moduleDef.filename;
			ctx.jsio.path = jsioPath;
			return ctx;
		};
		
		var importStack = [];
		function importer(boundContext, fromDir, fromFile, request, opts) {
			opts = opts || {};
			fromDir = fromDir || './';
			fromFile = fromFile || '<initial file>';
		
			// importer is bound to a module's (or global) context -- we can override this
			// by using opts.exportInto
			var exportInto = opts.exportInto || boundContext || ENV.global;
		
			// parse the import request(s)
			var imports = resolveImportRequest(exportInto, request, opts),
				numImports = imports.length,
				retVal = numImports > 1 ? {} : null;
		
			// import each requested item
			for (var i = 0; i < numImports; ++i) {
				var item = imports[i];
				var modulePath = item.from;
				var modules = jsio.__modules;
				var path;
				var moduleDef;
				var err;
				
				try {
					moduleDef = loadModule(fromDir, fromFile, modulePath, opts);
				} catch(e) {
					err = e;
				}

				if (moduleDef) {
					path = moduleDef.path;
				} else if (jsio.__env.require) {
					path = modulePath;
					try {
						modules[path] = {exports: jsio.__env.require(modulePath)};
						err = null;
					} catch (e2) {
						if (!err) { err = e2; }
					}
				} else if (moduleDef == false) {
					return false;
				}

				if (err) {
					if (opts.suppressErrors) { return false; }
					if (!err.jsioLogged) {
						ENV.log(
							'\nError loading module:\n',
							'\t[[', request, ']]\n',
							'\trequested by:', fromDir + fromFile, '\n',
							'\tcurrent directory:', jsio.__env.getCwd(), '\n',
							'\t' + err, '\n',
							'\t' + err.stack);
						err.jsioLogged = true;
					}

					throw err;
				}
				
				if (moduleDef) {
					importStack.push(importStack.length + ' : ' + moduleDef.friendlyPath + ' (' + moduleDef.path + ')');
				}
				
				// eval any packages that we don't know about already
				if (!(path in modules)) {
					var newContext = makeContext(opts.context, modulePath, moduleDef, item.dontAddBase);

					modules[path] = moduleDef;

					moduleDef.exports = newContext.exports;
					if (item.dontUseExports) {
						var src = [';(function(){'], k = 1;
						for (var j in item['import']) {
							newContext.exports[j] = undefined;
							src[k++] = 'if(typeof '+j+'!="undefined"&&exports.'+j+'==undefined)exports.'+j+'='+j+';';
						}
						src[k] = '})();';
						moduleDef.src += src.join('');
					}

					execModuleDef(newContext, moduleDef);
					moduleDef.exports = newContext.exports;
				}
				
				importStack.pop();
			
				var module = modules[path].exports;
			
				// return the module if we're only importing one module
				if (numImports == 1) { retVal = module; }
			
				if (!opts.dontExport) {
					// add the module to the current context
					if (item.as) {
						// remove trailing/leading dots
						var as = item.as.match(/^\.*(.*?)\.*$/)[1],
							segments = as.split('.'),
							kMax = segments.length - 1,
							c = exportInto;
				
						// build the object in the context
						for(var k = 0; k < kMax; ++k) {
							var segment = segments[k];
							if (!segment) continue;
							if (!c[segment]) { c[segment] = {}; }
							c = c[segment];
						}
					
						c[segments[kMax]] = module;
				
						// there can be multiple module imports with this syntax (import foo, bar)
						if (numImports > 1) {
							retVal[as] = module;
						}
					} else if (item['import']) {
						// there can only be one module import with this syntax 
						// (from foo import bar), so retVal will already be set here
						if (item['import']['*']) {
							for (var k in modules[path].exports) { exportInto[k] = module[k]; }
						} else {
							for (var k in item['import']) { exportInto[item['import'][k]] = module[k]; }
						}
					}
				}
			}
		
			return retVal;
		}
	
		// DEFINE SYNTAX FOR JSIO('cmd')
	
		// from myPackage import myFunc
		// external myPackage import myFunc
		jsio.addCmd(function(context, request, opts, imports) {
			var match = request.match(/^\s*(from|external)\s+([\w.$]+)\s+(import|grab)\s+(.*)$/);
			if(match) {
				imports.push({
					from: match[2],
					dontAddBase: match[1] == 'external',
					dontUseExports: match[3] == 'grab' || match[1] == 'external',
					'import': {}
				});
			
				match[4].replace(/\s*([\w.$*]+)(?:\s+as\s+([\w.$]+))?/g, function(_, item, as) {
					imports[0]['import'][item] = as || item;
				});
				return true;
			}
		});

		// import myPackage
		jsio.addCmd(function(context, request, opts, imports) {
			var match = request.match(/^\s*import\s+(.*)$/);
			if (match) {
				match[1].replace(/\s*([\w.$]+)(?:\s+as\s+([\w.$]+))?,?/g, function(_, fullPath, as) {
					imports.push(
						as ? {
							from: fullPath,
							as: as
						} : {
							from: fullPath,
							as: fullPath
						});
				});
				return true;
			}
		});

		// CommonJS syntax
		jsio.addCmd(function(context, request, opts, imports) {
		
			//		./../b -> ..b
			// 		../../b -> ...b
			// 		../b -> ..b
			// 		./b -> .b
		
			var match = request.match(/^\s*[\w.0-9$\/\-]+\s*$/);
			if (match) {
			
				var req = util.resolveRelativePath(match[0]),
					isRelative = req.charAt(0) == '.';
			
				req = req
					// .replace(/^\//, '') // remove any leading slash
					.replace(/\.\.\//g, '.') // replace relative path indicators with dots
					.replace(/\.\//g, '')
					.replace(/\//g, '.'); // any remaining slashes are path separators

				imports[0] = { from: (isRelative ? '.' : '') + req };
				return true;
			}
		});
		
		jsio.install = function() {
			jsio('from base import *');
			GLOBAL['logger'] = logging.get('jsiocore');
		};

		jsio.eval = function (src, path) {
			path = ENV.getCwd() || '/';
			var moduleDef = new ModuleDef(path);
			moduleDef.src = src;
			applyPreprocessors(path, moduleDef, ["import", "cls"], {});
			execModuleDef(ENV.global, moduleDef);
		};
		
		jsio.clone = util.bind(null, init, jsio);

		return jsio;
	}

	var J = init(null, {});
	if (typeof exports != 'undefined') {
		module.exports = J;
	} else {
		jsio = J;
	}
})();
jsio.path.set(["sdk/jsio",".","sdk/gc/api/","sdk/","sdk/timestep/"]);jsio.path.cache={"preprocessors":"sdk/jsio","base":"sdk/jsio","util":"sdk/jsio","gc":"sdk/","device":"sdk/timestep/","event":"sdk/timestep/","lib":"sdk/jsio","ui":"sdk/timestep/","std":"sdk/jsio","platforms":"sdk/timestep/","math":"sdk/jsio","timer":"sdk/timestep/","animate":"sdk/timestep/","squill":"sdk/","AudioManager":"sdk/timestep/","net":"sdk/jsio","src":"."};jsio.setCache({"sdk/jsio/base.js":{"path":"sdk/jsio/base.js","friendlyPath":"base","directory":"sdk/jsio/","filename":"base.js","baseMod":"base","basePath":"sdk/jsio","src":"/**\n * base.js\n * This file contains all global functions provided by js.io.\n */\n\nexports.log = jsio.__env.log;\nexports.GLOBAL = jsio.__env.global;\n\n/**\n * Various polyfill methods to ensure js.io implementations provide\n * a baseline of JavaScript functionality. Feature compatibility (localStorage,\n * etc.) should be provided elsewhere.\n */\n\n// Array.isArray\n// Not available before ECMAScript 5.\n// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/isArray\n\nif (!Array.isArray) {\n\tArray.isArray = function (arg) {\n\t\treturn Object.prototype.toString.call(arg) === '[object Array]';\n\t}\n};\n\n// Function.prototype.bind\n// Not available before ECMAScript 5.\n// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Function/bind\n\nif (!Function.prototype.bind) {\n  Function.prototype.bind = function (oThis) {\n    if (typeof this !== \"function\") {\n      // closest thing possible to the ECMAScript 5 internal IsCallable function\n      throw new TypeError(\"Function.prototype.bind - what is trying to be bound is not callable\");\n    }\n\n    var aArgs = Array.prototype.slice.call(arguments, 1), \n        fToBind = this, \n        fNOP = function () {},\n        fBound = function () {\n          return fToBind.apply(this instanceof fNOP\n                                 ? this\n                                 : oThis,\n                               aArgs.concat(Array.prototype.slice.call(arguments)));\n        };\n\n    fNOP.prototype = this.prototype;\n    fBound.prototype = new fNOP();\n\n    return fBound;\n  };\n}\n\n/**\n * DEPRECATED. Old js.io polyfills.\n */\n\nvar SLICE = Array.prototype.slice;\n\n/* Use native isArray if available\n */\nif (typeof Array.isArray === 'function') {\n\texports.isArray = Array.isArray;\n} else {\n\texports.isArray = function (obj) {\n\t\treturn Object.prototype.toString.call(obj) === '[object Array]';\n\t}\n}\n\nexports.bind = function(context, method /*, VARGS*/) {\n\tif(arguments.length > 2) {\n\t\tvar args = SLICE.call(arguments, 2);\n\t\treturn typeof method == 'string'\n\t\t\t? function __bound() {\n\t\t\t\tif (context[method]) {\n\t\t\t\t\treturn context[method].apply(context, args.concat(SLICE.call(arguments, 0)));\n\t\t\t\t} else {\n\t\t\t\t\tthrow logger.error('No method:', method, 'for context', context);\n\t\t\t\t}\n\t\t\t}\n\t\t\t: function __bound() { return method.apply(context, args.concat(SLICE.call(arguments, 0))); }\n\t} else {\n\t\treturn typeof method == 'string'\n\t\t\t? function __bound() {\n\t\t\t\tif (context[method]) {\n\t\t\t\t\treturn context[method].apply(context, arguments);\n\t\t\t\t} else {\n\t\t\t\t\tthrow logger.error('No method:', method, 'for context', context);\n\t\t\t\t}\n\t\t\t}\n\t\t\t: function __bound() { return method.apply(context, arguments); }\n\t}\n}\n\n/**\n * Class constructor.\n */\n\nexports.Class = function(name, parent, proto) {\n\treturn exports.__class__(function() { return this.init && this.init.apply(this, arguments); }, name, parent, proto);\n}\n\nexports.__class__ = function (cls, name, parent, proto) {\n\tvar clsProto = function () {};\n\tvar logger;\n\n\tif (typeof name != 'string') {\n\t\tproto = parent;\n\t\tparent = name;\n\t\tname = null;\n\t}\n\n\tif (name) {\n\t\tlogger = exports.logging.get(name);\n\t}\n\n\tif (!parent) { throw new Error('parent or prototype not provided'); }\n\tif (!proto) { proto = parent; parent = null; }\n\n\tif (parent) {\n\t\tif (exports.isArray(parent)) { // multiple inheritance, use at your own risk =)\n\t\t\tclsProto.prototype = {};\n\t\t\tfor(var i = 0, p; p = parent[i]; ++i) {\n\t\t\t\tif (p == Error && ErrorParentClass) { p = ErrorParentClass; }\n\t\t\t\tfor (var item in p.prototype) {\n\t\t\t\t\tif (!(item in clsProto.prototype)) {\n\t\t\t\t\t\tclsProto.prototype[item] = p.prototype[item];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tparent = parent[0];\n\t\t} else {\n\t\t\tif (parent == Error && ErrorParentClass) { parent = ErrorParentClass; }\n\t\t\tclsProto.prototype = parent.prototype;\n\t\t}\n\t}\n\t\n\tvar supr = parent ? function(context, method, args) {\n\t\t\tvar f = parent.prototype[method];\n\t\t\tif (!f) { throw new Error('method ' + method + ' does not exist'); }\n\t\t\treturn f.apply(context, args || []);\n\t\t} : null;\n\t\n\tvar p = cls.prototype = new clsProto();\n\tp.constructor = cls;\n\tp.__parentClass__ = parent;\n\tif (name) { p.__class__ = name; }\n\tproto.call(p, logger || supr, logger && supr);\n\treturn cls;\n}\n\nvar ErrorParentClass = exports.__class__(function ErrorCls() {\n\t\tvar err = Error.prototype.constructor.apply(this, arguments);\n\t\tfor (var prop in err) {\n\t\t\tif (err.hasOwnProperty(prop)) {\n\t\t\t\tthis[prop] = err[prop];\n\t\t\t}\n\t\t}\n\t}, function() {});\n\n/**\n * Merge two objects together.\n */\n\nexports.Class.defaults = \nexports.merge = function(base, extra) {\n\tbase = base || {};\n\t\n\tfor (var i = 1, len = arguments.length; i < len; ++i) {\n\t\tvar copyFrom = arguments[i];\n\t\tfor (var key in copyFrom) {\n\t\t\tif (copyFrom.hasOwnProperty(key) && !base.hasOwnProperty(key)) {\n\t\t\t\tbase[key] = copyFrom[key];\n\t\t\t}\n\t\t}\n\t}\n\t\n\treturn base;\n}\n\n/**\n * Create a timer delay.\n */\n\nexports.delay = function(orig, timeout) {\n\tvar _timer = null;\n\tvar ctx, args;\n\tvar f = function() { orig.apply(ctx, args); }\n\treturn function() {\n\t\tctx = this;\n\t\targs = arguments;\n\t\tif (_timer) { clearTimeout(_timer); }\n\t\t_timer = setTimeout(f, timeout || 0);\n\t}\n}\n\n/**\n * Log constructor and default \"logger\".\n */\n\nexports.logging = (function() {\n\t\n\t// logging namespace, this is what is exported\n\tvar logging = {\n\t\t\tDEBUG: 1,\n\t\t\tLOG: 2,\n\t\t\tINFO: 3,\n\t\t\tWARN: 4,\n\t\t\tERROR: 5,\n\t\t\tNONE: 10\n\t\t},\n\t\tloggers = {}, // effectively globals - all loggers and a global production state\n\t\tproduction = false;\n\tvar gPrefix = '';\n\tlogging.setPrefix = function(prefix) { gPrefix = prefix + ' '; }\n\tlogging.setProduction = function(prod) { production = !!prod; }\n\tlogging.get = function(name) {\n\t\treturn loggers.hasOwnProperty(name) ? loggers[name]\n\t\t\t: (loggers[name] = new Logger(name));\n\t}\n\tlogging.set = function(name, _logger) {\n\t\tloggers[name] = _logger;\n\t}\n\t\n\tlogging.getAll = function() { return loggers; }\n\n\tlogging.__create = function(pkg, ctx) { ctx.logger = logging.get(pkg); }\n\t\n\tvar Logger = exports.__class__(\n\t\tfunction Logger(name, level) {\n\t\t\tthis._name = name;\n\t\t\tthis._level = level || logging.LOG;\n\t\t},\n\t\tfunction () {\n\t\t\tthis.setLevel = function(level) { this._level = level; }\n\t\t\n\t\t\tfunction makeLogFunction(level, type) {\n\t\t\t\treturn function() {\n\t\t\t\t\tif (!production && level >= this._level) {\n\t\t\t\t\t\tvar prefix = type + ' ' + gPrefix + this._name,\n\t\t\t\t\t\t\tlistener = this._listener || exports.log;\n\t\t\t\t\t\t\n\t\t\t\t\t\treturn listener && listener.apply(this._listener, [prefix].concat(SLICE.call(arguments)));\n\t\t\t\t\t}\n\t\t\t\t\treturn arguments[0];\n\t\t\t\t}\n\t\t\t}\n\t\t\n\t\t\tthis.setListener = function(listener) { this._listener = listener; }\n\t\t\tthis.debug = makeLogFunction(logging.DEBUG, \"DEBUG\");\n\t\t\tthis.log = makeLogFunction(logging.LOG, \"LOG\");\n\t\t\tthis.info = makeLogFunction(logging.INFO, \"INFO\");\n\t\t\tthis.warn = makeLogFunction(logging.WARN, \"WARN\");\n\t\t\tthis.error = makeLogFunction(logging.ERROR, \"ERROR\");\n\t\t});\n\n\treturn logging;\n})();\n\nvar logger = exports.logging.get('jsiocore');\n"},"sdk/gc/browser/launchClient.js":{"path":"sdk/gc/browser/launchClient.js","friendlyPath":"gc.browser.launchClient","directory":"sdk/gc/browser/","filename":"launchClient.js","baseMod":"gc","basePath":"sdk/","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\njsio(\"import device\");\nvar isSimulator = device.isSimulator;\n\nif (isSimulator) {\n\t// prefix filenames in the debugger\n\tjsio.__env.debugPath = function (path) { return 'http://' + window.location.host + '/' + path; }\n\n\t// NATIVE will be simulated in this case\n} else {\n\tdevice.simulatingMobileNative = true;\n\tjsio(\"import gc.debugging.nativeShim\");\n}\n\n// shims\n\nif (!window.JSON) {\n\tjsio('import std.JSON').createGlobal();\n}\n\nif (!window.console) {\n\twindow.console = {};\n\twindow.console.log = window.console.info = window.console.error = window.console.warn = function () {};\n}\n\nif (!window.localStorage) {\n\twindow.localStorage = {\n\t\tgetItem: function () {},\n\t\tsetItem: function () {},\n\t\tremoveItem: function () {}\n\t}\n}\n\n// parsing options\njsio(\"import std.uri\");\nvar uri = new std.uri(window.location);\nvar mute = uri.hash('mute');\nCONFIG.isMuted = mute != undefined && mute != \"false\" && mute != \"0\" && mute != \"no\";\n\nif (DEBUG && isSimulator) {\n\t// device simulation\n\n\t// simulate device chrome, input, and userAgent\n\tvar sim_device = uri.query('device') || uri.hash('device');\n\tif (sim_device) {\n\t\t// hack to access SDK static resolutions file from a debug device\n\t\ttry {\n\t\t\tjsio(\"import preprocessors.import\");\n\t\t\tjsio(\"import preprocessors.cls\");\n\n\t\t\tjsio(\"import .simulateDevice\");\n\t\t\tvar resImport = \"import ....static.util.resolutions\";\n\t\t\tvar resolutions = jsio.__jsio(resImport);\n\n\t\t\tsimulateDevice.simulate(resolutions.get(sim_device));\n\t\t} catch (e) {\n\t\t\tlogger.error(e);\n\t\t}\n\t}\n\n\tjsio(\"import ..debugging.connect\");\n\tdebugging.connect.connect(null, function (conn) {\n\t\tconn.sendEvent('HANDSHAKE', {\n\t\t\ttype: 'simulator',\n\t\t\tport: window.location.port // used to identify the simulator\n\t\t});\n\n\t\tsetTimeout(bind(this, startApp, conn), 0);\n\t});\n} else {\n\tstartApp();\n}\n\nfunction startApp (conn) {\n\n\t// setup timestep device API\n\n\tjsio(\"import device\");\n\tjsio(\"import platforms.browser.initialize\");\n\tdevice.init();\n\n\t// logging\n\n\tif (isSimulator && conn) {\n\n\t\tjsio(\"import ..debugging.TimestepInspector\");\n\t\tconn.addClient(new debugging.TimestepInspector());\n\n\t\tvar initDebugging = function () {\n\t\t\tvar env = jsio.__env;\n\t\t\t\n\t\t\tvar originalSyntax = bind(env, env.checkSyntax);\n\t\t\tvar originalFetch = bind(env, env.fetch);\n\n\t\t\tenv.fetch = function (filename) {\n\t\t\t\tlogging.get('jsiocore').warn('LOADING EXTERNAL FILE:', filename);\n\t\t\t\treturn originalFetch.apply(this, arguments);\n\t\t\t}\n\t\t\t\n\t\t\tenv.checkSyntax = function (code, filename) {\n\t\t\t\tvar xhr = new XMLHttpRequest();\n\t\t\t\txhr.open('POST', '/.syntax', false);\n\t\t\t\txhr.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");\n\t\t\t\txhr.onreadystatechange = function () {\n\t\t\t\t\tif (xhr.readyState != 4) { return; }\n\t\t\t\t\n\t\t\t\t\tif (xhr.status == 200 && xhr.responseText) {\n\t\t\t\t\t\tvar err;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tvar response = JSON.parse(xhr.responseText);\n\t\t\t\t\t\t\terr = response[1];\n\t\t\t\t\t\t} catch(e) {\n\t\t\t\t\t\t\terr = xhr.responseText;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconsole.log(err);\n\t\t\t\t\t\t\n\t\t\t\t\t\tdocument.body.innerHTML = '<pre style=\\'margin-left: 10px; font: bold 12px Consolas, \"Bitstream Vera Sans Mono\", Monaco, \"Lucida Console\", Terminal, monospace; color: #FFF;\\'>'\n\t\t\t\t\t\t\t+ '<span style=\"color:#AAF\">' + filename + '</span>\\n\\n'\n\t\t\t\t\t\t\t+ err.map(function (e) {\n\t\t\t\t\t\t\t\t\tif (e.err) {\n\t\t\t\t\t\t\t\t\t\treturn '<span style=\"color:#F55\">' + e.err.replace(/error - parse error.\\s+/i, '') + '</span>\\n'\n\t\t\t\t\t\t\t\t\t\t\t+ ' <span style=\"color:#5F5\">' + e.line + '</span>: '\n\t\t\t\t\t\t\t\t\t\t\t\t+ ' <span style=\"color:#EEE\">' + e.code[0] + '</span>\\n'\n\t\t\t\t\t\t\t\t\t\t\t\t+ new Array(('' + e.line).length + 5).join(' ') + e.code[1];\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\treturn'<span style=\"color:#F55\">' + e.code.join('\\n') + '</span>';\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}).join('\\n')\n\t\t\t\t\t\t\t+ '</pre>';\n\t\t\t\t\t} else if (xhr.status > 0) {\n\t\t\t\t\t\toriginalSyntax(code, filename);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\n\t\t\t\txhr.send('javascript=' + encodeURIComponent(code));\n\t\t\t}\n\t\t};\n\n\t\tif (device.isMobileBrowser) {\n\t\t\tconn.initLogProxy();\n\t\t\tconn.initRemoteEval();\n\t\t}\n\n\t\tinitDebugging();\n\t}\n\n\t// init sets up the GC object\n\tjsio(\"import gc.API\");\n\tGC.buildApp('launchUI');\n\n\tif (isSimulator && conn) {\n\t\tconn.setApp(GC.app);\n\t}\n}\n","pre":true},"sdk/timestep/device.js":{"path":"sdk/timestep/device.js","friendlyPath":"device","directory":"sdk/timestep/","filename":"device.js","baseMod":"device","basePath":"sdk/timestep/","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @module device;\n *\n * Namespace for the current device. Determines what device we're running using\n * navigator.userAgent. This namespace exposes various properties about the\n * current device, such as screen size, mobile/browser, pixel ratios, etc.\n *\n * Using device.get('...') imports device-specific implementations from\n *   timestep.env.* by default, or from packages registered using\n *   registerDevice().\n * Using device.importUI('...') imports rendering classes for DOM or canvas.\n *\n * @doc http://doc.gameclosure.com/api/device.html\n * @docsrc https://github.com/gameclosure/doc/blob/master/api/device.md\n */\n\njsio(\"import event.Emitter as Emitter\");\njsio(\"import util.setProperty\");\n\nif (typeof navigator == 'undefined' || !navigator.userAgent) {\n\tlogger.warn('> Timestep was unable to determine your device! Please check that navigator.userAgent is defined.');\n\texports = {isUnknown: true};\n}\n\nvar ua = navigator.userAgent;\n\n/**\n * @namespace\n */\n\nvar _devices = {}\nexports.registerDevice = function (name, path) {\n\t_devices[name] = path;\n}\n\nexports.get = function (module) {\n\tvar path = _devices[exports.name] || 'platforms.browser';\n\treturn jsio('import ' + path + '.' + module, {dontExport: true, suppressErrors: true});\n};\n\nexports.importUI = function (module) {\n\treturn jsio('import ui.backend.' + (exports.useDOM ? 'dom' : 'canvas') + '.' + module, {dontExport: true, suppressErrors: true});\n};\n\nexports.isMobileNative = exports.isMobile = /TeaLeaf/.test(ua);\n\nlogger.log(exports.isMobile ? 'on mobile device' : 'in web browser');\n\nexports.screen = new Emitter();\n\nvar devicePixelRatio = window.devicePixelRatio || 1;\n\n// @deprecated\nexports.devicePixelRatio = devicePixelRatio;\n\nexports.screen.devicePixelRatio = devicePixelRatio;\nexports.screen.width = window.screen.width * devicePixelRatio;\nexports.screen.height = window.screen.height * devicePixelRatio;\n\n// This is stubbed out unless available on the current device.\nexports.hideAddressBar = function () {};\n\nutil.setProperty(exports, 'defaultFontFamily', {\n\tcb: function (value) {\n\t\tjsio(\"import ui.resource.Font\");\n\t\tui.resource.Font.setDefaultFontFamily(value);\n\t},\n\tvalue: 'Helvetica'\n});\nexports.defaultFontWeight = \"\";\n\nif ('ontouchstart' in window && (!/BlackBerry/.test(ua))) {\n\texports.events = {\n\t\tstart: 'touchstart',\n\t\tmove: 'touchmove',\n\t\tend: 'touchend'\n\t};\n} else {\n\texports.events = {\n\t\tstart: 'mousedown',\n\t\tmove: 'mousemove',\n\t\tend: 'mouseup'\n\t};\n}\n\nexports.isMobileBrowser = false;\nexports.isUIWebView = false;\nexports.isSafari = /Safari/.test(ua);\n\njsio(\"import std.uri\");\nuri = new std.uri(window.location);\nexports.isSimulator = !!(uri.query('device') || uri.hash('device'));\n\nif (exports.isSimulator) {\n\tvar urlStr = window.location.href.toLowerCase();\n\texports.isIOSSimulator = urlStr.indexOf('ipad') !== -1 || urlStr.indexOf('iphone') !== -1;\n\t\n\t// Until we support more platforms, if it's not\n\t// iOS then it's assumed to be an Android device\n\texports.isAndroidSimulator = !exports.isIOSSimulator;\n} else {\n\texports.isAndroidSimulator = false;\n\texports.isIOSSimulator = false;\n}\n\nif (exports.isMobile) {\n\texports.name = 'tealeaf';\n\texports.width = navigator.width;\n\texports.height = navigator.height;\n\texports.isAndroid = /Android/.test(ua);\n\tif (exports.isAndroid) {\n\t\texports.isTablet = navigator.width/devicePixelRatio >= 600;\n\t} else {\n\t\texports.isIPad = exports.isTablet = /iPad/.test(ua);\n\t\texports.isIPhone = /iPhone/.test(ua);\n\n\t\t// Until we support more platforms, if it's not\n\t\t// Android then it's assumed to be an iOS device\n\t\texports.isIOS = true;\n\t}\n} else {\n\tif (/(iPod|iPhone|iPad)/i.test(ua)) {\n\t\texports.name = 'browser';\n\t\texports.isMobileBrowser = true;\n\t\texports.isIOS = true;\n\n\t\tvar match = ua.match(/iPhone OS ([0-9]+)/);\n\t\texports.iosVersion = match && parseInt(match[1]);\n\t\texports.isUIWebView = !exports.isSafari;\n\n\t\texports.screen.defaultOrientation = 'portrait';\n\t\texports.screen.browserChrome = {\n\t\t\tportrait: {top: 20 * devicePixelRatio, bottom: 44 * devicePixelRatio},\n\t\t\tlandscape: {top: 20 * devicePixelRatio, bottom: 32 * devicePixelRatio}\n\t\t};\n\n\t} else if (/Mobile Safari/.test(ua) || /Android/.test(ua) || /BlackBerry/.test(ua)) {\n\t\texports.name = 'browser';\n\t\texports.isMobileBrowser = true;\n\t\texports.isAndroid = true;\n\n\t\texports.screen.width = window.outerWidth;\n\t\texports.screen.height = window.outerHeight - 1;\n\n\t\texports.screen.defaultOrientation = 'portrait';\n\t\texports.screen.browserChrome = {\n\t\t\tportrait: {top: 0, bottom: 0},\n\t\t\tlandscape: {top: 0, bottom: 0}\n\t\t};\n\t} else {\n\t\t// All other browsers\n\t\texports.screen.width = window.innerWidth;\n\t\texports.screen.height = window.innerHeight;\n\t\texports.name = 'browser';\n\t\texports.canResize = false;\n\t}\n\n\t// Set up device.width and device.height for browser case\n\texports.width = exports.screen.width;\n\texports.height = exports.screen.height;\n}\n\nexports.useDOM = false;\nexports.setUseDOM = function (useDOM) {\n\t// if (exports.useDOM != useDOM) {\n\t// \texports.useDOM = useDOM;\n\n\t// \timport ui.View as View;\n\t// \tvar backing = exports.importUI('ViewBacking');\n\t// \tView.setDefaultViewBacking(backing);\n\t// }\n}\n\nexports.getDimensions = function (isLandscape) {\n\tvar dMin = Math.min(exports.width, exports.height),\n\t\tdMax = Math.max(exports.width, exports.height);\n\n\treturn isLandscape\n\t\t? {height: dMin, width: dMax}\n\t\t: {height: dMax, width: dMin};\n}\n\n/**\n * Initialize the device. Called from somewhere else.\n */\n\nexports.init = function () {\n\tjsio(\"import ui.init\");\n\texports.get('initialize').init();\n\texports.screen.width = exports.width;\n\texports.screen.height = exports.height;\n}\n\n/**\n * Event handlers\n */\nexports.setBackButtonHandler = function (handler) {\n\tNATIVE.onBackButton = handler;\n}\n\nexports.setRotationHandler = function (handler) {\n\tNATIVE.onRotation = handler;\n}\n\n/*\n * Stay awake\n */\nexports.stayAwake = function(enable) {\n\tNATIVE.stayAwake && NATIVE.stayAwake(enable);\n}\n\n/**\n * Garbage Collection\n */\nexports.collectGarbage = function () {\n\tlogger.log('collecting garbage');\n\tNATIVE.gc && NATIVE.gc.runGC();\n}\n\n/**\n * Global device accessibility controls. Muting, click, color, font changing, etc.\n */\n\nGLOBAL.ACCESSIBILITY = new (Class(Emitter, function (supr) {\n\tthis.muted = false;\n\n\tthis.mute = function (flag) {\n\t\tthis.muted = flag;\n\t\tthis.publish('MuteChange');\n\t};\n}));\n\nif (GLOBAL.ONACCESSIBLE) {\n\tGLOBAL.ONACCESSIBLE();\n}\n","pre":true},"sdk/timestep/event/Emitter.js":{"path":"sdk/timestep/event/Emitter.js","friendlyPath":"event.Emitter","directory":"sdk/timestep/event/","filename":"Emitter.js","baseMod":"event","basePath":"sdk/timestep/","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @class event.Emitter;\n * Namespace shim to bring in PubSub from jsio.\n *\n * @doc http://doc.gameclosure.com/api/event.html#class-event.emitter\n * @docsrc https://github.com/gameclosure/doc/blob/master/api/event.md\n */\n\njsio(\"import lib.PubSub as exports\");\n","pre":true},"sdk/jsio/lib/PubSub.js":{"path":"sdk/jsio/lib/PubSub.js","friendlyPath":"lib.PubSub","directory":"sdk/jsio/lib/","filename":"PubSub.js","baseMod":"lib","basePath":"sdk/jsio","src":"/**\n * Summary: inherit from lib.PubSub if a class wants publish/subscribe ability\n * Methods:\n *  - publish(signal, args...) - all subscribers to signal will be called\n *     with the list of arguments provided.\n *  - subscribe(signal, ctx, method, args...) - register a bound method\n *     to a signal.  Any args that are passed in will be the first args\n *     when the method is invoked during a publish.\n *  Usage notes: There is one special signal '__any'.  Any subscribers to\n *     '__any' will be called on every publish with the first publish\n *     argument being the signal itself (after any args passed in during\n *     the corresponding subscribe). \n *     Calling the super constructor is not required for descendants of \n *     lib.PubSub. \n */\n\nvar ctx = jsio.__env.global,\n\tSLICE = Array.prototype.slice;\n\nvar sdk_jsio_lib_PubSub=__class__;exports=sdk_jsio_lib_PubSub(function sdk_jsio_lib_PubSub(){return this.init&&this.init.apply(this,arguments)},function () {\n\n\tthis.init = function () {};\n\t\n\tthis.publish = function (signal) {\n\t\tif (this._subscribers) {\n\t\t\tvar args = SLICE.call(arguments, 1);\n\t\t\tif (this._subscribers.__any) {\n\t\t\t\tvar anyArgs = [signal].concat(args),\n\t\t\t\t\tsubs = this._subscribers.__any.slice(0);\n\t\t\t\tfor(var i = 0, sub; sub = subs[i]; ++i) {\n\t\t\t\t\tsub.apply(ctx, anyArgs);\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tif (!this._subscribers[signal]) {\n\t\t\t\treturn this;\n\t\t\t}\n\t\t\t\n\t\t\tvar subs = this._subscribers[signal].slice(0);\n\t\t\tfor (var i = 0, sub; sub = subs[i]; ++i) {\n\t\t\t\tsub.apply(ctx, args);\n\t\t\t}\n\t\t}\n\t\treturn this;\n\t};\n\t\n\tthis.subscribe = function (signal, ctx, method) {\n\t\tvar cb;\n\t\tif (arguments.length == 2) {\n\t\t\tcb = ctx;\n\t\t} else {\n\t\t\tcb = bind.apply(GLOBAL, SLICE.call(arguments, 1));\n\t\t\tcb._ctx = ctx; // references for unsubscription\n\t\t\tcb._method = method;\n\t\t}\n\t\t\n\t\tvar s = this._subscribers || (this._subscribers = {});\n\t\t(s[signal] || (s[signal] = [])).push(cb);\n\t\treturn this;\n\t};\n\t\n\tthis.subscribeOnce = function (signal, ctx, method) {\n\t\tvar args = arguments,\n\t\t\tcb = bind(this, function () {\n\t\t\t\tthis.unsubscribe(signal, cb);\n\t\t\t\tif (args.length == 2) {\n\t\t\t\t\tctx.apply(GLOBAL, arguments);\n\t\t\t\t} else {\n\t\t\t\t\tbind.apply(GLOBAL, SLICE.call(args, 1))\n\t\t\t\t\t\t.apply(GLOBAL, arguments);\n\t\t\t\t}\n\t\t\t});\n\t\t\t\n\t\tif (args.length === 3) {\n\t\t\tcb._ctx = ctx;\n\t\t\tcb._method = method;\n\t\t}\n\t\t\n\t\treturn this.subscribe(signal, cb);\n\t};\n\t\n\t// If no method is specified, all subscriptions with a callback context\n\t// of ctx will be removed.\n\n\tthis.unsubscribe = function (signal, ctx, method) {\n\t\tif (!this._subscribers || !this._subscribers[signal]) {\n\t\t\treturn this;\n\t\t}\n\t\tvar subs = this._subscribers[signal];\n\t\tfor (var i = 0, c; c = subs[i]; ++i) {\n\t\t\tif (c == ctx || c._ctx == ctx && (!method || c._method == method)) {\n\t\t\t\tsubs.splice(i--, 1);\n\t\t\t}\n\t\t}\n\t\treturn this;\n\t};\n\n\t/**\n\t * EventEmitter-style API\n\t * http://nodejs.org/api/events.html\n\t */\n\n\tthis.listeners = function (type) {\n\t\tthis._subscribers = (this._subscribers ? this._subscribers : {});\n\t\treturn (this.hasOwnProperty.call(this._subscribers, type))\n\t\t\t? this._subscribers[type]\n\t\t\t: (this._subscribers[type] = []);\n\t};\n\n\tthis.addListener = this.on = function (type, f) {\n\t\tif (this.listeners(type).length + 1 > this._maxListeners && this._maxListeners !== 0) {\n\t\t\tif (typeof console !== \"undefined\") {\n\t\t\t\tconsole.warn(\"Possible EventEmitter memory leak detected. \" + this._subscribers[type].length + \" listeners added. Use emitter.setMaxListeners() to increase limit.\");\n\t\t\t}\n\t\t}\n\t\tthis.emit(\"newListener\", type, f);\n\t\treturn this.subscribe(type, this, f);\n\t};\n\n\tthis.once = function (type, f) {\n\t\treturn this.subscribeOnce(type, this, f);\n\t};\n\n\tthis.removeListener = function (type, f) {\n\t\tthis.unsubscribe(type, this, f);\n\t\treturn this;\n\t};\n\n\tthis.removeAllListeners = function (type) {\n\t\tif (this._subscribers) {\n\t\t\tfor (var k in this._subscribers) {\n\t\t\t\tif (type == null || type == k) {\n\t\t\t\t\tdelete this._subscribers[k];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn this;\n\t};\n\n\tthis.emit = function (type) {\n\t\tthis.publish.apply(this, arguments);\n\t\treturn this.listeners(type).length > 0;\n\t};\n\n\tthis._maxListeners = 10;\n\n\tthis.setMaxListeners = function (_maxListeners) {\n\t\tthis._maxListeners = _maxListeners;\n\t};\n\n\tthis.hasListeners = function (type) {\n\t\treturn this._subscribers && this._subscribers[type] && this._subscribers[type].length;\n\t};\n});\n\n","pre":true},"sdk/jsio/util/setProperty.js":{"path":"sdk/jsio/util/setProperty.js","friendlyPath":"util.setProperty","directory":"sdk/jsio/util/","filename":"setProperty.js","src":"function createGetter(ctx, name) {\n\treturn function() {\n\t\treturn this[name];\n\t}\n}\n\nfunction createSetter(ctx, name, callback, initialValue) {\n\tif (initialValue !== undefined) {\n\t\tctx[name] = initialValue;\n\t}\n\t\n\tif (typeof callback == 'function') {\n\t\treturn function(value) {\n\t\t\tif (this[name] !== value) {\n\t\t\t\tvar old = this[name];\n\t\t\t\tthis[name] = value;\n\t\t\t\tcallback.call(this, name, value, old);\n\t\t\t}\n\t\t}\n\t} else if (typeof callback == 'string') {\n\t\treturn function(value) {\n\t\t\tif (this[name] !== value) {\n\t\t\t\tvar old = this[name];\n\t\t\t\tthis[name] = value;\n\t\t\t\tthis[callback](name, value, old);\n\t\t\t}\n\t\t}\n\t} else {\n\t\treturn function(value) {\n\t\t\tthis[name] = value;\n\t\t}\n\t}\n}\n\nexports = function(ctx, name, def) {\n\tif (!def.get && !def.set && !def.cb && ('value' in def)) {\n\t\tctx[name] = def.value;\n\t} else {\n\t\tif (!def.get) { def.get = createGetter(ctx, '_' + name); }\n\t\tif (!def.set) { def.set = createSetter(ctx, '_' + name, def.cb, def.value); }\n\t\tif ('value' in def) { ctx['_' + name] = def.value; }\n\n\t\tdelete def.value;\n\t\tif (Object.defineProperty) {\n\t\t\tObject.defineProperty(ctx, name, def);\n\t\t\t// merge(def, {\n\t\t\t// \t\t\t\tconfigurable: false,\n\t\t\t// \t\t\t\tenumerable: true\n\t\t\t// \t\t\t});\n\t\t} else if (ctx.__defineSetter__) {\n\t\t\tctx.__defineSetter__(name, def.set);\n\t\t\tctx.__defineGetter__(name, def.get);\n\t\t} else {\n\t\t\tctx[name] = def.value;\n\t\t}\n\t}\n}\n","pre":true},"sdk/timestep/ui/resource/Font.js":{"path":"sdk/timestep/ui/resource/Font.js","friendlyPath":"ui.resource.Font","directory":"sdk/timestep/ui/resource/","filename":"Font.js","baseMod":"ui","basePath":"sdk/timestep/","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @class ui.resource.Font;\n * Font string parser, a la CSS Font strings. Exports a Font object class.\n * This class is purely informational.\n *\n * @doc http://doc.gameclosure.com/api/ui-text.html#class-ui.resource.font\n * @docsrc https://github.com/gameclosure/doc/blob/master/api/ui/text.md\n */\n\nvar _cache = {},\n\tweights = 'normal|bold|bolder|lighter|[1-9]00',\n\tstyles = 'normal|italic|oblique',\n\tunits = 'px|pt|pc|in|cm|mm|%',\n\tname = '([\\\\w\\\"\\'\\\\- ]+(?:,|$))+',\n\tfontParser = new RegExp(\n\t\t'^ *'\n\t\t\t+ '(?:(' + weights + ') *)?'\n\t\t\t+ '(?:(' + styles + ') *)?'\n\t\t\t+ '([\\\\d\\\\.]+)(' + units + ')'\n\t\t\t+ '('+ name + ')',\n\t\t\t'i'\n\t),\n\tsizeParser = new RegExp('([\\\\d\\\\.]+)(' + units + ')', 'i'),\n\tTO_PT = {\n\t\t'pt': 1,\n\t\t'px': 3 / 4,\n\t\t'in': 3 / 4 * 96,\n\t\t'mm': 3 / 4 * 96 / 25.4,\n\t\t'cm': 3 / 4 * 96 / 2.54\n\t},\n\tTO_PX = {\n\t\t'pt': 4 / 3,\n\t\t'px': 1,\n\t\t'in': 96,\n\t\t'mm': 96 / 25.4,\n\t\t'cm': 96 / 2.54\n\t};\n\nfunction parseSize(sizeStr, unit) {\n\tvar match = sizeStr.match(sizeParser);\n\tif (!match) { throw 'invalid font size'; }\n\treturn {\n\t\tvalue: parseFloat(match[1]),\n\t\tunit: match[2]\n\t};\n}\n\nfunction toPx(size) {\n\treturn {\n\t\tvalue: size.value * TO_PX[size.unit],\n\t\tunit: 'px'\n\t};\n}\n\nfunction toPt(size) {\n\treturn {\n\t\tvalue: size.value * TO_PT[size.unit],\n\t\tunit: 'pt'\n\t};\n}\n\nfunction parseFont(fontStr) {\n\tvar match = fontStr.match(fontParser);\n\tif (!match) { throw 'invalid font string'; }\n\t\n\tvar res = {};\n\tres.weight = match[1] || 'normal';\n\tres.style = match[2] || 'normal';\n\tres.size = {\n\t\tvalue: parseFloat(match[3]),\n\t\tunit: match[4]\n\t};\n\tres.names = match[5]\n\t\t.split(',')\n\t\t.map(function (str) {\n\t\t\treturn str.replace(/[\\-_]/g, ' ')\n\t\t\t\t.replace(/\\s+/g, ' ')\n\t\t\t\t.replace(/['\"]/g, '')\n\t\t\t\t.replace(/^\\s+|\\s+$/g, '')\n\t\t});\n\n\tres.name = res.names[0];\n\treturn res;\n};\n\nvar sdk_timestep_ui_resource_Font=__class__;var Font = exports=sdk_timestep_ui_resource_Font(function sdk_timestep_ui_resource_Font(){return this.init&&this.init.apply(this,arguments)},function () {\n\t\n\tvar _defaultFontFamily = null;\n\tthis.constructor.setDefaultFontFamily = function (fontFamily) {\n\t\t_defaultFontFamily = fontFamily;\n\t}\n\n\tvar defaults = {\n\t\tname: _defaultFontFamily,\n\t\tsize: 20,\n\t\tunit: 'px',\n\t\tstyle: '',\n\t\tweight: ''\n\t};\n\n\tthis.init = function (opts) {\n\t\tif (typeof opts === 'string') {\n\t\t\t_cache[opts] = this;\n\t\t\tthis._string = opts;\n\t\t\topts = parseFont(opts);\n\t\t} else {\n\t\t\topts = merge(opts, defaults);\n\t\t}\n\t\t\n\t\tif (typeof opts.size == 'string') {\n\t\t\topts.size = parseSize(opts.size);\n\t\t}\n\t\t\n\t\tthis._name = opts.name;\n\t\tthis._style = opts.style;\n\t\tthis.size = opts.size;\n\t\tthis.sizePx = toPx(this.size).value;\n\t\tthis.sizePt = toPt(this.size).value;\n\t\tthis._weight = opts.weight;\n\n\t\tthis._isBold = /bold/i.test(this._weight);\n\t};\n\t\n\tthis.getSize = function () { return this.sizePx; }\n\n\tthis.getName = function () { return this._name; }\n\tthis.getWeight = function () { return this._weight; }\n});\n\nexports.parse = function (str) {\n\tif (str in _cache) {\n\t\treturn _cache[str];\n\t} else {\n\t\treturn new Font(str);\n\t}\n}\n","pre":true},"sdk/jsio/std/uri.js":{"path":"sdk/jsio/std/uri.js","friendlyPath":"std.uri","directory":"sdk/jsio/std/","filename":"uri.js","baseMod":"std","basePath":"sdk/jsio","src":"var attrs = [ \n\t\"source\",\n\t\"protocol\",\n\t\"authority\",\n\t\"userInfo\",\n\t\"user\",\n\t\"password\",\n\t\"host\",\n\t\"port\",\n\t\"relative\",\n\t\"path\",\n\t\"directory\",\n\t\"file\",\n\t\"query\",\n\t\"anchor\"\n];\n\nvar sdk_jsio_std_uri=__class__;var URI = exports=sdk_jsio_std_uri(function sdk_jsio_std_uri(){return this.init&&this.init.apply(this,arguments)},function(supr) {\n\tthis.init = function(url, isStrict) {\n\t\tif (url instanceof URI) {\n\t\t\tfor (var i = 0, attr; attr = attrs[i]; ++i) {\n\t\t\t\tthis['_' + attr] = url['_' + attr];\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tthis._isStrict = isStrict;\n\t\t\n\t\tvar uriData = exports.parse(url, isStrict);\n\t\tfor (var attr in uriData) {\n\t\t\tthis['_' + attr] = uriData[attr];\n\t\t};\n\t}\n  \n\tfor (var i = 0, attr; attr = attrs[i]; ++i) {\n\t\t(function(attr) {\n\t\t\tvar fNameSuffix = attr.charAt(0).toUpperCase() + attr.slice(1);\n\t\t\tthis['get' + fNameSuffix] = function() {\n\t\t\t\treturn this['_' + attr];\n\t\t\t};\n\t\t\tthis['set' + fNameSuffix] = function(val) {\n\t\t\t\tthis['_' + attr] = val;\n\t\t\t\treturn this;\n\t\t\t};\n\t\t}).call(this, attr);\n\t};\n\t\n\tthis.query = function(key) { return exports.parseQuery(this._query)[key]; }\n\tthis.hash = function(key) { return exports.parseQuery(this._anchor)[key]; }\n\t\n\tthis.addHash = function(kvp) {\n\t\tvar hash = exports.parseQuery(this._anchor);\n\t\tfor (var i in kvp) { hash[i] = kvp[i]; }\n\t\tthis._anchor = exports.buildQuery(hash);\n\t\treturn this;\n\t}\n\t\n\tthis.push = function(path) {\n\t\tif (path) {\n\t\t\tthis._path = (this._path + '/' + path).replace(/\\/\\/+/g, '/');\n\t\t}\n\t\treturn this;\n\t}\n\t\n\tthis.addQuery = function(kvp) {\n\t\tvar query = exports.parseQuery(this._query);\n\t\tfor (var i in kvp) { query[i] = kvp[i]; }\n\t\tthis._query = exports.buildQuery(query);\n\t\treturn this;\n\t}\n\t\n\tthis.removeQuery = function(keys) {\n\t\tvar query = exports.parseQuery(this._query);\n\t\tif (isArray(keys)) {\n\t\t\tfor (var i = 0, n = keys.length; i < n; ++i) {\n\t\t\t\tdelete query[keys[i]];\n\t\t\t}\n\t\t} else {\n\t\t\tdelete query[keys];\n\t\t}\n\t\tthis._query = exports.buildQuery(query);\n\t\treturn this;\n\t}\n\n\tthis.toJSON = function() { return this.toString(false); }\n\n\tthis.toString = function(onlyBase) {\n\t\t// XXX TODO: This is vaguely reasonable, but not complete. fix it...\n\t\tvar a = this._protocol ? this._protocol + \"://\" : \"\"\n\t\tvar b = this._host ? this._host + ((this._port || 80) == 80 ? \"\" : \":\" + this._port) : \"\";\n\t\t\n\t\tif (onlyBase) {\n\t\t\treturn a + b;\n\t\t}\n\t\t\n\t\tvar c = this._path;\n\t\tvar d = this._query ? '?' + this._query : '';\n\t\tvar e = this._anchor ? '#' + this._anchor : '';\n\t\treturn a + b + c + d + e;\n\t};\n});\n\nexports.relativeTo = function(url, base) {\n\tvar url = String(url);\n\tif (base && !/^http(s?):\\/\\//.test(url)) {\n\t\tvar baseURI = new exports(base)\n\t\t\t.setAnchor('')\n\t\t\t.setQuery('')\n\t\t\t.setFile('')\n\t\t\t.toString(url.charAt(0) == '/');\n\n\t\turl = exports.resolveRelative(baseURI + url);\n\t}\n\n\treturn new URI(url);\n}\n\nexports.resolveRelative = function(url) {\n\tvar prevUrl;\n\t\n\t// remove ../ with preceeding folder\n\twhile((prevUrl = url) != (url = url.replace(/(^|\\/)([^\\/]+)\\/\\.\\.\\//g, '/'))) {};\n\t\n\t// remove ./ if it isn't preceeded by a .\n\treturn url.replace(/[^.]\\.\\//g, '');\n}\n\nexports.buildQuery = function(kvp) {\n\tvar pairs = [];\n\tfor (var key in kvp) {\n\t\tpairs.push(encodeURIComponent(key) + '=' + encodeURIComponent(kvp[key]));\n\t}\n\treturn pairs.join('&');\n}\n\nexports.parseQuery = function(str) {\n\tvar pairs = str.split('&'),\n\t\tn = pairs.length,\n\t\tdata = {};\n\tfor (var i = 0; i < n; ++i) {\n\t\tvar pair = pairs[i].split('='),\n\t\t\tkey = decodeURIComponent(pair[0]);\n\t\tif (key) { data[key] = decodeURIComponent(pair[1]); }\n\t}\n\treturn data;\n}\n\n// Regexs are based on parseUri 1.2.2\n// Original: (c) Steven Levithan <stevenlevithan.com>\n// Original: MIT License\n\nvar strictRegex = /^(?:([^:\\/?#]+):)?(?:\\/\\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\\/?#]*)(?::(\\d*))?))?((((?:[^?#\\/]*\\/)*)([^?#]*))(?:\\?([^#]*))?(?:#(.*))?)/;\nvar looseRegex = /^(?:(?![^:@]+:[^:@\\/]*@)([^:\\/?#.]+):)?(?:\\/\\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\\/?#]*)(?::(\\d*))?)(((\\/(?:[^?#](?![^?#\\/]*\\.[^?#\\/.]+(?:[?#]|$)))*\\/?)?([^?#\\/]*))(?:\\?([^#]*))?(?:#(.*))?)/;\nvar queryStringRegex = /(?:^|&)([^&=]*)=?([^&]*)/g;\n\nexports.parse = function(str, isStrict) {\n\tvar regex = isStrict ? strictRegex : looseRegex;\n\tvar result = {};\n\tvar match = regex.exec(str);\n\tfor (var i = 0, attr; attr = attrs[i]; ++i) {\n\t\tresult[attr] = match[i] || \"\";\n\t}\n\t\n\tvar qs = result['queryKey'] = {};\n\tresult['query'].replace(queryStringRegex, function(check, key, val) {\n\t\tif (check) {\n\t\t\tqs[key] = val;\n\t\t}\n\t});\n\t\n\treturn result;\n}\n\nexports.isSameDomain = function(urlA, urlB) {\n\tvar a = exports.parse(urlA);\n\tvar b = exports.parse(urlB);\n\treturn ((a.port == b.port ) && (a.host == b.host) && (a.protocol == b.protocol));\n};\n","pre":true},"sdk/timestep/platforms/browser/doc.js":{"path":"sdk/timestep/platforms/browser/doc.js","friendlyPath":".doc","directory":"sdk/timestep/platforms/browser/","filename":"doc.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\njsio(\"import lib.PubSub\");\njsio(\"import lib.Enum as Enum\");\njsio(\"import std.js as JS\");\njsio(\"from util.browser import $\");\n\njsio(\"import device\");\n\nvar SCALING = Enum('FIXED', 'RESIZE', 'MANUAL');\nvar defaultScalingMode = device.isMobileBrowser || device.simulating ? SCALING.RESIZE : SCALING.FIXED;\n\n/**\n * @extends lib.PubSub\n */\nDocument=__class__;var Document=Document(function Document(){return this.init&&this.init.apply(this,arguments)},lib.PubSub, function () {\n\tthis.init = function () {\n\t\tif (!$) {\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tvar doc = GLOBAL.document,\n\t\t\tbody = doc && doc.body;\n\t\t\n\t\tthis._el = $({\n\t\t\tparent: body,\n\t\t\tstyle: {\n \t\t\t\tposition: 'absolute',\n\t\t\t\toverflow: 'hidden',\n\t\t\t\twidth: '100%',\n\t\t\t\theight: '100%'\n\t\t\t}\n\t\t});\n\t\t\n\t\tdevice.screen.subscribe('Resize', this, 'onResize');\n\t\t\n\t\tif (exports.postCreateHook) { exports.postCreateHook(this); }\n\t\tthis.setScalingMode(defaultScalingMode);\n\t}\n\t\n\tthis.unsubscribeResize = function () {\n\t\tdevice.screen.unsubscribe('Resize', this, 'onResize');\n\t}\n\t\n\tthis.setEngine = function (engine) {\n\t\tif (engine == this._engine) { return; }\n\t\t\n\t\tthis._engine = engine;\n\t\tthis._canvas = this._engine.getCanvas();\n\t\tthis.appendChild(this._canvas);\n\n\t\tif (this._canvas.getContext) {\n\t\t\tvar ctx = this._canvas.getContext(window.WebGLRenderingContext ? 'webgl' : '2d');\n\t\t\tif (ctx.setParentNode) {\n\t\t\t\tctx.setParentNode(this._el);\n\t\t\t}\n\t\t}\n\t}\n\t\n\tthis.getElement = function () {\n\t\treturn this._el;\n\t};\n\t\n\tthis.setScalingMode = function (scalingMode, opts) {\n\t\tthis._scalingMode = scalingMode;\n\t\t\n\t\tvar el = this._el,\n\t\t\ts = el.style;\n\t\t\n\t\tswitch (scalingMode) {\n\t\t\tcase SCALING.FIXED:\n\t\t\t\topts = merge(opts, {\n\t\t\t\t\t\twidth: device.width,\n\t\t\t\t\t\theight: device.height\n\t\t\t\t\t});\n\t\t\t\ts.width = opts.width + 'px';\n\t\t\t\ts.height = opts.height + 'px';\n\t\t\t\tbreak;\n\t\t\tcase SCALING.RESIZE:\n\t\t\t\topts = merge(opts, {\n\t\t\t\t\t\tresizeCanvas: true\n\t\t\t\t\t});\n\t\t\t\t// fall through:\n\t\t\tcase SCALING.MANUAL:\n\t\t\t\ts.margin = '0px';\n\t\t\t\ts.width = '100%';\n\t\t\t\ts.height = '100%';\n\t\t\t\tbreak;\n\t\t}\n\t\t\n\t\tthis._scalingOpts = opts;\n\t\tthis.onResize();\n\t\tsetTimeout(bind(this, 'onResize'), 1000);\n\t}\n\t\n\tthis.onResize = function () {\n\t\tvar el = this._el;\n\t\tvar s = this._el.style;\n\t\t\n\t\tel.className = device.screen.orientation;\n\t\tlogger.log('resize', device.width, device.height);\n\t\t\n\t\tvar width = device.width;\n\t\tvar height = device.height;\n\t\tvar mode = this._scalingMode;\n\t\tvar opts = this._scalingOpts;\n\t\t\n\t\tif (mode == SCALING.FIXED) {\n\t\t\twidth = opts.width;\n\t\t\theight = opts.height;\n\t\t}\n\t\t\n\t\t// enforce maxWidth/maxHeight\n\t\t// if maxWidth/maxHeight is met, switch a RESIZE scaling mode to FIXED (center the document on the screen)\n\t\tif (opts.maxWidth && width > opts.maxWidth) {\n\t\t\twidth = opts.maxWidth;\n\t\t\tif (mode == SCALING.RESIZE) { mode = SCALING.FIXED; }\n\t\t}\n\t\t\n\t\tif (opts.maxHeight && height > opts.maxHeight) {\n\t\t\theight = opts.maxHeight;\n\t\t\tif (mode == SCALING.RESIZE) { mode = SCALING.FIXED; }\n\t\t}\n\t\t\n\t\tswitch (mode) {\n\t\t\tcase SCALING.MANUAL:\n\t\t\t\tbreak; // do nothing\n\t\t\tcase SCALING.FIXED:\n\t\t\t\t// try to center the container\n\t\t\t\tel.style.top = Math.round(Math.max(0, (window.innerHeight - height) / 2)) + 'px';\n\t\t\t\tel.style.left = Math.round(Math.max(0, (window.innerWidth - width) / 2)) + 'px';\n\t\t\t\t\n\t\t\t\ts.width = width + 'px';\n\t\t\t\ts.height = height + 'px';\n\t\t\t\tbreak;\n\t\t\tcase SCALING.RESIZE:\n\t\t\t\t// if we have a canvas element, scale it\n\t\t\t\tif (opts.resizeCanvas && this._canvas\n\t\t\t\t\t\t&& (this._canvas.width != width || this._canvas.height != height)) {\n\t\t\t\t\tthis._canvas.width = width;\n\t\t\t\t\tthis._canvas.height = height;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\ts.width = width + 'px';\n\t\t\t\ts.height = height + 'px';\n\t\t\t\tbreak;\n\t\t}\n\t\t\n\t\t// make sure to force a render immediately (should we use needsRepaint instead?)\n\t\tthis._setDim(width, height);\n\t\tif (this._engine) { this._engine.render(); }\n\t}\n\t\n\tthis._setDim = function (width, height) {\n\t\tif (this.width != width || this.height != height) {\n\t\t\tthis.width = width;\n\t\t\tthis.height = height;\n\t\t\tthis.publish('Resize', width, height);\n\t\t}\n\t}\n\t\n\tthis.setColors = function (bgColor, engineColor) {\n\t\tif (this._el) {\n\t\t\tthis._el.style.background = engineColor;\n\t\t\tdocument.documentElement.style.background = document.body.style.background = bgColor;\n\t\t}\n\t}\n\t\n\tthis.appendChild = function (el) {\n\t\tthis._el.appendChild(el);\n\t}\n\t\n\tthis.getOffset = function () {\n\t\treturn {\n\t\t\tx: this._el.offsetLeft,\n\t\t\ty: this._el.offsetTop\n\t\t};\n\t}\n});\n\nexports = new Document();\nexports.SCALING = SCALING;\n\nexports.setDocStyle = function () {\n\tvar doc = GLOBAL.document,\n\t\tbody = doc && doc.body;\n\t\n\tif (body) {\n\t\tvar docStyle = {\n\t\t\theight: '100%',\n\t\t\tmargin: '0px',\n\t\t\tpadding: '0px'\n\t\t};\n\t\n\t\t$.style(document.documentElement, docStyle);\n\t\t$.style(document.body, docStyle);\n\t}\n}\n\nexports.defaultParent = null;\nexports.postCreateHook = null;\n","pre":true},"sdk/jsio/lib/Enum.js":{"path":"sdk/jsio/lib/Enum.js","friendlyPath":"lib.Enum","directory":"sdk/jsio/lib/","filename":"Enum.js","src":"exports = function() {\n\tif (arguments.length == 1) {\n\t\tif (typeof arguments[0] == 'object') {\n\t\t\tvar obj = arguments[0];\n\t\t\tfor (var i in obj) {\n\t\t\t\tif (!(obj[i] in obj)) {\n\t\t\t\t\tobj[obj[i]] = i;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn obj;\n\t\t} else if (typeof arguments[0] != 'string') {\n\t\t\tkeys = arguments[0];\n\t\t}\n\t}\n\t\n\tif (!keys) { var keys = arguments; }\n\tvar obj = {};\n\tfor(var i = 0, len = keys.length; i < len; ++i) {\n\t\tif (keys[i]) {\n\t\t\tobj[keys[i]] = i + 1;\n\t\t}\n\t\tobj[i + 1] = keys[i];\n\t}\n\treturn obj;\n}","pre":true},"sdk/jsio/std/js.js":{"path":"sdk/jsio/std/js.js","friendlyPath":"std.js","directory":"sdk/jsio/std/","filename":"js.js","src":"var SLICE = Array.prototype.slice;\n\nexports.vargs = function(args, n) { return SLICE.call(args, n || 0); }\nexports.isArray = function(input) { return Object.prototype.toString.call(input) === '[object Array]'; }\n\nexports.shallowCopy = function(input) {\n\tif (exports.isArray(input)) {\n\t\treturn input.slice(0);\n\t} else {\n\t\tvar out = {};\n\t\tfor (var key in input) {\n\t\t\tif (input.hasOwnProperty(key)) {\n\t\t\t\tout[key] = input[key];\n\t\t\t}\n\t\t}\n\t}\n\t\n\treturn out;\n}\n\nexports.merge = function(base, extra) {\n\tbase = base || {};\n\t\n\tfor (var i = 1, len = arguments.length; i < len; ++i) {\n\t\tvar copyFrom = arguments[i];\n\t\tfor (var key in copyFrom) {\n\t\t\tif (copyFrom.hasOwnProperty(key) && !base.hasOwnProperty(key)) {\n\t\t\t\tbase[key] = copyFrom[key];\n\t\t\t}\n\t\t}\n\t}\n\t\n\treturn base;\n}\n\nexports.curry = function(method /*, VARGS*/) {\n\tvar args = SLICE.call(arguments, 1),\n\t\tf = typeof method == 'string'\n\t\t\t\t? function() { this[method].apply(ctx, args.concat(SLICE.call(arguments))); }\n\t\t\t\t: function() { method.apply(this, args.concat(SLICE.call(arguments))); }\n\tf.curried = true;\n\treturn f;\n}\n\nexports.unbind = function(method /*, VARGS*/) {\n\tvar args = SLICE.call(arguments, 1),\n\t\tf = typeof method == 'string'\n\t\t\t\t? function(ctx) { ctx[method].apply(ctx, args.concat(SLICE.call(arguments, 1))); }\n\t\t\t\t: function(ctx) { method.apply(ctx, args.concat(SLICE.call(arguments, 1))); }\n\tf.unbound = true;\n\treturn f;\n}\n\n","pre":true},"sdk/jsio/util/browser.js":{"path":"sdk/jsio/util/browser.js","friendlyPath":"util.browser","directory":"sdk/jsio/util/","filename":"browser.js","src":"if (jsio.__env.name == 'browser') {\n\tjsio('external .sizzle import Sizzle');\n\tjsio('import math.geom.Rect');\n\t\n\tfunction isWindow(el) {\n\t\treturn el && !$.isElement(el) && $.isElement(el.document);\n\t}\n\t\n\tvar singleId = /^#([\\w-]+)$/;\n\t\n\tvar $ = exports.$ = function(selector, win) {\n\t\tswitch(typeof selector) {\n\t\t\tcase 'object':\n\t\t\t\tif ($.isElement(selector)) {\n\t\t\t\t\treturn $.remove(selector);\n\t\t\t\t} else if ($.isElement(selector.document && selector.document.body)) {\n\t\t\t\t\treturn $.size(selector);\n\t\t\t\t}\n\t\t\t\treturn $.create(selector);\n\t\t\tcase 'string':\n\t\t\t\tif (singleId.test(selector)) { return $.id(selector.substring(1), win); }\n\t\t\t\treturn Sizzle.apply(GLOBAL, arguments);\n\t\t}\n\t}\n\t\n\tvar DOM2 = typeof HTMLElement === \"object\";\n\t$.isElement = DOM2\n\t\t? function(el) { return el && el instanceof HTMLElement; }\n\t\t: function(el) { return el && typeof el.nodeType == 'number' && typeof el.nodeName == 'string' };\n\t\n\t$.id = function(id, win) { return typeof id == 'string' ? (win || window).document.getElementById(id) : id; }\n\n\t$.apply = function(el, params) {\n\t\tif (params.attrs) {\n\t\t\tfor(attr in params.attrs) {\n\t\t\t\tel.setAttribute(attr, params.attrs[attr]);\n\t\t\t}\n\t\t}\n\t\t\n\t\tif (params.id) { el.id = params.id; }\n\t\tif (params.style) { $.style(el, params.style); }\n\t\tif (params.src) { el.src = params.src; }\n\t\tif (params['class'] || params['className']) {\n\t\t\tel.className = params['class'] || params['className'];\n\t\t}\n\t\t\n\t\tvar parent = params.parent || params.parentNode;\n\t\tif (parent && params.first) {\n\t\t\t$.insertBefore(parent, el, parent.firstChild);\n\t\t} else if (params.before) {\n\t\t\t$.insertBefore(params.before.parentNode || parent, el, params.before);\n\t\t} else if (params.after) {\n\t\t\t$.insertAfter(params.after.parentNode || parent, el, params.after);\n\t\t} else if (parent) {\n\t\t\tparent.appendChild(el);\n\t\t}\n\t\t\n\t\tif ('html' in params) { el.innerHTML = params.html; }\n\t\tif ('text' in params) { $.setText(el, params.text); }\n\t\t\n\t\tif (params.children) {\n\t\t\tvar c = params.children;\n\t\t\tfor (var i = 0, n = c.length; i < n; ++i) {\n\t\t\t\tel.appendChild($.isElement(c[i]) ? c[i] : $(c[i]));\n\t\t\t}\n\t\t}\n\t\t\n\t\treturn el;\n\t}\n\t\n\t$.insertBefore = function(parentNode, el, beforeNode) {\n\t\tif (!parentNode || !el) { return; }\n\t\tif (beforeNode && beforeNode.parentNode == parentNode) {\n\t\t\tparentNode.insertBefore(el, beforeNode);\n\t\t} else {\n\t\t\tparentNode.appendChild(el);\n\t\t}\n\t}\n\t\n\t$.insertAfter = function(parentNode, el, afterNode) {\n\t\tif (!parentNode || !el) { return; }\n\t\tif (!afterNode || afterNode.parentNode != parentNode) {\n\t\t\t$.insertBefore(parentNode, el, parentNode.firstChild);\n\t\t} else if (!afterNode.nextSibling) {\n\t\t\tparentNode.appendChild(el);\n\t\t} else {\n\t\t\tparentNode.insertBefore(el, afterNode.nextSibling);\n\t\t}\n\t}\n\n\t$.create = function(params) {\n\t\tvar doc = ((params && params.win) || window).document;\n\t\tif (!params || typeof params == 'string') {\n\t\t\treturn doc.createElement(params || 'div');\n\t\t};\n\n\t\treturn $.apply(params.el || doc.createElement(params.tag || params.tagName || 'div'), params);\n\t}\n\n\t$.show = function(el, how) { $.id(el).style.display = how || 'block'; }\n\t$.hide = function(el) { $.id(el).style.display = 'none'; }\n\n\t// accepts an array or a space-delimited string of classNames\n\t$.addClass = function(el, classNames) {\n\t\tif (!el) { return; }\n\t\tvar el = $.id(el);\n\t\tif (typeof classNames == \"string\") {\n\t\t\tclassNames = classNames.split(' ');\n\t\t}\n\t\n\t\tvar current = ' ' + el.className + ' ';\n\t\tfor (var i = 0, len = classNames.length; i < len; ++i) {\n\t\t\tvar c = classNames[i];\n\t\t\tif (current.indexOf(' ' + c + ' ') == -1) {\n\t\t\t\tcurrent += c + ' ';\n\t\t\t}\n\t\t}\n\t\t\n\t\tel.className = current.replace(/^\\s+|\\s+$/g, '');\n\t\treturn $;\n\t}\n\t\n\t$.getTag = function(from, tag) { return from.getElementsByTagName(tag); }\n\n\t$.removeClass = function(el, classNames) {\n\t\tif (!el) { return; }\n\t\tvar el = $.id(el);\n\t\tel.className = (' ' + el.className + ' ')\n\t\t\t.replace(' ', '  ')\n\t\t\t.replace(new RegExp('( ' + classNames.replace('\\s+', ' | ').replace('-','\\-') + ' )', 'g'), ' ')\n\t\t\t.replace(/\\s+/, ' ')\n\t\t\t.replace(/^\\s+|\\s+$/g, '');\n\t}\n\n\tfunction ieGetAlpha(el) {\n\t\ttry {\n\t\t\treturn el.filters.item(\"alpha\");\n\t\t} catch(e) {}\n\t\n\t\ttry {\n\t\t\treturn el.filters.item(\"progid:DXImageTransform.Microsoft.Alpha\");\n\t\t} catch(e) {}\n\t\n\t\treturn null;\n\t}\n\n\t$.style = function(el, style) {\n\t\tif(el instanceof Array) {\n\t\t\tfor(var i = 0, o; o = el[i]; ++i) { $.style(o, style); }\n\t\t\treturn;\n\t\t}\n\t\n\t\tel = $.id(el);\n\t\tvar s = el.style;\n\t\tfor(prop in style) {\n\t\t\tswitch(prop) {\n\t\t\t\tcase 'styleFloat':\n\t\t\t\tcase 'cssFloat':\n\t\t\t\tcase 'float':\n\t\t\t\t\ts.styleFloat = s.cssFloat = style[prop];\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'opacity':\n\t\t\t\t\ts.opacity = style[prop];\n\t\t\t\t\tif(el.filters) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tvar alpha = ieGetAlpha();\n\t\t\t\t\t\t\tvar opacity = style[prop] == 1 ? 99.99 : style[prop] * 100;\n\t\t\t\t\t\t\tif(!alpha) {\n\t\t\t\t\t\t\t\t// TODO: this might destroy any existing filters?\n\t\t\t\t\t\t\t\ts.filter = \"alpha(opacity=\" + opacity + \")\";\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\talpha.Opacity = opacity;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch(e) {}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'borderRadius':\n\t\t\t\t\ts.borderRadius = s.MozBorderRadius = style[prop];\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'boxSizing':\n\t\t\t\t\ts.MsBoxSizing = s.MozBoxSizing = s.WebkitBoxSizing = style[prop];\n\t\t\t\tdefault:\n\t\t\t\t\ts[prop] = style[prop];\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t};\n\n\t$.onEvent = function(el, name, f) {\n\t\tif (typeof f != 'function') {\n\t\t\tf = bind.apply(GLOBAL, Array.prototype.slice.call(arguments, 2));\n\t\t}\n\t\n\t\tvar handler = f;\n\t\n\t\tel = $.id(el);\n\t\tif(el.addEventListener) { \n\t\t\tel.addEventListener(name, handler, false);\n\t\t} else {\n\t\t\thandler = function(e) {\n\t\t\t\tvar evt = e || window.event;\n\t\t\t\t// TODO: normalize the event object\n\t\t\t\tf(evt);\n\t\t\t};\n\t\t\n\t\t\tel.attachEvent('on' + name, handler);\n\t\t}\n\t\n\t\treturn bind($, 'removeEvent', el, name, handler);\n\t};\n\n\t$.removeEvent = function(el, name, f) {\n\t\tel = $.id(el);\n\t\tif (el.addEventListener) {\n\t\t\tel.removeEventListener(name, f, false);\n\t\t} else {\n\t\t\tel.detachEvent('on' + name, f);\n\t\t}\n\t}\n\n\t$.stopEvent = function(e) {\n\t\tif (e) {\n\t\t\te.cancelBubble = true;\n\t\t\tif(e.stopPropagation) e.stopPropagation();\n\t\t\tif(e.preventDefault) e.preventDefault();\n\t\t}\n\t}\n\n\t$.setText = function(el, text) {\n\t\tel = $.id(el);\n\t\ttext = String(text);\n\t\tif ('textContent' in el) {\n\t\t\tel.textContent = text;\n\t\t} else if ('innerText' in el) {\n\t\t\tel.innerText = text.replace(/\\n/g, ' ');\n\t\t} else {\n\t\t\tel.innerHTML = '';\n\t\t\tel.appendChild(document.createTextNode(text));\n\t\t}\n\t}\n\n\t$.setValue = function(el, value) {\n\t\tel = $.id(el);\n\t\tif ('value' in el) {\n\t\t\tel.value = value;\n\t\t} else if ('value' in el.firstChild) {\n\t\t\tel.firstChild.value = value;\n\t\t}\n\t};\n\n\t$.remove = function(el) {\n\t\tel = $.id(el);\n\t\tif(el && el.parentNode) {\n\t\t\tel.parentNode.removeChild(el);\n\t\t}\n\t}\n\n\t$.cursorPos = function(ev, el) {\n\t\tvar offset = $.pos(el);\n\t\toffset.top = ev.clientY - offset.top + (window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop);\n\t\toffset.left = ev.clientX - offset.left + (window.pageXOffset || document.documentElement.scrollLeft || document.body.scrollLeft);\n\t\treturn offset;\n\t}\n\n\t$.pos = function(el) {\n\t\tvar parent = el;\n\t\tvar offset = {top: 0, left: 0};\n\t\twhile(parent && parent != document.body) {\n\t\t\toffset.left += parent.offsetLeft;\n\t\t\toffset.top += parent.offsetTop;\n\t\t\twhile(parent.offsetParent != parent.parentNode) {\n\t\t\t\toffset.top -= parent.scrollTop; offset.left -= parent.scrollLeft;\n\t\t\t\tparent = parent.parentNode;\n\t\t\t}\n\t\t\tparent = parent.offsetParent;\n\t\t}\n\t\treturn offset;\n\t}\n\t\n\t$.size = function(el) {\n\t\tif ($.isElement(el)) {\n\t\t\treturn {width: el.offsetWidth, height: el.offsetHeight};\n\t\t} else if (el.document) {\n\t\t\tvar doc = el.document.documentElement || el.document.body;\n\t\t\treturn new math.geom.Rect(\n\t\t\t\tdoc.offsetTop,\n\t\t\t\tdoc.offsetLeft,\n\t\t\t\tel.innerWidth || (doc.clientWidth || doc.clientWidth),\n\t\t\t\tel.innerHeight || (doc.clientHeight || doc.clientHeight)\n\t\t\t);\n\t\t}\n\t}\n\t\n\t$.insertCSSFile = function(filename) {\n\t\tdocument.getElementsByTagName('head')[0].appendChild($({\n\t\t\ttag: 'link',\n\t\t\tattrs: {\n\t\t\t\trel: 'stylesheet',\n\t\t\t\ttype: 'text/css',\n\t\t\t\thref: filename\n\t\t\t}\n\t\t}));\n\t}\n}\n","pre":true},"sdk/jsio/util/sizzle.js":{"path":"sdk/jsio/util/sizzle.js","friendlyPath":".sizzle","directory":"sdk/jsio/util/","filename":"sizzle.js","src":"/*!\n * Sizzle CSS Selector Engine - v1.0\n *  Copyright 2009, The Dojo Foundation\n *  Released under the MIT, BSD, and GPL Licenses.\n *  More information: http://sizzlejs.com/\n */\n\nSizzle = (function(){\n\nvar chunker = /((?:\\((?:\\([^()]+\\)|[^()]+)+\\)|\\[(?:\\[[^[\\]]*\\]|['\"][^'\"]*['\"]|[^[\\]'\"]+)+\\]|\\\\.|[^ >+~,(\\[\\\\]+)+|[>+~])(\\s*,\\s*)?/g,\n\tdone = 0,\n\ttoString = Object.prototype.toString,\n\thasDuplicate = false;\n\nvar Sizzle = function(selector, context, results, seed) {\n\tresults = results || [];\n\tvar origContext = context = context || document;\n\n\tif ( context.nodeType !== 1 && context.nodeType !== 9 ) {\n\t\treturn [];\n\t}\n\t\n\tif ( !selector || typeof selector !== \"string\" ) {\n\t\treturn results;\n\t}\n\n\tvar parts = [], m, set, checkSet, check, mode, extra, prune = true, contextXML = isXML(context);\n\t\n\t// Reset the position of the chunker regexp (start from head)\n\tchunker.lastIndex = 0;\n\t\n\twhile ( (m = chunker.exec(selector)) !== null ) {\n\t\tparts.push( m[1] );\n\t\t\n\t\tif ( m[2] ) {\n\t\t\textra = RegExp.rightContext;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif ( parts.length > 1 && origPOS.exec( selector ) ) {\n\t\tif ( parts.length === 2 && Expr.relative[ parts[0] ] ) {\n\t\t\tset = posProcess( parts[0] + parts[1], context );\n\t\t} else {\n\t\t\tset = Expr.relative[ parts[0] ] ?\n\t\t\t\t[ context ] :\n\t\t\t\tSizzle( parts.shift(), context );\n\n\t\t\twhile ( parts.length ) {\n\t\t\t\tselector = parts.shift();\n\n\t\t\t\tif ( Expr.relative[ selector ] )\n\t\t\t\t\tselector += parts.shift();\n\n\t\t\t\tset = posProcess( selector, set );\n\t\t\t}\n\t\t}\n\t} else {\n\t\t// Take a shortcut and set the context if the root selector is an ID\n\t\t// (but not if it'll be faster if the inner selector is an ID)\n\t\tif ( !seed && parts.length > 1 && context.nodeType === 9 && !contextXML &&\n\t\t\t\tExpr.match.ID.test(parts[0]) && !Expr.match.ID.test(parts[parts.length - 1]) ) {\n\t\t\tvar ret = Sizzle.find( parts.shift(), context, contextXML );\n\t\t\tcontext = ret.expr ? Sizzle.filter( ret.expr, ret.set )[0] : ret.set[0];\n\t\t}\n\n\t\tif ( context ) {\n\t\t\tvar ret = seed ?\n\t\t\t\t{ expr: parts.pop(), set: makeArray(seed) } :\n\t\t\t\tSizzle.find( parts.pop(), parts.length === 1 && (parts[0] === \"~\" || parts[0] === \"+\") && context.parentNode ? context.parentNode : context, contextXML );\n\t\t\tset = ret.expr ? Sizzle.filter( ret.expr, ret.set ) : ret.set;\n\n\t\t\tif ( parts.length > 0 ) {\n\t\t\t\tcheckSet = makeArray(set);\n\t\t\t} else {\n\t\t\t\tprune = false;\n\t\t\t}\n\n\t\t\twhile ( parts.length ) {\n\t\t\t\tvar cur = parts.pop(), pop = cur;\n\n\t\t\t\tif ( !Expr.relative[ cur ] ) {\n\t\t\t\t\tcur = \"\";\n\t\t\t\t} else {\n\t\t\t\t\tpop = parts.pop();\n\t\t\t\t}\n\n\t\t\t\tif ( pop == null ) {\n\t\t\t\t\tpop = context;\n\t\t\t\t}\n\n\t\t\t\tExpr.relative[ cur ]( checkSet, pop, contextXML );\n\t\t\t}\n\t\t} else {\n\t\t\tcheckSet = parts = [];\n\t\t}\n\t}\n\n\tif ( !checkSet ) {\n\t\tcheckSet = set;\n\t}\n\n\tif ( !checkSet ) {\n\t\tthrow \"Syntax error, unrecognized expression: \" + (cur || selector);\n\t}\n\n\tif ( toString.call(checkSet) === \"[object Array]\" ) {\n\t\tif ( !prune ) {\n\t\t\tresults.push.apply( results, checkSet );\n\t\t} else if ( context && context.nodeType === 1 ) {\n\t\t\tfor ( var i = 0; checkSet[i] != null; i++ ) {\n\t\t\t\tif ( checkSet[i] && (checkSet[i] === true || checkSet[i].nodeType === 1 && contains(context, checkSet[i])) ) {\n\t\t\t\t\tresults.push( set[i] );\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tfor ( var i = 0; checkSet[i] != null; i++ ) {\n\t\t\t\tif ( checkSet[i] && checkSet[i].nodeType === 1 ) {\n\t\t\t\t\tresults.push( set[i] );\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t} else {\n\t\tmakeArray( checkSet, results );\n\t}\n\n\tif ( extra ) {\n\t\tSizzle( extra, origContext, results, seed );\n\t\tSizzle.uniqueSort( results );\n\t}\n\n\treturn results;\n};\n\nSizzle.uniqueSort = function(results){\n\tif ( sortOrder ) {\n\t\thasDuplicate = false;\n\t\tresults.sort(sortOrder);\n\n\t\tif ( hasDuplicate ) {\n\t\t\tfor ( var i = 1; i < results.length; i++ ) {\n\t\t\t\tif ( results[i] === results[i-1] ) {\n\t\t\t\t\tresults.splice(i--, 1);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n};\n\nSizzle.matches = function(expr, set){\n\treturn Sizzle(expr, null, null, set);\n};\n\nSizzle.find = function(expr, context, isXML){\n\tvar set, match;\n\n\tif ( !expr ) {\n\t\treturn [];\n\t}\n\n\tfor ( var i = 0, l = Expr.order.length; i < l; i++ ) {\n\t\tvar type = Expr.order[i], match;\n\t\t\n\t\tif ( (match = Expr.match[ type ].exec( expr )) ) {\n\t\t\tvar left = RegExp.leftContext;\n\n\t\t\tif ( left.substr( left.length - 1 ) !== \"\\\\\" ) {\n\t\t\t\tmatch[1] = (match[1] || \"\").replace(/\\\\/g, \"\");\n\t\t\t\tset = Expr.find[ type ]( match, context, isXML );\n\t\t\t\tif ( set != null ) {\n\t\t\t\t\texpr = expr.replace( Expr.match[ type ], \"\" );\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tif ( !set ) {\n\t\tset = context.getElementsByTagName(\"*\");\n\t}\n\n\treturn {set: set, expr: expr};\n};\n\nSizzle.filter = function(expr, set, inplace, not){\n\tvar old = expr, result = [], curLoop = set, match, anyFound,\n\t\tisXMLFilter = set && set[0] && isXML(set[0]);\n\n\twhile ( expr && set.length ) {\n\t\tfor ( var type in Expr.filter ) {\n\t\t\tif ( (match = Expr.match[ type ].exec( expr )) != null ) {\n\t\t\t\tvar filter = Expr.filter[ type ], found, item;\n\t\t\t\tanyFound = false;\n\n\t\t\t\tif ( curLoop == result ) {\n\t\t\t\t\tresult = [];\n\t\t\t\t}\n\n\t\t\t\tif ( Expr.preFilter[ type ] ) {\n\t\t\t\t\tmatch = Expr.preFilter[ type ]( match, curLoop, inplace, result, not, isXMLFilter );\n\n\t\t\t\t\tif ( !match ) {\n\t\t\t\t\t\tanyFound = found = true;\n\t\t\t\t\t} else if ( match === true ) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif ( match ) {\n\t\t\t\t\tfor ( var i = 0; (item = curLoop[i]) != null; i++ ) {\n\t\t\t\t\t\tif ( item ) {\n\t\t\t\t\t\t\tfound = filter( item, match, i, curLoop );\n\t\t\t\t\t\t\tvar pass = not ^ !!found;\n\n\t\t\t\t\t\t\tif ( inplace && found != null ) {\n\t\t\t\t\t\t\t\tif ( pass ) {\n\t\t\t\t\t\t\t\t\tanyFound = true;\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tcurLoop[i] = false;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} else if ( pass ) {\n\t\t\t\t\t\t\t\tresult.push( item );\n\t\t\t\t\t\t\t\tanyFound = true;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif ( found !== undefined ) {\n\t\t\t\t\tif ( !inplace ) {\n\t\t\t\t\t\tcurLoop = result;\n\t\t\t\t\t}\n\n\t\t\t\t\texpr = expr.replace( Expr.match[ type ], \"\" );\n\n\t\t\t\t\tif ( !anyFound ) {\n\t\t\t\t\t\treturn [];\n\t\t\t\t\t}\n\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Improper expression\n\t\tif ( expr == old ) {\n\t\t\tif ( anyFound == null ) {\n\t\t\t\tthrow \"Syntax error, unrecognized expression: \" + expr;\n\t\t\t} else {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\told = expr;\n\t}\n\n\treturn curLoop;\n};\n\nvar Expr = Sizzle.selectors = {\n\torder: [ \"ID\", \"NAME\", \"TAG\" ],\n\tmatch: {\n\t\tID: /#((?:[\\w\\u00c0-\\uFFFF_-]|\\\\.)+)/,\n\t\tCLASS: /\\.((?:[\\w\\u00c0-\\uFFFF_-]|\\\\.)+)/,\n\t\tNAME: /\\[name=['\"]*((?:[\\w\\u00c0-\\uFFFF_-]|\\\\.)+)['\"]*\\]/,\n\t\tATTR: /\\[\\s*((?:[\\w\\u00c0-\\uFFFF_-]|\\\\.)+)\\s*(?:(\\S?=)\\s*(['\"]*)(.*?)\\3|)\\s*\\]/,\n\t\tTAG: /^((?:[\\w\\u00c0-\\uFFFF\\*_-]|\\\\.)+)/,\n\t\tCHILD: /:(only|nth|last|first)-child(?:\\((even|odd|[\\dn+-]*)\\))?/,\n\t\tPOS: /:(nth|eq|gt|lt|first|last|even|odd)(?:\\((\\d*)\\))?(?=[^-]|$)/,\n\t\tPSEUDO: /:((?:[\\w\\u00c0-\\uFFFF_-]|\\\\.)+)(?:\\((['\"]*)((?:\\([^\\)]+\\)|[^\\2\\(\\)]*)+)\\2\\))?/\n\t},\n\tattrMap: {\n\t\t\"class\": \"className\",\n\t\t\"for\": \"htmlFor\"\n\t},\n\tattrHandle: {\n\t\thref: function(elem){\n\t\t\treturn elem.getAttribute(\"href\");\n\t\t}\n\t},\n\trelative: {\n\t\t\"+\": function(checkSet, part, isXML){\n\t\t\tvar isPartStr = typeof part === \"string\",\n\t\t\t\tisTag = isPartStr && !/\\W/.test(part),\n\t\t\t\tisPartStrNotTag = isPartStr && !isTag;\n\n\t\t\tif ( isTag && !isXML ) {\n\t\t\t\tpart = part.toUpperCase();\n\t\t\t}\n\n\t\t\tfor ( var i = 0, l = checkSet.length, elem; i < l; i++ ) {\n\t\t\t\tif ( (elem = checkSet[i]) ) {\n\t\t\t\t\twhile ( (elem = elem.previousSibling) && elem.nodeType !== 1 ) {}\n\n\t\t\t\t\tcheckSet[i] = isPartStrNotTag || elem && elem.nodeName === part ?\n\t\t\t\t\t\telem || false :\n\t\t\t\t\t\telem === part;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif ( isPartStrNotTag ) {\n\t\t\t\tSizzle.filter( part, checkSet, true );\n\t\t\t}\n\t\t},\n\t\t\">\": function(checkSet, part, isXML){\n\t\t\tvar isPartStr = typeof part === \"string\";\n\n\t\t\tif ( isPartStr && !/\\W/.test(part) ) {\n\t\t\t\tpart = isXML ? part : part.toUpperCase();\n\n\t\t\t\tfor ( var i = 0, l = checkSet.length; i < l; i++ ) {\n\t\t\t\t\tvar elem = checkSet[i];\n\t\t\t\t\tif ( elem ) {\n\t\t\t\t\t\tvar parent = elem.parentNode;\n\t\t\t\t\t\tcheckSet[i] = parent.nodeName === part ? parent : false;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tfor ( var i = 0, l = checkSet.length; i < l; i++ ) {\n\t\t\t\t\tvar elem = checkSet[i];\n\t\t\t\t\tif ( elem ) {\n\t\t\t\t\t\tcheckSet[i] = isPartStr ?\n\t\t\t\t\t\t\telem.parentNode :\n\t\t\t\t\t\t\telem.parentNode === part;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif ( isPartStr ) {\n\t\t\t\t\tSizzle.filter( part, checkSet, true );\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\t\"\": function(checkSet, part, isXML){\n\t\t\tvar doneName = done++, checkFn = dirCheck;\n\n\t\t\tif ( !/\\W/.test(part) ) {\n\t\t\t\tvar nodeCheck = part = isXML ? part : part.toUpperCase();\n\t\t\t\tcheckFn = dirNodeCheck;\n\t\t\t}\n\n\t\t\tcheckFn(\"parentNode\", part, doneName, checkSet, nodeCheck, isXML);\n\t\t},\n\t\t\"~\": function(checkSet, part, isXML){\n\t\t\tvar doneName = done++, checkFn = dirCheck;\n\n\t\t\tif ( typeof part === \"string\" && !/\\W/.test(part) ) {\n\t\t\t\tvar nodeCheck = part = isXML ? part : part.toUpperCase();\n\t\t\t\tcheckFn = dirNodeCheck;\n\t\t\t}\n\n\t\t\tcheckFn(\"previousSibling\", part, doneName, checkSet, nodeCheck, isXML);\n\t\t}\n\t},\n\tfind: {\n\t\tID: function(match, context, isXML){\n\t\t\tif ( typeof context.getElementById !== \"undefined\" && !isXML ) {\n\t\t\t\tvar m = context.getElementById(match[1]);\n\t\t\t\treturn m ? [m] : [];\n\t\t\t}\n\t\t},\n\t\tNAME: function(match, context, isXML){\n\t\t\tif ( typeof context.getElementsByName !== \"undefined\" ) {\n\t\t\t\tvar ret = [], results = context.getElementsByName(match[1]);\n\n\t\t\t\tfor ( var i = 0, l = results.length; i < l; i++ ) {\n\t\t\t\t\tif ( results[i].getAttribute(\"name\") === match[1] ) {\n\t\t\t\t\t\tret.push( results[i] );\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn ret.length === 0 ? null : ret;\n\t\t\t}\n\t\t},\n\t\tTAG: function(match, context){\n\t\t\treturn context.getElementsByTagName(match[1]);\n\t\t}\n\t},\n\tpreFilter: {\n\t\tCLASS: function(match, curLoop, inplace, result, not, isXML){\n\t\t\tmatch = \" \" + match[1].replace(/\\\\/g, \"\") + \" \";\n\n\t\t\tif ( isXML ) {\n\t\t\t\treturn match;\n\t\t\t}\n\n\t\t\tfor ( var i = 0, elem; (elem = curLoop[i]) != null; i++ ) {\n\t\t\t\tif ( elem ) {\n\t\t\t\t\tif ( not ^ (elem.className && (\" \" + elem.className + \" \").indexOf(match) >= 0) ) {\n\t\t\t\t\t\tif ( !inplace )\n\t\t\t\t\t\t\tresult.push( elem );\n\t\t\t\t\t} else if ( inplace ) {\n\t\t\t\t\t\tcurLoop[i] = false;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn false;\n\t\t},\n\t\tID: function(match){\n\t\t\treturn match[1].replace(/\\\\/g, \"\");\n\t\t},\n\t\tTAG: function(match, curLoop){\n\t\t\tfor ( var i = 0; curLoop[i] === false; i++ ){}\n\t\t\treturn curLoop[i] && isXML(curLoop[i]) ? match[1] : match[1].toUpperCase();\n\t\t},\n\t\tCHILD: function(match){\n\t\t\tif ( match[1] == \"nth\" ) {\n\t\t\t\t// parse equations like 'even', 'odd', '5', '2n', '3n+2', '4n-1', '-n+6'\n\t\t\t\tvar test = /(-?)(\\d*)n((?:\\+|-)?\\d*)/.exec(\n\t\t\t\t\tmatch[2] == \"even\" && \"2n\" || match[2] == \"odd\" && \"2n+1\" ||\n\t\t\t\t\t!/\\D/.test( match[2] ) && \"0n+\" + match[2] || match[2]);\n\n\t\t\t\t// calculate the numbers (first)n+(last) including if they are negative\n\t\t\t\tmatch[2] = (test[1] + (test[2] || 1)) - 0;\n\t\t\t\tmatch[3] = test[3] - 0;\n\t\t\t}\n\n\t\t\t// TODO: Move to normal caching system\n\t\t\tmatch[0] = done++;\n\n\t\t\treturn match;\n\t\t},\n\t\tATTR: function(match, curLoop, inplace, result, not, isXML){\n\t\t\tvar name = match[1].replace(/\\\\/g, \"\");\n\t\t\t\n\t\t\tif ( !isXML && Expr.attrMap[name] ) {\n\t\t\t\tmatch[1] = Expr.attrMap[name];\n\t\t\t}\n\n\t\t\tif ( match[2] === \"~=\" ) {\n\t\t\t\tmatch[4] = \" \" + match[4] + \" \";\n\t\t\t}\n\n\t\t\treturn match;\n\t\t},\n\t\tPSEUDO: function(match, curLoop, inplace, result, not){\n\t\t\tif ( match[1] === \"not\" ) {\n\t\t\t\t// If we're dealing with a complex expression, or a simple one\n\t\t\t\tif ( chunker.exec(match[3]).length > 1 || /^\\w/.test(match[3]) ) {\n\t\t\t\t\tmatch[3] = Sizzle(match[3], null, null, curLoop);\n\t\t\t\t} else {\n\t\t\t\t\tvar ret = Sizzle.filter(match[3], curLoop, inplace, true ^ not);\n\t\t\t\t\tif ( !inplace ) {\n\t\t\t\t\t\tresult.push.apply( result, ret );\n\t\t\t\t\t}\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t} else if ( Expr.match.POS.test( match[0] ) || Expr.match.CHILD.test( match[0] ) ) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\t\n\t\t\treturn match;\n\t\t},\n\t\tPOS: function(match){\n\t\t\tmatch.unshift( true );\n\t\t\treturn match;\n\t\t}\n\t},\n\tfilters: {\n\t\tenabled: function(elem){\n\t\t\treturn elem.disabled === false && elem.type !== \"hidden\";\n\t\t},\n\t\tdisabled: function(elem){\n\t\t\treturn elem.disabled === true;\n\t\t},\n\t\tchecked: function(elem){\n\t\t\treturn elem.checked === true;\n\t\t},\n\t\tselected: function(elem){\n\t\t\t// Accessing this property makes selected-by-default\n\t\t\t// options in Safari work properly\n\t\t\telem.parentNode.selectedIndex;\n\t\t\treturn elem.selected === true;\n\t\t},\n\t\tparent: function(elem){\n\t\t\treturn !!elem.firstChild;\n\t\t},\n\t\tempty: function(elem){\n\t\t\treturn !elem.firstChild;\n\t\t},\n\t\thas: function(elem, i, match){\n\t\t\treturn !!Sizzle( match[3], elem ).length;\n\t\t},\n\t\theader: function(elem){\n\t\t\treturn /h\\d/i.test( elem.nodeName );\n\t\t},\n\t\ttext: function(elem){\n\t\t\treturn \"text\" === elem.type;\n\t\t},\n\t\tradio: function(elem){\n\t\t\treturn \"radio\" === elem.type;\n\t\t},\n\t\tcheckbox: function(elem){\n\t\t\treturn \"checkbox\" === elem.type;\n\t\t},\n\t\tfile: function(elem){\n\t\t\treturn \"file\" === elem.type;\n\t\t},\n\t\tpassword: function(elem){\n\t\t\treturn \"password\" === elem.type;\n\t\t},\n\t\tsubmit: function(elem){\n\t\t\treturn \"submit\" === elem.type;\n\t\t},\n\t\timage: function(elem){\n\t\t\treturn \"image\" === elem.type;\n\t\t},\n\t\treset: function(elem){\n\t\t\treturn \"reset\" === elem.type;\n\t\t},\n\t\tbutton: function(elem){\n\t\t\treturn \"button\" === elem.type || elem.nodeName.toUpperCase() === \"BUTTON\";\n\t\t},\n\t\tinput: function(elem){\n\t\t\treturn /input|select|textarea|button/i.test(elem.nodeName);\n\t\t}\n\t},\n\tsetFilters: {\n\t\tfirst: function(elem, i){\n\t\t\treturn i === 0;\n\t\t},\n\t\tlast: function(elem, i, match, array){\n\t\t\treturn i === array.length - 1;\n\t\t},\n\t\teven: function(elem, i){\n\t\t\treturn i % 2 === 0;\n\t\t},\n\t\todd: function(elem, i){\n\t\t\treturn i % 2 === 1;\n\t\t},\n\t\tlt: function(elem, i, match){\n\t\t\treturn i < match[3] - 0;\n\t\t},\n\t\tgt: function(elem, i, match){\n\t\t\treturn i > match[3] - 0;\n\t\t},\n\t\tnth: function(elem, i, match){\n\t\t\treturn match[3] - 0 == i;\n\t\t},\n\t\teq: function(elem, i, match){\n\t\t\treturn match[3] - 0 == i;\n\t\t}\n\t},\n\tfilter: {\n\t\tPSEUDO: function(elem, match, i, array){\n\t\t\tvar name = match[1], filter = Expr.filters[ name ];\n\n\t\t\tif ( filter ) {\n\t\t\t\treturn filter( elem, i, match, array );\n\t\t\t} else if ( name === \"contains\" ) {\n\t\t\t\treturn (elem.textContent || elem.innerText || \"\").indexOf(match[3]) >= 0;\n\t\t\t} else if ( name === \"not\" ) {\n\t\t\t\tvar not = match[3];\n\n\t\t\t\tfor ( var i = 0, l = not.length; i < l; i++ ) {\n\t\t\t\t\tif ( not[i] === elem ) {\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn true;\n\t\t\t}\n\t\t},\n\t\tCHILD: function(elem, match){\n\t\t\tvar type = match[1], node = elem;\n\t\t\tswitch (type) {\n\t\t\t\tcase 'only':\n\t\t\t\tcase 'first':\n\t\t\t\t\twhile ( (node = node.previousSibling) )  {\n\t\t\t\t\t\tif ( node.nodeType === 1 ) return false;\n\t\t\t\t\t}\n\t\t\t\t\tif ( type == 'first') return true;\n\t\t\t\t\tnode = elem;\n\t\t\t\tcase 'last':\n\t\t\t\t\twhile ( (node = node.nextSibling) )  {\n\t\t\t\t\t\tif ( node.nodeType === 1 ) return false;\n\t\t\t\t\t}\n\t\t\t\t\treturn true;\n\t\t\t\tcase 'nth':\n\t\t\t\t\tvar first = match[2], last = match[3];\n\n\t\t\t\t\tif ( first == 1 && last == 0 ) {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tvar doneName = match[0],\n\t\t\t\t\t\tparent = elem.parentNode;\n\t\n\t\t\t\t\tif ( parent && (parent.sizcache !== doneName || !elem.nodeIndex) ) {\n\t\t\t\t\t\tvar count = 0;\n\t\t\t\t\t\tfor ( node = parent.firstChild; node; node = node.nextSibling ) {\n\t\t\t\t\t\t\tif ( node.nodeType === 1 ) {\n\t\t\t\t\t\t\t\tnode.nodeIndex = ++count;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} \n\t\t\t\t\t\tparent.sizcache = doneName;\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tvar diff = elem.nodeIndex - last;\n\t\t\t\t\tif ( first == 0 ) {\n\t\t\t\t\t\treturn diff == 0;\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn ( diff % first == 0 && diff / first >= 0 );\n\t\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tID: function(elem, match){\n\t\t\treturn elem.nodeType === 1 && elem.getAttribute(\"id\") === match;\n\t\t},\n\t\tTAG: function(elem, match){\n\t\t\treturn (match === \"*\" && elem.nodeType === 1) || elem.nodeName === match;\n\t\t},\n\t\tCLASS: function(elem, match){\n\t\t\treturn (\" \" + (elem.className || elem.getAttribute(\"class\")) + \" \")\n\t\t\t\t.indexOf( match ) > -1;\n\t\t},\n\t\tATTR: function(elem, match){\n\t\t\tvar name = match[1],\n\t\t\t\tresult = Expr.attrHandle[ name ] ?\n\t\t\t\t\tExpr.attrHandle[ name ]( elem ) :\n\t\t\t\t\telem[ name ] != null ?\n\t\t\t\t\t\telem[ name ] :\n\t\t\t\t\t\telem.getAttribute( name ),\n\t\t\t\tvalue = result + \"\",\n\t\t\t\ttype = match[2],\n\t\t\t\tcheck = match[4];\n\n\t\t\treturn result == null ?\n\t\t\t\ttype === \"!=\" :\n\t\t\t\ttype === \"=\" ?\n\t\t\t\tvalue === check :\n\t\t\t\ttype === \"*=\" ?\n\t\t\t\tvalue.indexOf(check) >= 0 :\n\t\t\t\ttype === \"~=\" ?\n\t\t\t\t(\" \" + value + \" \").indexOf(check) >= 0 :\n\t\t\t\t!check ?\n\t\t\t\tvalue && result !== false :\n\t\t\t\ttype === \"!=\" ?\n\t\t\t\tvalue != check :\n\t\t\t\ttype === \"^=\" ?\n\t\t\t\tvalue.indexOf(check) === 0 :\n\t\t\t\ttype === \"$=\" ?\n\t\t\t\tvalue.substr(value.length - check.length) === check :\n\t\t\t\ttype === \"|=\" ?\n\t\t\t\tvalue === check || value.substr(0, check.length + 1) === check + \"-\" :\n\t\t\t\tfalse;\n\t\t},\n\t\tPOS: function(elem, match, i, array){\n\t\t\tvar name = match[2], filter = Expr.setFilters[ name ];\n\n\t\t\tif ( filter ) {\n\t\t\t\treturn filter( elem, i, match, array );\n\t\t\t}\n\t\t}\n\t}\n};\n\nvar origPOS = Expr.match.POS;\n\nfor ( var type in Expr.match ) {\n\tExpr.match[ type ] = new RegExp( Expr.match[ type ].source + /(?![^\\[]*\\])(?![^\\(]*\\))/.source );\n}\n\nvar makeArray = function(array, results) {\n\tarray = Array.prototype.slice.call( array, 0 );\n\n\tif ( results ) {\n\t\tresults.push.apply( results, array );\n\t\treturn results;\n\t}\n\t\n\treturn array;\n};\n\n// Perform a simple check to determine if the browser is capable of\n// converting a NodeList to an array using builtin methods.\ntry {\n\tArray.prototype.slice.call( document.documentElement.childNodes, 0 );\n\n// Provide a fallback method if it does not work\n} catch(e){\n\tmakeArray = function(array, results) {\n\t\tvar ret = results || [];\n\n\t\tif ( toString.call(array) === \"[object Array]\" ) {\n\t\t\tArray.prototype.push.apply( ret, array );\n\t\t} else {\n\t\t\tif ( typeof array.length === \"number\" ) {\n\t\t\t\tfor ( var i = 0, l = array.length; i < l; i++ ) {\n\t\t\t\t\tret.push( array[i] );\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tfor ( var i = 0; array[i]; i++ ) {\n\t\t\t\t\tret.push( array[i] );\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn ret;\n\t};\n}\n\nvar sortOrder;\n\nif ( document.documentElement.compareDocumentPosition ) {\n\tsortOrder = function( a, b ) {\n\t\tvar ret = a.compareDocumentPosition(b) & 4 ? -1 : a === b ? 0 : 1;\n\t\tif ( ret === 0 ) {\n\t\t\thasDuplicate = true;\n\t\t}\n\t\treturn ret;\n\t};\n} else if ( \"sourceIndex\" in document.documentElement ) {\n\tsortOrder = function( a, b ) {\n\t\tvar ret = a.sourceIndex - b.sourceIndex;\n\t\tif ( ret === 0 ) {\n\t\t\thasDuplicate = true;\n\t\t}\n\t\treturn ret;\n\t};\n} else if ( document.createRange ) {\n\tsortOrder = function( a, b ) {\n\t\tvar aRange = a.ownerDocument.createRange(), bRange = b.ownerDocument.createRange();\n\t\taRange.selectNode(a);\n\t\taRange.collapse(true);\n\t\tbRange.selectNode(b);\n\t\tbRange.collapse(true);\n\t\tvar ret = aRange.compareBoundaryPoints(Range.START_TO_END, bRange);\n\t\tif ( ret === 0 ) {\n\t\t\thasDuplicate = true;\n\t\t}\n\t\treturn ret;\n\t};\n}\n\n// Check to see if the browser returns elements by name when\n// querying by getElementById (and provide a workaround)\n(function(){\n\t// We're going to inject a fake input element with a specified name\n\tvar form = document.createElement(\"div\"),\n\t\tid = \"script\" + (new Date).getTime();\n\tform.innerHTML = \"<a name='\" + id + \"'/>\";\n\n\t// Inject it into the root element, check its status, and remove it quickly\n\tvar root = document.documentElement;\n\troot.insertBefore( form, root.firstChild );\n\n\t// The workaround has to do additional checks after a getElementById\n\t// Which slows things down for other browsers (hence the branching)\n\tif ( !!document.getElementById( id ) ) {\n\t\tExpr.find.ID = function(match, context, isXML){\n\t\t\tif ( typeof context.getElementById !== \"undefined\" && !isXML ) {\n\t\t\t\tvar m = context.getElementById(match[1]);\n\t\t\t\treturn m ? m.id === match[1] || typeof m.getAttributeNode !== \"undefined\" && m.getAttributeNode(\"id\").nodeValue === match[1] ? [m] : undefined : [];\n\t\t\t}\n\t\t};\n\n\t\tExpr.filter.ID = function(elem, match){\n\t\t\tvar node = typeof elem.getAttributeNode !== \"undefined\" && elem.getAttributeNode(\"id\");\n\t\t\treturn elem.nodeType === 1 && node && node.nodeValue === match;\n\t\t};\n\t}\n\n\troot.removeChild( form );\n\troot = form = null; // release memory in IE\n})();\n\n(function(){\n\t// Check to see if the browser returns only elements\n\t// when doing getElementsByTagName(\"*\")\n\n\t// Create a fake element\n\tvar div = document.createElement(\"div\");\n\tdiv.appendChild( document.createComment(\"\") );\n\n\t// Make sure no comments are found\n\tif ( div.getElementsByTagName(\"*\").length > 0 ) {\n\t\tExpr.find.TAG = function(match, context){\n\t\t\tvar results = context.getElementsByTagName(match[1]);\n\n\t\t\t// Filter out possible comments\n\t\t\tif ( match[1] === \"*\" ) {\n\t\t\t\tvar tmp = [];\n\n\t\t\t\tfor ( var i = 0; results[i]; i++ ) {\n\t\t\t\t\tif ( results[i].nodeType === 1 ) {\n\t\t\t\t\t\ttmp.push( results[i] );\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tresults = tmp;\n\t\t\t}\n\n\t\t\treturn results;\n\t\t};\n\t}\n\n\t// Check to see if an attribute returns normalized href attributes\n\tdiv.innerHTML = \"<a href='#'></a>\";\n\tif ( div.firstChild && typeof div.firstChild.getAttribute !== \"undefined\" &&\n\t\t\tdiv.firstChild.getAttribute(\"href\") !== \"#\" ) {\n\t\tExpr.attrHandle.href = function(elem){\n\t\t\treturn elem.getAttribute(\"href\", 2);\n\t\t};\n\t}\n\n\tdiv = null; // release memory in IE\n})();\n\nif ( document.querySelectorAll ) (function(){\n\tvar oldSizzle = Sizzle, div = document.createElement(\"div\");\n\tdiv.innerHTML = \"<p class='TEST'></p>\";\n\n\t// Safari can't handle uppercase or unicode characters when\n\t// in quirks mode.\n\tif ( div.querySelectorAll && div.querySelectorAll(\".TEST\").length === 0 ) {\n\t\treturn;\n\t}\n\t\n\tSizzle = function(query, context, extra, seed){\n\t\tcontext = context || document;\n\n\t\t// Only use querySelectorAll on non-XML documents\n\t\t// (ID selectors don't work in non-HTML documents)\n\t\tif ( !seed && context.nodeType === 9 && !isXML(context) ) {\n\t\t\ttry {\n\t\t\t\treturn makeArray( context.querySelectorAll(query), extra );\n\t\t\t} catch(e){}\n\t\t}\n\t\t\n\t\treturn oldSizzle(query, context, extra, seed);\n\t};\n\n\tfor ( var prop in oldSizzle ) {\n\t\tSizzle[ prop ] = oldSizzle[ prop ];\n\t}\n\n\tdiv = null; // release memory in IE\n})();\n\nif ( document.getElementsByClassName && document.documentElement.getElementsByClassName ) (function(){\n\tvar div = document.createElement(\"div\");\n\tdiv.innerHTML = \"<div class='test e'></div><div class='test'></div>\";\n\n\t// Opera can't find a second classname (in 9.6)\n\tif ( div.getElementsByClassName(\"e\").length === 0 )\n\t\treturn;\n\n\t// Safari caches class attributes, doesn't catch changes (in 3.2)\n\tdiv.lastChild.className = \"e\";\n\n\tif ( div.getElementsByClassName(\"e\").length === 1 )\n\t\treturn;\n\n\tExpr.order.splice(1, 0, \"CLASS\");\n\tExpr.find.CLASS = function(match, context, isXML) {\n\t\tif ( typeof context.getElementsByClassName !== \"undefined\" && !isXML ) {\n\t\t\treturn context.getElementsByClassName(match[1]);\n\t\t}\n\t};\n\n\tdiv = null; // release memory in IE\n})();\n\nfunction dirNodeCheck( dir, cur, doneName, checkSet, nodeCheck, isXML ) {\n\tvar sibDir = dir == \"previousSibling\" && !isXML;\n\tfor ( var i = 0, l = checkSet.length; i < l; i++ ) {\n\t\tvar elem = checkSet[i];\n\t\tif ( elem ) {\n\t\t\tif ( sibDir && elem.nodeType === 1 ){\n\t\t\t\telem.sizcache = doneName;\n\t\t\t\telem.sizset = i;\n\t\t\t}\n\t\t\telem = elem[dir];\n\t\t\tvar match = false;\n\n\t\t\twhile ( elem ) {\n\t\t\t\tif ( elem.sizcache === doneName ) {\n\t\t\t\t\tmatch = checkSet[elem.sizset];\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tif ( elem.nodeType === 1 && !isXML ){\n\t\t\t\t\telem.sizcache = doneName;\n\t\t\t\t\telem.sizset = i;\n\t\t\t\t}\n\n\t\t\t\tif ( elem.nodeName === cur ) {\n\t\t\t\t\tmatch = elem;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\telem = elem[dir];\n\t\t\t}\n\n\t\t\tcheckSet[i] = match;\n\t\t}\n\t}\n}\n\nfunction dirCheck( dir, cur, doneName, checkSet, nodeCheck, isXML ) {\n\tvar sibDir = dir == \"previousSibling\" && !isXML;\n\tfor ( var i = 0, l = checkSet.length; i < l; i++ ) {\n\t\tvar elem = checkSet[i];\n\t\tif ( elem ) {\n\t\t\tif ( sibDir && elem.nodeType === 1 ) {\n\t\t\t\telem.sizcache = doneName;\n\t\t\t\telem.sizset = i;\n\t\t\t}\n\t\t\telem = elem[dir];\n\t\t\tvar match = false;\n\n\t\t\twhile ( elem ) {\n\t\t\t\tif ( elem.sizcache === doneName ) {\n\t\t\t\t\tmatch = checkSet[elem.sizset];\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tif ( elem.nodeType === 1 ) {\n\t\t\t\t\tif ( !isXML ) {\n\t\t\t\t\t\telem.sizcache = doneName;\n\t\t\t\t\t\telem.sizset = i;\n\t\t\t\t\t}\n\t\t\t\t\tif ( typeof cur !== \"string\" ) {\n\t\t\t\t\t\tif ( elem === cur ) {\n\t\t\t\t\t\t\tmatch = true;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t} else if ( Sizzle.filter( cur, [elem] ).length > 0 ) {\n\t\t\t\t\t\tmatch = elem;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\telem = elem[dir];\n\t\t\t}\n\n\t\t\tcheckSet[i] = match;\n\t\t}\n\t}\n}\n\nvar contains = document.compareDocumentPosition ?  function(a, b){\n\treturn a.compareDocumentPosition(b) & 16;\n} : function(a, b){\n\treturn a !== b && (a.contains ? a.contains(b) : true);\n};\n\nvar isXML = function(elem){\n\treturn elem.nodeType === 9 && elem.documentElement.nodeName !== \"HTML\" ||\n\t\t!!elem.ownerDocument && elem.ownerDocument.documentElement.nodeName !== \"HTML\";\n};\n\nvar posProcess = function(selector, context){\n\tvar tmpSet = [], later = \"\", match,\n\t\troot = context.nodeType ? [context] : context;\n\n\t// Position selectors must be done after the filter\n\t// And so must :not(positional) so we move all PSEUDOs to the end\n\twhile ( (match = Expr.match.PSEUDO.exec( selector )) ) {\n\t\tlater += match[0];\n\t\tselector = selector.replace( Expr.match.PSEUDO, \"\" );\n\t}\n\n\tselector = Expr.relative[selector] ? selector + \"*\" : selector;\n\n\tfor ( var i = 0, l = root.length; i < l; i++ ) {\n\t\tSizzle( selector, root[i], tmpSet );\n\t}\n\n\treturn Sizzle.filter( later, tmpSet );\n};\n\nreturn Sizzle;\n\n})();\n","pre":true},"sdk/jsio/math/geom/Rect.js":{"path":"sdk/jsio/math/geom/Rect.js","friendlyPath":"math.geom.Rect","directory":"sdk/jsio/math/geom/","filename":"Rect.js","baseMod":"math","basePath":"sdk/jsio","src":"jsio(\"import lib.Enum\");\njsio(\"import .Point\");\njsio(\"import .Line\");\njsio(\"import .intersect\");\n\n/**\n * Model a rectangle.\n */\n\nvar sdk_jsio_math_geom_Rect=__class__;var Rect = exports=sdk_jsio_math_geom_Rect(function sdk_jsio_math_geom_Rect(){return this.init&&this.init.apply(this,arguments)},function() {\n\tthis.init = function(a, b, c, d) {\n\t\tswitch(arguments.length) {\n\t\t\tcase 0: // init\n\t\t\t\tthis.width = this.height = this.x = this.y = 0;\n\t\t\t\tbreak;\n\t\t\tcase 1: // copy\n\t\t\t\tthis.width = a.width;\n\t\t\t\tthis.height = a.height;\n\t\t\t\tthis.x = a.x;\n\t\t\t\tthis.y = a.y;\n\t\t\t\tbreak;\n\t\t\tcase 2: // (x, y), (width, height)\n\t\t\t\tthis.x = a.x;\n\t\t\t\tthis.y = a.y;\n\t\t\t\tthis.width = b.x;\n\t\t\t\tthis.height = b.y;\n\t\t\t\tbreak;\n\t\t\tcase 3: // (x, y), width, height\n\t\t\t\tthis.x = a.x;\n\t\t\t\tthis.y = a.y;\n\t\t\t\tthis.width = b;\n\t\t\t\tthis.height = c;\n\t\t\t\tbreak;\n\t\t\tcase 4: // x, y, width, height\n\t\t\t\tthis.x = a;\n\t\t\t\tthis.y = b;\n\t\t\t\tthis.width = c;\n\t\t\t\tthis.height = d;\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\t/**\n\t * Normalize negative height and width dimensions by adjusting the position\n\t * of the rect.\n\t */\n\t\n\tthis.normalize = function() {\n\t\tif (this.width < 0) {\n\t\t\tthis.x -= this.width;\n\t\t\tthis.width = -this.width;\n\t\t}\n\t\t\n\t\tif (this.height < 0) {\n\t\t\tthis.y -= this.height;\n\t\t\tthis.height = -this.height;\n\t\t}\n\t\treturn this;\n\t}\n\n\t/**\n\t * Generate the intersection of a rectange with another rectangle.\n\t */\n\n\tthis.intersectRect = function (rect) {\n\t\tif (intersect.isRectAndRect(this, rect)) {\n\t\t\tvar x1 = this.x;\n\t\t\tvar y1 = this.y;\n\t\t\tvar x2 = this.x + this.width;\n\t\t\tvar y2 = this.y + this.height;\n\n\t\t\tthis.x = Math.max(x1, rect.x),\n\t\t\tthis.y = Math.max(y1, rect.y),\n\t\t\tthis.width = Math.min(x2, rect.x + rect.width) - this.x;\n\t\t\tthis.height = Math.min(y2, rect.y + rect.height) - this.y;\n\t\t} else {\n\t\t\tthis.width = 0;\n\t\t\tthis.height = 0;\n\t\t}\n\t}\n\t\n\t/**\n\t * Generate the union of a rectange with another rectangle.\n\t */\n\t\n\tthis.unionRect = function(rect) {\n\t\tthis.normalize();\n\t\tif (rect.normalize) { rect.normalize(); }\n\t\t\n\t\tvar x2 = this.x + this.width,\n\t\t\ty2 = this.y + this.height;\n\t\t\n\t\tvar rx2 = rect.x + rect.width,\n\t\t\try2 = rect.y + rect.height;\n\t\t\n\t\tthis.x = this.x < rect.x ? this.x : rect.x;\n\t\tthis.y = this.y < rect.y ? this.y : rect.y;\n\t\t\n\t\tthis.width = (x2 > rx2 ? x2 : rx2) - this.x;\n\t\tthis.height = (y2 > ry2 ? y2 : ry2) - this.y;\n\t};\n\n\t/**\n\t * Get a point for the given corner.\n\t */\n\t\n\tthis.getCorner = function(i) {\n\t\tswitch(i) {\n\t\t\tcase CORNERS.TOP_LEFT:\n\t\t\t\treturn new Point(this.x, this.y);\n\t\t\tcase CORNERS.TOP_RIGHT:\n\t\t\t\treturn new Point(this.x + this.width, this.y);\n\t\t\tcase CORNERS.BOTTOM_LEFT:\n\t\t\t\treturn new Point(this.x, this.y + this.height);\n\t\t\tcase CORNERS.BOTTOM_RIGHT:\n\t\t\t\treturn new Point(this.x + this.width, this.y + this.height);\n\t\t}\n\t}\n\t\n\t/**\n\t * Return a line corresponding to the given side.\n\t */\n\t\n\tthis.getSide = function(i) {\n\t\tswitch(i) {\n\t\t\tcase SIDES.TOP:\n\t\t\t\treturn new Line(this.getCorner(CORNERS.TOP_LEFT), this.getCorner(CORNERS.TOP_RIGHT));\n\t\t\tcase SIDES.RIGHT:\n\t\t\t\treturn new Line(this.getCorner(CORNERS.TOP_RIGHT), this.getCorner(CORNERS.BOTTOM_RIGHT));\n\t\t\tcase SIDES.BOTTOM:\n\t\t\t\treturn new Line(this.getCorner(CORNERS.BOTTOM_RIGHT), this.getCorner(CORNERS.BOTTOM_LEFT));\n\t\t\tcase SIDES.LEFT:\n\t\t\t\treturn new Line(this.getCorner(CORNERS.BOTTOM_LEFT), this.getCorner(CORNERS.TOP_LEFT));\n\t\t}\n\t}\n\n\t/**\n\t * Return the center point of a rectangle.\n\t */\n\t\n\tthis.getCenter = function() {\n\t\treturn new Point(this.x + this.width / 2, this.y + this.height / 2);\n\t}\n});\n\nvar SIDES = Rect.SIDES = lib.Enum('TOP', 'BOTTOM', 'LEFT', 'RIGHT');\nvar CORNERS = Rect.CORNERS = lib.Enum('TOP_LEFT', 'TOP_RIGHT', 'BOTTOM_RIGHT', 'BOTTOM_LEFT');\n","pre":true},"sdk/jsio/math/geom/Point.js":{"path":"sdk/jsio/math/geom/Point.js","friendlyPath":".Point","directory":"sdk/jsio/math/geom/","filename":"Point.js","src":"/**\n * @package math.geom.Point;\n * Models a Point in 2D space.\n */\n\nvar sdk_jsio_math_geom_Point=__class__;var Point = exports=sdk_jsio_math_geom_Point(function sdk_jsio_math_geom_Point(){return this.init&&this.init.apply(this,arguments)},function() {\n\tthis.init = function(a, b) {\n\t\tswitch(arguments.length) {\n\t\t\tcase 0:\n\t\t\t\tthis.x = 0;\n\t\t\t\tthis.y = 0;\n\t\t\t\tbreak;\n\t\t\tcase 1:\n\t\t\t\tthis.x = a.x || 0;\n\t\t\t\tthis.y = a.y || 0;\n\t\t\t\tbreak;\n\t\t\tcase 2:\n\t\t\t\tthis.x = a || 0;\n\t\t\t\tthis.y = b || 0;\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\t/**\n\t * Rotates this point around the origin by a value in radians.\n\t */\n\t\n\tthis.rotate = function(r) {\n\t\tvar x = this.x,\n\t\t\ty = this.y,\n\t\t\tcosr = Math.cos(r),\n\t\t\tsinr = Math.sin(r);\n\t\t\n\t\tthis.x = x * cosr - y * sinr;\n\t\tthis.y = x * sinr + y * cosr;\n\t\t\n\t\treturn this;\n\t}\n\n\t/**\n\t * Translate this point by two scalars or by another point.\n\t */\n\t\n\tthis.translate = this.add = function(x, y) {\n\t\tif (typeof x == 'number') {\n\t\t\tthis.x += x;\n\t\t\tthis.y += y;\n\t\t} else {\n\t\t\tthis.x += x.x;\n\t\t\tthis.y += x.y;\n\t\t}\n\t\treturn this;\n\t}\n\n\t/**\n\t * Subtract this point by two scalars or by another point.\n\t */\n\t\n\tthis.subtract = function(x, y) {\n\t\tif (typeof x == 'number') {\n\t\t\tthis.x -= x;\n\t\t\tthis.y -= y;\n\t\t} else {\n\t\t\tthis.x -= x.x;\n\t\t\tthis.y -= x.y;\n\t\t}\n\t\treturn this;\n\t}\n\n\t/**\n\t * Scale this number.\n\t */\n\n\tthis.scale = function(sx, sy) {\n\t\t//if no scaleY specified\n\t\tif(sy === undefined) sy = sx;\n\n\t\tthis.x *= sx;\n\t\tthis.y *= sy;\n\t\treturn this;\n\t}\n\n\t/**\n\t * Set the magnitude of this point at a constant angle.\n\t */\n\t\n\tthis.setMagnitude = function(m) {\n\t\tvar theta = this.getAngle();\n\t\tthis.x = m * Math.cos(theta);\n\t\tthis.y = m * Math.sin(theta);\n\t\treturn this;\n\t}\n\n\t/**\n\t * Normalize this point to the unit circle.\n\t */\n\t\n\tthis.normalize = function() {\n\t\tvar m = this.getMagnitude();\n\t\tthis.x /= m;\n\t\tthis.y /= m;\n\t\treturn this;\n\t};\n\n\t/**\n\t * Add magnitude to this point.\n\t */\n\t\n\tthis.addMagnitude = function(m) {\n\t\treturn this.setMagnitude(this.getMagnitude() + m);\n\t};\n\n\tthis.getMagnitude = function() {\n\t\treturn Math.sqrt(this.x * this.x + this.y * this.y);\n\t};\n\n\tthis.getSquaredMagnitude = function() {\n\t\treturn this.x * this.x + this.y * this.y;\n\t};\n\n\tthis.getDirection = this.getAngle = function() {\n\t\treturn Math.atan2(this.y, this.x);\n\t};\n\t\n});\n\n/*\n */\nPoint.getPolarR = function(x, y) { \n\tthrow \"notImplemented\";\n}\n\n/*\n\t### Class Method: Point.getPolarTheta (x, y)\n\t1. `x {number}`\n\t2. `y {number}`\n\t3. Return: `{number}`\n*/\nPoint.getPolarTheta = function(x, y) { \n\tvar val = Math.atan2(y,x) + (Math.PI * 2); \n\treturn val > Math.PI * 2 ? val % (Math.PI * 2) : val;\n}\n\n/*\n\t### Class Method: Point.add (a, b, c, d)\n\t### Class Method: Point.translate (a, b, c, d)\n\t1. `a {number}`\n\t2. `b {number}`\n\t3. `c {number}`\n\t4. `d {number}`\n\t5. Return: `{Point}`\n */\nPoint.add = Point.translate = function(a, b, c, d) {\n\tswitch(arguments.length) {\n\t\tcase 2: return new Point(a).add(b);\n\t\tcase 3: return new Point(a).add(b, c);\n\t\tcase 4: return new Point(a, b).add(c, d);\n\t}\n}\n\n/*\n\t### Class Method: Point.subtract (a, b, c, d)\n\t1. `a {number}`\n\t2. `b {number}`\n\t3. `c {number}`\n\t4. `d {number}`\n\t5. Return: `{Point}`\n */\nPoint.subtract = function(a, b, c, d) {\n\tswitch(arguments.length) {\n\t\tcase 2: return new Point(a).subtract(b);\n\t\tcase 3: return new Point(a).subtract(b, c);\n\t\tcase 4: return new Point(a, b).subtract(c, d);\n\t}\n}\n\n/*\n\t### Class Method: Point.scale (a, b, c) \n\t1. `a {number}`\n\t2. `b {number}`\n\t3. `c {number}`\n\t4. Return: `{Point}`\n */\nPoint.scale = function(a, b, c) {\n\tswitch(arguments.length) {\n\t\tcase 2: return new Point(a).scale(b);\n\t\tcase 3: return new Point(a, b).scale(c);\n\t}\n}\n\n/*\n\t### Class Method: Point.setMagnitude (a, b, c)\n\t1. `a {number}`\n\t2. `b {number}`\n\t3. `c {number}`\n\t4. Return: `{Point}`\n*/\nPoint.setMagnitude = function(a, b, c) {\n\tswitch(arguments.length) {\n\t\tcase 2: return new Point(a).setMagnitude(c);\n\t\tcase 3: return new Point(a, b).setMagnitude(c);\n\t}\n}\n\n/*\n\t### Class Method: Point.addMagnitude (a, b, c)\n\t1. `a {number}`\n\t2. `b {number}`\n\t3. `c {number}`\n\t4. Return: `{Point}`\n */\nPoint.addMagnitude = function(a, b, c) {\n\tswitch(arguments.length) {\n\t\tcase 2: pt = new Point(a); break;\n\t\tcase 3: pt = new Point(a, b); b = c; break;\n\t}\n\t\n\treturn pt.addMagnitude(b);\n}\n\n/*\n\t### Class Method: Point.getMagnitude (a, b)\n\t1. `a {number}`\n\t2. `b {number}`\n\t3. Return: `{Point}`\n */\nPoint.getMagnitude = function(a, b) { return new Point(a, b).getMagnitude(); }\n\n/*\n\t### Class Method: Point.rotate (a, b, c)\n\t1. `a {number}`\n\t2. `b {number}`\n\t3. `c {number}`\n\t4. Return: `{Point}`\n */\nPoint.rotate = function(a, b, c) {\n\tswitch(arguments.length) {\n\t\tcase 2: return new Point(a).rotate(b);\n\t\tcase 3: return new Point(a, b).rotate(c);\n\t}\n}\n\n/**\n * Treat two points as vectors and project a onto b\n *  (a dot unit(b)) * unit(b)\n */\nPoint.project = function (a, b) {\n\tvar unitB = new Point(b).normalize();\n\treturn unitB.scale(unitB.x * a.x + unitB.y * a.y);\n}\n","pre":true},"sdk/jsio/math/geom/Line.js":{"path":"sdk/jsio/math/geom/Line.js","friendlyPath":".Line","directory":"sdk/jsio/math/geom/","filename":"Line.js","src":"jsio(\"import .Point\");\n\nvar sdk_jsio_math_geom_Line=__class__;exports=sdk_jsio_math_geom_Line(function sdk_jsio_math_geom_Line(){return this.init&&this.init.apply(this,arguments)},function() {\n\tthis.init = function(a, b, c, d) {\n\t\tswitch(arguments.length) {\n\t\t\tcase 0:\n\t\t\t\tthis.start = new Point();\n\t\t\t\tthis.end = new Point();\n\t\t\t\tbreak;\n\t\t\tcase 1:\n\t\t\t\tthis.start = new Point(a.start);\n\t\t\t\tthis.end = new Point(a.end);\n\t\t\t\tbreak;\n\t\t\tcase 2:\n\t\t\t\tthis.start = new Point(a);\n\t\t\t\tthis.end = new Point(b);\n\t\t\t\tbreak;\n\t\t\tcase 3:\n\t\t\t\tthis.start = new Point(a);\n\t\t\t\tthis.end = new Point(b, c);\n\t\t\t\tbreak;\n\t\t\tcase 4:\n\t\t\tdefault:\n\t\t\t\tthis.start = new Point(a, b);\n\t\t\t\tthis.end = new Point(c, d);\n\t\t\t\tbreak;\n\t\t}\n\t}\n\t\n\tthis.getMagnitude = \n\tthis.getLength = function() {\n\t\tvar dx = this.end.x - this.start.x,\n\t\t\tdy = this.end.y - this.start.y;\n\t\t\n\t\treturn Math.sqrt(dx * dx + dy * dy);\n\t}\n});\n","pre":true},"sdk/jsio/math/geom/intersect.js":{"path":"sdk/jsio/math/geom/intersect.js","friendlyPath":".intersect","directory":"sdk/jsio/math/geom/","filename":"intersect.js","src":"jsio(\"import .Point\");\njsio(\"import .Line\");\njsio(\"import .Rect\");\n\n/**\n * @package math.geom.intersect\n */\nvar intersect = exports;\n\nintersect.pointAndRect = intersect.ptAndRect = function (pt, rect) {\n\tvar x = pt.x,\n\t\t\ty = pt.y;\n\treturn (x >= rect.x &&\n\t\t\t\t\tx <= rect.x + rect.width &&\n\t\t\t\t\ty >= rect.y &&\n\t\t\t\t\ty <= rect.y + rect.height);\n};\n\nintersect.rectAndPoint = intersect.rectAndPt = function (rect, pt) {\n\treturn intersect.pointAndRect(pt, rect);\n};\n\nintersect.pointAndCircle = intersect.ptAndCirc = function(pt, circle) {\n\tvar dx = pt.x - circle.x,\n\t\t\tdy = pt.y - circle.y;\n\treturn dx * dx + dy * dy < circle.radius * circle.radius;\n};\n\nintersect.circleAndPoint = intersect.circAndPt = function (circle, pt) {\n\treturn intersect.pointAndCircle(pt, circle);\n};\n\nintersect.isRectAndRect = function (rect1, rect2) {\n\treturn !((rect1.y + rect1.height < rect2.y) ||\n\t\t\t\t\t (rect2.y + rect2.height < rect1.y) ||\n\t\t\t\t\t (rect1.x + rect1.width < rect2.x) ||\n\t\t\t\t\t (rect2.x + rect2.width < rect1.x));\n};\n\nintersect.circleAndRect = function(circle, rect) {\n\tif (intersect.pointAndRect(circle, rect)) {\n\t\treturn true;\n\t}\n\treturn (intersect.lineAndCircle(rect.getSide(1), circle) ||\n\t\t\t\t\tintersect.lineAndCircle(rect.getSide(2), circle) ||\n\t\t\t\t\tintersect.lineAndCircle(rect.getSide(3), circle) ||\n\t\t\t\t\tintersect.lineAndCircle(rect.getSide(4), circle));\n};\n\nintersect.rectAndCircle = function(rect, circle) {\n\treturn intersect.circleAndRect(circle, rect);\n};\n\nintersect.lineAndCircle = function (line, circle) {\n\tvar vec = intersect.pointToLine(circle, line);\n\treturn vec.getMagnitude() < circle.radius;\n};\n\nintersect.circleAndLine = function (circle, line) {\n\treturn intersect.lineAndCircle(line, circle);\n};\n\n// returns line from pt to nearest pt on line\nintersect.pointToLine = intersect.ptToLine = function (pt, line) {\n\tvar dx = (line.end.x - line.start.x),\n\t\t\tdy = (line.end.y - line.start.y),\n\t\t\tu = ((pt.x - line.start.x) * dx\t// TODO can we abstract this from 2D to 2D/3D?\n\t\t\t\t\t + (pt.y - line.start.y) * dy) / (dx * dx + dy * dy);\n\n\tvar i;\n\tif (u < 0) {\n\t\ti = new Point(line.start);\n\t} else if (u > 1) {\n\t\ti = new Point(line.end);\n\t} else {\n\t\ti = new Point(line.start.x + u * dx, line.start.y + u * dy);\n\t}\n\treturn new Line(i, pt);\n};\n\n// returns rectangle of intersection\nintersect.rectAndRect = function (rect1, rect2) {\n\tjsio(\"import .Rect\");\n\treturn (intersect.rectAndRect = function(rect1, rect2) {\n\t\tif (rect1 === true) { return new Rect(rect2); }\n\t\tif (rect2 === true) { return new Rect(rect2); }\n\n\t\tif (intersect.isRectAndRect(rect1, rect2)) {\n\t\t\tvar x1 = Math.max(rect1.x, rect2.x),\n\t\t\t\t\ty1 = Math.max(rect1.y, rect2.y),\n\t\t\t\t\tx2 = Math.min(rect1.x + rect1.width, rect2.x + rect2.width),\n\t\t\t\t\ty2 = Math.min(rect1.y + rect1.height, rect2.y + rect2.height);\n\t\t\treturn new Rect(x1, y1, x2 - x1, y2 - y1);\n\t\t}\n\t\treturn null;\n\t})(rect1, rect2);\n}\n","pre":true},"sdk/timestep/platforms/browser/Audio.js":{"path":"sdk/timestep/platforms/browser/Audio.js","friendlyPath":".Audio","directory":"sdk/timestep/platforms/browser/","filename":"Audio.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @package timestep.env.browser.Audio;\n *\n * Audio implementation using the <audio> element for browsers.\n */\n\nexports = function (opts) {\n\tvar defaults = {\n\t\tautoplay: false,\n\t\tpreload: 'auto',\n\t\tvolume: 1.0,\n\t\tloop: 0,\n\t\tsrc: ''\n\t};\n\t\n\topts = merge(opts, defaults);\n\tvar el = document.createElement('Audio');\n\t\n\tel.autoplay = opts.autoplay;\n\tel.preload = opts.preload;\n\tel.volume = opts.volume;\n\tel.loop = opts.loop;\n\tel.src = opts.src;\n\t\n\treturn el;\n};","pre":true},"sdk/timestep/platforms/browser/Canvas.js":{"path":"sdk/timestep/platforms/browser/Canvas.js","friendlyPath":".Canvas","directory":"sdk/timestep/platforms/browser/","filename":"Canvas.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @package timestep.env.browser.Canvas;\n *\n * Canvas implementation for browsers. Wraps a Context2D.\n */\n\njsio(\"import .Context2D\");\n\nvar sdk_timestep_platforms_browser_Canvas=__class__;exports=sdk_timestep_platforms_browser_Canvas(function sdk_timestep_platforms_browser_Canvas(){return this.init&&this.init.apply(this,arguments)},function () {\n\tthis.init = function (opts) {\n\t\topts = merge(opts, {width: 300, height: 200});\n\t\tvar ctx = new Context2D(opts);\n\t\tvar el = this._el = ctx.getElement();\n\t\tel.getContext = function () { return ctx; }\n\t\tel.complete = true;\n\t\treturn el;\n\t}\n});\n","pre":true},"sdk/timestep/platforms/browser/Context2D.js":{"path":"sdk/timestep/platforms/browser/Context2D.js","friendlyPath":".Context2D","directory":"sdk/timestep/platforms/browser/","filename":"Context2D.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @package timestep.env.browser.Context2D;\n *\n * Generates a rendering context by creating our own Canvas element.\n */\n\njsio(\"import device\");\njsio(\"import .FontRenderer\");\n\nfunction setter(name) {\n\treturn (function (val) {\n\t\treturn (this[name] = val);\n\t});\n}\n\nfunction getter(name) {\n\treturn (function (val) {\n\t\treturn this[name];\n\t});\n}\n\nexports = function (opts) {\n\tvar parentNode = opts && opts.parent,\n\t\tel = opts && opts.el || document.createElement('canvas');\n\t\n\t//if (!parentNode) {\n\t//\tel.style.cssText = 'position: absolute; top: 0px; left: 0px; z-index: 1';\n\t//}\n\t\n\tel.width = opts.width;\n\tel.height = opts.height;\n\t\n\tvar ctx = el.getContext('2d');\n\tctx.font = '11px ' + device.defaultFontFamily;\n\tctx.getElement = function () { return el; }\n\t\n\tctx.reset = function () {}\n\t\n\tctx.clear = function () {\n\t\t//el.width = el.width;\n\t\tthis.clearRect(0, 0, el.width, el.height);\n\t};\n\t\n\tctx.clipRect = function (x, y, w, h) {\n\t\tctx.beginPath();\n\t\tctx.rect(x, y, w, h);\n\t\tctx.clip();\n\t}\n\t\n\tctx.swap = function () {};\n\tctx.execSwap = function () {};\n\t\n\tctx.circle = function (x, y, radius) {\n\t\tthis.beginPath();\n\t\tthis.arc(x, y, radius, 0, 2 * Math.PI, true);\n\t}\n\n\tvar _lastPointSprite = {\n\t\timg: null,\n\t\tcolor: null,\n\t\tcanvas: null\n\t};\n\n\tctx.drawPointSprites = function (x1, y1, x2, y2) {\n\t\tvar sprite = this.pointSprite;\n\t\tif (!sprite || !sprite.complete) { return; }\n\n\t\tvar width = sprite.width;\n\t\tvar height = sprite.height;\n\t\tvar canvas = _lastPointSprite.canvas || (_lastPointSprite.canvas = document.createElement('canvas'));\n\n\t\tif (sprite != _lastPointSprite.img || this.strokeStyle != _lastPointSprite.color) {\n\t\t\t_lastPointSprite.img = sprite;\n\t\t\t_lastPointSprite.color = this.strokeStyle;\n\t\t\tcanvas.width = width;\n\t\t\tcanvas.height = height;\n\t\t\tvar ctx = canvas.getContext('2d');\n\t\t\tctx.fillStyle = this.strokeStyle;\n\t\t\tctx.fillRect(0, 0, width, height);\n\t\t\tctx.globalCompositeOperation = 'destination-in';\n\t\t\tctx.drawImage(sprite, 0, 0);\n\t\t}\n\n\t\t// Add points to the buffer so there are drawing points every X pixels\n\t\tvar dx = x2 - x1;\n\t\tvar dy = y2 - y1;\n\t\tvar count = Math.ceil(Math.sqrt(dx * dx + dy * dy) / this.pointSpriteStep);\n\t\tif (count < 1) { count = 1; }\n\n\t\tvar d = this.lineWidth;\n\t\tfor (var i = 0; i < count; ++i) {\n\t\t\tvar x = x1 + dx * i / count;\n\t\t\tvar y = y1 + dy * i / count;\n\t\t\tthis.drawImage(canvas, 0, 0, width, height, x - d / 2, y - d / 2, d, d);\n\t\t}\n\t}\n\t\n\tctx.roundRect = function (x, y, width, height, radius) {\n\t\tthis.beginPath();\n\t\tthis.moveTo(x,y+radius);\n\t\tthis.lineTo(x,y+height-radius);\n\t\tthis.quadraticCurveTo(x,y+height,x+radius,y+height);\n\t\tthis.lineTo(x+width-radius,y+height);\n\t\tthis.quadraticCurveTo(x+width,y+height,x+width,y+height-radius);\n\t\tthis.lineTo(x+width,y+radius);\n\t\tthis.quadraticCurveTo(x+width,y,x+width-radius,y);\n\t\tthis.lineTo(x+radius,y);\n\t\tthis.quadraticCurveTo(x,y,x,y+radius);\n\t}\n\n\tctx.loadIdentity = function () {\n\t\tthis.setTransform(1, 0, 0, 1, 0, 0);\n\t}\n\t\n\tctx.measureText = FontRenderer.wrapMeasureText(ctx.measureText);\n\tctx.fillText = FontRenderer.wrapFillText(ctx.fillText);\n\tctx.strokeText = FontRenderer.wrapStrokeText(ctx.strokeText);\n\n\tctx.filters = {}\n\tctx.setFilters = function (filters) {\n\t\tthis.clearFilters();\n\t\tfor (var name in filters) {\n\t\t\tthis.filters[name] = filters[name];\n\t\t}\n\t}\n\n\tctx.clearFilters = function () {\n\t\tfor (var name in this.filters) {\n\t\t\tdelete this.filters[name];\n\t\t}\n\t}\n\t\n\treturn ctx;\n};\n","pre":true},"sdk/timestep/platforms/browser/FontRenderer.js":{"path":"sdk/timestep/platforms/browser/FontRenderer.js","friendlyPath":".FontRenderer","directory":"sdk/timestep/platforms/browser/","filename":"FontRenderer.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @package env.browser.FontRenderer;\n *\n * Render fonts or custom fonts on a Canvas context.\n */\n\njsio(\"import ui.resource.Font as Font\");\njsio(\"import ui.Engine as Engine\");\njsio(\"import .FontBuffer as FontBuffer\");\n\njsio(\"import device\");\n\nvar _customFonts = {};\nvar _customFontInfo = {};\nvar _fontMap = {};\nvar _buffers = [];\nvar _fontBuffer = false;\nvar _origMeasureText;\n\nfunction loadCustomFontImage(customFont, index) {\n\tvar image = new Image();\n\n\timage.onload = function () {\n\t\timage.onload = null;\n\t\tcustomFont.imagesLoaded++;\n\t\tcustomFont.loaded = (customFont.imagesLoaded === customFont.imagesTotal);\n\t}\n\timage.src = 'resources/fonts/' + customFont.filename + index + '.png';\n\n\treturn image;\n}\n\nfunction findVerticalInfo(dimensions) {\n\t// A..Z, a..z, all\n\tvar ranges = [{start: 0x41, end: 0x5A}, {start: 0x61, end: 0x7A}, {start: 0x20, end: 0xFF}];\n\tvar range;\n\tvar dimension;\n\tvar found = false;\n\tvar baseline = 0;\n\tvar bottom = 0;\n\tvar i;\n\n\tfor (i = 0; i < ranges.length; i++) {\n\t\trange = ranges[i];\n\t\tfor (j = range.start; j <= range.end; j++) {\n\t\t\tdimension = dimensions[j];\n\t\t\tif (dimension) {\n\t\t\t\tbaseline = Math.max(baseline, dimension.h);\n\t\t\t\tbottom = Math.max(bottom, dimension.h);\n\t\t\t\tfound = true;\n\t\t\t}\n\t\t}\n\t\tif (found) {\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn {\n\t\tbaseline: baseline,\n\t\tbottom: bottom\n\t};\n}\n\nfunction findHorizontalInfo(dimensions) {\n\t// a..z, A..Z\n\tvar ranges = [{start: 0x61, end: 0x7A}, {start: 0x41, end: 0x5A}, {start: 0x20, end: 0xFF}];\n\tvar range;\n\tvar dimension;\n\tvar width = 0;\n\tvar count = 0;\n\tvar i, j;\n\n\tfor (i = 0; i < ranges.length; i++) {\n\t\trange = ranges[i];\n\t\tfor (j = range.start; j <= range.end; j++) {\n\t\t\tdimension = dimensions[j];\n\t\t\tif (dimension) {\n\t\t\t\twidth += dimension.w;\n\t\t\t\tcount++;\n\t\t\t}\n\t\t}\n\t\tif (count !== 0) {\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn {\n\t\twidth: width / count\n\t};\n}\n\nfunction loadingCustomFont (customFont) {\n\tif (customFont.imagesLoaded !== -1) {\n\t \treturn !customFont.loaded;\n\t}\n\n\tvar settings = customFont.settings;\n\tvar filename = settings.filename;\n\tvar images;\n\tvar image;\n\tvar info;\n\tvar i, j;\n\n\tif (_customFontInfo[filename]) {\n\t\tinfo = _customFontInfo[filename];\n\t\tcustomFont.dimensions = info.dimensions;\n\t\tcustomFont.horizontal = info.horizontal;\n\t\tcustomFont.vertical = info.vertical;\n\t} else {\n\t\t// Load from legacy .js extension or newer .json extension.\n\t\tvar basename = 'resources/fonts/' + filename;\n\t\tvar json = CACHE[basename + '.json'];\n\t\tif (json == null) {\n\t\t\tjson = CACHE[basename + '.js'];\n\t\t\tif (json) {\n\t\t\t\tjson = json.replace(/^\\s*exports\\s*=\\s*|;\\s*$/g, '');\n\t\t\t} else {\n\t\t\t\tlogger.warn('Could not load font', customFont.name, 'from cached path', basename);\n\t\t\t}\n\t\t}\n\t\tcustomFont.dimensions = JSON.parse(json);\n\t\tcustomFont.horizontal = findHorizontalInfo(customFont.dimensions);\n\t\tcustomFont.vertical = findVerticalInfo(customFont.dimensions);\n\n\t\t_customFontInfo[filename] = {\n\t\t\tdimensions: customFont.dimensions,\n\t\t\thorizontal: customFont.horizontal,\n\t\t\tvertical: customFont.vertical\n\t\t};\n\t}\n\n\tcustomFont.images = [];\n\tcustomFont.imagesLoaded = 0;\n\n\timages = customFont.images;\n\n\tswitch (customFont.type) {\n\t\tcase 'color':\n\t\t\tfor (i = 0; i < settings.count; i++) {\n\t\t\t\timages[i] = [];\n\t\t\t\timages[i].push(loadCustomFontImage(customFont, '_0_' + i));\n\t\t\t\tcustomFont.imagesTotal++;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase 'composite':\n\t\t\tfor (i = 1; i < 3; i++) {\n\t\t\t\timages[i - 1] = [];\n\t\t\t\tfor (j = 0; j < settings.count; j++) {\n\t\t\t\t\timages[i - 1].push(loadCustomFontImage(customFont, '_' + i + '_' + j));\n\t\t\t\t\tcustomFont.imagesTotal++;\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t}\n\n\treturn true;\n}\n\n(function () {\n\tvar manifest = window.CONFIG;\n\tif (manifest && manifest.fonts) {\n\t\tvar fonts = manifest.fonts;\n\t\tvar font;\n\t\tvar customFont;\n\t\tvar i = fonts.length;\n\n\t\twhile (i) {\n\t\t\tfont = fonts[--i];\n\t\t\tcustomFont = {\n\t\t\t\tfilename: font.filename,\n\t\t\t\tsettings: font,\n\t\t\t\timagesLoaded: -1,\n\t\t\t\timagesTotal: 0,\n\t\t\t\tloaded: false,\n\t\t\t\ttype: 'color'\n\t\t\t};\n\t\t\t_customFonts[font.contextName + ' color'] = customFont;\n\t\t\tloadingCustomFont(customFont);\n\n\t\t\tcustomFont = {\n\t\t\t\t// The difference between color- and composite-filename is in the suffix!!!\n\t\t\t\tfilename: font.filename,\n\t\t\t\tsettings: font,\n\t\t\t\timagesLoaded: -1,\n\t\t\t\timagesTotal: 0,\n\t\t\t\tloaded: false,\n\t\t\t\ttype: 'composite'\n\t\t\t}\n\t\t\t_customFonts[font.contextName + ' composite'] = customFont;\n\t\t\tloadingCustomFont(customFont);\n\t\t}\n\t}\n})();\n\nfunction getCanvas() {\n\treturn document.createElement('canvas');\n}\n\nfunction getBuffers(srcBuffers, customFont, color, type) {\n\tvar key = customFont.filename + '_' + color + '_' + type;\n\tvar dstBuffers = [];\n\tvar i;\n\n\tif (!_buffers[key]) {\n\t\t_buffers[key] = {\n\t\t\tbuffers: dstBuffers\n\t\t}\n\t\tfor (i = 0; i < srcBuffers.length; i++) {\n\t\t\tvar canvas = getCanvas(),\n\t\t\t\tctx = canvas.getContext('2d'),\n\t\t\t\twidth = srcBuffers[i].width,\n\t\t\t\theight = srcBuffers[i].height;\n\n\t\t\tdstBuffers[i] = canvas;\n\n\t\t\tcanvas.width = width;\n\t\t\tcanvas.height = height;\n\n\t\t\tctx.save();\n\t\t\tctx.fillStyle = color;\n\t\t\tctx.fillRect(0, 0, width, height);\n\t\t\tctx.globalCompositeOperation = 'destination-in';\n\t\t\tctx.drawImage(srcBuffers[i], 0, 0);\n\t\t\tctx.restore();\n\t\t}\n\t}\n\t\n\t_buffers[key].lastUsed = +new Date();\n\treturn _buffers[key].buffers;\n}\n\nfunction measure(ctx, fontInfo, text) {\n\tvar customFont = fontInfo.customFont;\n\tvar dimensions = customFont.dimensions;\n\tvar scale = fontInfo.scale;\n\tvar outline = (customFont.settings.outline || 0) * scale;\n\tvar tracking = (customFont.settings.tracking || 0) * scale;\n\tvar width = 0;\n\tvar failed = true;\n\n\tif (dimensions) {\n\t\tvar i = 0;\n\t\tvar j = text.length;\n\n\t\tfailed = false;\n\n\t\twhile ((i < j) && !failed) {\n\t\t\tcharacter = text.charCodeAt(i);\n\t\t\tswitch (character) {\n\t\t\t\tcase 9: // tab...\n\t\t\t\t\twidth += customFont.horizontal.width * 4 * scale;\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 32: // space...\n\t\t\t\t\twidth += customFont.horizontal.width * scale;\n\t\t\t\t\tbreak;\n\n\t\t\t\tdefault:\n\t\t\t\t\tif (dimensions[character]) {\n\t\t\t\t\t\tcharacter = dimensions[character];\n\t\t\t\t\t\twidth += (character.ow - 2) * scale;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tfailed = true;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\twidth += tracking - outline;\n\t\t\ti++;\n\t\t}\n\t}\n\n\tif (failed) {\n\t\tvar font = ctx.font;\n\t\tctx.font = fontInfo.size.value + fontInfo.size.unit + ' ' + (ctx.defaultFontFamily || device.defaultFontFamily);\n\t\tvar result = {failed: true, width: _origMeasureText.apply(ctx, [text])};\n\t\tctx.font = font;\n\n\t\treturn result;\n\t}\n\n\treturn {failed: false, width: width + 2 * scale};\n}\n\nfunction renderCustomFont(ctx, x, y, text, color, fontInfo, index) {\n\tvar measureInfo = measure(ctx, fontInfo, text);\n\n\tif (measureInfo.failed) {\n\t\treturn false;\n\t}\n\n\tvar customFont = fontInfo.customFont;\n\tvar srcBuffers = customFont.images[index];\n\tvar dimensions = customFont.dimensions;\n\tvar scale = fontInfo.scale;\n\tvar width = measureInfo.width;\n\tvar outline = (customFont.settings.outline || 0) * scale;\n\tvar tracking = (customFont.settings.tracking || 0) * scale;\n\n\tswitch (ctx.textBaseline) {\n\t\tcase 'alphabetic':\n\t\t\ty -= customFont.vertical.baseline * scale;\n\t\t\tbreak;\n\t\tcase 'middle':\n\t\t\ty -= (customFont.vertical.bottom / 2) * scale;\n\t\t\tbreak;\n\t\tcase 'bottom':\n\t\t\ty -= customFont.vertical.bottom * scale;\n\t\t\tbreak;\n\t}\n\n\tswitch (ctx.textAlign) {\n\t\tcase 'center':\n\t\t\tx -= width / 2;\n\t\t\tbreak;\n\t\tcase 'right':\n\t\t\tx -= width;\n\t\t\tbreak;\n\t}\n\n\tvar buffer = false;\n\tvar bufferX = x;\n\tvar bufferY = y;\n\tvar character;\n\n\tif (buffer) {\n\t\tx = buffer.x;\n\t\ty = buffer.y;\n\t\tctx = buffer.ctx;\n\t}\n\n\tif (customFont.type === 'composite') {\n\t\tsrcBuffers = getBuffers(srcBuffers, customFont, color, index);\n\t}\n\n\tif (!buffer || buffer.refresh) {\n\t\tvar i = 0;\n\t\tvar j = text.length;\n\t\twhile (i < j) {\n\t\t\tcharacter = text.charCodeAt(i);\n\t\t\tswitch (character) {\n\t\t\t\tcase 9: // tab...\n\t\t\t\t\tx += customFont.horizontal.width * 4 * scale + tracking - outline;\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 32: // space...\n\t\t\t\t\tx += customFont.horizontal.width * scale + tracking - outline;\n\t\t\t\t\tbreak;\n\n\t\t\t\tdefault:\n\t\t\t\t\tcharacter = dimensions[character];\n\t\t\t\t\tctx.drawImage(\n\t\t\t\t\t\tsrcBuffers[character.i],\n\t\t\t\t\t\tcharacter.x,\n\t\t\t\t\t\tcharacter.y,\n\t\t\t\t\t\tcharacter.w,\n\t\t\t\t\t\tcharacter.h, \n\t\t\t\t\t\tx,\n\t\t\t\t\t\ty + (character.oh - 1) * scale,\n\t\t\t\t\t\t(character.w - 2) * scale,\n\t\t\t\t\t\t(character.h - 2) * scale\n\t\t\t\t\t);\n\t\t\t\t\tx += (character.ow - 2) * scale + tracking - outline;\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\ti++;\n\t\t}\n\t}\n\n\tif (buffer) {\n\t\tthis.drawImage(\n\t\t\tbuffer.ctx.canvas,\n\t\t\tbuffer.x,\n\t\t\tbuffer.y,\n\t\t\tbuffer.width,\n\t\t\tbuffer.height,\n\t\t\tbufferX,\n\t\t\tbufferY,\n\t\t\tbuffer.width,\n\t\t\tbuffer.height\n\t\t);\n\t}\n\n\treturn true;\n};\n\nexports.findFontInfo = function (ctx) {\n\tvar font = Font.parse(ctx.font);\n\tvar name = font.getName();\n\tif (name && _customFonts[name]) {\n\t\tcustomFont = _customFonts[name];\n\t\tfont.customFont = customFont;\n\t\tfont.scale = font.getSize() / customFont.settings.size;\n\t\treturn font;\n\t}\n\n\treturn false;\n}\n\nexports.wrapMeasureText = function (origMeasureText) {\n\t_origMeasureText = origMeasureText;\n\n\treturn function (text) {\n\t\tvar fontInfo = exports.findFontInfo(this);\n\n\t\tif (!fontInfo) {\n\t\t\treturn origMeasureText.apply(this, arguments);\n\t\t}\n\t\tvar measureInfo = measure(this, fontInfo, text);\n\n\t\tif (measureInfo.failed) {\n\t\t\treturn origMeasureText.apply(this, arguments);\n\t\t}\n\t\treturn measureInfo;\n\t}\n};\n\nexports.wrapFillText = function (origFillText) {\n\treturn function (text, x, y) {\n\t\tvar fontInfo = exports.findFontInfo(this);\n\n\t\tif (!fontInfo) {\n\t\t\treturn origFillText.apply(this, arguments);\n\t\t}\n\t\tif (loadingCustomFont(fontInfo.customFont)) {\n\t\t\treturn;\n\t\t}\n\t\tif (isNaN(x)) {\n\t\t\tx = 0;\n\t\t}\n\t\tif (isNaN(y)) {\n\t\t\ty = 0;\n\t\t}\n\n\t\tif (!renderCustomFont(this, x, y, text + '', this.fillStyle, fontInfo, 0)) {\n\t\t\tvar font = this.font;\n\t\t\tthis.font = fontInfo.size.value + fontInfo.size.unit + ' ' + (this.defaultFontFamily || device.defaultFontFamily);\n\t\t\torigFillText.apply(this, [text, x, y]);\n\t\t\tthis.font = font;\n\t\t}\n\t}\n};\n\nexports.wrapStrokeText = function (origStrokeText) {\n\treturn function (text, x, y) {\n\t\tvar fontInfo = exports.findFontInfo(this);\n\n\t\tif (!fontInfo) {\n\t\t\treturn origStrokeText.apply(this, arguments);\n\t\t}\n\t\tif (loadingCustomFont(fontInfo.customFont)) {\n\t\t\treturn;\n\t\t}\n\t\tif (isNaN(x)) {\n\t\t\tx = 0;\n\t\t}\n\t\tif (isNaN(y)) {\n\t\t\ty = 0;\n\t\t}\n\n\t\tif (!renderCustomFont(this, x, y, text + '', this.strokeStyle, fontInfo, 1)) {\n\t\t\tvar font = this.font;\n\t\t\tthis.font = fontInfo.size.value + fontInfo.size.unit + ' ' + (this.defaultFontFamily || device.defaultFontFamily);\n\t\t\torigStrokeText.apply(this, [text, x, y]);\n\t\t\tthis.font = font;\n\t\t}\n\t}\n};\n\nexports.getFontBuffer = function () {\n\treturn _fontBuffer;\n};","pre":true},"sdk/timestep/ui/Engine.js":{"path":"sdk/timestep/ui/Engine.js","friendlyPath":"ui.Engine","directory":"sdk/timestep/ui/","filename":"Engine.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @class ui.Engine\n *\n * This is the game engine for timestep. It is built on a scene graph composed\n * of \"views\", and has canvas and DOM rendering backends.\n *\n * Responsibilities for the application engine includes initializing the canvas,\n * input and key listeners, game loop, animation tick, the view hierarchy and\n * rendering the scene graph.\n *\n * Not to be confused with GC.Application, the superclass exposed to games which\n * controls the game loop. A single ui.Engine is instantiated for\n * games which resides at GC.app.engine.\n *\n * @doc http://doc.gameclosure.com/api/appengine.html\n * @docsrc https://github.com/gameclosure/doc/blob/master/api/appengine.md\n */\n\njsio(\"import event.Emitter as Emitter\");\n\njsio(\"import event.input.dispatch as dispatch\");\n\njsio(\"import timer\");\njsio(\"import ui.backend.ReflowManager as ReflowManager\");\n\njsio(\"import device\");\n\nvar _timers = [];\ntimer.onTick = function (dt) {\n\tvar i = _timers.length;\n\twhile (i--) {\n\t\t_timers[i](dt);\n\t}\n}\n\nvar __instance = null;\n\n/**\n * @extends event.Emitter\n */\nvar sdk_timestep_ui_Engine=__class__;var Application = exports=sdk_timestep_ui_Engine(function sdk_timestep_ui_Engine(){return this.init&&this.init.apply(this,arguments)},Emitter, function (supr) {\n\tthis.init = function (opts) {\n\t\tif (!__instance) {\n\t\t\tjsio(\"import .StackView\");\n\n\t\t\t__instance = this;\n\t\t}\n\n\t\tvar canvas = opts && opts.canvas;\n\t\tif (typeof canvas == 'string' && GLOBAL.document && document.getElementById) {\n\t\t\tcanvas = document.getElementById(canvas);\n\t\t}\n\n\t\tthis._opts = opts = merge(opts, {\n\t\t\tkeyListenerEnabled: true,\n\t\t\twidth: canvas && canvas.width || device.width,\n\t\t\theight: canvas && canvas.height || device.height,\n\t\t\tview: null,\n\t\t\tdtFixed: 0,\n\t\t\tdtMinimum: 0,\n\t\t\tclearEachFrame: true,\n\t\t\talwaysRepaint: true,\n\t\t\trepaintOnEvent: true,\n\t\t\tmergeMoveEvents: false,\n\t\t\tcontinuousInputCheck: !device.isMobileBrowser && !device.isMobile,\n\t\t\tshowFPS: false\n\t\t});\n\n\t\t_timers.push(bind(this, this._tick));\n\n\t\tthis._doubleBuffered = true;\n\t\tthis._countdown = null;\n\n\t\tif (!device.useDOM) {\n\t\t\tvar Canvas = device.get('Canvas');\n\t\t\tthis._rootElement = new Canvas({\n\t\t\t\tel: canvas, // use an existing canvas if one was provided, but wrap the 2D context\n\t\t\t\twidth: opts.width,\n\t\t\t\theight: opts.height,\n\t\t\t\toffscreen: false\n\t\t\t});\n\n\t\t\tthis._ctx = this._rootElement.getContext('2d');\n\t\t\tthis._ctx.font = '11px ' + device.defaultFontFamily;\n\t\t}\n\n\t\tthis._view = opts.view || new StackView();\n\t\tthis._view.style.update({\n\t\t\twidth: opts.width,\n\t\t\theight: opts.height\n\t\t});\n\n\t\tif (device.useDOM) {\n\t\t\tthis._rootElement = this._view.getBacking().getElement();\n\t\t}\n\n\t\t// __root is a pointer to the Engine instance that a view\n\t\t// is currently attached to.  If __root is null, the view\n\t\t// is not currently in a view hierarchy.\n\t\tthis._view.__root = this;\n\t\t\n\t\tthis._events = [];\n\n\t\tif (dispatch.KeyListener) {\n\t\t\tthis._keyListener = new dispatch.KeyListener();\n\t\t}\n\n\t\tthis._inputListener = new dispatch.InputListener({\n\t\t\trootView: this._view,\n\t\t\tel: this._rootElement,\n\t\t\tkeyListener: this._keyListener\n\t\t});\n\n\t\tthis._reflowManager = ReflowManager.get();\n\n\t\tthis._view.setReflowManager(this._reflowManager);\n\n\t\tthis._tickBuffer = 0;\n\t\tthis._onTick = [];\n\n\t\t// configure auto-layout in the browser (expand\n\t\t// to fill the viewport)\n\t\tif (device.name == 'browser') {\n\t\t\tif (canvas) {\n\t\t\t\tdevice.width = canvas.width;\n\t\t\t\tdevice.height = canvas.height;\n\t\t\t\tdevice.screen.width = canvas.width;\n\t\t\t\tdevice.screen.height = canvas.height;\n\t\t\t} else {\n\t\t\t\tvar doc = device.get('doc');\n\t\t\t\tif (doc) {\n\t\t\t\t\tdoc.setEngine(this);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis.updateOpts(this._opts);\n\t};\n\n\tthis.updateOpts = function (opts) {\n\t\tthis._opts = merge(opts, this._opts);\n\t\tif (this._keyListener) {\n\t\t\tthis._keyListener.setEnabled(this._opts.keyListenerEnabled);\n\t\t}\n\n\t\tif (this._opts.scaleUI) {\n\t\t\tif (Array.isArray(this._opts.scaleUI)) {\n\t\t\t\tif (this._opts.scaleUI.length != 2) {\n\t\t\t\t\tthrow new Error(\"Illegal value for engine option scaleUI: \" + this._opts.scaleUI);\n\t\t\t\t}\n\t\t\t\tthis.scaleUI(this._opts.scaleUI[0], this._opts.scaleUI[1]);\n\t\t\t} else {\n\t\t\t\tthis.scaleUI(576, 1024);\n\t\t\t}\n\t\t}\n\n\t\tif (this._opts.noReflow) {\n\t\t\tthis._reflowManager = null;\n\t\t\tthis._view.setReflowManager(null);\n\t\t}\n\n\t\tif (this._opts.showFPS) {\n\t\t\tif (!this._applicationFPS) {\n\t\t\t\tjsio(\"import ui.backend.debug.FPSView as FPSView\");\n\t\t\t\tthis._applicationFPS = new FPSView({application: this});\n\t\t\t}\n\t\t\t\n\t\t\tthis._renderFPS = bind(this._applicationFPS, this._applicationFPS.render);\n\t\t\tthis._tickFPS = bind(this._applicationFPS, this._applicationFPS.tick);\n\t\t} else {\n\t\t\tthis._renderFPS = function () {};\n\t\t\tthis._tickFPS = function () {};\n\t\t}\n\t};\n\n\tthis.scaleUI = function (w, h) {\n\t\tif (device.height > device.width) {\n\t\t\tthis._view.baseWidth = w;\n\t\t\tthis._view.baseHeight = device.height * (w / device.width);\n\t\t\tthis._view.scale = device.width / this._view.baseWidth;\n\t\t} else {\n\t\t\tthis._view.baseWidth = h;\n\t\t\tthis._view.baseHeight = device.height * (h / device.width);\n\t\t\tthis._view.scale = device.height / this._view.baseHeight;\n\t\t}\n\t\tthis._view.style.scale = this._view.scale;\n\t};\n\n\tthis.supports = function (key) {\n\t\treturn this._opts[key];\n\t};\n\n\t/* @internal */\n\tthis.getInput = function () {\n\t\treturn this._inputListener;\n\t};\n\n\tthis.getKeyListener = function () {\n\t\treturn this._keyListener;\n\t};\n\n\tthis.getEvents = function () {\n\t\treturn this._events;\n\t};\n\n\t// deprecating getCanvas...\n\tthis.getElement = this.getCanvas = function () {\n\t\treturn this._rootElement;\n\t};\n\n\tthis.getViewCtor = function () {\n\t\treturn View;\n\t};\n\n\tthis.getView = function () {\n\t\treturn this._view;\n\t};\n\n\tthis.setView = function (view) {\n\t\tthis._view = view; return this;\n\t};\n\n\tthis.getReflowManager = function () {\n\t\treturn this._reflowManager;\n\t};\n\n\tthis.show = function () {\n\t\tthis._rootElement.style.display = 'block';\n\t\treturn this;\n\t};\n\n\tthis.hide = function () {\n\t\tthis._rootElement.style.display = 'none';\n\t\treturn this;\n\t};\n\t\n\tthis.pause = function () {\n\t\tthis.stopLoop();\n\t\tif (this._keyListener) {\n\t\t\tthis._keyListener.setEnabled(false);\n\t\t}\n\t};\n\n\tthis.resume = function () {\n\t\tthis.startLoop();\n\t\tif (this._keyListener) {\n\t\t\tthis._keyListener.setEnabled(true);\n\t\t}\n\t};\n\n\tthis.stepFrame = function (n) {\n\t\tthis.pause();\n\t\tn = n || 1;\n\t\tthis._countdown = n;\n\t\tthis.resume();\n\t};\n\n\tthis.startLoop = function (dtMin) {\n\t\tif (this._running) { return; }\n\t\tthis._running = true;\n\t\t\n\t\tthis.now = 0;\n\t\ttimer.start(dtMin || this._opts.dtMinimum);\n\t\treturn this;\n\t};\n\n\tthis.stopLoop = function () {\n\t\tif (!this._running) { return; }\n\t\tthis._running = false;\n\t\t\n\t\ttimer.stop();\n\t\treturn this;\n\t};\n\n\tthis.isRunning = function () {\n\t\treturn this._running;\n\t};\n\n\tthis.doOnTick = function (cb) {\n\t\tif (arguments.length > 1) { cb = bind.apply(this, arguments); }\n\t\tthis._onTick.push(cb);\n\t};\n\n\tthis._tick = function (dt) {\n\t\t//if the countdown is defined\n\t\tif (this._countdown !== null) {\n\t\t\tthis._countdown--;\n\n\t\t\t//if below zero, stop timer\n\t\t\tif (this._countdown === -1) {\n\t\t\t\tthis.pause();\n\t\t\t\tthis._countdown = null;\n\t\t\t}\n\t\t}\n\n\t\tif (this._ctx) {\n\t\t\tvar el = this._ctx.getElement();\n\t\t\tvar s = this._view.style;\n\t\t\tif (el && (s.width != el.width / s.scale || s.height != el.height / s.scale)) {\n\t\t\t\ts.width = el.width / s.scale;\n\t\t\t\ts.height = el.height / s.scale;\n\t\t\t}\n\t\t}\n\n\t\tfor (var i = 0, cb; cb = this._onTick[i]; ++i) { cb(dt); }\n\n\t\tvar events = this._inputListener.getEvents();\n\t\tvar n = events.length;\n\n\t\tthis._events = events;\n\t\tif (this._opts._mergeMoveEvents) {\n\t\t\tvar hasMove = false;\n\t\t\tfor (var i = n - 1; i >= 0; --i) {\n\t\t\t\tif (events[i].type == dispatch.eventTypes.MOVE) {\n\t\t\t\t\tif (!hasMove) { \n\t\t\t\t\t\thasMove = true;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tevents.splice(i, 1);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tfor (var i = 0, evt; evt = events[i]; ++i) {\n\t\t\tevt.srcApp = this;\n\t\t\tdispatch.dispatchEvent(this._view, evt);\n\t\t}\n\n\t\tif (!device.useDOM) {\n\t\t\tif (i > 0) {\n\t\t\t\tif (this._opts.repaintOnEvent) { this.needsRepaint(); }\n\t\t\t} else if (this._opts.continuousInputCheck) {\n\t\t\t\tvar prevMove = dispatch._evtHistory['input:move'];\n\t\t\t\tif (prevMove) {\n\t\t\t\t\tdispatch.dispatchEvent(this._view, new dispatch.InputEvent(prevMove.id, prevMove.type, prevMove.srcPt));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (this._opts.dtFixed) {\n\t\t\tthis._tickBuffer += dt;\n\t\t\twhile (this._tickBuffer >= this._opts.dtFixed) {\n\t\t\t\tthis._tickBuffer -= this._opts.dtFixed;\n\t\t\t\tthis.now += this._opts.dtFixed;\n\t\t\t\tthis.__tick(this._opts.dtFixed);\n\t\t\t}\n\t\t} else {\n\t\t\tthis.__tick(dt);\n\t\t}\n\n\t\tif (this._reflowManager) {\n\t\t\tthis._reflowManager.startReflow(this._ctx);\n\t\t\tthis._reflowManager.setInRender(true);\n\t\t}\n\n\t\tvar doRepaint = this._opts.alwaysRepaint || this._needsRepaint;\n\t\tif (!doRepaint && this._doubleBuffered && this._doubleBufferedState > 0) {\n\t\t\t// even if we don't repaint, we need to paint at least 1 more time\n\t\t\t// for devices that use multiple buffers (like the ios, I think...)\n\t\t\t--this._doubleBufferedState;\n\t\t\tthis.render(dt);\n\t\t} else if (doRepaint) {\n\t\t\tthis._doubleBufferedState = 3;\n\t\t\tthis.render(dt);\n\t\t}\n\n\t\tthis._needsRepaint = false;\n\t\tthis._reflowManager && this._reflowManager.setInRender(false);\n\t};\n\n\tthis.render = function (dt) {\n\t\tif (this._opts.clearEachFrame) {\n\t\t\tthis._ctx && this._ctx.clear();\n\t\t}\n\n\t\tthis._view.__view.constructor.absScale = 1;\n\t\tthis._view.__view.wrapRender(this._ctx, {});\n\t\tthis.publish('Render', this._ctx);\n\n\t\tif (this._ctx) {\n\t\t\tif (DEBUG) {\n\t\t\t\tthis._renderFPS(this._ctx, dt);\n\t\t\t}\n\n\t\t\tthis._ctx.swap();\n\t\t}\n\t};\n\n\tthis.needsRepaint = function () {\n\t\tthis._needsRepaint = true;\n\t\treturn this;\n\t};\n\n\tthis.__tick = function (dt) {\n\t\tthis._tickFPS(dt);\n\t\tthis.publish('Tick', dt);\n\t\tthis._view.__view.wrapTick(dt, this);\n\t};\n\n\tvar log_counter = 0;\n\n});\n\nexports.get = function () { return __instance; };\n","pre":true},"sdk/timestep/event/input/dispatch.js":{"path":"sdk/timestep/event/input/dispatch.js","friendlyPath":"event.input.dispatch","directory":"sdk/timestep/event/input/","filename":"dispatch.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @module event.input.dispatch;\n * This namespace includes functions to dispatch touch events starting from the\n * root application view, which are traced through the hierarchy to each view's\n * individual InputHandler proxy. Additionally, this namespace includes those\n * functions actually in timestep.input, like InputListener and KeyListener classes.\n */\n\njsio(\"import math.geom.Point as Point\");\njsio(\"import device\");\njsio(\"import lib.Enum\");\n\nexports.eventTypes = new lib.Enum('START', 'MOVE', 'SELECT', 'SCROLL', 'CLEAR');\nexports.VERTICAL_AXIS = 2;\nexports.HORIZONTAL_AXIS = 1;\n\n/**\n * capture/bubble event, starting from root Application view\n *  - publish <inputTypeCapture> on the way down (e.g. onInputStartCapture)\n *  - call callbacks (e.g. onInputStart) and publish <inputType> (e.g. onInputstart)\n *    on the way up, checking evt.cancelled to see if someone has cancelled the event\n */\nexports.dispatchEvent = function (root, evt) {\n\t// if (evt.type == input.eventTypes.MOVE) { var now = +new Date(); }\n\t// store the root in case an event listener wants the top-most view?\n\tevt.root = root;\n\t\n\t// SHOULD_HANDLE = LOCALIZE = 0;\n\n\t// grab the bottom-most view whose bounding box contains the evt.srcPt\n\t// also updates the evt object with a trace of localized points and views\n\texports.traceEvt(root, evt, evt.srcPt);\n\n\t// if (now) { logger.log('TRACED A', LOCALIZE, SHOULD_HANDLE) }\n\t\n\t// once we've traced the event, we know how deep it goes\n\tvar depth = evt.depth;\n\t\n\texports._evtHistory[evt.type] = evt;\n\t\n\tvar signal = exports._evtCb[evt.type] || exports.getEvtCbName(evt.type);\n\t\n\tfor (var i = depth - 1; i >= 0; --i) {\n\t\tvar view = evt.trace[i],\n\t\t\tpt = evt.pt[view.uid];\n\t\tview.publish(signal + 'Capture', evt, pt, i == 0);\n\t\tif (evt.cancelled || view.__input.blockEvents) { return; }\n\t}\n\t\n\tvar cbName = 'on' + signal;\n\tfor (var i = 0; i < depth; ++i) {\n\t\tvar view = evt.trace[i];\n\t\tif (view.__input.canHandleEvents) {\n\t\t\tvar pt = evt.pt[view.uid];\n\t\t\tif (view[cbName]) { view[cbName](evt, pt, i == 0); }\n\t\t\tview.publish(signal, evt, pt, i == 0);\n\t\t\tview._onEventPropagate(evt, pt, i == 0);\n\t\t\tif (evt.cancelled) { break; }\n\t\t}\n\t}\n}\n\n/**\n * Trace an event recursively down to the view on which the event is triggered.\n */\nexports.traceEvt = function (view, evt, pt) {\n\t// var now = +new Date();\n\tvar localPt = view.style.localizePoint(new Point(pt));\n\tvar inputHandler = view.getInput();\n\tif (!inputHandler.containsEvent(evt, localPt)) { return false; }\n\n\tvar canHandleEvents = view.getInput().canHandleEvents;\n\tif (canHandleEvents) {\n\t\tevt.depth++;\n\t\tevt.trace.unshift(view);\n\t\tevt.pt[view.uid] = localPt;\n\t}\n\t\n\tvar subviews = view.getSubviews();\n\tfor (var i = subviews.length - 1; i >= 0; --i) {\n\t\tif (subviews[i].style.visible && exports.traceEvt(subviews[i], evt, localPt)) {\n\t\t\treturn true;\n\t\t}\n\t}\n\t\n\tif (canHandleEvents) {\n\t\tevt.target = view;\n\t\treturn true;\n\t}\n}\n\nexports._evtHistory = {};\nexports._activeInputOver = {};\n\nexports.clearOverState = function (id) {\n\tif (id) {\n\t\tvar evt = exports._activeInputOver[id];\n\t\tif (evt) {\n\t\t\tdelete exports._activeInputOver[id];\n\t\t\tvar trace = evt.trace;\n\t\t\tif (trace) {\n\t\t\t\tfor (var i = 0, view; view = trace[i]; ++i) {\n\t\t\t\t\tview.__input.onLeave(id);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t} else {\n\t\tfor (var id in exports._activeInputOver) {\n\t\t\texports.clearOverState(id);\n\t\t}\n\t}\n}\n\nexports._isDragging = false;\nexports.isDragging = function () { return exports._isDragging; }\n\nexports._evtCb = {};\nexports.getEvtCbName = function (evtType) {\n\tvar name = exports.eventTypes[evtType];\n\treturn (exports._evtCb[evtType] = 'Input' + name.charAt(0) + name.substring(1).toLowerCase());\n}\n\n/**\n * Aliases for children of the timestep.input \"package\".\n */\n\nexports.InputListener = device.get('Input');\nexports.KeyListener = device.get('KeyListener');\n\njsio(\"import .InputEvent as exports.InputEvent\");\n","pre":true},"sdk/timestep/event/input/InputEvent.js":{"path":"sdk/timestep/event/input/InputEvent.js","friendlyPath":".InputEvent","directory":"sdk/timestep/event/input/","filename":"InputEvent.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @class event.input.InputEvent;\n * This class represents an input event.\n * \n * It assumes a tree structure of View objects.  The top (root) of the\n * tree is typically the main Application view.  \n * \n * Events are assigned a root and a target.  View::dispatchEvent\n * computes the root and target from the event location (x, y).\n *\n * Propogation has two phases: capturing and bubbling.  Users \n * can mostly ignore capturing as the primary hooks are in the \n * bubbling.  Bubbling is defined as calling event handlers on\n * each view starting with 'target' and then continuing up \n * superview pointers until reaching 'root'.  Views can listen\n * to the event bubbling by adding methods such as:\n * \"input:start\" -> \"function onInputStart(evt)\"\n * \"input:drag\" -> \"function onDrag(dragEvt, moveEvt, delta)\"\n *\n * Other code can hook into a view's events by calling:\n *   myView.subscribe('input:start', function () { alert('Mouse Down'); });\n *   myView.subscribe('input:end', this, 'onChildViewClick');\n *\n * Propogation of events can be cancelled by calling evt.cancel().\n *\n * Note that onDrag is a special event that receives not only\n * a move event from an 'input:move' event, but also a custom\n * dragEvt object that contains extra data such as the start\n * position of the drag.\n *\n * @doc http://doc.gameclosure.com/api/event.html#class-event.input.inputevent\n * @docsrc https://github.com/gameclosure/doc/blob/master/api/event.md\n */\n\njsio(\"import math.geom.Point as Point\");\njsio(\"import timer\");\n\nvar sdk_timestep_event_input_InputEvent=__class__;var InputEvent = exports=sdk_timestep_event_input_InputEvent(function sdk_timestep_event_input_InputEvent(){return this.init&&this.init.apply(this,arguments)},function () {\n\tthis.cancelled = false; // If true, this event will not propogate\n\tthis.depth = 0; // Number of levels of the tree from root to target (inclusive)\n\t\n\t// Note that under normal usage:\n\t//   this.depth == this.trace.length\n\t//   this.root = this.trace[this.trace.length - 1]\n\t//   this.target = this.trace[0]\n\t\n\tthis.init = function (id, evtType, x, y, root, target) {\n\t\t// unique ID for a particular input - the ID should be constant for a given input\n\t\t// for example, the mouse should always have the same ID.  Each finger (touch)\n\t\t// should have the same ID throughout the touch start/move/end process\n\t\tthis.id = id; \n\t\t\n\t\t// string evtType, e.g. 'input:start'\n\t\tthis.type = evtType;\n\t\t\n\t\t// localized point coordinates, indexed by a view's uid (View::uid)\n\t\t// @internal --at least for now, concerns over performance.\n\t\tthis.point = this.pt = {};\n\t\t\n\t\t// raw (x, y) coordinates\n\t\tthis.srcPoint = this.srcPt = new Point(x, y);\n\t\t\n\t\t// list of View nodes from target to root\n\t\tthis.trace = [];\n\t\t\n\t\t// Top-most view where event is dispatched (e.g. the tree root)\n\t\tthis.root = root || null;\n\t\t\n\t\t// time of dispatch\n\t\tthis.when = timer.now;\n\t\t\n\t\t// Bottom-most view where the event occurred\n\t\tthis.target = target || null;\n\t}\n\t\n\tthis.cancel = function () {\n\t\tthis.cancelled = true;\n\t}\n\n\tthis.clone = function () {\n\t\treturn new InputEvent(this.id, this.type, this.srcPt.x, this.srcPt.y, this.root, this.target);\n\t}\n});\n","pre":true},"sdk/timestep/timer.js":{"path":"sdk/timestep/timer.js","friendlyPath":"timer","directory":"sdk/timestep/","filename":"timer.js","baseMod":"timer","basePath":"sdk/timestep/","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @module timer\n *\n * Implements an independent, singleton timer for use by the environment.\n * The Application Engine binds to this to generate the rendering tick.\n */\n\njsio(\"import device\");\n\nvar Timer = device.get('Timer');\n\nvar MAX_TICK = 10000; // ticks over 10 seconds will be considered too large to process\nexports.now = 0;\nexports.frames = 0;\nexports.reset = function () { this._last = null; }\nexports.tick = function (dt) {\n\ttry {\n\t\tif (dt > MAX_TICK) {\n\t\t\texports.onLargeTick(dt, MAX_TICK);\n\t\t\tdt = 1;\n\t\t}\n\t\t\n\t\texports.now += dt;\n\t\texports.frames++;\n\t\texports.onTick(dt);\n\t\tok = true;\n\t} finally {\n\t\tif (exports.debug && !ok) {\n\t\t\tapp.stopLoop()\n\t\t}\n\t}\n}\n\n/**\n * If our computer falls asleep, dt might be an insanely large number. \n * If we're running a simulation of sorts, we don't want the computer\n * to freeze while computing 1000s of simulation steps, so just drop\n * this tick.  Anyone who is interested can listen for a call to 'onLargeTick'\n */\nexports.onLargeTick = function (largeDt, threshold) {\n\tlogger.warn('Dropping large tick: ' + largeDt + '; Threshold is set at: ' + threshold);\n}\n\nexports.onTick = function (dt) {}\n\nexports.debug = false;\n\n\n// TODO: <jsio>('from iOS import start as exports.start, stop as exports.stop');\n\nexports.start = function (minDt) {\n\tthis.reset();\n\tthis.isRunning = true;\n\tdevice.get('Timer').start(exports.tick, minDt);\n}\n\nexports.stop = function () {\n\tthis.reset();\n\tthis.isRunning = false;\n\tdevice.get('Timer').stop();\n}\n\nexports.getTickProgress = function () {\n\tvar now = +new Date;\n\treturn (-(Timer.last || now) + now);\n}\n","pre":true},"sdk/timestep/ui/backend/ReflowManager.js":{"path":"sdk/timestep/ui/backend/ReflowManager.js","friendlyPath":"ui.backend.ReflowManager","directory":"sdk/timestep/ui/backend/","filename":"ReflowManager.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\nvar DEBUG = false;\n\nif (DEBUG) {\n\tvar _debug = {\n\t\tspace: '',\n\t\tstepIn: function () { this.space += ' '; return true; },\n\t\tstepOut: function () { this.space = this.space.slice(0, this.space.length - 1); return true; },\n\t\tlog: function () { logger.log.apply(logger, [this.space].concat(Array.prototype.slice.call(arguments, 0))); return true; }\n\t};\n\tlogger.log(\"===== CREATING REFLOW MANAGER\");\n}\n\n// max reflows for any view in a given tick\nvar MAX_REFLOW_THRESHOLD = 6;\n\nvar _pool = new (Class(function () {\n\tthis._pool = [];\n\n\tthis.recycle = function (item) {\n\t\titem.count = 0;\n\t\titem.view = null;\n\t\tthis._pool.push(item);\n\t}\n\n\tthis.get = function (view) {\n\t\tvar item = this._pool.pop() || {};\n\t\titem.view = view;\n\n\t\titem.iter = 0;\n\t\titem.count = 0;\n\t\treturn item;\n\t}\n}));\n\n/**\n * The ReflowManager is the controller for view layout.  It hooks into\n * the render cycle in two places:\n *  1. at the start of a render to reflow any views that we know\n *     need layout.  This is signalled by calling calls to needsReflow\n *     on a view between render cycles that result in a call to \n *     `ReflowMgr.add`.\n *  2. during render, if the view hasn't ever been rendered, the \n *     ReflowManager is notified to initiate the buildView call\n *     and handle any reflow logic before the view's first render.\n * The ReflowManager uses a queue-like structure to resolve the reflow \n * constraints. Views notify the ReflowManager through the add(view) \n * method, which then adds the view to the queue.  During a reflow cycle,\n * the ReflowManager tracks how many iterations through the queue each \n * view actually gets reflowed.  If the number of reflows exceeds the\n * MAX_REFLOW_THRESHOLD, reflow stops for that view, preventing infinite\n * loops when reflow cycles occur.\n */\n\nvar sdk_timestep_ui_backend_ReflowManager=__class__;var ReflowManager = exports=sdk_timestep_ui_backend_ReflowManager(function sdk_timestep_ui_backend_ReflowManager(){return this.init&&this.init.apply(this,arguments)},function () {\n\tthis.init = function () {\n\t\tthis._pending = {};\n\t\tthis._iter = 0;\n\t}\n\n\tthis.setInRender = function (isInRender) {\n\t\tthis._isInRender = isInRender;\n\t}\n\n\tthis.add = function (view) {\n\t\tvar uid = view.uid;\n\t\tvar item = this._pending[uid] || (this._pending[uid] = _pool.get(view));\n\n\t\titem.needsReflow = true;\n\n\t\t// increment count once per reflow iteration\n\t\tif (item.iter != this._iter) {\n\t\t\titem.count++;\n\t\t\titem.iter = this._iter;\n\t\t}\n\n\t\tDEBUG && _debug.log('adding view', uid, view.style.width + 'x' + view.style.height, view.getTag());\n\n\t\tif (this._isInRender && !this._isInReflow) {\n\t\t\tthis.startReflow(this._lastCtx);\n\t\t}\n\t}\n\n\tthis._reflow = function (ctx, item) {\n\t\titem.needsReflow = false;\n\n\t\tvar view = item.view;\n\t\tvar style = view.style;\n\t\tif (!style.__firstRender) {\n\t\t\tstyle.__firstRender = true;\n\n\t\t\tDEBUG && _debug.log('calling buildView for', view.uid, '(' + view.style.width + 'x' + view.style.height + ')') && _debug.stepIn();\n\t\t\tview.buildView(ctx);\n\t\t\tDEBUG && _debug.stepOut();\n\t\t}\n\n\t\tif (view.hasListeners('Resize')) {\n\t\t\tvar w = style.width;\n\t\t\tvar h = style.height;\n\t\t\tif (style.__cachedWidth != w || style.__cachedHeight != h) {\n\t\t\t\tstyle.__cachedWidth = w;\n\t\t\t\tstyle.__cachedHeight = h;\n\t\t\t\tview.publish('Resize');\n\t\t\t}\n\t\t}\n\n\t\tif (view.__layout) { view.__layout.reflow(); }\n\t\tview.reflow(false);\n\t}\n\n\tthis.startReflow = function (ctx) {\n\t\tthis._lastCtx = ctx;\n\t\tthis._isInReflow = true;\n\t\tthis._iter = 0;\n\t\tvar count;\n\n\t\tDEBUG && _debug.stepIn();\n\n\t\t// as long as we reflowed some views, keep looping\n\t\tdo {\n\t\t\t++this._iter; // what iteration are we on? only increment a view's count once per iteration\n\n\t\t\tcount = 0;\n\t\t\tfor (var uid in this._pending) {\n\t\t\t\tvar item = this._pending[uid];\n\t\t\t\tif (item.count > MAX_REFLOW_THRESHOLD) {\n\t\t\t\t\tlogger.warn('reflow loop detected for view', item.view.uid);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tif (item.needsReflow) {\n\t\t\t\t\tDEBUG && _debug.log('starting reflow for view', item.view.uid, '(' + item.count + ' times)') && _debug.stepIn();\n\t\t\t\t\tthis._reflow(ctx, item);\n\t\t\t\t\tDEBUG && _debug.stepOut();\n\t\t\t\t\t++count;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tDEBUG && count && _debug.log('iteration', this._iter, 'reflowed', count, 'views');\n\t\t} while (count);\n\n\t\t// recyle items\n\t\tfor (var uid in this._pending) {\n\t\t\t_pool.recycle(this._pending[uid]);\n\t\t}\n\n\t\tthis._pending = {};\n\t\tthis._isInReflow = false;\n\n\t\tDEBUG && _debug.stepOut();\n\t}\n\n});\n\nvar _instance = null;\nexports.get = function () {\n\treturn (_instance || (_instance = new ReflowManager()));\n}\n","pre":true},"sdk/timestep/ui/StackView.js":{"path":"sdk/timestep/ui/StackView.js","friendlyPath":".StackView","directory":"sdk/timestep/ui/","filename":"StackView.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @class ui.StackView;\n * Implements a view which can switch out one of several child views to display at the front.\n *\n * @doc http://doc.gameclosure.com/api/ui-stackview.html\n * @docsrc https://github.com/gameclosure/doc/blob/master/api/ui/stackview.md\n */\n\njsio(\"import ui.View as View\");\njsio(\"import animate\");\n\n/**\n * @extends ui.View\n */\nvar sdk_timestep_ui_StackView=__class__;exports=sdk_timestep_ui_StackView(function sdk_timestep_ui_StackView(){return this.init&&this.init.apply(this,arguments)},View, function (supr) {\n\tthis.init = function (opts) {\n\t\topts = merge(opts, {\n\t\t\tlayout: 'box'\n\t\t});\n\t\tsupr(this, 'init', [opts]);\n\t\tthis.stack = [];\n\t};\n\n\tthis.getStack = function () { return this.stack; };\n\n\tthis.getCurrentView = function () {\n\t\tif (!this.stack.length) { return null; }\n\t\treturn this.stack[this.stack.length - 1];\n\t};\n\n\tthis.push = function (view, dontAnimate, reverse) {\n\t\t// don't animate the first (base) view of a stackview unless explicitly asked to\n\t\tif (!this.stack[0] && dontAnimate !== false) {\n\t\t\tdontAnimate = true;\n\t\t}\n\n\t\tvar current = this.getCurrentView();\n\t\tif (current) { this._hide(current, dontAnimate); }\n\t\tview.style.y = 0;\n\t\tview.style.width = this.style.width / view.style.scale;\n\t\tview.style.height = this.style.height / view.style.scale;\n\t\tthis.stack.push(view);\n\t\tthis._show(view, dontAnimate, reverse);\n\t\treturn view;\n\t};\n\n\tthis._hide = function (view, dontAnimate, reverse) {\n\t\tview.publish('ViewWillDisappear');\n\t\tif (!dontAnimate) {\n\t\t\tthis.getInput().blockEvents = true;\n\t\t\tanimate(view)\n\t\t\t\t.then({x: (reverse ? 1 : -1) * this.style.width})\n\t\t\t\t.then(bind(this, function () {\n\t\t\t\t\tthis.removeSubview(view);\n\t\t\t\t\tview.publish('ViewDidDisappear');\n\t\t\t\t\tthis.getInput().blockEvents = false;\n\t\t\t\t}));\n\t\t} else {\n\t\t\tthis.removeSubview(view);\n\t\t\tview.publish('ViewDidDisappear');\n\t\t}\n\t};\n\n\tthis._show = function (view, dontAnimate, reverse) {\n\t\tview.publish('ViewWillAppear');\n\t\tview.style.visible = true;\n\t\tif (!dontAnimate) {\n\t\t\tview.style.x = (reverse ? -1 : 1) * this.style.width;\n\t\t\tthis.addSubview(view);\n\t\t\tanimate(view)\n\t\t\t\t.then({x: 0})\n\t\t\t\t.then(bind(view, 'publish', 'ViewDidAppear'));\n\t\t} else {\n\t\t\tthis.addSubview(view);\n\t\t\tview.style.x = 0;\n\t\t\tview.publish('ViewDidAppear');\n\t\t}\n\t};\n\n\tthis.hasView = function (view) {\n\t\treturn this.stack.indexOf(view) >= 0;\n\t};\n\n\tthis.remove = function (view) {\n\t\tvar i = this.stack.indexOf(view);\n\t\tif (i >= 0) {\n\t\t\tthis.stack.splice(i, 1);\n\t\t}\n\t}\n\n\tthis.pop = function (dontAnimate, reverse) {\n\t\tif (!this.stack.length) { return false; }\n\t\tvar view = this.stack.pop();\n\t\t//reverse by default\n\t\tthis._hide(view, dontAnimate, (reverse === false) ? false : true);\n\n\t\tif (this.stack.length) {\n\t\t\tthis._show(this.stack[this.stack.length - 1], dontAnimate, true);\n\t\t}\n\n\t\treturn view;\n\t};\n\n\tthis.popAll = function (dontAnimate) {\n\t\twhile (this.stack[1]) {\n\t\t\tthis.pop(dontAnimate);\n\t\t}\n\t};\n});\n","pre":true},"sdk/timestep/ui/View.js":{"path":"sdk/timestep/ui/View.js","friendlyPath":"ui.View","directory":"sdk/timestep/ui/","filename":"View.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @class ui.View;\n * The View base class.\n *\n * @doc http://doc.gameclosure.com/api/ui-view.html\n * @docsrc https://github.com/gameclosure/doc/blob/master/api/ui/view.md\n */\n\njsio(\"import device\");\njsio(\"import event.Emitter as Emitter\");\n\njsio(\"import math.geom.Point as Point\");\njsio(\"import math.geom.Rect as Rect\");\n\njsio(\"import .backend.canvas.ViewBacking\");\n\njsio(\"import ui.backend.ReflowManager as ReflowManager\");\n\njsio(\"import event.input.dispatch as dispatch\");\njsio(\"import event.input.InputHandler as InputHandler\");\n\njsio(\"import animate\");\n\njsio(\"import util.setProperty\");\n\njsio(\"import .Engine\");\n\nvar KeyListener = device.get('KeyListener');\n\nEventScheduler=__class__;var EventScheduler=EventScheduler(function EventScheduler(){return this.init&&this.init.apply(this,arguments)},function () {\n\tthis.init = function () {\n\t\tthis._queue = [];\n\t}\n\n\tthis.add = function (f) {\n\t\tthis._queue.push(f);\n\n\t\tif (!this._running) {\n\t\t\tthis._running = true;\n\t\t\twhile ((f = this._queue.shift())) {\n\t\t\t\tf();\n\t\t\t}\n\t\t\tthis._running = false;\n\t\t}\n\t}\n});\n\nvar scheduler = new EventScheduler();\n\n/**\n * This singleton class controls the focus of the current application. Only one\n * view can be focused at a given time.\n *\n * This doesn't correspond to native and isn't being used.\n */\nvar FocusMgr = new (Class(function () {\n\tthis.init = function (opts) {\n\t\tthis._keyListener = KeyListener && (new KeyListener());\n\t\tthis._target = null;\n\t\tthis._canChange = true;\n\t};\n\n\t/**\n\t * Focus the target, unfocusing the last target with focus.\n\t */\n\tthis.focus = function (target) {\n\t\tif (this._target != target && this._canChange) {\n\t\t\tif (this._target && this._target.onBlur) {\n\t\t\t\tthis._target.onBlur(this);\n\t\t\t}\n\n\t\t\tthis._target = target;\n\t\t\tif (target && target.onFocus) {\n\t\t\t\tthis._target.onFocus(this);\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.blur = function (target) {\n\t\ttarget.onBlur && target.onBlur(this);\n\t\tthis._target = false;\n\t};\n\n\t/**\n\t * Return the keylistener used by the focus manager.\n\t */\n\tthis.getKeyListener = function () {\n\t\treturn this._keyListener;\n\t};\n\n\tthis.get = function () {\n\t\treturn this;\n\t};\n}));\n\n/**\n * Unique ID counter for all views.\n */\nvar UID = 0;\n\nvar _BackingCtor = null;\n\n/**\n * @extends event.Emitter\n */\nvar sdk_timestep_ui_View=__class__;var View = exports=sdk_timestep_ui_View(function sdk_timestep_ui_View(){return this.init&&this.init.apply(this,arguments)},Emitter, function () {\n\t/**\n\t * infinite: boolean, default false - if true, no bounding shape at all (e.g. infinite scroll plane)\n\t * clip: boolean, default false - if true, always clip to the region\n\t * canHandleEvents: boolean, default true - if false, this view is ignored for event handling\n\t * parent: object, if provided, sets the initial superview\n\t */\n\tthis.init = function (opts) {\n\t\tif (!opts) { opts = {}; }\n\n\t\tthis.uid = ++UID;\n\n\t\t// Maintain pointers to children to keep native views from being garbage collected\n\t\tthis.__parent = null;\n\t\tthis.__children = null;\n\t\tthis.__leftSibling = null;\n\t\tthis.__rightSibling = null;\n\n\t\tthis.__input = new InputHandler(this, opts);\n\n\t\t// set with View.setDefaultViewBacking();\n\t\tthis.__view = this.style = new (opts.Backing || _BackingCtor)(this, opts);\n\n\t\tthis._filter = null;\n\t\tthis._dragOffset = {};\n\n\t\tthis.__view._view = this;\n\n\t\tvar engine = Engine.get();\n\t\tif (engine) {\n\t\t\tthis._reflowManager = engine.getReflowManager();\n\t\t}\n\n\t\tthis.updateOpts(opts);\n\t};\n\n\tthis.updateOpts = function (opts) {\n\t\topts = opts || {};\n\t\tif (this._opts) {\n\t\t\tfor (var key in opts) {\n\t\t\t\tthis._opts[key] = opts[key];\n\t\t\t}\n\t\t} else {\n\t\t\tthis._opts = opts;\n\t\t}\n\n\t\tif (opts.tag) { this.tag = opts.tag; }\n\t\tif (opts.filter) { this._filter = opts.filter; }\n\n\t\tif (opts.infinite) {\n\t\t\tthis._infinite = opts.infinite;\n\t\t}\n\n\t\tthis.style.update(opts);\n\n\t\tif (opts.superview) {\n\t\t\topts.superview.addSubview(this);\n\t\t}\n\t\t//opts.parent is deprecated, use opts.superview instead\n\t\tif (opts.parent) {\n\t\t\topts.parent.addSubview(this);\n\t\t}\n\n\t\treturn opts;\n\t};\n\n\t// --- filters ---\n\t// each filter can have multiple views\n\t// but no view can have more than one filter\n\n\t/**\n\t * Returns the filters attached to this view -- DEPRECATED\n\t */\n\tthis.getFilters = function () {\n\t\tlogger.warn(\"View.getFilters() is deprecated! Use View.getFilter() instead.\");\n\t\tvar filters = {};\n\t\tif (this._filter) {\n\t\t\tfilters[this._filter._opts.type] = this._filter;\n\t\t}\n\t\treturn filters;\n\t};\n\n\t/**\n\t * Returns the filter attached to this view.\n\t */\n\tthis.getFilter = function () {\n\t\treturn this._filter;\n\t};\n\n\t/**\n\t * Sets the filter on this view -- DEPRECATED\n\t */\n\tthis.addFilter = function (filter) {\n\t\tlogger.warn(\"View.addFilter() is deprecated! Use View.setFilter() instead.\");\n\t\tthis.setFilter(filter);\n\t};\n\n\t/**\n\t * Sets the filter on this view. Only one filter can exist on a view.\n\t */\n\tthis.setFilter = function (filter) {\n\t\tthis._filter = filter;\n\t};\n\n\t/**\n\t * Remove the filter from this view.\n\t */\n\tthis.removeFilter = function () {\n\t\tthis._filter = null;\n\t};\n\n\t// --- render/tick setters ---\n\n\t/**\n\t * Adds a hook to determine when the \"render\" property is set.\n\t */\n\tutil.setProperty(this, 'render', {\n\t\t\tvalue: undefined,\n\t\t\tcb: function () { this.__view && (this.__view.hasJSRender = true); }\n\t\t});\n\n\t/**\n\t * Adds a hook to determine when the \"tick\" property is set.\n\t */\n\tutil.setProperty(this, 'tick', {\n\t\t\tvalue: undefined,\n\t\t\tcb: function () { this.__view && (this.__view.hasJSTick = true); }\n\t\t});\n\n\t// --- animation component ---\n\n\t/**\n\t * Get an animation group from this view.\n\t */\n\tthis.getAnimation = function (groupID) {\n\t\treturn animate(this, groupID);\n\t};\n\n\t/**\n\t * @deprecated\n\t * Return an animation object for this view.\n\t */\n\tthis.animate = function (style, duration, easing) {\n\t\treturn this.getAnimation().then(style, duration, easing);\n\t};\n\n\t// --- ui focus/blur component ---\n\n\t/**\n\t * Indicate to the focus manager singleton this element is focused.\n\t */\n\tthis.focus = function () {\n\t\tFocusMgr.get().focus(this); return this;\n\t};\n\n\t/**\n\t * Indicate to the focus manager singleton this element is blurred.\n\t */\n\tthis.blur = function () {\n\t\tFocusMgr.get().blur(this);\n\t\treturn this;\n\t};\n\n\t/**\n\t * Triggered when focus is given to this view.\n\t */\n\tthis.onFocus = function () {\n\t\tthis._isFocused = true;\n\t};\n\n\t/**\n\t * Indicate to the focus manager singleton this element is blurred.\n\t */\n\tthis.onBlur = function () {\n\t\tthis._isFocused = false;\n\t};\n\n\t// --- input component ---\n\n\t/**\n\t * Returns a boolean indicating we are currently dragging this view.\n\t */\n\tthis.isDragging = function () {\n\t\treturn this.__input.isDragging();\n\t};\n\n\t/**\n\t * Start responding to touch input by dragging this view.\n\t */\n\tthis.startDrag = function (opts) {\n\t\tthis.__input.startDrag(opts);\n\t};\n\n\t/**\n\t * Return the InputHandler for this view.\n\t */\n\tthis.getInput = function () {\n\t\treturn this.__input;\n\t};\n\n\t/**\n\t * Returns a boolean indicating if a touch is on this view.\n\t */\n\tthis.isInputOver = function () {\n\t\treturn !!this.__input.overCount;\n\t};\n\n\t/**\n\t * Returns a number indicating how many touches are on this view.\n\t */\n\tthis.getInputOverCount = function () {\n\t\treturn this._inputOverCount;\n\t};\n\n\t/**\n\t * Renamed to setHandleEvents, canHandleEvents is deprecated.\n\t * @param {boolean} handleEvents Pass events through.\n\t * @param {boolean} ignoreSubviews Optional, defaults to false in InputHandler. Ignore events in childen as well.\n\t */\n\tthis.setHandleEvents = this.canHandleEvents = function (handleEvents, ignoreSubviews) {\n\t\tthis.__input.canHandleEvents = handleEvents;\n\t\t\n\t\tif (typeof ignoreSubviews === 'boolean') {\n\t\t\tthis.__input.blockEvents = ignoreSubviews;\n\t\t}\n\t};\n\n\t// TODO: think about refactoring internal components and exposing them differently...\n\tthis.setIsHandlingEvents = function (canHandleEvents) {\n\t\tthis.__input.canHandleEvents = canHandleEvents;\n\t};\n\n\tthis.isHandlingEvents = function () {\n\t\treturn this.__input.canHandleEvents;\n\t};\n\n\tthis.needsRepaint = function () {\n\t\tthis._needsRepaint = true;\n\t};\n\n\tthis.needsReflow = function (force) {\n\t\tif (this.style.__firstRender || force) {\n\t\t\tthis._reflowManager && this._reflowManager.add(this);\n\t\t\tthis._needsRepaint = true;\n\t\t}\n\t};\n\n\t/**\n\t * Consumes an event targeting this view.\n\t * NOTE: Does no actual propagation.\n\t */\n\tthis._onEventPropagate = function (evt, pt, atTarget) {\n\t\tif (atTarget) {\n\t\t\tvar id = evt.id;\n\t\t\tvar lastEvt;\n\t\t\tvar i;\n\n\t\t\tswitch(evt.type) {\n\t\t\t\tcase dispatch.eventTypes.SELECT:\n\t\t\t\tcase dispatch.eventTypes.CLEAR:\n\t\t\t\t\tdispatch._evtHistory[dispatch.eventTypes.MOVE] = null;\n\t\t\t\t\tlastEvt = dispatch._activeInputOver[id];\n\t\t\t\t\tif (lastEvt) {\n\t\t\t\t\t\tdispatch.clearOverState(id);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase dispatch.eventTypes.START:\n\t\t\t\tcase dispatch.eventTypes.MOVE:\n\t\t\t\t\t// translate input:move events into two higher-level events:\n\t\t\t\t\t//   input:over and input:out\n\n\t\t\t\t\tvar target = evt.trace[0];\n\t\t\t\t\tvar view = null;\n\n\t\t\t\t\t// fire input:out events first, start with deepest node and work out\n\t\t\t\t\tlastEvt = dispatch._activeInputOver[id];\n\t\t\t\t\tif (lastEvt && target != lastEvt.trace[0]) {\n\t\t\t\t\t\tvar trace = lastEvt.trace;\n\t\t\t\t\t\tfor (i = 0, view; view = trace[i]; ++i) {\n\t\t\t\t\t\t\tif (!(view.uid in evt.pt)) {\n\t\t\t\t\t\t\t\tview.__input.onLeave(id, target == view);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!lastEvt || target != lastEvt.trace[0]) {\n\t\t\t\t\t\t// fire input:over events second, start with outermost node and go to target\n\t\t\t\t\t\tvar trace = evt.trace;\n\t\t\t\t\t\tfor (i = evt.depth - 1; i >= 0; --i) {\n\t\t\t\t\t\t\ttrace[i].__input.onEnter(id, target == view);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// update current mouse trace\n\t\t\t\t\t\tdispatch._activeInputOver[id] = evt;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.localizePoint = function (pt) {\n\t\tvar list = this.getParents();\n\t\tvar i = 0;\n\t\tlist.push(this);\n\t\twhile (list[++i]) { pt = list[i].__view.localizePoint(pt); }\n\t\treturn pt;\n\t};\n\n\t// --- view hierarchy component ---\n\n\tthis.setReflowManager = function (reflowManager) {\n\t\tthis._reflowManager = reflowManager;\n\t};\n\n\t/**\n\t * Return the subview at the given index.\n\t */\n\tthis.getSubview = function (i) {\n\t\treturn this.__view.getSubviews()[i];\n\t};\n\n\t/**\n\t * Returns an array of all subviews.\n\t */\n\tthis.getSubviews = function () {\n\t\treturn this.__view.getSubviews();\n\t};\n\n\t/**\n\t * Returns the superview of this view.\n\t */\n\tthis.getSuperview = function () {\n\t\treturn this.__view.getSuperview();\n\t};\n\n\tthis.connectEvent = function (src, name /*, args */) {\n\t\tif (!this.__subs) {\n\t\t\tthis.__subs = [];\n\n\t\t\tthis.on('ViewAdded', bind(this, '_connectEvents'));\n\t\t\tthis.on('ViewRemoved', bind(this, '_disconnectEvents'));\n\n\t\t\tif (this.__root) {\n\t\t\t\tthis._connectEvents();\n\t\t\t}\n\t\t}\n\n\t\tvar args = Array.prototype.slice.call(arguments, 1);\n\t\tthis.__subs.push([src, args]);\n\t\tif (this.__root) {\n\t\t\tsrc.on.apply(src, args);\n\t\t}\n\t}\n\n\tfunction compareSubscription (args, sub) {\n\t\t// note that args and sub may not be the same length\n\t\t// return true if all items in args match items in sub\n\t\t// (we don't care if sub has extra arguments)\n\t\tfor (var i = 0, n = args.length; i < n; ++i) {\n\t\t\tif (args[i] != sub[i]) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t};\n\n\tthis.disconnectEvent = function (src, name /*, args */) {\n\t\tif (this.__subs) {\n\t\t\tvar args = Array.prototype.slice.call(arguments, 1);\n\t\t\tfor (var i = 0, sub; sub = this.__subs[i]; ++i) {\n\t\t\t\tif (sub[0] == src && compareSubscription(args, sub[1])) {\n\t\t\t\t\tsub[0].removeListener.apply(sub[0], sub[1]);\n\t\t\t\t\tthis.__subs.splice(i--, 1);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n\n\tthis._connectEvents = function () {\n\t\tfor (var i = 0, args; args = this.__subs[i]; ++i) {\n\t\t\targs[0].on.apply(args[0], args[1]);\n\t\t}\n\t};\n\n\tthis._disconnectEvents = function () {\n\t\tfor (var i = 0, args; args = this.__subs[i]; ++i) {\n\t\t\targs[0].removeListener.apply(args[0], args[1]);\n\t\t}\n\t};\n\n\t/**\n\t * Add a subview.\n\t */\n\tthis.addSubview = function (view) {\n\t\tif (this.__view.addSubview(view)) {\n\t\t\tview.needsRepaint();\n\t\t\tthis._reflowManager && view.needsReflow();\n\n\t\t\tthis._linkView(view);\n\n\t\t\t// if successful, clear any residual input over count\n\t\t\tview.__input.resetOver();\n\n\t\t\tthis.publish('SubviewAdded', view);\n\t\t\tif (this.__root) {\n\t\t\t\tvar root = this.__root;\n\t\t\t\tvar viewCreated = view;\n\t\t\t\tscheduler.add(bind(this, function recurse(view) {\n\t\t\t\t\tview.__root = root;\n\t\t\t\t\tview.emit('ViewAdded', viewCreated);\n\t\t\t\t\tvar subviews = view.getSubviews();\n\t\t\t\t\tfor (var i = 0, subview; subview = subviews[i]; ++i) {\n\t\t\t\t\t\trecurse(subview);\n\t\t\t\t\t}\n\t\t\t\t}, view));\n\t\t\t}\n\t\t}\n\n\t\treturn view;\n\t};\n\n\t// link the input view to the current view to prevent native views from being\n\t// garbage collected\n\tthis._linkView = function (view) {\n\t\t// remove any current connections\n\t\tthis._unlinkView(view);\n\n\t\t// Insert this view as the head of the sibling list\n\t\tif (this.__children) {\n\t\t\tthis.__children.__leftSibling = view;\n\t\t}\n\t\tview.__leftSibling = null;\n\t\tview.__rightSibling = this.__children;\n\t\tthis.__children = view;\n\t\tview.__parent = this;\n\n\n\t};\n\n\tthis._unlinkView = function (view) {\n\t\tif (view.__parent) {\n\t\t\t// When removing a subview, remove the view from its sibling list\n\t\t\tif (view.__leftSibling) {\n\t\t\t\tview.__leftSibling.__rightSibling = view.__rightSibling;\n\t\t\t}\n\n\t\t\tif (view.__rightSibling) {\n\t\t\t\tview.__rightSibling.__leftSibling = view.__leftSibling;\n\t\t\t}\n\n\t\t\t// If this view is the head of the sibling list\n\t\t\t// then set the next sibling to be the head\n\t\t\tif (view.__parent.__children == view) {\n\t\t\t\tview.__parent.__children = view.__rightSibling;\n\t\t\t}\n\n\t\t\tview.__leftSibling = null;\n\t\t\tview.__rightSibling = null;\n\t\t\tview.__parent = null;\n\t\t}\n\t};\n\n\t/**\n\t * Removes a subview.\n\t */\n\tthis.removeSubview = function (view) {\n\t\tif (this.__view.removeSubview(view)) {\n\t\t\tthis._unlinkView(view);\t\n\t\t\tthis.publish('SubviewRemoved', view);\n\t\t\tif (view.__root) {\n\t\t\t\tscheduler.add(bind(this, function recurse(view) {\n\t\t\t\t\tview.__root = null;\n\t\t\t\t\tview.emit('ViewRemoved', this);\n\t\t\t\t\tvar subviews = view.getSubviews();\n\t\t\t\t\tfor (var i = 0, subview; subview = subviews[i]; ++i) {\n\t\t\t\t\t\trecurse(subview);\n\t\t\t\t\t}\n\t\t\t\t}, view));\n\t\t\t}\n\t\t}\n\n\t\treturn view;\n\t};\n\n\t/**\n\t * Removes this view from its parent.\n\t */\n\tthis.removeFromSuperview = function () {\n\t\tvar superview = this.__view.getSuperview();\n\t\tif (superview) {\n\t\t\tsuperview.removeSubview(this);\n\t\t}\n\t};\n\n\t/**\n\t * Removes all subviews from this view.\n\t */\n\tthis.removeAllSubviews = function () {\n\t\tvar subviews = this.getSubviews();\n\t\tvar i = subviews.length;\n\t\twhile (i--) {\n\t\t\tthis.removeSubview(subviews[i]);\n\t\t}\n\t};\n\n\t// legacy implementation shim\n\tutil.setProperty(this, '_superview', {get: this.getSuperview, set: function () {}});\n\tutil.setProperty(this, '_subviews', {get: this.getSubviews, set: function () {}});\n\n\t// --- onResize callbacks ---\n\n\tthis.reflow = function () {\n\t};\n\n\t// ---\n\n\t/**\n\t * Get the root application for this view.\n\t */\n\tthis.getApp = function () {\n\t\tvar top = this;\n\t\tvar next;\n\t\tdo {\n\t\t\tnext = top.__view.getSuperview();\n\t\t} while (next && (top = next));\n\t\treturn top.__root;\n\t};\n\n\t/**\n\t * Returns an array of all ancestors of the current view.\n\t */\n\tthis.getParents = function () {\n\t\tvar list = [this];\n\t\tvar next;\n\t\tdo {\n\t\t\tnext = list[0].__view.getSuperview();\n\t\t} while (next && list.unshift(next));\n\n\t\tlist.pop();\n\t\treturn list;\n\t};\n\n\t/**\n\t * @interface\n\t */\n\tthis.buildView = function () {};\n\n\t/**\n\t * Determine if this view contains a point.\n\t */\n\tthis.containsLocalPoint = function (pt) {\n\t\tif (this._infinite) { return true; }  // infinite plane\n\n\t\tvar s = this.style,\n\t\t\tw = s.width,\n\t\t\th = s.height;\n\n\t\tif (w > 0 && h > 0) {\n\t\t\treturn pt.x <= w && pt.y <= h && pt.x >= 0 && pt.y >= 0;\n\t\t} else if (w > 0) {\n\t\t\treturn pt.x <= w && pt.y >= h && pt.x >= 0 && pt.y <= 0;\n\t\t} else if (h > 0) {\n\t\t\treturn pt.x >= w && pt.y <= h && pt.x <= 0 && pt.y >= 0;\n\t\t} else {\n\t\t\treturn pt.x >= w && pt.y >= h && pt.x <= 0 && pt.y <= 0;\n\t\t}\n\t};\n\n\t/**\n\t * Return the bounding shape for this view. The shape is defined in the\n\t * options object when this view was constructed.\n\t */\n\tthis._boundingShape = {};\n\tthis.getBoundingShape = function (simple) {\n\t\tif (this._infinite) {\n\t\t\treturn true;\n\t\t} else {\n\t\t\tvar s = this.style;\n\t\t\tvar w = s.width;\n\t\t\tvar h = s.height;\n\t\t\tif (!(w && h) && s.layout) {\n\t\t\t\tvar superview = this.getSuperview();\n\t\t\t\tif (superview) {\n\t\t\t\t\tvar supersize = superview.getBoundingShape(true);\n\t\t\t\t\tif (!w) {\n\t\t\t\t\t\tw = supersize.width;\n\t\t\t\t\t\tif (s.layoutWidth) {\n\t\t\t\t\t\t\tw *= parseInt(s.layoutWidth) / 100;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!h) {\n\t\t\t\t\t\th = supersize.height;\n\t\t\t\t\t\tif (s.layoutHeight) {\n\t\t\t\t\t\t\th *= parseInt(s.layoutHeight) / 100;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (simple) {\n\t\t\t\tthis._boundingShape.x = s.x;\n\t\t\t\tthis._boundingShape.y = s.y;\n\t\t\t\tthis._boundingShape.width = w * s.scale;\n\t\t\t\tthis._boundingShape.height = h * s.scale;\n\t\t\t\treturn this._boundingShape;\n\t\t\t}\n\t\t\treturn new Rect(s.x, s.y, w * s.scale, h * s.scale);\n\t\t}\n\t};\n\n\t/**\n\t * Given a rectangle and a parent view, compute the location of\n\t * the rectangle in this view's coordinate space.\n\t * WARNING: only works with non-rotated rectangles.\n\t * TODO Make it work with rotated rectangles!\n\t */\n\tthis.getRelativeRegion = function (region, parent) {\n\t\tvar offset = this.getPosition(parent || region.src);\n\t\treturn new Rect((region.x - offset.x) / offset.scale,\n\t\t\t\t\t\t(region.y - offset.y)  / offset.scale,\n\t\t\t\t\t\tregion.width / offset.scale,\n\t\t\t\t\t\tregion.height / offset.scale);\n\t};\n\n\t/**\n\t * Return a fully defined position, rotation, size, and scale for this view.\n\t */\n\tthis.getPosition = function (/* optional */ relativeTo) {\n\t\tvar abs = new Point(),\n\t\t\tview = this,\n\t\t\tr = 0,\n\t\t\ts = this.style,\n\t\t\tw = s.width,\n\t\t\th = s.height,\n\t\t\tc = 1;\n\n\t\twhile (view && view != relativeTo) {\n\t\t\tvar scale = view.style.scale;\n\n\t\t\t//translate to anchor point\n\t\t\tabs.add(\n\t\t\t\t-(view.style.anchorX),\n\t\t\t\t-(view.style.anchorY)\n\t\t\t);\n\n\t\t\t//scale and rotate\n\t\t\tabs.rotate(view.style.r);\n\t\t\tabs.scale(scale);\n\n\t\t\t//translate back\n\t\t\tabs.add(\n\t\t\t\tview.style.anchorX + view.style.x + view.style.offsetX,\n\t\t\t\tview.style.anchorY + view.style.y + view.style.offsetY\n\t\t\t);\n\n\t\t\tr += view.style.r;\n\t\t\tw *= scale;\n\t\t\th *= scale;\n\t\t\tc *= scale;\n\t\t\tview = view.__view.getSuperview();\n\t\t}\n\n\t\treturn {\n\t\t\tx: abs.x,\n\t\t\ty: abs.y,\n\t\t\tr: r % (2 * Math.PI),\n\t\t\twidth: w,\n\t\t\theight: h,\n\t\t\tscale: c,\n\t\t\tanchorX: this.style.anchorX,\n\t\t\tanchorY: this.style.anchorY\n\t\t};\n\t};\n\n\t/**\n\t * Exposes the internal implementation of the view hierarchy\n\t */\n\tthis.getBacking = function () {\n\t\treturn this.__view;\n\t};\n\n\t/**\n\t * Sets the visibility to true. Triggers repaint.\n\t */\n\tthis.show = function () {\n\t\tthis.style.visible = true;\n\t\tthis.needsRepaint();\n\t};\n\n\t/**\n\t * Sets the visibility to false. Triggers repaint.\n\t */\n\tthis.hide = function () {\n\t\tthis.style.visible = false;\n\t\tthis.needsRepaint();\n\t};\n\n\t/**\n\t * Return a human-readable tag for this view.\n\t */\n\tthis.toString = this.getTag = function () {\n\t\tvar cls = \"View\";\n\n\t\tif (DEBUG) {\n\t\t\t// check the cached name\n\t\t\tif (this.__tagClassName) {\n\t\t\t\tcls = this.__tagClassName;\n\t\t\t} else {\n\t\t\t\t// generate the classname\n\t\t\t\tcls = this.constructor.name;\n\n\t\t\t\tif (!cls) {\n\t\t\t\t\tcls = this.constructor.toString().match(/^function ([^(]+)/)[1];\n\t\t\t\t}\n\n\t\t\t\tif (cls) {\n\t\t\t\t\tcls = cls.substr(cls.lastIndexOf(\"_\") + 1);\n\t\t\t\t}\n\n\t\t\t\tthis.__tagClassName = cls || 'unknown';\n\t\t\t}\n\t\t}\n\n\t\treturn cls + this.uid + (this.tag ? ':' + this.tag : '');\n\t};\n});\n\nvar _extensions = [];\nView.addExtension = function (ext) {\n\text.extend(View.BackingCtor);\n\t_extensions.push(ext);\n};\n\nView.setDefaultViewBacking = function (ViewBackingCtor) {\n\t_BackingCtor = View.BackingCtor = ViewBackingCtor;\n\t_extensions.forEach(function (ext) { ext.extend(_BackingCtor); });\n};\n\n// default view backing is canvas\nView.setDefaultViewBacking(backend.canvas.ViewBacking);\n","pre":true},"sdk/timestep/ui/backend/canvas/ViewBacking.js":{"path":"sdk/timestep/ui/backend/canvas/ViewBacking.js","friendlyPath":".backend.canvas.ViewBacking","directory":"sdk/timestep/ui/backend/canvas/","filename":"ViewBacking.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @package ui.backend.canvas.ViewStyle;\n *\n * Models the style object of the canvas View.\n */\n\njsio(\"import ..strPad\");\njsio(\"import ..BaseBacking\");\njsio(\"import util.setProperty as setProperty\");\n\nvar _styleKeys = {};\n\nvar sdk_timestep_ui_backend_canvas_ViewBacking=__class__;var ViewBacking = exports=sdk_timestep_ui_backend_canvas_ViewBacking(function sdk_timestep_ui_backend_canvas_ViewBacking(){return this.init&&this.init.apply(this,arguments)},BaseBacking, function () {\n\t\n\tthis.constructor.absScale = 1;\n\n\tthis.init = function (view) {\n\t\tthis._view = view;\n\t\tthis._subviews = [];\n\t}\n\n\tthis.getSuperview = function () { return this._superview; }\n\tthis.getSubviews = function () {\n\t\tif (this._needsSort) { this._needsSort = false; this._subviews.sort(); }\n\t\tvar subviews = [];\n\t\tvar backings = this._subviews;\n\t\tvar n = backings.length;\n\t\tfor (var i = 0; i < n; ++i) {\n\t\t\tsubviews[i] = backings[i]._view;\n\t\t}\n\n\t\treturn subviews;\n\t}\n\n\tvar ADD_COUNTER = 900000;\n\tthis.addSubview = function (view) {\n\t\tvar backing = view.__view;\n\t\tvar superview = backing._superview;\n\t\tif (superview == this._view) { return false; }\n\t\tif (superview) { superview.__view.removeSubview(view); }\n\n\t\tvar n = this._subviews.length;\n\t\tthis._subviews[n] = backing;\n\n\t\tbacking._superview = this._view;\n\t\tbacking._setAddedAt(++ADD_COUNTER);\n\n\t\tif (n && backing.__sortKey < this._subviews[n - 1].__sortKey) {\n\t\t\tthis._needsSort = true;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tthis.removeSubview = function (targetView) {\n\t\tvar index = this._subviews.indexOf(targetView.__view);\n\t\tif (index != -1) {\n\t\t\tthis._subviews.splice(index, 1);\n\t\t\t// this._view.needsRepaint();\n\n\t\t\ttargetView.__view._superview = null;\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tthis.wrapTick = function (dt, app) {\n\t\tthis._view.tick && this._view.tick(dt, app);\n\n\t\tfor (var i = 0, view; view = this._subviews[i]; ++i) {\n\t\t\tview.wrapTick(dt, app);\n\t\t}\n\n\t\t// TODO: support partial repaints?\n\t\t// if (this._view._needsRepaint) {\n\t\t// \tthis._view._needsRepaint = false;\n\t\t// \tapp.needsRepaint();\n\t\t// }\n\t}\n\n\tthis.wrapRender = function (ctx, opts) {\n\t\tif (!this.visible) { return; }\n\t\t\n\t\tif (!this.__firstRender) { this._view.needsReflow(true); }\n\t\tif (this._needsSort) { this._needsSort = false; this._subviews.sort(); }\n\t\t\n\t\tvar width = this._width;\n\t\tvar height = this._height;\n\t\tif (width < 0 || height < 0) { return; }\n\n\t\tctx.save();\n\t\t\n\t\tctx.translate(this.x + this.anchorX + this.offsetX, this.y + this.anchorY + this.offsetY);\n\t\t\n\t\tif (this.r) { ctx.rotate(this.r); }\n\t\t\n\t\t// clip this render to be within its view;\n\t\tif (this.scale != 1) {\n\t\t\tctx.scale(this.scale, this.scale);\n\t\t\tViewBacking.absScale *= this.scale;\n\t\t}\n\n\t\t// scale dimensions individually\n\t\tif (this.scaleX != 1) {\n\t\t\tctx.scale(this.scaleX, 1);\n\t\t}\n\t\tif (this.scaleY != 1) {\n\t\t\tctx.scale(1, this.scaleY);\n\t\t}\n\n\t\tthis.absScale = ViewBacking.absScale;\n\t\t\n\t\tif (this.opacity != 1) { ctx.globalAlpha *= this.opacity; }\n\n\t\tctx.translate(-this.anchorX, -this.anchorY);\n\n\t\tif (this.clip) { ctx.clipRect(0, 0, width, height); }\n\t\t\n\t\tvar filters = {};\n\t\tvar filter = this._view.getFilter();\n\t\tif (filter) {\n\t\t\tfilters[filter._opts.type] = filter;\n\t\t}\n\t\tctx.setFilters(filters);\n\n\t\tif (this.flipX || this.flipY) {\n\t\t\tctx.translate(\n\t\t\t\tthis.flipX ? width / 2 : 0,\n\t\t\t\tthis.flipY ? height / 2 : 0\n\t\t\t);\n\n\t\t\tctx.scale(\n\t\t\t\tthis.flipX ? -1 : 1,\n\t\t\t\tthis.flipY ? -1 : 1\n\t\t\t);\n\n\t\t\tctx.translate(\n\t\t\t\tthis.flipX ? -width / 2 : 0,\n\t\t\t\tthis.flipY ? -height / 2 : 0\n\t\t\t);\n\t\t}\n\n\t\ttry {\n\t\t\tif (this.backgroundColor) {\n\t\t\t\tctx.fillStyle = this.backgroundColor;\n\t\t\t\tctx.fillRect(0, 0, width, height);\n\t\t\t}\n\n\t\t\tvar viewport = opts.viewport;\n\t\t\tthis._view.render && this._view.render(ctx, opts);\n\t\t\tthis._renderSubviews(ctx, opts);\n\t\t\topts.viewport = viewport;\n\n\t\t} finally {\n\t\t\tctx.clearFilters();\n\t\t\tctx.restore();\n\t\t}\n\t}\n\n\tthis._renderSubviews = function (ctx, opts) {\n\t\tvar i = 0;\n\t\tvar view;\n\t\tvar subviews = this._subviews;\n\t\twhile (view = subviews[i++]) {\n\t\t\tview.wrapRender(ctx, opts);\n\t\t}\n\t}\n\n\t// this._clearCache = function () { this._cache = null; }\n\t\n\t// this.updateRadius = function () {\n\t// \tvar w = this.width * 0.5,\n\t// \t\th = this.height * 0.5;\n\t\t\n\t// \tif (!this._cache) { this._cache = {}; }\n\t// \treturn (this._cache.radius = Math.sqrt(w * w + h * h));\n\t// }\n\t\n\tthis._onResize = function (prop, value, prevValue) {\n\t\t// local properties are invalidated\n\t\t// this._cache = null;\n\t\t\n\t\t// child view properties might be invalidated\n\t\tthis._view.needsReflow();\n\t}\n\t\n\tthis._sortIndex = strPad.initialValue;\n\tthis._onZIndex = function (_, zIndex) {\n\t\tthis._sortIndex = strPad.pad(zIndex);\n\n\t\tthis._setSortKey();\n\t\tthis._view.needsRepaint();\n\n\t\tvar superview = this._view.getSuperview();\n\t\tif (superview) { superview.__view._needsSort = true; }\n\t}\n\n\tthis._setAddedAt = function (addedAt) {\n\t\tthis._addedAt = addedAt;\n\t\tthis._setSortKey();\n\t}\n\n\tthis._setSortKey = function () {\n\t\tthis.__sortKey = this._sortIndex + this._addedAt;\n\t}\n\n\t//not implemented\n\tthis._onOffsetX = function (n) {\n\t\tthis.offsetX = n * this.width / 100;\n\t};\n\n\t//not implemented\n\tthis._onOffsetY = function (n) {\n\t\tthis.offsetY = n * this.height / 100;\n\t};\n\t\n\tthis.toString = function () { return this.__sortKey; }\n});\n","pre":true},"sdk/timestep/ui/backend/strPad.js":{"path":"sdk/timestep/ui/backend/strPad.js","friendlyPath":"..strPad","directory":"sdk/timestep/ui/backend/","filename":"strPad.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\nvar LEN = 8;\nvar MAX = 99999999;\nvar MIN = -99999999;\nvar PAD = \"00000000\";\n\nexports.initialValue = PAD;\n\nexports.pad = function (val) {\n\tval = ~~val;\n\n\tif (val < MIN) { val = MIN; }\n\tif (val > MAX) { val = MAX; }\n\tif (val < 0) {\n\t\tval *= -1;\n\t\treturn '-' + PAD.substring(0, LEN - ('' + val).length) + val;\n\t} else {\n\t\treturn PAD.substring(0, LEN - ('' + val).length) + val;\n\t}\n};\n","pre":true},"sdk/timestep/ui/backend/BaseBacking.js":{"path":"sdk/timestep/ui/backend/BaseBacking.js","friendlyPath":"..BaseBacking","directory":"sdk/timestep/ui/backend/","filename":"BaseBacking.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n\njsio(\"import util.setProperty as setProperty\");\n\nvar sdk_timestep_ui_backend_BaseBacking=__class__;var BaseBacking = exports=sdk_timestep_ui_backend_BaseBacking(function sdk_timestep_ui_backend_BaseBacking(){return this.init&&this.init.apply(this,arguments)},function () {\n\t\n\t// required methods:\n\t//\n\t// this._onResize = function () {};\n\t// this._onZIndex = function () {};\n\n\tvar styleKeys = this.constructor.styleKeys = {};\n\n\t// keys map to properties\n\tvar BASE_STYLE_PROPS = {\n\t\t'x': {value: 0},\n\t\t'y': {value: 0},\n\t\t'offsetX': {value: 0}, //translate\n\t\t'offsetY': {value: 0},\n\t\t'offsetXPercent': {value: undefined, cb: '_onOffsetX'}, //not implemented\n\t\t'offsetYPercent': {value: undefined, cb: '_onOffsetY'},\n\t\t'anchorX': {value: 0}, //rotation and scale\n\t\t'anchorY': {value: 0},\n\t\t'centerAnchor': {value: false},\n\t\t'width': {cb: '_onResize'},\n\t\t'height': {cb: '_onResize'},\n\t\t'r': {value: 0},\n\t\t'opacity': {value: 1},\n\t\t'zIndex': {value: 0, cb: '_onZIndex'},\n\t\t// 'radius': {\n\t\t// \tget: function () {\n\t\t// \t\treturn this._cache && 'radius' in this._cache ? this._cache.radius : this.updateRadius();\n\t\t// \t}\n\t\t// },\n\t\t'scale': {value: 1},\n\t\t'scaleX': {value: 1},\n\t\t'scaleY': {value: 1},\n\t\t'flipX': {value: false},\n\t\t'flipY': {value: false},\n\t\t'visible': {value: true},\n\t\t'shadowColor': {value: 'black'}, //only has an effect in TextView??\n\t\t'clip': {value: false},\n\t\t'backgroundColor': {value: undefined}\n\t};\n\t\n\tthis.constructor.addProperty = function (key, def) {\n\t\tstyleKeys[key] = true;\n\t\tsetProperty(this.prototype, key, def);\n\t}\n\n\tfor (var key in BASE_STYLE_PROPS) {\n\t\tthis.constructor.addProperty(key, BASE_STYLE_PROPS[key]);\n\t}\n\n\tthis.localizePoint = function (pt) {\n\t\tpt.x -= this.x + this.anchorX + this.offsetX;\n\t\tpt.y -= this.y + this.anchorY + this.offsetY;\n\t\tif (this.r) { pt.rotate(-this.r); }\n\t\tpt.scale(1 / this.scale);\n\t\tpt.x += this.anchorX;\n\t\tpt.y += this.anchorY;\n\t\treturn pt;\n\t}\n\n\tthis.copy = function () {\n\t\tvar copy = {};\n\t\tfor (var key in styleKeys) {\n\t\t\tcopy[key] = this[key];\n\t\t}\n\n\t\treturn copy;\n\t}\n\t\n\tthis.update = function (style) {\n\t\tfor (var i in style) {\n\t\t\tif (style.hasOwnProperty(i) && styleKeys.hasOwnProperty(i)) {\n\t\t\t\tthis[i] = style[i];\n\t\t\t}\n\t\t}\n\t\treturn this;\n\t}\n});\n","pre":true},"sdk/timestep/event/input/InputHandler.js":{"path":"sdk/timestep/event/input/InputHandler.js","friendlyPath":"event.input.InputHandler","directory":"sdk/timestep/event/input/","filename":"InputHandler.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @class event.input.InputHandler;\n * An event handler proxy for an individual view. This handles dispatching\n * of events onto the actual view itself, as well as determining if the view\n * is the actual target of a propagated event. \n */\n\njsio(\"import math.geom.Point as Point\");\njsio(\"import event.input.dispatch as dispatch\");\n\nvar sdk_timestep_event_input_InputHandler=__class__;var InputHandler = exports=sdk_timestep_event_input_InputHandler(function sdk_timestep_event_input_InputHandler(){return this.init&&this.init.apply(this,arguments)},function () {\n\t\n\t// ---- start mouseover\n\tthis.startCount = 0;\n\tthis.dragCount = 0;\n\tthis.overCount = 0;\n\tthis.canHandleEvents = true;\n\tthis.blockEvents = false;\n\n\tthis.init = function (view, opts) {\n\t\tthis.view = view;\n\n\t\tif ('canHandleEvents' in opts) {\n\t\t\tthis.canHandleEvents = opts.canHandleEvents;\n\t\t}\n\n\t\tif ('blockEvents' in opts) {\n\t\t\tthis.blockEvents = opts.blockEvents;\n\t\t}\n\t}\n\t\n\tthis.containsEvent = function (evt, localPt) {\n\t\t// block events must be false\n\t\treturn !this.blockEvents && (!this.view._superview   // top-view captures all events\n\t\t\t\t|| this.view.containsLocalPoint(localPt));\n\t}\n\n\tthis.onEnter = function (id, atTarget) {\n\t\tvar view = this.view;\n\t\tvar over = this._over || (this._over = {});\n\t\tif (id in over) { return; }\n\t\t\n\t\tover[id] = true;\n\t\tthis.overCount++;\n\t\t\n\t\tif (view.onInputOver) { view.onInputOver(over, this.overCount, atTarget); }\n\t\tview.publish('InputOver', over, this.overCount, atTarget);\n\t}\n\t\n\tthis.onLeave = function (id, atTarget) {\n\t\tvar view = this.view;\n\t\tvar over = this._over || (this._over = {});\n\t\tif (!(id in over)) { return; }\n\t\t\n\t\tdelete over[id];\n\t\t--this.overCount;\n\t\t\n\t\tif (view.onInputOut) { view.onInputOut(over, this.overCount, atTarget); }\n\t\tview.publish('InputOut', over, this.overCount, atTarget);\n\t}\n\t\n\tthis.resetOver = function () {\n\t\tdelete this._over;\n\t\tthis.overCount = 0;\n\t}\n\t\n\t// ---- end mouseover\n\t\n\t\n\t// ---- start drag\n\t\n\tthis.startDrag = function (opts) {\n\t\topts = opts || {};\n\t\tvar view = this.view;\n\t\tvar inputStartEvt = opts.inputStartEvt || opts.inputStartEvent || dispatch._evtHistory[dispatch.eventTypes.START];\n\t\tvar id = inputStartEvt.id;\n\t\t\n\t\t// dedup drags from same input ID\n\t\tvar dragging = this._isDragging || (this._isDragging = {});\n\t\tif (dragging[id]) { return; }\n\t\tdragging[id] = true;\n\t\t\n\t\t++this.dragCount;\n\t\t++this.startCount;\n\n\t\tvar root = inputStartEvt.root;\n\t\tvar dragEvt = new dispatch.InputEvent(inputStartEvt.id, 'input:drag', inputStartEvt.srcPt.x, inputStartEvt.srcPt.y, root, view);\n\t\t\n\t\tdragEvt.didDrag = false;\n\t\tdragEvt.radius = opts.radius * opts.radius || 0;\n\t\t\n\t\troot.subscribe('InputMoveCapture', this, 'onDragStart', dragEvt);\n\t\troot.subscribe('InputSelectCapture', this, 'onDragStop', dragEvt);\n\t}\n\t\n\tthis.isDragging = function () { return this.dragCount && dispatch._isDragging; }\n\t\n\tthis.onDragStart = function (dragEvt, moveEvt) {\n\t\t// have we exceeded the move radius?\n\t\tvar dx = moveEvt.srcPt.x - dragEvt.srcPt.x;\n\t\tvar dy = moveEvt.srcPt.y - dragEvt.srcPt.y;\n\t\tif (dx * dx + dy * dy <= dragEvt.radius) { return; }\n\n\t\tif (dragEvt.didDrag) {\n\t\t\treturn;\n\t\t}\n\t\tdragEvt.didDrag = true;\n\t\t--this.startCount;\n\t\t\n\t\tvar view = this.view;\n\t\t\n\t\t// no longer need to listen for move events for onDragStart\n\t\tif (this.startCount == 0) {\n\t\t\tdragEvt.root.unsubscribe('InputMoveCapture', this, 'onDragStart');\n\t\t}\n\t\t\n\t\t// want to fire onDragStart with the current point equal to the initial point \n\t\t// even though the user has moved away by now\n\t\tdragEvt.currPt = dragEvt.srcPt;\n\t\tdragEvt.localPt = view.localizePoint(new Point(dragEvt.currPt));\n\n\t\tif (view.onDragStart) { view.onDragStart(dragEvt); }\n\t\tview.publish('DragStart', dragEvt);\n\t\t\n\t\t// future move events should be captured by _onDrag\n\t\t// we should also call _onDrag now to handle the current move event delta\n\t\tdragEvt.root.subscribe('InputMoveCapture', this, 'onDrag', dragEvt);\n\t\tthis.onDrag(dragEvt, moveEvt);\n\t}\n\t\n\tthis.onDrag = function (dragEvt, moveEvt) {\n\t\tif (dragEvt.id != moveEvt.id\n\t\t\t\t|| moveEvt.srcPt.x == dragEvt.currPt.x && moveEvt.srcPt.y == dragEvt.currPt.y) { return; }\n\n\t\tvar view = this.view;\n\t\t\n\t\tdragEvt.prevPt = dragEvt.currPt;\n\t\tdragEvt.currPt = moveEvt.srcPt;\n\n\t\tdragEvt.prevLocalPt = dragEvt.localPt;\n\t\tdragEvt.localPt = view.localizePoint(new Point(dragEvt.currPt));\n\n\t\tvar delta = Point.subtract(dragEvt.localPt, dragEvt.prevLocalPt);\n\n\t\tdispatch._isDragging = true;\n\n\t\tif (view.onDrag) { view.onDrag(dragEvt, moveEvt, delta); }\n\t\tview.publish('Drag', dragEvt, moveEvt, delta);\n\t\t\n\t\t//moveEvt.cancel();\n\t}\n\t\n\tthis.onDragStop = function (dragEvt, selectEvt) {\n\t\tvar id = dragEvt.id;\n\t\tvar dragging = this._isDragging || (this._isDragging = {});\n\t\tif (!dragging[id] || dragEvt.id != selectEvt.id) { return; }\n\t\t\n\t\tdelete dragging[id];\n\t\t--this.dragCount;\n\n\t\tif (!this.dragCount) {\n\t\t\tdragEvt.root.unsubscribe('InputMoveCapture', this, 'onDragStart');\n\t\t\tdragEvt.root.unsubscribe('InputMoveCapture', this, 'onDrag');\n\t\t\tdragEvt.root.unsubscribe('InputSelectCapture', this, 'onDragStop');\n\t\t\tdispatch._isDragging = false;\n\t\t}\n\t\t\n\t\tif (dragEvt.didDrag) {\n\t\t\tvar view = this.view;\n\t\t\t\n\t\t\t// a subscription can later 'uncancel' the selectEvt by setting 'selectEvt.cancelled = false;'\n\t\t\tselectEvt.cancel();\n\t\t\t\n\t\t\tif (view.onDragStop) { view.onDragStop(dragEvt, selectEvt); }\n\t\t\tview.publish('DragStop', dragEvt, selectEvt);\n\t\t}\n\t}\n\t\n\t// ---- end drag\n});\n","pre":true},"sdk/timestep/animate.js":{"path":"sdk/timestep/animate.js","friendlyPath":"animate","directory":"sdk/timestep/","filename":"animate.js","baseMod":"animate","basePath":"sdk/timestep/","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @module animate\n * Import the DOM/Canvas implementation of animate. Also define the transition function aliases.\n *\n * @doc http://doc.gameclosure.com/api/animate.html\n * @docsrc https://github.com/gameclosure/doc/blob/master/api/animate.md\n */\n\njsio(\"import ui.backend.canvas.animate as exports\");\n","pre":true},"sdk/timestep/ui/backend/canvas/animate.js":{"path":"sdk/timestep/ui/backend/canvas/animate.js","friendlyPath":"ui.backend.canvas.animate","directory":"sdk/timestep/ui/backend/canvas/","filename":"animate.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * package ui.backend.canvas.animate;\n *\n * Canvas animate namespace and functions.\n */\n\njsio(\"import event.Emitter as Emitter\");\njsio(\"import animate.transitions as transitions\");\njsio(\"import timer\");\n\nvar anim_uid = 0;\n\nexports = function (subject, groupId) {\n\n\t// TODO: we have a circular import, so do the Engine import on first use\n\tif (typeof Engine == 'undefined') {\n\t\tjsio(\"import ui.Engine as Engine\");\n\t\tjsio(\"import ui.View as View\");\n\t}\n\n\tvar groupId = groupId || 0,\n\t\tgroup = groups[groupId] || (groups[groupId] = new Group()),\n\t\tanimID = subject.__anim_id || (subject.__anim_id = '__anim_' + (++anim_uid)),\n\t\tanim = group.get(animID);\n\n\tif (!anim) {\n\t\tanim = subject instanceof View\n\t\t\t\t? new ViewAnimator(subject, group)\n\t\t\t\t: new Animator(subject, group);\n\n\t\tgroup.add(animID, anim);\n\t}\n\n\treturn anim;\n}\n\nexports.getViewAnimator = function () {\n\treturn ViewAnimator;\n};\n\nexports.setViewAnimator = function (ctor) {\n\tViewAnimator = ctor;\n};\n\nGroup=__class__;var Group=Group(function Group(){return this.init&&this.init.apply(this,arguments)},Emitter, function (supr) {\n\tthis.init = function () {\n\t\tthis._anims = {};\n\t\tthis._pending = [];\n\t};\n\n\tthis.get = function (id) { return this._anims[id]; };\n\n\tthis.add = function (id, q) {\n\t\tthis._anims[id] = q;\n\t\tq.id = id;\n\t\treturn q;\n\t};\n\n\tthis.isActive = function () {\n\t\tfor (var id in this._anims) {\n\t\t\tif (this._anims[id].hasFrames()) { return true; }\n\t\t}\n\n\t\treturn false;\n\t};\n\n\tthis.onAnimationFinish = function (anim) {\n\t\tdelete this._anims[anim.id];\n\n\t\tif (!this.isActive()) {\n\t\t\t// if called from a Finish event, republish it\n\t\t\tthis.publish('Finish');\n\t\t}\n\t};\n});\n\nvar groups = {\n\t0: new Group()\n};\n\nexports.getGroup = function (i) {\n\treturn groups[i || 0];\n};\n\nvar TRANSITIONS = [\n\ttransitions.easeInOut, // 0: default\n\ttransitions.linear,    // 1\n\ttransitions.easeIn,    // 2\n\ttransitions.easeOut,   // 3\n\ttransitions.easeInOut, // 4\n\ttransitions.bounce     // 5\n];\n\nexports.linear = 1;\nexports.easeIn = 2;\nexports.easeOut = 3;\nexports.easeInOut = 4;\nexports.bounce = 5;\n\nfunction getTransition(n) {\n\treturn (typeof n == 'function' ? n : TRANSITIONS[n | 0]);\n}\n\nFrame=__class__;var Frame=Frame(function Frame(){return this.init&&this.init.apply(this,arguments)},function () {\n\tthis.init = function (opts) {\n\t\tthis.subject = opts.subject;\n\t\tthis.target = opts.target;\n\t\tthis.duration = opts.duration || 0;\n\t\tthis.transition = getTransition(opts.transition);\n\t\tthis.onTick = opts.onTick;\n\t};\n\n\tthis.exec = function () {};\n\tthis.onInterrupt = function () {};\n});\n\nCallbackFrame=__class__;var CallbackFrame=CallbackFrame(function CallbackFrame(){return this.init&&this.init.apply(this,arguments)},Frame, function () {\n\tthis.exec = function (tt, t) {\n\t\tthis.target.apply(this.subject, arguments);\n\t};\n});\n\n// a wait frame is just a frame that does nothing... so we\n// don't need to do anything!\nvar WaitFrame = Frame;\n\nObjectFrame=__class__;var ObjectFrame=ObjectFrame(function ObjectFrame(){return this.init&&this.init.apply(this,arguments)},Frame, function () {\n\tthis.exec = function (tt, t, debug) {\n\t\tif (!this.base) {\n\t\t\tthis.base = {};\n\t\t\tfor (var key in this.target) {\n\t\t\t\tthis.base[key] = this.subject[key];\n\t\t\t}\n\t\t}\n\n\t\tfor (var key in this.target) {\n\t\t\tthis.subject[key] = (this.target[key] - this.base[key]) * tt + this.base[key];\n\t\t}\n\n\t\tif (debug) {\n\t\t\tvar changed = {};\n\t\t\tfor (var key in this.target) {\n\t\t\t\tchanged[key] = this.subject[key] + ' -> ' + this.target[key];\n\t\t\t}\n\t\t\tlogger.log(this.duration, tt, JSON.stringify(changed));\n\t\t}\n\t};\n});\n\n// a ViewStyleFrame updates a view's style in exec\nViewStyleFrame=__class__;var ViewStyleFrame=ViewStyleFrame(function ViewStyleFrame(){return this.init&&this.init.apply(this,arguments)},Frame, function () {\n\n\tthis._resolvedDeltas = false;\n\n\tthis.init = function (opts) {\n\t\tthis.subject = opts.subject;\n\t\tthis.target = merge({}, opts.target);\n\t\tthis.duration = opts.duration === 0 ? 0 : (opts.duration || 500);\n\t\tthis.transition = getTransition(opts && opts.transition);\n\t\tthis.onTick = opts.onTick;\n\t};\n\n\tthis.resolveDeltas = function (againstStyle) {\n\t\tvar style = this.target;\n\t\tthis._resolvedDeltas = true;\n\t\tfor (var key in style) {\n\t\t\tvar baseKey = key.substring(1);\n\t\t\tif (key.charAt(0) == 'd' && !(key in againstStyle) && (baseKey in againstStyle)) {\n\t\t\t\tstyle[baseKey] = style[key] + againstStyle[baseKey];\n\t\t\t\tdelete style[key];\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.exec = function (tt, t, debug) {\n\t\tvar oldStyle = this._baseStyle || (this._baseStyle = this.subject.style.copy()),\n\t\t\tnewStyle = this.target;\n\n\t\tif (!this._resolvedDeltas) { this.resolveDeltas(this._baseStyle); }\n\n\t\tvar oldStyle = this._baseStyle;\n\t\tfor (var key in newStyle) {\n\t\t\tif (key in oldStyle) {\n\t\t\t\tthis.subject.style[key] = (newStyle[key] - oldStyle[key]) * tt + oldStyle[key];\n\t\t\t}\n\t\t}\n\n\t\tthis.subject.needsRepaint();\n\n\t\tif (debug) {\n\t\t\tvar changed = {};\n\t\t\tfor (var key in newStyle) {\n\t\t\t\tchanged[key] = this.subject.style[key] + ' -> ' + newStyle[key];\n\t\t\t}\n\t\t\tlogger.log(timer.now, this.duration, tt, JSON.stringify(changed));\n\t\t}\n\t};\n\n\tthis.onInterrupt = function (newFrame) {\n\t\t// var preStyle = this.subject.style.copy();\n\n\t\t// You might want to resolve any deltas against the post-committed style.\n\t\t// But I think this should be off by default.  You can commit the style,\n\t\t// resolve your deltas, then restore the old style yourself if you want.\n\t\t// I don't think you _always_ want this to be the behavior?\n\t\t//\n\t\t// this.commit(true);\n\t\t// newFrame.resolveDeltas(this.subject.style);\n\n\t\t// If you're animating multiple properties, and you've only\n\t\t// interrupted some of them, you may want the rest to continue.\n\t\t// This only looks good if the timing is the same too -- to do\n\t\t// this properly, you'd have to branch animations based on the\n\t\t// style property being animated...\n\t\t//\n\t\t// for (var i in ViewStyle.keys) {\n\t\t// \tif (postCommitStyle[i] != preStyle[i] && !(i in newStyle)) {\n\t\t// \t\tnewStyle[i] = postCommitStyle[i];\n\t\t// \t}\n\t\t// }\n\n\t\t// this.subject.style.update(preStyle);\n\t};\n});\n\nexports.Animator=__class__;var Animator = exports.Animator=exports.Animator(function exports_Animator(){return this.init&&this.init.apply(this,arguments)},Emitter, function () {\n\tthis.init = function (subject, group) {\n\t\tthis.subject = subject;\n\t\tthis._group = group;\n\t\tthis.clear();\n\t\tthis._isPaused = false;\n\t};\n\n\tthis.clear = function () {\n\t\tthis._elapsed = 0;\n\t\tthis._queue = [];\n\t\tthis._unschedule();\n\t\treturn this;\n\t};\n\n\t// this.getQueue = function () { return this._queue; }\n\n\t// Careful: pause will *not* fire the finish event, so anything pending the end of the\n\t// animation will have to wait until the animation is resumed.\n\tthis.pause = function () {\n\t\tif (!this._isPaused) {\n\t\t\tthis._isPaused = true;\n\t\t\tthis._unschedule();\n\t\t}\n\t};\n\n\tthis.resume = function () {\n\t\tif (this._isPaused) {\n\t\t\tthis._isPaused = false;\n\t\t\tthis._schedule();\n\t\t}\n\t};\n\n\tthis._schedule = function () {\n\t\tif (!this._isScheduled) {\n\t\t\tthis._isScheduled = true;\n\t\t\tEngine.get().subscribe('Tick', this, 'onTick');\n\t\t}\n\t};\n\n\tthis._unschedule = function () {\n\t\tif (this._isScheduled) {\n\t\t\tthis._isScheduled = false;\n\t\t\tEngine.get().unsubscribe('Tick', this, 'onTick');\n\t\t}\n\t};\n\n\tthis.isPaused = function () { return this._isPaused; };\n\tthis.hasFrames = function () { return !!this._queue[0]; };\n\n\tthis.wait = function (duration) {\n\t\treturn this.then(new WaitFrame({duration: duration}));\n\t};\n\n\tthis.buildFrame = function (opts) {\n\t\tif (typeof opts.target == 'function') {\n\t\t\treturn new CallbackFrame(opts);\n\t\t}\n\n\t\tif (typeof opts.target == 'object') {\n\t\t\treturn new ObjectFrame(opts);\n\t\t}\n\n\t\treturn new WaitFrame(opts);\n\t};\n\n\tthis.now = function (target, duration, transition, onTick) {\n\t\ttransition = transition || (this._queue[0] ? exports.easeOut : exports.easeInOut);\n\n\t\tvar nextFrame = target instanceof Frame\n\t\t\t\t? target\n\t\t\t\t: this.buildFrame({\n\t\t\t\t\t\tsubject: this.subject,\n\t\t\t\t\t\ttarget: target,\n\t\t\t\t\t\tduration: duration,\n\t\t\t\t\t\ttransition: transition,\n\t\t\t\t\t\tonTick: onTick\n\t\t\t\t\t});\n\n\t\tvar frame = this._queue[0];\n\t\tframe && frame.onInterrupt(nextFrame);\n\n\t\tthis.clear();\n\t\treturn this.then(nextFrame);\n\t};\n\n\tthis.then = function (target, duration, transition, onTick) {\n\t\tvar nextFrame = target instanceof Frame\n\t\t\t\t? target\n\t\t\t\t: this.buildFrame({\n\t\t\t\t\t\tsubject: this.subject,\n\t\t\t\t\t\ttarget: target,\n\t\t\t\t\t\tduration: duration,\n\t\t\t\t\t\ttransition: transition,\n\t\t\t\t\t\tonTick: onTick\n\t\t\t\t\t});\n\n\t\tif (!this._queue.length) {\n\t\t\tthis._elapsed = 0;\n\t\t}\n\n\t\tthis._queue.push(nextFrame);\n\t\tthis._schedule();\n\t\treturn this;\n\t};\n\n\tthis.debug = function () { this._debug = true; return this; };\n\n\tthis.commit = function () {\n\t\tthis._elapsed = 0;\n\t\tfor (var i = 0, p; p = this._queue[i]; ++i) {\n\t\t\tthis._elapsed += p.duration;\n\t\t}\n\n\t\tthis.next();\n\t\treturn this;\n\t};\n\n\tthis.onTick = function (dt) {\n\t\tif (!this._isScheduled) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._elapsed += dt;\n\t\tthis.next();\n\n\t\tif (!this._isScheduled) {\n\t\t\tthis._group.onAnimationFinish(this);\n\t\t}\n\t};\n\n\tthis.next = function () {\n\t\tvar p,\n\t\t\ttarget;\n\n\t\tif (!this._queue[0]) { return; }\n\n\t\twhile ((p = this._queue[0])) {\n\t\t\tvar frameFinished = this._elapsed >= p.duration,\n\t\t\t\tt = frameFinished ? 1 : this._elapsed / p.duration,\n\t\t\t\ttt = p.transition(t);\n\n\t\t\tif (frameFinished) {\n\t\t\t\tthis._elapsed -= p.duration;\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tp.exec(tt, t, this._debug);\n\t\t\t\tif (p.onTick) { p.onTick.call(p.subject, tt, t); }\n\t\t\t} finally {\n\t\t\t\t// if we haven't modified the queue in a callback, remove the frame if it is finished\n\t\t\t\tif (frameFinished && p == this._queue[0]) {\n\t\t\t\t\tthis._queue.shift();\n\t\t\t\t}\n\n\t\t\t\t// if we got paused during a callback or the\n\t\t\t\t// frame is not finished yet, don't continue\n\t\t\t\tif (!frameFinished || this._isPaused) { return; }\n\t\t\t}\n\t\t}\n\n\t\t// nothing left in the queue!\n\t\tthis._unschedule();\n\t};\n});\n\nViewAnimator=__class__;var ViewAnimator=ViewAnimator(function ViewAnimator(){return this.init&&this.init.apply(this,arguments)},Animator, function (supr) {\n\tthis.buildFrame = function (opts) {\n\t\tif (typeof opts.target == 'object') {\n\t\t\treturn new ViewStyleFrame(opts);\n\t\t}\n\n\t\treturn supr(this, 'buildFrame', arguments);\n\t};\n});\n","pre":true},"sdk/timestep/animate/transitions.js":{"path":"sdk/timestep/animate/transitions.js","friendlyPath":"animate.transitions","directory":"sdk/timestep/animate/","filename":"transitions.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @module animate.transitions\n *\n * Transition functions for use by the animate features. These aren't referenced\n * directly by the animate namespace, but by numerical reference.\n *\n * @doc http://doc.gameclosure.com/api/animate.html\n * @docsrc https://github.com/gameclosure/doc/blob/master/api/animate.md\n */\n\nexports.linear = function (n) { return n; }\nexports.easeIn = function (n) { return n * n; }\nexports.easeInOut = function (n) { return (n *= 2) < 1 ? 0.5 * n * n * n : 0.5 * ((n -= 2) * n * n + 2); }\nexports.easeOut = function (n) { return n * (2 - n); }\n","pre":true},"sdk/timestep/ui/backend/debug/FPSView.js":{"path":"sdk/timestep/ui/backend/debug/FPSView.js","friendlyPath":"ui.backend.debug.FPSView","directory":"sdk/timestep/ui/backend/debug/","filename":"FPSView.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @package ui.backend.debug.FPSView;\n *\n * The view which renders the FPS when showFPS is set to true on the\n * Application options.\n *\n * TODO Move to debug package.\n */\n\njsio(\"import device\");\njsio(\"import lib.Enum as Enum\");\n\njsio(\"import math.geom.Rect as Rect\");\njsio(\"import math.geom.intersect as intersect\");\n\njsio(\"import event.input.dispatch as dispatch\");\n\nvar viewModes = new Enum('FPS', 'DT');\n\nfunction strokeRect(ctx, rect, color) {\n\tctx.fillStyle = color;\n\tctx.fillRect(rect.x, rect.y, 1, rect.height);\n\tctx.fillRect(rect.x, rect.y, rect.width, 1);\n\tctx.fillRect(rect.x + rect.width - 1, rect.y, 1, rect.height);\n\tctx.fillRect(rect.x, rect.y + rect.height - 1, rect.width, 1);\n};\n\nfunction fillRect(ctx, rect, color) {\n\tctx.fillStyle = color;\n\tctx.fillRect(rect.x, rect.y, rect.width, rect.height);\n};\n\nGraph=__class__;var Graph=Graph(function Graph(){return this.init&&this.init.apply(this,arguments)},function () {\n\tthis.init = function (opts) {\n\t\tvar Canvas = device.get('Canvas');\n\n\t\tthis._width = opts.width;\n\t\tthis._height = opts.height;\n\n\t\tthis._maxValue = opts.maxValue;\n\t\tthis._backgroundColor = opts.backgroundColor;\n\t\tthis._colors = opts.colors;\n\t\tthis._axisColor = opts.axisColor;\n\n\t\tthis._canvas = new Canvas({width: opts.width, height: opts.height});\n\t\tthis._ctx = this._canvas.getContext('2d');\n\t\tthis._ctx.fillStyle = opts.backgroundColor;\n\t\tthis._ctx.fillRect(0, 0, opts.width, opts.height);\n\n\t\tthis._offset = 0;\n\t\tthis._index = 0;\n\t};\n\n\tthis.addValues = function (values, timeAxis) {\n\t\tvar ctx = this._ctx,\n\t\t\twidth = this._width,\n\t\t\theight = this._height,\n\t\t\tvalue,\n\t\t\tmaxValue = this._maxValue,\n\t\t\tx = (this._offset + this._index) % width,\n\t\t\ty = this._height,\n\t\t\tn,\n\t\t\ti, j;\n\n\t\tctx.fillStyle = this._backgroundColor;\n\t\tctx.fillRect(x, 0, 2, height);\n\n\t\ti = values.length;\n\t\twhile (i) {\n\t\t\tvalue = values[--i];\n\t\t\tif (value > maxValue) {\n\t\t\t\tvalue = maxValue;\n\t\t\t}\n\t\t\tn = ~~(value / maxValue *  height);\n\t\t\tctx.fillStyle = this._colors[i];\n\t\t\tctx.fillRect(x, height - n, 2, n);\n\t\t}\n\n\t\tctx.fillStyle = this._axisColor;\n\t\tif (timeAxis) {\n\t\t\tctx.fillRect(x, 0, 1, height);\n\t\t}\n\t\tctx.fillRect(x, 25, 2, 1);\n\t\tctx.fillRect(x, 50, 2, 1);\n\t\tctx.fillRect(x, 75, 2, 1);\n\n\t\tif (this._index < width) {\n\t\t\tthis._index += 2;\n\t\t} else {\n\t\t\tthis._offset += 2;\n\t\t\tif (this._offset >= width) {\n\t\t\t\tthis._offset = 0;\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.render = function (ctx, x, y) {\n\t\tvar offset = this._offset,\n\t\t\twidth = this._width,\n\t\t\theight = this._height;\n\n\t\tif (offset === 0) {\n\t\t\tctx.drawImage(this._canvas, 0, 0, width, height, x, y, width, height);\n\t\t} else {\n\t\t\tctx.drawImage(this._canvas, offset, 0, width - offset, height, x, y, width - offset, height);\n\t\t\tctx.drawImage(this._canvas, 0, 0, offset, height, width - offset + x, y, offset, height);\n\t\t}\n\t};\n});\n\nvar sdk_timestep_ui_backend_debug_FPSView=__class__;exports=sdk_timestep_ui_backend_debug_FPSView(function sdk_timestep_ui_backend_debug_FPSView(){return this.init&&this.init.apply(this,arguments)},function () {\n\tthis.init = function (opts) {\n\t\tthis._application = opts.application;\n\n\t\tthis._time = +(new Date()) + 1000;\n\t\tthis._frames = 0;\n\t\tthis._fps = 20;\n\t\tthis._dt = 10;\n\n\t\tthis._minimized = true;\n\n\t\tvar width = 200,\n\t\t\theight = 100;\n\n\t\tthis._rectTop = new Rect(1, 1, width, 16);\n\t\tthis._rectMin = new Rect(0, 0, 24, 15);\n\t\tthis._rectMax = new Rect(0, 0, width + 2, height + 17);\n\t\tthis._rect = this._rectMin;\n\n\t\tthis._rectFPS = new Rect(141, 1, 30, 15);\n\t\tthis._rectDT = new Rect(171, 1, 30, 15);\n\n\t\tthis._borderColor = 'rgb(100,100,150)';\n\t\tthis._backgroundColor = '#17182E';\n\t\tthis._textColor = '#FFFFFF';\n\n\t\tthis._viewMode = viewModes.DT;\n\n\t\tthis._graphs = {}\n\t\tthis._graphs[viewModes.FPS] = new Graph({\n\t\t\twidth: width,\n\t\t\theight: height,\n\t\t\tmaxValue: 60,\n\t\t\tbackgroundColor: this._backgroundColor,\n\t\t\tcolors: ['rgba(170,170,252,0.3)', 'rgb(170,170,252)'],\n\t\t\taxisColor: '#FFFFFF'\n\t\t});\n\t\tthis._graphs[viewModes.DT] = new Graph({\n\t\t\twidth: width,\n\t\t\theight: height,\n\t\t\tmaxValue: 66,\n\t\t\tbackgroundColor: this._backgroundColor,\n\t\t\tcolors: ['rgba(255,0,0,0.5)', 'rgb(254,255,170)'],\n\t\t\taxisColor: '#FFFFFF'\n\t\t});\n\t};\n\n\tthis.tick = function (dt) {\n\t\tvar time = +(new Date());\n\t\tif (time > this._time) {\n\t\t\tthis._time = time + 1000;\n\t\t\tthis._fps = this._frames;\n\t\t\tthis._frames = 1;\n\t\t} else {\n\t\t\tthis._frames++;\n\t\t}\n\n\t\tvar events = this._application.getEvents();\n\t\tif (events.length) {\n\t\t\tthis._handleEvents(events);\n\t\t}\n\n\t\tthis._dt = this._dt * 0.8 + dt * 0.2;\n\n\t\tif (!this._minimized) {\n\t\t\tswitch (this._viewMode) {\n\t\t\t\tcase viewModes.DT:\n\t\t\t\t\tthis._graphs[viewModes.DT].addValues([this._dt, dt], (this._frames === 1));\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase viewModes.FPS:\n\t\t\t\t\tthis._graphs[viewModes.FPS].addValues([this._fps, 1000 / dt], (this._frames === 1));\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t};\n\n\tthis._handleEvents = function (events) {\n\t\tvar types = dispatch.eventTypes;\n\t\tvar i = events.length;\n\n\t\twhile (i) {\n\t\t\tvar event = events[--i];\n\t\t\tswitch (event.type) {\n\t\t\t\tcase types.START:\n\t\t\t\t\tif (intersect.ptAndRect(event.srcPt, this._rect)) {\n\t\t\t\t\t\tif (this._minimized) {\n\t\t\t\t\t\t\tthis._minimized = false;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tif (intersect.ptAndRect(event.srcPt, this._rectFPS)) {\n\t\t\t\t\t\t\t\tthis._viewMode = viewModes.FPS;\n\t\t\t\t\t\t\t} else if (intersect.ptAndRect(event.srcPt, this._rectDT)) {\n\t\t\t\t\t\t\t\tthis._viewMode = viewModes.DT;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tthis._minimized = true;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthis._rect = this._minimized ? this._rectMin : this._rectMax;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.render = function (ctx) {\n\t\tctx.save();\n\n\t\tctx.textBaseline = 'top';\n\t\tctx.textAlign = 'center';\n\t\tctx.font = '12px Verdana';\n\n\t\tif (this._minimized) {\n\t\t\tfillRect(ctx, this._rect, this._backgroundColor);\n\t\t} else {\n\t\t\tfillRect(ctx, this._rectTop, this._backgroundColor);\n\t\t\tthis._graphs[this._viewMode].render(ctx, 1, 17);\n\t\t\tctx.fillStyle = this._borderColor;\n\t\t\tctx.fillRect(0, 16, this._rect.width, 1);\n\n\t\t\tvar fpsMode = (this._viewMode === viewModes.FPS),\n\t\t\t\tdtMode = (this._viewMode === viewModes.DT);\n\n\t\t\tfillRect(ctx, this._rectFPS, fpsMode ? this._borderColor : this._backgroundColor);\n\t\t\tctx.fillStyle = fpsMode ? this._textColor : this._borderColor;\n\t\t\tctx.fillText('FPS', this._rectFPS.x + this._rectFPS.width / 2, 0);\n\n\t\t\tfillRect(ctx, this._rectDT, dtMode ? this._borderColor : this._backgroundColor);\n\t\t\tctx.fillStyle = dtMode ? this._textColor : this._borderColor;\n\t\t\tctx.fillText('DT', this._rectDT.x + this._rectDT.width / 2, 0);\n\t\t}\n\n\t\tstrokeRect(ctx, this._rect, this._borderColor);\n\n\t\tctx.fillStyle = this._textColor;\n\t\tctx.fillText(this._fps, 12, 0);\n\n\t\tctx.restore();\n\t};\n\n\tthis.getFPS = function () {\n\t\treturn this._fps;\n\t};\n});\n","pre":true},"sdk/timestep/platforms/browser/FontBuffer.js":{"path":"sdk/timestep/platforms/browser/FontBuffer.js","friendlyPath":".FontBuffer","directory":"sdk/timestep/platforms/browser/","filename":"FontBuffer.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @package env.browser.FontBuffer;\n *\n * ??? What the hell is this\n */\n\njsio(\"import device\");\n\nvar randomColorElement = function () {\n\tvar e = Math.floor(Math.random() * 255).toString(16);\n\treturn ((e.length === 1) ? '0' : '') + e;\n};\n\nvar randomColor = function () {\n\treturn '#' + randomColorElement() + randomColorElement() + randomColorElement();\n};\n\nvar sdk_timestep_platforms_browser_FontBuffer=__class__;var FontBuffer = exports=sdk_timestep_platforms_browser_FontBuffer(function sdk_timestep_platforms_browser_FontBuffer(){return this.init&&this.init.apply(this,arguments)},function () {\n\tthis.init = function (opts) {\n\t\t// 8 * 24\n\t\t// 10 * 32\n\t\t// 8 * 64\n\t\tvar lineSizes = [{size: 24, count: 8}, {size: 32, count: 10}, {size: 64, count: 8}],\n\t\t\tlineSize,\n\t\t\tlines,\n\t\t\titem,\n\t\t\ty = 0,\n\t\t\ti, j;\n\n\t\tthis._canvas = document.createElement('canvas');\n\t\tthis._canvas.width = 1024;\n\t\tthis._canvas.height = 1024;\n\t\tthis._ctx = this._canvas.getContext('2d');\n\n\t\tthis._list = [];\n\t\tfor (i = 0; i < lineSizes.length; i++) {\n\t\t\tlines = [];\n\t\t\tlineSize = lineSizes[i];\n\n\t\t\tfor (j = 0; j < lineSize.count; j++) {\n\t\t\t\titem = {\n\t\t\t\t\tprevious: null,\n\t\t\t\t\tnext: null,\n\t\t\t\t\tx: 0,\n\t\t\t\t\ty: y,\n\t\t\t\t\twidth: 1024,\n\t\t\t\t\theight: 0,\n\t\t\t\t\thash: null,\n\t\t\t\t\tframe: 0,\n\t\t\t\t\trefresh: true,\n\t\t\t\t\tctx: this._ctx\n\t\t\t\t};\n\t\t\t\tlines.push(item);\n\t\t\t\ty += lineSize.size;\n\t\t\t}\n\n\t\t\tthis._list.push({\n\t\t\t\tsize: lineSize.size,\n\t\t\t\tlines: lines\n\t\t\t});\n\t\t}\n\n\t\tthis._hashMap = {};\n\n\t\tthis._currentFrame = 0;\n\t\tthis._frameTimeout = 3;\n\n\t\tjsio('import ui.Engine').get().subscribe('Tick', this, this._onTick);\n\t};\n\n\tthis._onTick = function (dt) {\n\t\tthis._currentFrame++;\n\n\t\tvar remove,\n\t\t\tcurrentFrame = this._currentFrame,\n\t\t\tframeTimeout = this._frameTimeout,\n\t\t\tlist = this._list,\n\t\t\tlines,\n\t\t\titem,\n\t\t\ti, j, k, l;\n\n\t\tfor (i = 0, j = list.length; i < j; i++) {\n\t\t\tlines = list[i].lines;\n\t\t\tfor (k = 0, l = lines.length; k < l; k++) {\n\t\t\t\titem = lines[k];\n\t\t\t\twhile (item) {\n\t\t\t\t\tif (item.hash === null) {\n\t\t\t\t\t\tif (item.next && (item.next.hash === null)) {\n\t\t\t\t\t\t\titem.width += item.next.width;\n\t\t\t\t\t\t\titem.next = item.next.next;\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if (currentFrame > item.frame + frameTimeout) {\n\t\t\t\t\t\tthis._ctx.fillStyle = randomColor();\n\t\t\t\t\t\tthis._ctx.fillRect(item.x, item.y, item.width, item.height);\n\t\t\t\t\t\t// Remove old item...\n\t\t\t\t\t\tdelete(this._hashMap[item.hash]);\n\t\t\t\t\t\titem.hash = null;\n\t\t\t\t\t}\n\t\t\t\t\titem = item.next;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.alloc = function (opts) {\n\t\tvar requestHeight = opts.height,\n\t\t\trequestWidth = opts.width + 3, // Add some extra pixels to allow color bleeding...\n\n\t\t\tstrokeStyle = opts.strokeStyle || '',\n\t\t\tfillStyle = opts.fillStyle || '',\n\t\t\tfont = opts.font || '',\n\t\t\thash = strokeStyle + '_' + fillStyle + '_' + font + '_' + opts.text,\n\n\t\t\tlist = this._list,\n\t\t\tlines,\n\t\t\titem = this._hashMap[hash],\n\t\t\ti, j, k, l;\n\n\t\tif (item) {\n\t\t\titem.frame = this._currentFrame;\n\t\t\titem.refresh = false;\n\t\t\treturn item;\n\t\t}\n\n\t\tfor (i = 0, j = list.length; i < j; i++) {\n\t\t\tif (requestHeight <= list[i].size) {\n\t\t\t\tlines = list[i].lines;\n\t\t\t\tfor (k = 0, l = lines.length; k < l; k++) {\n\t\t\t\t\titem = lines[k];\n\t\t\t\t\twhile (item) {\n\t\t\t\t\t\tif ((requestWidth <= item.width) && (item.hash === null)) {\n\t\t\t\t\t\t\tif (requestWidth !== item.width) {\n\t\t\t\t\t\t\t\t//console.log('request:', requestWidth, 'width:', item.width, 'rest:', item.width - requestWidth);\n\t\t\t\t\t\t\t\titem.next = {\n\t\t\t\t\t\t\t\t\tprevious: item,\n\t\t\t\t\t\t\t\t\tnext: item.next,\n\t\t\t\t\t\t\t\t\tx: item.x + requestWidth,\n\t\t\t\t\t\t\t\t\ty: item.y,\n\t\t\t\t\t\t\t\t\twidth: item.width - requestWidth,\n\t\t\t\t\t\t\t\t\thash: null,\n\t\t\t\t\t\t\t\t\tframe: 0,\n\t\t\t\t\t\t\t\t\tctx: this._ctx\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\titem.frame = this._currentFrame;\n\t\t\t\t\t\t\titem.hash = hash;\n\t\t\t\t\t\t\titem.width = requestWidth;\n\t\t\t\t\t\t\titem.height = requestHeight;\n\t\t\t\t\t\t\titem.refresh = true;\n\n\t\t\t\t\t\t\tthis._ctx.clearRect(item.x, item.y, requestWidth, requestHeight);\n\n\t\t\t\t\t\t\tthis._hashMap[hash] = item;\n\t\t\t\t\t\t\treturn item;\n\t\t\t\t\t\t}\n\t\t\t\t\t\titem = item.next;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t};\n\n\tthis.getCanvas = function () {\n\t\treturn this._canvas;\n\t};\n});\n","pre":true},"sdk/timestep/platforms/browser/dev_error.js":{"path":"sdk/timestep/platforms/browser/dev_error.js","friendlyPath":".dev_error","directory":"sdk/timestep/platforms/browser/","filename":"dev_error.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @package timestep.env.browser.dev_error;\n *\n * Displays a developer error.\n *\n * ??? TODO move to a debug package.\n */\n\nexports.render = function (e) {\n\tlogger.error(\"unhandled tick exception\");\n\tlogger.error(e.stack);\n\t\n\tvar c = document.getElementsByTagName('canvas');\n\tfor (var i = 0, el; el = c[i]; ++i) {\n\t\trender(el.getContext('2d'), e);\n\t}\n}\n\nfunction render(ctx, e) {\n\tctx.fillStyle = \"rgb(0, 0, 255)\";\n\tctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);\n\t\n\tvar x = 30, y = 40;\n\n\tctx.fillStyle = \"#FFF\";\n\tctx.font = \"bold 12px Monaco,\\\"Bitstream Vera Sans Mono\\\",\\\"Lucida Console\\\",Terminal,monospace\";\n\tfunction drawLine(msg) {\n\t\tctx.fillText(msg, x, y);\n\t\ty += 20;\n\t}\n\t\n\tdrawLine(e.message);\n\ty += 40;\n\te.stack.split('\\n').map(drawLine);\n}\n","pre":true},"sdk/timestep/platforms/browser/FlashAPI.js":{"path":"sdk/timestep/platforms/browser/FlashAPI.js","friendlyPath":".FlashAPI","directory":"sdk/timestep/platforms/browser/","filename":"FlashAPI.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n\"use import\";\n\njsio(\"import lib.PubSub\");\njsio(\"import .SoundManager\");\njsio(\"from util.underscore import _\");\n\nvar soundManager = new SoundManager();\nsoundManager.url = 'media/swf';\nsoundManager.flashVersion = 9;\nsoundManager.useMovieStar = true;\nsoundManager.debugMode = false;\nsoundManager.consoleOnly = true;\nsoundManager.useHighPerformance = true;\nsoundManager.useFastPolling = true;\n\n/**\n * @extends lib.PubSub\n */\nvar sdk_timestep_platforms_browser_FlashAPI=__class__;var AudioAPI = exports=sdk_timestep_platforms_browser_FlashAPI(function sdk_timestep_platforms_browser_FlashAPI(){return this.init&&this.init.apply(this,arguments)},lib.PubSub, function (supr) {\n\tthis.init = function (opts) {\n\n\t\topts = merge(opts, {\n\t\t\tmap: {},\n\t\t\tbackground: []\n\t\t});\n\n\t\tsupr(this, 'init', [opts]);\n\t\tvar path = opts.path;\n\t\tthis._map = {};\n\n\t\t_.each(opts.background, function (name) {\n\t\t\topts.map[name] = {'name': name}\n\t\t}, this);\n\t\t\n\t\tsoundManager.onready(bind(this, function () {\n\t\t\tlogger.log('SoundManager onReady');\n\t\t\tfor (key in opts.map) {\n\t\t\t\tlogger.log('SoundManager key: ', key);\n\t\t\t\tvar url = 'media/audio/'  + key + '.mp3';\n\t\t\t\tvar k = this._map[key] = soundManager.createSound({\n\t\t\t\t\tid: key,\n\t\t\t\t\tbufferTime: 3,\n\t\t\t\t\turl: url\n\t\t\t\t});\n\t\t\t\tk.load();\n\t\t\t}\n\n\t\t\tthis.publish('Ready');\n\t\t}));\n\t}\n\t\n\tthis.canPlay = function (name) {\n\t\treturn (name in this._map);\n\t}\n\t\n\tthis.setVolume = function (volume) {\n\t\tthis._soundPlaying && soundManager.setVolume(this._soundPlaying, volume);\n\t\tthis._backgroundSoundPlaying && soundManager.setVolume(this._backgroundSoundPlaying, volume);\n\t}\n\n\tthis.setMuted = function (muted) {\n\t\tthis.muted = muted;\n\t\tif (muted) {\n\t\t\tthis.setVolume(0);\n\t\t}\n\t}\n\n\tthis.play = function (name, volume, channel) {\n\t\tif (!this.canPlay(name)) { return; }\n\t\tif (this.muted) { return; }\n\t\tif (volume === undefined) {\n\t\t\tvolume = 1.0;\n\t\t}\n\t\tthis._soundPlaying = name;\n\t\tthis._map[name].setVolume(volume * 100 | 0);\n\t\tthis._map[name].play();\n\t}\n\n\tthis.pause = function () {\n\t\tthis._map[this._soundPlaying].pause();\n\t\tthis._soundPlaying = null;\n\t}\n\n\tthis.playBackgroundMusic = function (name, volume) {\n\t\tif (!this.canPlay(name)) { return; }\n\t\tif (this.muted) { return; }\n\t\tif (volume === undefined) {\n\t\t\tvolume = 1.0;\n\t\t}\n\t\tthis._backgroundSoundPlaying = name;\n\t\tthis._map[name].setVolume(volume * 100 | 0);\n\t\tthis._map[name].play();\n\t}\n\n\tthis.pauseBackgroundMusic = function () {\n\t\tif (!this._backgroundSoundPlaying) { return; }\n\t\tthis._map[this._backgroundSoundPlaying].pause();\n\t\tthis._backgroundSoundPlaying = null;\n\t}\n});\n","pre":true},"sdk/timestep/platforms/browser/SoundManager.js":{"path":"sdk/timestep/platforms/browser/SoundManager.js","friendlyPath":".SoundManager","directory":"sdk/timestep/platforms/browser/","filename":"SoundManager.js","src":"/*\r\n * @license\r\n * SoundManager 2: JavaScript Sound for the Web\r\n * ----------------------------------------------\r\n * http://schillmania.com/projects/soundmanager2/\r\n *\r\n * Copyright (c) 2007, Scott Schiller. All rights reserved.\r\n * Code provided under the BSD License:\r\n * http://schillmania.com/projects/soundmanager2/license.txt\r\n *\r\n * V2.97a.20110801\r\n*/\r\n\r\n/*global window, SM2_DEFER, sm2Debugger, console, document, navigator, setTimeout, setInterval, clearInterval, Audio */\r\n/*jslint regexp: true, sloppy: true, white: true, nomen: true, plusplus: true */\r\n\r\nvar SoundManager = exports = function SoundManager(smURL, smID) {\r\n\r\n  this.flashVersion = 8;             // version of flash to require, either 8 or 9. Some API features require Flash 9.\r\n  this.debugMode = true;             // enable debugging output (div#soundmanager-debug, OR console if available+configured)\r\n  this.debugFlash = false;           // enable debugging output inside SWF, troubleshoot Flash/browser issues\r\n  this.useConsole = true;            // use firebug/safari console.log()-type debug console if available\r\n  this.consoleOnly = false;          // if console is being used, do not create/write to #soundmanager-debug\r\n  this.waitForWindowLoad = false;    // force SM2 to wait for window.onload() before trying to call soundManager.onload()\r\n  this.nullURL = 'about:blank';      // path to \"null\" (empty) MP3 file, used to unload sounds (Flash 8 only)\r\n  this.allowPolling = true;          // allow flash to poll for status update (required for whileplaying() events, peak, sound spectrum functions to work.)\r\n  this.useFastPolling = false;       // uses lower flash timer interval for higher callback frequency, best combined with useHighPerformance\r\n  this.useMovieStar = true;          // enable support for Flash 9.0r115+ (codename \"MovieStar\") MPEG4 audio formats (AAC, M4V, FLV, MOV etc.)\r\n  this.bgColor = '#ffffff';          // movie (.swf) background color, eg. '#000000'\r\n  this.useHighPerformance = false;   // position:fixed flash movie can help increase js/flash speed, minimize lag\r\n  this.flashPollingInterval = null;  // msec for polling interval. Defaults to 50 unless useFastPolling = true.\r\n  this.flashLoadTimeout = 1000;      // msec to wait for flash movie to load before failing (0 = infinity)\r\n  this.wmode = null;                 // string: flash rendering mode - null, transparent, opaque (last two allow layering of HTML on top)\r\n  this.allowScriptAccess = 'always'; // for scripting the SWF (object/embed property), either 'always' or 'sameDomain'\r\n  this.useFlashBlock = false;        // *requires flashblock.css, see demos* - allow recovery from flash blockers. Wait indefinitely and apply timeout CSS to SWF, if applicable.\r\n  this.useHTML5Audio = true;         // Beta feature: Use HTML5 Audio() where API is supported (most Safari, Chrome versions), Firefox (no MP3/MP4.) Ideally, transparent vs. Flash API where possible.\r\n  this.html5Test = /^(probably|maybe)$/i; // HTML5 Audio() format support test. Use /^probably$/i; if you want to be more conservative.\r\n  this.preferFlash = true;           // (experimental) if true and flash support present, will try to use flash for MP3/MP4 as needed since HTML5 audio support is still quirky in browsers.\r\n\r\n  this.audioFormats = {\r\n    /*\r\n     * determines HTML5 support + flash requirements.\r\n     * if no support for a \"required\" format, SM2 will fail to start.\r\n     * flash fallback is used for MP3 or MP4 if HTML5 can't play it (or if preferFlash = true)\r\n     * multiple MIME types may be tested while trying to get a positive canPlayType() response.\r\n    */\r\n    'mp3': {\r\n      'type': ['audio/mpeg; codecs=\"mp3\"', 'audio/mpeg', 'audio/mp3', 'audio/MPA', 'audio/mpa-robust'],\r\n      'required': true\r\n    },\r\n    'mp4': {\r\n      'related': ['aac','m4a'], // additional formats under the MP4 container\r\n      'type': ['audio/mp4; codecs=\"mp4a.40.2\"', 'audio/aac', 'audio/x-m4a', 'audio/MP4A-LATM', 'audio/mpeg4-generic'],\r\n      'required': false\r\n    },\r\n    'ogg': {\r\n      'type': ['audio/ogg; codecs=vorbis'],\r\n      'required': false\r\n    },\r\n    'wav': {\r\n      'type': ['audio/wav; codecs=\"1\"', 'audio/wav', 'audio/wave', 'audio/x-wav'],\r\n      'required': false\r\n    }\r\n  };\r\n\r\n  this.defaultOptions = {\r\n    'autoLoad': false,             // enable automatic loading (otherwise .load() will be called on demand with .play(), the latter being nicer on bandwidth - if you want to .load yourself, you also can)\r\n    'stream': true,                // allows playing before entire file has loaded (recommended)\r\n    'autoPlay': false,             // enable playing of file as soon as possible (much faster if \"stream\" is true)\r\n    'loops': 1,                    // how many times to repeat the sound (position will wrap around to 0, setPosition() will break out of loop when >0)\r\n    'onid3': null,                 // callback function for \"ID3 data is added/available\"\r\n    'onload': null,                // callback function for \"load finished\"\r\n    'whileloading': null,          // callback function for \"download progress update\" (X of Y bytes received)\r\n    'onplay': null,                // callback for \"play\" start\r\n    'onpause': null,               // callback for \"pause\"\r\n    'onresume': null,              // callback for \"resume\" (pause toggle)\r\n    'whileplaying': null,          // callback during play (position update)\r\n    'onstop': null,                // callback for \"user stop\"\r\n    'onfailure': null,             // callback function for when playing fails\r\n    'onfinish': null,              // callback function for \"sound finished playing\"\r\n    'onbeforefinish': null,        // callback for \"before sound finished playing (at [time])\"\r\n    'onbeforefinishtime': 5000,    // offset (milliseconds) before end of sound to trigger beforefinish (eg. 1000 msec = 1 second)\r\n    'onbeforefinishcomplete': null,// function to call when said sound finishes playing\r\n    'onjustbeforefinish': null,    // callback for [n] msec before end of current sound\r\n    'onjustbeforefinishtime': 200, // [n] - if not using, set to 0 (or null handler) and event will not fire.\r\n    'multiShot': true,             // let sounds \"restart\" or layer on top of each other when played multiple times, rather than one-shot/one at a time\r\n    'multiShotEvents': false,      // fire multiple sound events (currently onfinish() only) when multiShot is enabled\r\n    'position': null,              // offset (milliseconds) to seek to within loaded sound data.\r\n    'pan': 0,                      // \"pan\" settings, left-to-right, -100 to 100\r\n    'type': null,                  // MIME-like hint for file pattern / canPlay() tests, eg. audio/mp3\r\n    'usePolicyFile': false,        // enable crossdomain.xml request for audio on remote domains (for ID3/waveform access)\r\n    'volume': 100                  // self-explanatory. 0-100, the latter being the max.\r\n  };\r\n\r\n  this.flash9Options = {      // flash 9-only options, merged into defaultOptions if flash 9 is being used\r\n    'isMovieStar': null,      // \"MovieStar\" MPEG4 audio mode. Null (default) = auto detect MP4, AAC etc. based on URL. true = force on, ignore URL\r\n    'usePeakData': false,     // enable left/right channel peak (level) data\r\n    'useWaveformData': false, // enable sound spectrum (raw waveform data) - WARNING: CPU-INTENSIVE: may set CPUs on fire.\r\n    'useEQData': false,       // enable sound EQ (frequency spectrum data) - WARNING: Also CPU-intensive.\r\n    'onbufferchange': null,   // callback for \"isBuffering\" property change\r\n    'ondataerror': null       // callback for waveform/eq data access error (flash playing audio in other tabs/domains)\r\n  };\r\n\r\n  this.movieStarOptions = { // flash 9.0r115+ MPEG4 audio options, merged into defaultOptions if flash 9+movieStar mode is enabled\r\n    'bufferTime': 3,        // seconds of data to buffer before playback begins (null = flash default of 0.1 seconds - if AAC playback is gappy, try increasing.)\r\n    'serverURL': null,      // rtmp: FMS or FMIS server to connect to, required when requesting media via RTMP or one of its variants\r\n    'onconnect': null,      // rtmp: callback for connection to flash media server\r\n    'duration': null        // rtmp: song duration (msec)\r\n  };\r\n\r\n  this.version = null;\r\n  this.versionNumber = 'V2.97a.20110801';\r\n  this.movieURL = null;\r\n  this.url = (smURL || null);\r\n  this.altURL = null;\r\n  this.swfLoaded = false;\r\n  this.enabled = false;\r\n  this.o = null;\r\n  this.movieID = 'sm2-container';\r\n  this.id = (smID || 'sm2movie');\r\n  this.swfCSS = {\r\n    'swfBox': 'sm2-object-box',\r\n    'swfDefault': 'movieContainer',\r\n    'swfError': 'swf_error', // SWF loaded, but SM2 couldn't start (other error)\r\n    'swfTimedout': 'swf_timedout',\r\n    'swfLoaded': 'swf_loaded',\r\n    'swfUnblocked': 'swf_unblocked', // or loaded OK\r\n    'sm2Debug': 'sm2_debug',\r\n    'highPerf': 'high_performance',\r\n    'flashDebug': 'flash_debug'\r\n  };\r\n  this.oMC = null;\r\n  this.sounds = {};\r\n  this.soundIDs = [];\r\n  this.muted = false;\r\n  this.debugID = 'soundmanager-debug';\r\n  this.debugURLParam = /([#?&])debug=1/i;\r\n  this.specialWmodeCase = false;\r\n  this.didFlashBlock = false;\r\n\r\n  this.filePattern = null;\r\n  this.filePatterns = {\r\n    'flash8': /\\.mp3(\\?.*)?$/i,\r\n    'flash9': /\\.mp3(\\?.*)?$/i\r\n  };\r\n\r\n  this.baseMimeTypes = /^\\s*audio\\/(?:x-)?(?:mp(?:eg|3))\\s*(?:$|;)/i; // mp3\r\n  this.netStreamMimeTypes = /^\\s*audio\\/(?:x-)?(?:mp(?:eg|3))\\s*(?:$|;)/i; // mp3, mp4, aac etc.\r\n  this.netStreamTypes = ['aac', 'flv', 'mov', 'mp4', 'm4v', 'f4v', 'm4a', 'mp4v', '3gp', '3g2']; // Flash v9.0r115+ \"moviestar\" formats\r\n  this.netStreamPattern = new RegExp('\\\\.(' + this.netStreamTypes.join('|') + ')(\\\\?.*)?$', 'i');\r\n  this.mimePattern = this.baseMimeTypes;\r\n\r\n  this.features = {\r\n    'buffering': false,\r\n    'peakData': false,\r\n    'waveformData': false,\r\n    'eqData': false,\r\n    'movieStar': false\r\n  };\r\n\r\n  this.sandbox = {\r\n    // <d>\r\n    'type': null,\r\n    'types': {\r\n      'remote': 'remote (domain-based) rules',\r\n      'localWithFile': 'local with file access (no internet access)',\r\n      'localWithNetwork': 'local with network (internet access only, no local access)',\r\n      'localTrusted': 'local, trusted (local+internet access)'\r\n    },\r\n    'description': null,\r\n    'noRemote': null,\r\n    'noLocal': null\r\n    // </d>\r\n  };\r\n\r\n  this.hasHTML5 = (typeof Audio !== 'undefined' && typeof new Audio().canPlayType !== 'undefined'); // switch for handling logic\r\n\r\n  // stores canPlayType() results, etc. treat as read-only.\r\n  this.html5 = {\r\n    // mp3: boolean\r\n    // mp4: boolean\r\n    'usingFlash': null // set if/when flash fallback is needed\r\n  };\r\n\r\n  // format support\r\n  this.flash = {\r\n    // mp3: boolean\r\n    // mp4: boolean\r\n  };\r\n\r\n  this.html5Only = false;   // determined at init time\r\n  this.ignoreFlash = false; // used for special cases (eg. iPad/iPhone/palm OS?)\r\n\r\n  /*\r\n   * a few private internals\r\n  */\r\n\r\n  var SMSound,\r\n  _s = this, _sm = 'soundManager', _smc = _sm+'::', _h5 = 'HTML5::', _id, _ua = navigator.userAgent, _win = window, _wl = _win.location.href.toString(), _fV = this.flashVersion, _doc = document, _doNothing, _init, _on_queue = [], _debugOpen = true, _debugTS, _didAppend = false, _appendSuccess = false, _didInit = false, _disabled = false, _windowLoaded = false, _wDS, _wdCount = 0, _initComplete, _mixin, _addOnEvent, _processOnEvents, _initUserOnload, _delayWaitForEI, _waitForEI, _setVersionInfo, _handleFocus, _strings, _initMovie, _dcLoaded, _didDCLoaded, _getDocument, _createMovie, _catchError, _setPolling, _initDebug, _debugLevels = ['log', 'info', 'warn', 'error'], _defaultFlashVersion = 8, _disableObject, _failSafely, _normalizeMovieURL, _oRemoved = null, _oRemovedHTML = null, _str, _flashBlockHandler, _getSWFCSS, _toggleDebug, _loopFix, _policyFix, _complain, _idCheck, _waitingForEI = false, _initPending = false, _smTimer, _onTimer, _startTimer, _stopTimer, _needsFlash = null, _featureCheck, _html5OK, _html5CanPlay, _html5Ext,  _dcIE, _testHTML5, _event, _slice = Array.prototype.slice, _useGlobalHTML5Audio = false, _hasFlash, _detectFlash, _badSafariFix, _html5_events, _showSupport,\r\n  _is_iDevice = _ua.match(/(ipad|iphone|ipod)/i), _likesHTML5 = (_ua.match(/(mobile|pre\\/|xoom)/i) || _is_iDevice), _isIE = _ua.match(/msie/i), _isWebkit = _ua.match(/webkit/i), _isSafari = (_ua.match(/safari/i) && !_ua.match(/chrome/i)), _isOpera = (_ua.match(/opera/i)), \r\n  _isBadSafari = (!_wl.match(/usehtml5audio/i) && !_wl.match(/sm2\\-ignorebadua/i) && _isSafari && _ua.match(/OS X 10_6_([3-7])/i)), // Safari 4 and 5 occasionally fail to load/play HTML5 audio on Snow Leopard 10.6.3 through 10.6.7 due to bug(s) in QuickTime X and/or other underlying frameworks. :/ Confirmed bug. https://bugs.webkit.org/show_bug.cgi?id=32159\r\n  _hasConsole = (typeof console !== 'undefined' && typeof console.log !== 'undefined'), _isFocused = (typeof _doc.hasFocus !== 'undefined'?_doc.hasFocus():null), _tryInitOnFocus = (_isSafari && typeof _doc.hasFocus === 'undefined'), _okToDisable = !_tryInitOnFocus, _flashMIME = /(mp3|mp4|mpa)/i,\r\n  _overHTTP = (_doc.location?_doc.location.protocol.match(/http/i):null),\r\n  _http = (!_overHTTP ? 'http:' : '');\r\n\r\n  this.useAltURL = !_overHTTP; // use altURL if not \"online\"\r\n  this._global_a = null;\r\n\r\n  if (_likesHTML5) {\r\n    // prefer HTML5 for mobile + tablet-like devices, probably more reliable vs. flash at this point.\r\n    _s.useHTML5Audio = true;\r\n    _s.preferFlash = false;\r\n    if (_is_iDevice) {\r\n      // by default, use global feature. iOS onfinish() -> next may fail otherwise.\r\n      _s.ignoreFlash = true;\r\n      _useGlobalHTML5Audio = true;\r\n    }\r\n  }\r\n\r\n  /*\r\n   * public soundManager API\r\n  */\r\n\r\n  this.ok = function () {\r\n    return (_needsFlash?(_didInit && !_disabled):(_s.useHTML5Audio && _s.hasHTML5));\r\n  };\r\n\r\n  this.supported = this.ok; // legacy\r\n\r\n  this.getMovie = function (smID) {\r\n    return _isIE?_win[smID]:(_isSafari?_id(smID) || _doc[smID]:_id(smID));\r\n  };\r\n\r\n  this.createSound = function (oOptions) {\r\n    var _cs = _sm+'.createSound(): ',\r\n    thisOptions = null, oSound = null, _tO = null;\r\n    if (!_didInit || !_s.ok()) {\r\n      _complain(_cs + _str(!_didInit?'notReady':'notOK'));\r\n      return false;\r\n    }\r\n    if (arguments.length === 2) {\r\n      // function overloading in JS! :) ..assume simple createSound(id,url) use case\r\n      oOptions = {\r\n        'id': arguments[0],\r\n        'url': arguments[1]\r\n      };\r\n    }\r\n    thisOptions = _mixin(oOptions); // inherit from defaultOptions\r\n    _tO = thisOptions; // alias\r\n    // <d>\r\n    if (_tO.id.toString().charAt(0).match(/^[0-9]$/)) {\r\n      _s._wD(_cs + _str('badID', _tO.id), 2);\r\n    }\r\n    _s._wD(_cs + _tO.id + ' (' + _tO.url + ')', 1);\r\n    // </d>\r\n    if (_idCheck(_tO.id, true)) {\r\n      _s._wD(_cs + _tO.id + ' exists', 1);\r\n      return _s.sounds[_tO.id];\r\n    }\r\n\r\n    function make() {\r\n      thisOptions = _loopFix(thisOptions);\r\n      _s.sounds[_tO.id] = new SMSound(_tO);\r\n      _s.soundIDs.push(_tO.id);\r\n      return _s.sounds[_tO.id];\r\n    }\r\n\r\n    if (_html5OK(_tO)) {\r\n      oSound = make();\r\n      _s._wD('Loading sound '+_tO.id+' via HTML5');\r\n      oSound._setup_html5(_tO);\r\n    } else {\r\n      if (_fV > 8 && _s.useMovieStar) {\r\n        if (_tO.isMovieStar === null) {\r\n          _tO.isMovieStar = ((_tO.serverURL || (_tO.type?_tO.type.match(_s.netStreamPattern):false)||_tO.url.match(_s.netStreamPattern))?true:false);\r\n        }\r\n        if (_tO.isMovieStar) {\r\n          _s._wD(_cs + 'using MovieStar handling');\r\n        }\r\n        if (_tO.isMovieStar) {\r\n          if (_tO.usePeakData) {\r\n            _wDS('noPeak');\r\n            _tO.usePeakData = false;\r\n          }\r\n          if (_tO.loops > 1) {\r\n            _wDS('noNSLoop');\r\n          }\r\n        }\r\n      }\r\n      _tO = _policyFix(_tO, _cs);\r\n      oSound = make();\r\n      if (_fV === 8) {\r\n        _s.o._createSound(_tO.id, _tO.onjustbeforefinishtime, _tO.loops||1, _tO.usePolicyFile);\r\n      } else {\r\n        _s.o._createSound(_tO.id, _tO.url, _tO.onjustbeforefinishtime, _tO.usePeakData, _tO.useWaveformData, _tO.useEQData, _tO.isMovieStar, (_tO.isMovieStar?_tO.bufferTime:false), _tO.loops||1, _tO.serverURL, _tO.duration||null, _tO.autoPlay, true, _tO.autoLoad, _tO.usePolicyFile);\r\n        if (!_tO.serverURL) {\r\n          // We are connected immediately\r\n          oSound.connected = true;\r\n          if (_tO.onconnect) {\r\n            _tO.onconnect.apply(oSound);\r\n          }\r\n        }\r\n      }\r\n\r\n      if (!_tO.serverURL && (_tO.autoLoad || _tO.autoPlay)) {\r\n        oSound.load(_tO); // call load for non-rtmp streams\r\n      }\r\n    }\r\n    if (!_tO.serverURL && _tO.autoPlay) { // rtmp will play in onconnect\r\n      oSound.play();\r\n    }\r\n    return oSound;\r\n  };\r\n\r\n  this.destroySound = function (sID, _bFromSound) {\r\n    // explicitly destroy a sound before normal page unload, etc.\r\n    if (!_idCheck(sID)) {\r\n      return false;\r\n    }\r\n    var oS = _s.sounds[sID], i;\r\n    oS._iO = {}; // Disable all callbacks while the sound is being destroyed\r\n    oS.stop();\r\n    oS.unload();\r\n    for (i = 0; i < _s.soundIDs.length; i++) {\r\n      if (_s.soundIDs[i] === sID) {\r\n        _s.soundIDs.splice(i, 1);\r\n        break;\r\n      }\r\n    }\r\n    if (!_bFromSound) {\r\n      // ignore if being called from SMSound instance\r\n      oS.destruct(true);\r\n    }\r\n    oS = null;\r\n    delete _s.sounds[sID];\r\n    return true;\r\n  };\r\n\r\n  this.load = function (sID, oOptions) {\r\n    if (!_idCheck(sID)) {\r\n      return false;\r\n    }\r\n    return _s.sounds[sID].load(oOptions);\r\n  };\r\n\r\n  this.unload = function (sID) {\r\n    if (!_idCheck(sID)) {\r\n      return false;\r\n    }\r\n    return _s.sounds[sID].unload();\r\n  };\r\n\r\n  this.play = function (sID, oOptions) {\r\n    var fN = _sm+'.play(): ';\r\n    if (!_didInit || !_s.ok()) {\r\n      _complain(fN + _str(!_didInit?'notReady':'notOK'));\r\n      return false;\r\n    }\r\n    if (!_idCheck(sID)) {\r\n      if (!(oOptions instanceof Object)) {\r\n        oOptions = {\r\n          url: oOptions\r\n        }; // overloading use case: play('mySound','/path/to/some.mp3');\r\n      }\r\n      if (oOptions && oOptions.url) {\r\n        // overloading use case, create+play: .play('someID',{url:'/path/to.mp3'});\r\n        _s._wD(fN + 'attempting to create \"' + sID + '\"', 1);\r\n        oOptions.id = sID;\r\n        return _s.createSound(oOptions).play();\r\n      } else {\r\n        return false;\r\n      }\r\n    }\r\n    return _s.sounds[sID].play(oOptions);\r\n  };\r\n\r\n  this.start = this.play; // just for convenience\r\n\r\n  this.setPosition = function (sID, nMsecOffset) {\r\n    if (!_idCheck(sID)) {\r\n      return false;\r\n    }\r\n    return _s.sounds[sID].setPosition(nMsecOffset);\r\n  };\r\n\r\n  this.stop = function (sID) {\r\n    if (!_idCheck(sID)) {\r\n      return false;\r\n    }\r\n    _s._wD(_sm+'.stop(' + sID + ')', 1);\r\n    return _s.sounds[sID].stop();\r\n  };\r\n\r\n  this.stopAll = function () {\r\n    var oSound;\r\n    _s._wD(_sm+'.stopAll()', 1);\r\n    for (oSound in _s.sounds) {\r\n      if (_s.sounds.hasOwnProperty(oSound)) {\r\n        _s.sounds[oSound].stop(); // apply only to sound objects\r\n      }\r\n    }\r\n  };\r\n\r\n  this.pause = function (sID) {\r\n    if (!_idCheck(sID)) {\r\n      return false;\r\n    }\r\n    return _s.sounds[sID].pause();\r\n  };\r\n\r\n  this.pauseAll = function () {\r\n    var i;\r\n    for (i = _s.soundIDs.length; i--;) {\r\n      _s.sounds[_s.soundIDs[i]].pause();\r\n    }\r\n  };\r\n\r\n  this.resume = function (sID) {\r\n    if (!_idCheck(sID)) {\r\n      return false;\r\n    }\r\n    return _s.sounds[sID].resume();\r\n  };\r\n\r\n  this.resumeAll = function () {\r\n    var i;\r\n    for (i = _s.soundIDs.length; i--;) {\r\n      _s.sounds[_s.soundIDs[i]].resume();\r\n    }\r\n  };\r\n\r\n  this.togglePause = function (sID) {\r\n    if (!_idCheck(sID)) {\r\n      return false;\r\n    }\r\n    return _s.sounds[sID].togglePause();\r\n  };\r\n\r\n  this.setPan = function (sID, nPan) {\r\n    if (!_idCheck(sID)) {\r\n      return false;\r\n    }\r\n    return _s.sounds[sID].setPan(nPan);\r\n  };\r\n\r\n  this.setVolume = function (sID, nVol) {\r\n    if (!_idCheck(sID)) {\r\n      return false;\r\n    }\r\n    return _s.sounds[sID].setVolume(nVol);\r\n  };\r\n\r\n  this.mute = function (sID) {\r\n    var fN = _sm+'.mute(): ',\r\n    i = 0;\r\n    if (typeof sID !== 'string') {\r\n      sID = null;\r\n    }\r\n    if (!sID) {\r\n      _s._wD(fN + 'Muting all sounds');\r\n      for (i = _s.soundIDs.length; i--;) {\r\n        _s.sounds[_s.soundIDs[i]].mute();\r\n      }\r\n      _s.muted = true;\r\n    } else {\r\n      if (!_idCheck(sID)) {\r\n        return false;\r\n      }\r\n      _s._wD(fN + 'Muting \"' + sID + '\"');\r\n      return _s.sounds[sID].mute();\r\n    }\r\n    return true;\r\n  };\r\n\r\n  this.muteAll = function () {\r\n    _s.mute();\r\n  };\r\n\r\n  this.unmute = function (sID) {\r\n    var fN = _sm+'.unmute(): ', i;\r\n    if (typeof sID !== 'string') {\r\n      sID = null;\r\n    }\r\n    if (!sID) {\r\n      _s._wD(fN + 'Unmuting all sounds');\r\n      for (i = _s.soundIDs.length; i--;) {\r\n        _s.sounds[_s.soundIDs[i]].unmute();\r\n      }\r\n      _s.muted = false;\r\n    } else {\r\n      if (!_idCheck(sID)) {\r\n        return false;\r\n      }\r\n      _s._wD(fN + 'Unmuting \"' + sID + '\"');\r\n      return _s.sounds[sID].unmute();\r\n    }\r\n    return true;\r\n  };\r\n\r\n  this.unmuteAll = function () {\r\n    _s.unmute();\r\n  };\r\n\r\n  this.toggleMute = function (sID) {\r\n    if (!_idCheck(sID)) {\r\n      return false;\r\n    }\r\n    return _s.sounds[sID].toggleMute();\r\n  };\r\n\r\n  this.getMemoryUse = function () {\r\n    // flash-only\r\n    var ram = 0;\r\n    if (_s.o && _fV !== 8) {\r\n      ram = parseInt(_s.o._getMemoryUse(), 10);\r\n    }\r\n    return ram;\r\n  };\r\n\r\n  this.disable = function (bNoDisable) {\r\n    // destroy all functions\r\n    var i;\r\n    if (typeof bNoDisable === 'undefined') {\r\n      bNoDisable = false;\r\n    }\r\n    if (_disabled) {\r\n      return false;\r\n    }\r\n    _disabled = true;\r\n    _wDS('shutdown', 1);\r\n    for (i = _s.soundIDs.length; i--;) {\r\n      _disableObject(_s.sounds[_s.soundIDs[i]]);\r\n    }\r\n    _initComplete(bNoDisable); // fire \"complete\", despite fail\r\n    _event.remove(_win, 'load', _initUserOnload);\r\n    return true;\r\n  };\r\n\r\n  this.canPlayMIME = function (sMIME) {\r\n    var result;\r\n    if (_s.hasHTML5) {\r\n      result = _html5CanPlay({type:sMIME});\r\n    }\r\n    if (!_needsFlash || result) {\r\n      // no flash, or OK\r\n      return result;\r\n    } else {\r\n      return (sMIME?(sMIME.match(_s.mimePattern)?true:false):null);\r\n    }\r\n  };\r\n\r\n  this.canPlayURL = function (sURL) {\r\n    var result;\r\n    if (_s.hasHTML5) {\r\n      result = _html5CanPlay({url: sURL});\r\n    }\r\n    if (!_needsFlash || result) {\r\n      // no flash, or OK\r\n      return result;\r\n    } else {\r\n      return (sURL?(sURL.match(_s.filePattern)?true:false):null);\r\n    }\r\n  };\r\n\r\n  this.canPlayLink = function (oLink) {\r\n    if (typeof oLink.type !== 'undefined' && oLink.type) {\r\n      if (_s.canPlayMIME(oLink.type)) {\r\n        return true;\r\n      }\r\n    }\r\n    return _s.canPlayURL(oLink.href);\r\n  };\r\n\r\n  this.getSoundById = function (sID, suppressDebug) {\r\n    if (!sID) {\r\n      throw new Error(_sm+'.getSoundById(): sID is null/undefined');\r\n    }\r\n    var result = _s.sounds[sID];\r\n    if (!result && !suppressDebug) {\r\n      _s._wD('\"' + sID + '\" is an invalid sound ID.', 2);\r\n    }\r\n    return result;\r\n  };\r\n\r\n  this.onready = function (oMethod, oScope) {\r\n    var sType = 'onready';\r\n    if (oMethod && oMethod instanceof Function) {\r\n      if (_didInit) {\r\n        _s._wD(_str('queue', sType));\r\n      }\r\n      if (!oScope) {\r\n        oScope = _win;\r\n      }\r\n      _addOnEvent(sType, oMethod, oScope);\r\n      _processOnEvents();\r\n      return true;\r\n    } else {\r\n      throw _str('needFunction', sType);\r\n    }\r\n  };\r\n\r\n  this.ontimeout = function (oMethod, oScope) {\r\n    var sType = 'ontimeout';\r\n    if (oMethod && oMethod instanceof Function) {\r\n      if (_didInit) {\r\n        _s._wD(_str('queue', sType));\r\n      }\r\n      if (!oScope) {\r\n        oScope = _win;\r\n      }\r\n      _addOnEvent(sType, oMethod, oScope);\r\n      _processOnEvents({type:sType});\r\n      return true;\r\n    } else {\r\n      throw _str('needFunction', sType);\r\n    }\r\n  };\r\n\r\n  this._writeDebug = function (sText, sType, bTimestamp) {\r\n    // pseudo-private console.log()-style output\r\n    // <d>\r\n    var sDID = 'soundmanager-debug', o, oItem, sMethod;\r\n    if (!_s.debugMode) {\r\n      return false;\r\n    }\r\n    if (typeof bTimestamp !== 'undefined' && bTimestamp) {\r\n      sText = sText + ' | ' + new Date().getTime();\r\n    }\r\n    if (_hasConsole && _s.useConsole) {\r\n      sMethod = _debugLevels[sType];\r\n      if (typeof console[sMethod] !== 'undefined') {\r\n        console[sMethod](sText);\r\n      } else {\r\n        console.log(sText);\r\n      }\r\n      if (_s.useConsoleOnly) {\r\n        return true;\r\n      }\r\n    }\r\n    try {\r\n      o = _id(sDID);\r\n      if (!o) {\r\n        return false;\r\n      }\r\n      oItem = _doc.createElement('div');\r\n      if (++_wdCount % 2 === 0) {\r\n        oItem.className = 'sm2-alt';\r\n      }\r\n      if (typeof sType === 'undefined') {\r\n        sType = 0;\r\n      } else {\r\n        sType = parseInt(sType, 10);\r\n      }\r\n      oItem.appendChild(_doc.createTextNode(sText));\r\n      if (sType) {\r\n        if (sType >= 2) {\r\n          oItem.style.fontWeight = 'bold';\r\n        }\r\n        if (sType === 3) {\r\n          oItem.style.color = '#ff3333';\r\n        }\r\n      }\r\n      // o.appendChild(oItem); // top-to-bottom\r\n      o.insertBefore(oItem, o.firstChild); // bottom-to-top\r\n    } catch(e) {\r\n      // oh well\r\n    }\r\n    o = null;\r\n    // </d>\r\n    return true;\r\n  };\r\n  this._wD = this._writeDebug; // alias\r\n\r\n  this._debug = function () {\r\n    // <d>\r\n    var i, j;\r\n    _wDS('currentObj', 1);\r\n    for (i = 0, j = _s.soundIDs.length; i < j; i++) {\r\n      _s.sounds[_s.soundIDs[i]]._debug();\r\n    }\r\n    // </d>\r\n  };\r\n\r\n  this.reboot = function () {\r\n    // attempt to reset and init SM2\r\n    _s._wD(_sm+'.reboot()');\r\n    if (_s.soundIDs.length) {\r\n      _s._wD('Destroying ' + _s.soundIDs.length + ' SMSound objects...');\r\n    }\r\n    var i, j;\r\n    for (i = _s.soundIDs.length; i--;) {\r\n      _s.sounds[_s.soundIDs[i]].destruct();\r\n    }\r\n    // trash ze flash\r\n    try {\r\n      if (_isIE) {\r\n        _oRemovedHTML = _s.o.innerHTML;\r\n      }\r\n      _oRemoved = _s.o.parentNode.removeChild(_s.o);\r\n      _s._wD('Flash movie removed.');\r\n    } catch(e) {\r\n      // uh-oh.\r\n      _wDS('badRemove', 2);\r\n    }\r\n    // actually, force recreate of movie.\r\n    _oRemovedHTML = _oRemoved = _needsFlash = null;\r\n    _s.enabled = _didDCLoaded = _didInit = _waitingForEI = _initPending = _didAppend = _appendSuccess = _disabled = _s.swfLoaded = false;\r\n    _s.soundIDs = _s.sounds = [];\r\n    _s.o = null;\r\n    for (i in _on_queue) {\r\n      if (_on_queue.hasOwnProperty(i)) {\r\n        for (j = _on_queue[i].length; j--;) {\r\n          _on_queue[i][j].fired = false;\r\n        }\r\n      }\r\n    }\r\n    _s._wD(_sm + ': Rebooting...');\r\n    _win.setTimeout(_s.beginDelayedInit, 20);\r\n  };\r\n\r\n  this.getMoviePercent = function () {\r\n    return (_s.o && typeof _s.o.PercentLoaded !== 'undefined' ? _s.o.PercentLoaded() : null);\r\n  };\r\n\r\n  this.beginDelayedInit = function () {\r\n    _windowLoaded = true;\r\n    _dcLoaded();\r\n    setTimeout(function () {\r\n      if (_initPending) {\r\n        return false;\r\n      }\r\n      _createMovie();\r\n      _initMovie();\r\n      _initPending = true;\r\n      return true;\r\n    }, 20);\r\n    _delayWaitForEI();\r\n  };\r\n\r\n  this.destruct = function () {\r\n    _s._wD(_sm+'.destruct()');\r\n    _s.disable(true);\r\n  };\r\n\r\n  /*\r\n   * internal HTML5 event handling\r\n  */\r\n\r\n  function _html5_event(oFn) {\r\n    // wrap html5 event handlers so we don't call them on destroyed sounds\r\n    return function (e) {\r\n      if (!this._t || !this._t._a) {\r\n        if (this._t && this._t.sID) {\r\n          _s._wD(_h5+'ignoring '+e.type+': '+this._t.sID);\r\n        } else {\r\n          _s._wD(_h5+'ignoring '+e.type);\r\n        }\r\n        return null;\r\n      } else {\r\n        return oFn.call(this, e);\r\n      }\r\n    };\r\n  }\r\n\r\n  _html5_events = {\r\n\r\n    // HTML5 event-name-to-handler map\r\n    abort: _html5_event(function (e) {\r\n      _s._wD(_h5+'abort: '+this._t.sID);\r\n    }),\r\n\r\n    // enough has loaded to play\r\n    canplay: _html5_event(function (e) {\r\n      if (this._t._html5_canplay) {\r\n        // this event has already fired. ignore.\r\n        return true;\r\n      }\r\n      this._t._html5_canplay = true;\r\n      _s._wD(_h5+'canplay: '+this._t.sID+', '+this._t.url);\r\n      this._t._onbufferchange(0);\r\n      var position1K = (!isNaN(this._t.position)?this._t.position/1000:null);\r\n      // set the position if position was set before the sound loaded\r\n      if (this._t.position && this.currentTime !== position1K) {\r\n        _s._wD(_h5+'canplay: setting position to '+position1K);\r\n        try {\r\n          this.currentTime = position1K;\r\n        } catch(ee) {\r\n          _s._wD(_h5+'setting position failed: '+ee.message, 2);\r\n        }\r\n      }\r\n    }),\r\n\r\n    load: _html5_event(function (e) {\r\n      if (!this._t.loaded) {\r\n        this._t._onbufferchange(0);\r\n        // should be 1, and the same\r\n        this._t._whileloading(this._t.bytesTotal, this._t.bytesTotal, this._t._get_html5_duration());\r\n        this._t._onload(true);\r\n      }\r\n    }),\r\n\r\n    emptied: _html5_event(function (e) {\r\n      _s._wD(_h5+'emptied: '+this._t.sID);\r\n    }),\r\n\r\n    ended: _html5_event(function (e) {\r\n      _s._wD(_h5+'ended: '+this._t.sID);\r\n      this._t._onfinish();\r\n    }),\r\n\r\n    error: _html5_event(function (e) {\r\n      _s._wD(_h5+'error: '+this.error.code);\r\n      // call load with error state?\r\n      this._t._onload(false);\r\n    }),\r\n\r\n    loadeddata: _html5_event(function (e) {\r\n      var t = this._t,\r\n          bytesTotal = t.bytesTotal || 1; // at least 1 byte, so math works\r\n      _s._wD(_h5+'loadeddata: '+this._t.sID);\r\n      if (!t._loaded && !_isSafari) { // safari seems to nicely report progress events, eventually totalling 100%\r\n        t.duration = t._get_html5_duration();\r\n        // fire whileloading() with 100% values\r\n        t._whileloading(bytesTotal, bytesTotal, t._get_html5_duration());\r\n        t._onload(true);\r\n      }\r\n    }),\r\n\r\n    loadedmetadata: _html5_event(function (e) {\r\n      _s._wD(_h5+'loadedmetadata: '+this._t.sID);\r\n    }),\r\n\r\n    loadstart: _html5_event(function (e) {\r\n      _s._wD(_h5+'loadstart: '+this._t.sID);\r\n      // assume buffering at first\r\n      this._t._onbufferchange(1);\r\n    }),\r\n\r\n    play: _html5_event(function (e) {\r\n      _s._wD(_h5+'play: '+this._t.sID+', '+this._t.url);\r\n      // once play starts, no buffering\r\n      this._t._onbufferchange(0);\r\n    }),\r\n\r\n    // TODO: verify if this is actually implemented anywhere yet.\r\n    playing: _html5_event(function (e) {\r\n      _s._wD(_h5+'playing: '+this._t.sID+', '+this._t.url);\r\n      // once play starts, no buffering\r\n      this._t._onbufferchange(0);\r\n    }),\r\n\r\n    progress: _html5_event(function (e) {\r\n\r\n      if (this._t.loaded) {\r\n        return false;\r\n      }\r\n\r\n      var i, j, str, buffered = 0,\r\n          isProgress = (e.type === 'progress'),\r\n          ranges = e.target.buffered,\r\n          loaded = (e.loaded||0), // firefox 3.6 implements e.loaded/total (bytes)\r\n          total = (e.total||1);\r\n\r\n      if (ranges && ranges.length) {\r\n\r\n        // if loaded is 0, try TimeRanges implementation as % of load\r\n        // https://developer.mozilla.org/en/DOM/TimeRanges\r\n        for (i=ranges.length; i--;) {\r\n          buffered = (ranges.end(i) - ranges.start(i));\r\n        }\r\n\r\n        // linear case, buffer sum; does not account for seeking and HTTP partials / byte ranges\r\n        loaded = buffered/e.target.duration;\r\n\r\n        // <d>\r\n        if (isProgress && ranges.length > 1) {\r\n          str = [];\r\n          j = ranges.length;\r\n          for (i=0; i<j; i++) {\r\n            str.push(e.target.buffered.start(i) +'-'+ e.target.buffered.end(i));\r\n          }\r\n          _s._wD(_h5+'progress: timeRanges: '+str.join(', '));\r\n        }\r\n        // </d>\r\n\r\n        if (isProgress && !isNaN(loaded)) {\r\n          _s._wD(_h5+'progress: '+this._t.sID+': ' + Math.floor(loaded*100)+'% loaded');\r\n        }\r\n\r\n      }\r\n\r\n      if (!isNaN(loaded)) {\r\n\r\n        this._t._onbufferchange(0); // if progress, likely not buffering\r\n        this._t._whileloading(loaded, total, this._t._get_html5_duration());\r\n\r\n        if (loaded && total && loaded === total) {\r\n          // in case \"onload\" doesn't fire (eg. gecko 1.9.2)\r\n          _html5_events.load.call(this, e);\r\n        }\r\n\r\n      }\r\n\r\n    }),\r\n\r\n    ratechange: _html5_event(function (e) {\r\n      _s._wD(_h5+'ratechange: '+this._t.sID);\r\n    }),\r\n\r\n    suspend: _html5_event(function (e) {\r\n      // download paused/stopped, may have finished (eg. onload)\r\n      _s._wD(_h5+'suspend: '+this._t.sID);\r\n      _html5_events.progress.call(this, e);\r\n    }),\r\n\r\n    stalled: _html5_event(function (e) {\r\n      _s._wD(_h5+'stalled: '+this._t.sID);\r\n    }),\r\n\r\n    timeupdate: _html5_event(function (e) {\r\n      this._t._onTimer();\r\n    }),\r\n\r\n    waiting: _html5_event(function (e) { // see also: seeking\r\n      _s._wD(_h5+'waiting: '+this._t.sID);\r\n      // playback faster than download rate, etc.\r\n      this._t._onbufferchange(1);\r\n    })\r\n\r\n  };\r\n\r\n  /*\r\n   * SMSound() (sound object) instance\r\n  */\r\n\r\n  SMSound = function (oOptions) {\r\n\r\n    var _t = this, _resetProperties, _stop_html5_timer, _start_html5_timer;\r\n    this.sID = oOptions.id;\r\n    this.url = oOptions.url;\r\n    this.options = _mixin(oOptions);\r\n    this.instanceOptions = this.options; // per-play-instance-specific options\r\n    this._iO = this.instanceOptions; // short alias\r\n    // assign property defaults\r\n    this.pan = this.options.pan;\r\n    this.volume = this.options.volume;\r\n    this._lastURL = null;\r\n    this.isHTML5 = false;\r\n    this._a = null;\r\n\r\n    // --- public methods ---\r\n\r\n    this.id3 = {};\r\n\r\n    this._debug = function () {\r\n      // <d>\r\n      // pseudo-private console.log()-style output\r\n      if (_s.debugMode) {\r\n        var stuff = null, msg = [], sF, sfBracket, maxLength = 64;\r\n        for (stuff in _t.options) {\r\n          if (_t.options[stuff] !== null) {\r\n            if (_t.options[stuff] instanceof Function) {\r\n              // handle functions specially\r\n              sF = _t.options[stuff].toString();\r\n              sF = sF.replace(/\\s\\s+/g, ' '); // normalize spaces\r\n              sfBracket = sF.indexOf('{');\r\n              msg.push(' ' + stuff + ': {' + sF.substr(sfBracket + 1, (Math.min(Math.max(sF.indexOf('\\n') - 1, maxLength), maxLength))).replace(/\\n/g, '') + '... }');\r\n            } else {\r\n              msg.push(' ' + stuff + ': ' + _t.options[stuff]);\r\n            }\r\n          }\r\n        }\r\n        _s._wD('SMSound() merged options: {\\n' + msg.join(', \\n') + '\\n}');\r\n      }\r\n      // </d>\r\n    };\r\n\r\n    // <d>\r\n    this._debug();\r\n    // </d>\r\n\r\n    this.load = function (oOptions) {\r\n      var oS = null;\r\n      if (typeof oOptions !== 'undefined') {\r\n        _t._iO = _mixin(oOptions, _t.options);\r\n        _t.instanceOptions = _t._iO;\r\n      } else {\r\n        oOptions = _t.options;\r\n        _t._iO = oOptions;\r\n        _t.instanceOptions = _t._iO;\r\n        if (_t._lastURL && _t._lastURL !== _t.url) {\r\n          _wDS('manURL');\r\n          _t._iO.url = _t.url;\r\n          _t.url = null;\r\n        }\r\n      }\r\n      if (!_t._iO.url) {\r\n        _t._iO.url = _t.url;\r\n      }\r\n      _s._wD('SMSound.load(): ' + _t._iO.url, 1);\r\n      if (_t._iO.url === _t.url && _t.readyState !== 0 && _t.readyState !== 2) {\r\n        _wDS('onURL', 1);\r\n        return _t;\r\n      }\r\n      _t._lastURL = _t.url;\r\n      _t.loaded = false;\r\n      _t.readyState = 1;\r\n      _t.playState = 0;\r\n      if (_html5OK(_t._iO)) {\r\n        oS = _t._setup_html5(_t._iO);\r\n        if (!oS._called_load) {\r\n          _s._wD(_h5+'load: '+_t.sID);\r\n          _t._html5_canplay = false;\r\n          oS.load();\r\n          oS._called_load = true;\r\n          if (_t._iO.autoPlay) {\r\n            _t.play();\r\n          }\r\n        } else {\r\n          _s._wD(_h5+'ignoring request to load again: '+_t.sID);\r\n        }\r\n      } else {\r\n        try {\r\n          _t.isHTML5 = false;\r\n          _t._iO = _policyFix(_loopFix(_t._iO));\r\n          if (_fV === 8) {\r\n            _s.o._load(_t.sID, _t._iO.url, _t._iO.stream, _t._iO.autoPlay, (_t._iO.whileloading?1:0), _t._iO.loops||1, _t._iO.usePolicyFile);\r\n          } else {\r\n            _s.o._load(_t.sID, _t._iO.url, _t._iO.stream?true:false, _t._iO.autoPlay?true:false, _t._iO.loops||1, _t._iO.autoLoad?true:false, _t._iO.usePolicyFile);\r\n          }\r\n        } catch(e) {\r\n          _wDS('smError', 2);\r\n          _debugTS('onload', false);\r\n          _catchError({type:'SMSOUND_LOAD_JS_EXCEPTION', fatal:true});\r\n        }\r\n      }\r\n      return _t;\r\n    };\r\n\r\n    this.unload = function () {\r\n      // Flash 8/AS2 can't \"close\" a stream - fake it by loading an empty MP3\r\n      // Flash 9/AS3: Close stream, preventing further load\r\n      if (_t.readyState !== 0) {\r\n        _s._wD('SMSound.unload(): \"' + _t.sID + '\"');\r\n        if (!_t.isHTML5) {\r\n          if (_fV === 8) {\r\n            _s.o._unload(_t.sID, _s.nullURL);\r\n          } else {\r\n            _s.o._unload(_t.sID);\r\n          }\r\n        } else {\r\n          _stop_html5_timer();\r\n          if (_t._a) {\r\n            // abort()-style method here, stop loading? (doesn't exist?)\r\n            _t._a.pause();\r\n            _t._a.src = ''; // https://developer.mozilla.org/En/Using_audio_and_video_in_Firefox#Stopping_the_download_of_media\r\n          }\r\n        }\r\n        // reset load/status flags\r\n        _resetProperties();\r\n      }\r\n      return _t;\r\n    };\r\n\r\n    this.destruct = function (_bFromSM) {\r\n      _s._wD('SMSound.destruct(): \"' + _t.sID + '\"');\r\n      if (!_t.isHTML5) {\r\n        // kill sound within Flash\r\n        // Disable the onfailure handler\r\n        _t._iO.onfailure = null;\r\n        _s.o._destroySound(_t.sID);\r\n      } else {\r\n        _stop_html5_timer();\r\n        if (_t._a) {\r\n          // abort()-style method here, stop loading? (doesn't exist?)\r\n          _t._a.pause();\r\n          _t._a.src = ''; // https://developer.mozilla.org/En/Using_audio_and_video_in_Firefox#Stopping_the_download_of_media\r\n          if (!_useGlobalHTML5Audio) {\r\n            _t._remove_html5_events();\r\n          }\r\n          _t._a._t = null; // break potential circular reference\r\n          _t._a = null;\r\n        }\r\n      }\r\n      if (!_bFromSM) {\r\n        _s.destroySound(_t.sID, true); // ensure deletion from controller\r\n      }\r\n    };\r\n\r\n    this.play = function (oOptions, _updatePlayState) {\r\n      var fN = 'SMSound.play(): ', allowMulti, a;\r\n      _updatePlayState = _updatePlayState === undefined ? true : _updatePlayState; // default to true\r\n      if (!oOptions) {\r\n        oOptions = {};\r\n      }\r\n      _t._iO = _mixin(oOptions, _t._iO);\r\n      _t._iO = _mixin(_t._iO, _t.options);\r\n      _t.instanceOptions = _t._iO;\r\n      if (_t._iO.serverURL && !_t.connected) {\r\n        if (!_t.getAutoPlay()) {\r\n          _s._wD(fN+' Netstream not connected yet - setting autoPlay');\r\n          _t.setAutoPlay(true);\r\n        }\r\n        return _t; // play will be called in _onconnect()\r\n      }\r\n      if (_html5OK(_t._iO)) {\r\n        _t._setup_html5(_t._iO);\r\n        _start_html5_timer();\r\n      }\r\n      if (_t.playState === 1 && !_t.paused) {\r\n        allowMulti = _t._iO.multiShot;\r\n        if (!allowMulti) {\r\n          _s._wD(fN + '\"' + _t.sID + '\" already playing (one-shot)', 1);\r\n          return _t;\r\n        } else {\r\n          _s._wD(fN + '\"' + _t.sID + '\" already playing (multi-shot)', 1);\r\n        }\r\n      }\r\n      if (!_t.loaded) {\r\n        if (_t.readyState === 0) {\r\n          _s._wD(fN + 'Attempting to load \"' + _t.sID + '\"', 1);\r\n          // try to get this sound playing ASAP\r\n          if (!_t.isHTML5) {\r\n            _t._iO.autoPlay = true; // assign directly because setAutoPlay() increments the instanceCount\r\n          }\r\n          _t.load(_t._iO);\r\n        } else if (_t.readyState === 2) {\r\n          _s._wD(fN + 'Could not load \"' + _t.sID + '\" - exiting', 2);\r\n          return _t;\r\n        } else {\r\n          _s._wD(fN + '\"' + _t.sID + '\" is loading - attempting to play..', 1);\r\n        }\r\n      } else {\r\n        _s._wD(fN + '\"' + _t.sID + '\"');\r\n      }\r\n      if (!_t.isHTML5 && _fV === 9 && _t.position > 0 && _t.position === _t.duration) {\r\n        // flash 9 needs a position reset if play() is called while at the end of a sound.\r\n        _s._wD(fN + '\"' + _t.sID + '\": Sound at end, resetting to position:0');\r\n        _t._iO.position = 0;\r\n      }\r\n      /*\r\n       * Streams will pause when their buffer is full if they are being loaded.\r\n       * In this case paused is true, but the song hasn't started playing yet.\r\n       * If we just call resume() the onplay() callback will never be called.\r\n       * So only call resume() if the position is > 0.\r\n       * Another reason is because options like volume won't have been applied yet.\r\n      */\r\n      if (_t.paused && _t.position && _t.position > 0) { // https://gist.github.com/37b17df75cc4d7a90bf6\r\n        _s._wD(fN + '\"' + _t.sID + '\" is resuming from paused state',1);\r\n        _t.resume();\r\n      } else {\r\n        _s._wD(fN+'\"'+ _t.sID+'\" is starting to play');\r\n        _t.playState = 1;\r\n        _t.paused = false;\r\n        if (!_t.instanceCount || _t._iO.multiShotEvents || (!_t.isHTML5 && _fV > 8 && !_t.getAutoPlay())) {\r\n          _t.instanceCount++;\r\n        }\r\n        _t.position = (typeof _t._iO.position !== 'undefined' && !isNaN(_t._iO.position)?_t._iO.position:0);\r\n        if (!_t.isHTML5) {\r\n          _t._iO = _policyFix(_loopFix(_t._iO));\r\n        }\r\n        if (_t._iO.onplay && _updatePlayState) {\r\n          _t._iO.onplay.apply(_t);\r\n          _t._onplay_called = true;\r\n        }\r\n        _t.setVolume(_t._iO.volume, true);\r\n        _t.setPan(_t._iO.pan, true);\r\n        if (!_t.isHTML5) {\r\n          _s.o._start(_t.sID, _t._iO.loops || 1, (_fV === 9?_t._iO.position:_t._iO.position / 1000));\r\n        } else {\r\n          _start_html5_timer();\r\n          a = _t._setup_html5();\r\n          _t.setPosition(_t._iO.position);\r\n          a.play();\r\n        }\r\n      }\r\n      return _t;\r\n    };\r\n\r\n    this.start = this.play; // just for convenience\r\n\r\n    this.stop = function (bAll) {\r\n      if (_t.playState === 1) {\r\n        _t._onbufferchange(0);\r\n        _t.resetOnPosition(0);\r\n        if (!_t.isHTML5) {\r\n          _t.playState = 0;\r\n        }\r\n        _t.paused = false;\r\n        if (_t._iO.onstop) {\r\n          _t._iO.onstop.apply(_t);\r\n        }\r\n        if (!_t.isHTML5) {\r\n          _s.o._stop(_t.sID, bAll);\r\n          // hack for netStream: just unload\r\n          if (_t._iO.serverURL) {\r\n            _t.unload();\r\n          }\r\n        } else {\r\n          if (_t._a) {\r\n            _t.setPosition(0); // act like Flash, though\r\n            _t._a.pause(); // html5 has no stop()\r\n            _t.playState = 0;\r\n            _t._onTimer(); // and update UI\r\n            _stop_html5_timer();\r\n            _t.unload();\r\n          }\r\n        }\r\n        _t.instanceCount = 0;\r\n        _t._iO = {};\r\n      }\r\n      return _t;\r\n    };\r\n\r\n    this.setAutoPlay = function (autoPlay) {\r\n      _s._wD('sound '+_t.sID+' turned autoplay ' + (autoPlay ? 'on' : 'off'));\r\n      _t._iO.autoPlay = autoPlay;\r\n      if (!_t.isHTML5) {\r\n        _s.o._setAutoPlay(_t.sID, autoPlay);\r\n        if (autoPlay) {\r\n          // only increment the instanceCount if the sound isn't loaded (TODO: verify RTMP)\r\n          if (!_t.instanceCount && _t.readyState === 1) {\r\n            _t.instanceCount++;\r\n            _s._wD('sound '+_t.sID+' incremented instance count to '+_t.instanceCount);\r\n          }\r\n        }\r\n      }\r\n    };\r\n\r\n    this.getAutoPlay = function () {\r\n      return _t._iO.autoPlay;\r\n    };\r\n\r\n    this.setPosition = function (nMsecOffset) {\r\n      if (nMsecOffset === undefined) {\r\n        nMsecOffset = 0;\r\n      }\r\n      // Use the duration from the instance options, if we don't have a track duration yet.\r\n      var original_pos, position, position1K,\r\n          offset = (_t.isHTML5 ? Math.max(nMsecOffset,0) : Math.min(_t.duration || _t._iO.duration, Math.max(nMsecOffset, 0))); // position >= 0 and <= current available (loaded) duration\r\n      original_pos = _t.position;\r\n      _t.position = offset;\r\n      position1K = _t.position/1000;\r\n      _t.resetOnPosition(_t.position);\r\n      _t._iO.position = offset;\r\n      if (!_t.isHTML5) {\r\n        position = (_fV === 9 ? _t.position : position1K);\r\n        if (_t.readyState && _t.readyState !== 2) {\r\n          _s.o._setPosition(_t.sID, position, (_t.paused || !_t.playState)); // if paused or not playing, will not resume (by playing)\r\n        }\r\n      } else if (_t._a) {\r\n        // Set the position in the canplay handler if the sound is not ready yet\r\n        if (_t._html5_canplay) {\r\n          if (_t._a.currentTime !== position1K) {\r\n            /*\r\n             * DOM/JS errors/exceptions to watch out for:\r\n             * if seek is beyond (loaded?) position, \"DOM exception 11\"\r\n             * \"INDEX_SIZE_ERR\": DOM exception 1\r\n            */\r\n            _s._wD('setPosition('+position1K+'): setting position');\r\n            try {\r\n              _t._a.currentTime = position1K;\r\n              if (_t.playState === 0 || _t.paused) {\r\n                // allow seek without auto-play/resume\r\n                _t._a.pause();\r\n              }\r\n            } catch(e) {\r\n              _s._wD('setPosition('+position1K+'): setting position failed: '+e.message, 2);\r\n            }\r\n          }\r\n        } else {\r\n          _s._wD('setPosition('+position1K+'): delaying, sound not ready');\r\n        }\r\n      }\r\n      if (_t.isHTML5) {\r\n        if (_t.paused) { // if paused, refresh UI right away\r\n          _t._onTimer(true); // force update\r\n        }\r\n      }\r\n      return _t;\r\n    };\r\n\r\n    this.pause = function (bCallFlash) {\r\n      if (_t.paused || (_t.playState === 0 && _t.readyState !== 1)) {\r\n        return _t;\r\n      }\r\n      _s._wD('SMSound.pause()');\r\n      _t.paused = true;\r\n      if (!_t.isHTML5) {\r\n        if (bCallFlash || bCallFlash === undefined) {\r\n          _s.o._pause(_t.sID);\r\n        }\r\n      } else {\r\n        _t._setup_html5().pause();\r\n        _stop_html5_timer();\r\n      }\r\n      if (_t._iO.onpause) {\r\n        _t._iO.onpause.apply(_t);\r\n      }\r\n      return _t;\r\n    };\r\n\r\n    /*\r\n     * When auto-loaded streams pause on buffer full they have a playState of 0.\r\n     * We need to make sure that the playState is set to 1 when these streams \"resume\".\r\n     * When a paused stream is resumed, we need to trigger the onplay() callback if it\r\n     * hasn't been called already. In this case since the sound is being played for the\r\n     * first time, I think it's more appropriate to call onplay() rather than onresume().\r\n    */\r\n    this.resume = function () {\r\n      if (!_t.paused) {\r\n        return _t;\r\n      }\r\n      _s._wD('SMSound.resume()');\r\n      _t.paused = false;\r\n      _t.playState = 1;\r\n      if (!_t.isHTML5) {\r\n        if (_t._iO.isMovieStar) {\r\n          // Bizarre Webkit bug (Chrome reported via 8tracks.com dudes): AAC content paused for 30+ seconds(?) will not resume without a reposition.\r\n          _t.setPosition(_t.position);\r\n        }\r\n        _s.o._pause(_t.sID); // flash method is toggle-based (pause/resume)\r\n      } else {\r\n        _t._setup_html5().play();\r\n        _start_html5_timer();\r\n      }\r\n      if (!_t._onplay_called && _t._iO.onplay) {\r\n        _t._iO.onplay.apply(_t);\r\n        _t._onplay_called = true;\r\n      } else if (_t._iO.onresume) {\r\n        _t._iO.onresume.apply(_t);\r\n      }\r\n      return _t;\r\n    };\r\n\r\n    this.togglePause = function () {\r\n      _s._wD('SMSound.togglePause()');\r\n      if (_t.playState === 0) {\r\n        _t.play({\r\n          position: (_fV === 9 && !_t.isHTML5 ? _t.position : _t.position / 1000)\r\n        });\r\n        return _t;\r\n      }\r\n      if (_t.paused) {\r\n        _t.resume();\r\n      } else {\r\n        _t.pause();\r\n      }\r\n      return _t;\r\n    };\r\n\r\n    this.setPan = function (nPan, bInstanceOnly) {\r\n      if (typeof nPan === 'undefined') {\r\n        nPan = 0;\r\n      }\r\n      if (typeof bInstanceOnly === 'undefined') {\r\n        bInstanceOnly = false;\r\n      }\r\n      if (!_t.isHTML5) {\r\n        _s.o._setPan(_t.sID, nPan);\r\n      } // else { no HTML5 pan? }\r\n      _t._iO.pan = nPan;\r\n      if (!bInstanceOnly) {\r\n        _t.pan = nPan;\r\n        _t.options.pan = nPan;\r\n      }\r\n      return _t;\r\n    };\r\n\r\n    this.setVolume = function (nVol, bInstanceOnly) {\r\n      if (typeof nVol === 'undefined') {\r\n        nVol = 100;\r\n      }\r\n      if (typeof bInstanceOnly === 'undefined') {\r\n        bInstanceOnly = false;\r\n      }\r\n      if (!_t.isHTML5) {\r\n        _s.o._setVolume(_t.sID, (_s.muted && !_t.muted) || _t.muted?0:nVol);\r\n      } else if (_t._a) {\r\n        _t._a.volume = Math.max(0, Math.min(1, nVol/100)); // valid range: 0-1\r\n      }\r\n      _t._iO.volume = nVol;\r\n      if (!bInstanceOnly) {\r\n        _t.volume = nVol;\r\n        _t.options.volume = nVol;\r\n      }\r\n      return _t;\r\n    };\r\n\r\n    this.mute = function () {\r\n      _t.muted = true;\r\n      if (!_t.isHTML5) {\r\n        _s.o._setVolume(_t.sID, 0);\r\n      } else if (_t._a) {\r\n        _t._a.muted = true;\r\n      }\r\n      return _t;\r\n    };\r\n\r\n    this.unmute = function () {\r\n      _t.muted = false;\r\n      var hasIO = typeof _t._iO.volume !== 'undefined';\r\n      if (!_t.isHTML5) {\r\n        _s.o._setVolume(_t.sID, hasIO?_t._iO.volume:_t.options.volume);\r\n      } else if (_t._a) {\r\n        _t._a.muted = false;\r\n      }\r\n      return _t;\r\n    };\r\n\r\n    this.toggleMute = function () {\r\n      return (_t.muted?_t.unmute():_t.mute());\r\n    };\r\n\r\n    this.onposition = function (nPosition, oMethod, oScope) {\r\n      // TODO: allow for ranges, too? eg. (nPosition instanceof Array)\r\n      _t._onPositionItems.push({\r\n        position: nPosition,\r\n        method: oMethod,\r\n        scope: (typeof oScope !== 'undefined'?oScope:_t),\r\n        fired: false\r\n      });\r\n      return _t;\r\n    };\r\n\r\n    this.processOnPosition = function () {\r\n      var i, item, j = _t._onPositionItems.length;\r\n      if (!j || !_t.playState || _t._onPositionFired >= j) {\r\n        return false;\r\n      }\r\n      for (i=j; i--;) {\r\n        item = _t._onPositionItems[i];\r\n        if (!item.fired && _t.position >= item.position) {\r\n          item.method.apply(item.scope,[item.position]);\r\n          item.fired = true;\r\n          _s._onPositionFired++;\r\n        }\r\n      }\r\n      return true;\r\n    };\r\n\r\n    this.resetOnPosition = function (nPosition) {\r\n      // reset \"fired\" for items interested in this position\r\n      var i, item, j = _t._onPositionItems.length;\r\n      if (!j) {\r\n        return false;\r\n      }\r\n      for (i=j; i--;) {\r\n        item = _t._onPositionItems[i];\r\n        if (item.fired && nPosition <= item.position) {\r\n          item.fired = false;\r\n          _s._onPositionFired--;\r\n        }\r\n      }\r\n      return true;\r\n    };\r\n\r\n    /*\r\n     * private internals\r\n    */\r\n\r\n    _start_html5_timer = function () {\r\n      if (_t.isHTML5) {\r\n        _startTimer(_t);\r\n      }\r\n    };\r\n\r\n    _stop_html5_timer = function () {\r\n      if (_t.isHTML5) {\r\n        _stopTimer(_t);\r\n      }\r\n    };\r\n\r\n    _resetProperties = function () {\r\n      _t._onPositionItems = [];\r\n      _t._onPositionFired = 0;\r\n      _t._hasTimer = null;\r\n      _t._onplay_called = false;\r\n      _t._a = null;\r\n      _t._html5_canplay = false;\r\n      _t.bytesLoaded = null;\r\n      _t.bytesTotal = null;\r\n      _t.position = null;\r\n      _t.duration = (_t._iO && _t._iO.duration?_t._iO.duration:null);\r\n      _t.durationEstimate = null;\r\n      _t.failures = 0;\r\n      _t.loaded = false;\r\n      _t.playState = 0;\r\n      _t.paused = false;\r\n      _t.readyState = 0; // 0 = uninitialised, 1 = loading, 2 = failed/error, 3 = loaded/success\r\n      _t.muted = false;\r\n      _t.didBeforeFinish = false;\r\n      _t.didJustBeforeFinish = false;\r\n      _t.isBuffering = false;\r\n      _t.instanceOptions = {};\r\n      _t.instanceCount = 0;\r\n      _t.peakData = {\r\n        left: 0,\r\n        right: 0\r\n      };\r\n      _t.waveformData = {\r\n        left: [],\r\n        right: []\r\n      };\r\n      _t.eqData = []; // legacy: 1D array\r\n      _t.eqData.left = [];\r\n      _t.eqData.right = [];\r\n    };\r\n\r\n    _resetProperties();\r\n\r\n    /*\r\n     * pseudo-private SMSound internals\r\n    */\r\n\r\n    this._onTimer = function (bForce) {\r\n      // HTML5-only _whileplaying() etc.\r\n      var time, x = {};\r\n      if (_t._hasTimer || bForce) {\r\n        if (_t._a && (bForce || ((_t.playState > 0 || _t.readyState === 1) && !_t.paused))) { // TODO: May not need to track readyState (1 = loading)\r\n          _t.duration = _t._get_html5_duration();\r\n          _t.durationEstimate = _t.duration;\r\n          time = _t._a.currentTime?_t._a.currentTime*1000:0;\r\n          _t._whileplaying(time,x,x,x,x);\r\n          return true;\r\n        } else {\r\n         _s._wD('_onTimer: Warn for \"'+_t.sID+'\": '+(!_t._a?'Could not find element. ':'')+(_t.playState === 0?'playState bad, 0?':'playState = '+_t.playState+', OK'));\r\n          return false;\r\n        }\r\n      }\r\n    };\r\n\r\n    this._get_html5_duration = function () {\r\n      var d = (_t._a ? _t._a.duration*1000 : (_t._iO ? _t._iO.duration : undefined)),\r\n          result = (d && !isNaN(d) && d !== Infinity ? d : (_t._iO ? _t._iO.duration : null));\r\n      return result;\r\n    };\r\n\r\n    this._setup_html5 = function (oOptions) {\r\n      var _iO = _mixin(_t._iO, oOptions), d = decodeURI,\r\n          _a = _useGlobalHTML5Audio ? _s._global_a : _t._a,\r\n          _dURL = d(_iO.url),\r\n          _oldIO = (_a && _a._t ? _a._t.instanceOptions : null);\r\n      if (_a) {\r\n        if (_a._t && _oldIO.url === _iO.url && (!_t._lastURL || (_t._lastURL === _oldIO.url))) {\r\n          return _a; // same url, ignore request\r\n        }\r\n        _s._wD('setting new URL on existing object: ' + _dURL + (_t._lastURL ? ', old URL: ' + _t._lastURL : ''));\r\n        /*\r\n         * \"First things first, I, Poppa..\" (reset the previous state of the old sound, if playing)\r\n         * Fixes case with devices that can only play one sound at a time\r\n         * Otherwise, other sounds in mid-play will be terminated without warning and in a stuck state\r\n        */\r\n        if (_useGlobalHTML5Audio && _a._t && _a._t.playState && _iO.url !== _oldIO.url) {\r\n          _a._t.stop();\r\n        }\r\n        _resetProperties(); // new URL, so reset load/playstate and so on\r\n        _a.src = _iO.url;\r\n        _t.url = _iO.url;\r\n        _t._lastURL = _iO.url;\r\n        _a._called_load = false;\r\n      } else {\r\n        _s._wD('creating HTML5 Audio() element with URL: '+_dURL);\r\n        _a = new Audio(_iO.url);\r\n        _a._called_load = false;\r\n        if (_useGlobalHTML5Audio) {\r\n          _s._global_a = _a;\r\n        }\r\n      }\r\n      _t.isHTML5 = true;\r\n      _t._a = _a; // store a ref on the track\r\n      _a._t = _t; // store a ref on the audio\r\n      _t._add_html5_events();\r\n      _a.loop = (_iO.loops>1?'loop':'');\r\n      if (_iO.autoLoad || _iO.autoPlay) {\r\n        _a.autobuffer = 'auto'; // early HTML5 implementation (non-standard)\r\n        _a.preload = 'auto'; // standard\r\n        _t.load();\r\n        _a._called_load = true;\r\n      } else {\r\n        _a.autobuffer = false; // early HTML5 implementation (non-standard)\r\n        _a.preload = 'none'; // standard\r\n      }\r\n      _a.loop = (_iO.loops>1?'loop':''); // boolean instead of \"loop\", for webkit? - spec says string. http://www.w3.org/TR/html-markup/audio.html#audio.attrs.loop\r\n      return _a;\r\n    };\r\n\r\n    this._add_html5_events = function () {\r\n\r\n      if (_t._a._added_events) {\r\n        return false;\r\n      }\r\n\r\n      var f;\r\n\r\n      function add(oEvt, oFn, bCapture) {\r\n        return _t._a ? _t._a.addEventListener(oEvt, oFn, bCapture||false) : null;\r\n      }\r\n\r\n      _s._wD(_h5+'adding event listeners: '+_t.sID);\r\n      _t._a._added_events = true;\r\n\r\n      for (f in _html5_events) {\r\n        if (_html5_events.hasOwnProperty(f)) {\r\n          add(f, _html5_events[f]);\r\n        }\r\n      }\r\n\r\n      return true;\r\n\r\n    };\r\n\r\n    this._remove_html5_events = function () {\r\n\r\n      // Remove event listeners\r\n\r\n      var f;\r\n\r\n      function remove(oEvt, oFn, bCapture) {\r\n        return (_t._a ? _t._a.removeEventListener(oEvt, oFn, bCapture||false) : null);\r\n      }\r\n\r\n      _s._wD(_h5+'removing event listeners: '+_t.sID);\r\n      _t._a._added_events = false;\r\n\r\n      for (f in _html5_events) {\r\n        if (_html5_events.hasOwnProperty(f)) {\r\n          remove(f, _html5_events[f]);\r\n        }\r\n      }\r\n\r\n    };\r\n\r\n    /*\r\n     * pseudo-private event internals\r\n    */\r\n\r\n    this._onload = function (nSuccess) {\r\n      var fN = 'SMSound._onload(): ', loadOK = (nSuccess?true:false);\r\n      _s._wD(fN + '\"' + _t.sID + '\"' + (loadOK?' loaded.':' failed to load? - ' + _t.url), (loadOK?1:2));\r\n      // <d>\r\n      if (!loadOK && !_t.isHTML5) {\r\n        if (_s.sandbox.noRemote === true) {\r\n          _s._wD(fN + _str('noNet'), 1);\r\n        }\r\n        if (_s.sandbox.noLocal === true) {\r\n          _s._wD(fN + _str('noLocal'), 1);\r\n        }\r\n      }\r\n      // </d>\r\n      _t.loaded = loadOK;\r\n      _t.readyState = loadOK?3:2;\r\n      _t._onbufferchange(0);\r\n      if (_t._iO.onload) {\r\n        _t._iO.onload.apply(_t, [loadOK]);\r\n      }\r\n      return true;\r\n    };\r\n\r\n    this._onbufferchange = function (nIsBuffering) {\r\n      var fN = 'SMSound._onbufferchange()';\r\n      if (_t.playState === 0) {\r\n        // ignore if not playing\r\n        return false;\r\n      }\r\n      if ((nIsBuffering && _t.isBuffering) || (!nIsBuffering && !_t.isBuffering)) {\r\n        return false;\r\n      }\r\n      _t.isBuffering = (nIsBuffering === 1);\r\n      if (_t._iO.onbufferchange) {\r\n        _s._wD(fN + ': ' + nIsBuffering);\r\n        _t._iO.onbufferchange.apply(_t);\r\n      }\r\n      return true;\r\n    };\r\n\r\n    /*\r\n     * flash-only method, should fire only once at most\r\n     * at this point we just recreate failed sounds rather than trying to reconnect\r\n    */\r\n    this._onfailure = function (msg, level, code) {\r\n      _t.failures++;\r\n      _s._wD('SMSound._onfailure(): \"'+_t.sID+'\" count '+_t.failures);\r\n      if (_t._iO.onfailure && _t.failures === 1) {\r\n        _t._iO.onfailure(_t, msg, level, code);\r\n      } else {\r\n        _s._wD('SMSound._onfailure(): ignoring');\r\n      }\r\n    };\r\n\r\n    this._onbeforefinish = function () {\r\n      if (!_t.didBeforeFinish) {\r\n        _t.didBeforeFinish = true;\r\n        if (_t._iO.onbeforefinish) {\r\n          _s._wD('SMSound._onbeforefinish(): \"' + _t.sID + '\"');\r\n          _t._iO.onbeforefinish.apply(_t);\r\n        }\r\n      }\r\n    };\r\n\r\n    this._onjustbeforefinish = function (msOffset) {\r\n      if (!_t.didJustBeforeFinish) {\r\n        _t.didJustBeforeFinish = true;\r\n        if (_t._iO.onjustbeforefinish) {\r\n          _s._wD('SMSound._onjustbeforefinish(): \"' + _t.sID + '\"');\r\n          _t._iO.onjustbeforefinish.apply(_t);\r\n        }\r\n      }\r\n    };\r\n\r\n    this._onfinish = function () {\r\n      var _io_onfinish = _t._iO.onfinish; // store local copy before it gets trashed..\r\n      _t._onbufferchange(0);\r\n      _t.resetOnPosition(0);\r\n      if (_t._iO.onbeforefinishcomplete) {\r\n        _t._iO.onbeforefinishcomplete.apply(_t);\r\n      }\r\n      // reset some state items\r\n      _t.didBeforeFinish = false;\r\n      _t.didJustBeforeFinish = false;\r\n      if (_t.instanceCount) {\r\n        _t.instanceCount--;\r\n        if (!_t.instanceCount) {\r\n          // reset instance options\r\n          _t.playState = 0;\r\n          _t.paused = false;\r\n          _t.instanceCount = 0;\r\n          _t.instanceOptions = {};\r\n          _t._iO = {};\r\n          _stop_html5_timer();\r\n        }\r\n        if (!_t.instanceCount || _t._iO.multiShotEvents) {\r\n          // fire onfinish for last, or every instance\r\n          if (_io_onfinish) {\r\n            _s._wD('SMSound._onfinish(): \"' + _t.sID + '\"');\r\n            _io_onfinish.apply(_t);\r\n          }\r\n        }\r\n      }\r\n    };\r\n\r\n    this._whileloading = function (nBytesLoaded, nBytesTotal, nDuration, nBufferLength) {\r\n      _t.bytesLoaded = nBytesLoaded;\r\n      _t.bytesTotal = nBytesTotal;\r\n      _t.duration = Math.floor(nDuration);\r\n      _t.bufferLength = nBufferLength;\r\n      if (!_t._iO.isMovieStar) {\r\n        if (_t._iO.duration) {\r\n          // use options, if specified and larger\r\n          _t.durationEstimate = (_t.duration > _t._iO.duration) ? _t.duration : _t._iO.duration;\r\n        } else {\r\n          _t.durationEstimate = parseInt((_t.bytesTotal / _t.bytesLoaded) * _t.duration, 10);\r\n        }\r\n        if (_t.durationEstimate === undefined) {\r\n          _t.durationEstimate = _t.duration;\r\n        }\r\n        if (_t.readyState !== 3 && _t._iO.whileloading) {\r\n          _t._iO.whileloading.apply(_t);\r\n        }\r\n      } else {\r\n        _t.durationEstimate = _t.duration;\r\n        if (_t.readyState !== 3 && _t._iO.whileloading) {\r\n          _t._iO.whileloading.apply(_t);\r\n        }\r\n      }\r\n    };\r\n\r\n    this._whileplaying = function (nPosition, oPeakData, oWaveformDataLeft, oWaveformDataRight, oEQData) {\r\n      if (isNaN(nPosition) || nPosition === null) {\r\n        return false; // flash safety net\r\n      }\r\n      _t.position = nPosition;\r\n      _t.processOnPosition();\r\n      if (!_t.isHTML5 && _fV > 8) {\r\n        if (_t._iO.usePeakData && typeof oPeakData !== 'undefined' && oPeakData) {\r\n          _t.peakData = {\r\n            left: oPeakData.leftPeak,\r\n            right: oPeakData.rightPeak\r\n          };\r\n        }\r\n        if (_t._iO.useWaveformData && typeof oWaveformDataLeft !== 'undefined' && oWaveformDataLeft) {\r\n          _t.waveformData = {\r\n            left: oWaveformDataLeft.split(','),\r\n            right: oWaveformDataRight.split(',')\r\n          };\r\n        }\r\n        if (_t._iO.useEQData) {\r\n          if (typeof oEQData !== 'undefined' && oEQData && oEQData.leftEQ) {\r\n            var eqLeft = oEQData.leftEQ.split(',');\r\n            _t.eqData = eqLeft;\r\n            _t.eqData.left = eqLeft;\r\n            if (typeof oEQData.rightEQ !== 'undefined' && oEQData.rightEQ) {\r\n              _t.eqData.right = oEQData.rightEQ.split(',');\r\n            }\r\n          }\r\n        }\r\n      }\r\n      if (_t.playState === 1) {\r\n        // special case/hack: ensure buffering is false if loading from cache (and not yet started)\r\n        if (!_t.isHTML5 && _s.flashVersion === 8 && !_t.position && _t.isBuffering) {\r\n          _t._onbufferchange(0);\r\n        }\r\n        if (_t._iO.whileplaying) {\r\n          _t._iO.whileplaying.apply(_t); // flash may call after actual finish\r\n        }\r\n        if ((_t.loaded || (!_t.loaded && _t._iO.isMovieStar)) && _t._iO.onbeforefinish && _t._iO.onbeforefinishtime && !_t.didBeforeFinish && _t.duration - _t.position <= _t._iO.onbeforefinishtime) {\r\n          _t._onbeforefinish();\r\n        }\r\n      }\r\n      return true;\r\n    };\r\n\r\n    this._onid3 = function (oID3PropNames, oID3Data) {\r\n      // oID3PropNames: string array (names)\r\n      // ID3Data: string array (data)\r\n      _s._wD('SMSound._onid3(): \"' + this.sID + '\" ID3 data received.');\r\n      var oData = [], i, j;\r\n      for (i = 0, j = oID3PropNames.length; i < j; i++) {\r\n        oData[oID3PropNames[i]] = oID3Data[i];\r\n      }\r\n      _t.id3 = _mixin(_t.id3, oData);\r\n      if (_t._iO.onid3) {\r\n        _t._iO.onid3.apply(_t);\r\n      }\r\n    };\r\n\r\n    // flash + RTMP\r\n    this._onconnect = function (bSuccess) {\r\n      var fN = 'SMSound._onconnect(): ';\r\n      bSuccess = (bSuccess === 1);\r\n      _s._wD(fN+'\"'+_t.sID+'\"'+(bSuccess?' connected.':' failed to connect? - '+_t.url), (bSuccess?1:2));\r\n      _t.connected = bSuccess;\r\n      if (bSuccess) {\r\n        _t.failures = 0;\r\n        if (_idCheck(_t.sID)) {\r\n          if (_t.getAutoPlay()) {\r\n            _t.play(undefined, _t.getAutoPlay()); // only update the play state if auto playing\r\n          } else if (_t._iO.autoLoad) {\r\n            _t.load();\r\n          }\r\n        }\r\n        if (_t._iO.onconnect) {\r\n          _t._iO.onconnect.apply(_t,[bSuccess]);\r\n        }\r\n      }\r\n    };\r\n\r\n    this._ondataerror = function (sError) {\r\n      // flash 9 wave/eq data handler\r\n      if (_t.playState > 0) { // hack: called at start, and end from flash at/after onfinish()\r\n        _s._wD('SMSound._ondataerror(): ' + sError);\r\n        if (_t._iO.ondataerror) {\r\n          _t._iO.ondataerror.apply(_t);\r\n        }\r\n      }\r\n    };\r\n\r\n  }; // SMSound()\r\n\r\n  /*\r\n   * private soundManager internals\r\n  */\r\n\r\n  _getDocument = function () {\r\n    return (_doc.body || _doc._docElement || _doc.getElementsByTagName('div')[0]);\r\n  };\r\n\r\n  _id = function (sID) {\r\n    return _doc.getElementById(sID);\r\n  };\r\n\r\n  _mixin = function (oMain, oAdd) {\r\n    // non-destructive merge\r\n    var o1 = {}, i, o2, o;\r\n    for (i in oMain) { // clone c1\r\n      if (oMain.hasOwnProperty(i)) {\r\n        o1[i] = oMain[i];\r\n      }\r\n    }\r\n    o2 = (typeof oAdd === 'undefined'?_s.defaultOptions:oAdd);\r\n    for (o in o2) {\r\n      if (o2.hasOwnProperty(o) && typeof o1[o] === 'undefined') {\r\n        o1[o] = o2[o];\r\n      }\r\n    }\r\n    return o1;\r\n  };\r\n\r\n  _event = (function () {\r\n\r\n    var old = (_win.attachEvent),\r\n    evt = {\r\n      add: (old?'attachEvent':'addEventListener'),\r\n      remove: (old?'detachEvent':'removeEventListener')\r\n    };\r\n\r\n    function getArgs(oArgs) {\r\n      var args = _slice.call(oArgs), len = args.length;\r\n      if (old) {\r\n        args[1] = 'on' + args[1]; // prefix\r\n        if (len > 3) {\r\n          args.pop(); // no capture\r\n        }\r\n      } else if (len === 3) {\r\n        args.push(false);\r\n      }\r\n      return args;\r\n    }\r\n\r\n    function apply(args, sType) {\r\n      var element = args.shift(),\r\n          method = [evt[sType]];\r\n      if (old) {\r\n        element[method](args[0], args[1]);\r\n      } else {\r\n        element[method].apply(element, args);\r\n      }\r\n    }\r\n\r\n    function add() {\r\n      apply(getArgs(arguments), 'add');\r\n    }\r\n\r\n    function remove() {\r\n      apply(getArgs(arguments), 'remove');\r\n    }\r\n\r\n    return {\r\n      'add': add,\r\n      'remove': remove\r\n    };\r\n\r\n  }());\r\n\r\n  _html5OK = function (iO) {\r\n    return (!iO.serverURL && (iO.type?_html5CanPlay({type:iO.type}):_html5CanPlay({url:iO.url})||_s.html5Only)); // Use type, if specified. If HTML5-only mode, no other options, so just give 'er\r\n  };\r\n\r\n  _html5CanPlay = function (o) {\r\n\r\n    /*\r\n     * try to find MIME, test and return truthiness\r\n     * o = {\r\n     *  url: '/path/to/an.mp3',\r\n     *  type: 'audio/mp3'\r\n     * }\r\n    */\r\n\r\n    if (!_s.useHTML5Audio || !_s.hasHTML5) {\r\n      return false;\r\n    }\r\n\r\n    var url = (o.url || null),\r\n        mime = (o.type || null),\r\n        aF = _s.audioFormats,\r\n        result,\r\n        offset,\r\n        fileExt,\r\n        item;\r\n\r\n    function preferFlashCheck(kind) {\r\n      // whether flash should play a given type\r\n      return (_s.preferFlash && _hasFlash && !_s.ignoreFlash && (typeof _s.flash[kind] !== 'undefined' && _s.flash[kind]));\r\n    }\r\n\r\n    // account for known cases like audio/mp3\r\n    if (mime && _s.html5[mime] !== 'undefined') {\r\n      return (_s.html5[mime] && !preferFlashCheck(mime));\r\n    }\r\n\r\n    if (!_html5Ext) {\r\n      _html5Ext = [];\r\n      for (item in aF) {\r\n        if (aF.hasOwnProperty(item)) {\r\n          _html5Ext.push(item);\r\n          if (aF[item].related) {\r\n            _html5Ext = _html5Ext.concat(aF[item].related);\r\n          }\r\n        }\r\n      }\r\n      _html5Ext = new RegExp('\\\\.('+_html5Ext.join('|')+')(\\\\?.*)?$','i');\r\n    }\r\n\r\n    fileExt = (url ? url.toLowerCase().match(_html5Ext) : null); // TODO: Strip URL queries, etc.\r\n\r\n    if (!fileExt || !fileExt.length) {\r\n      if (!mime) {\r\n        return false;\r\n      } else {\r\n        // audio/mp3 -> mp3, result should be known\r\n        offset = mime.indexOf(';');\r\n        fileExt = (offset !== -1?mime.substr(0,offset):mime).substr(6); // strip \"audio/X; codecs..\"\r\n      }\r\n    } else {\r\n      fileExt = fileExt[1]; // match the raw extension name - \"mp3\", for example\r\n    }\r\n\r\n    if (fileExt && typeof _s.html5[fileExt] !== 'undefined') {\r\n      // result known\r\n      return (_s.html5[fileExt] && !preferFlashCheck(fileExt));\r\n    } else {\r\n      mime = 'audio/'+fileExt;\r\n      result = _s.html5.canPlayType({type:mime});\r\n      _s.html5[fileExt] = result;\r\n      // _s._wD('canPlayType, found result: '+result);\r\n      return (result && _s.html5[mime] && !preferFlashCheck(mime));\r\n    }\r\n\r\n  };\r\n\r\n  _testHTML5 = function () {\r\n\r\n    if (!_s.useHTML5Audio || typeof Audio === 'undefined') {\r\n      return false;\r\n    }\r\n\r\n    // double-whammy: Opera 9.64 throws WRONG_ARGUMENTS_ERR if no parameter passed to Audio(), and Webkit + iOS happily tries to load \"null\" as a URL. :/\r\n    var a = (typeof Audio !== 'undefined' ? (_isOpera ? new Audio(null) : new Audio()) : null),\r\n        item, support = {}, aF, i;\r\n\r\n    function _cp(m) {\r\n      var canPlay, i, j, isOK = false;\r\n      if (!a || typeof a.canPlayType !== 'function') {\r\n        return false;\r\n      }\r\n      if (m instanceof Array) {\r\n        // iterate through all mime types, return any successes\r\n        for (i=0, j=m.length; i<j && !isOK; i++) {\r\n          if (_s.html5[m[i]] || a.canPlayType(m[i]).match(_s.html5Test)) {\r\n            isOK = true;\r\n            _s.html5[m[i]] = true;\r\n            // if flash can play and preferred, also mark it for use.\r\n            _s.flash[m[i]] = !!(_s.preferFlash && _hasFlash && m[i].match(_flashMIME));\r\n          }\r\n        }\r\n        return isOK;\r\n      } else {\r\n        canPlay = (a && typeof a.canPlayType === 'function' ? a.canPlayType(m) : false);\r\n        return !!(canPlay && (canPlay.match(_s.html5Test)));\r\n      }\r\n    }\r\n\r\n    // test all registered formats + codecs\r\n    aF = _s.audioFormats;\r\n    for (item in aF) {\r\n      if (aF.hasOwnProperty(item)) {\r\n        support[item] = _cp(aF[item].type);\r\n        support['audio/'+item] = support[item]; // write back generic type too, eg. audio/mp3\r\n        // assign flash\r\n        if (_s.preferFlash && !_s.ignoreFlash && item.match(_flashMIME)) {\r\n          _s.flash[item] = true;\r\n        } else {\r\n          _s.flash[item] = false;\r\n        }\r\n        // assign result to related formats, too\r\n        if (aF[item] && aF[item].related) {\r\n          for (i=aF[item].related.length; i--;) {\r\n            support['audio/'+aF[item].related[i]] = support[item]; // eg. audio/m4a\r\n            _s.html5[aF[item].related[i]] = support[item];\r\n            _s.flash[aF[item].related[i]] = support[item];\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    support.canPlayType = (a?_cp:null);\r\n    _s.html5 = _mixin(_s.html5, support);\r\n    return true;\r\n\r\n  };\r\n\r\n  _strings = {\r\n    // <d>\r\n    notReady: 'Not loaded yet - wait for soundManager.onload()/onready()',\r\n    notOK: 'Audio support is not available.',\r\n    domError: _smc + 'createMovie(): appendChild/innerHTML call failed. DOM not ready or other error.',\r\n    spcWmode: _smc + 'createMovie(): Removing wmode, preventing known SWF loading issue(s)',\r\n    swf404: _sm + ': Verify that %s is a valid path.',\r\n    tryDebug: 'Try ' + _sm + '.debugFlash = true for more security details (output goes to SWF.)',\r\n    checkSWF: 'See SWF output for more debug info.',\r\n    localFail: _sm + ': Non-HTTP page (' + _doc.location.protocol + ' URL?) Review Flash player security settings for this special case:\\nhttp://www.macromedia.com/support/documentation/en/flashplayer/help/settings_manager04.html\\nMay need to add/allow path, eg. c:/sm2/ or /users/me/sm2/',\r\n    waitFocus: _sm + ': Special case: Waiting for focus-related event..',\r\n    waitImpatient: _sm + ': Getting impatient, still waiting for Flash%s...',\r\n    waitForever: _sm + ': Waiting indefinitely for Flash (will recover if unblocked)...',\r\n    needFunction: _sm + ': Function object expected for %s',\r\n    badID: 'Warning: Sound ID \"%s\" should be a string, starting with a non-numeric character',\r\n    noMS: 'MovieStar mode not enabled. Exiting.',\r\n    currentObj: '--- ' + _sm + '._debug(): Current sound objects ---',\r\n    waitEI: _smc + 'initMovie(): Waiting for ExternalInterface call from Flash..',\r\n    waitOnload: _sm + ': Waiting for window.onload()',\r\n    docLoaded: _sm + ': Document already loaded',\r\n    onload: _smc + 'initComplete(): calling soundManager.onload()',\r\n    onloadOK: _sm + '.onload() complete',\r\n    init: _smc + 'init()',\r\n    didInit: _smc + 'init(): Already called?',\r\n    flashJS: _sm + ': Attempting to call Flash from JS..',\r\n    noPolling: _sm + ': Polling (whileloading()/whileplaying() support) is disabled.',\r\n    secNote: 'Flash security note: Network/internet URLs will not load due to security restrictions. Access can be configured via Flash Player Global Security Settings Page: http://www.macromedia.com/support/documentation/en/flashplayer/help/settings_manager04.html',\r\n    badRemove: 'Warning: Failed to remove flash movie.',\r\n    noPeak: 'Warning: peakData features unsupported for movieStar formats',\r\n    shutdown: _sm + '.disable(): Shutting down',\r\n    queue: _sm + ': Queueing %s handler',\r\n    smFail: _sm + ': Failed to initialise.',\r\n    smError: 'SMSound.load(): Exception: JS-Flash communication failed, or JS error.',\r\n    fbTimeout: 'No flash response, applying .'+_s.swfCSS.swfTimedout+' CSS..',\r\n    fbLoaded: 'Flash loaded',\r\n    fbHandler: _smc+'flashBlockHandler()',\r\n    manURL: 'SMSound.load(): Using manually-assigned URL',\r\n    onURL: _sm + '.load(): current URL already assigned.',\r\n    badFV: _sm + '.flashVersion must be 8 or 9. \"%s\" is invalid. Reverting to %s.',\r\n    as2loop: 'Note: Setting stream:false so looping can work (flash 8 limitation)',\r\n    noNSLoop: 'Note: Looping not implemented for MovieStar formats',\r\n    needfl9: 'Note: Switching to flash 9, required for MP4 formats.',\r\n    mfTimeout: 'Setting flashLoadTimeout = 0 (infinite) for off-screen, mobile flash case',\r\n    mfOn: 'mobileFlash::enabling on-screen flash repositioning',\r\n    policy: 'Enabling usePolicyFile for data access'\r\n    // </d>\r\n  };\r\n\r\n  _str = function () { // o [,items to replace]\r\n    // <d>\r\n    var args = _slice.call(arguments), // real array, please\r\n    o = args.shift(), // first arg\r\n    str = (_strings && _strings[o]?_strings[o]:''), i, j;\r\n    if (str && args && args.length) {\r\n      for (i = 0, j = args.length; i < j; i++) {\r\n        str = str.replace('%s', args[i]);\r\n      }\r\n    }\r\n    return str;\r\n    // </d>\r\n  };\r\n\r\n  _loopFix = function (sOpt) {\r\n    // flash 8 requires stream = false for looping to work\r\n    if (_fV === 8 && sOpt.loops > 1 && sOpt.stream) {\r\n      _wDS('as2loop');\r\n      sOpt.stream = false;\r\n    }\r\n    return sOpt;\r\n  };\r\n\r\n  _policyFix = function (sOpt, sPre) {\r\n    if (sOpt && !sOpt.usePolicyFile && (sOpt.onid3 || sOpt.usePeakData || sOpt.useWaveformData || sOpt.useEQData)) {\r\n      _s._wD((sPre || '') + _str('policy'));\r\n      sOpt.usePolicyFile = true;\r\n    }\r\n    return sOpt;\r\n  };\r\n\r\n  _complain = function (sMsg) {\r\n    if (typeof console !== 'undefined' && typeof console.warn !== 'undefined') {\r\n      console.warn(sMsg);\r\n    } else {\r\n      _s._wD(sMsg);\r\n    }\r\n  };\r\n\r\n  _doNothing = function () {\r\n    return false;\r\n  };\r\n\r\n  _disableObject = function (o) {\r\n    var oProp;\r\n    for (oProp in o) {\r\n      if (o.hasOwnProperty(oProp) && typeof o[oProp] === 'function') {\r\n        o[oProp] = _doNothing;\r\n      }\r\n    }\r\n    oProp = null;\r\n  };\r\n\r\n  _failSafely = function (bNoDisable) {\r\n    // general failure exception handler\r\n    if (typeof bNoDisable === 'undefined') {\r\n      bNoDisable = false;\r\n    }\r\n    if (_disabled || bNoDisable) {\r\n      _wDS('smFail', 2);\r\n      _s.disable(bNoDisable);\r\n    }\r\n  };\r\n\r\n  _normalizeMovieURL = function (smURL) {\r\n    var urlParams = null;\r\n    if (smURL) {\r\n      if (smURL.match(/\\.swf(\\?.*)?$/i)) {\r\n        urlParams = smURL.substr(smURL.toLowerCase().lastIndexOf('.swf?') + 4);\r\n        if (urlParams) {\r\n          return smURL; // assume user knows what they're doing\r\n        }\r\n      } else if (smURL.lastIndexOf('/') !== smURL.length - 1) {\r\n        smURL = smURL + '/';\r\n      }\r\n    }\r\n    return (smURL && smURL.lastIndexOf('/') !== - 1?smURL.substr(0, smURL.lastIndexOf('/') + 1):'./') + _s.movieURL;\r\n  };\r\n\r\n  _setVersionInfo = function () {\r\n\r\n    if (_fV !== 8 && _fV !== 9) {\r\n      _s._wD(_str('badFV', _fV, _defaultFlashVersion));\r\n      _s.flashVersion = _defaultFlashVersion;\r\n    }\r\n    var isDebug = (_s.debugMode || _s.debugFlash?'_debug.swf':'.swf'); // debug flash movie, if applicable\r\n    if (_s.useHTML5Audio && !_s.html5Only && _s.audioFormats.mp4.required && _s.flashVersion < 9) {\r\n      _s._wD(_str('needfl9'));\r\n      _s.flashVersion = 9;\r\n    }\r\n    _fV = _s.flashVersion; // short-hand for internal use\r\n    _s.version = _s.versionNumber + (_s.html5Only?' (HTML5-only mode)':(_fV === 9?' (AS3/Flash 9)':' (AS2/Flash 8)'));\r\n    // set up default options\r\n    if (_fV > 8) {\r\n      _s.defaultOptions = _mixin(_s.defaultOptions, _s.flash9Options);\r\n      _s.features.buffering = true;\r\n    }\r\n    if (_fV > 8 && _s.useMovieStar) {\r\n      // flash 9+ support for movieStar formats as well as MP3\r\n      _s.defaultOptions = _mixin(_s.defaultOptions, _s.movieStarOptions);\r\n      _s.filePatterns.flash9 = new RegExp('\\\\.(mp3|' + _s.netStreamTypes.join('|') + ')(\\\\?.*)?$', 'i');\r\n      _s.mimePattern = _s.netStreamMimeTypes;\r\n      _s.features.movieStar = true;\r\n    } else {\r\n      _s.useMovieStar = false;\r\n      _s.features.movieStar = false;\r\n    }\r\n    _s.filePattern = _s.filePatterns[(_fV !== 8?'flash9':'flash8')];\r\n    _s.movieURL = (_fV === 8?'soundmanager2.swf':'soundmanager2_flash9.swf').replace('.swf',isDebug);\r\n    _s.features.peakData = _s.features.waveformData = _s.features.eqData = (_fV > 8);\r\n  };\r\n\r\n  _setPolling = function (bPolling, bHighPerformance) {\r\n    if (!_s.o || !_s.allowPolling) {\r\n      return false;\r\n    }\r\n    _s.o._setPolling(bPolling, bHighPerformance);\r\n  };\r\n\r\n  _initDebug = function () {\r\n    if (_s.debugURLParam.test(_wl)) {\r\n      _s.debugMode = true; // allow force of debug mode via URL\r\n    }\r\n    // <d>\r\n    if (_id(_s.debugID)) {\r\n      return false;\r\n    }\r\n    var oD, oDebug, oTarget, oToggle, tmp;\r\n    if (_s.debugMode && !_id(_s.debugID) && ((!_hasConsole || !_s.useConsole) || (_s.useConsole && _hasConsole && !_s.consoleOnly))) {\r\n      oD = _doc.createElement('div');\r\n      oD.id = _s.debugID + '-toggle';\r\n      oToggle = {\r\n        'position': 'fixed',\r\n        'bottom': '0px',\r\n        'right': '0px',\r\n        'width': '1.2em',\r\n        'height': '1.2em',\r\n        'lineHeight': '1.2em',\r\n        'margin': '2px',\r\n        'textAlign': 'center',\r\n        'border': '1px solid #999',\r\n        'cursor': 'pointer',\r\n        'background': '#fff',\r\n        'color': '#333',\r\n        'zIndex': 10001\r\n      };\r\n      oD.appendChild(_doc.createTextNode('-'));\r\n      oD.onclick = _toggleDebug;\r\n      oD.title = 'Toggle SM2 debug console';\r\n      if (_ua.match(/msie 6/i)) {\r\n        oD.style.position = 'absolute';\r\n        oD.style.cursor = 'hand';\r\n      }\r\n      for (tmp in oToggle) {\r\n        if (oToggle.hasOwnProperty(tmp)) {\r\n          oD.style[tmp] = oToggle[tmp];\r\n        }\r\n      }\r\n      oDebug = _doc.createElement('div');\r\n      oDebug.id = _s.debugID;\r\n      oDebug.style.display = (_s.debugMode?'block':'none');\r\n      if (_s.debugMode && !_id(oD.id)) {\r\n        try {\r\n          oTarget = _getDocument();\r\n          oTarget.appendChild(oD);\r\n        } catch(e2) {\r\n          throw new Error(_str('domError')+' \\n'+e2.toString());\r\n        }\r\n        oTarget.appendChild(oDebug);\r\n      }\r\n    }\r\n    oTarget = null;\r\n    // </d>\r\n  };\r\n\r\n  _idCheck = this.getSoundById;\r\n\r\n  // <d>\r\n  _wDS = function (o, errorLevel) {\r\n    if (!o) {\r\n      return '';\r\n    } else {\r\n      return _s._wD(_str(o), errorLevel);\r\n    }\r\n  };\r\n\r\n  // last-resort debugging option\r\n  if (_wl.indexOf('sm2-debug=alert') + 1 && _s.debugMode) {\r\n    _s._wD = function (sText) {window.alert(sText);};\r\n  }\r\n\r\n  _toggleDebug = function () {\r\n    var o = _id(_s.debugID),\r\n    oT = _id(_s.debugID + '-toggle');\r\n    if (!o) {\r\n      return false;\r\n    }\r\n    if (_debugOpen) {\r\n      // minimize\r\n      oT.innerHTML = '+';\r\n      o.style.display = 'none';\r\n    } else {\r\n      oT.innerHTML = '-';\r\n      o.style.display = 'block';\r\n    }\r\n    _debugOpen = !_debugOpen;\r\n  };\r\n\r\n  _debugTS = function (sEventType, bSuccess, sMessage) {\r\n    // troubleshooter debug hooks\r\n    if (typeof sm2Debugger !== 'undefined') {\r\n      try {\r\n        sm2Debugger.handleEvent(sEventType, bSuccess, sMessage);\r\n      } catch(e) {\r\n        // oh well\r\n      }\r\n    }\r\n    return true;\r\n  };\r\n  // </d>\r\n\r\n  _getSWFCSS = function () {\r\n    var css = [];\r\n    if (_s.debugMode) {\r\n      css.push(_s.swfCSS.sm2Debug);\r\n    }\r\n    if (_s.debugFlash) {\r\n      css.push(_s.swfCSS.flashDebug);\r\n    }\r\n    if (_s.useHighPerformance) {\r\n      css.push(_s.swfCSS.highPerf);\r\n    }\r\n    return css.join(' ');\r\n  };\r\n\r\n  _flashBlockHandler = function () {\r\n    // *possible* flash block situation.\r\n    var name = _str('fbHandler'),\r\n        p = _s.getMoviePercent(),\r\n        css = _s.swfCSS,\r\n        error = {type:'FLASHBLOCK'};\r\n    if (_s.html5Only) {\r\n      return false;\r\n    }\r\n    if (!_s.ok()) {\r\n      if (_needsFlash) {\r\n        // make the movie more visible, so user can fix\r\n        _s.oMC.className = _getSWFCSS() + ' ' + css.swfDefault + ' ' + (p === null?css.swfTimedout:css.swfError);\r\n        _s._wD(name+': '+_str('fbTimeout')+(p?' ('+_str('fbLoaded')+')':''));\r\n      }\r\n      _s.didFlashBlock = true;\r\n      _processOnEvents({type:'ontimeout', ignoreInit:true, error:error}); // fire onready(), complain lightly\r\n      _catchError(error);\r\n    } else {\r\n      // SM2 loaded OK (or recovered)\r\n      if (_s.didFlashBlock) {\r\n        _s._wD(name+': Unblocked');\r\n      }\r\n      if (_s.oMC) {\r\n        _s.oMC.className = [_getSWFCSS(), css.swfDefault, css.swfLoaded + (_s.didFlashBlock?' '+css.swfUnblocked:'')].join(' ');\r\n      }\r\n    }\r\n  };\r\n\r\n  _addOnEvent = function (sType, oMethod, oScope) {\r\n    if (typeof _on_queue[sType] === 'undefined') {\r\n      _on_queue[sType] = [];\r\n    }\r\n    _on_queue[sType].push({\r\n      'method': oMethod,\r\n      'scope': (oScope || null),\r\n      'fired': false\r\n    });\r\n  };\r\n\r\n  _processOnEvents = function (oOptions) {\r\n    if (!oOptions) { // assume onready, if unspecified\r\n      oOptions = {\r\n        type: 'onready'\r\n      };\r\n    }\r\n    if (!_didInit && oOptions && !oOptions.ignoreInit) {\r\n      // not ready yet.\r\n      return false;\r\n    }\r\n    if (oOptions.type === 'ontimeout' && _s.ok()) {\r\n      // invalid case\r\n      return false;\r\n    }\r\n    var status = {\r\n          success: (oOptions && oOptions.ignoreInit?_s.ok():!_disabled)\r\n        },\r\n        srcQueue = (oOptions && oOptions.type?_on_queue[oOptions.type]||[]:[]), // queue specified by type, or none\r\n        queue = [], i, j,\r\n        args = [status],\r\n        canRetry = (_needsFlash && _s.useFlashBlock && !_s.ok());\r\n    if (oOptions.error) {\r\n      args[0].error = oOptions.error;\r\n    }\r\n    for (i = 0, j = srcQueue.length; i < j; i++) {\r\n      if (srcQueue[i].fired !== true) {\r\n        queue.push(srcQueue[i]);\r\n      }\r\n    }\r\n    if (queue.length) {\r\n      _s._wD(_sm + ': Firing ' + queue.length + ' '+oOptions.type+'() item' + (queue.length === 1?'':'s'));\r\n      for (i = 0, j = queue.length; i < j; i++) {\r\n        if (queue[i].scope) {\r\n          queue[i].method.apply(queue[i].scope, args);\r\n        } else {\r\n          queue[i].method.apply(this, args);\r\n        }\r\n        if (!canRetry) { // flashblock case doesn't count here\r\n          queue[i].fired = true;\r\n        }\r\n      }\r\n    }\r\n    return true;\r\n  };\r\n\r\n  _initUserOnload = function () {\r\n    _win.setTimeout(function () {\r\n      if (_s.useFlashBlock) {\r\n        _flashBlockHandler();\r\n      }\r\n      _processOnEvents();\r\n      // call user-defined \"onload\", scoped to window\r\n      if (_s.onload instanceof Function) {\r\n        _wDS('onload', 1);\r\n        _s.onload.apply(_win);\r\n        _wDS('onloadOK', 1);\r\n      }\r\n      if (_s.waitForWindowLoad) {\r\n        _event.add(_win, 'load', _initUserOnload);\r\n      }\r\n    },1);\r\n  };\r\n\r\n  _detectFlash = function () {\r\n\r\n    // hat tip: Flash Detect library (BSD, (C) 2007) by Carl \"DocYes\" S. Yestrau - http://featureblend.com/javascript-flash-detection-library.html / http://featureblend.com/license.txt\r\n\r\n    if (_hasFlash !== undefined) {\r\n      // this work has already been done.\r\n      return _hasFlash;\r\n    }\r\n\r\n    var hasPlugin = false, n = navigator, nP = n.plugins, obj, type, types, AX = _win.ActiveXObject;\r\n\r\n    if (nP && nP.length) {\r\n\r\n      type = 'application/x-shockwave-flash';\r\n      types = n.mimeTypes;\r\n      if (types && types[type] && types[type].enabledPlugin && types[type].enabledPlugin.description) {\r\n        hasPlugin = true;\r\n      }\r\n\r\n    } else if (typeof AX !== 'undefined') {\r\n\r\n      try {\r\n        obj = new AX('ShockwaveFlash.ShockwaveFlash');\r\n      } catch(e) {\r\n        // oh well\r\n      }\r\n      hasPlugin = (!!obj);\r\n\r\n    }\r\n\r\n    _hasFlash = hasPlugin;\r\n\r\n    return hasPlugin;\r\n\r\n  };\r\n\r\n  _featureCheck = function () {\r\n\r\n    var needsFlash, item,\r\n        isSpecial = (_ua.match(/iphone os (1|2|3_0|3_1)/i)?true:false); // iPhone <= 3.1 has broken HTML5 audio(), but firmware 3.2 (iPad) + iOS4 works.\r\n\r\n    if (isSpecial) {\r\n      _s.hasHTML5 = false; // has Audio(), but is broken; let it load links directly.\r\n      _s.html5Only = true; // ignore flash case, however\r\n      if (_s.oMC) {\r\n        _s.oMC.style.display = 'none';\r\n      }\r\n      return false;\r\n    }\r\n\r\n    if (_s.useHTML5Audio) {\r\n      if (!_s.html5 || !_s.html5.canPlayType) {\r\n        _s._wD('SoundManager: No HTML5 Audio() support detected.');\r\n        _s.hasHTML5 = false;\r\n        return true;\r\n      } else {\r\n        _s.hasHTML5 = true;\r\n      }\r\n      if (_isBadSafari) {\r\n        _s._wD(_smc+'Note: Buggy HTML5 Audio in Safari on this OS X release, see https://bugs.webkit.org/show_bug.cgi?id=32159 - '+(!_hasFlash?' would use flash fallback for MP3/MP4, but none detected.':'will use flash fallback for MP3/MP4, if available'),1);\r\n        if (_detectFlash()) {\r\n          return true;\r\n        }\r\n      }\r\n    } else {\r\n      // flash needed (or, HTML5 needs enabling.)\r\n      return true;\r\n    }\r\n\r\n    for (item in _s.audioFormats) {\r\n      if (_s.audioFormats.hasOwnProperty(item)) {\r\n        if ( (_s.audioFormats[item].required && !_s.html5.canPlayType(_s.audioFormats[item].type)) || _s.flash[item] || _s.flash[_s.audioFormats[item].type]) {\r\n          // flash may be required, or preferred for this format\r\n          needsFlash = true;\r\n        }\r\n      }\r\n    }\r\n\r\n    // sanity check..\r\n    if (_s.ignoreFlash) {\r\n      needsFlash = false;\r\n    }\r\n\r\n    _s.html5Only = (_s.hasHTML5 && _s.useHTML5Audio && !needsFlash);\r\n\r\n    return (!_s.html5Only);\r\n\r\n  };\r\n\r\n  _startTimer = function (oSound) {\r\n    if (!oSound._hasTimer) {\r\n      oSound._hasTimer = true;\r\n    }\r\n  };\r\n\r\n  _stopTimer = function (oSound) {\r\n    if (oSound._hasTimer) {\r\n      oSound._hasTimer = false;\r\n    }\r\n  };\r\n\r\n  _catchError = function (options) {\r\n    options = (typeof options !== 'undefined' ? options : {});\r\n    if (_s.onerror instanceof Function) {\r\n      _s.onerror.apply(_win, [{type:(typeof options.type !== 'undefined' ? options.type : null)}]);\r\n    }\r\n    if (typeof options.fatal !== 'undefined' && options.fatal) {\r\n      _s.disable();\r\n    }\r\n  };\r\n\r\n  _badSafariFix = function () {\r\n    // special case: \"bad\" Safari (OS X 10.3 - 10.7) must fall back to flash for MP3/MP4\r\n    if (!_isBadSafari || !_detectFlash()) {\r\n      return false; // doesn't apply\r\n    }\r\n    var aF = _s.audioFormats, i, item;\r\n    for (item in aF) {\r\n      if (aF.hasOwnProperty(item)) {\r\n        if (item === 'mp3' || item === 'mp4') {\r\n          _s._wD(_sm+': Using flash fallback for '+item+' format');\r\n          _s.html5[item] = false;\r\n          // assign result to related formats, too\r\n          if (aF[item] && aF[item].related) {\r\n            for (i = aF[item].related.length; i--;) {\r\n              _s.html5[aF[item].related[i]] = false;\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  };\r\n\r\n  /*\r\n   * pseudo-private flash/ExternalInterface methods\r\n  */\r\n\r\n  this._setSandboxType = function (sandboxType) {\r\n    // <d>\r\n    var sb = _s.sandbox;\r\n    sb.type = sandboxType;\r\n    sb.description = sb.types[(typeof sb.types[sandboxType] !== 'undefined'?sandboxType:'unknown')];\r\n    _s._wD('Flash security sandbox type: ' + sb.type);\r\n    if (sb.type === 'localWithFile') {\r\n      sb.noRemote = true;\r\n      sb.noLocal = false;\r\n      _wDS('secNote', 2);\r\n    } else if (sb.type === 'localWithNetwork') {\r\n      sb.noRemote = false;\r\n      sb.noLocal = true;\r\n    } else if (sb.type === 'localTrusted') {\r\n      sb.noRemote = false;\r\n      sb.noLocal = false;\r\n    }\r\n    // </d>\r\n  };\r\n\r\n  this._externalInterfaceOK = function (flashDate) {\r\n    // flash callback confirming flash loaded, EI working etc.\r\n    // flashDate = approx. timing/delay info for JS/flash bridge\r\n    if (_s.swfLoaded) {\r\n      return false;\r\n    }\r\n    var eiTime = new Date().getTime();\r\n    _s._wD(_smc+'externalInterfaceOK()' + (flashDate?' (~' + (eiTime - flashDate) + ' ms)':''));\r\n    _debugTS('swf', true);\r\n    _debugTS('flashtojs', true);\r\n    _s.swfLoaded = true;\r\n    _tryInitOnFocus = false;\r\n    if (_isBadSafari) {\r\n      _badSafariFix();\r\n    }\r\n    if (_isIE) {\r\n      // IE needs a timeout OR delay until window.onload - may need TODO: investigating\r\n      setTimeout(_init, 100);\r\n    } else {\r\n      _init();\r\n    }\r\n  };\r\n\r\n  /*\r\n   * private initialization helpers\r\n  */\r\n\r\n  _createMovie = function (smID, smURL) {\r\n\r\n    if (_didAppend && _appendSuccess) {\r\n      return false; // ignore if already succeeded\r\n    }\r\n\r\n    function _initMsg() {\r\n      _s._wD('-- SoundManager 2 ' + _s.version + (!_s.html5Only && _s.useHTML5Audio?(_s.hasHTML5?' + HTML5 audio':', no HTML5 audio support'):'') + (!_s.html5Only ? (_s.useMovieStar?', MovieStar mode':'') + (_s.useHighPerformance?', high performance mode, ':', ') + (( _s.flashPollingInterval ? 'custom (' + _s.flashPollingInterval + 'ms)' : (_s.useFastPolling?'fast':'normal')) + ' polling') + (_s.wmode?', wmode: ' + _s.wmode:'') + (_s.debugFlash?', flash debug mode':'') + (_s.useFlashBlock?', flashBlock mode':'') : '') + ' --', 1);\r\n    }\r\n\r\n    if (_s.html5Only) {\r\n      // 100% HTML5 mode\r\n      _setVersionInfo();\r\n      _initMsg();\r\n      _s.oMC = _id(_s.movieID);\r\n      _init();\r\n      // prevent multiple init attempts\r\n      _didAppend = true;\r\n      _appendSuccess = true;\r\n      return false;\r\n    }\r\n\r\n    // flash path\r\n    var remoteURL = (smURL || _s.url),\r\n    localURL = (_s.altURL || remoteURL),\r\n    swfTitle = 'JS/Flash audio component (SoundManager 2)',\r\n    oEmbed, oMovie, oTarget = _getDocument(), tmp, movieHTML, oEl, extraClass = _getSWFCSS(), s, x, sClass, side = 'auto', isRTL = null, html = _doc.getElementsByTagName('html')[0];\r\n\r\n    isRTL = (html && html.dir && html.dir.match(/rtl/i));\r\n    smID = (typeof smID === 'undefined'?_s.id:smID);\r\n\r\n    function param(name, value) {\r\n      return '<param name=\"'+name+'\" value=\"'+value+'\" />';\r\n    }\r\n\r\n    // safety check for legacy (change to Flash 9 URL)\r\n    _setVersionInfo();\r\n    _s.url = _normalizeMovieURL(_overHTTP?remoteURL:localURL);\r\n    smURL = _s.url;\r\n\r\n    _s.wmode = (!_s.wmode && _s.useHighPerformance && !_s.useMovieStar?'transparent':_s.wmode);\r\n\r\n    if (_s.wmode !== null && (_ua.match(/msie 8/i) || (!_isIE && !_s.useHighPerformance)) && navigator.platform.match(/win32|win64/i)) {\r\n      /*\r\n       * extra-special case: movie doesn't load until scrolled into view when using wmode = anything but 'window' here\r\n       * does not apply when using high performance (position:fixed means on-screen), OR infinite flash load timeout\r\n       * wmode breaks IE 8 on Vista + Win7 too in some cases, as of January 2011 (?)\r\n      */\r\n      _s.specialWmodeCase = true;\r\n      _wDS('spcWmode');\r\n      _s.wmode = null;\r\n    }\r\n\r\n    oEmbed = {\r\n      'name': smID,\r\n      'id': smID,\r\n      'src': smURL,\r\n      'width': side,\r\n      'height': side,\r\n      'quality': 'high',\r\n      'allowScriptAccess': _s.allowScriptAccess,\r\n      'bgcolor': _s.bgColor,\r\n      'pluginspage': _http+'//www.macromedia.com/go/getflashplayer',\r\n      'title': swfTitle,\r\n      'type': 'application/x-shockwave-flash',\r\n      'wmode': _s.wmode,\r\n      'hasPriority': 'true' // http://help.adobe.com/en_US/as3/mobile/WS4bebcd66a74275c36cfb8137124318eebc6-7ffd.html\r\n    };\r\n\r\n    if (_s.debugFlash) {\r\n      oEmbed.FlashVars = 'debug=1';\r\n    }\r\n\r\n    if (!_s.wmode) {\r\n      delete oEmbed.wmode; // don't write empty attribute\r\n    }\r\n\r\n    if (_isIE) {\r\n\r\n      // IE is \"special\".\r\n      oMovie = _doc.createElement('div');\r\n      movieHTML = [\r\n        '<object id=\"' + smID + '\" data=\"' + smURL + '\" type=\"' + oEmbed.type + '\" title=\"' + oEmbed.title +'\" classid=\"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000\" codebase=\"' + _http+'//download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0\" width=\"' + oEmbed.width + '\" height=\"' + oEmbed.height + '\">',\r\n        param('movie', smURL),\r\n        param('AllowScriptAccess', _s.allowScriptAccess),\r\n        param('quality', oEmbed.quality),\r\n        (_s.wmode? param('wmode', _s.wmode): ''),\r\n        param('bgcolor', _s.bgColor),\r\n        param('hasPriority', 'true'),\r\n        (_s.debugFlash ? param('FlashVars', oEmbed.FlashVars) : ''),\r\n        '</object>'\r\n      ].join('');\r\n\r\n    } else {\r\n\r\n      oMovie = _doc.createElement('embed');\r\n      for (tmp in oEmbed) {\r\n        if (oEmbed.hasOwnProperty(tmp)) {\r\n          oMovie.setAttribute(tmp, oEmbed[tmp]);\r\n        }\r\n      }\r\n\r\n    }\r\n\r\n    _initDebug();\r\n    extraClass = _getSWFCSS();\r\n    oTarget = _getDocument();\r\n\r\n    if (oTarget) {\r\n\r\n      _s.oMC = (_id(_s.movieID) || _doc.createElement('div'));\r\n\r\n      if (!_s.oMC.id) {\r\n\r\n        _s.oMC.id = _s.movieID;\r\n        _s.oMC.className = _s.swfCSS.swfDefault + ' ' + extraClass;\r\n        s = null;\r\n        oEl = null;\r\n\r\n        if (!_s.useFlashBlock) {\r\n          if (_s.useHighPerformance) {\r\n            // on-screen at all times\r\n            s = {\r\n              'position': 'fixed',\r\n              'width': '8px',\r\n              'height': '8px',\r\n              // >= 6px for flash to run fast, >= 8px to start up under Firefox/win32 in some cases. odd? yes.\r\n              'bottom': '0px',\r\n              'left': '0px',\r\n              'overflow': 'hidden'\r\n            };\r\n          } else {\r\n            // hide off-screen, lower priority\r\n            s = {\r\n              'position': 'absolute',\r\n              'width': '6px',\r\n              'height': '6px',\r\n              'top': '-9999px',\r\n              'left': '-9999px'\r\n            };\r\n            if (isRTL) {\r\n              s.left = Math.abs(parseInt(s.left,10))+'px';\r\n            }\r\n          }\r\n        }\r\n\r\n        if (_isWebkit) {\r\n          _s.oMC.style.zIndex = 10000; // soundcloud-reported render/crash fix, safari 5\r\n        }\r\n\r\n        if (!_s.debugFlash) {\r\n          for (x in s) {\r\n            if (s.hasOwnProperty(x)) {\r\n              _s.oMC.style[x] = s[x];\r\n            }\r\n          }\r\n        }\r\n\r\n        try {\r\n          if (!_isIE) {\r\n            _s.oMC.appendChild(oMovie);\r\n          }\r\n          oTarget.appendChild(_s.oMC);\r\n          if (_isIE) {\r\n            oEl = _s.oMC.appendChild(_doc.createElement('div'));\r\n            oEl.className = _s.swfCSS.swfBox;\r\n            oEl.innerHTML = movieHTML;\r\n          }\r\n          _appendSuccess = true;\r\n        } catch(e) {\r\n          throw new Error(_str('domError')+' \\n'+e.toString());\r\n        }\r\n\r\n      } else {\r\n\r\n        // SM2 container is already in the document (eg. flashblock use case)\r\n        sClass = _s.oMC.className;\r\n        _s.oMC.className = (sClass?sClass+' ':_s.swfCSS.swfDefault) + (extraClass?' '+extraClass:'');\r\n        _s.oMC.appendChild(oMovie);\r\n        if (_isIE) {\r\n          oEl = _s.oMC.appendChild(_doc.createElement('div'));\r\n          oEl.className = _s.swfCSS.swfBox;\r\n          oEl.innerHTML = movieHTML;\r\n        }\r\n        _appendSuccess = true;\r\n\r\n      }\r\n\r\n    }\r\n\r\n    _didAppend = true;\r\n    _initMsg();\r\n    _s._wD(_smc+'createMovie(): Trying to load ' + smURL + (!_overHTTP && _s.altURL?' (alternate URL)':''), 1);\r\n\r\n    return true;\r\n\r\n  };\r\n\r\n  _initMovie = function () {\r\n\r\n    if (_s.html5Only) {\r\n      _createMovie();\r\n      return false;\r\n    }\r\n\r\n    // attempt to get, or create, movie\r\n    if (_s.o) {\r\n      return false; // may already exist\r\n    }\r\n\r\n    _s.o = _s.getMovie(_s.id); // inline markup\r\n\r\n    if (!_s.o) {\r\n      if (!_oRemoved) {\r\n        // try to create\r\n        _createMovie(_s.id, _s.url);\r\n      } else {\r\n        // try to re-append removed movie after reboot()\r\n        if (!_isIE) {\r\n          _s.oMC.appendChild(_oRemoved);\r\n        } else {\r\n          _s.oMC.innerHTML = _oRemovedHTML;\r\n        }\r\n        _oRemoved = null;\r\n        _didAppend = true;\r\n      }\r\n      _s.o = _s.getMovie(_s.id);\r\n    }\r\n\r\n    if (_s.o) {\r\n      _wDS('waitEI');\r\n    }\r\n\r\n    if (_s.oninitmovie instanceof Function) {\r\n      setTimeout(_s.oninitmovie, 1);\r\n    }\r\n\r\n    return true;\r\n\r\n  };\r\n\r\n  _delayWaitForEI = function () {\r\n    setTimeout(_waitForEI, 1000);\r\n  };\r\n\r\n  _waitForEI = function () {\r\n\r\n    if (_waitingForEI) {\r\n      return false;\r\n    }\r\n\r\n    _waitingForEI = true;\r\n    _event.remove(_win, 'load', _delayWaitForEI);\r\n\r\n    if (_tryInitOnFocus && !_isFocused) {\r\n      // giant Safari 3.1 hack - assume mousemove = focus given lack of focus event\r\n      _wDS('waitFocus');\r\n      return false;\r\n    }\r\n\r\n    var p;\r\n    if (!_didInit) {\r\n      p = _s.getMoviePercent();\r\n      _s._wD(_str('waitImpatient', (p === 100?' (SWF loaded)':(p > 0?' (SWF ' + p + '% loaded)':''))));\r\n    }\r\n\r\n    setTimeout(function () {\r\n\r\n      p = _s.getMoviePercent();\r\n\r\n      if (!_didInit) {\r\n        _s._wD(_sm + ': No Flash response within expected time.\\nLikely causes: ' + (p === 0?'Loading ' + _s.movieURL + ' may have failed (and/or Flash ' + _fV + '+ not present?), ':'') + 'Flash blocked or JS-Flash security error.' + (_s.debugFlash?' ' + _str('checkSWF'):''), 2);\r\n        if (!_overHTTP && p) {\r\n          _wDS('localFail', 2);\r\n          if (!_s.debugFlash) {\r\n            _wDS('tryDebug', 2);\r\n          }\r\n        }\r\n        if (p === 0) {\r\n          // if 0 (not null), probably a 404.\r\n          _s._wD(_str('swf404', _s.url));\r\n        }\r\n        _debugTS('flashtojs', false, ': Timed out' + _overHTTP?' (Check flash security or flash blockers)':' (No plugin/missing SWF?)');\r\n      }\r\n\r\n      // give up / time-out, depending\r\n      if (!_didInit && _okToDisable) {\r\n        if (p === null) {\r\n          // SWF failed. Maybe blocked.\r\n          if (_s.useFlashBlock || _s.flashLoadTimeout === 0) {\r\n            if (_s.useFlashBlock) {\r\n              _flashBlockHandler();\r\n            }\r\n            _wDS('waitForever');\r\n          } else {\r\n            // old SM2 behaviour, simply fail\r\n            _failSafely(true);\r\n          }\r\n\r\n        } else {\r\n          // flash loaded? Shouldn't be a blocking issue, then.\r\n          if (_s.flashLoadTimeout === 0) {\r\n             _wDS('waitForever');\r\n          } else {\r\n            _failSafely(true);\r\n          }\r\n        }\r\n      }\r\n\r\n    }, _s.flashLoadTimeout);\r\n\r\n  };\r\n\r\n  _handleFocus = function () {\r\n    function cleanup() {\r\n      _event.remove(_win, 'focus', _handleFocus);\r\n      _event.remove(_win, 'load', _handleFocus);\r\n    }\r\n    if (_isFocused || !_tryInitOnFocus) {\r\n      cleanup();\r\n      return true;\r\n    }\r\n    _okToDisable = true;\r\n    _isFocused = true;\r\n    _s._wD(_smc+'handleFocus()');\r\n    if (_isSafari && _tryInitOnFocus) {\r\n      _event.remove(_win, 'mousemove', _handleFocus);\r\n    }\r\n    // allow init to restart\r\n    _waitingForEI = false;\r\n    cleanup();\r\n    return true;\r\n  };\r\n\r\n  _initComplete = function (bNoDisable) {\r\n    if (_didInit) {\r\n      return false;\r\n    }\r\n    if (_s.html5Only) {\r\n      // all good.\r\n      _s._wD('-- SoundManager 2: loaded --');\r\n      _didInit = true;\r\n      _initUserOnload();\r\n      _debugTS('onload', true);\r\n      return true;\r\n    }\r\n    var wasTimeout = (_s.useFlashBlock && _s.flashLoadTimeout && !_s.getMoviePercent()),\r\n        error;\r\n    if (!wasTimeout) {\r\n      _didInit = true;\r\n      if (_disabled) {\r\n        error = {type: (!_hasFlash && _needsFlash ? 'NO_FLASH' : 'INIT_TIMEOUT')};\r\n      }\r\n    }\r\n    _s._wD('-- SoundManager 2 ' + (_disabled?'failed to load':'loaded') + ' (' + (_disabled?'security/load error':'OK') + ') --', 1);\r\n    if (_disabled || bNoDisable) {\r\n      if (_s.useFlashBlock && _s.oMC) {\r\n        _s.oMC.className = _getSWFCSS() + ' ' + (_s.getMoviePercent() === null?_s.swfCSS.swfTimedout:_s.swfCSS.swfError);\r\n      }\r\n      _processOnEvents({type:'ontimeout', error:error});\r\n      _debugTS('onload', false);\r\n      _catchError(error);\r\n      return false;\r\n    } else {\r\n      _debugTS('onload', true);\r\n    }\r\n    _event.add(_win, 'unload', _doNothing); // prevent browser from showing cached state via back button, because flash will be dead\r\n    if (_s.waitForWindowLoad && !_windowLoaded) {\r\n      _wDS('waitOnload');\r\n      _event.add(_win, 'load', _initUserOnload);\r\n      return false;\r\n    } else {\r\n      if (_s.waitForWindowLoad && _windowLoaded) {\r\n        _wDS('docLoaded');\r\n      }\r\n      _initUserOnload();\r\n    }\r\n    return true;\r\n  };\r\n\r\n  _showSupport = function () {\r\n\r\n    var item, tests = [];\r\n    if (_s.useHTML5Audio && _s.hasHTML5) {\r\n      for (item in _s.audioFormats) {\r\n        if (_s.audioFormats.hasOwnProperty(item)) {\r\n          tests.push(item + ': ' + _s.html5[item] + (!_s.html5[item] && _hasFlash && _s.flash[item] ? ' (using flash)' : (_s.preferFlash && _s.flash[item] && _hasFlash ? ' (preferring flash)': (!_s.html5[item] ? ' (' + (_s.audioFormats[item].required ? 'required, ':'') + 'and no flash support)' : ''))));\r\n        }\r\n      }\r\n      _s._wD('-- SoundManager 2: HTML5 support tests ('+_s.html5Test+'): '+tests.join(', ')+' --',1);\r\n    }\r\n\r\n  };\r\n\r\n  _init = function () {\r\n\r\n    _wDS('init');\r\n\r\n    // called after onload()\r\n    if (_didInit) {\r\n      _wDS('didInit');\r\n      return false;\r\n    }\r\n\r\n    function _cleanup() {\r\n      _event.remove(_win, 'load', _s.beginDelayedInit);\r\n    }\r\n\r\n    if (_s.html5Only) {\r\n      if (!_didInit) {\r\n        // we don't need no steenking flash!\r\n        _cleanup();\r\n        _s.enabled = true;\r\n        _initComplete();\r\n      }\r\n      return true;\r\n    }\r\n\r\n    // flash path\r\n    _initMovie();\r\n\r\n    try {\r\n      _wDS('flashJS');\r\n      _s.o._externalInterfaceTest(false); // attempt to talk to Flash\r\n      if (!_s.allowPolling) {\r\n        _wDS('noPolling', 1);\r\n      } else {\r\n        _setPolling(true, (_s.flashPollingInterval || (_s.useFastPolling ? 10 : 50)));\r\n      }\r\n      if (!_s.debugMode) {\r\n        _s.o._disableDebug();\r\n      }\r\n      _s.enabled = true;\r\n      _debugTS('jstoflash', true);\r\n    } catch(e) {\r\n      _s._wD('js/flash exception: ' + e.toString());\r\n      _debugTS('jstoflash', false);\r\n      _catchError({type:'JS_TO_FLASH_EXCEPTION', fatal:true});\r\n      _failSafely(true); // don't disable, for reboot()\r\n      _initComplete();\r\n      return false;\r\n    }\r\n\r\n    _initComplete();\r\n    // event cleanup\r\n    _cleanup();\r\n    return true;\r\n\r\n  };\r\n\r\n  _dcLoaded = function () {\r\n    if (_didDCLoaded) {\r\n      return false;\r\n    }\r\n    _didDCLoaded = true;\r\n    _initDebug();\r\n\r\n    /*\r\n     * Temporary feature: allow force of HTML5 via URL params: sm2-usehtml5audio=0 or 1\r\n     * Ditto for sm2-preferFlash, too.\r\n    */\r\n    // <d>\r\n    (function () {\r\n      var a = 'sm2-usehtml5audio=', l = _wl.toLowerCase(), b = null,\r\n      a2 = 'sm2-preferflash=', b2 = null, hasCon = (typeof console !== 'undefined' && typeof console.log !== 'undefined');\r\n      if (l.indexOf(a) !== -1) {\r\n        b = (l.charAt(l.indexOf(a)+a.length) === '1');\r\n        if (hasCon) {\r\n          console.log((b?'Enabling ':'Disabling ')+'useHTML5Audio via URL parameter');\r\n        }\r\n        _s.useHTML5Audio = b;\r\n      }\r\n      if (l.indexOf(a2) !== -1) {\r\n        b2 = (l.charAt(l.indexOf(a2)+a2.length) === '1');\r\n        if (hasCon) {\r\n          console.log((b2?'Enabling ':'Disabling ')+'preferFlash via URL parameter');\r\n        }\r\n        _s.preferFlash = b2;\r\n      }\r\n    }());\r\n    // </d>\r\n\r\n    if (!_hasFlash && _s.hasHTML5) {\r\n      _s._wD('SoundManager: No Flash detected'+(!_s.useHTML5Audio?', enabling HTML5.':'. Trying HTML5-only mode.'));\r\n      _s.useHTML5Audio = true;\r\n      // make sure we aren't preferring flash, either\r\n      // TODO: preferFlash should not matter if flash is not installed. Currently, stuff breaks without the below tweak.\r\n      _s.preferFlash = false;\r\n    }\r\n\r\n    _testHTML5();\r\n    _s.html5.usingFlash = _featureCheck();\r\n    _needsFlash = _s.html5.usingFlash;\r\n\r\n    _showSupport();\r\n\r\n    if (!_hasFlash && _needsFlash) {\r\n      _s._wD('SoundManager: Fatal error: Flash is needed to play some required formats, but is not available.');\r\n      // TODO: Fatal here vs. timeout approach, etc.\r\n      _s.flashLoadTimeout = 1; // hack: fail sooner.\r\n    }\r\n\r\n    if (_doc.removeEventListener) {\r\n      _doc.removeEventListener('DOMContentLoaded', _dcLoaded, false);\r\n    }\r\n    _initMovie();\r\n    return true;\r\n  };\r\n\r\n  _dcIE = function () {\r\n    if (_doc.readyState === 'complete') {\r\n      _dcLoaded();\r\n      _doc.detachEvent('onreadystatechange', _dcIE);\r\n    }\r\n    return true;\r\n  };\r\n\r\n  // sniff up-front\r\n  _detectFlash();\r\n\r\n  // focus and window load, init (primarily flash-driven)\r\n  _event.add(_win, 'focus', _handleFocus);\r\n  _event.add(_win, 'load', _handleFocus);\r\n  _event.add(_win, 'load', _delayWaitForEI);\r\n  if (_isSafari && _tryInitOnFocus) {\r\n    _event.add(_win, 'mousemove', _handleFocus); // massive Safari 3.1 focus hack\r\n  }\r\n\r\n  if (_doc.addEventListener) {\r\n    _doc.addEventListener('DOMContentLoaded', _dcLoaded, false);\r\n  } else if (_doc.attachEvent) {\r\n    _doc.attachEvent('onreadystatechange', _dcIE);\r\n  } else {\r\n    // no add/attachevent support - safe to assume no JS -> Flash either\r\n    _debugTS('onload', false);\r\n    _catchError({type:'NO_DOM2_EVENTS', fatal:true});\r\n  }\r\n\r\n  if (_doc.readyState === 'complete') {\r\n    setTimeout(_dcLoaded,100);\r\n  }\r\n\r\n} // SoundManager()\r\n","pre":true},"sdk/jsio/util/underscore.js":{"path":"sdk/jsio/util/underscore.js","friendlyPath":"util.underscore","directory":"sdk/jsio/util/","filename":"underscore.js","src":"//     Underscore.js 1.5.2\n//     http://underscorejs.org\n//     (c) 2009-2013 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors\n//     Underscore may be freely distributed under the MIT license.\n\n(function() {\n\n  // Baseline setup\n  // --------------\n\n  // Establish the root object, `window` in the browser, or `exports` on the server.\n  var root = this;\n\n  // Save the previous value of the `_` variable.\n  var previousUnderscore = root._;\n\n  // Establish the object that gets returned to break out of a loop iteration.\n  var breaker = {};\n\n  // Save bytes in the minified (but not gzipped) version:\n  var ArrayProto = Array.prototype, ObjProto = Object.prototype, FuncProto = Function.prototype;\n\n  // Create quick reference variables for speed access to core prototypes.\n  var\n    push             = ArrayProto.push,\n    slice            = ArrayProto.slice,\n    concat           = ArrayProto.concat,\n    toString         = ObjProto.toString,\n    hasOwnProperty   = ObjProto.hasOwnProperty;\n\n  // All **ECMAScript 5** native function implementations that we hope to use\n  // are declared here.\n  var\n    nativeForEach      = ArrayProto.forEach,\n    nativeMap          = ArrayProto.map,\n    nativeReduce       = ArrayProto.reduce,\n    nativeReduceRight  = ArrayProto.reduceRight,\n    nativeFilter       = ArrayProto.filter,\n    nativeEvery        = ArrayProto.every,\n    nativeSome         = ArrayProto.some,\n    nativeIndexOf      = ArrayProto.indexOf,\n    nativeLastIndexOf  = ArrayProto.lastIndexOf,\n    nativeIsArray      = Array.isArray,\n    nativeKeys         = Object.keys,\n    nativeBind         = FuncProto.bind;\n\n  // Create a safe reference to the Underscore object for use below.\n  var _ = function(obj) {\n    if (obj instanceof _) return obj;\n    if (!(this instanceof _)) return new _(obj);\n    this._wrapped = obj;\n  };\n\n  // Export the Underscore object for **Node.js**, with\n  // backwards-compatibility for the old `require()` API. If we're in\n  // the browser, add `_` as a global object via a string identifier,\n  // for Closure Compiler \"advanced\" mode.\n  if (typeof exports !== 'undefined') {\n    if (typeof module !== 'undefined' && module.exports) {\n      exports = module.exports = _;\n    }\n    exports._ = _;\n  } else {\n    root._ = _;\n  }\n\n  // Current version.\n  _.VERSION = '1.5.2';\n\n  // Collection Functions\n  // --------------------\n\n  // The cornerstone, an `each` implementation, aka `forEach`.\n  // Handles objects with the built-in `forEach`, arrays, and raw objects.\n  // Delegates to **ECMAScript 5**'s native `forEach` if available.\n  var each = _.each = _.forEach = function(obj, iterator, context) {\n    if (obj == null) return;\n    if (nativeForEach && obj.forEach === nativeForEach) {\n      obj.forEach(iterator, context);\n    } else if (obj.length === +obj.length) {\n      for (var i = 0, length = obj.length; i < length; i++) {\n        if (iterator.call(context, obj[i], i, obj) === breaker) return;\n      }\n    } else {\n      var keys = _.keys(obj);\n      for (var i = 0, length = keys.length; i < length; i++) {\n        if (iterator.call(context, obj[keys[i]], keys[i], obj) === breaker) return;\n      }\n    }\n  };\n\n  // Return the results of applying the iterator to each element.\n  // Delegates to **ECMAScript 5**'s native `map` if available.\n  _.map = _.collect = function(obj, iterator, context) {\n    var results = [];\n    if (obj == null) return results;\n    if (nativeMap && obj.map === nativeMap) return obj.map(iterator, context);\n    each(obj, function(value, index, list) {\n      results.push(iterator.call(context, value, index, list));\n    });\n    return results;\n  };\n\n  var reduceError = 'Reduce of empty array with no initial value';\n\n  // **Reduce** builds up a single result from a list of values, aka `inject`,\n  // or `foldl`. Delegates to **ECMAScript 5**'s native `reduce` if available.\n  _.reduce = _.foldl = _.inject = function(obj, iterator, memo, context) {\n    var initial = arguments.length > 2;\n    if (obj == null) obj = [];\n    if (nativeReduce && obj.reduce === nativeReduce) {\n      if (context) iterator = _.bind(iterator, context);\n      return initial ? obj.reduce(iterator, memo) : obj.reduce(iterator);\n    }\n    each(obj, function(value, index, list) {\n      if (!initial) {\n        memo = value;\n        initial = true;\n      } else {\n        memo = iterator.call(context, memo, value, index, list);\n      }\n    });\n    if (!initial) throw new TypeError(reduceError);\n    return memo;\n  };\n\n  // The right-associative version of reduce, also known as `foldr`.\n  // Delegates to **ECMAScript 5**'s native `reduceRight` if available.\n  _.reduceRight = _.foldr = function(obj, iterator, memo, context) {\n    var initial = arguments.length > 2;\n    if (obj == null) obj = [];\n    if (nativeReduceRight && obj.reduceRight === nativeReduceRight) {\n      if (context) iterator = _.bind(iterator, context);\n      return initial ? obj.reduceRight(iterator, memo) : obj.reduceRight(iterator);\n    }\n    var length = obj.length;\n    if (length !== +length) {\n      var keys = _.keys(obj);\n      length = keys.length;\n    }\n    each(obj, function(value, index, list) {\n      index = keys ? keys[--length] : --length;\n      if (!initial) {\n        memo = obj[index];\n        initial = true;\n      } else {\n        memo = iterator.call(context, memo, obj[index], index, list);\n      }\n    });\n    if (!initial) throw new TypeError(reduceError);\n    return memo;\n  };\n\n  // Return the first value which passes a truth test. Aliased as `detect`.\n  _.find = _.detect = function(obj, iterator, context) {\n    var result;\n    any(obj, function(value, index, list) {\n      if (iterator.call(context, value, index, list)) {\n        result = value;\n        return true;\n      }\n    });\n    return result;\n  };\n\n  // Return all the elements that pass a truth test.\n  // Delegates to **ECMAScript 5**'s native `filter` if available.\n  // Aliased as `select`.\n  _.filter = _.select = function(obj, iterator, context) {\n    var results = [];\n    if (obj == null) return results;\n    if (nativeFilter && obj.filter === nativeFilter) return obj.filter(iterator, context);\n    each(obj, function(value, index, list) {\n      if (iterator.call(context, value, index, list)) results.push(value);\n    });\n    return results;\n  };\n\n  // Return all the elements for which a truth test fails.\n  _.reject = function(obj, iterator, context) {\n    return _.filter(obj, function(value, index, list) {\n      return !iterator.call(context, value, index, list);\n    }, context);\n  };\n\n  // Determine whether all of the elements match a truth test.\n  // Delegates to **ECMAScript 5**'s native `every` if available.\n  // Aliased as `all`.\n  _.every = _.all = function(obj, iterator, context) {\n    iterator || (iterator = _.identity);\n    var result = true;\n    if (obj == null) return result;\n    if (nativeEvery && obj.every === nativeEvery) return obj.every(iterator, context);\n    each(obj, function(value, index, list) {\n      if (!(result = result && iterator.call(context, value, index, list))) return breaker;\n    });\n    return !!result;\n  };\n\n  // Determine if at least one element in the object matches a truth test.\n  // Delegates to **ECMAScript 5**'s native `some` if available.\n  // Aliased as `any`.\n  var any = _.some = _.any = function(obj, iterator, context) {\n    iterator || (iterator = _.identity);\n    var result = false;\n    if (obj == null) return result;\n    if (nativeSome && obj.some === nativeSome) return obj.some(iterator, context);\n    each(obj, function(value, index, list) {\n      if (result || (result = iterator.call(context, value, index, list))) return breaker;\n    });\n    return !!result;\n  };\n\n  // Determine if the array or object contains a given value (using `===`).\n  // Aliased as `include`.\n  _.contains = _.include = function(obj, target) {\n    if (obj == null) return false;\n    if (nativeIndexOf && obj.indexOf === nativeIndexOf) return obj.indexOf(target) != -1;\n    return any(obj, function(value) {\n      return value === target;\n    });\n  };\n\n  // Invoke a method (with arguments) on every item in a collection.\n  _.invoke = function(obj, method) {\n    var args = slice.call(arguments, 2);\n    var isFunc = _.isFunction(method);\n    return _.map(obj, function(value) {\n      return (isFunc ? method : value[method]).apply(value, args);\n    });\n  };\n\n  // Convenience version of a common use case of `map`: fetching a property.\n  _.pluck = function(obj, key) {\n    return _.map(obj, function(value){ return value[key]; });\n  };\n\n  // Convenience version of a common use case of `filter`: selecting only objects\n  // containing specific `key:value` pairs.\n  _.where = function(obj, attrs, first) {\n    if (_.isEmpty(attrs)) return first ? void 0 : [];\n    return _[first ? 'find' : 'filter'](obj, function(value) {\n      for (var key in attrs) {\n        if (attrs[key] !== value[key]) return false;\n      }\n      return true;\n    });\n  };\n\n  // Convenience version of a common use case of `find`: getting the first object\n  // containing specific `key:value` pairs.\n  _.findWhere = function(obj, attrs) {\n    return _.where(obj, attrs, true);\n  };\n\n  // Return the maximum element or (element-based computation).\n  // Can't optimize arrays of integers longer than 65,535 elements.\n  // See [WebKit Bug 80797](https://bugs.webkit.org/show_bug.cgi?id=80797)\n  _.max = function(obj, iterator, context) {\n    if (!iterator && _.isArray(obj) && obj[0] === +obj[0] && obj.length < 65535) {\n      return Math.max.apply(Math, obj);\n    }\n    if (!iterator && _.isEmpty(obj)) return -Infinity;\n    var result = {computed : -Infinity, value: -Infinity};\n    each(obj, function(value, index, list) {\n      var computed = iterator ? iterator.call(context, value, index, list) : value;\n      computed > result.computed && (result = {value : value, computed : computed});\n    });\n    return result.value;\n  };\n\n  // Return the minimum element (or element-based computation).\n  _.min = function(obj, iterator, context) {\n    if (!iterator && _.isArray(obj) && obj[0] === +obj[0] && obj.length < 65535) {\n      return Math.min.apply(Math, obj);\n    }\n    if (!iterator && _.isEmpty(obj)) return Infinity;\n    var result = {computed : Infinity, value: Infinity};\n    each(obj, function(value, index, list) {\n      var computed = iterator ? iterator.call(context, value, index, list) : value;\n      computed < result.computed && (result = {value : value, computed : computed});\n    });\n    return result.value;\n  };\n\n  // Shuffle an array, using the modern version of the \n  // [Fisher-Yates shuffle](http://en.wikipedia.org/wiki/Fisherâ€“Yates_shuffle).\n  _.shuffle = function(obj) {\n    var rand;\n    var index = 0;\n    var shuffled = [];\n    each(obj, function(value) {\n      rand = _.random(index++);\n      shuffled[index - 1] = shuffled[rand];\n      shuffled[rand] = value;\n    });\n    return shuffled;\n  };\n\n  // Sample **n** random values from an array.\n  // If **n** is not specified, returns a single random element from the array.\n  // The internal `guard` argument allows it to work with `map`.\n  _.sample = function(obj, n, guard) {\n    if (arguments.length < 2 || guard) {\n      return obj[_.random(obj.length - 1)];\n    }\n    return _.shuffle(obj).slice(0, Math.max(0, n));\n  };\n\n  // An internal function to generate lookup iterators.\n  var lookupIterator = function(value) {\n    return _.isFunction(value) ? value : function(obj){ return obj[value]; };\n  };\n\n  // Sort the object's values by a criterion produced by an iterator.\n  _.sortBy = function(obj, value, context) {\n    var iterator = lookupIterator(value);\n    return _.pluck(_.map(obj, function(value, index, list) {\n      return {\n        value: value,\n        index: index,\n        criteria: iterator.call(context, value, index, list)\n      };\n    }).sort(function(left, right) {\n      var a = left.criteria;\n      var b = right.criteria;\n      if (a !== b) {\n        if (a > b || a === void 0) return 1;\n        if (a < b || b === void 0) return -1;\n      }\n      return left.index - right.index;\n    }), 'value');\n  };\n\n  // An internal function used for aggregate \"group by\" operations.\n  var group = function(behavior) {\n    return function(obj, value, context) {\n      var result = {};\n      var iterator = value == null ? _.identity : lookupIterator(value);\n      each(obj, function(value, index) {\n        var key = iterator.call(context, value, index, obj);\n        behavior(result, key, value);\n      });\n      return result;\n    };\n  };\n\n  // Groups the object's values by a criterion. Pass either a string attribute\n  // to group by, or a function that returns the criterion.\n  _.groupBy = group(function(result, key, value) {\n    (_.has(result, key) ? result[key] : (result[key] = [])).push(value);\n  });\n\n  // Indexes the object's values by a criterion, similar to `groupBy`, but for\n  // when you know that your index values will be unique.\n  _.indexBy = group(function(result, key, value) {\n    result[key] = value;\n  });\n\n  // Counts instances of an object that group by a certain criterion. Pass\n  // either a string attribute to count by, or a function that returns the\n  // criterion.\n  _.countBy = group(function(result, key) {\n    _.has(result, key) ? result[key]++ : result[key] = 1;\n  });\n\n  // Use a comparator function to figure out the smallest index at which\n  // an object should be inserted so as to maintain order. Uses binary search.\n  _.sortedIndex = function(array, obj, iterator, context) {\n    iterator = iterator == null ? _.identity : lookupIterator(iterator);\n    var value = iterator.call(context, obj);\n    var low = 0, high = array.length;\n    while (low < high) {\n      var mid = (low + high) >>> 1;\n      iterator.call(context, array[mid]) < value ? low = mid + 1 : high = mid;\n    }\n    return low;\n  };\n\n  // Safely create a real, live array from anything iterable.\n  _.toArray = function(obj) {\n    if (!obj) return [];\n    if (_.isArray(obj)) return slice.call(obj);\n    if (obj.length === +obj.length) return _.map(obj, _.identity);\n    return _.values(obj);\n  };\n\n  // Return the number of elements in an object.\n  _.size = function(obj) {\n    if (obj == null) return 0;\n    return (obj.length === +obj.length) ? obj.length : _.keys(obj).length;\n  };\n\n  // Array Functions\n  // ---------------\n\n  // Get the first element of an array. Passing **n** will return the first N\n  // values in the array. Aliased as `head` and `take`. The **guard** check\n  // allows it to work with `_.map`.\n  _.first = _.head = _.take = function(array, n, guard) {\n    if (array == null) return void 0;\n    return (n == null) || guard ? array[0] : slice.call(array, 0, n);\n  };\n\n  // Returns everything but the last entry of the array. Especially useful on\n  // the arguments object. Passing **n** will return all the values in\n  // the array, excluding the last N. The **guard** check allows it to work with\n  // `_.map`.\n  _.initial = function(array, n, guard) {\n    return slice.call(array, 0, array.length - ((n == null) || guard ? 1 : n));\n  };\n\n  // Get the last element of an array. Passing **n** will return the last N\n  // values in the array. The **guard** check allows it to work with `_.map`.\n  _.last = function(array, n, guard) {\n    if (array == null) return void 0;\n    if ((n == null) || guard) {\n      return array[array.length - 1];\n    } else {\n      return slice.call(array, Math.max(array.length - n, 0));\n    }\n  };\n\n  // Returns everything but the first entry of the array. Aliased as `tail` and `drop`.\n  // Especially useful on the arguments object. Passing an **n** will return\n  // the rest N values in the array. The **guard**\n  // check allows it to work with `_.map`.\n  _.rest = _.tail = _.drop = function(array, n, guard) {\n    return slice.call(array, (n == null) || guard ? 1 : n);\n  };\n\n  // Trim out all falsy values from an array.\n  _.compact = function(array) {\n    return _.filter(array, _.identity);\n  };\n\n  // Internal implementation of a recursive `flatten` function.\n  var flatten = function(input, shallow, output) {\n    if (shallow && _.every(input, _.isArray)) {\n      return concat.apply(output, input);\n    }\n    each(input, function(value) {\n      if (_.isArray(value) || _.isArguments(value)) {\n        shallow ? push.apply(output, value) : flatten(value, shallow, output);\n      } else {\n        output.push(value);\n      }\n    });\n    return output;\n  };\n\n  // Flatten out an array, either recursively (by default), or just one level.\n  _.flatten = function(array, shallow) {\n    return flatten(array, shallow, []);\n  };\n\n  // Return a version of the array that does not contain the specified value(s).\n  _.without = function(array) {\n    return _.difference(array, slice.call(arguments, 1));\n  };\n\n  // Produce a duplicate-free version of the array. If the array has already\n  // been sorted, you have the option of using a faster algorithm.\n  // Aliased as `unique`.\n  _.uniq = _.unique = function(array, isSorted, iterator, context) {\n    if (_.isFunction(isSorted)) {\n      context = iterator;\n      iterator = isSorted;\n      isSorted = false;\n    }\n    var initial = iterator ? _.map(array, iterator, context) : array;\n    var results = [];\n    var seen = [];\n    each(initial, function(value, index) {\n      if (isSorted ? (!index || seen[seen.length - 1] !== value) : !_.contains(seen, value)) {\n        seen.push(value);\n        results.push(array[index]);\n      }\n    });\n    return results;\n  };\n\n  // Produce an array that contains the union: each distinct element from all of\n  // the passed-in arrays.\n  _.union = function() {\n    return _.uniq(_.flatten(arguments, true));\n  };\n\n  // Produce an array that contains every item shared between all the\n  // passed-in arrays.\n  _.intersection = function(array) {\n    var rest = slice.call(arguments, 1);\n    return _.filter(_.uniq(array), function(item) {\n      return _.every(rest, function(other) {\n        return _.indexOf(other, item) >= 0;\n      });\n    });\n  };\n\n  // Take the difference between one array and a number of other arrays.\n  // Only the elements present in just the first array will remain.\n  _.difference = function(array) {\n    var rest = concat.apply(ArrayProto, slice.call(arguments, 1));\n    return _.filter(array, function(value){ return !_.contains(rest, value); });\n  };\n\n  // Zip together multiple lists into a single array -- elements that share\n  // an index go together.\n  _.zip = function() {\n    var length = _.max(_.pluck(arguments, \"length\").concat(0));\n    var results = new Array(length);\n    for (var i = 0; i < length; i++) {\n      results[i] = _.pluck(arguments, '' + i);\n    }\n    return results;\n  };\n\n  // Converts lists into objects. Pass either a single array of `[key, value]`\n  // pairs, or two parallel arrays of the same length -- one of keys, and one of\n  // the corresponding values.\n  _.object = function(list, values) {\n    if (list == null) return {};\n    var result = {};\n    for (var i = 0, length = list.length; i < length; i++) {\n      if (values) {\n        result[list[i]] = values[i];\n      } else {\n        result[list[i][0]] = list[i][1];\n      }\n    }\n    return result;\n  };\n\n  // If the browser doesn't supply us with indexOf (I'm looking at you, **MSIE**),\n  // we need this function. Return the position of the first occurrence of an\n  // item in an array, or -1 if the item is not included in the array.\n  // Delegates to **ECMAScript 5**'s native `indexOf` if available.\n  // If the array is large and already in sort order, pass `true`\n  // for **isSorted** to use binary search.\n  _.indexOf = function(array, item, isSorted) {\n    if (array == null) return -1;\n    var i = 0, length = array.length;\n    if (isSorted) {\n      if (typeof isSorted == 'number') {\n        i = (isSorted < 0 ? Math.max(0, length + isSorted) : isSorted);\n      } else {\n        i = _.sortedIndex(array, item);\n        return array[i] === item ? i : -1;\n      }\n    }\n    if (nativeIndexOf && array.indexOf === nativeIndexOf) return array.indexOf(item, isSorted);\n    for (; i < length; i++) if (array[i] === item) return i;\n    return -1;\n  };\n\n  // Delegates to **ECMAScript 5**'s native `lastIndexOf` if available.\n  _.lastIndexOf = function(array, item, from) {\n    if (array == null) return -1;\n    var hasIndex = from != null;\n    if (nativeLastIndexOf && array.lastIndexOf === nativeLastIndexOf) {\n      return hasIndex ? array.lastIndexOf(item, from) : array.lastIndexOf(item);\n    }\n    var i = (hasIndex ? from : array.length);\n    while (i--) if (array[i] === item) return i;\n    return -1;\n  };\n\n  // Generate an integer Array containing an arithmetic progression. A port of\n  // the native Python `range()` function. See\n  // [the Python documentation](http://docs.python.org/library/functions.html#range).\n  _.range = function(start, stop, step) {\n    if (arguments.length <= 1) {\n      stop = start || 0;\n      start = 0;\n    }\n    step = arguments[2] || 1;\n\n    var length = Math.max(Math.ceil((stop - start) / step), 0);\n    var idx = 0;\n    var range = new Array(length);\n\n    while(idx < length) {\n      range[idx++] = start;\n      start += step;\n    }\n\n    return range;\n  };\n\n  // Function (ahem) Functions\n  // ------------------\n\n  // Reusable constructor function for prototype setting.\n  var ctor = function(){};\n\n  // Create a function bound to a given object (assigning `this`, and arguments,\n  // optionally). Delegates to **ECMAScript 5**'s native `Function.bind` if\n  // available.\n  _.bind = function(func, context) {\n    var args, bound;\n    if (nativeBind && func.bind === nativeBind) return nativeBind.apply(func, slice.call(arguments, 1));\n    if (!_.isFunction(func)) throw new TypeError;\n    args = slice.call(arguments, 2);\n    return bound = function() {\n      if (!(this instanceof bound)) return func.apply(context, args.concat(slice.call(arguments)));\n      ctor.prototype = func.prototype;\n      var self = new ctor;\n      ctor.prototype = null;\n      var result = func.apply(self, args.concat(slice.call(arguments)));\n      if (Object(result) === result) return result;\n      return self;\n    };\n  };\n\n  // Partially apply a function by creating a version that has had some of its\n  // arguments pre-filled, without changing its dynamic `this` context.\n  _.partial = function(func) {\n    var args = slice.call(arguments, 1);\n    return function() {\n      return func.apply(this, args.concat(slice.call(arguments)));\n    };\n  };\n\n  // Bind all of an object's methods to that object. Useful for ensuring that\n  // all callbacks defined on an object belong to it.\n  _.bindAll = function(obj) {\n    var funcs = slice.call(arguments, 1);\n    if (funcs.length === 0) throw new Error(\"bindAll must be passed function names\");\n    each(funcs, function(f) { obj[f] = _.bind(obj[f], obj); });\n    return obj;\n  };\n\n  // Memoize an expensive function by storing its results.\n  _.memoize = function(func, hasher) {\n    var memo = {};\n    hasher || (hasher = _.identity);\n    return function() {\n      var key = hasher.apply(this, arguments);\n      return _.has(memo, key) ? memo[key] : (memo[key] = func.apply(this, arguments));\n    };\n  };\n\n  // Delays a function for the given number of milliseconds, and then calls\n  // it with the arguments supplied.\n  _.delay = function(func, wait) {\n    var args = slice.call(arguments, 2);\n    return setTimeout(function(){ return func.apply(null, args); }, wait);\n  };\n\n  // Defers a function, scheduling it to run after the current call stack has\n  // cleared.\n  _.defer = function(func) {\n    return _.delay.apply(_, [func, 1].concat(slice.call(arguments, 1)));\n  };\n\n  // Returns a function, that, when invoked, will only be triggered at most once\n  // during a given window of time. Normally, the throttled function will run\n  // as much as it can, without ever going more than once per `wait` duration;\n  // but if you'd like to disable the execution on the leading edge, pass\n  // `{leading: false}`. To disable execution on the trailing edge, ditto.\n  _.throttle = function(func, wait, options) {\n    var context, args, result;\n    var timeout = null;\n    var previous = 0;\n    options || (options = {});\n    var later = function() {\n      previous = options.leading === false ? 0 : new Date;\n      timeout = null;\n      result = func.apply(context, args);\n    };\n    return function() {\n      var now = new Date;\n      if (!previous && options.leading === false) previous = now;\n      var remaining = wait - (now - previous);\n      context = this;\n      args = arguments;\n      if (remaining <= 0) {\n        clearTimeout(timeout);\n        timeout = null;\n        previous = now;\n        result = func.apply(context, args);\n      } else if (!timeout && options.trailing !== false) {\n        timeout = setTimeout(later, remaining);\n      }\n      return result;\n    };\n  };\n\n  // Returns a function, that, as long as it continues to be invoked, will not\n  // be triggered. The function will be called after it stops being called for\n  // N milliseconds. If `immediate` is passed, trigger the function on the\n  // leading edge, instead of the trailing.\n  _.debounce = function(func, wait, immediate) {\n    var timeout, args, context, timestamp, result;\n    return function() {\n      context = this;\n      args = arguments;\n      timestamp = new Date();\n      var later = function() {\n        var last = (new Date()) - timestamp;\n        if (last < wait) {\n          timeout = setTimeout(later, wait - last);\n        } else {\n          timeout = null;\n          if (!immediate) result = func.apply(context, args);\n        }\n      };\n      var callNow = immediate && !timeout;\n      if (!timeout) {\n        timeout = setTimeout(later, wait);\n      }\n      if (callNow) result = func.apply(context, args);\n      return result;\n    };\n  };\n\n  // Returns a function that will be executed at most one time, no matter how\n  // often you call it. Useful for lazy initialization.\n  _.once = function(func) {\n    var ran = false, memo;\n    return function() {\n      if (ran) return memo;\n      ran = true;\n      memo = func.apply(this, arguments);\n      func = null;\n      return memo;\n    };\n  };\n\n  // Returns the first function passed as an argument to the second,\n  // allowing you to adjust arguments, run code before and after, and\n  // conditionally execute the original function.\n  _.wrap = function(func, wrapper) {\n    return function() {\n      var args = [func];\n      push.apply(args, arguments);\n      return wrapper.apply(this, args);\n    };\n  };\n\n  // Returns a function that is the composition of a list of functions, each\n  // consuming the return value of the function that follows.\n  _.compose = function() {\n    var funcs = arguments;\n    return function() {\n      var args = arguments;\n      for (var i = funcs.length - 1; i >= 0; i--) {\n        args = [funcs[i].apply(this, args)];\n      }\n      return args[0];\n    };\n  };\n\n  // Returns a function that will only be executed after being called N times.\n  _.after = function(times, func) {\n    return function() {\n      if (--times < 1) {\n        return func.apply(this, arguments);\n      }\n    };\n  };\n\n  // Object Functions\n  // ----------------\n\n  // Retrieve the names of an object's properties.\n  // Delegates to **ECMAScript 5**'s native `Object.keys`\n  _.keys = nativeKeys || function(obj) {\n    if (obj !== Object(obj)) throw new TypeError('Invalid object');\n    var keys = [];\n    for (var key in obj) if (_.has(obj, key)) keys.push(key);\n    return keys;\n  };\n\n  // Retrieve the values of an object's properties.\n  _.values = function(obj) {\n    var keys = _.keys(obj);\n    var length = keys.length;\n    var values = new Array(length);\n    for (var i = 0; i < length; i++) {\n      values[i] = obj[keys[i]];\n    }\n    return values;\n  };\n\n  // Convert an object into a list of `[key, value]` pairs.\n  _.pairs = function(obj) {\n    var keys = _.keys(obj);\n    var length = keys.length;\n    var pairs = new Array(length);\n    for (var i = 0; i < length; i++) {\n      pairs[i] = [keys[i], obj[keys[i]]];\n    }\n    return pairs;\n  };\n\n  // Invert the keys and values of an object. The values must be serializable.\n  _.invert = function(obj) {\n    var result = {};\n    var keys = _.keys(obj);\n    for (var i = 0, length = keys.length; i < length; i++) {\n      result[obj[keys[i]]] = keys[i];\n    }\n    return result;\n  };\n\n  // Return a sorted list of the function names available on the object.\n  // Aliased as `methods`\n  _.functions = _.methods = function(obj) {\n    var names = [];\n    for (var key in obj) {\n      if (_.isFunction(obj[key])) names.push(key);\n    }\n    return names.sort();\n  };\n\n  // Extend a given object with all the properties in passed-in object(s).\n  _.extend = function(obj) {\n    each(slice.call(arguments, 1), function(source) {\n      if (source) {\n        for (var prop in source) {\n          obj[prop] = source[prop];\n        }\n      }\n    });\n    return obj;\n  };\n\n  // Return a copy of the object only containing the whitelisted properties.\n  _.pick = function(obj) {\n    var copy = {};\n    var keys = concat.apply(ArrayProto, slice.call(arguments, 1));\n    each(keys, function(key) {\n      if (key in obj) copy[key] = obj[key];\n    });\n    return copy;\n  };\n\n   // Return a copy of the object without the blacklisted properties.\n  _.omit = function(obj) {\n    var copy = {};\n    var keys = concat.apply(ArrayProto, slice.call(arguments, 1));\n    for (var key in obj) {\n      if (!_.contains(keys, key)) copy[key] = obj[key];\n    }\n    return copy;\n  };\n\n  // Fill in a given object with default properties.\n  _.defaults = function(obj) {\n    each(slice.call(arguments, 1), function(source) {\n      if (source) {\n        for (var prop in source) {\n          if (obj[prop] === void 0) obj[prop] = source[prop];\n        }\n      }\n    });\n    return obj;\n  };\n\n  // Create a (shallow-cloned) duplicate of an object.\n  _.clone = function(obj) {\n    if (!_.isObject(obj)) return obj;\n    return _.isArray(obj) ? obj.slice() : _.extend({}, obj);\n  };\n\n  // Invokes interceptor with the obj, and then returns obj.\n  // The primary purpose of this method is to \"tap into\" a method chain, in\n  // order to perform operations on intermediate results within the chain.\n  _.tap = function(obj, interceptor) {\n    interceptor(obj);\n    return obj;\n  };\n\n  // Internal recursive comparison function for `isEqual`.\n  var eq = function(a, b, aStack, bStack) {\n    // Identical objects are equal. `0 === -0`, but they aren't identical.\n    // See the [Harmony `egal` proposal](http://wiki.ecmascript.org/doku.php?id=harmony:egal).\n    if (a === b) return a !== 0 || 1 / a == 1 / b;\n    // A strict comparison is necessary because `null == undefined`.\n    if (a == null || b == null) return a === b;\n    // Unwrap any wrapped objects.\n    if (a instanceof _) a = a._wrapped;\n    if (b instanceof _) b = b._wrapped;\n    // Compare `[[Class]]` names.\n    var className = toString.call(a);\n    if (className != toString.call(b)) return false;\n    switch (className) {\n      // Strings, numbers, dates, and booleans are compared by value.\n      case '[object String]':\n        // Primitives and their corresponding object wrappers are equivalent; thus, `\"5\"` is\n        // equivalent to `new String(\"5\")`.\n        return a == String(b);\n      case '[object Number]':\n        // `NaN`s are equivalent, but non-reflexive. An `egal` comparison is performed for\n        // other numeric values.\n        return a != +a ? b != +b : (a == 0 ? 1 / a == 1 / b : a == +b);\n      case '[object Date]':\n      case '[object Boolean]':\n        // Coerce dates and booleans to numeric primitive values. Dates are compared by their\n        // millisecond representations. Note that invalid dates with millisecond representations\n        // of `NaN` are not equivalent.\n        return +a == +b;\n      // RegExps are compared by their source patterns and flags.\n      case '[object RegExp]':\n        return a.source == b.source &&\n               a.global == b.global &&\n               a.multiline == b.multiline &&\n               a.ignoreCase == b.ignoreCase;\n    }\n    if (typeof a != 'object' || typeof b != 'object') return false;\n    // Assume equality for cyclic structures. The algorithm for detecting cyclic\n    // structures is adapted from ES 5.1 section 15.12.3, abstract operation `JO`.\n    var length = aStack.length;\n    while (length--) {\n      // Linear search. Performance is inversely proportional to the number of\n      // unique nested structures.\n      if (aStack[length] == a) return bStack[length] == b;\n    }\n    // Objects with different constructors are not equivalent, but `Object`s\n    // from different frames are.\n    var aCtor = a.constructor, bCtor = b.constructor;\n    if (aCtor !== bCtor && !(_.isFunction(aCtor) && (aCtor instanceof aCtor) &&\n                             _.isFunction(bCtor) && (bCtor instanceof bCtor))) {\n      return false;\n    }\n    // Add the first object to the stack of traversed objects.\n    aStack.push(a);\n    bStack.push(b);\n    var size = 0, result = true;\n    // Recursively compare objects and arrays.\n    if (className == '[object Array]') {\n      // Compare array lengths to determine if a deep comparison is necessary.\n      size = a.length;\n      result = size == b.length;\n      if (result) {\n        // Deep compare the contents, ignoring non-numeric properties.\n        while (size--) {\n          if (!(result = eq(a[size], b[size], aStack, bStack))) break;\n        }\n      }\n    } else {\n      // Deep compare objects.\n      for (var key in a) {\n        if (_.has(a, key)) {\n          // Count the expected number of properties.\n          size++;\n          // Deep compare each member.\n          if (!(result = _.has(b, key) && eq(a[key], b[key], aStack, bStack))) break;\n        }\n      }\n      // Ensure that both objects contain the same number of properties.\n      if (result) {\n        for (key in b) {\n          if (_.has(b, key) && !(size--)) break;\n        }\n        result = !size;\n      }\n    }\n    // Remove the first object from the stack of traversed objects.\n    aStack.pop();\n    bStack.pop();\n    return result;\n  };\n\n  // Perform a deep comparison to check if two objects are equal.\n  _.isEqual = function(a, b) {\n    return eq(a, b, [], []);\n  };\n\n  // Is a given array, string, or object empty?\n  // An \"empty\" object has no enumerable own-properties.\n  _.isEmpty = function(obj) {\n    if (obj == null) return true;\n    if (_.isArray(obj) || _.isString(obj)) return obj.length === 0;\n    for (var key in obj) if (_.has(obj, key)) return false;\n    return true;\n  };\n\n  // Is a given value a DOM element?\n  _.isElement = function(obj) {\n    return !!(obj && obj.nodeType === 1);\n  };\n\n  // Is a given value an array?\n  // Delegates to ECMA5's native Array.isArray\n  _.isArray = nativeIsArray || function(obj) {\n    return toString.call(obj) == '[object Array]';\n  };\n\n  // Is a given variable an object?\n  _.isObject = function(obj) {\n    return obj === Object(obj);\n  };\n\n  // Add some isType methods: isArguments, isFunction, isString, isNumber, isDate, isRegExp.\n  each(['Arguments', 'Function', 'String', 'Number', 'Date', 'RegExp'], function(name) {\n    _['is' + name] = function(obj) {\n      return toString.call(obj) == '[object ' + name + ']';\n    };\n  });\n\n  // Define a fallback version of the method in browsers (ahem, IE), where\n  // there isn't any inspectable \"Arguments\" type.\n  if (!_.isArguments(arguments)) {\n    _.isArguments = function(obj) {\n      return !!(obj && _.has(obj, 'callee'));\n    };\n  }\n\n  // Optimize `isFunction` if appropriate.\n  if (typeof (/./) !== 'function') {\n    _.isFunction = function(obj) {\n      return typeof obj === 'function';\n    };\n  }\n\n  // Is a given object a finite number?\n  _.isFinite = function(obj) {\n    return isFinite(obj) && !isNaN(parseFloat(obj));\n  };\n\n  // Is the given value `NaN`? (NaN is the only number which does not equal itself).\n  _.isNaN = function(obj) {\n    return _.isNumber(obj) && obj != +obj;\n  };\n\n  // Is a given value a boolean?\n  _.isBoolean = function(obj) {\n    return obj === true || obj === false || toString.call(obj) == '[object Boolean]';\n  };\n\n  // Is a given value equal to null?\n  _.isNull = function(obj) {\n    return obj === null;\n  };\n\n  // Is a given variable undefined?\n  _.isUndefined = function(obj) {\n    return obj === void 0;\n  };\n\n  // Shortcut function for checking if an object has a given property directly\n  // on itself (in other words, not on a prototype).\n  _.has = function(obj, key) {\n    return hasOwnProperty.call(obj, key);\n  };\n\n  // Utility Functions\n  // -----------------\n\n  // Run Underscore.js in *noConflict* mode, returning the `_` variable to its\n  // previous owner. Returns a reference to the Underscore object.\n  _.noConflict = function() {\n    root._ = previousUnderscore;\n    return this;\n  };\n\n  // Keep the identity function around for default iterators.\n  _.identity = function(value) {\n    return value;\n  };\n\n  // Run a function **n** times.\n  _.times = function(n, iterator, context) {\n    var accum = Array(Math.max(0, n));\n    for (var i = 0; i < n; i++) accum[i] = iterator.call(context, i);\n    return accum;\n  };\n\n  // Return a random integer between min and max (inclusive).\n  _.random = function(min, max) {\n    if (max == null) {\n      max = min;\n      min = 0;\n    }\n    return min + Math.floor(Math.random() * (max - min + 1));\n  };\n\n  // List of HTML entities for escaping.\n  var entityMap = {\n    escape: {\n      '&': '&amp;',\n      '<': '&lt;',\n      '>': '&gt;',\n      '\"': '&quot;',\n      \"'\": '&#x27;'\n    }\n  };\n  entityMap.unescape = _.invert(entityMap.escape);\n\n  // Regexes containing the keys and values listed immediately above.\n  var entityRegexes = {\n    escape:   new RegExp('[' + _.keys(entityMap.escape).join('') + ']', 'g'),\n    unescape: new RegExp('(' + _.keys(entityMap.unescape).join('|') + ')', 'g')\n  };\n\n  // Functions for escaping and unescaping strings to/from HTML interpolation.\n  _.each(['escape', 'unescape'], function(method) {\n    _[method] = function(string) {\n      if (string == null) return '';\n      return ('' + string).replace(entityRegexes[method], function(match) {\n        return entityMap[method][match];\n      });\n    };\n  });\n\n  // If the value of the named `property` is a function then invoke it with the\n  // `object` as context; otherwise, return it.\n  _.result = function(object, property) {\n    if (object == null) return void 0;\n    var value = object[property];\n    return _.isFunction(value) ? value.call(object) : value;\n  };\n\n  // Add your own custom functions to the Underscore object.\n  _.mixin = function(obj) {\n    each(_.functions(obj), function(name) {\n      var func = _[name] = obj[name];\n      _.prototype[name] = function() {\n        var args = [this._wrapped];\n        push.apply(args, arguments);\n        return result.call(this, func.apply(_, args));\n      };\n    });\n  };\n\n  // Generate a unique integer id (unique within the entire client session).\n  // Useful for temporary DOM ids.\n  var idCounter = 0;\n  _.uniqueId = function(prefix) {\n    var id = ++idCounter + '';\n    return prefix ? prefix + id : id;\n  };\n\n  // By default, Underscore uses ERB-style template delimiters, change the\n  // following template settings to use alternative delimiters.\n  _.templateSettings = {\n    evaluate    : /<%([\\s\\S]+?)%>/g,\n    interpolate : /<%=([\\s\\S]+?)%>/g,\n    escape      : /<%-([\\s\\S]+?)%>/g\n  };\n\n  // When customizing `templateSettings`, if you don't want to define an\n  // interpolation, evaluation or escaping regex, we need one that is\n  // guaranteed not to match.\n  var noMatch = /(.)^/;\n\n  // Certain characters need to be escaped so that they can be put into a\n  // string literal.\n  var escapes = {\n    \"'\":      \"'\",\n    '\\\\':     '\\\\',\n    '\\r':     'r',\n    '\\n':     'n',\n    '\\t':     't',\n    '\\u2028': 'u2028',\n    '\\u2029': 'u2029'\n  };\n\n  var escaper = /\\\\|'|\\r|\\n|\\t|\\u2028|\\u2029/g;\n\n  // JavaScript micro-templating, similar to John Resig's implementation.\n  // Underscore templating handles arbitrary delimiters, preserves whitespace,\n  // and correctly escapes quotes within interpolated code.\n  _.template = function(text, data, settings) {\n    var render;\n    settings = _.defaults({}, settings, _.templateSettings);\n\n    // Combine delimiters into one regular expression via alternation.\n    var matcher = new RegExp([\n      (settings.escape || noMatch).source,\n      (settings.interpolate || noMatch).source,\n      (settings.evaluate || noMatch).source\n    ].join('|') + '|$', 'g');\n\n    // Compile the template source, escaping string literals appropriately.\n    var index = 0;\n    var source = \"__p+='\";\n    text.replace(matcher, function(match, escape, interpolate, evaluate, offset) {\n      source += text.slice(index, offset)\n        .replace(escaper, function(match) { return '\\\\' + escapes[match]; });\n\n      if (escape) {\n        source += \"'+\\n((__t=(\" + escape + \"))==null?'':_.escape(__t))+\\n'\";\n      }\n      if (interpolate) {\n        source += \"'+\\n((__t=(\" + interpolate + \"))==null?'':__t)+\\n'\";\n      }\n      if (evaluate) {\n        source += \"';\\n\" + evaluate + \"\\n__p+='\";\n      }\n      index = offset + match.length;\n      return match;\n    });\n    source += \"';\\n\";\n\n    // If a variable is not specified, place data values in local scope.\n    if (!settings.variable) source = 'with(obj||{}){\\n' + source + '}\\n';\n\n    source = \"var __t,__p='',__j=Array.prototype.join,\" +\n      \"print=function(){__p+=__j.call(arguments,'');};\\n\" +\n      source + \"return __p;\\n\";\n\n    try {\n      render = new Function(settings.variable || 'obj', '_', source);\n    } catch (e) {\n      e.source = source;\n      throw e;\n    }\n\n    if (data) return render(data, _);\n    var template = function(data) {\n      return render.call(this, data, _);\n    };\n\n    // Provide the compiled function source as a convenience for precompilation.\n    template.source = 'function(' + (settings.variable || 'obj') + '){\\n' + source + '}';\n\n    return template;\n  };\n\n  // Add a \"chain\" function, which will delegate to the wrapper.\n  _.chain = function(obj) {\n    return _(obj).chain();\n  };\n\n  // OOP\n  // ---------------\n  // If Underscore is called as a function, it returns a wrapped object that\n  // can be used OO-style. This wrapper holds altered versions of all the\n  // underscore functions. Wrapped objects may be chained.\n\n  // Helper function to continue chaining intermediate results.\n  var result = function(obj) {\n    return this._chain ? _(obj).chain() : obj;\n  };\n\n  // Add all of the Underscore functions to the wrapper object.\n  _.mixin(_);\n\n  // Add all mutator Array functions to the wrapper.\n  each(['pop', 'push', 'reverse', 'shift', 'sort', 'splice', 'unshift'], function(name) {\n    var method = ArrayProto[name];\n    _.prototype[name] = function() {\n      var obj = this._wrapped;\n      method.apply(obj, arguments);\n      if ((name == 'shift' || name == 'splice') && obj.length === 0) delete obj[0];\n      return result.call(this, obj);\n    };\n  });\n\n  // Add all accessor Array functions to the wrapper.\n  each(['concat', 'join', 'slice'], function(name) {\n    var method = ArrayProto[name];\n    _.prototype[name] = function() {\n      return result.call(this, method.apply(this._wrapped, arguments));\n    };\n  });\n\n  _.extend(_.prototype, {\n\n    // Start chaining a wrapped Underscore object.\n    chain: function() {\n      this._chain = true;\n      return this;\n    },\n\n    // Extracts the result from a wrapped and chained object.\n    value: function() {\n      return this._wrapped;\n    }\n\n  });\n\n}).call(this);\n","pre":true},"sdk/timestep/platforms/browser/initialize.js":{"path":"sdk/timestep/platforms/browser/initialize.js","friendlyPath":"platforms.browser.initialize","directory":"sdk/timestep/platforms/browser/","filename":"initialize.js","baseMod":"platforms","basePath":"sdk/timestep/","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\njsio(\"import device\");\njsio(\"from util.browser import $\");\n\ndevice.registerDevice('browser', 'platforms.browser');\nexports.init = function () {\n\n\tvar onResize;\n\n\tif (device.isMobileBrowser) {\n\t\tdevice.setUseDOM(true);\n\n\t\tvar screen = device.screen;\n\t\tif (device.isIOS || device.isAndroid) {\n\t\t\t\n\t\t\tvar _isFocused = false;\n\t\t\twindow.addEventListener('focus', function (e) {\n\t\t\t\tvar tag = e.target.tagName;\n\t\t\t\tif (tag == 'TEXTAREA' || tag == 'INPUT') {\n\t\t\t\t\t_isFocused = true;\n\t\t\t\t}\n\t\t\t}, true);\n\t\t\t\n\t\t\tdocument.addEventListener('blur', function (e) {\n\t\t\t\tif (_isFocused) {\n\t\t\t\t\t_isFocused = false;\n\t\t\t\t}\n\t\t\t}, true);\n\t\t\t\n\t\t\tdevice.hideAddressBar = function () {\n\t\t\t\tif (_isFocused || !device.isMobileBrowser || !(device.isIOS || device.isAndroid)) { return; }\n\t\t\t\tif (device.isIOS) {\n\t\t\t\t\twindow.scrollTo(0, 1);\n\t\t\t\t\twindow.scrollTo(0, 0);\n\t\t\t\t} else {\n\t\t\t\t\twindow.scrollTo(0, -1);\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tif (!CONFIG.unlockViewport) {\n\t\t\t\twindow.addEventListener('touchstart', bind(device, 'hideAddressBar'), true);\n\t\t\t}\n\t\t}\n\t\t\n\t\tvar lastWidth, lastHeight, lastOrientation;\n\t\tonResize = function () {\n\t\t\tif (device.isIOS) {\n\t\t\t\tdevice.hideAddressBar();\n\t\t\t}\n\t\t\t\n\t\t\tvar w = window.outerWidth;\n\t\t\tvar h = window.outerHeight;\n\t\t\tvar o = window.orientation;\n\t\t\tif (lastWidth == w && lastHeight == h && lastOrientation == o) { return; }\n\t\t\t\n\t\t\tlastWidth = w;\n\t\t\tlastHeight = h;\n\t\t\tlastOrientation = o;\n\t\t\t\n\t\t\tvar isPortrait = screen.isPortrait = (h > w);\n\t\t\tvar isLandscape = screen.isLandscape = !screen.isPortrait;\n\t\t\t\n\t\t\tvar totalW = (isPortrait ? screen.width : screen.height);\n\t\t\tvar totalH = (isPortrait ? screen.height : screen.width);\n\n\t\t\t// in iOS 7 landscape, use full-screen dimensions?\n\t\t\t// TODO: this is actually a bad idea because any tap on the screen\n\t\t\t// will bring up the bottom bar\n\t\t\tif (device.iosVersion >= 7 && (o == 90 || o == -90)) {\n\t\t\t\t// screen width/height is not always rotated, so swap for landscape\n\t\t\t\tw = screen.width;\n\t\t\t\th = screen.height;\n\t\t\t\tif (w < h) {\n\t\t\t\t\tw = h;\n\t\t\t\t\th = screen.width;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// otherwise use available width/height\n\t\t\t\tw = window.innerWidth;\n\t\t\t\th = window.innerHeight;\n\t\t\t}\n\n\t\t\tif (device.width != w || device.height != h || device.orientation != o) {\n\t\t\t\tdevice.width = w;\n\t\t\t\tdevice.height = h;\n\t\t\t\tdevice.orientation = o;\n\t\t\t\tdevice.screen.publish('Resize', device.width, device.height, device.orientation);\n\t\t\t}\n\t\t}\n\t} else {\n\t\tonResize = function () {\n\t\t\tvar doc = window.document,\n\t\t\t\twidth = window.innerWidth || (doc.clientWidth || doc.clientWidth),\n\t\t\t\theight = window.innerHeight || (doc.clientHeight || doc.clientHeight);\n\t\t\t\n\t\t\tif (width != device.width || height != device.height) {\n\t\t\t\tdevice.width = width;\n\t\t\t\tdevice.height = height;\n\t\t\t\tdevice.screen.width = width;\n\t\t\t\tdevice.screen.height = height;\n\n\t\t\t\tif (width > height) {\n\t\t\t\t\tdevice.screen.isPortrait = false;\n\t\t\t\t\tdevice.screen.isLandscape = true;\n\t\t\t\t\tdevice.screen.orientation = 'landscape';\n\t\t\t\t} else {\n\t\t\t\t\tdevice.screen.isPortrait = true;\n\t\t\t\t\tdevice.screen.isLandscape = false;\n\t\t\t\t\tdevice.screen.orientation = 'portrait';\n\t\t\t\t}\n\n\t\t\t\tdevice.screen.publish('Resize', width, height);\n\t\t\t}\n\t\t}\n\t}\n\n\t$.onEvent(window, 'resize', onResize, false);\n\t$.onEvent(window, 'orientationchange', onResize, false);\n\n\tonResize();\n};\n","pre":true},"sdk/timestep/platforms/browser/Input.js":{"path":"sdk/timestep/platforms/browser/Input.js","friendlyPath":".Input","directory":"sdk/timestep/platforms/browser/","filename":"Input.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * package timestep.env.browser.Input;\n *\n * This is imported as timestep.input.InputListener. This binds touch or mouse\n * events on the document (depending on what's specified in device). \n * Additionally, if a canvas option is passed in or setElement(el) is called,\n * mouse over/out and start events are attached to the element. Used on the\n * canvas as well as DOM bindings.\n */\n\njsio(\"import device\");\njsio(\"from util.browser import $\");\n\njsio(\"import event.input.dispatch as input\");\nvar eventTypes = input.eventTypes;\n\n// import ...FPSCounter;\n\nvar UID = -1;\n\nvar sdk_timestep_platforms_browser_Input=__class__;exports=sdk_timestep_platforms_browser_Input(function sdk_timestep_platforms_browser_Input(){return this.init&&this.init.apply(this,arguments)},function (supr) {\n\t\n\tthis.init = function (opts) {\n\n\t\tif (device.simulatingMobileNative || device.simulatingMobileBrowser) { this._simulateMobile = true; }\n\t\t\n\t\tthis._evtQueue = [];\n\t\tthis._rootView = opts.rootView;\n\n\t\tif (opts.el) {\n\t\t\tif (device.isMobileBrowser) {\n\t\t\t\tthis._toggleNode = $({parent:document.body});\n\t\t\t}\n\t\t\tthis.setElement(opts.el);\n\t\t}\n\n\t\t// Mouseover/out events do not fire for mobile browsers\n\t\t// that are driven solely by touch events, so in mobile\n\t\t// browsers, assume the canvas should always handle events.\n\t\t// Otherwise, only handle events if the mouse is over the\n\t\t// canvas.\n\t\tthis._isOver = false;\n\n\t\t// disable the key listener on focus of input elements\n\t\tthis._keyListener = opts.keyListener;\n\n\t\tif (device.useDOM) {\n\t\t\t$.onEvent(document, device.events.start, this, 'handleMouse', eventTypes.START);\n\t\t}\n\t\t\n\t\tthis.enable();\n\t\t\n\t\t// this._evtFps = new FPSCounter({name: \"mouse events\"});\n\t\t\n\t\tthis._hasFocus = false;\n\t\tif (document.addEventListener) {\n\t\t\tdocument.addEventListener('focus', bind(this, 'onFocusCapture'), true);\n\t\t\tdocument.addEventListener('blur', bind(this, 'onBlurCapture'), true);\n\t\t}\n\t}\n\n\tthis.enable = function () {\n\t\tthis._handleMove = $.onEvent(document, device.events.move, this, 'handleMouse', eventTypes.MOVE);\n\t\tthis._handleSelect = $.onEvent(document, device.events.end, this, 'handleMouse', eventTypes.SELECT);\n\t\tthis._handleScroll = $.onEvent(window, 'DOMMouseScroll', this, 'handleMouse', eventTypes.SCROLL); // FF\n\t\tthis._handleWheel = $.onEvent(window, 'mousewheel', this, 'handleMouse', eventTypes.SCROLL); // webkit\n\t};\n\n\tthis.disable = function () {\n\t\tif (this._handleMove) {\n\t\t\tthis._handleMove();\n\t\t\tthis._handleMove = false;\n\t\t}\n\t\tif (this._handleSelect) {\n\t\t\tthis._handleSelect();\n\t\t\tthis._handleSelect = false;\n\t\t}\n\t\tif (this._handleScroll) {\n\t\t\tthis._handleScroll();\n\t\t\tthis._handleScroll = false;\n\t\t}\n\t\tif (this._handleWheel) {\n\t\t\tthis._handleWheel();\n\t\t\tthis._handleWheel = false;\n\t\t}\n\t};\n\t\n\tthis.onFocusCapture = function (e) {\n\t\tvar tag = e.target.tagName;\n\t\tif (tag == 'TEXTAREA' || tag == 'INPUT') {\n\t\t\tthis._hasFocus = e.target;\n\t\t\tthis._keyListener && this._keyListener.setEnabled(false);\n\t\t}\n\t}\n\t\n\tthis.onBlurCapture = function (e) {\n\t\tif (this._hasFocus) {\n\t\t\tthis._hasFocus = null;\n\t\t\tthis._keyListener && this._keyListener.setEnabled(true);\n\t\t}\n\t}\n\t\n\tthis.setElement = function (el) {\n\t\tthis._el = el;\n\t\t\n\t\tif (this._elEvents) {\n\t\t\tfor(var i = 0, detach; detach = this._elEvents[i]; ++i) {\n\t\t\t\tdetach();\n\t\t\t}\n\t\t}\n\t\t\n\t\tel.ondragstart = function () { return false; }\n\t\tel.onselectstart = function () { return false; }\n\t\t\n\t\tthis._elEvents = [];\n\t\t\n\t\tif (!device.useDOM) {\n\t\t\tthis._elEvents.push($.onEvent(el, device.events.start, this, 'handleMouse', eventTypes.START));\n\t\t}\n\t\t\n\t\tif (!device.isMobileBrowser && !device.isNative) {\n\t\t\tthis._elEvents.push($.onEvent(el, 'mouseover', this, 'onMouseOver'));\n\t\t\tthis._elEvents.push($.onEvent(el, 'mouseout', this, 'onMouseOut'));\n\t\t}\n\t}\n\t\n\tthis.onMouseOver = function () { this._isOver = true; }\n\tthis.onMouseOut = function () { this._isOver = false; }\n\tthis.onMouseDown = function () { this._isMouseDown = true; }\n\tthis.onMouseUp = function () { this._isMouseUp = true; }\n\t\n\t// for native-compatibility, always returns an empty array in the browser\n\tthis.getEvents = function () { return this._evtQueue; }\n\t\n\tthis.allowScrollEvents = function (allowScrollEvents) { this._allowScrollEvents = allowScrollEvents; }\n\t\n\tvar empty = function () {};\n\n\tthis.handleMouse = function (type, evt, recursive) {\n\t\tvar target = evt.target;\n\t\tif (this._hasFocus && this._hasFocus == target || target && target.getAttribute && target.getAttribute('noCapture')) { return; }\n\t\t\n\t\t// if (!recursive) {\n\t\t// \t// remove the empty callback to log the raw mouse event fps\n\t\t// \tthis._evtFps.tick(empty);\n\t\t// }\n\t\t\n\t\tvar isMobileBrowser = device.isMobileBrowser;\n\t\t\n\t\tif (!device.useDOM && !isMobileBrowser && !this._isDown && this._el && evt.target != this._el) { return; }\n\t\t\n\t\t// Cancel all events that occur on the canvas.  Optionally, pass scroll events\n\t\t// through to the page (apps that don't care about handling scroll events may\n\t\t// want to pass them through for easier browser debugging).\n\t\tif (isMobileBrowser) {\n\t\t\t$.stopEvent(evt);\n\t\t\tevt.returnValue = false;\n\t\t} else if (this._isOver && (!this._allowScrollEvents || type != eventTypes.SCROLL)) {\n\t\t\tif (evt.stopPropagation) { evt.stopPropagation(); }\n\t\t\tif (type != eventTypes.START) {\n\t\t\t\t$.stopEvent(evt);\n\t\t\t\tevt.returnValue = false;\n\t\t\t}\n\t\t}\n\t\t\n\t\t// On ios devices, this event could correspond to multiple touches.  We recall\n\t\t// ourselves with each changed touch independently.\n\t\tif (evt.touches) {\n\t\t\tfor (var i = 0, t; t = evt.changedTouches[i]; ++i) {\n\t\t\t\tthis.handleMouse(type, t, true);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tvar x, y;\n\t\t// Figure out where in the canvas the event fired.\n\t\t// if (isMobileBrowser) {\n\t\t// \tpt = {\n\t\t// \t\tx: evt.pageX,\n\t\t// \t\ty: evt.pageY\n\t\t// \t};\n\t\t// } else \n\t\tif ('offsetX' in evt && !device.useDOM) {\n\t\t\t// Chrome makes life easy.  offsetX/offsetY is w.r.t. the target, which\n\t\t\t// for us should be the canvas.\n\t\t\tx = evt.offsetX;\n\t\t\ty = evt.offsetY;\n\t\t} else if (this._el.getBoundingClientRect) {\n\t\t\t// It's not too hard in other browsers that support getBoundingClientRect.\n\t\t\t// Get the absolute position of the canvas and do the math.\n\t\t\tvar rect = this._el.getBoundingClientRect();\n\t\t\tx = evt.pageX - rect.left;\n\t\t\ty = evt.pageY - rect.top;\n\t\t} else {\n\t\t\t// Without boundingClientRect, life is hard.  This is the general\n\t\t\t// idea, but we need to loop for offsetParent/scrollLeft/scrollTop\n\t\t\t// to be at least partially complete.  Other libraries handle this\n\t\t\t// better, but the code complexity for that is huge.\n\t\t\t// \n\t\t\t// TODO: older browsers will fail cause this code is buggy and untested?\n\t\t\tvar offsetX, offsetY, parent = this._el;\n\t\t\twhile (parent) {\n\t\t\t\toffsetX += parent.offsetTop;\n\t\t\t\toffsetY += parent.offsetLeft;\n\t\t\t\tparent = parent.parentNode;\n\t\t\t}\n\t\t\t\n\t\t\tx = evt.pageX - offsetX;\n\t\t\ty = evt.pageY - offsetY;\n\t\t}\n\t\t\n\t\tvar id = evt.identifier || UID;\n\t\t\n\t\tif (this._simulateMobile) {\n\t\t\tswitch (type) {\n\t\t\t\tcase eventTypes.START:\n\t\t\t\t\tthis._moveOK = true;\n\t\t\t\t\tbreak;\n\t\t\t\tcase eventTypes.MOVE:\n\t\t\t\t\tif (!this._moveOK) { return; }\n\t\t\t\t\tbreak;\n\t\t\t\tcase eventTypes.SELECT:\n\t\t\t\t\tthis._moveOK = false;\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\t\n\t\tif (type == eventTypes.START) {\n\t\t\tthis._isDown = true;\n\t\t} else if (type == eventTypes.SELECT) {\n\t\t\tthis._isDown = false;\n\t\t\t\n\t\t\tif (this._toggleNode) {\n\t\t\t\tdocument.body.removeChild(this._toggleNode);\n\t\t\t\tdocument.body.appendChild(this._toggleNode);\n\t\t\t}\n\t\t}\n\t\t\n\t\tvar inputEvent = new input.InputEvent(id, type, x, y);\n\t\tif (device.useDOM) {\n\t\t\twhile (target && !target._view) {\n\t\t\t\ttarget = target.parentNode;\n\t\t\t}\n\t\t\tif (!target) { return; }\n\t\t\tinputEvent.target = target._view;\n\t\t}\n\t\t\n\t\tif (type == eventTypes.SCROLL) {\n\t\t\t// try to normalize scroll events! :-(\n\t\t\t\n\t\t\t// some browsers send both horizontal and vertical offsets in one event! nice!\n\t\t\t// other browsers don't. This is awful, since this is the least common denominator!\n\t\t\t// so we have to send two events even if the browser only sends one.\n\t\t\tif ('wheelDeltaX' in evt) {\n\t\t\t\t// default to Y\n\t\t\t\tinputEvent.scrollDelta = evt.wheelDeltaY / 120;\n\t\t\t\tinputEvent.scrollAxis = input.VERTICAL_AXIS;\n\n\t\t\t\t// if we also have X, then send it as a separate event\n\t\t\t\tif (evt.wheelDeltaX && evt.wheelDeltaY) {\n\t\t\t\t\tvar e = inputEvent.clone();\n\t\t\t\t\te.scrollDelta = evt.wheelDeltaX / 120;\n\t\t\t\t\te.scrollAxis = input.HORIZONTAL_AXIS;\n\n\t\t\t\t\tinput.dispatchEvent(this._rootView, e);\n\t\t\t\t} else if (evt.wheelDeltaX) {\n\t\t\t\t\t// we only have one of (X, Y) and it's X, so use X\n\t\t\t\t\tinputEvent.scrollDelta = evt.wheelDeltaX / 120;\n\t\t\t\t\tinputEvent.scrollAxis = input.HORIZONTAL_AXIS;\n\t\t\t\t}\n\n\t\t\t} else if (evt.detail) {\n\t\t\t\tinputEvent.scrollDelta = -evt.detail;\n\t\t\t\tinputEvent.scrollAxis = 'axis' in evt ? evt.axis == evt.VERTICAL_AXIS ? input.VERTICAL_AXIS : input.HORIZONTAL_AXIS : input.VERTICAL_AXIS;\n\t\t\t} else if (evt.wheelDelta) { // IE/Opera\n\t\t\t\tinputEvent.scrollDelta = (window.opera ? 1 : -1) * evt.wheelDelta / 120;\n\t\t\t\tinputEvent.scrollAxis = input.VERTICAL_AXIS;\n\t\t\t}\n\t\t}\n\n\t\tinput.dispatchEvent(this._rootView, inputEvent);\n\t}\n\t\n});\n","pre":true},"sdk/timestep/platforms/browser/InputPrompt.js":{"path":"sdk/timestep/platforms/browser/InputPrompt.js","friendlyPath":".InputPrompt","directory":"sdk/timestep/platforms/browser/","filename":"InputPrompt.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * package timestep.env.browser.InputPrompt;\n *\n * Prompt the user manually for input.\n *\n * ??? TODO Move this to debug, probably. A native modal prompt has no place\n *          in game code.\n */\nvar KeyboardTypes = {\n\tDefault: 0,                // Default type for the current input method.\n    NumbersAndPunctuation: 2,  // Numbers and assorted punctuation.\n    URL: 3,                    // A type optimized for URL entry (shows . / .com prominently).\n    NumberPad: 4,              // A number pad (0-9). Suitable for PIN entry.\n    PhonePad: 5,               // A phone pad (1-9, *, 0, #, with letters under the numbers).\n    EmailAddress: 7,           // A type optimized for multiple email address entry (shows space @ . prominently).\n    DecimalPad: 8\n}\n\nvar sdk_timestep_platforms_browser_InputPrompt=__class__;exports=sdk_timestep_platforms_browser_InputPrompt(function sdk_timestep_platforms_browser_InputPrompt(){return this.init&&this.init.apply(this,arguments)},function () {\n\tvar defaults = {\n\t\tonChange: function () {},\n\t\ttitle: '',\n\t\tmessage: '',\n\t\tvalue: '',\n\t\tprompt: ''\n\t}\n\n\tthis.init = function (opts) {\n\t\topts = merge(opts, defaults);\n\t\tthis.onChange = opts.onChange;\n\t\tthis.onSubmit = opts.onSubmit;\n\t\tthis._value = opts.value;\n\t\tthis._message = opts.title || opts.message || opts.prompt;\n\t};\n\n\tthis.show = function () {\n\t\tvar value = window.prompt(this._message, this._value);\n\t\tif (value !== null) { // returns null if user presses cancel\n\t\t\tthis._value = value;\n\t\t\tthis.onChange && this.onChange(value);\n\t\t\tthis.onSubmit && this.onSubmit(value);\n\t\t} else {\n\t\t\t// TODO: do something else on cancel?\n\t\t\tthis.onChange && this.onChange(value);\n\t\t}\n\t};\n\n\tthis.getValue = function () {\n\t\treturn this._value;\n\t};\n\n\tthis.setValue = function (value) {\n\t\tthis._value = value;\n\t\treturn this;\n\t};\n\n\tthis.setMessage = function (message) {\n\t\tthis._message = message;\n\t\treturn this;\n\t};\n\n\tthis.setOkButton = function (value) {\n\t\tthis._okText = value;\n\t\treturn this;\n\t}\n\n\tthis.setCancelButton = function (value) {\n\t\tthis._cancelText = value;\n\t\treturn this;\n\t}\n\n\tthis.setKeyboardType = function(keyboardType) {\n\t\tlogger.warn('Setting keyboard type in the browser does nothing');\n\t\treturn this;\n\t};\n\n\tthis.requestFocus = function() { this.show(); return this; }\n\n\tthis.closeEditField = function() {}\n\n\tthis.setHint = function() {}\n\n\tthis.refresh = function() {}\n});\n\nexports.showStatusBar = function() {};\nexports.hideStatusBar = function() {};\nexports.KeyboardTypes = KeyboardTypes;\n","pre":true},"sdk/timestep/platforms/browser/KeyListener.js":{"path":"sdk/timestep/platforms/browser/KeyListener.js","friendlyPath":".KeyListener","directory":"sdk/timestep/platforms/browser/","filename":"KeyListener.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * package timestep.env.browser.KeyListener;\n *\n * Listen to pressed keys and expose them using a altogether too public API.\n * An independent KeyListener is exposed for the Application Engine and any\n * Views with a Focus Manager.\n */\n\njsio(\"import lib.PubSub as PubSub\");\njsio(\"import lib.Enum\");\n\njsio(\"import event.input.keys as keyConstants\");\njsio(\"import device\");\njsio(\"import timer\");\n\njsio(\"from util.browser import $\");\n\nvar gListenerSingleton = null;\nvar gCancelKeys = lib.Enum(keyConstants.SPACE, keyConstants.LEFT, keyConstants.RIGHT, keyConstants.UP, keyConstants.DOWN);\n\nvar sdk_timestep_platforms_browser_KeyListener=__class__;exports=sdk_timestep_platforms_browser_KeyListener(function sdk_timestep_platforms_browser_KeyListener(){return this.init&&this.init.apply(this,arguments)},function () {\n\tthis.init = function (el, events) {\n\t\tif (gListenerSingleton) { return gListenerSingleton; }\n\t\tgListenerSingleton = this;\n\t\t\n\t\tthis._el = el = el || document;\n\t\tthis._events = [];\n\t\tthis._shortcuts = [];\n\t\tthis._isEnabled = true;\n\t\tthis._keyMap = {};\n\t\t\n\t\t$.onEvent(el, 'keydown', this, 'onKeyDown');\n\t\t$.onEvent(el, 'keypress', this, 'onKeyPress');\n\t\t$.onEvent(el, 'keyup', this, 'onKeyUp');\n\t\t$.onEvent(window, 'blur', this, 'liftAll');\n\t}\n\t\n\tthis.setEnabled = function (isEnabled) { this._isEnabled = isEnabled; }\n\n\tthis.captureShortcut = function (shortcut) {\n\t\tthis._shortcuts.push(shortcut);\n\t}\n\t\n\tthis.getPressed = function () { return this._keyMap; }\n\n\tthis.onKeyDown = function (e) {\n\t\t\n\t\tif (!this._isEnabled) { return; }\n\t\t\n\t\tvar evt = {\n\t\t\tcode: e.keyCode,\n\t\t\tctrl: e.ctrlKey,\n\t\t\tshift: e.shiftKey,\n\t\t\talt: e.altKey,\n\t\t\tmeta: e.metaKey, // for mac keyboards\n\t\t\tlifted: false,\n\t\t\tdt: timer.getTickProgress()\n\t\t};\n\t\t\n\t\tif (evt.ctrl || evt.shift || evt.alt || evt.meta) {\n\t\t\tvar captured = false;\n\t\t\tfor (var i = 0, s; s = this._shortcuts[i]; ++i) {\n\t\t\t\tif (s.compare(evt)) {\n\t\t\t\t\ts.publish('Down', evt);\n\t\t\t\t\tcaptured = true;\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tif (captured) { $.stopEvent(e); }\n\t\t\treturn;\n\t\t} else {\n\t\t\t// MUST cancel event if we're enabled to prevent browser\n\t\t\t// default behaviors (e.g. scrolling)\n\t\t\t$.stopEvent(e);\n\t\t}\n\t\t\n\t\t// We already know that key is down; ignore repeat events.\n\t\tif (e.keyCode in this._keyMap) { return; }\n\t\t\n\t\tthis._events.push(evt);\n\t\tthis._keyMap[e.keyCode] = +new Date();\n\t}\n\t\n\tthis.liftAll = function () {\n\t\tvar progressDt = timer.getTickProgress();\n\t\tfor (var code in this._keyMap) {\n\t\t\tthis._events.push({\n\t\t\t\tcode: code,\n\t\t\t\tlifted: true,\n\t\t\t\tdt: progressDt\n\t\t\t});\n\t\t}\n\t\tthis._keyMap = {};\n\t}\n\t\n\tthis.onKeyUp = function (e) {\n\t\tvar progressDt = timer.getTickProgress();\n\t\tdelete this._keyMap[e.keyCode];\n\t\tthis._events.push({\n\t\t\tcode: e.keyCode,\n\t\t\tlifted: true,\n\t\t\tdt: progressDt\n\t\t});\n\t\t$.stopEvent(e);\n\t}\n\t\n\tthis.onKeyPress = function (e) {\n\t\tif (!this._isEnabled) { return; }\n\t\tif (e.keyCode in gCancelKeys) {\n\t\t\t$.stopEvent(e);\n\t\t}\n\t}\n\t\n\tthis.peekEvents = function () { return this._events; }\n\tthis.popEvents = function () { return this._events.splice(0, this._events.length); }\n});\n\n// TODO: for maximum compatibility, especially with foreign keyboards, this needs to be inferred from the browser.  I think we can rely on a single DOM key event to get the constants in most browsers.\nmerge(exports.prototype, keyConstants);\n\nexports.Shortcut=__class__;exports.Shortcut=exports.Shortcut(function exports_Shortcut(){return this.init&&this.init.apply(this,arguments)},PubSub, function () {\n\tthis.init = function (keyCode, ctrl, shift, alt, meta) {\n\t\tthis.ctrl = !!ctrl;\n\t\tthis.shift = !!shift;\n\t\tthis.alt = !!alt;\n\t\tthis.meta = !!meta;\n\t\tthis.code = !!keyCode;\n\t}\n\t\n\tthis.compare = function (shortcut) {\n\t\treturn this.ctrl == shortcut.ctrl \n\t\t\t&& this.alt == shortcut.alt\n\t\t\t&& this.meta == shortcut.meta\n\t\t\t&& this.shift == shortcut.shift\n\t\t\t&& this.code == shortcut.code;\n\t}\n});\n","pre":true},"sdk/timestep/event/input/keys.js":{"path":"sdk/timestep/event/input/keys.js","friendlyPath":"event.input.keys","directory":"sdk/timestep/event/input/","filename":"keys.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @module event.input.keys\n * Map browser keycodes to corresponding keys.\n */\n\nexports = {\n\tBACKSPACE: 8,\n\tTAB: 9,\n\tENTER: 13,\n\tSHIFT: 16,\n\tCTRL: 17,\n\tALT: 18,\n\tPAUSE: 19,\n\tBREAK: 19,\n\tCAPS: 20,\n\tCAPS_LOCK: 20,\n\tESCAPE: 27,\n\tSPACE: 32,\n\tPAGE_UP: 33,\n\tPAGE_DOWN: 34,\n\tEND: 35,\n\tHOME: 36,\n\tLEFT: 37,\n\tUP: 38,\n\tRIGHT: 39,\n\tDOWN: 40,\n\tPRINT_SCREEN: 44,\n\tINSERT: 45,\n\tDELETE: 46,\n\tMETA_LEFT: 91,\n\tWIN_LEFT: 91,\n\tMETA_RIGHT: 92,\n\tWIN_RIGHT: 92,\n\tSELECT: 93,\n\tEQUAL: 187,\n\tMINUS: 189,\n\tF1: 112,\n\tF2: 113,\n\tF3: 114,\n\tF4: 115,\n\tF5: 116,\n\tF6: 117,\n\tF7: 118,\n\tF8: 119,\n\tF9: 120,\n\tF10: 121,\n\tF11: 122,\n\tF12: 123,\n\tMUTE: 173,\n\tVOL_DOWN: 174,\n\tVOL_UP: 175,\n\tFORWARD: 176,\n\tBACK: 177,\n\tSTOP: 178,\n\tPLAY_PAUSE: 179\n};\n","pre":true},"sdk/timestep/platforms/browser/MobileBrowserAPI.js":{"path":"sdk/timestep/platforms/browser/MobileBrowserAPI.js","friendlyPath":".MobileBrowserAPI","directory":"sdk/timestep/platforms/browser/","filename":"MobileBrowserAPI.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\njsio(\"import lib.PubSub\");\njsio(\"import device\");\njsio(\"from util.underscore import _\");\n\n/**\n * @extends lib.PubSub\n */\nvar sdk_timestep_platforms_browser_MobileBrowserAPI=__class__;var AudioAPI = exports=sdk_timestep_platforms_browser_MobileBrowserAPI(function sdk_timestep_platforms_browser_MobileBrowserAPI(){return this.init&&this.init.apply(this,arguments)},lib.PubSub, function (supr) {\n\n\tvar defaults = {\n\t\toneChannelOnly: device.isMobileBrowser,\n\t\tcompiledFilename: 'compiled'\n\t};\n\n\tthis.init = function (opts) {\n\t\topts = merge(opts, defaults);\n\t\tsupr(this, 'init', [opts]);\n\t\tthis._opts = opts;\n\t\tthis._map = opts.map;\n\t\tthis._audios = {};\n\t\tthis.oneChannelOnly = opts.oneChannelOnly;\n\n\t\tsetInterval(bind(this, '_ontimeupdate'), 200);\n\t\t\n\t\tif (!this.oneChannelOnly) {\n\t\t\t_.each(opts.background, function (name) {\n\t\t\t\topts.map[name] = {'name': name}\n\t\t\t}, this);\n\t\t}\n\n\t\t// Install the event listener right away. Set usecapture=true so that\n\t\t// nothing else will affect us from intercepting this event.\n\n\t\tthis._load();\n\t\tif (this.oneChannelOnly) {\n\t\t\tthis._boundLoadHandler = bind(this, '_playFirst');\n\t\t\tdocument.body.addEventListener(device.events.start, \n\t\t\t\t\t\t\t\t\t\t   this._boundLoadHandler, true);\n\t\t}\n\t\twindow.addEventListener('pagehide', bind(this, 'pause'), false);\n\t}\n\n\tthis._createChannel = function (name, src) {\n\t\tvar audio = new Audio(src);\n\t\tthis._audios[name] = audio;\n\n\t\taudio.addEventListener('error', bind(this, '_onerror'));\n\t\taudio.addEventListener('timeupdate', bind(this, '_ontimeupdate'));\n\n\t\taudio.load();\n\t}\n\n\tthis.setMuted = function (muted) {\n\t\tthis.muted = muted;\n\t\tif (muted) {\n\t\t\tthis.setVolume(0);\n\t\t}\n\t}\n\t\n\tthis.setVolume = function (volume) {\n\t\t_.each(this._audios, function (audio, key) {\n\t\t\taudio.volume = volume;\n\t\t});\n\t}\n\n\tthis.unload = function () {\n\t\tthis.pause();\n\t\t_.each(this._audios, function (audio, key) {\n\t\t\taudio.src = '';\n\t\t}, this);\n\t\t// TODO remove event listeners\n\t}\n\n\tthis._load = function () {\n\t\n\t\tthis._audios = {};\n\t\tvar path = this._opts.path.replace(/\\/$/, '');\n\t\tif (this.oneChannelOnly) {\n\t\t\tthis._createChannel('AUDIO', path + '/' + this._opts.compiledFilename + '.m4a');\n\t\t} else {\n\t\t\tfor (var key in this._map) if (this._map.hasOwnProperty(key)) {\n\t\t\t\tif (key == 'SILENCE') { continue; }\n\t\t\t\tthis._createChannel(key, path + '/' + key + '.mp3');\n\t\t\t}\n\t\t}\n\n\t\tlogger.info('now loading', this._opts.src);\n\n\t\tif (!this._publishedReady) {\n\t\t\tthis.publish('Ready'); // this is as close as we'll get with multiple sounds\n\t\t\tthis._publishedReady = true;\n\t\t}\n\t}\n\n\tthis._playFirst = function () {\n\t\tdocument.body.removeEventListener(device.events.start, \n\t\t\t\t\t\t\t\t\t\t  this._boundLoadHandler, true);\n\t\t\n\t\tthis._audios['AUDIO'].play();\n\t}\n\n\tthis._ontimeupdate = function (evt) {\n\t\t_.each(this._audios, function (audio, key) {\n\t\t\tif (audio.paused && !audio._pausedOnce) {\n\t\t\t\taudio.pause();\n\t\t\t\taudio._pausedOnce = true;\n\t\t\t\taudio._ready = true;\n\t\t\t}\n\n\t\t\tif (this.oneChannelOnly) {\n\t\t\t\tif (!this._nowPlaying || audio.currentTime >= this._nowPlaying.end) {\n\t\t\t\t\tthis.play('SILENCE');\n\t\t\t\t}\n\t\t\t}\n\t\t}, this);\n\n\t}\n\t\n\tthis._onerror = function (event) {\n\t\tvar s = '';\n\t\tfor (var key in event) {\n\t\t\ts += event[key] + ' ';\n\t\t}\n\t\tlogger.info('ERROR', s);\n\t\t// this.unload();\n\t\t// this.publish('AudioError', event);\n\t\t// this._status = 'error';\n\t}\n\n\tthis.canPlay = function (name) {\n\t\tif (!this._map[name]) { return false; }\n\n\t\tvar requiredEnd = null;\n\t\tif (this.oneChannelOnly) {\n\t\t\trequiredEnd = this._map[name].end;\n\t\t\tname = 'AUDIO';\n\t\t}\n\t\tvar audio = this._audios[name];\n\t\tif (!audio) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// if (!audio._ready) {\n\t\t// \treturn; // try downloading the whole file...\n\t\t// }\n\t\tif (audio._ready || !requiredEnd) {\n\t\t\treturn true;\n\t\t} else {\n\t\t\ttry {\n\t\t\t\tvar end = audio.seekable.end()\n\t\t\t\treturn (requiredEnd <= end);\n\t\t\t} catch(e) {\n\t\t\t\tlogger.log(e);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t}\n\n\tthis.play = function (name, volume, loop) {\t\t\n\t\tif (this.muted) { return; }\n\n\t\tif (volume === undefined) {\n\t\t\tvolume = 1.0;\n\t\t}\n\t\tif (!this.canPlay(name)) {\n\t\t\tlogger.info('Not ready yet');\n\t\t\treturn;\n\t\t}\n\n\t\tvar audio = this._audios[this.oneChannelOnly ? 'AUDIO' : name];\n\t\ttry {\n\t\t\tif (!audio.paused) {\n\t\t\t\taudio.pause(); // it glitches if you move currentTime while playing?\n\t\t\t}\n\t\t\tvar startTime = 0;\n\t\t\tif (this.oneChannelOnly && this._map[name].start != null) {\n\t\t\t\tstartTime = this._map[name].start;\n\t\t\t}\n\t\t\tif (audio.currentTime != startTime) {\n\t\t\t\t// logger.log('SEEK to play',name, startTime, 'from',audio.currentTime); // \n\t\t\t\taudio.currentTime = startTime;\n\t\t\t}\n\t\t\taudio.volume = volume;\n\t\t\taudio.play();\n\t\t\tthis._nowPlaying = this._map[name];\n\t\t} catch(e) {\n\t\t\t\n\t\t}\n\t}\n\t\n\tthis.pause = function () {\n\t\t_.each(this._audios, function (audio, key) {\n\t\t\taudio.pause();\n\t\t}, this);\n\t}\n\n\tthis.playBackgroundMusic = function (name, volume) {\n\t\tif (this.muted) { return; }\n\n\t\tif (this.oneChannelOnly) {\n\t\t\treturn false; // cannot play bg music here.\n\t\t}\n\n\t\tthis._backgroundSoundPlaying = name;\n\t\tthis.play(name, volume);\n\t}\n\n\tthis.pauseBackgroundMusic = function () {\n\t\tif (!this._backgroundSoundPlaying) { return; }\n\t\tthis._audios[this._backgroundSoundPlaying].pause();\n\t}\n\n});\n","pre":true},"sdk/timestep/platforms/browser/StatusBar.js":{"path":"sdk/timestep/platforms/browser/StatusBar.js","friendlyPath":".StatusBar","directory":"sdk/timestep/platforms/browser/","filename":"StatusBar.js","src":"exports.show = function () {\n\n}\n\nexports.hide = function () {\n\n}\n\nexports.getHeight = function () {\n\treturn 0;\n}","pre":true},"sdk/timestep/platforms/browser/TextBox.js":{"path":"sdk/timestep/platforms/browser/TextBox.js","friendlyPath":".TextBox","directory":"sdk/timestep/platforms/browser/","filename":"TextBox.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n\"use import\";\n\n/**\n * package timestep.env.browser.TextBox;\n *\n * A textbox for inputting user data.\n */\n\njsio(\"from util.browser import $\");\n\nvar sdk_timestep_platforms_browser_TextBox=__class__;exports=sdk_timestep_platforms_browser_TextBox(function sdk_timestep_platforms_browser_TextBox(){return this.init&&this.init.apply(this,arguments)},function () {\n\t\n\tvar defaultStyle = {\n\t\tpadding: 0,\n\t\tlineHeight: 1.4,\n\t\tborder: 'none',\n\t\tdisplay: 'none',\n\t\ttextAlign: 'center',\n\t\tverticalAlign: 'middle',\n\t\tfontSize: 16,\n\t\tfontFamily: null,\n\t\tfontWeight: '',\n\t\topacity: 1,\n\t\tposition: \"absolute\",\n\t\tbackgroundColor: \"transparent\",\n\t\ttop: 0,\n\t\tleft: 0\n\t};\n\t\n\tthis.init = function (opts) {\n\t\topts = merge(opts, {\n\t\t\tcolor: 'black',\n\t\t\theight: 20\n\t\t});\n\n\t\tvar style = merge({}, defaultStyle);\n\t\tif (opts.color) { style.color = opts.color; }\n\t\t\n\t\tthis._el = $({\n\t\t\ttag: opts.multiLine ? \"textarea\" : \"input\",\n\t\t\tattrs: {type: \"text\"}, \n\t\t\tstyle: style\n\t\t});\n\n\t\t$.onEvent(this._el, 'blur', this, 'onBlur');\n\t\t$.onEvent(this._el, 'focus', this, 'onFocus');\n\t\t$.onEvent(this._el, 'change', this, 'onChange');\n\t\t$.onEvent(this._el, 'click', this, 'onClick');\n\t}\n\t\n\tthis.onBlur = \n\tthis.onFocus =\n\tthis.onChange =\n\tthis.onClick = function () {}\n\t\n\tthis.destroy = function () {\n\t\t$.remove(this._el);\n\t\tthis._el = null;\n\t}\n\t\n\tthis.setApp = function (app) {\n\t\tif (app != this._app || !this._el.parentNode) {\n\t\t\tthis._app = app;\n\t\t\tvar canvas = app._ctx.canvas;\n\t\t\tlogger.log('setting parent', this._el);\n\t\t\tcanvas.parentNode.appendChild(this._el);\n\t\t}\n\t}\n\t\n\tthis.change = function () {\n\t\t\n\t}\n\t\n\tthis.click = function () {\n\t}\n\t\n\tthis.selectAll = function () {\n\t\tthis._el.focus();\n\t\tthis._el.select();\n\t}\n\t\n\tthis.show = function () { $.show(this._el); }\n\tthis.hide = function () { $.hide(this._el); }\n\t\n\tthis.setValue = function (value) { this._el.value = value; return this; }\n\tthis.setOpacity = function (o) { this._el.style.opacity = o; return this; }\n\tthis.setType = function (type) { this._el.type = type; return this; }\n\tthis.setVisible = function (isVisible) { return this[isVisible ? 'show': ' hide'](); }\n\tthis.getX = function () { return parseInt(this._el.style.left); }\n\tthis.getY = function () { return parseInt(this._el.style.top); }\n\tthis.getWidth = function () { return this._el.offsetWidth; }\n\tthis.getHeight = function () { return this._el.offsetHeight; }\n\tthis.getValue = function () { return this._el.value; }\n\tthis.getOpacity = function () { return this._el.style.opacity; }\n\tthis.getType = function () { return this._el.type; }\n\tthis.getVisible = function () { return this._el.parentNode && this._el.style.display == 'block'; }\n\t\n\tthis.setPosition = function (p) { this._el.style.top = p.y + 'px'; this._el.style.left = p.x + 'px'; }\n\tthis.getPosition = function () { return {x: this.getX(), y: this.getY()}; }\n\t\n\tthis.setDimensions = function (d) { this._el.style.width = d.width + 'px'; this._el.style.height = d.height + 'px'; return this; }\n\tthis.getDimensions = function () { return {width: this.getWidth(), height: this.getHeight()}; }\n});\n","pre":true},"sdk/timestep/platforms/browser/TextInput.js":{"path":"sdk/timestep/platforms/browser/TextInput.js","friendlyPath":".TextInput","directory":"sdk/timestep/platforms/browser/","filename":"TextInput.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n\"use import\";\n\n/**\n * package timestep.env.browser.TextInput;\n *\n * A textbox for inputting user data.\n */\n\njsio(\"import lib.PubSub\");\njsio(\"from util.browser import $\");\n\n/**\n * @extends lib.PubSub\n */\nvar sdk_timestep_platforms_browser_TextInput=__class__;exports=sdk_timestep_platforms_browser_TextInput(function sdk_timestep_platforms_browser_TextInput(){return this.init&&this.init.apply(this,arguments)},lib.PubSub, function () {\n\tthis.init = function (opts) {\n\t\tthis._el = $({\n\t\t\ttag: 'input',\n\t\t\tparent: document.body,\n\t\t\tstyle: {\n\t\t\t\tposition: 'absolute',\n\t\t\t\tleft: '-100px',\n\t\t\t\ttop: '-100px'\n\t\t\t},\n\t\t\tattrs: {\n\t\t\t\ttype: 'text',\n\t\t\t\tvalue: opts && opts.value || ''\n\t\t\t}\n\t\t});\n\t\tthis._value = this._el.value;\n\t\tthis._selectionStart = 0;\n\t\tthis._selectionEnd = 0;\n\t\t\n\t\t$.onEvent(this._el, 'keydown', this, 'checkValue');\n\t\t$.onEvent(this._el, 'keyup', this, 'checkValue');\n\t\t$.onEvent(this._el, 'keypress', this, 'checkValue');\n\t\t$.onEvent(this._el, 'focus', this, 'onFocus');\n\t\t$.onEvent(this._el, 'blur', this, 'onBlur');\n\t}\n\t\n\tthis.onFocus = function () { this.publish('Focus'); }\n\tthis.onBlur = function () { this.publish('Blur'); }\n\t\n\tthis.checkValue = function (evt) {\n\t\tvar target = evt.target,\n\t\t\tstart = target.selectionStart,\n\t\t\tend = target.selectionEnd;\n\t\t\n\t\tvar value = this._el.value;\n\t\t\n\t\tif (value != this._value) {\n\t\t\tthis.publish('ChangeValue', value);\n\t\t\tthis._value = value;\n\t\t}\n\t\t\n\t\tif (start != this._selectionStart) {\n\t\t\tthis._selectionStart = start;\n\t\t\tthis.publish('ChangeSelectionStart', start);\n\t\t}\n\t\t\n\t\tif (end != this._selectionEnd) {\n\t\t\tthis._selectionEnd = end;\n\t\t\tthis.publish('ChangeSelectionEnd', end);\n\t\t}\n\t}\n\t\n\tthis.focus = function () { logger.log('focus'); this._el.focus(); }\n\tthis.blur = function () { this._el.blur(); }\n});\n\n\n// Set desired tab- defaults to four space softtab\nvar tab = '    ',\n\ttabLength = 4;\n\nArray.prototype.map.call(document.getElementsByTagName('textarea'), function (el) {\n\tel.addEventListener('keydown', checkTab, false);\n});\n\nfunction checkTab(evt) {\n\tvar t = evt.target;\n\tvar ss = t.selectionStart;\n\tvar se = t.selectionEnd;\n \n\t// Tab key - insert tab expansion\n\tif (evt.keyCode == 9) {\n\t\tevt.preventDefault();\n\t\t\n\t\tif (evt.shiftKey) {\n\t\t\t// Special case of multi line selection\n\t\t\tif (ss != se && t.value.slice(ss,se).indexOf('\\n') != -1) {\n\t\t\t\t// In case selection was not of entire lines (e.g. selection begins in the middle of a line)\n\t\t\t\t// we ought to tab at the beginning as well as at the start of every following line.\n\t\t\t\tvar i = ss;\n\t\t\t\twhile(i && t.value.charAt(i - 1) != '\\n') { --i; }\n\t\t\t\tvar pre = t.value.slice(0, i);\n\t\t\t\tvar post = t.value.slice(se, t.value.length);\n\t\t\t\tvar sel = t.value.slice(i, se).replace(\n\t\t\t\t\tnew RegExp('(^|\\n)' + tab, 'g'),\n\t\t\t\t\tfunction (match) {\n\t\t\t\t\t\tse -= tab.length;\n\t\t\t\t\t\tif (match.charAt(0) == '\\n') {\n\t\t\t\t\t\t\treturn '\\n';\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tss -= tab.length;\n\t\t\t\t\t\t\treturn '';\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\tt.value = pre.concat(sel).concat(post);\n\n\t\t\t\tt.selectionStart = ss;\n\t\t\t\tt.selectionEnd = se;\n\t\t\t} else {\n\t\t\t\t// \"Normal\" case (no selection or selection on one line only)\n\n\t\t\t\tvar i = ss;\n\t\t\t\twhile(i && t.value.charAt(i - 1) != '\\n') { --i; }\n\t\t\t\tif (t.value.substring(i, i + tab.length) == tab) {\n\t\t\t\t\tt.value = t.value.slice(0, i).concat(t.value.slice(i + tab.length, t.value.length));\n\t\t\t\t\tif (ss == se) {\n\t\t\t\t\t\tt.selectionStart = t.selectionEnd = ss - (ss == i ? 0 : tab.length);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tt.selectionStart = ss - (ss == i ? 0 : tab.length);\n\t\t\t\t\t\tt.selectionEnd = se - tab.length;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t// Special case of multi line selection\n\t\t\tif (ss != se && t.value.slice(ss,se).indexOf(\"\\n\") != -1) {\n\t\t\t\t// In case selection was not of entire lines (e.g. selection begins in the middle of a line)\n\t\t\t\t// we ought to tab at the beginning as well as at the start of every following line.\n\t\t\t\tvar i = ss;\n\t\t\t\twhile(i && t.value.charAt(i - 1) != '\\n') { --i; }\n\t\t\t\tvar pre = t.value.slice(0, i);\n\t\t\t\tvar post = t.value.slice(se, t.value.length);\n\t\t\t\tvar sel = t.value.slice(i, se).replace(/\\n/g, function () {\n\t\t\t\t\tse += tab.length;\n\t\t\t\t\treturn '\\n' + tab;\n\t\t\t\t});\n\t\t\t\tt.value = pre.concat(tab).concat(sel).concat(post);\n\n\t\t\t\tt.selectionStart = ss + tab.length;\n\t\t\t\tt.selectionEnd = se + tab.length;\n\t\t\t} else {\n\t\t\t\t// \"Normal\" case (no selection or selection on one line only)\n\n\t\t\t\tvar i = ss;\n\t\t\t\twhile(i && t.value.charAt(i - 1) != '\\n') { --i; }\n\n\t\t\t\tt.value = t.value.slice(0, i).concat(tab).concat(t.value.slice(i, t.value.length));\n\n\t\t\t\tif (ss == se) {\n\t\t\t\t\tt.selectionStart = t.selectionEnd = ss + tab.length;\n\t\t\t\t} else {\n\t\t\t\t\tt.selectionStart = ss + tab.length;\n\t\t\t\t\tt.selectionEnd = se + tab.length;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t} else if (evt.shiftKey || evt.metaKey || evt.ctrlKey) {\n\t\treturn;\n\t} else if (evt.keyCode == 8 && t.value.slice(ss - tabLength, ss) == tab) {\n\t\t// Backspace key - delete preceding tab expansion, if exists\n\t\tevt.preventDefault();\n\t\t\n\t\tt.value = t.value.slice(0,ss - tabLength).concat(t.value.slice(ss,t.value.length));\n\t\tt.selectionStart = t.selectionEnd = ss - tab.length;\n\t} else if (evt.keyCode == 46 && t.value.slice(se, se + tabLength) == tab) {\n\t\t// Delete key - delete following tab expansion, if exists\n\t\tevt.preventDefault();\n\t\t\n\t\tt.value = t.value.slice(0,ss).concat(t.value.slice(ss + tabLength,t.value.length));\n\t\tt.selectionStart = t.selectionEnd = ss;\n\t} else if (evt.keyCode == 37 && t.value.slice(ss - tabLength, ss) == tab) {\n\t\t// Left/right arrow keys - move across the tab in one go\n\t\tevt.preventDefault();\n\t\tt.selectionStart = t.selectionEnd = ss - tabLength;\n\t} else if (evt.keyCode == 39 && t.value.slice(ss, ss + tabLength) == tab) {\n\t\tevt.preventDefault();\n\t\tt.selectionStart = t.selectionEnd = ss + tabLength;\n\t}\n}\n","pre":true},"sdk/timestep/platforms/browser/Timer.js":{"path":"sdk/timestep/platforms/browser/Timer.js","friendlyPath":".Timer","directory":"sdk/timestep/platforms/browser/","filename":"Timer.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * package timestep.env.browser.Timer;\n *\n * System timer exposed to the device.\n */\n\nvar _onTick = null,\n\tdisableRequestAnimFrame = false,\n\tdisablePostMessage = true,\n\tasFastAsPossible = false,\n\tMIN_DT = 16;\n\nif (window.postMessage) {\n\tfunction postMessageCb(evt) { if (evt.data == 'timestep.TICK') { onFrame(); }}\n\t\n\tif (window.addEventListener) {\n\t\twindow.addEventListener('message', postMessageCb, false);\n\t} else {\n\t\twindow.attachEvent('onmessage', postMessageCb);\n\t}\n} else {\n\tdisablePostMessage = true;\n\ttickNow = sendTimeoutNow;\n}\n\nfunction sendPostMessage() { window.postMessage('timestep.TICK', '*'); }\nfunction sendTimeout() { setTimeout(onFrame, MIN_DT); }\nfunction sendTimeoutNow() { setTimeout(onFrame, 0); }\n\nvar fastDriver = sendTimeoutNow,\n\tmainDriver = sendTimeout;\n\nif (asFastAsPossible) {\n\tif (!disablePostMessage) {\n\t\tfastDriver = mainDriver = sendPostMessage;\n\t} else {\n\t\tmainDriver = sendTimeoutNow;\n\t}\n} else {\n\tvar reqAnim = !disableRequestAnimFrame && (\n\t\t\t\t\twindow.requestAnimationFrame\n\t\t\t\t|| window.webkitRequestAnimationFrame\n\t\t\t\t|| window.mozRequestAnimationFrame\n\t\t\t\t|| window.oRequestAnimationFrame\n\t\t\t\t|| window.msRequestAnimationFrame);\n\t\n\tif (reqAnim) {\n\t\tfastDriver = mainDriver = reqAnim;\n\t} else if (!disablePostMessage) {\n\t\tfastDriver = sendPostMessage;\n\t}\n}\n\n/*\nvar frameDts = [];\nvar print = false, frames = 0, lastPrint = 0;\nsetInterval(function () { print = true; }, 1000)\n\nvar slow = 0, fast = 0;\n*/\n\nfunction onFrame() {\n\tif (_onTick) {\n\t\tvar now = +new Date(),\n\t\t\tdt = now - (exports.last || now);\n\t\t\n\t\texports.last = now;\n\t\t\n\t\t//try {\n\t\t\t_onTick(dt);\n\t\t/*} catch (e) {\n\t\t\tif (window.DEV_MODE) {\n\t\t\t\tvar err = '.dev_error';\n\t\t\t\tjsio('import ' + err).render(e);\n\t\t\t\texports.stop();\n\t\t\t}\n\t\t}*/\n\n\t\t/*\n\t\tframeDts.push(dt);\n\t\tvar delay = +new Date() - now;\n\t\t++frames;\n\t\tif (print) {\n\t\t\tlogger.log(fast, slow, JSON.stringify(frameDts), now - lastPrint, dt, frames, delay);\n\t\t\tframeDts = [];\n\t\t\tlastPrint = now;\n\t\t\tprint = false;\n\t\t\tframes = 0;\n\t\t\tslow = 0;\n\t\t\tfast = 0;\n\t\t}\n\t\t*/\n\t\t\n\t\tif (dt > MIN_DT) {\n\t\t//\t++fast;\n\t\t\tfastDriver.call(window, onFrame);\n\t\t} else {\n\t\t//\t++slow;\n\t\t\tmainDriver.call(window, onFrame);\n\t\t}\n\t}\n}\n\nexports.last = null;\n\nexports.start = function (onTick) {\n\t_onTick = onTick;\n\tmainDriver.call(window, onFrame);\n}\n\nexports.stop = function () { _onTick = null; }\n","pre":true},"sdk/timestep/platforms/browser/EditText.js":{"path":"sdk/timestep/platforms/browser/EditText.js","friendlyPath":".EditText","directory":"sdk/timestep/platforms/browser/","filename":"EditText.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\njsio(\"from util.browser import $\");\njsio(\"import squill.Widget\");\njsio(\"import device\");\n\nvar __keyboardIsOpen = false;\n\nInputField=__class__;var InputField=InputField(function InputField(){return this.init&&this.init.apply(this,arguments)},squill.Widget, function (supr) {\n\n    this._def = {\n        tag: 'input',\n        parent: document.body,\n        style: {\n            position: 'absolute',\n            zIndex: '10000',\n            bottom: '0px',\n            left: '0px',\n            right: '0px'\n        }\n    }\n\n    this.buildWidget = function () {\n        this.initKeyEvents();\n        this.initFocusEvents();\n    }\n\n    this.setValue = function (value) {\n        this._el.value = value;\n        this._prevValue = value;\n    }\n\n    this.setCursor = function (cursorPos) {\n        this._el.selectionStart = this._el.selectionEnd = cursorPos;\n    }\n\n    this.setPlaceholder = function (placeholder) {\n        this._el.placeholder = placeholder;\n    }\n\n    this.setMaxLength = function (maxLength) {\n        this._el.maxlength = maxLength;\n    }\n\n    this.show = function () {\n        supr(this, 'show', arguments);\n\n        this._el.focus();\n    }\n\n    this.onKeyUp = function (evt) {\n        var el = this._el;\n        _focused && _focused.onChange(el.value, this._prevValue, el.selectionStart, el.selectionEnd);\n        this._prevValue = el.value;\n        if (evt.keyCode == 13) {\n            _focused && _focused.closeEditField();\n        }\n    }\n\n    this.getValue = function () { return this._el.value; }\n\n    this.onBlur = function (evt) {\n        this.hide();\n\t\tif (__keyboardIsOpen) {\n\t\t\t__keyboardIsOpen = false;\n\t\t\tvar ev = new Event('keyboardClosed');\n\t\t\tev.height = device.screen.height;\n\t\t\twindow.dispatchEvent(ev);\n\t\t}\n        _focused = null;\n        //_focused && _focused.closeEditField();\n    }\n\n})\n\nvar _input = new InputField();\n_input.hide();\n\nvar _focused = null;\n\nvar sdk_timestep_platforms_browser_EditText=__class__;exports=sdk_timestep_platforms_browser_EditText(function sdk_timestep_platforms_browser_EditText(){return this.init&&this.init.apply(this,arguments)},function () {\n\n    var defaults = {\n        hint: '',\n        inputType: 'default', // default | number | phone | password | capital\n        maxLength: -1\n    }\n\n\tthis.init = function (opts) {\n\t\tthis._opts = merge(opts, defaults);\n\n        this._textEditView = opts.textEditView;\n        this.onFocusChange = opts.onFocusChange || function() {};\n        this.onSubmit = opts.onSubmit || function () {}\n\t}\n\n    this.onChange = function (value, prevValue, cursorPos, selectionEnd) {\n        this._value = value;\n        if (this._opts.onChange) {\n            this._opts.onChange(value, prevValue, cursorPos);\n        }\n    }\n\n    this.getValue = function () {\n        return this._value;\n    }\n\n    this.setValue = function (value) {\n        this._value = value;\n        this.onChange(value);\n    }\n\n    this.requestFocus = function() {\n        if (_focused !== this) {\n            if (_focused != null) {\n                _focused.removeFocus(); \n\t\t\t}\n\n            this.onFocusChange(true);\n        }\n\n        _focused = this; \n    }\n\n    this.closeEditField = function() {\n        console.log(\"TextEditView editText removeFocus\");\n        if (_focused != null) {\n            _focused.removeFocus();\n        }\n\n        _input.hide();\n        // NATIVE.inputPrompt.hideSoftKeyboard(); \n\n\t\tif (__keyboardIsOpen) {\n\t\t\t__keyboardIsOpen = false;\n\t\t\tvar ev = new Event('keyboardClosed');\n\t\t\tev.height = device.screen.height;\n\t\t\twindow.dispatchEvent(ev);\n\t\t}\n     }\n\n    this.refresh = function(value, hasBack, hasForward, cursorPos) {\n\n        _input.setCursor(cursorPos);\n    \t_input.setValue(value);\n        _input.setPlaceholder(this._opts.hint);\n        _input.setMaxLength(this._opts.maxLength);\n        _input.show();\n\n\t\tif (!__keyboardIsOpen) {\n\t\t\t__keyboardIsOpen = true;\n\t\t\tvar ev = new Event('keyboardOpened');\n\t\t\tev.height = device.screen.height * .6;\n\t\t\twindow.dispatchEvent(ev);\n\t\t}\n\n    \t/*\n    \tif (hasBack) {\n\t\t\t_backButton.onSelect = bind(this, function () {\n\t\t\t\tthis._textEditView.focusPrevious());\n\t\t\t});\n\t\t\t_backButton.disabled = false;\n\t\t} else {\n\t\t\t_backButton.disabled = true;\n\t\t}\n\n    \tif (hasForward) {\n\t\t\t_forwardButton.onSelect = bind(this, function () {\n\t\t\t\tthis._textEditView.focusNext());\n\t\t\t});\n\t\t\t_forwardButton.disabled = false;\n\t\t} else {\n\t\t\t_forwardButton.disabled = true;\n\t\t}\n\n\t\t*/\n    }\n\n    this.hasFocus = function() {\n        return this == _focused;\n    }\n\n    this.removeFocus = function() {\n        this.onFocusChange(false);\n        this.onSubmit(_input.getValue());\n        if (_focused == this) {\n            _focused = null;    \n        }\n    }\n\n    this.setHint = function(hint) {\n        this._opts.hint = hint;\n    }\n});\n","pre":true},"sdk/squill/Alpha.js":{"path":"sdk/squill/Alpha.js","friendlyPath":".Alpha","directory":"sdk/squill/","filename":"Alpha.js","src":"\"use import\";\n\njsio(\"from util.browser import $\");\njsio(\"import .Widget\");\n\njsio(\"import .jscolor.jscolor as jscolor\");\n\nvar alphaSelect = false,\n\talphaIndicator;\n\nvar sdk_squill_Alpha=__class__;var Alpha = exports=sdk_squill_Alpha(function sdk_squill_Alpha(){return this.init&&this.init.apply(this,arguments)},Widget, function(supr) {\n\tthis._css = 'lph';\n\tthis._type = 'text';\n\n\tthis.init = function(params) {\n\t\tparams = merge(params, {tag: 'input'});\n\t\tsupr(this, 'init', [params]);\n\t};\n\n\tthis.buildWidget = function() {\n\t\tvar el = this._el;\n\n\t\tel.widget = this;\n\n\t\t$.onEvent(el, 'focus', this, '_onFocus');\n\t\t$.onEvent(el, 'blur', this, '_onBlur');\n\t\t$.onEvent(el, 'change', this, '_onChange');\n\n\t\tvar alphaGradient,\n\t\t\tctx,\n\t\t\tstyle,\n\t\t\trect;\n\n\t\tif (!alphaSelect) {\n\t\t\talphaSelect = document.createElement('div');\n\t\t\talphaSelect.style.display = 'none';\n\t\t\talphaSelect.className = 'colorMenu';\n\t\t\tdocument.body.appendChild(alphaSelect);\n\n\t\t\t$.onEvent(alphaSelect, 'mousedown', this, '_onSelect');\n\n\t\t\talphaGradient = document.createElement('canvas');\n\t\t\talphaGradient.width = 20;\n\t\t\talphaGradient.height = 100;\n\t\t\talphaSelect.appendChild(alphaGradient);\n\n\t\t\t$.style(\n\t\t\t\talphaGradient,\n\t\t\t\t{\n\t\t\t\t\t'float': 'left',\n\t\t\t\t\twidth: '20px',\n\t\t\t\t\theight: '100px',\n\t\t\t\t\tmargin: '8px 0 0 12px',\n\t\t\t\t\tborder: '1px solid #000',\n\t\t\t\t\tborderColor: 'ThreeDShadow ThreeDHighlight ThreeDHighlight ThreeDShadow',\n\t\t\t\t\tbackgroundColor: 'red'\n\t\t\t\t}\n\t\t\t);\n\t\t\t$.onEvent(alphaGradient, 'mousedown', this, '_onMouseDown');\n\t\t\t$.onEvent(alphaGradient, 'mousemove', this, '_onMouseMove');\n\t\t\t$.onEvent(alphaGradient, 'mouseup', this, '_onMouseUp');\n\t\t\t$.onEvent(alphaGradient, 'mouseout', this, '_onMouseOut');\n\n\t\t\talphaIndicator = document.createElement('img');\n\t\t\talphaIndicator.src = 'img/colorpicker/arrow.gif';\n\t\t\talphaSelect.appendChild(alphaIndicator);\n\n\t\t\t$.style(\n\t\t\t\talphaIndicator,\n\t\t\t\t{\n\t\t\t\t\tposition: 'absolute',\n\t\t\t\t\tleft: '4px',\n\t\t\t\t\ttop: '2px',\n\t\t\t\t\tborder: '0px hidden'\n\t\t\t\t}\n\t\t\t);\n\n\t\t\tctx = alphaGradient.getContext('2d');\n\t\t\tlinearGradient = ctx.createLinearGradient(0, 0, 0, 100);\n\t\t\tlinearGradient.addColorStop(0, '#FFFFFF');\n\t\t\tlinearGradient.addColorStop(1, '#000000');\n\t\t\tctx.fillStyle = linearGradient;\n\t\t\tctx.fillRect(0, 0, 20, 100);\n\t\t}\n\t};\n\n\tthis._showIndicator = function(alpha) {\n\t\tif (alpha < 0) {\n\t\t\talpha = 0;\n\t\t}\n\t\tif (alpha > 100) {\n\t\t\talpha = 100;\n\t\t}\n\n\t\t$.style(\n\t\t\talphaIndicator,\n\t\t\t{\n\t\t\t\tposition: 'absolute',\n\t\t\t\tleft: '4px',\n\t\t\t\ttop: (2 + alpha) + 'px',\n\t\t\t\tborder: '0px hidden'\n\t\t\t}\n\t\t);\n\n\t\treturn alpha;\n\t};\n\n\tthis._showMouseAlpha = function(evt) {\n\t\talphaSelect.target.value = 100 - this._showIndicator(evt.offsetY);\n\t\talphaSelect.widget.publish('Change', parseInt(alphaSelect.target.value, 10));\n\t};\n\n\tthis._onChange = function(evt) {\n\t\tvar value = this._el.value;\n\t\tif (!isNaN(value)) {\n\t\t\tvalue = parseInt(value, 10);\n\t\t\tif ((value >= 0) && (value <= 100)) {\n\t\t\t\talphaSelect.widget.publish('Change', value);\n\t\t\t}\n\t\t}\n\t};\n\n\tthis._onFocus = function(evt) {\n\t\tvar alpha,\n\t\t\tstyle = alphaSelect.style,\n\t\t\trect = this._el.getBoundingClientRect(),\n\t\t\tx = rect.right + 4,\n\t\t\ty = rect.top;\n\n\t\tif (y + 122 > window.innerHeight) {\n\t\t\ty = rect.bottom - 122;\n\t\t}\n\t\tif (x + 44 > window.innerWidth) {\n\t\t\tx = rect.left - 48;\n\t\t}\n\n\t\t$.style(\n\t\t\talphaSelect,\n\t\t\t{\n\t\t\t\tposition: 'absolute',\n\t\t\t\twidth: '44px',\n\t\t\t\theight: '122px',\n\t\t\t\tzIndex: '1000000',\n\t\t\t\tleft: x + 'px',\n\t\t\t\ttop: y + 'px',\n\t\t\t\tdisplay: 'block'\n\t\t\t}\n\t\t);\n\n\t\talphaSelect.widget = evt.target.widget;\n\t\talphaSelect.target = evt.target;\n\n\t\tif (isNaN(alphaSelect.target.value)) {\n\t\t\talpha = 0;\n\t\t} else {\n\t\t\talpha = parseInt(alphaSelect.target.value, 10);\n\t\t}\n\t\tthis._showIndicator(100 - alpha);\n\t};\n\n\tthis._onBlur = function(evt) {\n\t\talphaSelect.style.display = 'none';\n\t};\n\n\tthis._onSelect = function(evt) {\n\t\t$.stopEvent(evt);\n\t};\n\n\tthis._onMouseDown = function(evt) {\n\t\t$.stopEvent(evt);\n\t\tthis._showMouseAlpha(evt);\n\t\tthis._mouseDown = true;\n\t};\n\n\tthis._onMouseMove = function(evt) {\n\t\tif (this._mouseDown) {\n\t\t\tthis._showMouseAlpha(evt);\n\t\t}\n\t\t$.stopEvent(evt);\n\t};\n\n\tthis._onMouseOut = function(evt) {\n\t\tthis._mouseDown = false;\n\t\t$.stopEvent(evt);\n\t};\n\n\tthis._onMouseUp = function(evt) {\n\t\tthis._mouseDown = false;\n\t\t$.stopEvent(evt);\n\t};\n\n\tthis.setValue = function(value) {\n\t\tthis._el.value = value;\n\t};\n\n\tthis.getValue = function() {\n\t\treturn this._el.value;\n\t};\n});\n\n","pre":true},"sdk/squill/Widget.js":{"path":"sdk/squill/Widget.js","friendlyPath":"squill.Widget","directory":"sdk/squill/","filename":"Widget.js","baseMod":"squill","basePath":"sdk/","src":"jsio(\"from util.browser import $\");\njsio(\"import .Element, .Events, .global\");\njsio(\"import .i18n\");\njsio(\"import .Delegate\");\njsio(\"from .__imports__ import classes as WIDGET_CLASSES\");\n\nvar uid = 0;\n\nfunction shallowCopy(p) {\n\tvar o = {};\n\tfor(var i in p) {\n\t\tif(p.hasOwnProperty(i)) {\n\t\t\to[i] = p[i];\n\t\t}\n\t}\n\treturn o;\n}\n\nWidgetSet=__class__;var WidgetSet=WidgetSet(function WidgetSet(){return this.init&&this.init.apply(this,arguments)},function () {\n\tthis.init = function (target) {\n\t\tthis._target = target;\n\t\tthis.events = [];\n\t}\n\n\tthis.hasWidget = function (id) { return !!this._target[id]; };\n\n\tthis.addWidget = function (id, widget) {\n\t\tthis._target[id] = widget;\n\t};\n\n\tthis.addSubscription  = function(widget, signal /* ... args */) {\n\t\tif (this._target.dispatchEvent) {\n\t\t\twidget.subscribe.apply(widget, [signal, this._target, 'dispatchEvent'].concat(Array.prototype.slice.call(arguments, 2)));\n\t\t}\n\t}\n});\n\nvar sdk_squill_Widget=__class__;var Widget = exports=sdk_squill_Widget(function sdk_squill_Widget(){return this.init&&this.init.apply(this,arguments)},[Element, Events], function() {\n\tthis._css = 'widget';\n\tthis._name = '';\n\n\tthis.__getDef__ = function () {\n\t\tvar cls = this.constructor;\n\t\tvar def = {};\n\n\t\tdo {\n\t\t\tif (cls.prototype.hasOwnProperty('_def')) {\n\t\t\t\tcopyDef(def, cls.prototype._def);\n\t\t\t}\n\t\t} while ((cls = cls.prototype.__parentClass__));\n\n\t\t// handle base _def\n\t\tif (this.hasOwnProperty('_def')) {\n\t\t\tcopyDef(def, this._def);\n\t\t}\n\n\t\tfunction copyDef (target, src) {\n\t\t\tfor (var key in src) {\n\t\t\t\tif (key == 'attrs' || key == 'style') {\n\t\t\t\t\ttarget[key] = merge(target[key], src[key]);\n\t\t\t\t} if (key == 'className' && target.className) {\n\t\t\t\t\ttarget.className = src.className + ' ' + target.className;\n\t\t\t\t} else if (key == 'children') {\n\t\t\t\t\tif (target.children) {\n\t\t\t\t\t\ttarget.children.unshift(src.children);\n\t\t\t\t\t} else {\n\t\t\t\t\t\ttarget.children = [src.children];\n\t\t\t\t\t}\n\t\t\t\t} else if (!target.hasOwnProperty(key)) {\n\t\t\t\t\ttarget[key] = src[key];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn def;\n\t}\n\n\tthis.init = function(opts) {\n\t\topts = opts || {};\n\n\t\tthis._id = opts.id;\n\n\t\tthis._children = [];\n\n\t\t// ===\n\t\t// merge this._def and opts\n\n\t\tvar def = this._def = this.__getDef__();\n\n\t\t// className merges\n\t\tif (def.className) {\n\t\t\topts.className = opts.className ? opts.className + \" \" + def.className : def.className;\n\t\t}\n\n\t\tif (def.attrs) {\n\t\t\topts.attrs = merge(opts.attrs, def.attrs);\n\t\t}\n\n\t\tif (def.style) {\n\t\t\topts.style = merge(opts.style, def.style);\n\t\t}\n\t\t\n\t\t// opts take precedence over def\n\t\tthis._opts = opts;\n\t\tfor (var name in def) {\n\t\t\tif (name != 'children' && !opts.hasOwnProperty(name) && def.hasOwnProperty(name)) {\n\t\t\t\topts[name] = def[name];\n\t\t\t}\n\t\t}\n\n\t\t// delete opts.children;\n\n\t\t// end merge\n\t\t// ===\n\n\t\tif (opts.name) { this._name = opts.name; }\n\t\tif (opts.delegate) { this.delegate = opts.delegate; }\n\t\tif (opts.controller) { this.controller = opts.controller; }\n\n\t\tvar widgetParent;\n\t\tvar buildNow = false;\n\t\tif (opts.widgetParent) {\n\t\t\twidgetParent = opts.widgetParent;\n\t\t}\n\n\t\tif (opts.parent) {\n\t\t\tvar parent = this._parent = opts.parent;\n\t\t\tvar isWidgetParent = parent instanceof Widget;\n\t\t\tif (isWidgetParent) {\n\t\t\t\tif (!widgetParent) {\n\t\t\t\t\twidgetParent = opts.parent;\n\t\t\t\t}\n\n\t\t\t\topts.parent = parent.getContainer();\n\t\t\t} else if (!parent.appendChild) {\n\t\t\t\tdelete opts.parent;\n\t\t\t}\n\t\t}\n\n\t\tif (widgetParent) {\n\t\t\twidgetParent.addWidget(this);\n\t\t} else if (opts.parent || opts.el) {\n\t\t\tthis.build(opts.el);\n\t\t}\n\t};\n\n\tthis.getId = function () {\n\t\treturn this._id || (this._el && this._el.id);\n\t}\n\n\tthis.build = function (el) {\n\t\tif (!this._el || this._el != el) {\n\t\t\tvar opts = this._opts;\n\t\t\tvar children = opts.children;\n\t\t\t\n\t\t\tif (children) { delete opts.children; }\n\t\t\tthis._el = $.create(this._opts);\n\t\t\tif (children) { opts.children = children; }\n\n\t\t\tthis.buildContent();\n\t\t}\n\t\t\n\t\treturn this;\n\t}\n\n\tthis.getParent = function() { return this._parent; };\n\tthis.getWidgetParent = function () { return this._widgetParent; }\n\n\tthis.setWidgetParent = function (parent) {\n\t\tif (this._widgetParent != parent) {\n\t\t\tthis._widgetParent.addWidget(this);\n\t\t}\n\t}\n\n\tthis.setParent = function(parent) {\n\t\tthis._parent = parent;\n\t\tvar el = parent && (parent.getContainer && parent.getContainer() || parent.appendChild && parent);\n\t\tif (el) {\n\t\t\tif (!this._el) {\n\t\t\t\tthis._opts.parent = el;\n\t\t\t\tthis.build();\n\t\t\t} else {\n\t\t\t\tel.appendChild(this._el);\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.getChildren = function() {\n\t\treturn this._children;\n\t};\n\n\tthis.forEachDescend = function (cb, ctx) {\n\t\tvar n = this._children.length;\n\t\tfor (var i = 0; i < n; ++i) {\n\t\t\tvar child = this._children[i];\n\t\t\tcb.call(ctx, child);\n\t\t\tif (child.forEachDescend) {\n\t\t\t\tchild.forEachDescend(cb, ctx);\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.getFirstChild = function() {\n\t\treturn (this._children && this._children.length) ? this._children[0] : null;\n\t};\n\n\tthis.dispatchEvent = function(target, evt) {\n\t\tthis.delegate.call(this, target, evt);\n\t};\n\n\tthis.addElement = function (el) {\n\t\tthis._el.appendChild(el);\n\t}\n\n\tthis.addWidget = function(def, parent, result) {\n\t\tif (!this._el) { this.build(); }\n\n\t\tparent = def.parent || parent || this.getContainer() || this._el;\n\n\t\t// def is either a Widget or a definition for a Widget\n\t\tif (!(def instanceof Widget)) {\n\t\t\t// if it is not yet a widget, make it (or make a DOM node)\n\t\t\tvar opts = merge({}, def, {parent: parent, __result: result});\n\t\t\tif (opts.children) {\n\t\t\t\tvar children = opts.children;\n\t\t\t\tdelete opts.children;\n\t\t\t}\n\n\t\t\tvar el;\n\t\t\tif ('type' in opts && !opts.type) {\n\t\t\t\tlogger.warn('Did you forget to provide a type?', opts);\n\t\t\t}\n\t\t\t\n\t\t\tif (!opts.type || typeof opts.type == 'string') {\n\t\t\t\tif (WIDGET_CLASSES[opts.type]) {\n\t\t\t\t\tvar Constructor = jsio('import ' + WIDGET_CLASSES[opts.type]);\n\t\t\t\t\tel = new Constructor(opts);\n\t\t\t\t} else {\n\t\t\t\t\tswitch (opts.type) {\n\t\t\t\t\t\tcase 'checkbox':\n\t\t\t\t\t\t\tjsio(\"import .CheckBox\");\n\t\t\t\t\t\t\tel = new CheckBox(opts);\n\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\tcase 'image':\n\t\t\t\t\t\t\tel = $(merge({tag: 'img'}, opts));\n\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\tcase 'button':\n\t\t\t\t\t\t\tif (typeof TextButton == 'undefined') {\n\t\t\t\t\t\t\t\tjsio(\"import .TextButton\");\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tel = new TextButton(opts);\n\t\t\t\t\t\t\tif (result) {\n\t\t\t\t\t\t\t\tresult.addSubscription(el, 'Select', opts.id);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\tcase 'select':\n\t\t\t\t\t\t\tjsio(\"import .SelectBox\");\n\t\t\t\t\t\t\tel = new SelectBox(opts);\n\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\tcase 'widget':\n\t\t\t\t\t\t\tel = new exports(opts);\n\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\tel = $(opts);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tel = new opts.type(opts);\n\t\t\t}\n\t\t\t\n\t\t\tif (result && opts.id && !result.hasWidget(opts.id)) {\n\t\t\t\tresult.addWidget(opts.id, el);\n\t\t\t}\n\t\t} else {\n\t\t\tel = def;\n\t\t}\n\t\t\n\t\tif (el instanceof Widget) {\n\t\t\tif (el.getWidgetParent() != this) {\n\t\t\t\tvar prevParent = el.getWidgetParent();\n\t\t\t\tif (prevParent) {\n\t\t\t\t\tprevParent.removeWidget(this);\n\t\t\t\t}\n\n\t\t\t\tel._widgetParent = this;\n\t\t\t\tthis._children.push(el);\n\t\t\t}\n\n\t\t\tif (el.getParent() != parent) {\n\t\t\t\tel.setParent(parent);\n\t\t\t}\n\t\t}\n\n\t\tif (children) {\n\t\t\tif (el.buildChildren) {\n\t\t\t\tif (!result) { result = new WidgetSet(el); }\n\t\t\t\tel.buildChildren(children, result);\n\t\t\t} else {\n\t\t\t\tfor (var i = 0, c; c = children[i]; ++i) {\n\t\t\t\t\tthis.addWidget(c, el, result);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn el;\n\t};\n\n\tthis.removeWidget = function (widget) {\n\t\tvar index = this._children.indexOf(widget);\n\t\tif (index >= 0) {\n\t\t\tthis._children.splice(index, 1);\n\t\t}\n\t}\n\n\tthis.getContainer = function () { return this._el; };\n\tthis.getName = function () { return this._name; };\n\tthis.setName = function (name) { this._name = name; };\n\n\tthis.buildContent = function() {\n\t\tvar opts = this._opts;\n\n\t\tif (global.getWidgetPrefix() !== null) {\n\t\t\t$.addClass(this._el, global.getWidgetPrefix() + this._css);\n\t\t}\n\n\t\tif (!this.delegate) { this.delegate = new Delegate(); }\n\n\t\t// TODO: what's this doing here?\n\t\tif (opts.errorLabel) {\n\t\t\tthis._errorLabel = $.create({html: opts.errorLabel, className: global.getWidgetPrefix() + 'textInputErrorLabel', parent: this._el});\n\t\t}\n\n\t\tvar def = this._def;\n\n\t\t// def items always go on the widget\n\t\tif (def && def.children) {\n\t\t\tvar localRes = new WidgetSet(this);\n\t\t\tthis.buildChildren(def.children, localRes);\n\t\t}\n\n\t\tvar result = opts.__result || new WidgetSet(this);\n\n\t\t// opts items sometimes go on the widget\n\t\tif (opts.children) {\n\t\t\tthis.buildChildren(opts.children, result);\n\t\t}\n\n\t\tthis.buildWidget(this._el, result);\n\t};\n\n\tthis.buildChildren = function (children, result) {\n\t\tvar parent = this.getContainer();\n\t\tfor (var i = 0, n = children.length; i < n; ++i) {\n\t\t\tif (Array.isArray(children[i])) {\n\t\t\t\tthis.buildChildren(children[i], result);\n\t\t\t\tparent = this.getContainer();\n\t\t\t} else {\n\t\t\t\tthis.addWidget(children[i], parent, result);\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.buildWidget = function() {};\n\n\t// TODO: what's this doing here?\n\tthis.errors = function() {\n\t\treturn this.validators.map(function(item){\n\t\t\tif (item.isValid == false){\n\t\t\t\treturn item.message;\n\t\t\t}\n\t\t});\n\t};\n\n\t// TODO: what's this doing here?\n\tthis.validate = function() {\n\t\tvar isValid = true;\n\t\tfor (var i = 0, len = this.validators.length; i < len; ++i) {\n\t\t\tvar v = this.validators[i];\n\t\t\tisValid = isValid && (v.isValid = v.call(this));\n\t\t}\n\t\treturn (this._isValid = isValid);\n\t};\n\n\t// TODO: what's this doing here?\n\tthis._isValid = true;\n\tthis.isValid = function() { return this._isValid; }\n\tthis.validators = [];\n\n\tthis.getI18n = function(key, id) {\n\t\tvar src = key in this._opts\n\t\t\t? this._opts\n\t\t\t: i18n.get(id || this._opts.id);\n\t\t\n\t\treturn src && src[key] || '';\n\t};\n\n\tthis.getElement = function() {\n\t\tif (!this._el) { this.build(); }\n\t\treturn this._el;\n\t};\n\n\tthis.onBeforeShow = function() {\n\t\tfor (var i = 0, child; child = this._children[i]; ++i) {\n\t\t\tchild.onBeforeShow.apply(child, arguments);\n\t\t}\n\t};\n\n\tthis.onShow = function() {\n\t\tthis._isShowing = true;\n\t\tfor (var i = 0, child; child = this._children[i]; ++i) {\n\t\t\tchild.onShow.apply(child, arguments);\n\t\t}\n\t};\n\n\tthis.onBeforeHide = function() {\n\t\tfor (var i = 0, child; child = this._children[i]; ++i) {\n\t\t\tchild.onBeforeHide.apply(child, arguments);\n\t\t}\n\t};\n\n\tthis.onHide = function() {\n\t\tthis._isShowing = false;\n\t\tfor (var i = 0, child; child = this._children[i]; ++i) {\n\t\t\tchild.onHide.apply(child, arguments);\n\t\t}\n\t};\n\n\tthis.isShowing = function() { return this._isShowing; }\n\n\tthis.show = function() {\n\t\tthis.onBeforeShow();\n\n\t\tvar style = this._opts && this._opts.style;\n\t\tvar display = style && style.display != 'none' && style.display || 'block';\n\t\tif (this._el) {\n\t\t\tthis._el.style.display = display;\n\t\t}\n\n\t\tthis.onShow();\n\t};\n\n\tthis.hide = function() {\n\t\tthis.onBeforeHide();\n\t\t$.hide(this.getElement());\n\t\tthis.onHide();\n\t};\n\n\tthis.remove = function() {\n\t\tthis.onBeforeHide();\n\t\t$.remove(this.getElement());\n\t\tthis.onHide();\n\t};\n\n\tthis.putHere = function() {\n\t\tif(!this._el) { this.build(); }\n\t\t\n\t\tvar id = 'jsioWidgetId' + (++uid);\n\t\tglobal.getTargetDocument().write('<div id=\"'+id+'\"></div>');\n\t\tsetTimeout(bind(this, _replaceNode, id), 0);\n\t\t\n\t\treturn this;\n\t};\n\n\tfunction _replaceNode(id) {\n\t\tvar el = $.id(id);\n\t\tel.parentNode.insertBefore(this._el, el);\n\t\tel.parentNode.removeChild(el);\n\t};\n\n\tthis.appendTo = function(parent) {\n\t\tif(parent) {\n\t\t\tvar parent = $.id(parent);\n\t\t\tif(!this._el) { this.build(); }\n\t\t\tparent.appendChild(this._el);\n\t\t}\n\t\treturn this;\n\t};\n\n\tthis.onclick = function(f) { $.onEvent(this._el, 'click', f); return this; };\n});\n\nvar map = {};\nvar lowerCaseMap = {}\nWidget.register = function(cls, name) {\n\tif (name in map) { throw Error(\"A widget with name '\" + name + \"' is already registered\"); }\n\tmap[name] = cls;\n\tlowerCaseMap[name.toLowerCase()] = cls;\n};\n\nWidget.get = function(name) {\n\treturn lowerCaseMap[name.toLowerCase()];\n}\n\nWidget.WidgetSet = WidgetSet;\n","pre":true},"sdk/squill/Element.js":{"path":"sdk/squill/Element.js","friendlyPath":".Element","directory":"sdk/squill/","filename":"Element.js","src":"\"use import\";\n\njsio(\"import lib.PubSub\");\njsio(\"from util.browser import $\");\n\nvar sdk_squill_Element=__class__;var Element = exports=sdk_squill_Element(function sdk_squill_Element(){return this.init&&this.init.apply(this,arguments)},lib.PubSub, function(supr) {\n\tthis.init = function(opts) {\n\t\tthis._opts = JS.merge(opts, {\n\t\t\twin: window,\n\t\t\ttag: 'div'\n\t\t});\n\t}\n\t\n\tthis.build = function() {\n\t\tif (!this._el) {\n\t\t\tif (this._opts.el) {\n\t\t\t\tthis._el = this._opts.el;\n\t\t\t\t$.apply(this._el, this._opts);\n\t\t\t} else {\n\t\t\t\tthis._el = $.create(this._opts);\n\t\t\t}\n\t\t\n\t\t\tthis.buildContent();\n\t\t}\n\t\t\n\t\treturn this;\n\t}\n\t\n\tthis.getId = function() { return this._el && this._el.id || this._opts && this._opts.id; }\n\t\n\tthis.buildContent = function() {}\n\t\n\tthis.destroy = function() {\n\t\tif (!this._el) { return; }\n\t}\n\t\n\tthis.getElement = function() { return this._el || this.build()._el; }\n\t\n\tthis.appendChild = function(el) {\n\t\tif (!this._el) { this.build(); }\n\t\tthis._el.appendChild(el instanceof Element ? el._el : el);\n\t\t\n\t\treturn this;\n\t}\n\t\n\tthis.appendTo = function(el) {\n\t\tif (!this._el) { this.build(); }\n\t\t\n\t\tif (el instanceof Element) {\n\t\t\tel.appendChild(this);\n\t\t} else {\n\t\t\tel.appendChild(this._el);\n\t\t}\n\t\t\n\t\treturn this;\n\t}\n\t\n\tthis.setPos = function(x, y) {\n\t\tthis._el.style.x = x + 'px';\n\t\tthis._el.style.y = y + 'px';\n\t}\n\t\n\tthis.center = function() {\n\t\tvar dim = $(window);\n\t\tthis.setPos(Math.max(0, dim.width - this._el.offsetWidth) / 2, Math.max(0, dim.height - this._el.offsetHeight) / 2);\n\t}\n\t\n\tthis.remove = function() { $.remove(this._el); }\n});\n","pre":true},"sdk/squill/Events.js":{"path":"sdk/squill/Events.js","friendlyPath":".Events","directory":"sdk/squill/","filename":"Events.js","src":"\"use import\";\n\njsio(\"from util.browser import $\");\njsio(\"import .Drag\");\njsio(\"import lib.PubSub\");\n\nvar sdk_squill_Events=__class__;exports=sdk_squill_Events(function sdk_squill_Events(){return this.init&&this.init.apply(this,arguments)},lib.PubSub, function() {\n\tvar SLICE = Array.prototype.slice;\n\n\tvar isMobile = /(iPod|iPhone|iPad|Android)/i.test(navigator.userAgent);\n\n\tthis.event = function(el, name, handler) {\n\t\tif (!this._eventEnabled) { this._eventEnabled = {}; }\n\t\tvar args = [this, handler].concat(SLICE.call(arguments, 3)),\n\t\t\thandler = bind.apply(this, args),\n\t\t\tevents = this._eventEnabled;\n\t\t\n\t\tevents[name] = true;\n\t\t$.onEvent(el, name, function() {\n\t\t\tif (events[name]) {\n\t\t\t\treturn handler.apply(this, arguments);\n\t\t\t}\n\t\t});\n\t};\n\n\tthis.isDragging = function() {\n\t\treturn this._isDragging || false;\n\t};\n\n\tthis.initDragEvents = function(el) {\n\t\tif (!this.__drag) {\n\t\t\tvar d = this.__drag = new Drag();\n\t\t\td.subscribe('DragStart', this, 'onDragStart');\n\t\t\td.subscribe('Drag', this, 'onDrag');\n\t\t\td.subscribe('DragStop', this, 'onDragStop');\n\t\t}\n\t\t\n\t\tvar startDrag = bind(this.__drag, 'startDrag');\n\t\tif (!el) { el = this._el; }\n\t\tif (el.addEventListener) { el.addEventListener('touchstart', startDrag, true); }\n\t\t$.onEvent(el, 'mousedown', startDrag);\n\t};\n\n\tthis.initMouseEvents = function(el) {\n\t\tel = el || this._el;\n\t\t\n\t\tif (isMobile) {\n\t\t\tthis.event(el, 'touchstart', '_onTouchStart');\n\t\t\tthis.event(el, 'touchend', '_onTouchEnd');\n\t\t} else {\n\t\t\tthis.event(el, 'mouseover', 'onMouseOver');\n\t\t\tthis.event(el, 'mousemove', 'onMouseMove');\n\t\t\tthis.event(el, 'mouseout', 'onMouseOut');\n\t\t\tthis.event(el, 'mousedown', 'onMouseDown');\n\t\t\tthis.event(el, 'mouseup', 'onMouseUp');\n\t\t\tthis.event(el, 'click', 'onClick');\n\t\t}\n\t\t\n\t\treturn this;\n\t};\n\n\tthis.initFocusEvents = function(el) {\n\t\tel = el || this._el;\n\t\tthis.event(el, 'focus', 'onFocus');\n\t\tthis.event(el, 'blur', 'onBlur');\n\t\treturn this;\n\t};\n\n\tthis.initKeyEvents = function(el) {\n\t\tel = el || this._el;\n\t\tthis.event(el, 'keydown', 'onKeyDown');\n\t\tthis.event(el, 'keypress', 'onKeyPress');\n\t\tthis.event(el, 'keyup', 'onKeyUp');\n\t\treturn this;\n\t}\n\t\n\tthis._onTouchStart = function(e) {\n\t\tthis.onMouseOver(e);\n\t\tthis.onMouseDown(e);\n\t};\n\n\tthis._onTouchEnd = function(e) {\n\t\tthis.onMouseUp(e);\n\t\tthis.onClick(e);\n\t\tthis.onMouseOut(e);\n\t};\n\n\tthis.onMouseOver = function(e) {\n\t\tif (!this._enableMouseEvents) \n\t\tthis._isOver = true;\n\t\tthis.publish('Over', e);\n\t};\n\n\tthis.onMouseMove = function(e) {\n\t\tif (!this._enableMouseEvents) \n\t\tthis.publish('Move', e);\n\t};\n\n\tthis.onMouseOut = function(e) {\n\t\tthis._isOver = false;\n\t\tthis.publish('Out', e);\n\t};\n\n\tthis.onMouseDown = function(e) {\n\t\tthis._isDown = true;\n\t\tthis.publish('Down', e);\n\t\treturn false;\n\t};\n\n\tthis.onMouseUp = function(e) {\n\t\tthis._isDown = false;\n\t\tthis.publish('Up', e);\n\t\treturn false;\n\t};\n\n\tthis.onClick = function(e) {\n\t\tthis.publish('Select', e);\n\t\treturn false;\n\t};\n\n\tthis.onFocus = function(e) {\n\t\tthis._isFocused = true;\n\t\tthis.publish('Focus', e);\n\t};\n\n\tthis.onBlur = function(e) {\n\t\tthis._isFocused = false;\n\t\tthis.publish('Blur', e);\n\t};\n\n\tthis.onKeyUp = function(e) {\n\t\tthis.publish('KeyUp', e);\n\t};\n\n\tthis.onKeyPress = function(e) {\n\t\tthis.publish('KeyPress', e);\n\t};\n\n\tthis.onKeyDown = function(e) {\n\t\tthis.publish('KeyDown', e);\n\t};\n\n\tthis.onDragStart = function(dragEvt) {};\n\tthis.onDrag = function(dragEvt, moveEvt) {};\n\tthis.onDragStop = function(dragEvt, upEvt) {};\n});\n","pre":true},"sdk/squill/Drag.js":{"path":"sdk/squill/Drag.js","friendlyPath":".Drag","directory":"sdk/squill/","filename":"Drag.js","src":"jsio(\"import lib.PubSub\");\njsio(\"import math.geom.Point as Point\");\njsio(\"from util.browser import $\");\n\nvar gCurrentDrag = [],\n\tgCurrentMouse = {x: 0, y: 0};\n\nfunction resolveMouse(e) {\n\tif (e.touches) { return resolveMouse(e.touches[0]); }\n\t\n\tif ('pageX' in e) {\n\t\tgCurrentMouse.x = e.pageX;\n\t\tgCurrentMouse.y = e.pageY;\n\t} else { // looks like IE\n\t\tvar doc = document.documentElement,\n\t\t\tbody = document.body;\n\t\t\n\t\tgCurrentMouse.x = e.clientX + (doc && doc.scrollLeft || body && body.scrollLeft || 0) - (doc && doc.clientLeft || body && body.clientLeft || 0);\n\t\tgCurrentMouse.y = e.clientY + (doc && doc.scrollTop || body && body.scrollTop || 0) - (doc && doc.clientTop  || body && body.clientTop  || 0);\n\t}\n}\n\nvar _active = false;\n\nfunction gAddItem(item) {\n\tgRemoveItem(item);\n\tgCurrentDrag.push(item);\n\t_active = true;\n}\n\nfunction gRemoveItem(item) {\n\tfor (var i = 0; i < gCurrentDrag.length; ++i) {\n\t\tif (gCurrentDrag[i] == item) {\n\t\t\tgCurrentDrag.splice(i, 1);\n\t\t\t--i;\n\t\t}\n\t}\n\t\n\tif (!gCurrentDrag[0]) { _active = false; }\n}\n\nfunction onMove(e) {\n\tif (!_active) { return; }\n\t\n\tresolveMouse(e);\n\tfor (var i = 0; i < gCurrentDrag.length; ++i) {\n\t\tgCurrentDrag[i].onMouseMove(e);\n\t}\n\t\n}\n\nfunction onUp(e) {\n\tif (!_active) { return; }\n\t\n\tfor (var i = 0; i < gCurrentDrag.length; ++i) {\n\t\tgCurrentDrag[i].onMouseUp(e);\n\t}\n}\n\nif ('ontouchstart' in window && document.addEventListener) {\n\tdocument.addEventListener('touchstart', resolveMouse, true);\n\tdocument.addEventListener('touchmove', onMove, true);\n\tdocument.addEventListener('touchend', onUp, true);\n} else {\n\tdocument.addEventListener('mousedown', resolveMouse, true);\n\tdocument.addEventListener('mousemove', onMove, true);\n\tdocument.addEventListener('mouseup', onUp, true);\n}\n\nvar sdk_squill_Drag=__class__;exports=sdk_squill_Drag(function sdk_squill_Drag(){return this.init&&this.init.apply(this,arguments)},lib.PubSub, function(supr) {\n\n\tthis.init = function(params) {\n\t\tthis._isActive = false;\n\t}\n\n\t// data is an optional object that will be added to dragEvt.data.\n\t// This allows the caller of startDrag to pass along arbitrary objects\n\t// to the DragStart, Drag, and DragStop events, since the receiver\n\t// can just read data off of the event object (first argument).\n\tthis.startDrag = function(params, data) {\n\t\tvar e = this._evt = new exports.DragEvent();\n\t\tthis._evt.data = data;\n\t\tthis._evt.params = merge(params, {\n\t\t\t/* addInScroll: true, */ // TODO?\n\t\t\tthreshold: 5\n\t\t});\n\t\t\n\t\te.srcPt = new Point(gCurrentMouse);\n\t\te.currPt = new Point(gCurrentMouse);\n\t\tgAddItem(this);\n\t}\n\t\n\tthis.onMouseMove = function(moveEvt) {\n\t\tvar dragEvt = this._evt,\n\t\t\tabsDelta = Point.subtract(gCurrentMouse, dragEvt.srcPt);\n\t\t\n\t\tif (!this._isActive && absDelta.getMagnitude() > dragEvt.params.threshold) {\n\t\t\tthis._isActive = true;\n\t\t\tthis.setIframesEnabled(false);\n\t\t\tthis.publish('DragStart', dragEvt);\n\t\t}\n\t\t\n\t\tif (this._isActive) {\n\t\t\t$.stopEvent(moveEvt);\n\t\t\t\n\t\t\tdragEvt.prevPt = dragEvt.currPt;\n\t\t\tdragEvt.currPt = new Point(gCurrentMouse);\n\t\t\tthis.publish('Drag', dragEvt, moveEvt, Point.subtract(dragEvt.currPt, dragEvt.prevPt));\n\t\t}\n\t}\n\t\n\tthis.onMouseUp = function(upEvt) {\n\t\tgRemoveItem(this);\n\t\tif (this._isActive) {\n\t\t\t\n\t\t\t$.stopEvent(upEvt);\n\t\t\tthis._isActive = false;\n\t\t\tthis.setIframesEnabled(true);\n\t\t\tthis.publish('DragStop', this._evt, upEvt);\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tthis.setIframesEnabled = function (isEnabled) {\n\t\t$(\"iframe\").forEach(function (iframe) {\n\t\t\ttry {\n\t\t\t\tif (isEnabled) {\n\t\t\t\t\tiframe.style.pointerEvents = iframe.__squill_drag_pointer_events;\n\t\t\t\t} else {\n\t\t\t\t\tiframe.__squill_drag_pointer_events = getComputedStyle(iframe).getPropertyValue('pointerEvents');\n\t\t\t\t\tiframe.style.pointerEvents = 'none';\n\t\t\t\t}\n\t\t\t} catch (e) {};\n\t\t});\n\t}\n});\n\nexports.DragEvent=__class__;exports.DragEvent=exports.DragEvent(function exports_DragEvent(){return this.init&&this.init.apply(this,arguments)},function() {});\n","pre":true},"sdk/squill/global.js":{"path":"sdk/squill/global.js","friendlyPath":".global","directory":"sdk/squill/","filename":"global.js","src":"var gWidgetPrefix = 'squill-';\nvar gWin = window;\nvar gDoc = document;\n\nexports.setTargetWindow = function(w) { gWin = w; gDoc = w.document; }\nexports.getTargetWindow = function() { return gWin; }\nexports.getTargetDocument = function() { return gDoc; }\n\nexports.setWidgetPrefix = function(p) { gWidgetPrefix = p; }\nexports.getWidgetPrefix = function() { return gWidgetPrefix; }\n","pre":true},"sdk/squill/i18n.js":{"path":"sdk/squill/i18n.js","friendlyPath":".i18n","directory":"sdk/squill/","filename":"i18n.js","src":"var gLang = null;\n\nexports.setLang = function(lang) { gLang = lang; }\nexports.get = function(key) {\n\treturn gLang && gLang.get(key);\n}\n\nexports.Language=__class__;exports.Language=exports.Language(function exports_Language(){return this.init&&this.init.apply(this,arguments)},function() {\n\tthis.init = function(dict) { this._dict = dict; }\n\tthis.add = function(key, value) { this._dict[key] = value; }\n\tthis.get = function(key) { return this._dict[key]; }\n});\n","pre":true},"sdk/squill/Delegate.js":{"path":"sdk/squill/Delegate.js","friendlyPath":".Delegate","directory":"sdk/squill/","filename":"Delegate.js","src":"var sdk_squill_Delegate=__class__;var Delegate = exports=sdk_squill_Delegate(function sdk_squill_Delegate(){return this.init&&this.init.apply(this,arguments)},function() {\n\tthis.init = function(def) {\n\t\tdef && def(this);\n\t}\n\t\n\tthis.extend = function(def) {\n\t\tvar delegate = new Delegate(def);\n\t\tdelegate.parent = this;\n\t\treturn delegate;\n\t}\n\t\n\tthis.call = function(ctx, name) {\n\t\tif (this[name]) {\n\t\t\treturn this[name].apply(ctx, Array.prototype.slice.call(arguments, 1));\n\t\t} else if (this.parent) {\n\t\t\tthis.parent.call(ctx, name);\n\t\t}\n\t}\n});\n","pre":true},"sdk/squill/__imports__.js":{"path":"sdk/squill/__imports__.js","friendlyPath":".__imports__","directory":"sdk/squill/","filename":"__imports__.js","pre":true,"src":"exports.classes = {\n\talpha: '.Alpha',\n\tlabel: '.Label',\n\tlist: '.List',\n\ttext: '.TextInput',\n\ttextarea: '.TextArea',\n\tpassword: '.TextInput',\n\tscroller: '.Scroller',\n\tcanvas: '.Canvas',\n\tslider: '.Slider',\n\tcolor: '.Color',\n\tvcenter: '.VerticalCenter',\n\ttreelist: '.TreeList',\n\tgraph: '.Graph',\n\tselect: '.SelectBox',\n};\n\n\nexports.resolve = function(env, opts) {\n\tvar imports = [];\n\t\n\tif (env == 'browser') {\n\t\tfor (var key in exports.classes) {\n\t\t\timports.push(exports.classes[key]);\n\t\t}\n\t}\n\t\n\treturn imports;\n}\n"},"sdk/squill/CheckBox.js":{"path":"sdk/squill/CheckBox.js","friendlyPath":".CheckBox","directory":"sdk/squill/","filename":"CheckBox.js","src":"\"use import\";\n\njsio(\"import .Widget\");\njsio(\"from util.browser import $\");\n\nvar sdk_squill_CheckBox=__class__;var CheckBox = exports=sdk_squill_CheckBox(function sdk_squill_CheckBox(){return this.init&&this.init.apply(this,arguments)},Widget, function(supr) {\n\tthis._def = {\n\t\ttag: 'label',\n\t\tchildren: [\n\t\t\t{id: 'checkbox', tag: 'input', attrs: {type: 'checkbox'}},\n\t\t\t{tag: 'span', id: 'label', text: ''}\n\t\t]\n\t};\n\t\n\tthis.buildWidget = function() {\n\t\tthis.setLabel(this._opts.label || '');\n\t\tif (this._opts.name) {\n\t\t\tthis.setName(this._opts.name);\n\t\t}\n\t\t\n\t\tif (this._opts.value) {\n\t\t\tthis.setValue(this._opts.value);\n\t\t}\n\t\t\n\t\tthis.initMouseEvents(this.checkbox);\n\t\t$.onEvent(this.checkbox, 'change', this, '_onCheck');\n\n\t\tif (this._opts.__result) {\n\t\t\tthis._opts.__result.addSubscription(this, 'Select', this._opts.id);\n\t\t}\n\t}\n\t\n\tthis._onCheck = function() {\n\t\tthis.publish('Check', this.isChecked());\n\t\tthis.emit('change', this.isChecked());\n\t}\n\t\n\tthis.setLabel = function (label) { $.setText(this.label, label); }\n\tthis.setName = function (name) { this.checkbox.name = name; }\n\tthis.setValue = function (value) { this.checkbox.checked = !!value; }\n\n\tthis.isChecked = function () { return this.checkbox.checked; }\n\tthis.setChecked = function (isChecked) { this.checkbox.checked = isChecked; }\n\t\n\tthis.getValue = function () { return this.isChecked() ? this.checkbox.value : null; }\n});\n","pre":true},"sdk/squill/TextButton.js":{"path":"sdk/squill/TextButton.js","friendlyPath":".TextButton","directory":"sdk/squill/","filename":"TextButton.js","src":"\"use import\";\n\njsio(\"import .Button, .Widget\");\njsio(\"from util.browser import $\");\n\nvar sdk_squill_TextButton=__class__;var TextButton = exports=sdk_squill_TextButton(function sdk_squill_TextButton(){return this.init&&this.init.apply(this,arguments)},Button, function(supr) {\n\tthis._type = 'text-button';\n\t\n\tthis.buildWidget = function() {\n\t\tvar el = this._el;\n\t\t$.setText(el, this.getI18n('label') || this.getI18n('text'));\n\t\t\n\t\tthis.initMouseEvents(el);\n\t\tthis.initKeyEvents(el);\n\t}\n\t\n\tthis.setLabel = function(label) {\n\t\tthis._opts.label = label;\n\t\tif(this._el) { $.setText(this._el, label); }\n\t}\n});\n\nWidget.register(TextButton, 'TextButton');\n","pre":true},"sdk/squill/Button.js":{"path":"sdk/squill/Button.js","friendlyPath":".Button","directory":"sdk/squill/","filename":"Button.js","src":"\"use import\";\n\njsio(\"from util.browser import $\");\njsio(\"import .Widget\");\n\njsio(\"import .hint as hint\");\n\nvar sdk_squill_Button=__class__;var Button = exports=sdk_squill_Button(function sdk_squill_Button(){return this.init&&this.init.apply(this,arguments)},Widget, function(supr) {\n\tthis._css = 'btn';\n\tthis._type = 'button';\n\n\tthis.init = function(params) {\n\t\tparams = merge(params, {tag: 'button', isEnabled: true});\n\t\tthis._isEnabled = params.isEnabled;\n\t\tsupr(this, 'init', [params]);\n\t\tthis._hint = params.hint;\n\t};\n\n\tthis.create = function() {\n\t\tthis._opts.style = JS.merge(this._opts.style, {\n\t\t\t\twhiteSpace: 'nowrap',\n\t\t\t\tdisplay: 'block'\n\t\t\t});\n\t\t\n\t\tsupr(this, 'create', arguments);\n\t};\n\n\tthis.buildWidget = function() {\n\t\tvar el = this._el;\n\t\t\n\t\tthis.initMouseEvents(el);\n\t\tthis.initKeyEvents(el);\n\t\t\n\t\tel.style.userSelect = 'none';\n\t\tel.style.MozUserSelect = 'none'; // Mozilla\n\t\tel.style.KhtmlUserSelect = 'none'; // Safari\n\t\tel.unselectable = 'on'; // IE\n\t};\n\n\tthis._setHintTimeout = function(e) {\n\t\tif (!this._hint) {\n\t\t\treturn;\n\t\t}\n\t\tthis._hintTimeout && clearTimeout(this._hintTimeout);\n\t\tthis._hintTimeout = setTimeout(\n\t\t\tbind(\n\t\t\t\tthis,\n\t\t\t\tfunction() {\n\t\t\t\t\thint.show(e.pageX + 12, e.pageY + 14, this._hint);\n\t\t\t\t}\n\t\t\t),\n\t\t\t300\n\t\t);\n\t};\n\n\tthis.onMouseOver = function(e) {\n\t\tthis._setHintTimeout(e);\n\t};\n\n\tthis.onMouseMove = function(e) {\n\t\tthis._setHintTimeout(e);\n\t};\n\n\tthis.onMouseOut = function(e) {\n\t\thint.hide();\n\t\tthis._hintTimeout && clearTimeout(this._hintTimeout);\n\t};\n\n\tthis.onClick = function(e) {\n\t\t$.stopEvent(e);\n\t\tif (!this._isEnabled) { return; }\n\n\t\tif (this._opts.onClick) {\n\t\t\tthis._opts.onClick(e, this);\n\t\t}\n\t\t\n\t\tsupr(this, 'onClick', arguments);\n\t};\n\n\tthis.captureOnEnter = function(widget) {\n\t\twidget.subscribe('KeyDown', this, 'onKeyDown');\n\t\twidget.subscribe('KeyUp', this, 'onKeyUp');\n\t};\n\n\tthis.onKeyDown = function(e) {\n\t\tif (e.keyCode == 13) { $.stopEvent(e); this.onMouseDown(); }\n\t};\n\n\tthis.onKeyUp = function(e) {\n\t\tif (e.keyCode == 13) { $.stopEvent(e); this.onMouseUp(); this.onClick(e); }\n\t};\n\t\n\tthis.show = function() {\n\t\tthis.onBeforeShow();\n\t\tthis.getElement().style.display = 'inline-block';\n\t\tthis.onShow();\n\t};\n\n\tthis.setEnabled = function(isEnabled) {\n\t\tif (this._isEnabled != isEnabled) {\n\t\t\tthis._isEnabled = isEnabled;\n\t\t\tif (!isEnabled) {\n\t\t\t\t$.addClass(this._el, 'disabled')\n\t\t\t} else {\n\t\t\t\t$.removeClass(this._el, 'disabled')\n\t\t\t}\n\t\t}\n\t};\n});\n\n","pre":true},"sdk/squill/hint.js":{"path":"sdk/squill/hint.js","friendlyPath":".hint","directory":"sdk/squill/","filename":"hint.js","src":"\"use import\";\n\njsio(\"from util.browser import $\");\n\nvar hint = $({parent: document.body, className: 'hint'});\n\nexports.show = function(x, y, text) {\n\thint.innerHTML = text;\n\thint.style.left = x + 'px';\n\thint.style.top = y + 'px';\n\thint.style.display = 'block';\n\n\tconsole.log(text);\n\tif (x + hint.offsetWidth >= document.width) {\n\t\thint.style.left = (x - hint.offsetWidth) + 'px';\n\t}\n};\n\nexports.hide = function() {\n\thint = hint || $({\n\t\tparent: document.body,\n\t\tclassName: 'graphHint'\n\t});\n\n\thint.style.display = 'none';\n};\n\nvar setHintTimeout = function(evt) {\n\tevt.target.hintTimeout && clearTimeout(evt.target.hintTimeout);\n\tevt.target.hintTimeout = setTimeout(\n\t\tbind(\n\t\t\tthis,\n\t\t\tfunction() {\n\t\t\t\texports.show(evt.pageX + 12, evt.pageY + 14, evt.target.hintText);\n\t\t\t}\n\t\t),\n\t\t300\n\t);\n};\n\nexports.add = function(el, text) {\n\tel.hintText = text;\n\n\t$.onEvent(el, 'mouseover', setHintTimeout);\n\t$.onEvent(el, 'mousemove', setHintTimeout);\n\t$.onEvent(\n\t\tel,\n\t\t'mouseout',\n\t\tfunction(evt) {\n\t\t\texports.hide();\n\t\t\tevt.target.hintTimeout && clearTimeout(evt.target.hintTimeout);\n\t\t}\n\t);\n}","pre":true},"sdk/squill/SelectBox.js":{"path":"sdk/squill/SelectBox.js","friendlyPath":".SelectBox","directory":"sdk/squill/","filename":"SelectBox.js","src":"jsio(\"import .Widget\");\njsio(\"import squill.models.DataSource as DataSource\");\n\njsio(\"from util.browser import $\");\n\nvar sdk_squill_SelectBox=__class__;var SelectBox = exports=sdk_squill_SelectBox(function sdk_squill_SelectBox(){return this.init&&this.init.apply(this,arguments)},Widget, function(supr) {\n\tthis._def = {\n\t\ttag: 'select'\n\t};\n\n\tthis.init = function(opts) {\n\t\topts = merge(opts, {\n\t\t\trenderer: bind(this, 'defaultRenderer')\n\t\t});\n\n\t\tthis._items = {};\n\t\tif (opts.dataSource) { this.setDataSource(opts.dataSource); }\n\t\tsupr(this, 'init', arguments);\n\t}\n\t\n\tthis.buildWidget = function() {\n\t\tif (this._opts.name) {\n\t\t\tthis.setName(this._opts.name);\n\t\t}\n\n\t\tif (!this._dataSource) {\n\t\t\tthis.setDataSource(new DataSource());\n\t\t}\n\t\t\n\t\tif (this._opts.items) {\n\t\t\tvar uid = 1;\n\t\t\tvar items = this._opts.items.map(function (item) {\n\t\t\t\tif (typeof item != 'object') {\n\t\t\t\t\treturn {id: typeof item == 'string' ? item : uid++, value: item};\n\t\t\t\t} else {\n\t\t\t\t\tif (!item.id) {\n\t\t\t\t\t\titem.id =   'value' in item ? item.value :\n\t\t\t\t\t\t\t\t\t'title' in item ? item.title :\n\t\t\t\t\t\t\t\t\t(uid++);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn item;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis._dataSource.add(items);\n\t\t}\n\n\t\tif ('value' in this._opts) {\n\t\t\tthis.setValue(this._opts.value);\n\t\t}\n\n\t\tthis.initMouseEvents(this._el);\n\t\t$.onEvent(this._el, 'change', this, '_onSelect');\n\t}\n\t\n\tthis._onSelect = function() {\n\t\tvar item = this._dataSource.get(this.getValue());\n\t\tif (item) {\n\t\t\tthis.publish('change', item);\n\t\t}\n\t}\n\n\tthis.setDataSource = function(dataSource) {\n\t\tif (this._dataSource) {\n\t\t\tthis._dataSource.unsubscribe('Update', this);\n\t\t\tthis._dataSource.unsubscribe('Remove', this);\n\t\t}\n\t\tthis._dataSource = dataSource;\n\t\tthis._dataSource.subscribe('Update', this, 'onUpdateItem');\n\t\tthis._dataSource.subscribe('Remove', this, 'onRemoveItem');\n\t\tthis._dataSource.forEach(function(item, key) {\n\t\t\tthis.onUpdateItem(key, item);\n\t\t}, this);\n\t}\n\t\n\tthis.defaultRenderer = function(item) {\n\t\tvar key = this._dataSource.getKey();\n\t\treturn item.displayName || item.label || item.title || item.text || item[key];\n\t}\n\t\n\tthis.onUpdateItem = function(id, item) {\n\t\tvar el = this._items[id];\n\t\tvar keyField = this._dataSource.getKey();\n\n\t\tif (typeof(item) === 'string') {\n\t\t\tvar o = {};\n\t\t\to[keyField] = item;\n\t\t\titem = o;\n\t\t}\n\n\t\tif (!el) {\n\t\t\tvar el = this._items[id] = $.create({tag: 'option'});\n\t\t\t$.insertBefore(this._el, el);\n\t\t}\n\n\t\tel.setAttribute('value', item[keyField]);\n\t\tvar renderer = this._opts.renderer;\n\t\tel.innerText = (typeof renderer === 'string' ? item[renderer] : renderer(item))\n\t\tel.value = item[keyField];\n\t}\n\t\n\tthis.onRemoveItem = function(id) {\n\t\tvar el = this._items[id];\n\t\tvar prevValue = this.getValue();\n\t\tif (el) {\n\t\t\t$.remove(el);\n\t\t\tdelete this._items[id];\n\t\t}\n\t\tvar newValue = this.getValue();\n\t\tif (newValue != prevValue) {\n\t\t\tthis._onSelect(); // the old value was removed, so select a new one\n\t\t}\n\t}\n\n\n\tthis.setName = function(name) { this._el.name = name; }\n\tthis.setValue = function(value) { this._el.value = value; }\n\n\tthis.getValue = function() { return this._el.value; }\n});\n","pre":true},"sdk/squill/models/DataSource.js":{"path":"sdk/squill/models/DataSource.js","friendlyPath":"squill.models.DataSource","directory":"sdk/squill/models/","filename":"DataSource.js","src":"\"use import\";\n\njsio(\"import lib.Callback\");\njsio(\"import .BasicDataSource as BasicDataSource\");\n\nvar sdk_squill_models_DataSource=__class__;var DataSource = exports=sdk_squill_models_DataSource(function sdk_squill_models_DataSource(){return this.init&&this.init.apply(this,arguments)},BasicDataSource, function(supr) {\n\n\tvar defaults = {\n\t\tkey: 'id'\n\t};\n\n\tthis.init = function(opts) {\n\t\tthis._opts = opts = merge(opts, defaults);\n\n\t\tsupr(this, 'init', [opts]);\n\n\t\tthis._byIndex = [];\n\t\tthis._byID = {};\n\t\tthis._ctor = opts.ctor;\n\t\tthis._reverse = opts.reverse;\n\n\t\tthis.length = 0;\n\n\t\tthis.onLoad = new lib.Callback();\n\n\t\tthis.setSorter(opts.sorter);\n\t\tthis.setPersistence(opts.persistence);\n\n\t\tthis._changeDataSave = false;\n\t\tthis._changeData = {\n\t\t\tupdated: [], \n\t\t\tupdatedHash: {},\n\t\t\tremoved: [],\n\t\t\tremovedHash: {}\n\t\t};\n\t};\n\n\tthis.setPersistence = function(persistence) {\n\t\tthis._persistence = persistence;\n\t\tif (persistence) {\n\t\t\tthis.onLoad.clear();\n\t\t\tpersistence.load(this, this.onLoad.chain());\n\t\t}\n\t}\n\n\tthis._saveChanges = function(type, key) {\n\t\tif (this._changeDataSave && !this._changeData[type + 'Hash'][key]) {\n\t\t\tthis._changeData[type + 'Hash'][key] = true;\n\t\t\tthis._changeData[type].push(key);\n\t\t}\n\t};\n\t\n\tthis.getFilteredDataSource = function(filterFn) {\n\t\tvar ds = new DataSource(this._opts);\n\t\tthis.forEach(function (item) {\n\t\t\tif (filterFn(item)) {\n\t\t\t\tds.add(item);\n\t\t\t}\n\t\t});\n\n\t\tthis.subscribe('Update', function (id, item) {\n\t\t\tif (filterFn(item)) {\n\t\t\t\tds.add(item);\n\t\t\t} else {\n\t\t\t\tds.remove(item);\n\t\t\t}\n\t\t});\n\n\t\tthis.subscribe('Remove', function (id, item) { ds.remove(item); });\n\t\treturn ds;\n\t};\n\n\tthis.signalUpdate = function(type, item, id) {\n\t\tif (item[this.key] === undefined) {\n\t\t\treturn;\n\t\t}\n\t\tswitch (type) {\n\t\t\tcase 'UPDATE':\n\t\t\t\tthis._saveChanges('updated', item[this.key]);\n\t\t\t\tthis.publish('Update', item[this.key], item);\n\t\t\t\tbreak;\n\n\t\t\tcase 'REMOVE':\n\t\t\t\tthis._saveChanges('removed', item[this.key]);\n\t\t\t\tthis.publish('Remove', id, item);\n\t\t\t\tbreak;\n\t\t}\n\t};\n\n\tvar toStringSort = function() {\n\t\treturn this._sortKey;\n\t};\n\t// NEVER CHANGE THE ID OF AN ITEM WITHOUT REMOVING IT FROM THE DATASOURCE FIRST.\n\t// Love, Jeff Hubbard and Marcus Cavanaugh\n\n\tthis.updated = \n\tthis.add = function(item) {\n\t\tif (isArray(item)) {\n\t\t\tfor (var i = 0, len = item.length; i < len; ++i) {\n\t\t\t\titem[i] && this.add(item[i]);\n\t\t\t}\n\t\t} else {\n\t\t\tvar id = item[this.key];\n\n\t\t\t// note: not the same as `if (!id) { ... }`\n\t\t\tif (id == null) { return; }\n\n\t\t\tvar index = null;\n\t\t\tif (this._byID[id]) {\n\t\t\t\tfor (var i = 0, _item; _item = this._byIndex[i]; ++i) {\n\t\t\t\t\tif (_item[this.key] == id) {\n\t\t\t\t\t\tif (typeof _item.update == 'function') {\n\t\t\t\t\t\t\t_item.update(item);\n\t\t\t\t\t\t\titem = _item;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tindex = i;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tindex = this.length++;\n\t\t\t}\n\n\t\t\t// if we're adding it to the array:\n\t\t\tif (index !== null) {\n\n\t\t\t\t// make sure it's an instance of the specified class\n\t\t\t\tif (this._ctor && !(item instanceof this._ctor)) {\n\t\t\t\t\titem = new this._ctor(item);\n\t\t\t\t}\n\n\t\t\t\tthis._byIndex[index] = item;\n\t\t\t}\n\n\t\t\tthis._byID[id] = item;\n\n\t\t\tthis.signalUpdate('UPDATE', item);\n\n\t\t\tif (this._sorter) {\n\t\t\t\titem._sortKey = this._sorter(item);\n\t\t\t\titem.toString = toStringSort;\n\t\t\t}\n\t\t}\n\n\t\treturn item;\n\t};\n\t\n\tthis.remove = function(id) {\n\t\tif (typeof id == 'object') { id = id[this.key]; }\n\t\tif (id == null) { return; }\n\n\t\tif (this._byID[id]) {\n\t\t\tthis.signalUpdate('REMOVE', this._byID[id], id);\n\t\t\tdelete this._byID[id];\n\t\t\tfor (var i = 0, item; item = this._byIndex[i]; ++i) {\n\t\t\t\tif (item[this.key] == id) {\n\t\t\t\t\t--this.length;\n\t\t\t\t\treturn this._byIndex.splice(i, 1)[0];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.keepOnly = function(list) {\n\t\tthis.compare(list, function(dataSource, local, remote) {\n\t\t\tif (!remote) {\n\t\t\t\tdataSource.remove(local);\n\t\t\t}\n\t\t});\n\t};\n\n\tthis.clear = function() {\n\t\tvar index = this._byIndex;\n\n\t\tthis._byIndex = [];\n\t\tthis._byID = {};\n\t\tthis.length = 0;\n\n\t\tfor (var i = 0, item; item = index[i]; ++i) {\n\t\t\tthis.signalUpdate('REMOVE', item, item[this.key]);\n\t\t}\n\t};\n\n\tthis.getCount = function() {\n\t\treturn this.length;\n\t};\n\n\tthis.setSorter = function(sorter) {\n\t\tthis._sorter = sorter;\n\t\tif (sorter) {\n\t\t\tfor (var i = 0, item; item = this._byIndex[i]; ++i) {\n\t\t\t\titem._sortKey = sorter(item);\n\t\t\t\titem.toString = toStringSort;\n\t\t\t}\n\t\t}\n\t\tthis.sort();\n\t\treturn this;\n\t};\n\n\tthis.contains = function(id) {\n\t\treturn !!this._byID[id];\n\t};\n\n\tthis.getKey = function() {\n\t\treturn this.key;\n\t}\n\n\tthis.get = this.getItemForID = function(id) {\n\t\treturn this._byID[id] || null;\n\t};\n\n\tthis.getItemForIndex = function(index) {\n\t\treturn this._byIndex[index];\n\t};\n\n\tthis.sort = function() {\n\t\tthis._byIndex.sort();\n\t\tthis._reverse && this._byIndex.reverse();\n\t};\n\n\tthis.forEach = this.each = function(cb, context) {\n\t\tfor (var i = 0; i < this.length; ++i) {\n\t\t\tif (cb.call(context, this._byIndex[i], i)) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.toJSON = function() {\n\t\treturn {\n\t\t\tkey: this.key,\n\t\t\titems: this._byIndex\n\t\t};\n\t};\n\n\tthis.fromJSON = function(data) {\n\t\tthis.clear();\n\t\tvar key = this.key = data.key;\n\t\tthis.add(data.items);\n\t};\n\n\tthis.toArray = function() { return this._byIndex.slice(0); }\n\n\tthis.beginChanges = function() {\n\t\tthis._changeDataSave = true;\n\t\tthis._changeData = {\n\t\t\tupdated: [], \n\t\t\tupdatedHash: {},\n\t\t\tremoved: [],\n\t\t\tremovedHash: {}\n\t\t};\n\t};\n\n\tthis.saveChanges = function() {\n\t\tthis._changeDataSave = false;\n\t\tif (this._persistence) {\n\t\t\tvar changeData = this._changeData,\n\t\t\t\ti, j;\n\n\t\t\tthis._persistence.remove(changeData.removed);\n\n\t\t\tif (changeData.updated.length) {\n\t\t\t\tvar updateList = [];\n\t\t\t\tfor (i = 0, j = changeData.updated.length; i < j; i++) {\n\t\t\t\t\tupdateList.push(this._byID[changeData.updated[i]]);\n\t\t\t\t}\n\t\t\t\tthis._persistence.update(updateList);\n\t\t\t}\n\n\t\t\tthis._persistence.commit();\n\t\t}\n\t};\n\n\tthis.load = function(cb) {\n\t\tif (this._persistence) {\n\t\t\tthis._persistence.load(this, function(err) {\n\t\t\t\tif (err) {\n\t\t\t\t\tlogger.log('error loading', JSON.stringify(err));\n\t\t\t\t}\n\t\t\t\tcb && cb(err);\n\t\t\t});\n\t\t}\n\t};\n\n\tthis.save = function() {\n\t\tif (this._persistence) {\n\t\t\tthis._persistence.save(this);\n\t\t}\n\t}\n\n\tthis.compare = function(dict, cb) {\n\t\tvar key = this.key;\n\n\t\t// create a key-indexed copy of dict to run the comparison against\n\t\tvar compareTo = {};\n\t\tif (isArray(dict)) {\n\t\t\tfor (var i = 0, n = dict.length; i < n; ++i) {\n\t\t\t\tcompareTo[dict[i][key]] = dict[i];\n\t\t\t}\n\t\t} else {\n\t\t\tfor (var k in dict) {\n\t\t\t\tcompareTo[k] = dict[k];\n\t\t\t}\n\t\t}\n\n\t\t// first, compare all items in the index to the dict items\n\t\tvar items = this._byIndex.slice(0);\n\t\tfor (var i = 0, item; item = items[i]; ++i) {\n\t\t\tvar k = item[key];\n\t\t\tcb.call(this, this, item, compareTo[k]);\n\t\t\tdelete compareTo[k];\n\t\t}\n\n\t\t// then, for any remaining dict items, they don't exist in the local version\n\t\tfor (var k in compareTo) {\n\t\t\tcb.call(this, this, null, compareTo[k]);\n\t\t}\n\t}\n\n\tthis.filter = function(filter) {\n\t\tvar result = new DataSource({key: this.key});\n\t\tvar key;\n\t\tvar item;\n\t\tvar match;\n\t\tvar i;\n\t\tvar j = this.length;\n\n\t\tresult.key = this.key;\n\t\tfor (i = 0; i < j; ++i) {\n\t\t\titem = this._byIndex[i];\n\t\t\tmatch = true;\n\t\t\tfor (key in filter) {\n\t\t\t\tif ((typeof item[key] == 'string') && (item[key].toLowerCase().indexOf(filter[key]) == -1)) {\n\t\t\t\t\tmatch = false;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (match) {\n\t\t\t\tresult.add(item);\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t};\n});\n","pre":true},"sdk/jsio/lib/Callback.js":{"path":"sdk/jsio/lib/Callback.js","friendlyPath":"lib.Callback","directory":"sdk/jsio/lib/","filename":"Callback.js","src":"var sdk_jsio_lib_Callback=__class__;exports=sdk_jsio_lib_Callback(function sdk_jsio_lib_Callback(){return this.init&&this.init.apply(this,arguments)},function() {\n\n\tthis._fired = false;\n\tthis._id = 0;\n\tthis._pending = null;\n\n\tthis.init = function() { this._run = []; };\n\t\n\t/* fired is @deprecated in favor of hasFired*/\n\tthis.hasFired = this.fired = function() { return this._fired; } ;\n\n\t// preserve pending callbacks, but clear fired status\n\tthis.reset = function() { this._args = []; this._fired = false; };\n\n\t// clear fired status and remove any pending callbacks\n\tthis.clear = function() { this.reset(); this._run = []; this._pending = null; this._stat = null; };\n\n\t// a convenience function to proxy arguments to `this.run`: arguments passed as the first argument\n\tthis.forward = function(args) { this.run.apply(this, args); };\n\n\t// when the lib.Callback object fires, run a ctx, method, and\n\t// (optional) curried arguments or a single callback function\n\tthis.run = function(ctx, method) {\n\t\tvar f = method ? bind.apply(this, arguments) : ctx;\n\t\tif (f) {\n\t\t\tif (this._fired) {\n\t\t\t\tf.apply(this, this._args);\n\t\t\t} else {\n\t\t\t\tthis._run.push(f);\n\t\t\t}\n\t\t}\n\t\treturn this;\n\t};\n\n\tthis.runOrTimeout = function(onFire, onTimeout, duration) {\n\t\tif (!onFire && !onTimeout) { return; }\n\n\t\tif (this._fired) {\n\t\t\tonFire.apply(this, this._args);\n\t\t} else {\n\t\t\tvar f = bind(this, function() {\n\t\t\t\tclearTimeout(timeout);\n\t\t\t\tonFire.apply(this, this._args);\n\t\t\t});\n\n\t\t\tthis.run(f);\n\n\t\t\tvar timeout = setTimeout(bind(this, function() {\n\t\t\t\tfor (var i = 0, n = this._run.length; i < n; ++i) {\n\t\t\t\t\tif (this._run[i] == f) {\n\t\t\t\t\t\tthis._run.splice(i, 1);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tonTimeout();\n\t\t\t}), duration);\n\t\t}\n\t};\n\n\tthis.fire = function() {\n\t\tif (this._fired) { return; }\n\t\tthis._fired = true;\n\n\t\tvar cbs = this._run;\n\t\tthis._args = arguments;\n\t\tfor(var i = 0, len = cbs.length; i < len; ++i) {\n\t\t\tif (cbs[i]) { cbs[i].apply(this, arguments); }\n\t\t}\n\t};\n\n\tthis.chain = function(id) {\n\t\tif (!this._pending) { this._pending = {}; }\n\t\tif (id === undefined) { id = this._id++; }\n\t\tthis._pending[id] = true;\n\n\t\tthis.reset();\n\t\treturn bind(this, '_deferred', id);\n\t};\n\n\tthis._deferred = function(id) {\n\t\tif (!this._stat) { this._stat = {}; }\n\t\tif (this._stat.hasOwnProperty(id)) { return; }\n\n\t\tthis._stat[id] = Array.prototype.slice.call(arguments, 1);\n\t\tvar pending = this._pending;\n\t\tdelete pending[id];\n\t\tfor (var id in pending) {\n\t\t\tif (pending.hasOwnProperty(id)) { return; }\n\t\t}\n\n\t\tthis.fire(this._stat);\n\t};\n});\n","pre":true},"sdk/squill/models/BasicDataSource.js":{"path":"sdk/squill/models/BasicDataSource.js","friendlyPath":".BasicDataSource","directory":"sdk/squill/models/","filename":"BasicDataSource.js","src":"\"use import\";\n\njsio(\"import lib.PubSub as PubSub\");\n\nvar sdk_squill_models_BasicDataSource=__class__;var BasicDataSource = exports=sdk_squill_models_BasicDataSource(function sdk_squill_models_BasicDataSource(){return this.init&&this.init.apply(this,arguments)},PubSub, function(supr) {\n\tthis.init = function(opts) {\n\t\tsupr(this, 'init', arguments);\n\n\t\tthis.key = this._key = opts.key;\n\t\tthis._channel = opts.channel;\n\t\tthis._hasRemote = opts.hasRemote;\n\t};\n\n\tthis.getKey = function() {\n\t\treturn this._key;\n\t};\n});","pre":true},"sdk/squill/jscolor/jscolor.js":{"path":"sdk/squill/jscolor/jscolor.js","friendlyPath":".jscolor.jscolor","directory":"sdk/squill/jscolor/","filename":"jscolor.js","src":"\"use import\";\n\n/**\n * jscolor, JavaScript Color Picker\n *\n * @version 1.3.11\n * @license GNU Lesser General Public License, http://www.gnu.org/copyleft/lesser.html\n * @author  Jan Odvarko, http://odvarko.cz\n * @created 2008-06-15\n * @updated 2011-11-07\n * @link    http://jscolor.com\n */\n\n\nvar jscolor = {\n\n\n\tdir : '', // location of jscolor directory (leave empty to autodetect)\n\tbindClass : 'color', // class name\n\tbinding : true, // automatic binding via <input class=\"...\">\n\tpreloading : true, // use image preloading?\n\n\n\tinstall : function() {\n\t\tjscolor.addEvent(window, 'load', jscolor.init);\n\t},\n\n\n\tinit : function() {\n\t\tif(jscolor.binding) {\n\t\t\tjscolor.bind();\n\t\t}\n\t\tif(jscolor.preloading) {\n\t\t\tjscolor.preload();\n\t\t}\n\t},\n\n\n\tgetDir : function() {\n\t\t/*\n\t\tif(!jscolor.dir) {\n\t\t\tvar detected = jscolor.detectDir();\n\t\t\tjscolor.dir = detected!==false ? detected : 'jscolor/';\n\t\t}\n\t\t*/\n\t\tjscolor.dir = 'images/colorpicker/'\n\t\treturn jscolor.dir;\n\t},\n\n\n\tdetectDir : function() {\n\t\tvar base = location.href;\n\n\t\tvar e = document.getElementsByTagName('base');\n\t\tfor(var i=0; i<e.length; i+=1) {\n\t\t\tif(e[i].href) { base = e[i].href; }\n\t\t}\n\n\t\tvar e = document.getElementsByTagName('script');\n\t\tfor(var i=0; i<e.length; i+=1) {\n\t\t\tif(e[i].src && /(^|\\/)jscolor\\.js([?#].*)?$/i.test(e[i].src)) {\n\t\t\t\tvar src = new jscolor.URI(e[i].src);\n\t\t\t\tvar srcAbs = src.toAbsolute(base);\n\t\t\t\tsrcAbs.path = srcAbs.path.replace(/[^\\/]+$/, ''); // remove filename\n\t\t\t\tsrcAbs.query = null;\n\t\t\t\tsrcAbs.fragment = null;\n\t\t\t\treturn srcAbs.toString();\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t},\n\n\n\tbind : function(element) {\n\t\t/*\n\t\tvar matchClass = new RegExp('(^|\\\\s)('+jscolor.bindClass+')\\\\s*(\\\\{[^}]*\\\\})?', 'i');\n\t\tvar e = document.getElementsByTagName('input');\n\t\tfor(var i=0; i<e.length; i+=1) {\n\t\t\tvar m;\n\t\t\tif(!e[i].color && e[i].className && (m = e[i].className.match(matchClass))) {\n\t\t\t\tvar prop = {};\n\t\t\t\tif(m[3]) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\teval('prop='+m[3]);\n\t\t\t\t\t} catch(eInvalidProp) {}\n\t\t\t\t}\n\t\t\t\te[i].color = new jscolor.color(e[i], prop);\n\t\t\t}\n\t\t}\n\t\t*/\n\t\telement.color = new jscolor.color(element, {});\n\t},\n\n\n\tpreload : function() {\n\t\tfor(var fn in jscolor.imgRequire) {\n\t\t\tif(jscolor.imgRequire.hasOwnProperty(fn)) {\n\t\t\t\tjscolor.loadImage(fn);\n\t\t\t}\n\t\t}\n\t},\n\n\n\timages : {\n\t\tpad : [ 181, 101 ],\n\t\tsld : [ 16, 101 ],\n\t\tcross : [ 15, 15 ],\n\t\tarrow : [ 7, 11 ]\n\t},\n\n\n\timgRequire : {},\n\timgLoaded : {},\n\n\n\trequireImage : function(filename) {\n\t\tjscolor.imgRequire[filename] = true;\n\t},\n\n\n\tloadImage : function(filename) {\n\t\tif(!jscolor.imgLoaded[filename]) {\n\t\t\tjscolor.imgLoaded[filename] = new Image();\n\t\t\tjscolor.imgLoaded[filename].src = jscolor.getDir()+filename;\n\t\t}\n\t},\n\n\n\tfetchElement : function(mixed) {\n\t\treturn typeof mixed === 'string' ? document.getElementById(mixed) : mixed;\n\t},\n\n\n\taddEvent : function(el, evnt, func) {\n\t\tif(el.addEventListener) {\n\t\t\tel.addEventListener(evnt, func, false);\n\t\t} else if(el.attachEvent) {\n\t\t\tel.attachEvent('on'+evnt, func);\n\t\t}\n\t},\n\n\n\tfireEvent : function(el, evnt) {\n\t\tif(!el) {\n\t\t\treturn;\n\t\t}\n\t\tif(document.createEvent) {\n\t\t\tvar ev = document.createEvent('HTMLEvents');\n\t\t\tev.initEvent(evnt, true, true);\n\t\t\tel.dispatchEvent(ev);\n\t\t} else if(document.createEventObject) {\n\t\t\tvar ev = document.createEventObject();\n\t\t\tel.fireEvent('on'+evnt, ev);\n\t\t} else if(el['on'+evnt]) { // alternatively use the traditional event model (IE5)\n\t\t\tel['on'+evnt]();\n\t\t}\n\t},\n\n\n\tgetElementPos : function(e) {\n\t\tvar e1=e, e2=e;\n\t\tvar x=0, y=0;\n\t\tif(e1.offsetParent) {\n\t\t\tdo {\n\t\t\t\tx += e1.offsetLeft;\n\t\t\t\ty += e1.offsetTop;\n\t\t\t} while(e1 = e1.offsetParent);\n\t\t}\n\t\twhile((e2 = e2.parentNode) && e2.nodeName.toUpperCase() !== 'BODY') {\n\t\t\tx -= e2.scrollLeft;\n\t\t\ty -= e2.scrollTop;\n\t\t}\n\t\treturn [x, y];\n\t},\n\n\n\tgetElementSize : function(e) {\n\t\treturn [e.offsetWidth, e.offsetHeight];\n\t},\n\n\n\tgetRelMousePos : function(e) {\n\t\tvar x = 0, y = 0;\n\t\tif (!e) { e = window.event; }\n\t\tif (typeof e.offsetX === 'number') {\n\t\t\tx = e.offsetX;\n\t\t\ty = e.offsetY;\n\t\t} else if (typeof e.layerX === 'number') {\n\t\t\tx = e.layerX;\n\t\t\ty = e.layerY;\n\t\t}\n\t\treturn { x: x, y: y };\n\t},\n\n\n\tgetViewPos : function() {\n\t\tif(typeof window.pageYOffset === 'number') {\n\t\t\treturn [window.pageXOffset, window.pageYOffset];\n\t\t} else if(document.body && (document.body.scrollLeft || document.body.scrollTop)) {\n\t\t\treturn [document.body.scrollLeft, document.body.scrollTop];\n\t\t} else if(document.documentElement && (document.documentElement.scrollLeft || document.documentElement.scrollTop)) {\n\t\t\treturn [document.documentElement.scrollLeft, document.documentElement.scrollTop];\n\t\t} else {\n\t\t\treturn [0, 0];\n\t\t}\n\t},\n\n\n\tgetViewSize : function() {\n\t\tif(typeof window.innerWidth === 'number') {\n\t\t\treturn [window.innerWidth, window.innerHeight];\n\t\t} else if(document.body && (document.body.clientWidth || document.body.clientHeight)) {\n\t\t\treturn [document.body.clientWidth, document.body.clientHeight];\n\t\t} else if(document.documentElement && (document.documentElement.clientWidth || document.documentElement.clientHeight)) {\n\t\t\treturn [document.documentElement.clientWidth, document.documentElement.clientHeight];\n\t\t} else {\n\t\t\treturn [0, 0];\n\t\t}\n\t},\n\n\n\tURI : function(uri) { // See RFC3986\n\n\t\tthis.scheme = null;\n\t\tthis.authority = null;\n\t\tthis.path = '';\n\t\tthis.query = null;\n\t\tthis.fragment = null;\n\n\t\tthis.parse = function(uri) {\n\t\t\tvar m = uri.match(/^(([A-Za-z][0-9A-Za-z+.-]*)(:))?((\\/\\/)([^\\/?#]*))?([^?#]*)((\\?)([^#]*))?((#)(.*))?/);\n\t\t\tthis.scheme = m[3] ? m[2] : null;\n\t\t\tthis.authority = m[5] ? m[6] : null;\n\t\t\tthis.path = m[7];\n\t\t\tthis.query = m[9] ? m[10] : null;\n\t\t\tthis.fragment = m[12] ? m[13] : null;\n\t\t\treturn this;\n\t\t};\n\n\t\tthis.toString = function() {\n\t\t\tvar result = '';\n\t\t\tif(this.scheme !== null) { result = result + this.scheme + ':'; }\n\t\t\tif(this.authority !== null) { result = result + '//' + this.authority; }\n\t\t\tif(this.path !== null) { result = result + this.path; }\n\t\t\tif(this.query !== null) { result = result + '?' + this.query; }\n\t\t\tif(this.fragment !== null) { result = result + '#' + this.fragment; }\n\t\t\treturn result;\n\t\t};\n\n\t\tthis.toAbsolute = function(base) {\n\t\t\tvar base = new jscolor.URI(base);\n\t\t\tvar r = this;\n\t\t\tvar t = new jscolor.URI;\n\n\t\t\tif(base.scheme === null) { return false; }\n\n\t\t\tif(r.scheme !== null && r.scheme.toLowerCase() === base.scheme.toLowerCase()) {\n\t\t\t\tr.scheme = null;\n\t\t\t}\n\n\t\t\tif(r.scheme !== null) {\n\t\t\t\tt.scheme = r.scheme;\n\t\t\t\tt.authority = r.authority;\n\t\t\t\tt.path = removeDotSegments(r.path);\n\t\t\t\tt.query = r.query;\n\t\t\t} else {\n\t\t\t\tif(r.authority !== null) {\n\t\t\t\t\tt.authority = r.authority;\n\t\t\t\t\tt.path = removeDotSegments(r.path);\n\t\t\t\t\tt.query = r.query;\n\t\t\t\t} else {\n\t\t\t\t\tif(r.path === '') { // TODO: == or === ?\n\t\t\t\t\t\tt.path = base.path;\n\t\t\t\t\t\tif(r.query !== null) {\n\t\t\t\t\t\t\tt.query = r.query;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tt.query = base.query;\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif(r.path.substr(0,1) === '/') {\n\t\t\t\t\t\t\tt.path = removeDotSegments(r.path);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tif(base.authority !== null && base.path === '') { // TODO: == or === ?\n\t\t\t\t\t\t\t\tt.path = '/'+r.path;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tt.path = base.path.replace(/[^\\/]+$/,'')+r.path;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tt.path = removeDotSegments(t.path);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tt.query = r.query;\n\t\t\t\t\t}\n\t\t\t\t\tt.authority = base.authority;\n\t\t\t\t}\n\t\t\t\tt.scheme = base.scheme;\n\t\t\t}\n\t\t\tt.fragment = r.fragment;\n\n\t\t\treturn t;\n\t\t};\n\n\t\tfunction removeDotSegments(path) {\n\t\t\tvar out = '';\n\t\t\twhile(path) {\n\t\t\t\tif(path.substr(0,3)==='../' || path.substr(0,2)==='./') {\n\t\t\t\t\tpath = path.replace(/^\\.+/,'').substr(1);\n\t\t\t\t} else if(path.substr(0,3)==='/./' || path==='/.') {\n\t\t\t\t\tpath = '/'+path.substr(3);\n\t\t\t\t} else if(path.substr(0,4)==='/../' || path==='/..') {\n\t\t\t\t\tpath = '/'+path.substr(4);\n\t\t\t\t\tout = out.replace(/\\/?[^\\/]*$/, '');\n\t\t\t\t} else if(path==='.' || path==='..') {\n\t\t\t\t\tpath = '';\n\t\t\t\t} else {\n\t\t\t\t\tvar rm = path.match(/^\\/?[^\\/]*/)[0];\n\t\t\t\t\tpath = path.substr(rm.length);\n\t\t\t\t\tout = out + rm;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn out;\n\t\t}\n\n\t\tif(uri) {\n\t\t\tthis.parse(uri);\n\t\t}\n\n\t},\n\n\n\t/*\n\t * Usage example:\n\t * var myColor = new jscolor.color(myInputElement)\n\t */\n\n\tcolor : function(target, prop) {\n\n\n\t\tthis.required = true; // refuse empty values?\n\t\tthis.adjust = true; // adjust value to uniform notation?\n\t\tthis.hash = false; // prefix color with # symbol?\n\t\tthis.caps = true; // uppercase?\n\t\tthis.slider = true; // show the value/saturation slider?\n\t\tthis.valueElement = target; // value holder\n\t\tthis.styleElement = target; // where to reflect current color\n\t\tthis.onImmediateChange = null; // onchange callback (can be either string or function)\n\t\tthis.hsv = [0, 0, 1]; // read-only  0-6, 0-1, 0-1\n\t\tthis.rgb = [1, 1, 1]; // read-only  0-1, 0-1, 0-1\n\n\t\tthis.pickerOnfocus = true; // display picker on focus?\n\t\tthis.pickerMode = 'HSV'; // HSV | HVS\n\t\tthis.pickerPosition = 'bottom'; // left | right | top | bottom\n\t\tthis.pickerSmartPosition = true; // automatically adjust picker position when necessary\n\t\tthis.pickerButtonHeight = 20; // px\n\t\tthis.pickerClosable = false;\n\t\tthis.pickerCloseText = 'Close';\n\t\tthis.pickerButtonColor = 'ButtonText'; // px\n\t\tthis.pickerFace = 10; // px\n\t\tthis.pickerFaceColor = 'ThreeDFace'; // CSS color\n\t\tthis.pickerBorder = 1; // px\n\t\tthis.pickerBorderColor = 'ThreeDHighlight ThreeDShadow ThreeDShadow ThreeDHighlight'; // CSS color\n\t\tthis.pickerInset = 1; // px\n\t\tthis.pickerInsetColor = 'ThreeDShadow ThreeDHighlight ThreeDHighlight ThreeDShadow'; // CSS color\n\t\tthis.pickerZIndex = 10000;\n\n\n\t\tfor(var p in prop) {\n\t\t\tif(prop.hasOwnProperty(p)) {\n\t\t\t\tthis[p] = prop[p];\n\t\t\t}\n\t\t}\n\n\n\t\tthis.hidePicker = function() {\n\t\t\tif(isPickerOwner()) {\n\t\t\t\tremovePicker();\n\t\t\t}\n\t\t};\n\n\n\t\tthis.showPicker = function() {\n\t\t\tif(!isPickerOwner()) {\n\t\t\t\tvar tp = jscolor.getElementPos(target); // target pos\n\t\t\t\tvar ts = jscolor.getElementSize(target); // target size\n\t\t\t\tvar vp = jscolor.getViewPos(); // view pos\n\t\t\t\tvar vs = jscolor.getViewSize(); // view size\n\t\t\t\tvar ps = getPickerDims(this); // picker size\n\t\t\t\tvar a, b, c;\n\t\t\t\tswitch(this.pickerPosition.toLowerCase()) {\n\t\t\t\t\tcase 'left': a=1; b=0; c=-1; break;\n\t\t\t\t\tcase 'right':a=1; b=0; c=1; break;\n\t\t\t\t\tcase 'top':  a=0; b=1; c=-1; break;\n\t\t\t\t\tdefault:     a=0; b=1; c=1; break;\n\t\t\t\t}\n\t\t\t\tvar l = (ts[b]+ps[b])/2;\n\n\t\t\t\t// picker pos\n\t\t\t\tif (!this.pickerSmartPosition) {\n\t\t\t\t\tvar pp = [\n\t\t\t\t\t\ttp[a],\n\t\t\t\t\t\ttp[b]+ts[b]-l+l*c\n\t\t\t\t\t];\n\t\t\t\t} else {\n\t\t\t\t\tvar pp = [\n\t\t\t\t\t\t-vp[a]+tp[a]+ps[a] > vs[a] ?\n\t\t\t\t\t\t\t(-vp[a]+tp[a]+ts[a]/2 > vs[a]/2 && tp[a]+ts[a]-ps[a] >= 0 ? tp[a]+ts[a]-ps[a] : tp[a]) :\n\t\t\t\t\t\t\ttp[a],\n\t\t\t\t\t\t-vp[b]+tp[b]+ts[b]+ps[b]-l+l*c > vs[b] ?\n\t\t\t\t\t\t\t(-vp[b]+tp[b]+ts[b]/2 > vs[b]/2 && tp[b]+ts[b]-l-l*c >= 0 ? tp[b]+ts[b]-l-l*c : tp[b]+ts[b]-l+l*c) :\n\t\t\t\t\t\t\t(tp[b]+ts[b]-l+l*c >= 0 ? tp[b]+ts[b]-l+l*c : tp[b]+ts[b]-l-l*c)\n\t\t\t\t\t];\n\t\t\t\t}\n\t\t\t\tdrawPicker(pp[a], pp[b]);\n\t\t\t}\n\t\t};\n\n\n\t\tthis.importColor = function() {\n\t\t\tif(!valueElement) {\n\t\t\t\tthis.exportColor();\n\t\t\t} else {\n\t\t\t\tif(!this.adjust) {\n\t\t\t\t\tif(!this.fromString(valueElement.value, leaveValue)) {\n\t\t\t\t\t\tstyleElement.style.backgroundColor = styleElement.jscStyle.backgroundColor;\n\t\t\t\t\t\tstyleElement.style.color = styleElement.jscStyle.color;\n\t\t\t\t\t\tthis.exportColor(leaveValue | leaveStyle);\n\t\t\t\t\t}\n\t\t\t\t} else if(!this.required && /^\\s*$/.test(valueElement.value)) {\n\t\t\t\t\tvalueElement.value = '';\n\t\t\t\t\tstyleElement.style.backgroundColor = styleElement.jscStyle.backgroundColor;\n\t\t\t\t\tstyleElement.style.color = styleElement.jscStyle.color;\n\t\t\t\t\tthis.exportColor(leaveValue | leaveStyle);\n\n\t\t\t\t} else if(this.fromString(valueElement.value)) {\n\t\t\t\t\t// OK\n\t\t\t\t} else {\n\t\t\t\t\tthis.exportColor();\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\n\t\tthis.exportColor = function(flags) {\n\t\t\tif(!(flags & leaveValue) && valueElement) {\n\t\t\t\tvar value = this.toString();\n\t\t\t\tif(this.caps) { value = value.toUpperCase(); }\n\t\t\t\tif(this.hash) { value = '#'+value; }\n\t\t\t\tvalueElement.value = value;\n\t\t\t}\n\t\t\tif(!(flags & leaveStyle) && styleElement) {\n\t\t\t\tstyleElement.style.backgroundColor =\n\t\t\t\t\t'#'+this.toString();\n\t\t\t\tstyleElement.style.color =\n\t\t\t\t\t0.213 * this.rgb[0] +\n\t\t\t\t\t0.715 * this.rgb[1] +\n\t\t\t\t\t0.072 * this.rgb[2]\n\t\t\t\t\t< 0.5 ? '#FFF' : '#000';\n\t\t\t}\n\t\t\tif(!(flags & leavePad) && isPickerOwner()) {\n\t\t\t\tredrawPad();\n\t\t\t}\n\t\t\tif(!(flags & leaveSld) && isPickerOwner()) {\n\t\t\t\tredrawSld();\n\t\t\t}\n\t\t};\n\n\n\t\tthis.fromHSV = function(h, s, v, flags) { // null = don't change\n\t\t\th<0 && (h=0) || h>6 && (h=6);\n\t\t\ts<0 && (s=0) || s>1 && (s=1);\n\t\t\tv<0 && (v=0) || v>1 && (v=1);\n\t\t\tthis.rgb = HSV_RGB(\n\t\t\t\th===null ? this.hsv[0] : (this.hsv[0]=h),\n\t\t\t\ts===null ? this.hsv[1] : (this.hsv[1]=s),\n\t\t\t\tv===null ? this.hsv[2] : (this.hsv[2]=v)\n\t\t\t);\n\t\t\tthis.exportColor(flags);\n\t\t};\n\n\n\t\tthis.fromRGB = function(r, g, b, flags) { // null = don't change\n\t\t\tr<0 && (r=0) || r>1 && (r=1);\n\t\t\tg<0 && (g=0) || g>1 && (g=1);\n\t\t\tb<0 && (b=0) || b>1 && (b=1);\n\t\t\tvar hsv = RGB_HSV(\n\t\t\t\tr===null ? this.rgb[0] : (this.rgb[0]=r),\n\t\t\t\tg===null ? this.rgb[1] : (this.rgb[1]=g),\n\t\t\t\tb===null ? this.rgb[2] : (this.rgb[2]=b)\n\t\t\t);\n\t\t\tif(hsv[0] !== null) {\n\t\t\t\tthis.hsv[0] = hsv[0];\n\t\t\t}\n\t\t\tif(hsv[2] !== 0) {\n\t\t\t\tthis.hsv[1] = hsv[1];\n\t\t\t}\n\t\t\tthis.hsv[2] = hsv[2];\n\t\t\tthis.exportColor(flags);\n\t\t};\n\n\n\t\tthis.fromString = function(hex, flags) {\n\t\t\tvar m = hex.match(/^\\W*([0-9A-F]{3}([0-9A-F]{3})?)\\W*$/i);\n\t\t\tif(!m) {\n\t\t\t\treturn false;\n\t\t\t} else {\n\t\t\t\tif(m[1].length === 6) { // 6-char notation\n\t\t\t\t\tthis.fromRGB(\n\t\t\t\t\t\tparseInt(m[1].substr(0,2),16) / 255,\n\t\t\t\t\t\tparseInt(m[1].substr(2,2),16) / 255,\n\t\t\t\t\t\tparseInt(m[1].substr(4,2),16) / 255,\n\t\t\t\t\t\tflags\n\t\t\t\t\t);\n\t\t\t\t} else { // 3-char notation\n\t\t\t\t\tthis.fromRGB(\n\t\t\t\t\t\tparseInt(m[1].charAt(0)+m[1].charAt(0),16) / 255,\n\t\t\t\t\t\tparseInt(m[1].charAt(1)+m[1].charAt(1),16) / 255,\n\t\t\t\t\t\tparseInt(m[1].charAt(2)+m[1].charAt(2),16) / 255,\n\t\t\t\t\t\tflags\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\treturn true;\n\t\t\t}\n\t\t};\n\n\n\t\tthis.toString = function() {\n\t\t\treturn (\n\t\t\t\t(0x100 | Math.round(255*this.rgb[0])).toString(16).substr(1) +\n\t\t\t\t(0x100 | Math.round(255*this.rgb[1])).toString(16).substr(1) +\n\t\t\t\t(0x100 | Math.round(255*this.rgb[2])).toString(16).substr(1)\n\t\t\t);\n\t\t};\n\n\n\t\tfunction RGB_HSV(r, g, b) {\n\t\t\tvar n = Math.min(Math.min(r,g),b);\n\t\t\tvar v = Math.max(Math.max(r,g),b);\n\t\t\tvar m = v - n;\n\t\t\tif(m === 0) { return [ null, 0, v ]; }\n\t\t\tvar h = r===n ? 3+(b-g)/m : (g===n ? 5+(r-b)/m : 1+(g-r)/m);\n\t\t\treturn [ h===6?0:h, m/v, v ];\n\t\t}\n\n\n\t\tfunction HSV_RGB(h, s, v) {\n\t\t\tif(h === null) { return [ v, v, v ]; }\n\t\t\tvar i = Math.floor(h);\n\t\t\tvar f = i%2 ? h-i : 1-(h-i);\n\t\t\tvar m = v * (1 - s);\n\t\t\tvar n = v * (1 - s*f);\n\t\t\tswitch(i) {\n\t\t\t\tcase 6:\n\t\t\t\tcase 0: return [v,n,m];\n\t\t\t\tcase 1: return [n,v,m];\n\t\t\t\tcase 2: return [m,v,n];\n\t\t\t\tcase 3: return [m,n,v];\n\t\t\t\tcase 4: return [n,m,v];\n\t\t\t\tcase 5: return [v,m,n];\n\t\t\t}\n\t\t}\n\n\n\t\tfunction removePicker() {\n\t\t\tdelete jscolor.picker.owner;\n\t\t\tdocument.getElementsByTagName('body')[0].removeChild(jscolor.picker.boxB);\n\t\t}\n\n\n\t\tfunction drawPicker(x, y) {\n\t\t\tif(!jscolor.picker) {\n\t\t\t\tjscolor.picker = {\n\t\t\t\t\tbox : document.createElement('div'),\n\t\t\t\t\tboxB : document.createElement('div'),\n\t\t\t\t\tpad : document.createElement('div'),\n\t\t\t\t\tpadB : document.createElement('div'),\n\t\t\t\t\tpadM : document.createElement('div'),\n\t\t\t\t\tsld : document.createElement('div'),\n\t\t\t\t\tsldB : document.createElement('div'),\n\t\t\t\t\tsldM : document.createElement('div'),\n\t\t\t\t\tbtn : document.createElement('div'),\n\t\t\t\t\tbtnS : document.createElement('span'),\n\t\t\t\t\tbtnT : document.createTextNode(THIS.pickerCloseText)\n\t\t\t\t};\n\t\t\t\tfor(var i=0,segSize=4; i<jscolor.images.sld[1]; i+=segSize) {\n\t\t\t\t\tvar seg = document.createElement('div');\n\t\t\t\t\tseg.style.height = segSize+'px';\n\t\t\t\t\tseg.style.fontSize = '1px';\n\t\t\t\t\tseg.style.lineHeight = '0';\n\t\t\t\t\tjscolor.picker.sld.appendChild(seg);\n\t\t\t\t}\n\t\t\t\tjscolor.picker.sldB.appendChild(jscolor.picker.sld);\n\t\t\t\tjscolor.picker.box.appendChild(jscolor.picker.sldB);\n\t\t\t\tjscolor.picker.box.appendChild(jscolor.picker.sldM);\n\t\t\t\tjscolor.picker.padB.appendChild(jscolor.picker.pad);\n\t\t\t\tjscolor.picker.box.appendChild(jscolor.picker.padB);\n\t\t\t\tjscolor.picker.box.appendChild(jscolor.picker.padM);\n\t\t\t\tjscolor.picker.btnS.appendChild(jscolor.picker.btnT);\n\t\t\t\tjscolor.picker.btn.appendChild(jscolor.picker.btnS);\n\t\t\t\tjscolor.picker.box.appendChild(jscolor.picker.btn);\n\t\t\t\tjscolor.picker.boxB.appendChild(jscolor.picker.box);\n\t\t\t}\n\n\t\t\tvar p = jscolor.picker;\n\n\t\t\t// controls interaction\n\t\t\tp.box.onmouseup =\n\t\t\tp.box.onmouseout = function() { target.focus(); };\n\t\t\tp.box.onmousedown = function() { abortBlur=true; };\n\t\t\tp.box.onmousemove = function(e) {\n\t\t\t\tif (holdPad || holdSld) {\n\t\t\t\t\tholdPad && setPad(e);\n\t\t\t\t\tholdSld && setSld(e);\n\t\t\t\t\tif (document.selection) {\n\t\t\t\t\t\tdocument.selection.empty();\n\t\t\t\t\t} else if (window.getSelection) {\n\t\t\t\t\t\twindow.getSelection().removeAllRanges();\n\t\t\t\t\t}\n\t\t\t\t\tdispatchImmediateChange();\n\t\t\t\t}\n\t\t\t};\n\t\t\tp.padM.onmouseup =\n\t\t\tp.padM.onmouseout = function() { if(holdPad) { holdPad=false; jscolor.fireEvent(valueElement,'change'); } };\n\t\t\tp.padM.onmousedown = function(e) {\n\t\t\t\tholdPad=true;\n\t\t\t\tsetPad(e);\n\t\t\t\tdispatchImmediateChange();\n\t\t\t};\n\t\t\tp.sldM.onmouseup =\n\t\t\tp.sldM.onmouseout = function() { if(holdSld) { holdSld=false; jscolor.fireEvent(valueElement,'change'); } };\n\t\t\tp.sldM.onmousedown = function(e) {\n\t\t\t\tholdSld=true;\n\t\t\t\tsetSld(e);\n\t\t\t\tdispatchImmediateChange();\n\t\t\t};\n\n\t\t\t// picker\n\t\t\tvar dims = getPickerDims(THIS);\n\t\t\tp.box.style.width = dims[0] + 'px';\n\t\t\tp.box.style.height = dims[1] + 'px';\n\n\t\t\t// picker border\n\t\t\tp.boxB.style.position = 'absolute';\n\t\t\tp.boxB.style.clear = 'both';\n\t\t\tp.boxB.style.left = x+'px';\n\t\t\tp.boxB.style.top = y+'px';\n\t\t\tp.boxB.style.zIndex = THIS.pickerZIndex;\n\t\t\t//p.boxB.style.border = THIS.pickerBorder+'px solid';\n\t\t\t//p.boxB.style.borderColor = THIS.pickerBorderColor;\n\t\t\t//p.boxB.style.background = THIS.pickerFaceColor;\n\t\t\tp.boxB.className = 'colorMenu';\n\n\t\t\t// pad image\n\t\t\tp.pad.style.width = jscolor.images.pad[0]+'px';\n\t\t\tp.pad.style.height = jscolor.images.pad[1]+'px';\n\n\t\t\t// pad border\n\t\t\tp.padB.style.position = 'absolute';\n\t\t\tp.padB.style.left = THIS.pickerFace+'px';\n\t\t\tp.padB.style.top = THIS.pickerFace+'px';\n\t\t\tp.padB.style.border = THIS.pickerInset+'px solid';\n\t\t\tp.padB.style.borderColor = THIS.pickerInsetColor;\n\n\t\t\t// pad mouse area\n\t\t\tp.padM.style.position = 'absolute';\n\t\t\tp.padM.style.left = '0';\n\t\t\tp.padM.style.top = '0';\n\t\t\tp.padM.style.width = THIS.pickerFace + 2*THIS.pickerInset + jscolor.images.pad[0] + jscolor.images.arrow[0] + 'px';\n\t\t\tp.padM.style.height = p.box.style.height;\n\t\t\tp.padM.style.cursor = 'crosshair';\n\n\t\t\t// slider image\n\t\t\tp.sld.style.overflow = 'hidden';\n\t\t\tp.sld.style.width = jscolor.images.sld[0]+'px';\n\t\t\tp.sld.style.height = jscolor.images.sld[1]+'px';\n\n\t\t\t// slider border\n\t\t\tp.sldB.style.display = THIS.slider ? 'block' : 'none';\n\t\t\tp.sldB.style.position = 'absolute';\n\t\t\tp.sldB.style.right = THIS.pickerFace+'px';\n\t\t\tp.sldB.style.top = THIS.pickerFace+'px';\n\t\t\tp.sldB.style.border = THIS.pickerInset+'px solid';\n\t\t\tp.sldB.style.borderColor = THIS.pickerInsetColor;\n\n\t\t\t// slider mouse area\n\t\t\tp.sldM.style.display = THIS.slider ? 'block' : 'none';\n\t\t\tp.sldM.style.position = 'absolute';\n\t\t\tp.sldM.style.right = '0';\n\t\t\tp.sldM.style.top = '0';\n\t\t\tp.sldM.style.width = jscolor.images.sld[0] + jscolor.images.arrow[0] + THIS.pickerFace + 2*THIS.pickerInset + 'px';\n\t\t\tp.sldM.style.height = p.box.style.height;\n\t\t\ttry {\n\t\t\t\tp.sldM.style.cursor = 'pointer';\n\t\t\t} catch(eOldIE) {\n\t\t\t\tp.sldM.style.cursor = 'hand';\n\t\t\t}\n\n\t\t\t// \"close\" button\n\t\t\tfunction setBtnBorder() {\n\t\t\t\tvar insetColors = THIS.pickerInsetColor.split(/\\s+/);\n\t\t\t\tvar pickerOutsetColor = insetColors.length < 2 ? insetColors[0] : insetColors[1] + ' ' + insetColors[0] + ' ' + insetColors[0] + ' ' + insetColors[1];\n\t\t\t\tp.btn.style.borderColor = pickerOutsetColor;\n\t\t\t}\n\t\t\tp.btn.style.display = THIS.pickerClosable ? 'block' : 'none';\n\t\t\tp.btn.style.position = 'absolute';\n\t\t\tp.btn.style.left = THIS.pickerFace + 'px';\n\t\t\tp.btn.style.bottom = THIS.pickerFace + 'px';\n\t\t\tp.btn.style.padding = '0 15px';\n\t\t\tp.btn.style.height = '18px';\n\t\t\tp.btn.style.border = THIS.pickerInset + 'px solid';\n\t\t\tsetBtnBorder();\n\t\t\tp.btn.style.color = THIS.pickerButtonColor;\n\t\t\tp.btn.style.font = '12px sans-serif';\n\t\t\tp.btn.style.textAlign = 'center';\n\t\t\ttry {\n\t\t\t\tp.btn.style.cursor = 'pointer';\n\t\t\t} catch(eOldIE) {\n\t\t\t\tp.btn.style.cursor = 'hand';\n\t\t\t}\n\t\t\tp.btn.onmousedown = function () {\n\t\t\t\tTHIS.hidePicker();\n\t\t\t};\n\t\t\tp.btnS.style.lineHeight = p.btn.style.height;\n\n\t\t\t// load images in optimal order\n\t\t\tswitch(modeID) {\n\t\t\t\tcase 0: var padImg = 'hs.png'; break;\n\t\t\t\tcase 1: var padImg = 'hv.png'; break;\n\t\t\t}\n\t\t\tp.padM.style.backgroundImage = \"url('\"+jscolor.getDir()+\"cross.gif')\";\n\t\t\tp.padM.style.backgroundRepeat = \"no-repeat\";\n\t\t\tp.sldM.style.backgroundImage = \"url('\"+jscolor.getDir()+\"arrow.gif')\";\n\t\t\tp.sldM.style.backgroundRepeat = \"no-repeat\";\n\t\t\tp.pad.style.backgroundImage = \"url('\"+jscolor.getDir()+padImg+\"')\";\n\t\t\tp.pad.style.backgroundRepeat = \"no-repeat\";\n\t\t\tp.pad.style.backgroundPosition = \"0 0\";\n\n\t\t\t// place pointers\n\t\t\tredrawPad();\n\t\t\tredrawSld();\n\n\t\t\tjscolor.picker.owner = THIS;\n\t\t\tdocument.getElementsByTagName('body')[0].appendChild(p.boxB);\n\t\t}\n\n\n\t\tfunction getPickerDims(o) {\n\t\t\tvar dims = [\n\t\t\t\t2*o.pickerInset + 2*o.pickerFace + jscolor.images.pad[0] +\n\t\t\t\t\t(o.slider ? 2*o.pickerInset + 2*jscolor.images.arrow[0] + jscolor.images.sld[0] : 0),\n\t\t\t\to.pickerClosable ?\n\t\t\t\t\t4*o.pickerInset + 3*o.pickerFace + jscolor.images.pad[1] + o.pickerButtonHeight :\n\t\t\t\t\t2*o.pickerInset + 2*o.pickerFace + jscolor.images.pad[1]\n\t\t\t];\n\t\t\treturn dims;\n\t\t}\n\n\n\t\tfunction redrawPad() {\n\t\t\t// redraw the pad pointer\n\t\t\tswitch(modeID) {\n\t\t\t\tcase 0: var yComponent = 1; break;\n\t\t\t\tcase 1: var yComponent = 2; break;\n\t\t\t}\n\t\t\tvar x = Math.round((THIS.hsv[0]/6) * (jscolor.images.pad[0]-1));\n\t\t\tvar y = Math.round((1-THIS.hsv[yComponent]) * (jscolor.images.pad[1]-1));\n\t\t\tjscolor.picker.padM.style.backgroundPosition =\n\t\t\t\t(THIS.pickerFace+THIS.pickerInset+x - Math.floor(jscolor.images.cross[0]/2)) + 'px ' +\n\t\t\t\t(THIS.pickerFace+THIS.pickerInset+y - Math.floor(jscolor.images.cross[1]/2)) + 'px';\n\n\t\t\t// redraw the slider image\n\t\t\tvar seg = jscolor.picker.sld.childNodes;\n\n\t\t\tswitch(modeID) {\n\t\t\t\tcase 0:\n\t\t\t\t\tvar rgb = HSV_RGB(THIS.hsv[0], THIS.hsv[1], 1);\n\t\t\t\t\tfor(var i=0; i<seg.length; i+=1) {\n\t\t\t\t\t\tseg[i].style.backgroundColor = 'rgb('+\n\t\t\t\t\t\t\t(rgb[0]*(1-i/seg.length)*100)+'%,'+\n\t\t\t\t\t\t\t(rgb[1]*(1-i/seg.length)*100)+'%,'+\n\t\t\t\t\t\t\t(rgb[2]*(1-i/seg.length)*100)+'%)';\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase 1:\n\t\t\t\t\tvar rgb, s, c = [ THIS.hsv[2], 0, 0 ];\n\t\t\t\t\tvar i = Math.floor(THIS.hsv[0]);\n\t\t\t\t\tvar f = i%2 ? THIS.hsv[0]-i : 1-(THIS.hsv[0]-i);\n\t\t\t\t\tswitch(i) {\n\t\t\t\t\t\tcase 6:\n\t\t\t\t\t\tcase 0: rgb=[0,1,2]; break;\n\t\t\t\t\t\tcase 1: rgb=[1,0,2]; break;\n\t\t\t\t\t\tcase 2: rgb=[2,0,1]; break;\n\t\t\t\t\t\tcase 3: rgb=[2,1,0]; break;\n\t\t\t\t\t\tcase 4: rgb=[1,2,0]; break;\n\t\t\t\t\t\tcase 5: rgb=[0,2,1]; break;\n\t\t\t\t\t}\n\t\t\t\t\tfor(var i=0; i<seg.length; i+=1) {\n\t\t\t\t\t\ts = 1 - 1/(seg.length-1)*i;\n\t\t\t\t\t\tc[1] = c[0] * (1 - s*f);\n\t\t\t\t\t\tc[2] = c[0] * (1 - s);\n\t\t\t\t\t\tseg[i].style.backgroundColor = 'rgb('+\n\t\t\t\t\t\t\t(c[rgb[0]]*100)+'%,'+\n\t\t\t\t\t\t\t(c[rgb[1]]*100)+'%,'+\n\t\t\t\t\t\t\t(c[rgb[2]]*100)+'%)';\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\n\t\tfunction redrawSld() {\n\t\t\t// redraw the slider pointer\n\t\t\tswitch(modeID) {\n\t\t\t\tcase 0: var yComponent = 2; break;\n\t\t\t\tcase 1: var yComponent = 1; break;\n\t\t\t}\n\t\t\tvar y = Math.round((1-THIS.hsv[yComponent]) * (jscolor.images.sld[1]-1));\n\t\t\tjscolor.picker.sldM.style.backgroundPosition =\n\t\t\t\t'0 ' + (THIS.pickerFace+THIS.pickerInset+y - Math.floor(jscolor.images.arrow[1]/2)) + 'px';\n\t\t}\n\n\n\t\tfunction isPickerOwner() {\n\t\t\treturn jscolor.picker && jscolor.picker.owner === THIS;\n\t\t}\n\n\n\t\tfunction blurTarget() {\n\t\t\tif(valueElement === target) {\n\t\t\t\tTHIS.importColor();\n\t\t\t}\n\t\t\tif(THIS.pickerOnfocus) {\n\t\t\t\tTHIS.hidePicker();\n\t\t\t}\n\t\t}\n\n\n\t\tfunction blurValue() {\n\t\t\tif(valueElement !== target) {\n\t\t\t\tTHIS.importColor();\n\t\t\t}\n\t\t}\n\n\n\t\tfunction setPad(e) {\n\t\t\tvar mpos = jscolor.getRelMousePos(e);\n\t\t\tvar x = mpos.x - THIS.pickerFace - THIS.pickerInset;\n\t\t\tvar y = mpos.y - THIS.pickerFace - THIS.pickerInset;\n\t\t\tswitch(modeID) {\n\t\t\t\tcase 0: THIS.fromHSV(x*(6/(jscolor.images.pad[0]-1)), 1 - y/(jscolor.images.pad[1]-1), null, leaveSld); break;\n\t\t\t\tcase 1: THIS.fromHSV(x*(6/(jscolor.images.pad[0]-1)), null, 1 - y/(jscolor.images.pad[1]-1), leaveSld); break;\n\t\t\t}\n\t\t}\n\n\n\t\tfunction setSld(e) {\n\t\t\tvar mpos = jscolor.getRelMousePos(e);\n\t\t\tvar y = mpos.y - THIS.pickerFace - THIS.pickerInset;\n\t\t\tswitch(modeID) {\n\t\t\t\tcase 0: THIS.fromHSV(null, null, 1 - y/(jscolor.images.sld[1]-1), leavePad); break;\n\t\t\t\tcase 1: THIS.fromHSV(null, 1 - y/(jscolor.images.sld[1]-1), null, leavePad); break;\n\t\t\t}\n\t\t}\n\n\n\t\tfunction dispatchImmediateChange() {\n\t\t\tif (THIS.onImmediateChange) {\n\t\t\t\tif (typeof THIS.onImmediateChange === 'string') {\n\t\t\t\t\teval(THIS.onImmediateChange);\n\t\t\t\t} else {\n\t\t\t\t\tTHIS.onImmediateChange(THIS);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\n\t\tvar THIS = this;\n\t\tvar modeID = this.pickerMode.toLowerCase()==='hvs' ? 1 : 0;\n\t\tvar abortBlur = false;\n\t\tvar\n\t\t\tvalueElement = jscolor.fetchElement(this.valueElement),\n\t\t\tstyleElement = jscolor.fetchElement(this.styleElement);\n\t\tvar\n\t\t\tholdPad = false,\n\t\t\tholdSld = false;\n\t\tvar\n\t\t\tleaveValue = 1<<0,\n\t\t\tleaveStyle = 1<<1,\n\t\t\tleavePad = 1<<2,\n\t\t\tleaveSld = 1<<3;\n\n\t\t// target\n\t\tjscolor.addEvent(target, 'focus', function() {\n\t\t\tif(THIS.pickerOnfocus) { THIS.showPicker(); }\n\t\t});\n\t\tjscolor.addEvent(target, 'blur', function() {\n\t\t\tif(!abortBlur) {\n\t\t\t\twindow.setTimeout(function(){ abortBlur || blurTarget(); abortBlur=false; }, 0);\n\t\t\t} else {\n\t\t\t\tabortBlur = false;\n\t\t\t}\n\t\t});\n\n\t\t// valueElement\n\t\tif(valueElement) {\n\t\t\tvar updateField = function() {\n\t\t\t\tTHIS.fromString(valueElement.value, leaveValue);\n\t\t\t\tdispatchImmediateChange();\n\t\t\t};\n\t\t\tjscolor.addEvent(valueElement, 'keyup', updateField);\n\t\t\tjscolor.addEvent(valueElement, 'input', updateField);\n\t\t\tjscolor.addEvent(valueElement, 'blur', blurValue);\n\t\t\tvalueElement.setAttribute('autocomplete', 'off');\n\t\t}\n\n\t\t// styleElement\n\t\tif(styleElement) {\n\t\t\tstyleElement.jscStyle = {\n\t\t\t\tbackgroundColor : styleElement.style.backgroundColor,\n\t\t\t\tcolor : styleElement.style.color\n\t\t\t};\n\t\t}\n\n\t\t// require images\n\t\tswitch(modeID) {\n\t\t\tcase 0: jscolor.requireImage('hs.png'); break;\n\t\t\tcase 1: jscolor.requireImage('hv.png'); break;\n\t\t}\n\t\tjscolor.requireImage('cross.gif');\n\t\tjscolor.requireImage('arrow.gif');\n\n\t\tthis.importColor();\n\t}\n\n};\n\n//jscolor.install();\nexports = jscolor;\n","pre":true},"sdk/squill/Label.js":{"path":"sdk/squill/Label.js","friendlyPath":".Label","directory":"sdk/squill/","filename":"Label.js","src":"jsio(\"from util.browser import $\");\njsio(\"import squill.Widget\");\n\nvar sdk_squill_Label=__class__;exports=sdk_squill_Label(function sdk_squill_Label(){return this.init&&this.init.apply(this,arguments)},squill.Widget, function() {\n\tthis._css = 'label';\n\tthis._def = {\n\t\tchildren: [{\n\t\t\tid: '_labelSpan',\n\t\t\ttag: 'span'\n\t\t}]\n\t}\n\n\tthis.buildWidget = function() {\n\t\tthis.setLabel(this.getI18n('label'));\n\t}\n\t\n\tthis.setLabel =\n\tthis.setText = function(text) { $.setText(this._labelSpan, text); }\n\tthis.setHTML = function(html) { this._labelSpan.innerHTML = html; }\n});\n","pre":true},"sdk/squill/List.js":{"path":"sdk/squill/List.js","friendlyPath":".List","directory":"sdk/squill/","filename":"List.js","src":"\"use import\";\n\njsio(\"import .Widget\")\njsio(\"from util.browser import $\");\njsio(\"import .models.DataSource as DataSource\");\njsio(\"import .Selection\");\n\nvar sdk_squill_List=__class__;var List = exports=sdk_squill_List(function sdk_squill_List(){return this.init&&this.init.apply(this,arguments)},Widget, function(supr) {\n\tthis.init = function(opts) {\n\t\topts = merge(opts, {\n\t\t\tcontainSelf: true,\n\t\t\tmargin: 0,\n\t\t\tisTiled: false,\n\t\t\tpreserveCells: false,\n\t\t\trenderAll: true,\n\t\t\tisFixedHeight: true,\n\t\t\tabsolutePosition: true,\n\t\t\tfilter: null\n\t\t});\n\n\t\tthis.needsRender = delay(this.render);\n\t\t\n\t\tif (opts.cellCtor) { this.setCellCtor(opts.cellCtor); }\n\t\tif (opts.dataSource) { this.setDataSource(opts.dataSource); }\n\t\tif (opts.sorter) { this.setSorter(opts.sorter); }\n\n\t\tthis._lastFilter = -1;\n\t\tthis._filter = opts.filter;\n\t\tthis._cellsByID = {};\n\t\tthis._removed = {};\n\t\tthis._containSelf = opts.containSelf;\n\t\tthis._containerTag = opts.containerTag;\n\t\tthis._applyNodeOrder = opts.applyNodeOrder;\n\n\t\tthis._renderOpts = {\n\t\t\tmargin: opts.margin || 0\n\t\t};\n\n\t\tthis.updateFilter = delay(function() {\n\t\t\tthis._lastFilter = -1;\n\t\t\tthis.needsRender();\n\t\t}, 100);\n\n\t\tsupr(this, 'init', [opts]);\n\t};\n\n\t// cells go in _container\n\tthis.getContainer = function() {\n\t\treturn this._container;\n\t};\n\n\tthis.getDataSource = function() {\n\t\treturn this._dataSource;\n\t};\n\n\tthis.setDataSource = function(dataSource) {\n\t\tif (this._dataSource == dataSource) { return; }\n\n\t\tif (this._dataSource) {\n\t\t\tthis._dataSource.unsubscribe('Update', this);\n\t\t\tthis._dataSource.unsubscribe('Remove', this);\n\t\t\tthis.clear();\n\t\t}\n\n\t\tthis._dataSource = dataSource;\n\t\tthis._dataSource.subscribe('Update', this, 'onUpdateItem');\n\t\tthis._dataSource.subscribe('Remove', this, 'onRemoveItem');\n\n\t\tthis.needsRender();\n\t};\n\n\tthis.onUpdateItem = function(id, item) {\n\t\tvar cell = this._cellsByID[id];\n\t\tif (cell && cell.getData() != item) { cell.setData(item); }\n\t\tthis.updateFilter();\n\t};\n\n\tthis.onRemoveItem = function(id) {\n\t\tthis._removed[id] = true;\n\t\tthis.updateFilter();\n\t};\n\n\tthis.buildWidget = function() {\n\t\t\n\t\tthis._container = $({parent: this._el, className: this._opts.containerClassName, tag: this._containerTag || 'div'});\n\t\tif (this._containSelf && !this._applyNodeOrder) {\n\t\t\tthis._container.style.position = 'relative';\n\t\t}\n\n\t\tif (this._opts.selectable) {\n\t\t\tthis.setSelectable(this._opts.selectable);\n\t\t}\n\n\t\tthis.render();\n\t};\n\n\tthis.setSelectable = function(selectable) {\n\t\tthis.selection = new Selection({\n\t\t\tparent: this,\n\t\t\ttype: selectable\n\t\t})\n\t\t\t.subscribe('Select', this, '_onSelected', true)\n\t\t\t.subscribe('Deselect', this, '_onSelected', false)\n\n\t\tthis.selection;\n\t};\n\n\tthis._onSelected = function(isSelected, item, id) {\n\t\tif (this._cellsByID[id] !== undefined) {\n\t\t\tthis._cellsByID[id].updateSelected();\n\t\t}\n\t};\n\n\tthis.setCellCtor = function(cellCtor) {\n\t\tif (cellCtor == this._cellCtor) { return; }\n\n\t\tthis._cellCtor = cellCtor;\n\t\tthis.clear();\n\t}\n\t\n\tthis.clear = function() {\n\t\tfor (var id in this._cellsByID) {\n\t\t\tvar cell = this._cellsByID[id];\n\t\t\tcell.remove();\n\t\t}\n\n\t\tthis._cellsByID = {};\n\t\tthis._renderedDataSource = null;\n\t\tthis._cellDim = null;\n\t};\n\n\tthis.getCellById = function(id) {\n\t\treturn this._cellsByID[id];\n\t};\n\n\tthis.getCells = function() {\n\t\treturn this._cellsByID;\n\t};\n\n\tthis.setSorter = function(sorter) {\n\t\tthis._sorter = sorter;\n\t};\n\n\t// Filter moved to DataSource...\n\tthis.setFilter = function(filter) {\n\t\tthis._filter = filter;\n\t\tthis.needsRender();\n\t};\n\n\tthis.setFixedHeight = function(isFixedHeight) {\n\t\tthis._opts.isFixedHeight = isFixedHeight;\n\t};\n\n\t// Filter moved to DataSource...\n\tthis._applyFilter = function() {\n\t\tvar filter = this._filter;\n\t\tvar ds = this._renderedDataSource = new DataSource({key: this._dataSource.getKey()});\n\t\tvar src = this._dataSource;\n\t\tfor (var i = 0, n = src.length; i < n; ++i) {\n\t\t\tvar item = src.getItemForIndex(i);\n\t\t\tvar match = true;\n\t\t\tfor (var key in filter) {\n\t\t\t\tif (filter[key] instanceof RegExp) {\n\t\t\t\t\tif (!item[key].match(filter[key])) {\n\t\t\t\t\t\tmatch = false;\n\t\t\t\t\t}\n\t\t\t\t} else if (typeof item[key] == 'string'\n\t\t\t\t\t\t&& item[key].toLowerCase().indexOf(filter[key]) == -1) {\n\t\t\t\t\tmatch = false;\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tif (match) {\n\t\t\t\tds.add(item);\n\t\t\t} else {\n\t\t\t\tthis._removed[item[ds.key]] = true;\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.onShow = function() { supr(this, 'onShow', arguments); this.needsRender(); }\n\n\t// just render all cells for now\n\tthis.render = function() {\n\t\tif (!this._dataSource) { return; }\n\t\tthis._dataSource.sort();\n\n\t\tif (this._filter != this._lastFilter || !this._renderedDataSource) {\n\t\t\tthis._lastFilter = this._filter;\n\t\t\tthis._applyFilter();\n\t\t}\n\n\t\tif (this._opts.renderAll) {\n\t\t\tthis.renderAllDelayed();\n\t\t} else if (this._opts.isFixedHeight) {\n\t\t\tthis.renderFixedHeight();\n\t\t} else {\n\t\t\tthis.renderDynamicHeight();\n\t\t}\n\n\t\tthis._removed = {};\n\t};\n\n\tthis.setCellDim = function(cellDim) {\n\t\tthis._cellDim = cellDim;\n\t};\n\n\tthis.getCellDim = function() {\n\t\tif (this._cellDim) { return this._cellDim; }\n\t\t\n\t\tif (this._opts.isFixedHeight) {\n\t\t\tvar item = this._dataSource.getItemForIndex(0);\n\t\t\tif (!item) { return false; }\n\t\t\tvar key = item[this._dataSource.getKey()],\n\t\t\t\tcell = this._cellsByID[key] || (this._cellsByID[key] = this._createCell(item)),\n\t\t\t\tdim = $.size(cell.getElement());\n\t\t\tif (dim.width == 0 || dim.height == 0) { return null; }\n\t\t\t\n\t\t\tvar margin = this._opts.margin;\n\t\t\tif (margin) {\n\t\t\t\tdim.width += margin;\n\t\t\t\tdim.height += margin;\n\t\t\t}\n\t\t\t\n\t\t\tthis._cellDim = dim;\n\t\t\treturn dim;\n\t\t} else {\n\t\t\tthrow 'unimplemented'\n\t\t}\n\t};\n\n\tthis._createCell = function(item) {\n\t\tvar key = this._dataSource.getKey(),\n\t\t\tcell = new this._cellCtor({\n\t\t\t\tparent: this,\n\t\t\t\tcontroller: this,\n\t\t\t\tkey: key,\n\t\t\t\tdata: item\n\t\t\t});\n\t\t\n\t\tcell.getElement().setAttribute('squill-data-id', item[key]);\n\t\tcell.render();\n\t\treturn cell;\n\t};\n\n\tthis._nodeOrder = function() {\n\t\tvar container = this._container;\n\t\tvar src = this._renderedDataSource;\n\t\tvar key = src.key;\n\t\tvar dummy;\n\t\tvar cell;\n\t\tvar element;\n\t\tvar item;\n\t\tvar i;\n\n\t\tif (!container.childNodes.length) {\n\t\t\treturn;\n\t\t}\n\n\t\tdummy = document.createElement('div');\n\n\t\tcontainer.insertBefore(dummy, container.childNodes[0]);\n\t\tfor (i = 0; i < src.length; i++) {\n\t\t\titem = src.getItemForIndex(i);\n\t\t\tcell = this._cellsByID[item[key]];\n\t\t\telement = cell.getElement();\n\t\t\tif (cell && element.parentNode) {\n\t\t\t\tcontainer.insertBefore(container.removeChild(element), dummy);\n\t\t\t}\n\t\t}\n\n\t\tcontainer.removeChild(dummy);\n\t};\n\n\tthis.renderAllDelayed = function() {\n\t\tvar src = this._renderedDataSource;\n\t\tif (!src) { return; }\n\n\t\tthis.updateRenderOpts();\n\t\tvar i = 0;\n\t\tfunction renderOne() {\n\t\t\tvar item = src.getItemForIndex(i);\n\t\t\tif (!item) { return false; }\n\t\t\t\n\t\t\tvar id = item[src.getKey()];\n\t\t\tvar cell = this._cellsByID[id];\n\t\t\tif (!cell) {\n\t\t\t\tcell = this._cellsByID[id] = this._createCell(item);\n\t\t\t} else {\n\t\t\t\tcell.render();\n\t\t\t}\n\t\t\t!this._applyNodeOrder && this.positionCell(cell, i);\n\t\t\t++i;\n\t\t\treturn true;\n\t\t}\n\n\t\tfunction renderMany() {\n\t\t\tvar THRESHOLD = 50; // ms to render\n\t\t\tvar n = 0, t = +new Date();\n\t\t\twhile (n++ < 10 || +new Date() - t < THRESHOLD) {\n\t\t\t\tif (!renderOne.call(this)) {\n\t\t\t\t\tthis._applyNodeOrder && this._nodeOrder();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tsetTimeout(bind(this, renderMany), 100);\n\t\t}\n\n\t\tvar removed = this._removed;\n\t\tfor (var id in removed) {\n\t\t\tif (!src.getItemForID(id)) {\n\t\t\t\tvar cell = this._cellsByID[id];\n\t\t\t\tif (cell) {\n\t\t\t\t\tcell.remove();\n\t\t\t\t\tdelete this._cellsByID[id];\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\trenderMany.call(this);\n\t}\n\n\tthis.setOffsetParent = function(offsetParent) {\n\t\tthis._opts.offsetParent = offsetParent;\n\t};\n\n\tthis.setTiled = function(tiled) {\n\t\tthis._opts.isTiled = tiled;\n\t\tthis._isTiled = tiled;\n\t};\n\n\tthis.updateRenderOpts = function() {\n\t\tvar r = this._renderOpts;\n\n\t\tr.offsetTop = this._containSelf ? 0 : this._container.offsetTop;\n\t\tr.offsetLeft = this._containSelf ? 0 : this._container.offsetLeft;\n\n\t\tvar parent = this._offsetParent || this.getOffsetParent();\n\t\tr.top = (parent.getAttribute('squill-scroller-top') || parent.scrollTop) - r.offsetTop;\n\t\tr.height = parent.offsetHeight;\n\t\tr.bottom = r.top + r.height;\n\n\t\tif (this._opts.isFixedHeight) {\n\t\t\tvar cellDim = this.getCellDim();\n\t\t\tif (!cellDim) { return false; }\n\t\t\tr.cellWidth = cellDim.width;\n\t\t\tr.cellHeight = cellDim.height;\n\t\t}\n\n\t\tvar n = r.numRows = this._renderedDataSource.length;\n\t\tif (this._opts.isFixedHeight) {\n\t\t\tif (this._opts.isTiled) {\n\t\t\t\tr.maxWidth = parent.offsetWidth - r.offsetLeft;\n\t\t\t\tr.numPerRow = Math.max(1, r.maxWidth / r.cellWidth | 0);\n\t\t\t\tr.numRows = Math.ceil(n / r.numPerRow);\n\t\t\t\tr.start = Math.max(0, (r.top / r.cellHeight | 0) * r.numPerRow);\n\t\t\t\tr.end = Math.ceil(r.bottom / r.cellHeight) * r.numPerRow;\n\t\t\t} else {\n\t\t\t\tr.start = Math.max(0, r.top / r.cellHeight | 0);\n\t\t\t\tr.end = (r.bottom / r.cellHeight + 1) | 0;\n\t\t\t}\n\t\t}\n\n\t\tif (!this._applyNodeOrder) {\n\t\t\tif (this._opts.absolutePosition) {\n\t\t\t\tthis._container.style.height = r.numRows * r.cellHeight + 'px';\n\t\t\t} else {\n\t\t\t\tthis._container.style.height = 'auto';\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t};\n\n\tthis.positionCell = function(cell, i) {\n\t\tif (!this._opts.absolutePosition) { return; }\n\n\t\tvar r = this._renderOpts;\n\t\tvar el = cell.getElement();\n\t\tvar x, y;\n\n\t\tif (this._opts.isTiled) {\n\t\t\tx = i % r.numPerRow;\n\t\t\ty = (i / r.numPerRow) | 0;\n\t\t\tel.style.left = x * r.cellWidth + r.offsetLeft + 'px';\n\t\t\tel.style.top = y * r.cellHeight + r.offsetTop + 'px';\n\t\t} else {\n\t\t\tel.style.top = (i * r.cellHeight || 0) + r.offsetTop + 'px';\n\t\t}\n\t};\n\n\tthis.getOffsetParent = function() {\n\t\t// the list might be contained in some other scrolling div\n\t\treturn this._opts.offsetParent || (this._containSelf ? this._container : this._container.offsetParent) || document.body;\n\t};\n\n\tthis.renderFixedHeight = function() {\n\t\tvar parent = this.getOffsetParent();\n\t\tif (!parent) { return; }\n\t\tif (parent != this._offsetParent) {\n\t\t\tif (this._removeScrollEvt) { this._removeScrollEvt(); }\n\t\t\tthis._offsetParent = parent;\n\t\t\tthis._removeScrollEvt = $.onEvent(parent, 'scroll', this, 'needsRender');\n\t\t}\n\n\t\t// render data\n\t\tvar src = this._renderedDataSource,\n\t\t\tkey = src.getKey(),\n\t\t\tn = src.length;\n\t\t\n\t\tif (n && !this.updateRenderOpts()) { return; }\n\n\t\t// swap lists\n\t\tvar oldCellsByID = this._cellsByID;\n\t\tthis._cellsByID = {};\n\n\t\t// render new items\n\t\tif (n) {\n\t\t\tvar isTiled = this._isTiled;\n\t\t\tvar r = this._renderOpts;\n\t\t\tfor (var i = r.start; i < r.end; ++i) {\n\t\t\t\tvar item = src.getItemForIndex(i);\n\t\t\t\tif (!item) { break; }\n\n\t\t\t\tvar id = item[key];\n\t\t\t\tvar cell = oldCellsByID[id];\n\t\t\t\tif (!cell) {\n\t\t\t\t\tcell = this._createCell(item);\n\t\t\t\t} else {\n\t\t\t\t\tdelete(oldCellsByID[id]);\n\t\t\t\t\tcell.render();\n\t\t\t\t}\n\n\t\t\t\tthis.positionCell(cell, i);\n\t\t\t\tthis._cellsByID[id] = cell;\n\t\t\t}\n\t\t};\n\n\t\t// remove old items\n\t\tif (!this._opts.preserveCells) {\n\t\t\tfor (var id in oldCellsByID) {\n\t\t\t\toldCellsByID[id].remove();\n\t\t\t}\n\t\t} else {\n\t\t\tfor (var id in oldCellsByID) {\n\t\t\t\tvar cell = oldCellsByID[id];\n\t\t\t\tif (!src.getItemForID(id)) {\n\t\t\t\t\tcell.remove();\n\t\t\t\t} else {\n\t\t\t\t\tthis._cellsByID[id] = cell;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n});\n","pre":true},"sdk/squill/Selection.js":{"path":"sdk/squill/Selection.js","friendlyPath":".Selection","directory":"sdk/squill/","filename":"Selection.js","src":"\"use import\";\n\njsio(\"import lib.PubSub\");\n\n/**\n * The Selection class connects a selection storage to a UI element.\n *\n * A selection storage is very simple class that maintains the data layer of \n * a selection. It is entirely based on item ID, exposing the methods:\n *   isSelected(id) -> bool\n *   select(id)\n *   deselect(id)\n * You may, for example, want to implement a selection store that persists\n * the current selection over a network. The base implementation of a selection\n * storage is exports.LocalStore, which simply wraps an in-memory object.\n * \n * The Selection class handles logic such as how many items can be selected\n * at once, and provides the API that UI widgets can interact with.  For example,\n * the squill.List class contains a public proprty .selection that is an\n * instance of a Selection instance.\n */\nvar sdk_squill_Selection=__class__;exports=sdk_squill_Selection(function sdk_squill_Selection(){return this.init&&this.init.apply(this,arguments)},lib.PubSub, function() {\n\n\tthis.init = function(opts) {\n\t\tthis._parent = opts.parent;\n\t\tthis._type = opts.type || false;\n\t\tthis._selection = opts.selectionStore || new exports.LocalStore();\n\t\tthis._maxSelections = opts.maxSelections || 1;\n\t\tthis._currentSelectionCount = 0;\n\t\tthis._lastSelected = null;\n\t};\n\n\tthis.getType = function() { return this._type; };\n\n\tthis.isSelected = function(id) {\n\t\tif (typeof id == 'object') {\n\t\t\tid = id[this._parent.getDataSource().key];\n\t\t}\n\t\treturn this._selection.isSelected(id);\n\t};\n\n\tthis.toggle = function(item) {\n\t\tthis._setSelected(item, !this.isSelected(item[this._parent.getDataSource().key]));\n\t};\n\n\tthis.select = function(item) {\n\t\tif((this._currentSelectionCount < this._maxSelections) || this._type == 'single') {\n\t\t\tthis._setSelected(item, true);\n\t\t}\n\t};\n\n\tthis.deselect = function(item) {\n\t\tthis._setSelected(item, false);\n\t};\n\n\tthis.deselectAll = function() {\n\t\tthis._selection.deselectAll();\n\t\tthis._currentSelectionCount = 0;\n\t};\n\n\tthis.get = function() { return this._selection.get(); };\n\n\tthis.getSelectionCount = function() {\n\t\treturn this._currentSelectionCount;\n\t};\n\t\n\tthis._setSelected = function(item, isSelected) {\n\t\tif (!item) { return; }\n\t\t\n\t\tvar dataSource = this._parent.getDataSource(),\n\t\t\tkey = dataSource.key;\n\t\tif (typeof item == 'string') {\n\t\t\titem = dataSource.get(item);\n\t\t}\n\t\tvar id = item[key];\n\n\t\tif (this._selection.isSelected(id) != isSelected) {\n\t\t\tif (isSelected) {\n\t\t\t\tif (this._lastSelected && this._type == 'single') {\n\t\t\t\t\tvar lastID = this._lastSelected[key];\n\t\t\t\t\tthis._selection.deselect(lastID);\n\t\t\t\t\tthis._currentSelectionCount--;\n\t\t\t\t\tthis.publish('Deselect', this._lastSelected, lastID);\n\t\t\t\t}\n\n\t\t\t\tthis._lastSelected = item;\n\t\t\t\tthis._selection.select(id);\n\t\t\t\tthis._currentSelectionCount++;\n\t\t\t} else {\n\t\t\t\tthis._selection.deselect(id);\n\t\t\t\tthis._currentSelectionCount--;\n\t\t\t}\n\n\t\t\tthis.publish(isSelected ? 'Select' : 'Deselect', item, id);\n\t\t}\n\t};\n});\n\nexports.LocalStore=__class__;exports.LocalStore=exports.LocalStore(function exports_LocalStore(){return this.init&&this.init.apply(this,arguments)},function() {\n\tthis.init = function() {\n\t\tthis._store = {};\n\t}\n\t\n\tthis.get = function() {\n\t\treturn merge({}, this._store);\n\t}\n\n\tthis.select = function(id) {\n\t\tthis._store[id] = true;\n\t}\n\t\n\tthis.deselect = function(id) {\n\t\tdelete this._store[id];\n\t}\n\t\n\tthis.deselectAll = function(id) {\n\t\tthis._store = {};\n\t}\n\t\n\tthis.isSelected = function(id) {\n\t\tif (id !== undefined) {\n\t\t\treturn !!this._store[id];\n\t\t} else {\n\t\t\tfor (var key in this._store) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\treturn false;\n\t\t}\n\t}\n});\n\n","pre":true},"sdk/squill/TextInput.js":{"path":"sdk/squill/TextInput.js","friendlyPath":".TextInput","directory":"sdk/squill/","filename":"TextInput.js","src":"jsio('from util.browser import $');\njsio('import .Widget, .global');\n\nvar sdk_squill_TextInput=__class__;var TextInput = exports=sdk_squill_TextInput(function sdk_squill_TextInput(){return this.init&&this.init.apply(this,arguments)},Widget, function(supr) {\n\tthis._type = 'text';\n\tthis._css = 'textInput';\n\tthis._class = (global.getWidgetPrefix() === null) ? '' : (global.getWidgetPrefix() + this._css);\n\t\n\tthis.init = function(opts) {\n\t\topts = merge(opts, {\n\t\t\tname: '',\n\t\t\tvalue: '',\n\t\t\ttype: 'text',\n\t\t\tmultiline: false\n\t\t});\n\t\t\n\t\tthis._def = {\n\t\t\tchildren: [\n\t\t\t\t{tag: opts.multiline ? 'textarea' : 'input', id: '_input', attrs: {\n\t\t\t\t\ttype: opts.type,\n\t\t\t\t\tvalue: opts.value,\n\t\t\t\t\tname: opts.name\n\t\t\t\t}, style: merge(opts.textStyle, {\n\t\t\t\t\tdisplay: 'block',\n\t\t\t\t\t// width: '100%',\n\t\t\t\t\t// height: '100%',\n\t\t\t\t\tMozBoxSizing: 'border-box',\n\t\t\t\t\tWebkitBoxSizing: 'border-box',\n\t\t\t\t\tMsBoxSizing: 'border-box',\n\t\t\t\t\tboxSizing: 'border-box'\n\t\t\t\t})}\n\t\t\t],\n\t\t\tstyle: {position: 'relative'}\n\t\t};\n\t\t\n\t\tif (opts.prefixLabel) {\n\t\t\tthis._def.children.unshift({id: '_label', text: opts.label});\n\t\t}\n\t\t\n\t\tsupr(this, 'init', [opts]);\n\t}\n\t\n\tthis.buildWidget = function() {\n\t\tvar el = this._el;\n\t\tvar type = this._opts.type;\n\t\tif ('ontouchstart' in this._el) {\n\t\t\tthis._overlay = $({\n\t\t\t\tparent: this._el,\n\t\t\t\tattrs: {\n\t\t\t\t\tnoCapture: true\n\t\t\t\t},\n\t\t\t\tstyle: {\n\t\t\t\t\tposition: 'absolute',\n\t\t\t\t\ttop: '0px',\n\t\t\t\t\tleft: '0px',\n\t\t\t\t\twidth: '100%',\n\t\t\t\t\theight: '100%',\n\t\t\t\t\tzIndex: 1\n\t\t\t\t}\n\t\t\t});\n\t\t\t\n\t\t\tthis._overlay.addEventListener('click', bind(this, function() {\n\t\t\t\t$.hide(this._overlay);\n\t\t\t\tthis._input.focus();\n\t\t\t}), true);\n\t\t}\n\t\t\n\t\tif (!this._opts.prefixLabel || this._opts.placeholder) {\n\t\t\tvar label = this.getI18n('label');\n\t\t\tif (this._input.getAttribute('placeholder') === null) {\n\t\t\t\tthis._input.setAttribute('placeholder', this._opts.placeholder || label);\n\t\t\t} else {\n\t\t\t\tthis._placeholder = $.create({\n\t\t\t\t\ttag: 'button',\n\t\t\t\t\ttext: label,\n\t\t\t\t\tclassName: global.getWidgetPrefix() + 'textInputLabel',\n\t\t\t\t\tstyle: {position: 'absolute'},\n\t\t\t\t\tparent: el\n\t\t\t\t});\t\n\t\t\t}\n\t\t}\n\t\t\n\t\tthis.initMouseEvents(el);\n\t\tthis.initFocusEvents(this._input);\n\t\tthis.initKeyEvents(this._input);\n\t}\n\n\tthis.getInputElement = function () { return this._input; }\n\t\n\tthis.setName = function(name) {\n\t\tsupr(this, 'setName', arguments);\n\t\t\n\t\tif (this._input) { this._input.name = name; }\n\t}\n\t\n\tthis.setValue = function(value) { this._value = this._input.value = value; }\n\tthis.getValue = function() { return this._input.value; }\n\t\n\tthis.onKeyDown = function() {\n\t\tsupr(this, 'onKeyDown', arguments);\n\t\tif (this._placeholder) { $.hide(this._placeholder); }\n\t}\n\t\n\tthis.onKeyUp = function() {\n\t\tsupr(this, 'onKeyUp', arguments);\n\t\tthis.checkLabel();\n\t\tthis.checkValue();\n\t}\n\n\tthis.onMouseDown = function(evt) {\n\t\tsupr(this, 'onMouseDown', arguments);\n\n\t\tevt.stopPropagation();\n//\t\t$.stopEvent(evt);\n\t}\n\t\n\tthis.onKeyPress = function(e) {\n\t\tsupr(this, 'onKeyPress', arguments);\n\t\tif (e.keyCode == 13) {\n\t\t\tthis.publish('EnterPressed');\n\t\t}\n\t\tthis.checkValue();\n\t}\n\t\n\tthis.onBlur = function() {\n\t\tsupr(this, 'onBlur');\n\t\tthis.checkLabel();\n\t\t\n\t\tif (this._overlay) {\n\t\t\t$.show(this._overlay);\n\t\t}\n\t}\n\t\n\tthis.checkValue = function() {\n\t\tif (this._value != this._input.value) {\n\t\t\tthis._value = this._input.value;\n\t\t\tthis.publish('change', this._value);\n\t\t\tthis.publish('ValueChange', this._value);\n\t\t}\n\t}\n\t\n\tthis.checkLabel = function() {\n\t\tif(this._placeholder && /^\\s*$/.test(this._input.value)) {\n\t\t\t$.show(this._placeholder);\n\t\t}\n\t}\n\t\n\tthis.onClick = function() {\n\t\tsupr(this, 'onClick');\n\t\t\n\t\t//setTimeout(bind(this._input, 'focus'), 100);\n\t}\n});\n\nWidget.register(TextInput, 'TextInput');\n","pre":true},"sdk/squill/TextArea.js":{"path":"sdk/squill/TextArea.js","friendlyPath":".TextArea","directory":"sdk/squill/","filename":"TextArea.js","src":"\"use import\";\n\njsio(\"from util.browser import $\");\njsio(\"import .Widget\");\njsio(\"import .TextInput\");\n\nvar sdk_squill_TextArea=__class__;var TextArea = exports=sdk_squill_TextArea(function sdk_squill_TextArea(){return this.init&&this.init.apply(this,arguments)},TextInput, function(supr) {\n\tthis._tag = 'textarea';\n});\n\nWidget.register(TextArea, 'TextArea');","pre":true},"sdk/squill/Scroller.js":{"path":"sdk/squill/Scroller.js","friendlyPath":".Scroller","directory":"sdk/squill/","filename":"Scroller.js","src":"\"use import\";\n\njsio(\"import .Drag\");\njsio(\"import .Widget\");\njsio(\"import .transforms\");\njsio(\"from util.browser import $\");\n\nvar sdk_squill_Scroller=__class__;exports=sdk_squill_Scroller(function sdk_squill_Scroller(){return this.init&&this.init.apply(this,arguments)},Widget, function(supr) {\n\tthis._css = 'scroller';\n\t\n\tthis.init = function(opts) {\n\t\topts = merge(opts, {\n\t\t\tmomentum: true\n\t\t});\n\t\t\n\t\tthis._scrollTop = 0;\n\t\tthis._lastDelta = {\n\t\t\tdiff: 0,\n\t\t\twhen: 0,\n\t\t\tduration: 0\n\t\t};\n\t\t\n\t\tthis._hasMomentum = opts.momentum;\n\t\t\n\t\tsupr(this, 'init', [opts]);\n\t}\n\t\n\tthis.buildContent = function() {\n\t\tvar el = this._el;\n\t\t\n\t\t$.style(el, {height: '100%'});\n\t\t\n\t\tthis._scrollPane = $({\n\t\t\tparent: el,\n\t\t\tclassName: 'squill-scrollPane',\n\t\t\tminHeight: '100%'\n\t\t});\n\t\t\n\t\tif ('ontouchstart' in el) {\n\t\t\tel.addEventListener('touchstart', bind(this, 'onTouchStart'), true);\n\t\t\tel.addEventListener('mousedown', this, 'start')\n\t\t\tthis.initDragEvents();\n\t\t\tthis._el.style.overflow = 'hidden';\n\t\t\ttransforms.setTop(this._scrollPane, 0);\n\t\t} else {\n\t\t\tthis._el.style.overflow = 'auto';\n\t\t}\n\t\t\n\t\tif (this._def) {\n\t\t\tvar def = this._def;\n\t\t\tthis._def = null; // don't handle it in the supr call\n\t\t\t\n\t\t\t// build children into the scroll pane\n\t\t\tthis.buildChildren(merge({el: this._scrollPane}, def));\t\n\t\t}\n\t\t\n\t\treturn supr(this, 'buildContent', arguments);\n\t}\n\t\n\tthis.getScrollTop = function() { return this._scrollTop; }\n\tthis.getContainer = \n\tthis.getScrollPane = function() { return this._scrollPane; }\n\t\n\tthis.onTouchStart = function() {\n\t\tif (this._momentum) { clearInterval(this._momentum); }\n\t}\n\n\tthis.onDragStart = function(dragEvt, mouseEvt) {\n\t\tthis._height = this._scrollPane.offsetHeight - this._el.offsetHeight;\n\t\tthis._lastDelta.when = +new Date();\n\t\tif (this._momentum) { clearInterval(this._momentum); }\n\t}\n\n\tthis.onDrag = function(dragEvt, moveEvt, delta) {\n\t\tvar now = +new Date(),\n\t\t\td = this._lastDelta;\n\t\t\n\t\td.diff = delta.y;\n\t\td.duration = d.when && (now - d.when) || 0;\n\t\td.when = now;\n\t\t\n\t\tthis.scrollTo(this._scrollTop + delta.y);\n\t}\n\n\tthis.scrollTo = function(y, animate) {\n\t\tthis._scrollTop = y;\n\t\tif (this._scrollTop < -this._height) { this._scrollTop = -this._height; }\n\t\tif (this._scrollTop > 0) { this._scrollTop = 0; }\n\t\t\n\t\tthis._el.setAttribute('squill-scroller-top', -this._scrollTop);\n\t\t\n\t\tvar onFinish = bind(this, function() {\n\t\t\tif (document.createEvent) {\n\t\t\t\tvar e = document.createEvent('HTMLEvents');\n\t\t\t\te.initEvent('scroll', true, false);\n\t\t\t\tthis._el.dispatchEvent(e);\n\t\t\t}\n\t\t});\n\t\t\n\t\tif (animate) {\n\t\t\ttransforms.move(this._scrollPane, 0, this._scrollTop, '0.5s ease-in-out', onFinish);\n\t\t} else {\n\t\t\ttransforms.move(this._scrollPane, 0, this._scrollTop);\n\t\t\tonFinish();\n\t\t}\n\t}\n\t\n\tthis.onDragStop = function(dragEvt, selectEvt) {\n\t\t$.stopEvent(selectEvt);\n\t\tif (this._hasMomentum && this._lastDelta.duration != 0) {\n\t\t\tvar d = this._lastDelta,\n\t\t\t\tspeed = d.diff / d.duration,\n\t\t\t\tstart = d.when,\n\t\t\t\ttime = d.when,\n\t\t\t\tdir = speed > 0 ? 1 : -1,\n\t\t\t\tdur = 2;\n\t\t\n\t\t\tthis._momentum = setInterval(bind(this, function() {\n\t\t\t\tvar now = +new Date(),\n\t\t\t\t\tdt = now - time,\n\t\t\t\t\tdistance = speed * dt;\n\t\t\t\n\t\t\t\tthis.scrollTo(this._scrollTop + distance);\n\t\t\t\n\t\t\t\t// TODO: this isn't based on dt which is bad!!!\n\t\t\t\tspeed *= 0.95;\n\t\t\t\tif (Math.abs(speed) < 0.01) {\n\t\t\t\t\tclearTimeout(this._momentum);\n\t\t\t\t\tthis._momentum = null;\n\t\t\t\t}\n\t\t\t\ttime = now;\n\t\t\t}), 10);\n\t\t}\n\t}\n});\n","pre":true},"sdk/squill/transforms.js":{"path":"sdk/squill/transforms.js","friendlyPath":".transforms","directory":"sdk/squill/","filename":"transforms.js","src":"\"use import\";\n\njsio(\"from util.browser import $\");\n\nvar vendor = (/webkit/i).test(navigator.appVersion) ? 'webkit' :\n\t(/firefox/i).test(navigator.userAgent) ? 'Moz' :\n\t'opera' in window ? 'O' : '',\n\thas3d = 'WebKitCSSMatrix' in window && 'm11' in new WebKitCSSMatrix(),\n\thasTransform = vendor + 'Transform' in document.documentElement.style,\n\ttranslateStart = 'translate' + (has3d ? '3d(' : '('),\n\ttranslateEnd = has3d ? ',0)' : ')';\n\nif (hasTransform) {\n\texports.setLeft = function(el, left) {\n\t\tel.style[vendor + 'Transform'] = translateStart + left + 'px,0' + translateEnd;\n\t}\n\t\n\texports.setTop = function(el, top) {\n\t\tel.style[vendor + 'Transform'] = translateStart + '0,' + top + 'px' + translateEnd;\n\t}\n} else {\n\texports.setLeft = function(el, left) {\n\t\tel.style.left = left + 'px';\n\t}\n\t\n\texports.setTop = function(el, top) {\n\t\tel.style.top = top + 'px';\n\t}\n}\n\nexports.onTransitionEnd = function(el, cb) {\n\tvar executed = false;\n\tvar finished = function() {\n\t\tif (executed) { return; }\n\t\texecuted = true;\n\t\tfor (var i = 0, remove; remove = evts[i]; ++i) {\n\t\t\tremove();\n\t\t}\n\t\tcb();\n\t}\n\t\n\tvar evts = [\n\t\t$.onEvent(el, 'webkitTransitionEnd', finished),\n\t\t$.onEvent(el, 'transitionend', finished),\n\t\t$.onEvent(el, 'oTransitionEnd', finished)\n\t];\n}\n\nexports.setTransition = function(el, transition, cb) {\n\tif (transition) {\n\t\tvar oldTransition = el.style[vendor + 'Transition'];\n\t\texports.onTransitionEnd(el, function() {\n\t\t\tel.style[vendor + 'Transition'] = oldTransition;\n\t\t\tcb && cb();\n\t\t});\n\t\tel.style[vendor + 'Transition'] = '-' + vendor + '-transform ' + transition;\n\t} else {\n\t\tel.style[vendor + 'Transition'] = 'none';\n\t}\n}\n\nexports.rotate = function(el, rotation, transition, cb) {\n\tif (!hasTransform) { cb && cb(); return; }\n\texports.setTransition(el, transition, cb);\n\t\n\tel.style[vendor + 'Transform'] = 'rotate(' + rotation + ')';\n\t\n\tif (cb && !transition) { cb(); }\n}\n\nexports.move = function(el, x, y, transition, cb) {\n\tif (!hasTransform) { cb && cb(); return; }\n\texports.setTransition(el, transition, cb);\n\tel.style[vendor + 'Transform'] = translateStart + x + 'px,' + y + 'px' + translateEnd;\n\tif (cb && !transition) { cb(); }\n}\n\nexports.hasTransform = hasTransform;\n","pre":true},"sdk/squill/Canvas.js":{"path":"sdk/squill/Canvas.js","friendlyPath":".Canvas","directory":"sdk/squill/","filename":"Canvas.js","src":"\"use import\";\n\njsio(\"from util.browser import $\");\njsio(\"import .Widget\");\n\nvar sdk_squill_Canvas=__class__;var Canvas = exports=sdk_squill_Canvas(function sdk_squill_Canvas(){return this.init&&this.init.apply(this,arguments)},Widget, function(supr) {\n\tthis._css = 'cnvs';\n\tthis._type = 'canvas';\n\t\n\tthis.init = function(params) {\n\t\tparams = merge(params, {tag: 'canvas'});\n\t\tthis._isEnabled = params.isEnabled;\n\t\tsupr(this, 'init', [params]);\n\t}\n\t\n\tthis.create = function() {\n\t\tsupr(this, 'create', arguments);\n\t};\n\t\n\tthis.buildWidget = function() {\n\t\tvar el = this._el;\n\n\t\tel.width = this._opts.width;\n\t\tel.height = this._opts.height;\n\t\tif (this._opts.color) {\n\t\t\tel.style.backgroundColor = this._opts.color;\n\t\t}\n\n\t\tthis.initMouseEvents(el);\n\t\tthis.initKeyEvents(el);\n\t};\n});\n\n","pre":true},"sdk/squill/Slider.js":{"path":"sdk/squill/Slider.js","friendlyPath":".Slider","directory":"sdk/squill/","filename":"Slider.js","src":"\"use import\";\n\njsio(\"from util.browser import $\");\njsio(\"import .Widget\");\n\nvar sdk_squill_Slider=__class__;var Slider = exports=sdk_squill_Slider(function sdk_squill_Slider(){return this.init&&this.init.apply(this,arguments)},Widget, function(supr) {\n\tthis._css = 'rng';\n\tthis._type = 'range';\n\n\tthis.init = function(params) {\n\t\tthis._width = params.width || 100;\n\t\tthis._padding = 12;\n\t\tthis._hover = false;\n\t\tthis._fillColor = params.fillColor || '#000000';\n\t\tthis._lineColor = params.lineColor || '#FFFFFF';\n\n\t\tthis._def = {\n\t\t\tchildren: [\n\t\t\t\t{\n\t\t\t\t\tid: params.id + 'Canvas',\n\t\t\t\t\ttag: 'canvas',\n\t\t\t\t\tattrs: {width: this._width, height: this._padding * 2}\n\t\t\t\t}\n\t\t\t]\n\t\t};\n\n\t\tsupr(this, 'init', [params]);\n\t};\n\n\tthis._render = function() {\n\t\tvar width = this._width,\n\t\t\tpadding = this._padding,\n\t\t\tctx = this._ctx,\n\t\t\tradialGradient,\n\t\t\tv;\n\n\t\tctx.clearRect(0, 0, width, padding * 2);\n\n\t\tctx.lineCap = 'round';\n\n\t\tctx.beginPath();\n\t\tctx.arc(padding + 2, padding, 2, Math.PI * 0.5, Math.PI * 1.5, false);\n\t\tctx.arc(width - padding - 2, padding, 2, Math.PI * 1.5, Math.PI * 0.5, false);\n\t\tctx.closePath();\n\n\t\tctx.lineWidth = 1;\n\t\tctx.strokeStyle = this._lineColor;\n\t\tctx.stroke();\n\t\tctx.fillStyle = this._fillColor;\n\t\tctx.fill();\n\n\t\tctx.save();\n\n\t\tif (this._hover) {\n\t\t\tctx.shadowOffsetX = 0;\n\t\t\tctx.shadowOffsetY = 0;\n\t\t\tctx.shadowBlur = 10;\n\t\t\tctx.shadowColor = '#0099FF';\n\t\t}\n\n\t\tv = ~~((width - padding * 2) * (this.value - this.min) / (this.max - this.min));\n\n\t\tctx.beginPath();\n\t\tctx.arc(padding + v, padding, 5, 0, Math.PI * 2, false);\n\t\tctx.closePath();\n\n\t\tradialGradient = ctx.createRadialGradient(padding - 1 + v, padding - 1, 0, padding + v, padding, 4);\n\n\t\tradialGradient.addColorStop(0, '#FFFFFF');\n\t\tradialGradient.addColorStop(1, '#707070');\n\t\tctx.fillStyle = radialGradient;\n\t\tctx.fill();\n\n\t\tctx.restore();\n\t};\n\n\tthis.buildWidget = function() {\n\t\tvar el = this._el;\n\t\t\tcanvas = el.firstChild;\n\n\t\tel.slider = this;\n\n\t\t$.onEvent(canvas, 'mouseout', this, '_onMouseOut');\n\t\t$.onEvent(canvas, 'mousedown', this, '_onMouseDown');\n\t\t$.onEvent(canvas, 'mouseup', this, '_onMouseUp');\n\t\t$.onEvent(canvas, 'mousemove', this, '_onMouseMove');\n\n\t\tthis.min = this._opts.min || 0;\n\t\tthis.max = this._opts.max || 100;\n\t\tthis.step = this._opts.step || 1;\n\t\tthis.value = this._opts.value || 0;\n\n\t\tthis._mouseDown = false;\n\t\tthis._checkRange();\n\t\tthis._ctx = canvas.getContext('2d');\n\t\tthis._render();\n\t};\n\n\tthis.setValue = function(value) {\n\t\tthis.value = value;\n\t\tthis._render();\n\t};\n\n\tthis._onChange = function() {\n\t\tthis.publish('Change', this.value);\n\t};\n\n\tthis._checkRange = function() {\n\t\tif (this.value < this.min) {\n\t\t\tthis.value = this.min;\n\t\t}\n\t\tif (this.value > this.max) {\n\t\t\tthis.value = this.max;\n\t\t}\n\t};\n\n\tthis._checkMouse = function(evt) {\n\t\tvar mouseX = evt.offsetX,\n\t\t\tmouseY = evt.offsetY,\n\t\t\twidth = this._width,\n\t\t\tpadding = this._padding,\n\t\t\thover = this._hover,\n\t\t\tvalue;\n\n\t\tif (this._mouseDown) {\n\t\t\tif ((mouseX > padding) && (mouseY > padding - 5) && (mouseX < width - padding) && (mouseY < padding + 5)) {\n\t\t\t\tvalue = (evt.offsetX - padding) / (width - padding * 2) * (this.max - this.min);\n\t\t\t\tvalue = this.min + Math.round(value / this.step) * this.step;\n\t\t\t\tthis.value = value;\n\t\t\t\tthis._checkRange();\n\t\t\t\tthis._render();\n\t\t\t\tthis._onChange();\n\t\t\t}\n\t\t} else {\n\t\t\tif ((mouseY > padding - 5) && (mouseY < padding + 5)) {\n\t\t\t\tv = padding + ~~((width - padding * 2) * (this.value - this.min) / (this.max - this.min));\n\t\t\t\tthis._hover = (mouseX > v - 5) && (mouseY < v + 5);\n\t\t\t} else {\n\t\t\t\tthis._hover = false;\n\t\t\t}\n\n\t\t\tif (this._hover !== hover) {\n\t\t\t\tthis._render();\n\t\t\t}\n\t\t}\n\t};\n\n\tthis._onMouseOut = function(evt) {\n\t\tthis._mouseDown = false;\n\t\tthis._hover = false;\n\t\tthis._render();\n\t};\n\n\tthis._onMouseDown = function(evt) {\n\t\tthis._mouseDown = true;\n\t\tthis._checkMouse(evt);\n\t};\n\t\n\tthis._onMouseUp = function(evt) {\n\t\tthis._mouseDown = false;\n\t};\n\t\n\tthis._onMouseMove = function(evt) {\n\t\tthis._checkMouse(evt);\n\t};\n});\n\n","pre":true},"sdk/squill/Color.js":{"path":"sdk/squill/Color.js","friendlyPath":".Color","directory":"sdk/squill/","filename":"Color.js","src":"\"use import\";\n\njsio(\"from util.browser import $\");\njsio(\"import .Widget\");\n\njsio(\"import .jscolor.jscolor as jscolor\");\n\nvar sdk_squill_Color=__class__;var Color = exports=sdk_squill_Color(function sdk_squill_Color(){return this.init&&this.init.apply(this,arguments)},Widget, function(supr) {\n\tthis._css = 'clr';\n\tthis._type = 'text';\n\n\tthis.init = function(params) {\n\t\tparams = merge(params, {tag: 'input'});\n\t\tthis._isEnabled = params.isEnabled;\n\n\t\tsupr(this, 'init', [params]);\n\n\t};\n\n\tthis.buildWidget = function() {\n\t\tvar el = this._el;\n\n\t\t$.addClass(el, 'squill-color');\n\t\tel.min = this._opts.min || 0;\n\t\tel.max = this._opts.max || 100;\n\t\tel.step = this._opts.step || 1;\n\t\tel.value = this._opts.value || 0;\n\t\tel.onchange = bind(this, this._onChange);\n\n\t\tjscolor.bind(el);\n\t};\n\n\tthis.setValue = function(value) {\n\t\tif (value) {\n\t\t\tif (value[0] !== '#') {\n\t\t\t\tvalue = '#' + value;\n\t\t\t}\n\t\t\tthis._el.style.backgroundColor = value;\n\n\t\t\tvalue = value.substr(1, 6);\n\t\t}\n\t\tthis._el.value = value;\n\t};\n\n\tthis.getValue = function() {\n\t\treturn this._el.value;\n\t};\n\n\tthis._onChange = function() {\n\t\tthis.publish('Change', this._el.value);\n\t};\n});\n\n","pre":true},"sdk/squill/VerticalCenter.js":{"path":"sdk/squill/VerticalCenter.js","friendlyPath":".VerticalCenter","directory":"sdk/squill/","filename":"VerticalCenter.js","src":"\"use import\";\n\njsio(\"import .Widget\");\njsio(\"from util.browser import $\");\n\nvar sdk_squill_VerticalCenter=__class__;exports=sdk_squill_VerticalCenter(function sdk_squill_VerticalCenter(){return this.init&&this.init.apply(this,arguments)},Widget, function() {\n\tthis._def = {\n\t\ttag: 'table',\n\t\tstyle: merge({height: '100%', width: '100%'}, def.style),\n\t\tattrs: {cellpadding: 0, cellspacing: 0},\n\t\tchildren: [\n\t\t\t$({tag: 'tbody', children: [\n\t\t\t\t$({tag: 'tr', children: [\n\t\t\t\t\t$({id: 'contentPane', tag: 'td', attrs: {valign: 'middle'}, style: {verticalAlign: 'middle'}})\n\t\t\t\t]})\n\t\t\t]})\n\t\t]\n\t};\n\t\n\tthis.addElement = function() { this.contentPane.appendChild(el); }\n});\n","pre":true},"sdk/squill/TreeList.js":{"path":"sdk/squill/TreeList.js","friendlyPath":".TreeList","directory":"sdk/squill/","filename":"TreeList.js","src":"\"use import\";\n\njsio(\"from util.browser import $\");\n\njsio(\"import .Widget\");\n\nvar elementIDPrefix = 0;\n\nvar sdk_squill_TreeList=__class__;var TreeList = exports=sdk_squill_TreeList(function sdk_squill_TreeList(){return this.init&&this.init.apply(this,arguments)},Widget, function(supr) {\t\n\tvar defaults = {\n\t\tkey: 'id',\n\t\tlabel: 'title',\n\t\twrapperId: 'browser',\n\t\tcontentId: 'contentWrapper'\n\t};\n\n\tthis.init = function(opts) {\n\t\topts = opts || {};\n\t\topts = merge(opts, defaults);\n\n\t\tthis._initClasses(opts);\n\n\t\tthis._key = opts.key;\n\t\tthis._label = opts.label;\n\t\tthis._wrapperId = opts.wrapperId;\n\t\tthis._contentId = opts.contentId;\n\t\tthis._leaveWidth = opts.leaveWidth || 600;\n\n\t\telementIDPrefix++;\n\t\tthis._elementIDPrefix = 'menuItem' + elementIDPrefix + '_';\n\n\t\tif (opts.dataSource) {\n\t\t\tthis.setDataSource(opts.dataSource);\n\t\t} else {\n\t\t\tthis._dataSource = null;\n\t\t}\n\n\t\tthis._def = {id: this._wrapperId, className: 'browser', children: [\n\t\t\t\t\t\t{id: this._contentId, className: 'contentWrapper', children: []}\n\t\t\t\t\t]};\n\n\t\tthis._root = null;\n\t\tthis._itemByKey = {};\n\n\t\tsupr(this, 'init', arguments);\n\t};\n\n\tthis._initClasses = function(opts) {\n\t\tthis._classNames = {\n\t\t\tnodeWrapper: opts.nodeWrapper || 'browserNodeWrapper',\n\t\t\tnodeWrapperHidden: opts.nodeWrapperHidden || 'browserNodeWrapperHidden',\n\t\t\tnode: opts.node || 'browserNode',\n\t\t\tnodeChildren: opts.nodeChildren || 'children', // Node has children...\n\t\t\tnodeActive: opts.nodeActive || 'active', // Selected node...\n\t\t\tnodeActiveChild: opts.nodeActiveChild || 'browserNodeActiveChild'\n\t\t};\n\t};\n\n\tthis._clearItem = function(item) {\n\t\tvar parent,\n\t\t\tchildren,\n\t\t\ti, j;\n\n\t\tif (item.children) {\n\t\t\tchildren = item.children;\n\t\t\twhile (children.length) {\n\t\t\t\tthis._clearItem(children.pop());\n\t\t\t}\n\t\t}\n\n\t\tif (item.parent) {\n\t\t\tparent = item.parent;\n\t\t\tchildren = parent.children;\n\t\t\tfor (i = 0, j = children.length; i < j; i++) {\n\t\t\t\tif (children[i] === item) {\n\t\t\t\t\tchildren.splice(i, 1);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!children.length && parent.group) {\n\t\t\t\t$.remove(parent.group.parentNode);\n\t\t\t\t$.remove(parent.group);\n\t\t\t\tdelete(parent.group);\n\t\t\t}\n\t\t}\n\n\t\t$.remove(item.node);\n\t\titem.group && $.remove(item.group);\n\t};\n\n\tthis._createMenuId = function(inc) {\n\t\tvar menuId = this._menuId;\n\t\tif (inc) {\n\t\t\tthis._menuId++;\n\t\t}\n\t\treturn this._elementIDPrefix + menuId;\n\t};\n\n\tthis._createGroup = function(visible) {\n\t\tvar menuId = this._createMenuId(true),\n\t\t\tnode = $({\n\t\t\t\t\tparent: $({\n\t\t\t\t\t\t\t\tparent: $.id(this._contentId),\n\t\t\t\t\t\t\t\tid: menuId,\n\t\t\t\t\t\t\t\tclassName: visible ? this._classNames.nodeWrapper : this._classNames.nodeWrapperHidden\n\t\t\t\t\t\t\t}),\n\t\t\t\t\tclassName: this._classNames.node\n\t\t\t\t});\n\n\t\tnode.menuId = menuId;\n\t\treturn node;\n\t};\n\n\tthis._createItem = function(item, group) {\n\t\tvar id = this._createMenuId(true);\n\n\t\titem.node = $({parent: group, id: id, tag: 'a', text: item[this._label]});\n\t\t$.onEvent(id, 'click', this, 'onClick', item);\n\t};\n\n\tthis.buildWidget = function() {\n\t\tthis._menuId = 0;\n\t\tthis._menuById = [];\n\t\tthis._menuStack = [];\n\t\tthis._menuActiveItem = false;\n\n\t\tif (this._dataSource !== null) {\n\t\t\tthis._dataSource.each(bind(this, this.onCreateItem));\n\t\t}\n\t};\n\n\tthis._removeFromStack = function(depth) {\n\t\tvar menuStack = this._menuStack,\n\t\t\tinfo = null;\n\n\t\twhile (menuStack.length && (menuStack[menuStack.length - 1].depth >= depth)) {\n\t\t\tinfo = menuStack.pop();\n\n\t\t\t$.removeClass(info.node.id, this._classNames.nodeActive);\n\t\t\t$.removeClass(info.node.id, this._classNames.nodeActiveChild);\n\n\t\t\tif (info.group) {\n\t\t\t\t$.addClass(info.group.menuId, this._classNames.nodeWrapperHidden);\n\t\t\t\t$.removeClass(info.group.menuId, this._classNames.nodeWrapper);\n\t\t\t}\n\t\t}\n\n\t\treturn info;\n\t};\n\n\tthis.applyNodeStyle = function(item) {\n\t\tif (item.children && item.children.length) {\n\t\t\t$.addClass(item.node, this._classNames.nodeChildren);\n\t\t} else {\n\t\t\t$.removeClass(item.node, this._classNames.nodeChildren)\n\t\t}\n\t\tif (item === this._menuActiveItem) {\n\t\t\t$.addClass(item.node, this._classNames.nodeActive);\n\t\t} else {\n\t\t\t$.removeClass(item.node, this._classNames.nodeActive);\n\t\t}\n\n\t\tif ((item.removeCustomClass !== undefined) && item.removeCustomClass) {\n\t\t\t$.removeClass(item.node, item.removeCustomClass);\n\t\t}\n\t\tif ((item.customClass !== undefined) && item.customClass) {\n\t\t\t$.removeClass(item.node, item.customClass);\n\t\t\t$.addClass(item.node, item.customClass);\n\t\t}\n\t};\n\n\tthis._addToStack = function(item) {\n\t\tthis._menuStack.push(item);\n\t\tthis.applyNodeStyle(item);\n\n\t\tif (item.children && item.children.length) {\n\t\t\tif (!item.group) {\n\t\t\t\tvar child,\n\t\t\t\t\ti, j;\n\n\t\t\t\titem.children.sort();\n\n\t\t\t\titem.group = this._createGroup(true);\n\t\t\t\tfor (i = 0, j = item.children.length; i < j; i++) {\n\t\t\t\t\tchild = item.children[i];\n\t\t\t\t\tthis._createItem(child, item.group);\n\n\t\t\t\t\t// DisplayItem might change the styling of the element!\n\t\t\t\t\tthis.publish('DisplayItem', child.data, child);\n\t\t\t\t\tthis.applyNodeStyle(child);\n\t\t\t\t}\n\t\t\t}\n\t\t\t$.addClass(item.group.menuId, this._classNames.nodeWrapper);\n\t\t\t$.removeClass(item.group.menuId, this._classNames.nodeWrapperHidden);\n\t\t}\n\t};\n\n\tthis.onClick = function(item) {\n\t\tvar menuStack = this._menuStack;\n\t\tvar lastItem = null;\n\t\tvar id;\n\t\tvar i;\n\n\t\tthis.publish('SelectItem', item.data, item);\n\n\t\tif (this._menuActiveItem) {\n\t\t\tlastItem = this._menuActiveItem;\n\t\t\tthis._menuActiveItem = null;\n\t\t\tthis.applyNodeStyle(lastItem);\n\t\t\tlastItem = null;\n\t\t}\n\n\t\tif (menuStack.length && (item.depth <= menuStack[menuStack.length - 1].depth)) {\n\t\t\tlastItem = this._removeFromStack(item.depth);\n\t\t}\n\t\tif (lastItem !== item) {\n\t\t\tthis._addToStack(item);\n\t\t}\n\n\t\tthis._menuActiveItem = item;\n\t\tthis.applyNodeStyle(item);\n\n\t\tif (menuStack.length) {\n\t\t\ti = menuStack.length;\n\t\t\tif (menuStack[menuStack.length - 1].children && menuStack[menuStack.length - 1].children.length) {\n\t\t\t\ti++;\n\t\t\t}\n\t\t\t$.id(this._contentId).style.width = (i * 200 + this._leaveWidth) + 'px';\n\t\t}\n\t};\n\n\tthis.onUpdateItem = function(item, key) {\n\t\tvar treeItem = {\n\t\t\t\ttitle: item[this._label],\n\t\t\t\ttoString: function() { return this.title; }\n\t\t\t},\n\t\t\tparentItem,\n\t\t\tchildren,\n\t\t\tchild,\n\t\t\ti, j;\n\n\t\tif (this._itemByKey[key]) {\n\t\t\tif (this._itemByKey[key].node) {\n\t\t\t\tthis._itemByKey[key].node.innerHTML = item[this._label];\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tif ((item.parent === null) || (item.parent === -1)) {\n\t\t\tif (this._root === null) {\n\t\t\t\tthis._rootGroup = this._createGroup(true);\n\t\t\t\tthis._createItem(treeItem, this._rootGroup);\n\t\t\t\tthis._root = treeItem;\n\n\t\t\t\ttreeItem.data = item;\n\t\t\t\ttreeItem.depth = 0;\n\t\t\t\ttreeItem.parent = null;\n\n\t\t\t\t// DisplayItem might change the styling of the element!\n\t\t\t\tthis.publish('DisplayItem', treeItem.data, treeItem);\n\t\t\t\tthis.applyNodeStyle(treeItem);\n\t\t\t}\n\t\t} else {\n\t\t\tparentItem = this._itemByKey[item.parent[this._key]];\n\t\t\tif (parentItem) {\n\t\t\t\tif (!parentItem.children) {\n\t\t\t\t\tparentItem.children = [];\n\t\t\t\t}\n\t\t\t\tchildren = parentItem.children;\n\n\t\t\t\tif (this._menuActiveItem && ((this._menuActiveItem === parentItem) || (this._menuActiveItem.parent === parentItem))) {\n\t\t\t\t\tfor (i = 0, j = children.length; i < j; i++) {\n\t\t\t\t\t\tif (children[i].node) {\n\t\t\t\t\t\t\t$.remove(children[i].node)\n\t\t\t\t\t\t\tchildren[i].node = null;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tchildren.push(treeItem);\n\t\t\t\t\tchildren.sort();\n\n\t\t\t\t\tif (!parentItem.group) {\n\t\t\t\t\t\tparentItem.group = this._createGroup(true);\n\t\t\t\t\t\t$.id(this._contentId).style.width = ((this._menuStack.length + 1) * 200 + 500) + 'px';\n\t\t\t\t\t}\n\t\t\t\t\tfor (i = 0, j = children.length; i < j; i++) {\n\t\t\t\t\t\tchild = children[i];\n\t\t\t\t\t\tthis._createItem(child, parentItem.group);\n\n\t\t\t\t\t\t// DisplayItem might change the styling of the element!\n\t\t\t\t\t\tthis.publish('DisplayItem', child.data, child);\n\t\t\t\t\t\tthis.applyNodeStyle(child);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tchildren.push(treeItem);\n\t\t\t\t}\n\t\t\t}\n\t\t\ttreeItem.depth = parentItem.depth + 1;\n\t\t\ttreeItem.parent = parentItem;\n\t\t}\n\n\t\ttreeItem.data = item;\n\t\tthis._itemByKey[key] = treeItem;\n\t};\n\n\tthis.onCreateItem = function(item) {\n\t\tthis.onUpdateItem(item, item[this._key]);\n\t};\n\n\tthis.onRemoveItem = function(item, key) {\n\t\tvar treeItem = this._itemByKey[key];\n\t\tvar lastChild;\n\t\tvar treeParent;\n\t\t\n\t\tif (treeItem) {\n\t\t\tlastChild = (treeItem.parent.children.length <= 1);\n\t\t\ttreeParent = item[this._dataSource.parentKey];\n\n\t\t\tthis._removeFromStack(this._itemByKey[key].depth - 1);\n\t\t\tthis._clearItem(this._itemByKey[key]);\n\t\t\tthis._menuActiveItem = false;\n\n\t\t\tdelete(this._itemByKey[key]);\n\t\t\tthis.publish('UnSelectItem');\n\n\t\t\tif (lastChild && treeParent) {\n\t\t\t\ttreeItem = this._itemByKey[treeParent[this._dataSource.key]];\n\t\t\t\tthis.publish('DisplayItem', treeItem.data, treeItem);\n\t\t\t\tthis.applyNodeStyle(treeItem);\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.showItem = function(item) {\n\t\tvar treeItem = this.getTreeNode(item);\n\t\tthis.publish('DisplayItem', item, treeItem);\n\t\tthis.applyNodeStyle(treeItem);\n\t};\n\n\tthis.setDataSource = function(dataSource) {\n\t\tthis._dataSource = dataSource;\n\t\tthis._dataSource.subscribe('Update', this, this.onUpdateItem);\n\t\tthis._dataSource.subscribe('Remove', this, this.onRemoveItem);\n\t};\n\n\tthis.getPathString = function(separator) {\n\t\tvar result = '',\n\t\t\tmenuStack = this._menuStack,\n\t\t\ti, j;\n\n\t\tseparator = separator || ' ';\n\t\tfor (i = 0, j = menuStack.length; i < j; i++) {\n\t\t\tif (result !== '') {\n\t\t\t\tresult += separator;\n\t\t\t}\n\t\t\tresult += menuStack[i].data[this._label];\n\t\t}\n\n\t\treturn result;\n\t};\n\n\tthis.getTreeNode = function(item) {\n\t\treturn this._itemByKey[item[this._dataSource.key]];\n\t};\n});","pre":true},"sdk/squill/Graph.js":{"path":"sdk/squill/Graph.js","friendlyPath":".Graph","directory":"sdk/squill/","filename":"Graph.js","src":"\"use import\";\n\njsio(\"from util.browser import $\");\njsio(\"import .Widget\");\n\njsio(\"import .hint as hint\");\n\nvar sdk_squill_Graph=__class__;var Graph = exports=sdk_squill_Graph(function sdk_squill_Graph(){return this.init&&this.init.apply(this,arguments)},Widget, function(supr) {\n\tthis._css = 'cnvs';\n\tthis._type = 'canvas';\n\t\n\tthis.init = function(opts) {\n\t\tparams = merge(opts, {tag: 'canvas'});\n\t\tsupr(this, 'init', arguments);\n\n\t\tthis.setSettings(opts.settings || {});\n\n\t\tthis._width = opts.width || 400;\n\t\tthis._height = opts.height || 400;\n\n\t\tthis._rectangles = [];\n\t\tthis._data = false;\n\n\t\t$.onEvent(this._el, 'mousemove', this, this._onMouseMove);\n\t\t$.onEvent(this._el, 'mouseout', this, this._onMouseOut);\n\t};\n\n\tthis._onMouseMove = function(evt) {\n\t\tvar rectangles = this._rectangles,\n\t\t\trectangle,\n\t\t\tfound = false,\n\t\t\ti = rectangles.length;\n\n\t\twhile (i) {\n\t\t\trectangle = rectangles[--i];\n\t\t\tif ((evt.offsetX >= rectangle.x1) && (evt.offsetY >= rectangle.y1) &&\n\t\t\t\t(evt.offsetX <= rectangle.x2) && (evt.offsetY <= rectangle.y2)) {\n\t\t\t\tfound = true;\n\t\t\t\tbreak;\t\n\t\t\t}\n\t\t}\n\n\t\tif (found) {\n\t\t\thint.show(evt.pageX + 15, evt.pageY + 15, rectangle.label);\n\t\t} else {\n\t\t\thint.hide();\n\t\t}\n\t};\n\n\tthis._onMouseOut = function(evt) {\n\t\thint.hide();\n\t};\n\n\tthis.buildWidget = function() {\n\t\tvar el = this._el;\n\n\t\tthis.initMouseEvents(el);\n\t\tthis.initKeyEvents(el);\n\t};\n\n\tthis._renderBackground = function(ctx) {\n\t\tvar el = this._el,\n\t\t\twidth = el.width,\n\t\t\theight = el.height;\n\n\t\tthis._currentWidth = width;\n\t\tthis._currentHeight = height;\n\n\t\tif (this._settings.fillColor) {\n\t\t\tctx.fillStyle = this._settings.fillColor;\n\t\t\tctx.fillRect(0, 0, width, height);\n\t\t} else {\n\t\t\tctx.clearRect(0, 0, width, height);\n\t\t}\n\t};\n\n\tthis._calculateSegments = function(ctx, data) {\n\t\tvar settings = this._settings,\n\t\t\tmax = 0,\n\t\t\tmaxLabel = 0,\n\t\t\ti, j = data.length,\n\t\t\tk, l;\n\n\t\tfor (i = 0; i < j; i++) {\n\t\t\titem = data[i];\n\t\t\tmaxLabel = Math.max(ctx.measureText(item.title).width, maxLabel);\n\t\t\tif (maxLabel > settings.maxLabelSize) {\n\t\t\t\tmaxLabel = settings.maxLabelSize;\n\t\t\t}\n\t\t\tfor (k = 0, l = item.points.length; k < l; k++) {\n\t\t\t\tmax = Math.max(item.points[k], max);\n\t\t\t}\n\t\t}\n\n\t\tvar steps = [0.5, 0.25, 0.2, 0.125, 0.1],\n\t\t\tstepIndex = 0,\n\t\t\tstepCount,\n\t\t\tfactor = 1;\n\n\t\twhile (max / (steps[stepIndex] * factor) > 10) {\n\t\t\tstepIndex++;\n\t\t\tif (stepIndex >= steps.length) {\n\t\t\t\tstepIndex = 0;\n\t\t\t\tfactor *= 10;\n\t\t\t}\n\t\t}\n\n\t\tstepCount = Math.ceil(max / (steps[stepIndex] * factor));\n\t\treturn {\n\t\t\tsteps: stepCount,\n\t\t\tstep: steps[stepIndex],\n\t\t\tmax: stepCount * steps[stepIndex] * factor,\n\t\t\tmaxLabel: maxLabel + 4,\n\t\t\tfactor: factor\n\t\t}\n\t};\n\n\tthis._trimLabel = function(segmentInfo, ctx, label) {\n\t\tif (ctx.measureText(label).width > segmentInfo.maxLabel) {\n\t\t\twhile (ctx.measureText(label + '...').width > segmentInfo.maxLabel) {\n\t\t\t\tlabel = label.substr(0, label.length - 1);\n\t\t\t}\n\t\t\tlabel += '...';\n\t\t}\n\t\treturn label;\n\t};\n\n\tthis._renderHorizontalAxis = function(segmentInfo, ctx, data) {\n\t\tvar settings = this._settings,\n\t\t\tvalueSpace = settings.valueSpace,\n\t\t\tmainPadding = settings.mainPadding,\n\t\t\twidth = this._currentWidth - mainPadding * 2 - valueSpace,\n\t\t\theight = this._currentHeight - mainPadding * 2 - segmentInfo.maxLabel,\n\t\t\tstep = width / data.length,\n\t\t\tlabel,\n\t\t\thasDecimal,\n\t\t\tx, y,\n\t\t\ti, j, k;\n\n\t\tctx.strokeStyle = settings.barBackground;\n\t\tfor (i = 0; i < 2; i++) {\n\t\t\tx = valueSpace + mainPadding + 0.5 + i * width;\n\t\t\tctx.beginPath();\n\t\t\tctx.moveTo(x, mainPadding);\n\t\t\tctx.lineTo(x, mainPadding + height);\n\t\t\tctx.stroke();\n\t\t}\n\n\t\tctx.textAlign = 'right';\n\t\tctx.textBaseline = 'top';\n\n\t\tfor (i = 0, j = data.length; i < j; i++) {\n\t\t\tx = valueSpace + mainPadding + i * step;\n\t\t\tctx.save();\n\t\t\tctx.rotate(Math.PI * -0.5);\n\t\t\tlabel = this._trimLabel(segmentInfo, ctx, data[i].title);\n\n\t\t\tctx.fillStyle = this._settings.textColor;\n\t\t\tctx.fillText(label, -(mainPadding + height + 4), x);\n\t\t\tctx.restore();\n\n\t\t\tif ((i & 1) === 0) {\n\t\t\t\tctx.fillStyle = settings.barBackground;\n\t\t\t\tctx.fillRect(x, mainPadding, step, height);\n\t\t\t}\n\t\t}\n\n\t\tctx.strokeStyle = this._settings.lineColor;\n\t\tctx.fillStyle = '#000000';\n\n\t\thasDecimal = 0;\n\t\ti = height;\n\t\tj = 0;\n\t\twhile (i >= 0) {\n\t\t\tlabel = (j * segmentInfo.step).toString(10);\n\t\t\tk = label.indexOf('.');\n\t\t\tif (k !== -1) {\n\t\t\t\tk = label.length - k - 1;\n\t\t\t\tif (k > hasDecimal) {\n\t\t\t\t\thasDecimal = k;\n\t\t\t\t}\n\t\t\t}\n\t\t\ti = Math.ceil(i - height / segmentInfo.steps);\n\t\t\tj++;\n\t\t}\n\n\t\ti = height;\n\t\tj = 0;\n\t\twhile (i >= 0) {\n\t\t\tx = mainPadding + valueSpace;\n\t\t\ty = mainPadding + ~~i + 0.5;\n\t\t\tctx.beginPath();\n\t\t\tctx.moveTo(x, y);\n\t\t\tctx.lineTo(x + width, y);\n\t\t\tctx.stroke();\n\n\t\t\tlabel = (j * segmentInfo.step).toString(10);\n\t\t\tif (hasDecimal && (label.indexOf('.') === -1)) {\n\t\t\t\tlabel += '.';\n\t\t\t\tfor (k = 0; k < hasDecimal; k++) {\n\t\t\t\t\tlabel += '0';\n\t\t\t\t}\n\t\t\t}\n\t\t\tctx.fillStyle = this._settings.textColor;\n\t\t\tctx.fillText(label, valueSpace + mainPadding - 2, mainPadding + i - 8);\n\n\t\t\ti = Math.ceil(i - height / segmentInfo.steps);\n\t\t\tj++;\n\t\t}\n\n\t\tctx.textAlign = 'left';\n\n\t\tlabel = settings.mainLabel + ' x' + segmentInfo.factor;\n\n\t\ti = mainPadding;\n\t\tj = mainPadding + height / 2 + (ctx.measureText(label).width + settings.itemSize) / 2;\n\t\tctx.save();\n\t\tctx.rotate(Math.PI * -0.5);\n\t\tctx.fillStyle = this._settings.textColor;\n\t\tctx.fillText(label, -j - settings.itemSize, i);\n\t\tctx.restore();\n\n\t\tj -= ctx.measureText(label).width;\n\t\tctx.beginPath();\n\t\tctx.moveTo(i + 7.5, j);\n\t\tctx.lineTo(i + 7.5, j + 26);\n\t\tctx.stroke();\n\n\t\tctx.beginPath();\n\t\tctx.moveTo(i + 3.5, j + 5.5);\n\t\tctx.lineTo(i + 7.5, j);\n\t\tctx.lineTo(i + 11.5, j + 5.5);\n\t\tctx.stroke();\n\t};\n\n\tthis._renderVerticalBars = function(segmentInfo, ctx, data) {\n\t\tvar settings = this._settings,\n\t\t\tvalueSpace = settings.valueSpace,\n\t\t\tmainPadding = settings.mainPadding,\n\t\t\twidth = this._currentWidth - mainPadding * 2 - valueSpace,\n\t\t\theight = this._currentHeight - mainPadding * 2 - segmentInfo.maxLabel,\n\t\t\tstep = width / data.length,\n\t\t\tbarWidth = step - settings.barPadding * 2,\n\t\t\tbarWidthSeg,\n\t\t\tbarHeight,\n\t\t\tbarX,\n\t\t\titem,\n\t\t\tpoints,\n\t\t\ti, j, k, l;\n\n\t\tctx.globalAlpha = 0.9;\n\t\tfor (i = 0, j = data.length; i < j; i++) {\n\t\t\titem = data[i];\n\t\t\tpoints = item.points;\n\n\t\t\tl = points.length;\n\t\t\tbarWidthSeg = ~~(barWidth / l);\n\t\t\tfor (k = 0; k < l; k++) {\n\t\t\t\tbarHeight = item.points[k] / segmentInfo.max * height;\n\t\t\t\tbarX = valueSpace + mainPadding + i * step + settings.barPadding;\n\t\t\t\tbarY = mainPadding + height - barHeight;\n\n\t\t\t\tctx.fillStyle = settings.dataColors[k % settings.dataColors.length];\n\t\t\t\tctx.fillRect(barX + k * barWidthSeg, barY, barWidthSeg - 1, barHeight);\n\t\t\t}\n\t\t}\n\t\tctx.globalAlpha = 1;\n\t};\n\n\tthis._renderVerticalPoints = function(segmentInfo, ctx, data) {\n\t\tvar settings = this._settings,\n\t\t\trenderPoints = (settings.types.indexOf('points') !== -1),\n\t\t\trenderLines = (settings.types.indexOf('lines') !== -1),\n\t\t\trenderArea = (settings.types.indexOf('area') !== -1),\n\t\t\tvalueSpace = settings.valueSpace,\n\t\t\tmainPadding = settings.mainPadding,\n\t\t\twidth = this._currentWidth - mainPadding * 2 - valueSpace,\n\t\t\theight = this._currentHeight - mainPadding * 2 - segmentInfo.maxLabel,\n\t\t\tstep = width / data.length,\n\t\t\tpointWidth = step - settings.barPadding * 2,\n\t\t\tpointX, pointY,\n\t\t\tpoints,\n\t\t\tpoint,\n\t\t\tpointList = [],\n\t\t\thasLast,\n\t\t\titem,\n\t\t\ti, j, k, l;\n\n\t\tpointYLast = null;\n\n\t\tfor (i = 0, j = data.length; i < j; i++) {\n\t\t\titem = data[i];\n\t\t\tpoints = item.points;\n\n\t\t\thasLast = pointYLast !== null;\n\t\t\tif (pointYLast === null) {\n\t\t\t\tpointYLast = [];\n\t\t\t}\n\t\t\tpointX = ~~(valueSpace + mainPadding + i * step + settings.barPadding + (pointWidth / 2));\n\t\t\tfor (k = 0, l = points.length; k < l; k++) {\n\t\t\t\tpointY = ~~(mainPadding + height - item.points[k] / segmentInfo.max * height);\n\n\t\t\t\tif (!pointList[k]) {\n\t\t\t\t\tpointList[k] = [];\n\t\t\t\t}\n\t\t\t\tpointList[k].push({x: pointX, y: pointY});\n\n\t\t\t\tctx.strokeStyle = settings.dataColors[k % settings.dataColors.length];\n\t\t\t\tif (renderPoints) {\n\t\t\t\t\tctx.strokeRect(pointX - 4.5, pointY - 4.5, 10, 10);\n\t\t\t\t}\n\n\t\t\t\tif (hasLast && renderLines) {\n\t\t\t\t\tctx.beginPath();\n\t\t\t\t\tctx.moveTo(pointXLast, pointYLast[k]);\n\t\t\t\t\tctx.lineTo(pointX, pointY);\n\t\t\t\t\tctx.stroke();\n\t\t\t\t}\n\n\t\t\t\tpointYLast[k] = pointY;\n\t\t\t}\n\t\t\tpointXLast = pointX;\n\t\t}\n\n\t\tif (renderArea) {\n\t\t\tctx.globalAlpha = 0.05;\n\t\t\tfor (i = 0, j = pointList.length; i < j; i++) {\n\t\t\t\tctx.beginPath();\n\t\t\t\tctx.lineTo(pointList[i][0].x, mainPadding + height);\n\t\t\t\tfor (k = 0, l = pointList[i].length; k < l; k++) {\n\t\t\t\t\tpoint = pointList[i][k];\n\t\t\t\t\tctx.lineTo(point.x, point.y);\n\t\t\t\t}\n\t\t\t\tctx.lineTo(pointList[i][l - 1].x, mainPadding + height);\n\t\t\t\tctx.closePath();\n\t\t\t\tctx.fillStyle = settings.dataColors[i % settings.dataColors.length];\n\t\t\t\tctx.fill();\n\t\t\t}\n\t\t\tctx.globalAlpha = 1;\n\t\t}\n\t};\n\n\tthis._renderVerticalAxis = function(segmentInfo, ctx, data) {\n\t\tvar settings = this._settings,\n\t\t\tvalueSpace = settings.valueSpace,\n\t\t\tmainPadding = settings.mainPadding,\n\t\t\twidth = this._currentWidth - mainPadding * 2 - segmentInfo.maxLabel,\n\t\t\theight = this._currentHeight - mainPadding * 2 - valueSpace,\n\t\t\tstep = height / data.length,\n\t\t\tlabel,\n\t\t\thasDecimal,\n\t\t\tx, y,\n\t\t\ti, j, k;\n\n\t\tctx.strokeStyle = settings.barBackground;\n\t\tfor (i = 0; i < 2; i++) {\n\t\t\ty = mainPadding + 0.5 + i * height;\n\t\t\tctx.beginPath();\n\t\t\tctx.moveTo(mainPadding + segmentInfo.maxLabel, y);\n\t\t\tctx.lineTo(mainPadding + segmentInfo.maxLabel + width, y);\n\t\t\tctx.stroke();\n\t\t}\n\n\t\tctx.textAlign = 'right';\n\t\tctx.textBaseline = 'top';\n\n\t\tfor (i = 0, j = data.length; i < j; i++) {\n\t\t\ty = mainPadding + i * step;\n\t\t\tlabel = this._trimLabel(segmentInfo, ctx, data[i].title);\n\n\t\t\tctx.fillStyle = this._settings.textColor;\n\t\t\tctx.fillText(label, mainPadding + segmentInfo.maxLabel - 4, y + 4);\n\t\t\tthis._rectangles.push({\n\t\t\t\tx1: mainPadding + segmentInfo.maxLabel - 4 - ctx.measureText(label).width,\n\t\t\t\ty1: y + 4,\n\t\t\t\tx2: mainPadding + segmentInfo.maxLabel - 4,\n\t\t\t\ty2: y + 20,\n\t\t\t\tlabel: data[i].title\n\t\t\t});\n\t\t\tif ((i & 1) === 0) {\n\t\t\t\tctx.fillStyle = settings.barBackground;\n\t\t\t\tctx.fillRect(mainPadding + segmentInfo.maxLabel, y, width, step);\n\t\t\t}\n\t\t}\n\n\t\tctx.textAlign = 'center';\n\n\t\tctx.strokeStyle = this._settings.lineColor;\n\t\tctx.fillStyle = '#000000';\n\n\t\thasDecimal = 0;\n\t\ti = 0;\n\t\tj = 0;\n\t\twhile (i <= width) {\n\t\t\tlabel = (j * segmentInfo.step).toString(10);\n\t\t\tk = label.indexOf('.');\n\t\t\tif (k !== -1) {\n\t\t\t\tk = label.length - k - 1;\n\t\t\t\tif (k > hasDecimal) {\n\t\t\t\t\thasDecimal = k;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\ti = Math.floor(i + width / segmentInfo.steps);\n\t\t\tj++;\n\t\t}\n\n\t\ti = 0;\n\t\tj = 0;\n\t\twhile (i <= width) {\n\t\t\tx = mainPadding + segmentInfo.maxLabel + ~~i + 0.5;\n\t\t\ty = mainPadding;\n\t\t\tctx.beginPath();\n\t\t\tctx.moveTo(x, y);\n\t\t\tctx.lineTo(x, y + height);\n\t\t\tctx.stroke();\n\n\t\t\tlabel = (j * segmentInfo.step).toString(10);\n\t\t\tif (hasDecimal && (label.indexOf('.') === -1)) {\n\t\t\t\tlabel += '.';\n\t\t\t\tfor (k = 0; k < hasDecimal; k++) {\n\t\t\t\t\tlabel += '0';\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tctx.fillStyle = this._settings.textColor;\n\t\t\tctx.fillText(label, mainPadding + segmentInfo.maxLabel + i, mainPadding + height + 2);\n\n\t\t\ti = Math.floor(i + width / segmentInfo.steps);\n\t\t\tj++;\n\t\t}\n\n\t\tctx.textAlign = 'left';\n\n\t\tlabel = settings.mainLabel + ' x' + segmentInfo.factor;\n\n\t\ti = mainPadding + width / 2 - (ctx.measureText(label).width + settings.itemSize) / 2 + segmentInfo.maxLabel;\n\t\tj = mainPadding + height + 18;\n\n\t\tctx.fillStyle = this._settings.textColor;\n\t\tctx.fillText(label, i, j);\n\n\t\ti += ctx.measureText(label).width;\n\t\tctx.beginPath();\n\t\tctx.moveTo(i + 4, j + 7.5);\n\t\tctx.lineTo(i + settings.itemSize, j + 7.5);\n\t\tctx.stroke();\n\n\t\tctx.beginPath();\n\t\tctx.moveTo(i + settings.itemSize - 4, j + 3.5);\n\t\tctx.lineTo(i + settings.itemSize, j + 7.5);\n\t\tctx.lineTo(i + settings.itemSize - 4, j + 11.5);\n\t\tctx.stroke();\n\t}\n\n\tthis._renderHorizontalBars = function(segmentInfo, ctx, data) {\n\t\tvar settings = this._settings,\n\t\t\tvalueSpace = settings.valueSpace,\n\t\t\tmainPadding = settings.mainPadding,\n\t\t\twidth = this._currentWidth - mainPadding * 2 - segmentInfo.maxLabel,\n\t\t\theight = this._currentHeight - mainPadding * 2 - valueSpace,\n\t\t\tstep = height / data.length,\n\t\t\tbarWidth,\n\t\t\tbarHeight = step - settings.barPadding * 2,\n\t\t\tbarHeightSeg,\n\t\t\tbarX, barY,\n\t\t\titem,\n\t\t\tpoints,\n\t\t\ti, j, k, l;\n\n\t\tctx.globalAlpha = 0.9;\n\t\tfor (i = 0, j = data.length; i < j; i++) {\n\t\t\titem = data[i];\n\t\t\tpoints = item.points;\n\n\t\t\tl = points.length;\n\t\t\tbarHeightSeg = ~~(barHeight / l);\n\t\t\tfor (k = 0; k < l; k++) {\n\t\t\t\tbarWidth = ~~(item.points[k] / segmentInfo.max * width);\n\t\t\t\tbarX = segmentInfo.maxLabel + mainPadding;\n\t\t\t\tbarY = ~~mainPadding + i * step + settings.barPadding;\n\n\t\t\t\tctx.fillStyle = settings.dataColors[k % settings.dataColors.length];\n\t\t\t\tctx.fillRect(barX, barY + k * barHeightSeg, barWidth, barHeightSeg - 1);\n\t\t\t}\n\t\t}\n\t\tctx.globalAlpha = 1;\n\t};\n\n\tthis._renderHorizontalPoints = function(segmentInfo, ctx, data) {\n\t\tvar settings = this._settings,\n\t\t\trenderPoints = (settings.types.indexOf('points') !== -1),\n\t\t\trenderLines = (settings.types.indexOf('lines') !== -1),\n\t\t\trenderArea = (settings.types.indexOf('area') !== -1),\n\t\t\tvalueSpace = settings.valueSpace,\n\t\t\tmainPadding = settings.mainPadding,\n\t\t\twidth = this._currentWidth - mainPadding * 2 - segmentInfo.maxLabel,\n\t\t\theight = this._currentHeight - mainPadding * 2 - valueSpace,\n\t\t\tstep = height / data.length,\n\t\t\tpointHeight = step - settings.barPadding * 2,\n\t\t\tpointX, pointY,\n\t\t\tpoints,\n\t\t\tpoint,\n\t\t\tpointList = [],\n\t\t\thasLast,\n\t\t\titem,\n\t\t\ti, j, k, l;\n\n\t\tpointXLast = null;\n\n\t\tfor (i = 0, j = data.length; i < j; i++) {\n\t\t\titem = data[i];\n\t\t\tpoints = item.points;\n\n\t\t\thasLast = pointXLast !== null;\n\t\t\tif (pointXLast === null) {\n\t\t\t\tpointXLast = [];\n\t\t\t}\n\t\t\tpointY = ~~(mainPadding + i * step + settings.barPadding + pointHeight / 2);\n\t\t\tfor (k = 0, l = points.length; k < l; k++) {\n\t\t\t\tpointX = ~~(mainPadding + item.points[k] / segmentInfo.max * width + segmentInfo.maxLabel);\n\n\t\t\t\tif (!pointList[k]) {\n\t\t\t\t\tpointList[k] = [];\n\t\t\t\t}\n\t\t\t\tpointList[k].push({x: pointX, y: pointY});\n\n\t\t\t\tctx.strokeStyle = settings.dataColors[k % settings.dataColors.length];\n\t\t\t\tif (renderPoints) {\n\t\t\t\t\tctx.strokeRect(pointX - 4.5, pointY - 4.5, 10, 10);\n\t\t\t\t}\n\n\t\t\t\tif (hasLast && renderLines) {\n\t\t\t\t\tctx.beginPath();\n\t\t\t\t\tctx.moveTo(pointXLast[k], pointYLast);\n\t\t\t\t\tctx.lineTo(pointX, pointY);\n\t\t\t\t\tctx.stroke();\n\t\t\t\t}\n\n\t\t\t\tpointXLast[k] = pointX;\n\t\t\t}\n\t\t\tpointYLast = pointY;\n\t\t}\n\n\t\tif (renderArea) {\n\t\t\tctx.globalAlpha = 0.05;\n\t\t\tfor (i = 0, j = pointList.length; i < j; i++) {\n\t\t\t\tctx.beginPath();\n\t\t\t\tctx.moveTo(mainPadding + segmentInfo.maxLabel, pointList[i][0].y);\n\t\t\t\tfor (k = 0, l = pointList[i].length; k < l; k++) {\n\t\t\t\t\tpoint = pointList[i][k];\n\t\t\t\t\tctx.lineTo(point.x, point.y);\n\t\t\t\t}\n\t\t\t\tctx.lineTo(mainPadding + segmentInfo.maxLabel, pointList[i][l - 1].y);\n\t\t\t\tctx.closePath();\n\t\t\t\tctx.fillStyle = settings.dataColors[i % settings.dataColors.length];\n\t\t\t\tctx.fill();\n\t\t\t}\n\t\t\tctx.globalAlpha = 1;\n\t\t}\n\t};\n\n\tthis.setData = function(data) {\n\t\tvar el = this._el,\n\t\t\tctx = el.getContext('2d'),\n\t\t\tsettings = this._settings,\n\t\t\ttypes = settings.types,\n\t\t\taxisRenderMethod = function() {},\n\t\t\tbarsRenderMethod = function() {},\n\t\t\tpointsRenderMethod = function() {},\n\t\t\tsegmentInfo;\n\n\t\tswitch (settings.orientation) {\n\t\t\tcase 'horizontal':\n\t\t\t\tel.width = this._width;\n\t\t\t\tel.height = data.length * settings.itemSize + this._settings.valueSpace;\n\t\t\t\taxisRenderMethod = bind(this, this._renderVerticalAxis);\n\t\t\t\tbarsRenderMethod = bind(this, this._renderHorizontalBars);\n\t\t\t\tpointsRenderMethod = bind(this, this._renderHorizontalPoints);\n\t\t\t\tbreak;\n\n\t\t\tcase 'vertical':\n\t\t\t\tel.width = data.length * settings.itemSize + this._settings.valueSpace;\n\t\t\t\tel.height = this._height;\n\t\t\t\taxisRenderMethod = bind(this, this._renderHorizontalAxis);\n\t\t\t\tbarsRenderMethod = bind(this, this._renderVerticalBars);\n\t\t\t\tpointsRenderMethod = bind(this, this._renderVerticalPoints);\n\t\t\t\tbreak;\n\t\t}\n\n\t\tctx.font = settings.font;\n\n\t\tthis._renderBackground(ctx);\n\n\t\tif (data.length) {\n\t\t\tsegmentInfo = this._calculateSegments(ctx, data);\n\n\t\t\taxisRenderMethod(segmentInfo, ctx, data);\n\n\t\t\tif ((types.indexOf('points') !== -1) || (types.indexOf('area') !== -1) || (types.indexOf('lines') !== -1)) {\n\t\t\t\tpointsRenderMethod(segmentInfo, ctx, data);\n\t\t\t}\n\t\t\tif (types.indexOf('bars') !== -1) {\n\t\t\t\tbarsRenderMethod(segmentInfo, ctx, data);\n\t\t\t}\n\t\t}\n\n\t\tthis._data = data;\n\t};\n\n\tthis.setSettings = function(settings) {\n\t\tsettings.mainLabel = settings.mainLabel || '';\n\t\tsettings.textColor = settings.textColor || '#000000';\n\t\tsettings.fillColor = (settings.fillColor === undefined) ? '#FFFFFF' : settings.fillColor;\n\t\tsettings.lineColor = settings.lineColor || '#000000';\n\t\tsettings.orientation = settings.oriantation || 'horizontal';\n\t\tsettings.types = settings.types || 'bars,lines,area,points';\n\t\tsettings.barPadding = settings.barPadding || 2;\n\t\tsettings.barBackground = settings.barBackground || '#F8F8F8';\n\t\tsettings.mainPadding = settings.mainPadding || 10;\n\t\tsettings.valueSpace = settings.valueSpace || 40;\n\t\tsettings.dataColors = settings.dataColors || ['#DD0000', '#00DD00', '#0000DD'];\n\t\tsettings.font = settings.font || '13px Verdana';\n\t\tsettings.maxLabelSize = settings.maxLabelSize || 200;\n\t\tsettings.itemSize = settings.itemSize || 50;\n\n\t\tthis._settings = settings;\n\t};\n\n\tthis.update = function() {\n\t\tthis._data && this.setData(this._data);\n\t};\n});\n","pre":true},"sdk/timestep/ui/backend/dom/animate.js":{"path":"sdk/timestep/ui/backend/dom/animate.js","friendlyPath":".backend.dom.animate","directory":"sdk/timestep/ui/backend/dom/","filename":"animate.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @package ui.backend.dom.animate;\n *\n * For now, this package simply forwards to Canvas' implementation.\n */\n\njsio(\"import ui.backend.canvas.animate as canvasAnimate\");\n\nexports = function (view) {\n\t// For DOM nodes, return only one singleton animation class.\n\tif ('_node' in view) {\n\t\treturn view.getAnimation();\n\t} else {\n\t\treturn canvasAnimate(view);\n\t}\n}\nexports.linear = canvasAnimate.linear;\nexports.easeIn = canvasAnimate.easeIn;\nexports.easeInOut = canvasAnimate.easeInOut;\nexports.easeOut = canvasAnimate.easeOut;\n","pre":true},"sdk/timestep/ui/backend/dom/ImageView.js":{"path":"sdk/timestep/ui/backend/dom/ImageView.js","friendlyPath":".backend.dom.ImageView","directory":"sdk/timestep/ui/backend/dom/","filename":"ImageView.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @package ui.backend.dom.ImageView;\n *\n * Renders an image in a View for canvas.\n */\n\njsio(\"import ui.View as View\");\njsio(\"import ui.resource.Image as Image\");\n\nfunction getImageURL(image) {\n\tif (image.getSource) {\n\t\treturn image.getSource().src;\n\t} else {\n\t\treturn image;\n\t}\n}\n\n/**\n * @extends timestep.View\n */\nvar sdk_timestep_ui_backend_dom_ImageView=__class__;exports=sdk_timestep_ui_backend_dom_ImageView(function sdk_timestep_ui_backend_dom_ImageView(){return this.init&&this.init.apply(this,arguments)},View, function (supr) {\n\n\tthis.init = function (opts) {\n\t\topts = merge(opts, {\n\t\t\timage: null,\n\t\t\tautoSize: false\n\t\t});\n\n\t\tsupr(this, \"init\", [opts]);\n\n\t\tif (opts.image) {\n\t\t\tthis.setImage(opts.image, opts); \n\t\t}\n\t};\n\n\tthis.autoSize = function () {\n\t\tif (this._img) {\n\t\t\tthis.style.width = this._img.getWidth();\n\t\t\tthis.style.height = this._img.getHeight();\n\n\t\t\tif (this.style.fixedAspectRatio) {\n\t\t\t\tthis.style.updateAspectRatio();\n\t\t\t}\n\t\t}\n\t}\n\n\tthis.tick = function () {\n\t\tif (this._img) {\n\t\t\tvar boundsHash = JSON.stringify(this._img.getBounds());\n\t\t\tif (this._cachedBounds != boundsHash) {\n\t\t\t\tthis._cachedBounds = boundsHash;\n\t\t\t\tthis.updateImage();\n\t\t\t}\n\t\t}\n\t}\n\n\tthis._imgCache = {};\n\n\tthis.getImage = function () { return this._img; }\n\tthis.setImage = function (img, opts) {\n\t\tif (typeof img == 'string') {\n\t\t\t// Cache image requests to avoid heavy performance penalties at the\n\t\t\t// expense of a small amount of additional JS memory usage.\n\t\t\tvar name = img;\n\t\t\timg = this._imgCache[name];\n\t\t\tif (!img) {\n\t\t\t\tthis._imgCache[img] = img = new Image({url: name});\n\t\t\t}\n\t\t}\n\n\t\tthis._img = img;\n\n\t\tif (this._img) {\n\t\t\tif (opts && opts.autoSize) {\n\t\t\t\t// sprited resources will know their dimensions immediately\n\t\t\t\tif (this._img.getWidth() > 0 && this._img.getHeight() > 0) {\n\t\t\t\t\tthis.autoSize();\n\t\t\t\t} else {\n\t\t\t\t\t// non-sprited resources need to load first\n\t\t\t\t\tthis._img.doOnLoad(this, 'autoSize');\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis._img.doOnLoad(this, 'updateImage');\n\t\t} else {\n\t\t\tthis.updateImage();\n\t\t}\n\t}\n\n\tthis.reflow = function () {\n\t\tthis.updateImage();\n\t}\n\n\tthis.updateImage = function () {\n\t\tvar s = this.__view._node.style;\n\t\tif (!this._img || !this._img.isReady()) {\n\t\t\ts.backgroundImage = 'none';\n\t\t\treturn;\n\t\t}\n\n\t\tvar img = this._img;\n\t\tvar bounds = img.getBounds();\n\n\t\tvar sheetWidth = img.getOrigW();\n\t\tvar sheetHeight = img.getOrigH();\n\t\tvar imgWidth = bounds.width + bounds.marginLeft + bounds.marginRight;\n\t\tvar imgHeight = bounds.height + bounds.marginTop + bounds.marginBottom;\n\n\t\ts.padding = bounds.marginTop + 'px ' + bounds.marginRight + 'px ' + bounds.marginBottom + 'px ' + bounds.marginLeft + 'px';\n\n\t\tvar scaleX = this.style.width / imgWidth;\n\t\tvar scaleY = this.style.height / imgHeight;\n\n\t\t//s.overflow = 'hidden';\n\t\ts.webkitBackgroundClip = s.backgroundClip = 'content-box';\n\t\ts.backgroundImage = 'url(\"' + getImageURL(img) + '\")';\n\t\ts.backgroundPositionX = scaleX * (-bounds.x + bounds.marginLeft) + 'px';\n\t\ts.backgroundPositionY = scaleY * (-bounds.y + bounds.marginTop) + 'px';\n\t\ts.backgroundSize = sheetWidth * scaleX + 'px ' + sheetHeight * scaleY + 'px';\n\t}\n\n\tthis.getOrigWidth = this.getOrigW = function () { return this._img.getOrigW(); }\n\tthis.getOrigHeight = this.getOrigH = function () { return this._img.getOrigH(); }\n\n\tthis.doOnLoad = function () {\n\t\tif (arguments.length == 1) {\n\t\t\tthis._img.doOnLoad(this, arguments[0]);\n\t\t} else {\n\t\t\tthis._img.doOnLoad.apply(this._img, arguments);\n\t\t}\n\t\treturn this;\n\t}\n\n});\n","pre":true},"sdk/timestep/ui/resource/Image.js":{"path":"sdk/timestep/ui/resource/Image.js","friendlyPath":"ui.resource.Image","directory":"sdk/timestep/ui/resource/","filename":"Image.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @class ui.resource.Image;\n * Model an Image for rendering. Supports taking a subset of images, to support\n * extracting from compacted sprite sheets. Also supports applying filters to\n * an image, usually by the View class.\n *\n * @doc http://doc.gameclosure.com/api/ui-imageview.html#class-ui.resource.image\n * @docsrc https://github.com/gameclosure/doc/blob/master/api/ui/imageview.md\n */\n\njsio(\"import event.Callback as Callback\");\njsio(\"import math.geom.Rect as Rect\");\njsio(\"import lib.PubSub\");\njsio(\"import device\");\njsio(\"import ui.resource.loader as resourceLoader\");\n\n/**\n * Callback when images are loaded. This has a failsafe that runs up to a certain\n * threshold asynchronously, attempting to read the image size, before dying.\n */\n\nvar ImageCache = {};\n\n// `imageOnLoad` is called when a DOM image object fires a `load` or `error`\n// event.  Fire the internal `cb` with the error status.\nfunction imageOnLoad(success, evt, failCount) {\n\tif (success && !this.width) {\n\t\t// Some browsers fire the load event before the image width is\n\t\t// available.  Wait up to 3 frames for the width.  Note that an image\n\t\t// with zero-width will be considered an error.\n\t\tif (failCount <= 3) {\n\t\t\tsetTimeout(bind(this, imageOnLoad, success, evt, (failCount || 0) + 1), 0);\n\t\t} else {\n\t\t\tthis.__cb.fire(false);\n\t\t}\n\t} else {\n\t\tthis.__cb.fire(!success);\n\t}\n}\n\n/**\n * This class models the region of a larger image that this \"Image\" references.\n */\n\nvar ImageMap = !GLOBAL.CONFIG.disableNativeViews && GLOBAL.NATIVE && GLOBAL.NATIVE.timestep && GLOBAL.NATIVE.timestep.ImageMap;\n\nif (!ImageMap) {\nImageMap=__class__;\tImageMap=ImageMap(function ImageMap(){return this.init&&this.init.apply(this,arguments)},function () {\n\t\tthis.init = function (parentImage, x, y, width, height, marginTop, marginRight, marginBottom, marginLeft, url) {\n\t\t\tthis.url = url;\n\t\t\tthis.x = x;\n\t\t\tthis.y = y;\n\t\t\tthis.width = width;\n\t\t\tthis.height = height;\n\t\t\tthis.marginTop = marginTop;\n\t\t\tthis.marginRight = marginRight;\n\t\t\tthis.marginBottom = marginBottom;\n\t\t\tthis.marginLeft = marginLeft;\n\t\t}\n\t});\n}\n\nvar sdk_timestep_ui_resource_Image=__class__;exports=sdk_timestep_ui_resource_Image(function sdk_timestep_ui_resource_Image(){return this.init&&this.init.apply(this,arguments)},lib.PubSub, function () {\n\tthis.init = function (opts) {\n\t\tif (!opts) { opts = {}; }\n\n\t\tthis._cb = new Callback();\n\t\tthis._map = new ImageMap(this, 0, 0, -1, -1, 0, 0, 0, 0, opts.url || '');\n\n\t\tthis._originalURL = opts.url;\n\n\t\tresourceLoader._updateImageMap(this._map, opts.url, opts.sourceX, opts.sourceY, opts.sourceW, opts.sourceH);\n\n\t\tthis._scale = opts.scale;\n\n\t\t// srcImage can be null, then setSrcImg will create one\n\t\t// (use the map's URL in case it was updated to a spritesheet)\n\t\tthis._setSrcImg(opts.srcImage, this._map.url, opts.forceReload);\n\t};\n\n\tthis._setSrcImg = function (img, url, forceReload) {\n\t\tthis._cb.reset();\n\n\t\t// if we haven't found an image, look in the image cache\n\t\tif (!img && url && !forceReload && ImageCache[url]) {\n\t\t\timg = ImageCache[url];\n\t\t}\n\n\t\t// look up the base64 cache -- if it's been preloaded, we'll get back an image that's already loaded\n\t\t// if it has not been preloaded, we'll get back raw base64 in the b64 variable\n\t\tif (!img && !forceReload && Image.get) {\n\t\t\tvar b64 = Image.get(url);\n\t\t\tif (typeof b64 == 'object') {\n\t\t\t\timg = b64;\n\t\t\t} else if (b64) {\n\t\t\t\turl = b64;\n\t\t\t}\n\t\t}\n\n\t\tif (forceReload) {\n\t\t\t// clear native texture in an image object\n\t\t\tif (img && img.destroy) {\n\t\t\t\timg.destroy();\n\t\t\t}\n\n\t\t\t// clear native textures by URL\n\t\t\tif (url && NATIVE && NATIVE.gl && NATIVE.gl.deleteTexture) {\n\t\t\t\tNATIVE.gl.deleteTexture(url);\n\t\t\t}\n\t\t}\n\n\t\t// create an image if we don't have one\n\t\tif (!img) {\n\t\t\timg = new Image();\n\t\t}\n\n\t\tthis._srcImg = img;\n\n\t\tif (img instanceof HTMLCanvasElement) {\n\t\t\tthis._onLoad(false); // no error\n\t\t} else {\n\t\t\t// if it's already loaded, we call _onLoad immediately. Note that\n\t\t\t// we don't use `.complete` here intentionally since web browsers\n\t\t\t// set `.complete = true` before firing on the load/error\n\t\t\t// callbacks, so we can't actually detect whether there's an error\n\t\t\t// in some cases.\n\n\t\t\tif (!img.__cb) {\n\t\t\t\timg.__cb = new Callback();\n\t\t\t\timg.addEventListener('load', bind(img, imageOnLoad, true), false);\n\t\t\t\timg.addEventListener('error', bind(img, imageOnLoad, false), false);\n\n\t\t\t\tif (url) { ImageCache[url] = img; }\n\t\t\t\tif (!img.src && url) {\n\t\t\t\t\timg.src = this._map.url = url;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\timg.__cb.run(this, '_onLoad');\n\t\t}\n\t};\n\n\tthis.setSource = this.setSrcImg = function (srcImg) {\n\t\tthis._setSrcImg(srcImg);\n\t};\n\n\tthis.reload = function (cb) {\n\t\tif (this._srcImg) {\n\n\t\t\t// if passed a lib.Callback, chain it\n\t\t\tif (cb && cb.chain) {\n\t\t\t\tcb = cb.chain();\n\t\t\t}\n\n\t\t\t// GC native has a reload method to force reload\n\t\t\tif (this._srcImg.reload) {\n\t\t\t\tvar onReload = bind(this, function () {\n\t\t\t\t\tthis._srcImg.removeEventListener('reload', onReload, false);\n\t\t\t\t\tcb && cb();\n\t\t\t\t});\n\n\t\t\t\tthis._srcImg.addEventListener('reload', onReload, false);\n\t\t\t\tthis._srcImg.reload();\n\t\t\t} else if (cb) {\n\t\t\t\tif (this._cb.fired()) {\n\t\t\t\t\t// always wait a frame before calling the callback\n\t\t\t\t\tsetTimeout(cb, 0);\n\t\t\t\t} else {\n\t\t\t\t\tthis._cb.run(cb);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.setURL = function (url, forceReload) {\n\t\tresourceLoader._updateImageMap(this._map, url);\n\t\tthis._setSrcImg(null, this._map.url, forceReload);\n\t};\n\n\tthis.getURL = function () { return this._map.url; };\n\tthis.getOriginalURL = function () { return this._originalURL; }\n\n\tthis.getSourceWidth = this.getOrigWidth = this.getOrigW = function () { return this._srcImg.width; };\n\tthis.getSourceHeight = this.getOrigHeight = this.getOrigH = function () { return this._srcImg.height; };\n\n\tthis.setSourceWidth = this.setSourceW = function (w) { this._map.width = w; };\n\tthis.setSourceHeight = this.setSourceH = function (h) { this._map.height = h; };\n\tthis.setSourceY = this.setSourceY = function (y) { this._map.y = y; };\n\tthis.setSourceX = this.setSourceX = function (x) { this._map.x = x; };\n\n\tthis.setMarginTop = function (n) { this._map.marginTop = n; };\n\tthis.setMarginRight = function (n) { this._map.marginRight = n; };\n\tthis.setMarginBottom = function (n) { this._map.marginBottom = n; };\n\tthis.setMarginLeft = function (n) { this._map.marginLeft = n; };\n\n\tthis.getURL = function () { return this._map.url; }\n\n\t/* @deprecated */\n\tthis.getSourceWidth = this.getOrigWidth = this.getOrigW = function () { return this._srcImg.width; }\n\t/* @deprecated */\n\tthis.getSourceHeight = this.getOrigHeight = this.getOrigH = function () { return this._srcImg.height; }\n\t/* @deprecated */\n\tthis.setSourceWidth = this.setSourceW = function (w) { this._map.width = w; }\n\t/* @deprecated */\n\tthis.setSourceHeight = this.setSourceH = function (h) { this._map.height = h; }\n\t/* @deprecated */\n\tthis.setSourceY = this.setSourceY = function (y) { this._map.y = y; }\n\t/* @deprecated */\n\tthis.setSourceX = this.setSourceX = function (x) { this._map.x = x; }\n\t/* @deprecated */\n\tthis.setMarginTop = function (n) { this._map.marginTop = n; }\n\t/* @deprecated */\n\tthis.setMarginRight = function (n) { this._map.marginRight = n; }\n\t/* @deprecated */\n\tthis.setMarginBottom = function (n) { this._map.marginBottom = n; }\n\t/* @deprecated */\n\tthis.setMarginLeft = function (n) { this._map.marginLeft = n; }\n\t\n\tthis.getSource = function () {\n\t\treturn this._srcImg;\n\t};\n\n\tthis.getWidth = function () {\n\t\treturn (this._map.width == -1\n\t\t\t? 0\n\t\t\t: this._map.width + this._map.marginLeft + this._map.marginRight) / this._map.scale;\n\t};\n\n\tthis.getHeight = function () {\n\t\treturn (this._map.height == -1 ? 0 :\n\t\t\t\t\t\t\t   this._map.height + this._map.marginTop + this._map.marginBottom) / this._map.scale;\n\t};\n\n\tthis.getMap =\n\tthis.getBounds = function () { return this._map; };\n\tthis.setBounds = function (x, y, w, h, marginTop, marginRight, marginBottom, marginLeft) {\n\t\tvar map = this._map;\n\t\tmap.x = x;\n\t\tmap.y = y;\n\t\tmap.width = w;\n\t\tmap.height = h;\n\t\tmap.marginTop = marginTop || 0;\n\t\tmap.marginRight = marginRight || 0;\n\t\tmap.marginBottom = marginBottom || 0;\n\t\tmap.marginLeft = marginLeft || 0;\n\t};\n\n\t/* @deprecated */\n\tthis.setBounds = this.setMap;\n\t\n\t// register a callback for onload\n\tthis.doOnLoad = function () { this._cb.forward(arguments); return this; };\n\n\t// internal onload handler for actual Image object\n\tthis._onLoad = function (err) {\n\t\tif (err) {\n\t\t\t// TODO: something better?\n\t\t\tlogger.error('Image failed to load:', this._map.url);\n\t\t\tthis._isError = true;\n\t\t\tthis._cb.fire({NoImage: true});\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._srcImg.width == 0) { logger.warn('Image has no width', this._url); }\n\n\t\tvar map = this._map;\n\t\tif (this._scale && (map.width != -1 || map.height != -1)) {\n\t\t\t// requested scale & provided a width or height\n\t\t\tif (map.width == -1) {\n\t\t\t\t// by the above check, this._sourceH should not be -1\n\t\t\t\tmap.width = this._srcImg.width * map.height / this._srcImg.height;\n\t\t\t}\n\n\t\t\tif (map.height == -1) {\n\t\t\t\t// this._sourceW was initialized above\n\t\t\t\tmap.height = this._srcImg.height * map.width / this._srcImg.width;\n\t\t\t}\n\n\t\t\t// TODO: sourceImage might be shared so we can't actually modify width/height.  This is a bug.\n\t\t\tthis._srcImg.width = map.width;\n\t\t\tthis._srcImg.height = map.height;\n\t\t} else {\n\t\t\tif (map.width == -1) { map.width = this._srcImg.width; }\n\t\t\tif (map.height == -1) { map.height = this._srcImg.height; }\n\t\t}\n\n\t\tthis._map.url = this._srcImg.src;\n\n\t\tthis._cb.fire(null, this);\n\t};\n\n\tthis.isError = function () { return this._isError; }\n\tthis.isLoaded =\n\tthis.isReady = function () { return !this._isError && this._cb.fired(); };\n\n\tvar isNative = GLOBAL.NATIVE && !device.simulatingMobileNative;\n\tvar SLICE = Array.prototype.slice;\n\tif (!isNative) {\n\t\tvar Canvas = device.get('Canvas');\n\t\tvar _filterCanvas = new Canvas();\n\t\tvar _filterCtx = _filterCanvas.getContext('2d');\n\t};\n\n\tthis.render = function (ctx, destX, destY, destW, destH) {\n\t\tif (!this._cb.fired()) { return; }\n\n\t\ttry {\n\t\t\tvar args = arguments;\n\t\t\tvar map = this._map;\n\t\t\tvar scaleX;\n\t\t\tvar scaleY;\n\n\t\t\tif (!(ctx.filters && (ctx.filters.Multiply || ctx.filters.NegativeMask || ctx.filters.PositiveMask))) {\n\t\t\t\tif (args.length == 9) {\n\t\t\t\t\tctx.drawImage(this._srcImg, args[1], args[2], args[3], args[4], args[5], args[6], args[7], args[8]);\n\t\t\t\t} else if (destX instanceof Rect) {\n\t\t\t\t\tif (destY instanceof Rect) {\n\t\t\t\t\t\tvar srcRect = destX;\n\t\t\t\t\t\tvar destRect = destY;\n\t\t\t\t\t\tscaleX = destRect.width / (map.marginLeft + map.width + map.marginRight);\n\t\t\t\t\t\tscaleY = destRect.height / (map.marginTop + map.height + map.marginBottom);\n\t\t\t\t\t\tctx.drawImage(this._srcImg,\n\t\t\t\t\t\t\tsrcRect.x, srcRect.y, srcRect.width, srcRect.height,\n\t\t\t\t\t\t\tdestRect.x, destRect.y, destRect.width, destRect.height);\n\n\t\t\t\t\t} else {\n\t\t\t\t\t\tvar destRect = destX;\n\t\t\t\t\t\tscaleX = destRect.width / (map.marginLeft + map.width + map.marginRight);\n\t\t\t\t\t\tscaleY = destRect.height / (map.marginTop + map.height + map.marginBottom);\n\t\t\t\t\t\tctx.drawImage(this._srcImg,\n\t\t\t\t\t\t\t\t\t  map.x, map.y, map.width, map.height,\n\t\t\t\t\t\t\t\t\t  destRect.x + scaleX * map.marginLeft,\n\t\t\t\t\t\t\t\t\t  destRect.y + scaleY * map.marginTop,\n\t\t\t\t\t\t\t\t\t  scaleX * map.width,\n\t\t\t\t\t\t\t\t\t  scaleY * map.height);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tscaleX = destW / (map.marginLeft + map.width + map.marginRight);\n\t\t\t\t\tscaleY = destH / (map.marginTop + map.height + map.marginBottom);\n\n\t\t\t\t\tif (scaleX != Infinity && scaleY != Infinity) {\n\t\t\t\t\t\tctx.drawImage(this._srcImg,\n\t\t\t\t\t\t\t\t\t  map.x, map.y, map.width, map.height,\n\t\t\t\t\t\t\t\t\t  (destX || 0) + scaleX * map.marginLeft,\n\t\t\t\t\t\t\t\t\t  (destY || 0) + scaleY * map.marginTop,\n\t\t\t\t\t\t\t\t\t  scaleX * map.width,\n\t\t\t\t\t\t\t\t\t  scaleY * map.height);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tvar renderArgs = arguments, img = this;\n\n\t\t\tfunction applyOperation(color, op1, op2) {\n\t\t\t\t_filterCanvas.width = destW;\n\t\t\t\t_filterCanvas.height = destH;\n\t\t\t\t_filterCtx.globalCompositeOperation = 'source-over';\n\t\t\t\timg.render.apply(img, [_filterCtx].concat(SLICE.call(renderArgs, 1)));\n\n\t\t\t\t_filterCtx.globalCompositeOperation = op1;\n\t\t\t\t_filterCtx.fillStyle = \"rgba(\" + color.r  + \",\" + color.g + \",\" + color.b + \",\" + color.a + \")\";\n\t\t\t\t_filterCtx.fillRect(destX || 0, destY || 0, destW || map.width, destH || map.height);\n\n\t\t\t\tvar oldCompositeOperation = ctx.globalCompositeOperation;\n\t\t\t\tctx.globalCompositeOperation = op2;\n\t\t\t\tctx.drawImage(_filterCanvas, destX || 0, destY || 0, destW || map.width, destH || map.height);\n\t\t\t\tctx.globalCompositeOperation = oldCompositeOperation;\n\t\t\t}\n\n\t\t\t// Rendering engine flags.\n\t\t\tvar isWebkit = /WebKit/.exec(navigator.appVersion);\n\t\t\tif (!isNative && ctx.filters) {\n\n\t\t\t\tif (ctx.filters.LinearAdd) {\n\t\t\t\t\tvar f = ctx.filters.LinearAdd.get();\n\t\t\t\t\tapplyOperation(f, 'source-in', 'lighter');\n\t\t\t\t}\n\n\t\t\t\tif (ctx.filters.Tint) {\n\t\t\t\t\tvar f = ctx.filters.Tint.get();\n\t\t\t\t\tvar color = {r: f.r, g: f.g, b: f.b, a: f.a};\n\t\t\t\t\tapplyOperation(color, 'source-in', 'source-over');\n\t\t\t\t}\n\n\t\t\t\tif (ctx.filters.Multiply) {\n\t\t\t\t\tvar f = ctx.filters.Multiply.get();\n\t\t\t\t\tvar imgData = this.getImageData();\n\t\t\t\t\tvar data = imgData.data;\n\t\t\t\t\t\n\t\t\t\t\tfor (var i = 0; i < data.length; i+=4) {\n\t\t\t\t\t\tdata[i] *= (f.r / 255);\n\t\t\t\t\t\tdata[i + 1] *= (f.g / 255); \n\t\t\t\t\t\tdata[i + 2] *= (f.b / 255); \n\t\t\t\t\t}\n\n\t\t\t\t\t_filterCanvas.width = imgData.width;\n\t\t\t\t\t_filterCanvas.height = imgData.height;\n\t\t\t\t\t_filterCtx.putImageData(imgData, 0, 0);\n\t\t\t\t\tctx.drawImage(_filterCanvas, destX || 0, destY || 0, destW || map.width, destH || map.height);\n\n\t\t\t\t}\n\n\t\t\t\tif (ctx.filters.NegativeMask) {\n\t\t\t\t\tvar f = ctx.filters.NegativeMask.get();\n\t\t\t\t\t_filterCanvas.width = destW;\n\t\t\t\t\t_filterCanvas.height = destH;\n\t\t\t\t\t_filterCtx.globalCompositeOperation = 'source-over';\n\t\t\t\t\tf.imgObject.render.apply(f.imgObject, [_filterCtx].concat(SLICE.call(renderArgs, 1)));\n\n\t\t\t\t\t_filterCtx.globalCompositeOperation = 'source-in';\n\t\t\t\t\timg.render.apply(img, [_filterCtx].concat(SLICE.call(renderArgs, 1)));\n\n\t\t\t\t\tvar oldCompositeOperation = ctx.globalCompositeOperation;\n\t\t\t\t\tctx.globalCompositeOperation = 'source-over';\n\t\t\t\t\tctx.drawImage(_filterCanvas, destX || 0, destY || 0, destW || map.width, destH || map.height);\n\t\t\t\t\tctx.globalCompositeOperation = oldCompositeOperation;\n\t\t\t\t}\n\n\t\t\t\tif (ctx.filters.PositiveMask) {\n\t\t\t\t\tvar f = ctx.filters.PositiveMask.get();\n\t\t\t\t\t_filterCanvas.width = destW;\n\t\t\t\t\t_filterCanvas.height = destH;\n\t\t\t\t\t_filterCtx.globalCompositeOperation = 'source-over';\n\t\t\t\t\tf.imgObject.render.apply(f.imgObject, [_filterCtx].concat(SLICE.call(renderArgs, 1)));\n\n\t\t\t\t\t_filterCtx.globalCompositeOperation = 'source-out';\n\t\t\t\t\timg.render.apply(img, [_filterCtx].concat(SLICE.call(renderArgs, 1)));\n\n\t\t\t\t\tvar oldCompositeOperation = ctx.globalCompositeOperation;\n\t\t\t\t\tctx.globalCompositeOperation = 'source-over';\n\t\t\t\t\tctx.drawImage(_filterCanvas, destX || 0, destY || 0, destW || map.width, destH || map.height);\n\t\t\t\t\tctx.globalCompositeOperation = oldCompositeOperation;\n\t\t\t\t}\n\t\t\t}\n\t\t} catch(e) {}\n\t};\n\n\tthis.getImageData = function () {\n\t\tif (!GLOBAL.document || !document.createElement) { throw 'Not supported'; }\n\t\tif (!this._map.width || !this._map.height) { throw 'Not loaded'; }\n\n\t\tvar canvas = document.createElement('canvas');\n\t\tcanvas.width = this._map.width;\n\t\tcanvas.height = this._map.height;\n\t\tvar ctx = canvas.getContext('2d');\n\n\t\tthis.render(ctx, 0, 0, this._map.width, this._map.height);\n\n\t\tvar imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\n\n\t\treturn imageData;\n\t};\n\n\tthis.setImageData = function (data) { };\n\n\tthis.destroy = function () {\n\t\tthis._srcImg.destroy && this._srcImg.destroy();\n\t};\n});\n\nexports.__clearCache__ = function () {\n\tImageCache = {};\n};\n","pre":true},"sdk/timestep/event/Callback.js":{"path":"sdk/timestep/event/Callback.js","friendlyPath":"event.Callback","directory":"sdk/timestep/event/","filename":"Callback.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @class event.Callback;\n * Namespace shim to bring in Callback from jsio.\n *\n * @doc http://doc.gameclosure.com/api/event.html#class-event.callback\n * @docsrc https://github.com/gameclosure/doc/blob/master/api/event.md\n */\n\njsio(\"import lib.Callback as exports\");\n","pre":true},"sdk/timestep/ui/resource/loader.js":{"path":"sdk/timestep/ui/resource/loader.js","friendlyPath":"ui.resource.loader","directory":"sdk/timestep/ui/resource/","filename":"loader.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\njsio(\"import lib.Callback\");\n\nvar _cache = {};\n\nvar MIME = {\n\t'.png': 'image',\n\t'.jpg': 'image',\n\t'.bmp': 'image',\n\t'.css': 'css',\n\t'.html': 'html',\n\t'.mp3': 'audio',\n\t'.ogg': 'audio',\n\t'.mp4': 'audio',\n\t'.3gp': 'audio',\n\t'.m4a': 'audio',\n\t'.aac': 'audio',\n\t'.flac': 'audio',\n\t'.mkv': 'audio',\n\t'.wav': 'audio'\n};\n\nLoader=__class__;var Loader=Loader(function Loader(){return this.init&&this.init.apply(this,arguments)},function () {\n\tthis._map = {};\n\n\tthis.getMap = function () { return this._map; }\n\tthis.setMap = function (map) { \n\t\tvar localizedMap = {};\n\t\t// For any resource staring with resource-local/ change the path to be resources/\n\t\t// This allows localized resources to be loaded the same way for all languages\n\t\tvar language = navigator.language && navigator.language.split('-')[0].toLowerCase() || 'en';\n\t\tvar localResources = 'resources-' + language;\n\t\tvar shortLocalResources = 'resources-' + language.split('_')[0];\n\t\tfor (var key in map) {\n\t\t\tvar localLoc = key.indexOf(localResources);\n\t\t\tvar shortLocalLoc = key.indexOf(shortLocalResources);\n\t\t\t// Favor an exact match of the local and then try to match the short local\n\t\t\tif (localLoc == 0) {\n\t\t\t\tvar modifiedPath = 'resources' + key.substring(localResources.length);\n\t\t\t\tlocalizedMap[modifiedPath] = map[key];\n\t\t\t} else if (shortLocalLoc == 0) {\n\t\t\t\tvar modifiedPath = 'resources' + key.substring(shortLocalResources.length);\n\t\t\t\tlocalizedMap[modifiedPath] = map[key];\n\t\t\t}else {\n\t\t\t\tlocalizedMap[key] = map[key];\n\t\t\t}\n\t\t}\n\t\tthis._map = localizedMap; \n\t}\n\t\n\t// TODO: rename this function...\n\tthis.get = function (file) {\n\t\treturn 'resources/images/' + file;\n\t}\n\t\n\t/**\n\t * Preload a given resource or array of resources.\n\t * You can specify a folder name, or even a partial filename,\n\t * to preload all resources that begin with that prefix.\n\t * For instance, in a tree like so:\n\t * \n\t * resources\n\t * └── images\n     *     ├── boss\n     *     │   ├── enemy1.png\n\t *     │   └── enemy2.png\n     *     └── hero\n     *         ├── shield.png\n\t *         └── sword.png\n\t * \n\t * You could preload both enemy images in either of the following\n\t * ways:\n\t * \n\t *     ui.resource.loader.preload(\"resources/images/boss/\");\n\t *     ui.resource.loader.preload(\"resources/images/boss/enemy\");\n\t * \n\t * Pass an array of paths to preload all at once. The callback\n\t * will be called when all resources have finished loading.\n\t * \n\t * This works for both images and sounds.\n\t */\n\tthis.preload = function (pathPrefix, opts, cb) {\n\t\tif (typeof opts == 'function') {\n\t\t\tcb = opts;\n\t\t\topts = undefined;\n\t\t}\n\n\t\t// process an array of items, where cb is run at completion of the final one\n\t\tif (isArray(pathPrefix)) {\n\t\t\tvar chainCb = new lib.Callback();\n\t\t\tpathPrefix.forEach(function (prefix) {\n\t\t\t\tif (prefix) {\n\t\t\t\t\tthis.preload(prefix, opts, chainCb.chain());\n\t\t\t\t}\n\t\t\t}, this);\n\t\t\tcb && chainCb.run(cb);\n\t\t\treturn chainCb;\n\t\t} else {\n\t\t\tpathPrefix = pathPrefix.replace(/^\\//, ''); // remove leading slash\n\t\t\t// if an item is found in the map, add that item's sheet to the group.\n\t\t\t// If there is no sheet in the map (i.e. for sounds), load that file directly.\n\t\t\tvar preloadSheets = {};\n\t\t\tvar map = this._map;\n\t\t\tfor (var uri in map) {\n\t\t\t\tif (uri.indexOf(pathPrefix) == 0) {\n\t\t\t\t\t// sprites have sheet; sounds are just by the filename key itself\n\t\t\t\t\tpreloadSheets[map[uri] && map[uri].sheet || uri] = true;\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\tvar files = Object.keys(preloadSheets);\n\n\t\t\tvar callback = this._loadGroup(merge({resources: files}, opts));\n\t\t\tcb && callback.run(cb);\n\t\t\treturn callback;\n\t\t}\n\t};\n\n\tvar soundLoader = null;\n\tthis.getSound = function (src) {\n\t\tif (!soundLoader) {\n\t\t\tjsio(\"import AudioManager\");\n\t\t\tsoundLoader = new AudioManager();\n\t\t}\n\n\t\tif (GLOBAL.NATIVE && GLOBAL.NATIVE.sound && GLOBAL.NATIVE.sound.preloadSound) {\n\t\t\treturn NATIVE.sound.preloadSound(src);\n\t\t} else {\n\t\t\tsoundLoader.addSound(src);\n\t\t\t//HACK to make the preloader continue in the browser\n\t\t\treturn { complete: true };\n\t\t}\n\t}\n\n\tthis.getImagePaths = function (prefix) {\n\t\tprefix = prefix.replace(/^\\//, ''); // remove leading slash\n\t\tvar images = [];\n\t\tvar map = this._map;\n\t\tfor (var uri in map) {\n\t\t\tif (uri.indexOf(prefix) == 0) {\n\t\t\t\timages.push(uri);\n\t\t\t}\n\t\t}\n\t\treturn images;\n\t}\n\n\tthis.getImage = function (src, noWarn) {\n\t\t// create the image\n\t\tvar img = new Image();\n\t\t\n\t\t// find the base64 image if it exists\n\t\tif (Image.get) {\n\t\t\tvar b64 = Image.get(src);\n\t\t\tif (b64 instanceof Image) { \n\t\t\t\treturn b64;\n\t\t\t}\n\t\t}\n\t\t\n\t\tif (b64) {\n\t\t\timg.src = b64;\n\t\t\tImage.set(src, img);\n\t\t} else {\n\t\t\tif (!noWarn) { logger.warn(src, 'may not be properly cached!'); }\n\t\t\timg.src = src;\n\t\t}\n\n\t\treturn img;\n\t}\n\n\t/** \n\t * used internally by timestep.Image to seamlessly convert\n\t * non-sprited image URLs to sprited images. This is here (rather\n\t * than in timestep.Image) to keep sprite formats in one consistent place. \n\t */\n\tthis._updateImageMap = function (map, url, x, y, w, h) {\n\n\t\tx = x || 0;\n\t\ty = y || 0;\n\t\tw = w == undefined ? -1 : w;\n\t\th = h == undefined ? -1 : h;\n\n\t\tvar info = this._map[url];\n\t\tif (!info || !info.sheet) {\n\t\t\tmap.x = x;\n\t\t\tmap.y = y;\n\t\t\tmap.width = w;\n\t\t\tmap.height = h;\n\t\t\tmap.scale = 1;\n\t\t\tmap.url = url;\n\t\t\treturn;\n\t\t}\n\n\t\tvar scale = info.scale || 1;\n\n\t\t// calculate the source rectangle, with margins added to the edges\n\t\t// (disregarding the fact that they may fall off the edge of the sheet)\n\t\tmap.x = info.x - info.marginLeft;\n\t\tmap.y = info.y - info.marginTop;\n\t\tmap.width = info.w + info.marginLeft + info.marginRight;\n\t\tmap.height = info.h + info.marginTop + info.marginBottom;\n\t\t\n\t\t// Add in any source map options passed in to get the actual offsets\n\t\tmap.x += x * scale;\n\t\tmap.y += y * scale;\n\t\tif (w > 0) {\n\t\t\tmap.width = w * scale;\n\t\t}\n\t\tif (h > 0) {\n\t\t\tmap.height = h * scale;\n\t\t}\n\t\t\n\t\t// now updatea the margins to account for the new source map\n\t\tmap.marginLeft = Math.max(0, info.x - map.x);\n\t\tmap.marginTop = Math.max(0, info.y - map.y);\n\t\tmap.marginRight = Math.max(0, (map.x + map.width) - (info.x + info.w));\n\t\tmap.marginBottom = Math.max(0, (map.y + map.height) - (info.y + info.h));\n\t\t\n\t\t// and re-offset the source map to exclude margins\n\t\tmap.x += map.marginLeft;\n\t\tmap.y += map.marginTop;\n\t\tmap.width -= (map.marginLeft + map.marginRight);\n\t\tmap.height -= (map.marginTop + map.marginBottom);\n\t\t\n\t\t// the scale of the source image, if scaled in a spritesheet\n\t\tmap.scale = scale;\n\t\tmap.url = info.sheet;\n\n\t\treturn map;\n\t}\n\n\tthis._getRaw = function (type, src, copy, noWarn) {\n\t\t// always return the cached copy unless specifically requested not to\n\t\tif (!copy && _cache[src]) { return _cache[src]; }\n\t\tvar res = null;\n\t\tswitch (type) {\n\t\t\tcase 'audio':\n\t\t\t\tres = this.getSound(src);\n\t\t\t\tbreak;\n\t\t\tcase 'image':\n\t\t\t\tres = this.getImage(src, noWarn);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tlogger.error('unknown type for preloader', type);\n\t\t}\n\t\treturn (_cache[src] = res);\n\t}\n\n\t// The callback is called for each image in the group with the image\n\t// source that loaded and whether there was an error.\n\t// \n\t// function callback(lastSrc, error, isComplete, numCompleted, numTotal)\n\t//    where error is true or false and isComplete is true when numCompleted == numTotal\n\t//\n\tthis._loadGroup = function (opts, cb) {\n\t\tvar timeout = opts.timeout;\n\t\tvar callback = new lib.Callback();\n\t\t\n\t\t// compute a list of images using file extensions\n\t\tvar resources = opts.resources || [];\n\t\tvar n = resources.length || 0;\n\t\tvar loadableResources = [];\n\t\tfor (var i = 0; i < n; ++i) {\n\t\t\tvar ext = resources[i].substring(resources[i].lastIndexOf('.')).split('|')[0];\n\t\t\tif (MIME[ext] == 'image') {\n\t\t\t\tloadableResources.push({type:'image', resource: resources[i]});\n\t\t\t\tGLOBAL.NATIVE && NATIVE.gl && NATIVE.gl.touchTexture(resources[i]);\n\t\t\t} else if (MIME[ext] == 'audio') {\n\t\t\t\tloadableResources.push({type:'audio', resource: resources[i]});\n\t\t\t}\n\t\t}\n\n\t\t// If no resources were loadable,\n\t\tif (!loadableResources.length) {\n\t\t\tcb && callback.run(cb);\n\t\t\tcallback.fire();\n\t\t\treturn callback;\n\t\t}\n\t\t\n\t\t// do the preload asynchronously (note that base64 is synchronous, only downloads are asynchronous)\n\t\tvar nextIndexToLoad = 0;\n\t\tvar numResources = loadableResources.length;\n\t\tvar parallel = Math.min(numResources, opts.parallel || 5); // how many should we try to download at a time?\n\t\tvar numLoaded = 0;\n\n\t\tvar loadResource = bind(this, function () {\n\t\t    var currentIndex = nextIndexToLoad++;\n\t\t\tvar src = loadableResources[currentIndex];\n\t\t\tvar res;\n\t\t\tif (src) {\n\t\t\t\tres = this._getRaw(src.type, src.resource, false, true);\n\t\t\t} else {\n\t\t\t\t// End of resource list, done!\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar next = function (failed) {\n\t\t\t\t// If already complete, stub this out\n\t\t\t\tif (numLoaded >= numResources) { return; }\n\n\t\t\t\t// Set stubs for the reload and load events so that code\n\t\t\t\t// elsewhere can blindly call these without causing problems.\n\t\t\t\t// An alternative would be to set these to null but not every\n\t\t\t\t// piece of code that uses this does the right checks.\n\t\t\t\tres.onreload = res.onload = res.onerror = function() {};\n\n\t\t\t\t// The number of loads (success or failure) has increased.\n\t\t\t\t++numLoaded;\n\n\t\t\t\t// If we have loaded all of the resources,\n\t\t\t\tif (numLoaded >= numResources) {\n\t\t\t\t\t// Call the progress callback with isComplete == true\n\t\t\t\t\tcb && cb(src, failed, true, numLoaded, numResources);\n\n\t\t\t\t\t// If a timeout was set, clear it\n\t\t\t\t\tif (_timeout) {\n\t\t\t\t\t\tclearTimeout(_timeout);\n\t\t\t\t\t}\n\n\t\t\t\t\t// Fire the completion callback chain\n\t\t\t\t\tcallback.fire();\n\t\t\t\t} else {\n\t\t\t\t\t// Call the progress callback with the current progress\n\t\t\t\t\tcb && cb(src, failed, false, numLoaded, numResources);\n\n\t\t\t\t\t// Restart on next image in list\n\t\t\t\t\tsetTimeout(loadResource, 0);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\t// IF this is the type of resource that has a reload method,\n\t\t\tif (res.reload && res.complete) {\n\t\t\t\t// Use the magic of closures to create a chain of onreload\n\t\t\t\t// completion callbacks.  This is really important because\n\t\t\t\t// we can be be preloading the same resource twice, and we can\n\t\t\t\t// also be simultaneously preloading two groups at once.\n\t\t\t\tvar prevOnLoad = res.onreload;\n\t\t\t\tvar prevOnError = res.onerror;\n\n\t\t\t\t// When the resource completes loading, either with success\n\t\t\t\t// or failure:\n\n\t\t\t\tres.onreload = function () {\n\t\t\t\t\t// If previous callback exists, run it first in a chain\n\t\t\t\t\tprevOnLoad && prevOnLoad();\n\n\t\t\t\t\t// React to successful load of this resource\n\t\t\t\t\tnext(false);\n\t\t\t\t};\n\n\t\t\t\tres.onerror = function () {\n\t\t\t\t\t// If previous callback exists, run it first in a chain\n\t\t\t\t\tprevOnError && prevOnError();\n\n\t\t\t\t\t// React to failed load of this resource\n\t\t\t\t\tnext(true);\n\t\t\t\t}\n\n\t\t\t\t// Start it reloading\n\t\t\t\tres.reload();\n\t\t\t} else if (res.complete) {\n\t\t\t\t// Since the resource has already completed loading, go\n\t\t\t\t// ahead and invoke the next callback indicating the previous\n\t\t\t\t// success or failure.\n\t\t\t\tnext(res.failed === true);\n\t\t\t} else {\n\t\t\t\t// The comments above about onreload callback chaining equally\n\t\t\t\t// apply here.  See above.\n\t\t\t\tvar prevOnLoad = res.onload;\n\t\t\t\tvar prevOnError = res.onerror;\n\n\t\t\t\t// When the resource completes loading, either with success\n\t\t\t\t// or failure:\n\n\t\t\t\tres.onload = function () {\n\t\t\t\t\t// If previous callback exists, run it first in a chain\n\t\t\t\t\tprevOnLoad && prevOnLoad();\n\n\t\t\t\t\t// Reset fail flag\n\t\t\t\t\tres.failed = false;\n\n\t\t\t\t\t// React to successful load of this resource\n\t\t\t\t\tnext(false);\n\t\t\t\t};\n\n\t\t\t\tres.onerror = function () {\n\t\t\t\t\t// If previous callback exists, run it first in a chain\n\t\t\t\t\tprevOnError && prevOnError();\n\n\t\t\t\t\t// Set fail flag\n\t\t\t\t\tres.failed = true;\n\n\t\t\t\t\t// React to failed load of this resource\n\t\t\t\t\tnext(true);\n\t\t\t\t};\n\t\t\t}\n\t\t});\n\n\t\tvar _timeout = null;\n\t\tsetTimeout(function () {\n\t\t\t// spin up n simultaneous loaders!\n\t\t\tfor (var i = 0; i < parallel; ++i) { loadResource(); }\n\t\t\t\n\t\t\t// register timeout call\n\t\t\tif (timeout) {\n\t\t\t\t_timeout = setTimeout(function () {\n\t\t\t\t\tcallback.fire();\n\t\t\t\t\tnumLoaded = numResources;\n\t\t\t\t}, timeout)\n\t\t\t}\n\t\t}, 0);\n\t\t\n\t\treturn callback;\n\t}\n});\n\nexports = new Loader();\n","pre":true},"sdk/timestep/AudioManager.js":{"path":"sdk/timestep/AudioManager.js","friendlyPath":"AudioManager","directory":"sdk/timestep/","filename":"AudioManager.js","baseMod":"AudioManager","basePath":"sdk/timestep/","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @class Sound;\n * Implement the correct Audio support, depending on what platform we're running.\n *\n * @doc http://doc.gameclosure.com/api/sound.html\n * @docsrc https://github.com/gameclosure/doc/blob/master/api/sound.md\n */\n\njsio(\"import device\");\njsio(\"import event.Emitter as Emitter\");\n\n// Allow accessibility controls (like muting).\n// TODO This should definitely be in another file.\nGLOBAL.ACCESSIBILITY = new (Class(Emitter, function (supr) {\n\tthis.muted = false;\n\n\tthis.mute = function (flag) {\n\t\tthis.muted = flag;\n\t\tthis.publish('MuteChange');\n\t};\n}));\nif (GLOBAL.ONACCESSIBLE) {\n\tGLOBAL.ONACCESSIBLE();\n}\n\n// Determine which API to include.\n// if (device.isMobileBrowser && !device.simulatingMobileBrowser) {\n// \timport platforms.browser.MobileBrowserAPI;\n// \texports = platforms.browser.MobileBrowserAPI;\n// } else {\nexports = jsio('import ui.backend.sound.HTML5API');\n// }\n","pre":true},"sdk/timestep/ui/backend/sound/HTML5API.js":{"path":"sdk/timestep/ui/backend/sound/HTML5API.js","friendlyPath":"ui.backend.sound.HTML5API","directory":"sdk/timestep/ui/backend/sound/","filename":"HTML5API.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n// An API for playing named sounds. Sounds can be given a single file source\n// or multiple sources which will be chosen at random at play time. Sounds may\n// also be given a default volume and loop boolean.\n//\n// Only one background sound can be played at a time. They are streamed, not\n// preloaded, on native.\n\njsio(\"import event.Emitter as Emitter\");\njsio(\"import util.path\");\njsio(\"import device\");\n\n// \"Extend\" the local instance of Audio objects.\nRawAudio=__class__;var RawAudio=RawAudio(function RawAudio(){return this.init&&this.init.apply(this,arguments)},function () {\n\tthis.init = function () {\n\t\tvar audio = new Audio();\n\n\t\t// we can't really extend an HTML5 audio object in a browser, so\n\t\t// do our best...\n\t\tvar proto = RawAudio.prototype;\n\t\tfor (var i in proto) {\n\t\t\tif (!audio[i] && proto.hasOwnProperty(i)) {\n\t\t\t\taudio[i] = RawAudio.prototype[i];\n\t\t\t}\n\t\t}\n\n\t\taudio.oldPlay = audio.play;\n\t\taudio.play = function() {\n\t\t\tif (audio.readyState == 4) {\n\t\t\t\taudio.oldPlay();\n\t\t\t} else {\n\t\t\t\tsetTimeout(audio.play, 32);\n\t\t\t}\n\t\t};\n\n\t\t// Hook into accessibility features.\n\t\tGLOBAL.ACCESSIBILITY.subscribe('MuteChange', this, function () {\n\t\t\taudio.muted = GLOBAL.ACCESSIBILITY.muted;\n\t\t});\n\n\t\taudio.muted = GLOBAL.ACCESSIBILITY.muted;\n\n\t\treturn audio;\n\t};\n\n\t// add a stop method that resets the current time\n\tthis.stop = function () {\n\t\ttry {\n\t\t\t// html5 Audio object\n\t\t\tif (!this.paused) { this.pause(); }\n\n\t\t\t// if we have the NETWORK_LOADING flag, only restart currentTime if the sound has loaded.\n\t\t\t// http://scottdowne.wordpress.com/2010/08/17/no-more-exceptions/\n\t\t\tif ((!('NETWORK_LOADING' in this)\n\t\t\t\t\t|| this.networkState != this.NETWORK_LOADING\n\t\t\t\t\t|| this.networkState != this.NETWORK_NO_SOURCE)\n\t\t\t\t\t&& !isNaN(this.duration)) {\n\t\t\t\tthis.currentTime = 0;\n\t\t\t}\n\t\t} catch (e) {}\n\t};\n});\n\n/**\n * A sound object that can play one of a collection of audio sources.\n */\nMultiSound=__class__;var MultiSound=MultiSound(function MultiSound(){return this.init&&this.init.apply(this,arguments)},function () {\n\tthis.init = function (soundManager, name, opts) {\n\t\tthis._soundManager = soundManager;\n\t\tthis._name = name;\n\n\t\t// if a list of file names is given in sources, load them as alternative\n\t\t// clips for this sound. Else, assume the only clip for this sound\n\t\t// is the file with its same name\n\t\topts = typeof opts == 'string' ? {sources: [opts]} : (opts || {});\n\t\tvar srcList = opts.sources || [name];\n\t\tvar sources = this._sources = [];\n\n\t\tvar basePath = soundManager.getPath();\n\t\tvar ext = soundManager.getExt();\n\t\tvar extTestExp = new RegExp(ext + '$', 'i');\n\n\t\tvar loop = opts.loop !== undefined ? opts.loop : opts.background;\n\t\tvar volume = opts.volume !== undefined ? opts.volume : 1.0;\n\n\t\tvar isPaused = bind(this, 'isPaused');\n\n\t\t// html5 hack for web browsers\n\t\tvar _checkPauseOnPlay = function (src) {\n\t\t\t\tthis.removeEventListener(arguments.callee);\n\t\t\t\tif (isPaused()) {\n\t\t\t\t\tthis.pause();\n\t\t\t\t}\n\t\t\t};\n\n\t\tfor (var i = 0, src; src = srcList[i]; ++i) {\n\n\t\t\t// file paths are relative to the base path\n\t\t\tvar fullPath = util.path.join(basePath, opts.path, src);\n\n\t\t\t// append the extension if not already provided\n\t\t\tif (!extTestExp.test(fullPath)) {\n\t\t\t\tfullPath += ext;\n\t\t\t}\n\n\t\t\tvar audio = new RawAudio();\n\t\t\taudio.loop = loop;\n\t\t\taudio.volume = volume;\n\t\t\taudio.isBackgroundMusic = opts.background;\n\t\t\taudio.src = fullPath;\n\t\t\taudio.preload = ((audio.readyState != 4) || (soundManager._preload && !opts.background)) ? \"auto\" : \"none\";\n\n\t\t\t// If you pause or mute an html5 audio object in the browser\n\t\t\t// before the sound is ready, it will play anyway.  Here, we\n\t\t\t// check the pause status when the audio starts playing.\n\t\t\tif (audio.addEventListener) {\n\t\t\t\taudio.addEventListener('playing', _checkPauseOnPlay);\n\t\t\t}\n\n\t\t\tsources.push(audio);\n\t\t\tif (audio.isBackgroundMusic && window.NATIVE) {\n\t\t\t\tNATIVE.sound.registerMusic(fullPath, audio);\n\t\t\t}\n\t\t}\n\n\t\tthis.loop = loop;\n\t\tthis.isBackgroundMusic = opts.background;\n\t};\n\n\tthis.setVolume = function (volume) {\n\t\tfor (var i = 0, src; src = this._sources[i]; ++i) {\n\t\t\tsrc.volume = volume;\n\t\t}\n\t};\n\n\tthis.stop = function () {\n\t\tfor (var i = 0, src; src = this._sources[i]; ++i) {\n\t\t\tsrc.stop();\n\t\t}\n\t};\n\n\tthis.pause = function () {\n\t\tthis._isPaused = true;\n\n\t\tfor (var i = 0, src; src = this._sources[i]; ++i) {\n\t\t\tsrc.pause();\n\t\t}\n\t};\n\n\tthis.isPaused = function () {\n\t\treturn this._isPaused;\n\t};\n\n\tthis.isPlaying = function () {\n\t\tvar isPlaying = false;\n\t\tif (this._lastSrc) {\n\t\t\tvar cur = this._lastSrc.currentTime;\n\t\t\tvar dur = this._lastSrc.duration;\n\t\t\t// NaN duration means the duration isn't loaded yet,\n\t\t\t// meaning the sound was started very recently. Since\n\t\t\t// this._lastSrc is defined, we know that the sound has\n\t\t\t// been played, so it's playing unless it's paused :)\n\t\t\tif (isNaN(dur) || cur < dur) {\n\t\t\t\tisPlaying = !this.isPaused();\n\t\t\t}\n\t\t}\n\t\treturn isPlaying;\n\t};\n\n\tthis.getDuration = function () {\n\t\treturn this._lastSrc && this._lastSrc.duration || 0;\n\t};\n\n\tthis.getTime = function () {\n\t\treturn this._lastSrc ? this._lastSrc.currentTime : 0;\n\t};\n\n\tthis.setTime = function (t) {\n\t\tif (this._lastSrc && this.isBackgroundMusic && t != undefined) {\n\t\t\tif (this._lastSrc.duration) {\n\t\t\t\tthis._lastSrc.currentTime = t;\n\t\t\t} else {\n\t\t\t\tsetTimeout(bind(this, 'setTime', t + 0.01), 10);\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.play = function (opts) {\n\t\topts = opts || {};\n\t\tif (!this._isPaused) {\n\t\t\tthis.stop();\n\t\t} else {\n\t\t\tthis._isPaused = false;\n\t\t}\n\n\t\tvar src = this._getRandom();\n\t\tsrc.loop = opts.loop || this.loop;\n\t\tsrc.play();\n\t\t\n\t\tif (src.muted) {\n\t\t\t// Chrome bug? Audio objects with muted set before they\n\t\t\t// are played won't be muted, so toggle the mute state\n\t\t\t// twice after calling play.\n\t\t\tsrc.muted = false;\n\t\t\tsrc.muted = true;\n\t\t}\n\t\tthis._lastSrc = src;\n\t\tthis.setTime(opts.time);\n\t\tif (opts.duration) {\n\t\t\tsetTimeout(bind(this, function () {\n\t\t\t\tthis.pause();\n\t\t\t}), opts.duration * 1000);\n\t\t}\n\t};\n\n\tthis._getRandom = function () {\n\t\tvar index = Math.random() * this._sources.length | 0;\n\t\treturn this._sources[index];\n\t};\n});\n\n/**\n * @extends event.Emitter\n */\nvar sdk_timestep_ui_backend_sound_HTML5API=__class__;exports=sdk_timestep_ui_backend_sound_HTML5API(function sdk_timestep_ui_backend_sound_HTML5API(){return this.init&&this.init.apply(this,arguments)},Emitter, function (supr) {\n\tthis.init = function (opts) {\n\t\topts = opts || {};\n\n\t\tsupr(this, 'init', [opts]);\n\n\t\tthis.setPath(opts.path);\n\n\t\t//opts.map is deprecated in favor of opts.files\n\t\tthis._map = opts.files || opts.map;\n\t\tthis._preload = opts.preload;\n\t\tthis._sounds = {};\n\t\tthis._isMusicMuted = false;\n\t\tthis._areEffectsMuted = false;\n\t\tthis._currentMusic = null;\n\n\t\tif (opts.persist) {\n\t\t\tthis.persistState(opts.persist);\n\t\t}\n\n\t\t// determine whether browser supports mp3 or ogg. Default to mp3 if\n\t\t// both are supported. Native will return true for everything, but\n\t\t// on native, we store ogg files as .mp3 files, so return .mp3...\n\t\tvar sound = new Audio();\n\t\tthis._ext = sound.canPlayType(\"audio/mpeg\") ? '.mp3'\n\t\t\t: sound.canPlayType(\"audio/ogg\") ? '.ogg' : '';\n\n\t\tif (!this._ext) {\n\t\t\tthis._ext = '.mp3';\n\t\t\tlogger.log('warning: could not determine sound support type');\n\t\t}\n\n\t\t// add sounds to the audio API's list of sounds and\n\t\t// preload them if appropriate\n\t\tfor (var key in this._map) {\n\t\t\tvar item = this._map[key];\n\t\t\tthis.addSound(key, item);\n\t\t}\n\t};\n\n\tthis.getExt = function () { return this._ext; };\n\n\tthis.getPath = function (name) {\n\t\treturn (name) ? this._sounds[name].path : this._path;\n\t};\n\n\tthis.setPath = function (path) {\n\t\tif (path) {\n\t\t\tpath = path.replace(/\\/$/, '');\n\t\t}\n\n\t\tthis._path = path || '';\n\t};\n\n\tthis.addSound = function (name, opts) {\n\t\tthis._sounds[name] = new MultiSound(this, name, opts);\n\t};\n\n\t/* @internal for now\n\t */\n\tthis.persistState = function (key) {\n\t\tthis._key = key;\n\n\t\tvar value = localStorage.getItem(this._key);\n\t\tif (value) { try { value = JSON.parse(value); } catch (e) {} }\n\t\tif (value) {\n\t\t\tlogger.log('restoring audio api state');\n\t\t\tthis.setMusicMuted(value.isMusicMuted);\n\t\t\tthis.setEffectsMuted(value.areEffectsMuted);\n\t\t}\n\t};\n\n\t/* @internal for now\n\t */\n\tthis._persist = function () {\n\t\tif (this._key) {\n\t\t\tlocalStorage.setItem(this._key, JSON.stringify({\n\t\t\t\t\tisMusicMuted: this._isMusicMuted,\n\t\t\t\t\tareEffectsMuted: this._areEffectsMuted\n\t\t\t\t}));\n\t\t}\n\t};\n\n\tthis.getMuted = function () { return this._isMusicMuted && this._areEffectsMuted; };\n\tthis.getMusicMuted = function () { return this._isMusicMuted; };\n\tthis.getEffectsMuted = function () { return this._areEffectsMuted; };\n\n\t// global mute\n\tthis.setMuted = function (isMuted) {\n\t\tthis.setMusicMuted(isMuted);\n\t\tthis.setEffectsMuted(isMuted);\n\t};\n\n\tthis.setMusicMuted = function (isMusicMuted) {\n\t\t// if (isMusicMuted == this._isMusicMuted) { return; }\n\t\tthis._isMusicMuted = isMusicMuted;\n\t\tthis._persist();\n\n\t\t// resume music on unmute\n\t\tif (this._currentMusic) {\n\t\t\tif (isMusicMuted) {\n\t\t\t\tthis._currentMusic.pause();\n\t\t\t} else {\n\t\t\t\tthis._currentMusic.play();\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.setEffectsMuted = function (areEffectsMuted) {\n\t\tif (areEffectsMuted == this._areEffectsMuted) { return; }\n\t\tthis._areEffectsMuted = areEffectsMuted;\n\t\tthis._persist();\n\n\t\tif (areEffectsMuted) {\n\t\t\tfor (var key in this._sounds) {\n\t\t\t\tvar sound = this._sounds[key];\n\t\t\t\tif (!sound.isBackgroundMusic) {\n\t\t\t\t\tsound.stop();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.setVolume = function (name, volume) {\n\t\tvar sound = this._sounds[name];\n\t\tif (sound) {\n\t\t\tsound.setVolume(volume);\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t};\n\n\tthis.getVolume = function (name) {\n\t\tvar sound = this._sounds[name];\n\t\tif (sound) {\n\t\t\tvar elem = sound._sources[0]; //first audio element\n\t\t\treturn Math.round(10 * elem.volume) / 10; //round to nearest tenth\n\t\t} else {\n\t\t\treturn null;\n\t\t}\n\t};\n\n\tthis.setTime = function (name, t) {\n\t\tvar sound = this._sounds[name];\n\t\tif (!sound) {\n\t\t\tlogger.log(\"warning: no sound of that name\");\n\t\t\treturn false;\n\t\t}\n\n\t\tsound.setTime(t);\n\t};\n\n\tthis.getTime = function (name) {\n\t\tvar sound = this._sounds[name];\n\t\tif (!sound) {\n\t\t\tlogger.log(\"warning: no sound of that name\");\n\t\t\treturn false;\n\t\t}\n\n\t\treturn sound.getTime();\n\t};\n\n\tthis.getDuration = function (name) {\n\t\tvar sound = this._sounds[name];\n\t\tif (!sound) {\n\t\t\tlogger.log(\"warning: no sound of that name\");\n\t\t\treturn false;\n\t\t}\n\n\t\treturn sound.getDuration();\n\t};\n\n\tthis.play = function (name, opts) {\n\t\tvar sound = this._sounds[name];\n\t\topts = opts || {};\n\t\tif (!sound) {\n\t\t\tlogger.log(\"warning: no sound of that name\");\n\t\t\treturn false;\n\t\t}\n\n\t\tvar isBackgroundMusic = sound.isBackgroundMusic;\n\t\tif (isBackgroundMusic) {\n\t\t\t// some platforms enforce only one simultaneous background music\n\t\t\t// (native) while others do not.  Enforce it always.\n\t\t\tif (this._currentMusic) {\n\t\t\t\tthis._currentMusic.stop();\n\t\t\t}\n\n\t\t\tthis._currentMusic = sound;\n\n\t\t\t// if we're muted, make sure to resume the music if we unmute\n\t\t\tif (!this._isMusicMuted) {\n\t\t\t\tsound.play(opts);\n\t\t\t}\n\t\t} else if (!this._areEffectsMuted) {\n\t\t\tsound.play(opts);\n\t\t}\n\n\t\treturn true;\n\t};\n\n\tthis.pause = function (name) {\n\t\tvar sound = this._sounds[name];\n\t\tif (!sound) { return false; }\n\n\t\t// if we're muted and we pause the current music,\n\t\t// don't resume the music on unmute.\n\t\tif (this._currentMusic == sound) {\n\t\t\tthis._currentMusic = null;\n\t\t}\n\n\t\tsound.pause();\n\n\t\treturn true;\n\t};\n\n\tthis.stop = function (name) {\n\t\tvar sound = this._sounds[name];\n\t\tif (!sound) { return false; }\n\n\t\t// if we're muted and we pause the current music,\n\t\t// don't resume the music on unmute.\n\t\tif (this._currentMusic == sound) {\n\t\t\tthis._currentMusic = null;\n\t\t}\n\n\t\tsound.stop();\n\n\t\treturn true;\n\t};\n\n\tthis.isPaused = function (name) {\n\t\tvar sound = this._sounds[name];\n\t\tif (!sound) {\n\t\t\tlogger.log(\"warning: no sound of that name\");\n\t\t\treturn false;\n\t\t}\n\n\t\treturn sound.isPaused();\n\t};\n\n\tthis.isPlaying = function (name) {\n\t\tvar sound = this._sounds[name];\n\t\tif (!sound) {\n\t\t\tlogger.log(\"warning: no sound of that name\");\n\t\t\treturn false;\n\t\t}\n\n\t\treturn sound.isPlaying();\n\t};\n\n\t// @deprecated\n\tthis.playBackgroundMusic = this.play;\n\n\t// @deprecated\n\tthis.pauseBackgroundMusic = function () {\n\t\tthis._currentMusic && this._currentMusic.pause();\n\t};\n});\n","pre":true},"sdk/jsio/util/path.js":{"path":"sdk/jsio/util/path.js","friendlyPath":"util.path","directory":"sdk/jsio/util/","filename":"path.js","baseMod":"util","basePath":"sdk/jsio","pre":true,"src":"var util = jsio.__jsio.__util;\n\nexports.join = util.buildPath;\nexports.resolveRelativePath = util.resolveRelativePath;\nexports.splitPath = util.splitPath;\nexports.makeRelativePath = util.makeRelativePath;\nexports.splitExt = function(path) {\n\tvar res = exports.splitPath(path);\n\tvar i = res.filename.lastIndexOf('.');\n\tif (i == -1) {\n\t\tres.basename = res.filename;\n\t\tres.ext = '';\n\t} else {\n\t\tres.basename = res.filename.substring(0, i);\n\t\tres.ext = res.filename.substring(i);\n\t}\n\treturn res;\n}"},"sdk/timestep/ui/backend/dom/StackView.js":{"path":"sdk/timestep/ui/backend/dom/StackView.js","friendlyPath":".backend.dom.StackView","directory":"sdk/timestep/ui/backend/dom/","filename":"StackView.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\njsio(\"import ui.View\");\n\n/**\n * @extends timestep.dom.View\n */\nvar sdk_timestep_ui_backend_dom_StackView=__class__;exports=sdk_timestep_ui_backend_dom_StackView(function sdk_timestep_ui_backend_dom_StackView(){return this.init&&this.init.apply(this,arguments)},View, function (supr) {\n\n\tthis.init = function (opts) {\n\t\tsupr(this, 'init', arguments);\n\t\tthis.stack = [];\n\t}\n\t\n\tthis.getCurrentView = function () {\n\t\tif (!this.stack.length) { return null; }\n\t\treturn this.stack[this.stack.length - 1];\n\t}\n\t\n\tthis.push = function (view, dontAnimate) {\n\t\t// don't animate the first (base) view of a stackview unless explicitly asked to\n\t\tif (!this.stack[0] && dontAnimate !== false) {\n\t\t\tdontAnimate = true;\n\t\t}\n\t\t\n\t\tvar current = this.getCurrentView();\n\t\tif (current) { this._hide(current, dontAnimate); }\n\t\tview.style.width = this.style.width;\n\t\tview.style.height = this.style.height;\n\t\tthis.stack.push(view);\n\t\tthis._show(view, dontAnimate);\n\t\treturn view;\n\t}\n\t\n\tthis._hide = function (view, dontAnimate, backward) {\n\t\tview.publish('ViewWillDisappear');\n\t\tif (!dontAnimate) {\n\t\t\t// Prevent touches from triggering buttons/UI on the\n\t\t\t// disappearing view. Unfortunately, canHandleEvents()\n\t\t\t// doesn't affect subviews, so an overlay is added here\n\t\t\t// so that touches just don't go through while it animates out.\n\t\t\tvar overlay = new View({parent: view, zIndex: 100000});\n\t\t\tview.then({x: (backward ? 1 : -1) * view.style.width})\n\t\t\t\t.then(bind(this, 'removeSubview', view))\n\t\t\t\t.then(bind(view, 'publish', 'ViewDidDisappear'))\n\t\t\t\t.then(bind(overlay, 'removeFromSuperview'));\n\t\t} else {\n\t\t\tthis.removeSubview(view);\n\t\t\tview.publish('ViewDidDisappear');\n\t\t}\n\t}\n\n\tthis._show = function (view, dontAnimate, backward) {\n\t\tview.publish('ViewWillAppear');\n\t\tview.style.visible = true;\n\t\tif (!dontAnimate) {\n\t\t\tview.style.x = (backward ? -1 : 1) * this.style.width;\n\t\t\tthis.addSubview(view);\n\t\t\tview.then({x: 0})\n\t\t\t\t.then(bind(view, 'publish', 'ViewDidAppear'));\n\t\t} else {\n\t\t\tthis.addSubview(view);\n\t\t\tview.style.x = 0;\n\t\t\tview.publish('ViewDidAppear');\n\t\t}\n\t}\n\t\n\tthis.pop = function (dontAnimate) {\n\t\tif (!this.stack.length) { return false; }\n\t\tvar view = this.stack.pop();\n\t\tthis._hide(view, dontAnimate, true);\n\t\t\n\t\tif (this.stack.length) {\n\t\t\tthis._show(this.stack[this.stack.length - 1], dontAnimate, true);\n\t\t}\n\t\t\n\t\treturn view;\n\t}\n\t\n\tthis.popAll = function (dontAnimate) {\n\t\twhile (this.stack[1]) {\n\t\t\tthis.pop(dontAnimate);\n\t\t}\n\t}\n});\n","pre":true},"sdk/timestep/ui/backend/dom/TextView.js":{"path":"sdk/timestep/ui/backend/dom/TextView.js","friendlyPath":".backend.dom.TextView","directory":"sdk/timestep/ui/backend/dom/","filename":"TextView.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @package ui.backend.dom.TextView;\n *\n * TextView implementation for DOM.\n */\n\njsio(\"import ui.View as View\");\njsio(\"import device\");\n\n/**\n * @extends ui.View\n */\nvar sdk_timestep_ui_backend_dom_TextView=__class__;exports=sdk_timestep_ui_backend_dom_TextView(function sdk_timestep_ui_backend_dom_TextView(){return this.init&&this.init.apply(this,arguments)},View, function (supr) {\n\n\tthis._displayStyle = \"table\";\n\n\tvar defaults = {\n\t\t// layout properties...\n\t\twrap: true,\n\t\tautoSize: true,\n\t\tautoFontSize: true,\n\t\tverticalPadding: 0,\n\t\thorizontalPadding: 0,\n\t\tlineHeight: 1.2,\n\n\t\t// font properties...\n\t\tcolor: \"#000000\",\n\t\tfontFamily: device.defaultFontFamily,\n\t\tfontWeight: \"\",\n\t\tsize: 12,\n\t\tlineWidth: 2,\n\t\toutlineColor: null,\n\t\tshadowColor: null,\n\n\t\t// alignment properties...\n\t\tverticalAlign: \"middle\",\n\t\thorizontalAlign: \"center\",\n\n\t\t// misc properties...\n\t\tbackgroundColor: null\n\t};\n\n\tthis.init = function (opts) {\n\t\tsupr(this, \"init\", [merge(opts, defaults)]);\n\t};\n\n\tthis.updateOpts = function (opts) {\n\t\topts = supr(this, \"updateOpts\", arguments);\n\n\t\tvar s = this.__view.getElement().style;\n\n\t\tif (opts.horizontalPadding) {\n\t\t\tif (isArray(opts.horizontalPadding)) {\n\t\t\t\ts.paddingLeft = opts.horizontalPadding[0] + \"px\";\n\t\t\t\ts.paddingRight = opts.horizontalPadding[0] + \"px\";\n\t\t\t} else {\n\t\t\t\ts.paddingLeft = opts.horizontalPadding + \"px\";\n\t\t\t\ts.paddingRight = opts.horizontalPadding + \"px\";\n\t\t\t}\n\t\t}\n\n\t\tif (opts.verticalPadding) {\n\t\t\tif (isArray(opts.verticalPadding)) {\n\t\t\t\ts.paddingTop = opts.verticalPadding[0] + \"px\";\n\t\t\t\ts.paddingBottom = opts.verticalPadding[0] + \"px\";\n\t\t\t} else {\n\t\t\t\ts.paddingTop = opts.verticalPadding + \"px\";\n\t\t\t\ts.paddingBottom = opts.verticalPadding + \"px\";\n\t\t\t}\n\t\t}\n\n\t\tif (opts.color)           { s.color = opts.color; }\n\t\tif (opts.size)            { s.fontSize = opts.size + \"px\"; }\n\t\tif (opts.fontFamily)      { s.fontFamily = opts.fontFamily; }\n\t\tif (opts.horizontalAlign) { s.textAlign = opts.horizontalAlign; }\n\t\tif (opts.fontWeight)      { s.fontWeight = opts.fontWeight; }\n\t\tif (opts.shadowColor)     { s.textShadow = opts.shadowColor + \" 2px 2px 1px\"; }\n\t\tif (opts.outlineColor)    { s.webkitTextStroke = opts.lineWidth + \"px \" + opts.outlineColor; }\n\t\tif (!opts.wrap)           { s.whiteSpace = \"nowrap\"; }\n\n\t\ts.display = \"table\";\n\n\t\tif (\"text\" in opts) this.setText(opts.text);\n\t};\n\n\tthis.getText = function () {\n\t\treturn this.__view.getElement().getElementsByTagName(\"span\")[0].innerHTML;\n\t}\n\n\tthis.reflow = function () {\n\t\tif (this._textNode && this._opts.autoSize) {\n\t\t\tvar idealHeight = this._textNode.scrollHeight;\n\t\t\tif (!this.style.height || this.style.height < idealHeight) {\n\t\t\t\tthis.style.height = idealHeight;\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.setText = function (text) {\n\t\tif (typeof text == \"function\") {\n\t\t\treturn text(this);\n\t\t}\n\n\t\tif (this._text != text) {\n\t\t\tthis._text = text;\n\t\t\tvar n = this._textNode || document.createElement(\"span\");\n\t\t\tif (!this._textNode) {\n\t\t\t\tthis._textNode = n;\n\t\t\t\tthis.__view.getElement().appendChild(n);\n\t\t\t\tn.className = \"text\";\n\t\t\t\tn.style.display = \"table-cell\";\n\t\t\t\tn.style.verticalAlign = this._opts.verticalAlign || \"middle\";\n\t\t\t}\n\t\t\tthis._textNode.innerText = text || \"\";\n\t\t\tthis.needsReflow();\n\t\t}\n\t};\n});\n","pre":true},"sdk/timestep/ui/backend/dom/ViewBacking.js":{"path":"sdk/timestep/ui/backend/dom/ViewBacking.js","friendlyPath":".backend.dom.ViewBacking","directory":"sdk/timestep/ui/backend/dom/","filename":"ViewBacking.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\njsio(\"import device\");\njsio(\"import event.Callback as Callback\");\njsio(\"import animate\");\njsio(\"import animate.transitions as transitions\");\njsio(\"import event.input.InputEvent as InputEvent\");\njsio(\"import math.geom.Point as Point\");\njsio(\"from util.browser import $\");\n\njsio(\"import ..BaseBacking\");\n\nvar Canvas = device.get('Canvas');\n\nvar AVOID_CSS_ANIM = device.isAndroid;\n\nvar TRANSFORM_PREFIX = 'transform';\nfunction CHECK_TRANSLATE3D() {\n    var el = document.createElement('p'),\n        has3d,\n        transforms = {\n            'webkitTransform':'-webkit-transform',\n            'OTransform':'-o-transform',\n            'msTransform':'-ms-transform',\n            'MozTransform':'-moz-transform',\n            'transform':'transform'\n        };\n\n    // Add it to the body to get the computed style.\n    document.body.insertBefore(el, null);\n\n    for (var t in transforms) {\n        if (el.style[t] !== undefined) {\n            el.style[t] = \"translate3d(1px,1px,1px)\";\n            has3d = window.getComputedStyle(el).getPropertyValue(transforms[t]);\n            TRANSFORM_PREFIX = t;\n        }\n    }\n\n    document.body.removeChild(el);\n\n    return (has3d !== undefined && has3d.length > 0 && has3d !== \"none\");\n}\n\nvar SUPPORTS_TRANSLATE3D = CHECK_TRANSLATE3D();\n\n\nvar sdk_timestep_ui_backend_dom_ViewBacking=__class__;var ViewBacking = exports=sdk_timestep_ui_backend_dom_ViewBacking(function sdk_timestep_ui_backend_dom_ViewBacking(){return this.init&&this.init.apply(this,arguments)},BaseBacking, function () {\n\n\tvar arr = ['x', 'y', 'r', 'width', 'height', 'visible', 'anchorX', 'anchorY',\n\t\t\t   'opacity', 'scale', 'zIndex', 'scrollLeft', 'scrollTop', 'flipX', 'flipY'];\n\n\tvar CUSTOM_KEYS = {};\n\n\tarr.forEach(function (prop) {\n\t\tCUSTOM_KEYS[prop] = true;\n\n\t\tthis.__defineGetter__(prop, function () {\n\t\t\tif (prop in this._computed) {\n\t\t\t\treturn this._computed[prop];\n\t\t\t} else {\n\t\t\t\treturn parseInt(this._node.style[prop]);\n\t\t\t}\n\t\t});\n\t\tthis.__defineSetter__(prop, function (val) {\n\t\t\tvar props = {};\n\t\t\tprops[prop] = val;\n\t\t\tthis._setProps(props);\n\t\t\treturn val;\n\t\t});\n\t}, this);\n\n\tthis.init = function (view, opts) {\n\t\tthis._view = view;\n\t\tthis._subviews = [];\n\n\t\tvar n = this._node = document.createElement(opts.elementType || 'div');\n\n\t\t// used to identify dom nodes\n\t\tn._view = view;\n\t\tn.addEventListener(\"webkitTransitionEnd\", bind(this, \"_transitionEnd\"), false);\n\t\tn.className = \"view\" + \" \" + opts.className;\n\n\t\tvar s = n.style;\n\t\ts.fontSize = '1px';\n\t\ts.position = \"absolute\";\n\t\t\n\t\tthis.position(0, 0);\n\t\t\n\t\tif (!device.isAndroid) {\n\t\t\ts.webkitBackfaceVisibility = 'hidden';\n\t\t}\n\n\t\ts.webkitTransformOrigin = '0px 0px';\n\n\t\t// add any custom CSS style\n\t\tfor (var name in opts.styles) {\n\t\t\ts[name] = opts.styles[name];\n\t\t}\n\n\t\t// store for the computed styles\n\t\tthis._computed = {\n\t\t\tx: 0,\n\t\t\ty: 0,\n\t\t\tr: 0,\n\t\t\twidth: undefined,\n\t\t\theight: undefined,\n\t\t\tanchorX: 0,\n\t\t\tanchorY: 0,\n\t\t\topacity: 1,\n\t\t\tvisible: true,\n\t\t\tzIndex: 0,\n\t\t\tscale: 1\n\t\t};\n\n\t\t// animation\n\t\tthis._animating = false;\n\t\tthis._animationQueue = [];\n\t\tthis._animationCallback = null;\n\t}\n\n\tthis.getElement = function () { return this._node; }\n\n\tvar ADD_COUNTER = 900000;\n\tthis.addSubview = function (view) {\n\t\tvar backing = view.__view;\n\t\tvar node = backing._node;\n\t\tvar superview = node.parentNode && node.parentNode._view;\n\t\tif (superview == this._view) {\n\t\t\treturn false;\n\t\t} else {\n\t\t\tif (superview) { superview.__view.removeSubview(view); }\n\t\t\tvar n = this._subviews.length;\n\t\t\tthis._subviews[n] = view;\n\t\t\tthis._node.appendChild(node);\n\n\t\t\tbacking._setAddedAt(++ADD_COUNTER);\n\t\t\tif (n && backing.__sortKey < this._subviews[n - 1].__view.__sortKey) {\n\t\t\t\tthis._needsSort = true;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tthis.removeSubview = function (targetView) {\n\t\tvar index = this._subviews.indexOf(targetView);\n\t\tif (index != -1) {\n\t\t\tthis._subviews.splice(index, 1);\n\t\t\tthis._node.removeChild(targetView.__view._node);\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tthis.getSuperview = function () {\n\t\tvar p = this._node.parentNode;\n\t\tif (p == document.body || !p) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn p._view;\n\t}\n\n\tthis.getSubviews = function () {\n\t\tif (this._needsSort) { this._needsSort = false; this._subviews.sort(); }\n\t\treturn this._subviews;\n\t}\n\n\tthis.wrapTick = function (dt, app) {\n\t\tthis._view.tick && this._view.tick(dt, app);\n\n\t\tfor (var i = 0, view; view = this._subviews[i]; ++i) {\n\t\t\tview.__view.wrapTick(dt, app);\n\t\t}\n\t}\n\n\tthis.wrapRender = function (ctx, opts) {\n\t\tif (!this.visible) { return; }\n\n\t\tif (!this.__firstRender) { this._view.needsReflow(true); }\n\t\tif (this._needsSort) { this._needsSort = false; this._subviews.sort(); }\n\n\n\t\tvar width = this._computed.width;\n\t\tvar height = this._computed.height;\n\t\tif (!width || !height || width < 0 || height < 0) { return; }\n\n\t\t// var filters = this._view.getFilters();\n\t\t// ctx.setFilters(filters);\n\n\t\ttry {\n\t\t\tvar render = this._view.render;\n\t\t\tif (render && !render.isFake) {\n\t\t\t\tif (!this._canvas) {\n\t\t\t\t\tvar canvas = new Canvas();\n\t\t\t\t\tthis._canvas = canvas;\n\t\t\t\t\tthis._node.insertBefore(this._canvas, this._node.firstChild);\n\t\t\t\t\tthis.ctx = this._canvas.getContext('2d');\n\t\t\t\t}\n\n\t\t\t\tvar needsRepaint = this._view._needsRepaint;\n\n\t\t\t\t// clear the canvas\n\t\t\t\tif ((width | 0) != this._canvas.width || (height | 0) != this._canvas.height) {\n\t\t\t\t\tneedsRepaint = true;\n\t\t\t\t\tthis._canvas.width = width;\n\t\t\t\t\tthis._canvas.height = height;\n\t\t\t\t}\n\n\t\t\t\tif (needsRepaint) {\n\t\t\t\t\tthis._view._needsRepaint = false;\n\t\t\t\t\tthis._canvas.style.display = 'none';\n\t\t\t\t\tthis.ctx.clear();\n\t\t\t\t\t// this.ctx.fillStyle = 'red';\n\t\t\t\t\t// this.ctx.fillRect(0, 0, 1000, 1000);\n\t\t\t\t\tthis.ctx.save();\n\t\t\t\t\trender.call(this._view, this.ctx, opts);\n\t\t\t\t\tthis.ctx.restore();\n\t\t\t\t\tthis._canvas.style.display = 'block';\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis._renderSubviews(ctx, opts);\n\t\t} catch(e) {\n\t\t \tlogger.error(this, e.message, e.stack);\n\t\t}\n\t}\n\n\tthis._renderSubviews = function (ctx, opts) {\n\t\tvar i = 0;\n\t\tvar view;\n\t\tvar subviews = this._subviews;\n\t\twhile (view = subviews[i++]) {\n\t\t\tview.__view.wrapRender(ctx, opts);\n\t\t}\n\t}\n\n\tthis.localizePoint = function (pt) {\n\t\tvar s = this._computed;\n\t\tpt.x -= s.x + s.anchorX;\n\t\tpt.y -= s.y + s.anchorY;\n\t\tif (s.r) { pt.rotate(-s.r); }\n\t\tpt.scale(1 / s.scale);\n\t\tpt.x += s.anchorX;\n\t\tpt.y += s.anchorY;\n\t\treturn pt;\n\t}\n\n\t// exports the current style object\n\tthis.copy = function () {\n\t\treturn merge({}, this._computed);\n\t}\n\n\tthis.update = function (style) { this._setProps(style); }\n\t\n\tthis.position = function (x, y) {\n\t\tvar s = this._node.style;\n\n\t\tif (SUPPORTS_TRANSLATE3D) {\n\t\t\tvar translate = 'translate3d(' + (x) + 'px,' + (y) + 'px,0)';\n\n\t\t\t// Check for differences and other properties like scale, rotate, translate, etc\n\t\t\tif (s[TRANSFORM_PREFIX] != '' && s[TRANSFORM_PREFIX] != translate) {\n\t\t\t\ts[TRANSFORM_PREFIX] += translate;\n\t\t\t}\n\t\t\telse {\n\t\t\t\ts[TRANSFORM_PREFIX] = translate;\n\t\t\t}\n\n\t\t}\n\t\telse {\n\t\t\ts.left = x + 'px';\n\t\t\ts.top = y + 'px';\n\t\t}\n\t};\n\n\t//****************************************************************\n\t// ANIMATION\n\n\tfunction getEasing(fn) {\n\t\tif (typeof fn == 'string') { return fn; }\n\t\tif (fn == transitions.easeIn) { return 'ease-in'; }\n\t\tif (fn == transitions.easeOut) { return 'ease-out'; }\n\t\tif (fn == transitions.easeInOut) { return 'ease-in-out'; }\n\t\tif (fn == transitions.linear) { return 'linear'; }\n\t\treturn 'ease';\n\t};\n\n\tthis._updateOrigin = function () {\n\t\tthis._node.style.webkitTransformOrigin = (this._computed.anchorX || 0) + 'px ' + (this._computed.anchorY || 0) + 'px';\n\t}\n\n\t// {\n\t// \t'x': {value: 0, cb: '_onPosition'},\n\t// \t'y': {value: 0, cb: '_onPosition'},\n\t// }\n\n\tthis._onPosition = function (key, value) {\n\t\tvalue = Math.floor(value);\n\t\tthis._setMatrix();\n\t}\n\n\tthis._onResize = function () {\n\t\t// order matters\n\t\tthis._setMatrix();\n\t\tthis._setCenter();\n\t\tthis._view.needsReflow();\n\t}\n\n\tthis._setProps = function (props, anim) {\n\t\tvar setMatrix = false;\n\t\tvar s = this._node.style;\n\t\tvar animCount = 0;\n\t\tvar resized = false;\n\t\tvar previous = {};\n\t\tfor (var key in props) {\n\t\t\tvar value = props[key];\n\t\t\tif (key == \"dx\" || key == \"dy\") {\n\t\t\t\tkey = key.substr(1);\n\t\t\t\tvalue = this._computed[key] + value;\n\t\t\t}\n\t\t\tswitch (key) {\n\t\t\t\tcase \"anchorX\":\n\t\t\t\tcase \"anchorY\":\n\t\t\t\t\tthis._computed[key] = value;\n\t\t\t\t\tthis._updateOrigin();\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"clip\":\n\t\t\t\t\tthis._computed.clip = value;\n\t\t\t\t\ts.overflow = value ? 'hidden' : 'visible';\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"zIndex\":\n\t\t\t\t\tif (this._computed.zIndex != value) {\n\t\t\t\t\t\tthis._computed.zIndex = value;\n\t\t\t\t\t\ts.zIndex = value;\n\t\t\t\t\t\tthis._onZIndex(value);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"x\":\n\t\t\t\tcase \"y\":\n\t\t\t\t\tvalue = Math.floor(value);\n\t\t\t\tcase \"r\":\n\t\t\t\tcase \"scale\":\n\t\t\t\t\tif (this._computed[key] != value) {\n\t\t\t\t\t\tprevious[key] = this._computed[key];\n\t\t\t\t\t\tthis._computed[key] = value;\n\t\t\t\t\t\tsetMatrix = true;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tif (this._computed[key] != value) {\n\t\t\t\t\t\t++animCount;\n\t\t\t\t\t    this._computed[key] = value;\n\t\t\t\t\t\tif (key == 'width' || key == 'height') {\n\t\t\t\t\t\t\ts[key] = value + 'px';\n\t\t\t\t\t\t\tresized = true;\n\t\t\t\t\t\t} else if (key == 'visible') {\n\t\t\t\t\t\t\ts.display = (value ? this._displayStyle || 'block' : 'none');\n\t\t\t\t\t\t\t//s.visibility = (value ? 'visible' : 'hidden');\n\t\t\t\t\t\t\t// chrome has an obscure rendering bug where visibility:hidden won't\n\t\t\t\t\t\t\t// hide the canvas element child nodes sometimes. If you set opacity to zero, it will.\n\t\t\t\t\t\t\t//s.opacity = (value ? this._computed['opacity'] : 0);\n\n\t\t\t\t\t\t} else if (key == 'opacity') {\n\t\t\t\t\t\t\ts[key] = value;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\ts[key] = value;\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tif (!CUSTOM_KEYS[key]) {\n\t\t\t\t\t\t\t\tthis[key] = value;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tif (setMatrix) {\n\t\t\t++animCount;\n\t\t\tif (AVOID_CSS_ANIM) {\n\t\t\t\tvar obj = {\n\t\t\t\t\tscale: previous.scale || this._computed.scale,\n\t\t\t\t\tr: previous.r || this._computed.r\n\t\t\t\t};\n\t\t\t\t// because of android bugs,\n\t\t\t\t// we must never animate -webkit-transform.\n\t\t\t\t// http://code.google.com/p/android/issues/detail?id=12451\n\t\t\t\tif (anim && ((obj.scale != this._computed.scale) ||\n\t\t\t\t\t\t\t (obj.r != this._computed.r))) {\n\t\t\t\t\t// logger.log('set transform animated', obj.scale, this._computed.scale, obj.r, this._computed.r);\n\t\t\t\t\tanimate(obj).now({\n\t\t\t\t\t\tscale: this._computed.scale,\n\t\t\t\t\t\tr: this._computed.r\n\t\t\t\t\t}, anim.duration, anim.easing, bind(this, function () {\n\t\t\t\t\t\ts.WebkitTransform = ('scale(' + (this._computed.flipX ? obj.scale * -1 : obj.scale) +\n\t\t\t\t\t\t\t\t\t\t\t ',' + (this._computed.flipY ? obj.scale * -1 : obj.scale) + ') ' +\n\t\t\t\t\t\t\t\t\t\t\t 'rotate(' + obj.r + 'rad)');\n\t\t\t\t\t})).then(bind(this, function () {\n\t\t\t\t\t\ts.WebkitTransform = ('scale(' + (this._computed.flipX ? obj.scale * -1 : obj.scale) +\n\t\t\t\t\t\t\t\t\t\t\t ',' + (this._computed.flipY ? obj.scale * -1 : obj.scale) + ') '  +\n\t\t\t\t\t\t\t\t\t\t\t 'rotate(' + this._computed.r + 'rad)');\n\t\t\t\t\t}));\n\n\t\t\t\t} else if ((obj.scale != this._computed.scale) ||\n\t\t\t\t\t\t   (obj.r != this._computed.r)) {\n\t\t\t\t\t// logger.log('set transform', this._computed.scale, this._computed.r);\n\t\t\t\t\ts.WebkitTransform = ('scale(' + (this._computed.flipX ? this._computed.scale * -1 : this._computed.scale) +\n\t\t\t\t\t\t\t\t\t\t\t',' + (this._computed.flipY ? this._computed.scale * -1 : this._computed.scale) + ') ' +\n\t\t\t\t\t\t\t\t\t\t 'rotate(' + this._computed.r + 'rad)');\n\t\t\t\t}\n\t\t\t\t// use CSS animations for left and top though, since\n\t\t\t\t// those can still be taken out of javascript.\n\t\t\t        var computed = {\n                    \t\t\tx: (this._center ? -this.width / 2 | 0 : 0) + this._computed.x,\n                    \t\t\ty: (this._center ? -this.height / 2 | 0 : 0) + this._computed.y\n                \t\t};\n\t\t\t\t\n\t\t\t\tthis.position(computed.x, computed.y);\n\t\t\t} else {\n\t\t\t\tvar matrix = new WebKitCSSMatrix();\n\t\t\t\tmatrix = matrix.translate(\n\t\t\t\t\tthis._computed.x,\n\t\t\t\t\tthis._computed.y\n\t\t\t\t);\n\n\t\t\t\tmatrix = matrix.rotate(this._computed.r * 180 / 3.14159);\n\t\t\t\tmatrix = matrix.scale(this._computed.scale);\n\n\t\t\t\tif(this._computed.flipX || this._computed.flipY) {\n\t\t\t\t\tmatrix = matrix.translate(\n\t\t\t\t\t\tthis._computed.flipX ? -this._computed.width : 0,\n\t\t\t\t\t\tthis._computed.flipY ? this._computed.height / 2 : 0\n\t\t\t\t\t);\n\t\t\t\t\tmatrix = matrix.scale(\n\t\t\t\t\t\tthis._computed.flipX ? -1 : 1,\n\t\t\t\t\t\tthis._computed.flipY ? -1 : 1\n\t\t\t\t\t);\n\t\t\t\t\tmatrix = matrix.translate(\n\t\t\t\t\t\tthis._computed.flipX ? this._computed.width : 0,\n\t\t\t\t\t\tthis._computed.flipY ? -this._computed.height / 2 : 0\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\t// on iOS, forcing a 3D matrix provides huge performance gains.\n\t\t\t\t// Rotate it about the y axis 360 degrees to achieve this.\n\t\t\t\tmatrix = matrix.rotate(0, 360, 0);\n\t\t\t\ts.WebkitTransform = matrix;\n\t\t\t}\n\n\t\t}\n\t\tif (resized) {\n\t\t\tthis._onSizeChanged && this._onSizeChanged();\n\t\t}\n\n\t\treturn animCount;\n\t};\n\n\tthis._setCenter = function () {\n\t\tvar s = this._node.style;\n\t\tvar origin = {\n\t\t\tx: 0,\n\t\t\ty: 0\n\t\t};\n\t\tif (AVOID_CSS_ANIM) {\n\t\t\torigin.x += this._computed.x;\n\t\t\torigin.y += this._computed.y;\n\t\t}\n\t\t\n\t\tthis.position(origin.x, origin.y);\n\t}\n\n\tthis._onSizeChanged = function () {\n\t\tthis._setCenter();\n\t\tthis._view.needsReflow();\n\t}\n\n\t// ----- zIndex -----\n\n\tvar LEN_Z = 8;\n\tvar MAX_Z = 99999999;\n\tvar MIN_Z = -99999999;\n\tvar PAD = \"00000000\";\n\n\tthis._sortIndex = \"00000000\";\n\n\tthis._onZIndex = function (zIndex) {\n\t\tzIndex = ~~zIndex;\n\n\t\tif (zIndex < MIN_Z) { zIndex = this._zIndex = MIN_Z; }\n\t\tif (zIndex > MAX_Z) { zIndex = this._zIndex = MAX_Z; }\n\t\tif (zIndex < 0) {\n\t\t\tzIndex *= -1;\n\t\t\tthis._sortIndex = '-' + PAD.substring(0, LEN_Z - ('' + zIndex).length) + zIndex;\n\t\t} else {\n\t\t\tthis._sortIndex = PAD.substring(0, LEN_Z - ('' + zIndex).length) + zIndex;\n\t\t}\n\n\t\tthis._setSortKey();\n\t}\n\n\tthis._setAddedAt = function (addedAt) {\n\t\tthis._addedAt = addedAt;\n\t\tthis._setSortKey();\n\t}\n\n\tthis._setSortKey = function () {\n\t\tthis.__sortKey = this._sortIndex + this._addedAt;\n\t}\n\n\t// ----- ANIMATION -----\n\n\tthis._transitionEnd = function (evt) {\n\t\t$.stopEvent(evt);\n\t\tif (this.transitionCallback.fired()) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.transitionCallback.fire();\n\t\tthis.transitionCallback.reset();\n\n\t\tif (evt) {\n\t\t\tevt.cancelBubble = true;\n\t\t} else if (this._transitionEndTimeout) {\n\t\t\tthis._transitionEndTimeout = null;\n\t\t}\n\n\t\tthis._node.style.webkitTransition = \"none\";\n\n\t\tthis._animating = false;\n\t\tif (this._animationCallback) {\n\t\t\tvar callback = this._animationCallback;\n\t\t\tthis._animationCallback = null;\n\t\t\tcallback();\n\t\t}\n\n\t\tthis._processAnimation();\n\t};\n\n\n\tthis._processAnimation = function (doNow) {\n\t\tif (this._animationQueue.length == 0 || this._isPaused) {\n\t\t\treturn;\n\t\t}\n\t\tif (doNow) {\n\t\t\t\tclearTimeout(this._queuedTimeout);\n\t\t\t\tthis._queuedTimeout = null;\n\t\t}\n\t\tif (this._queuedTimeout) {\n\t\t\treturn;\n\t\t}\n\t\tif (!doNow) {\n\t\t\tif (!this._queuedTimeout) {\n\t\t\t\tthis._queuedTimeout = setTimeout(bind(this, function () {\n\t\t\t\t\tthis._queuedTimeout = false;\n\t\t\t\t\tthis._processAnimation(true);\n\t\t\t\t}), 0);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tvar anim = this._animationQueue.shift();\n\t\tswitch (anim.type) {\n\t\tcase \"animate\":\n\t\t\tvar s = this._node.style;\n\t\t\tif (AVOID_CSS_ANIM) {\n\t\t\t\ts.webkitTransitionProperty = \"left, top, opacity, width, height\";\n\t\t\t} else {\n\t\t\t\ts.webkitTransitionProperty = \"-webkit-transform, opacity, width, height\";\n\t\t\t}\n\t\t\ts.webkitTransitionDuration = (anim.duration|0) + \"ms\";\n\t\t\ts.webkitTransitionTimingFunction = getEasing(anim.easing);\n\t\t\tthis._setProps(anim.props, anim);\n\n\t\t\t// fall through\n\t\tcase \"wait\":\n\t\t\tthis._animating = true;\n\t\t\tthis._animationCallback = anim.callback || null;\n\n\t\t\tthis.transitionCallback = new Callback();\n\n\t\t\tthis.transitionCallback.runOrTimeout(function () {\n\t\t\t\t// if webkitTransitionEnd fires, do nothing\n\t\t\t}, bind(this, function (evt) {\n\t\t\t\t// webkitTransitionEnd is too late, baby, it's too late\n\t\t\t\tthis._transitionEnd(evt);\n\t\t\t}), anim.duration);\n\t\t\tbreak;\n\t\tcase \"callback\":\n\t\t\t//logger.log('doing callback', anim.callback, doNow);\n\t\t\tanim.callback();\n\t\t\tif (!this._animating) {\n\t\t\t\tthis._processAnimation();\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\n\t};\n\n\tthis.getQueue = function () {\n\t\treturn [];\n\t}\n\tthis.getAnimation = function () {\n\t\treturn this;\n\t}\n\n\tthis.animate = function () {\n\t\tif (!arguments[0]) {\n\t\t\treturn this;\n\t\t}\n\t\treturn this.next.apply(this, arguments);\n\t}\n\n\tthis.clear = function () {\n\t\tthis.transitionCallback && this.transitionCallback.fire();\n\t\tif (this._transitionEndTimeout) {\n\t\t\tclearTimeout(this._transitionEndTimeout);\n\t\t}\n\t\tthis._animationQueue = [];\n\t\tthis._animationCallback = null;\n\t\tthis._animating = false;\n\t\treturn this;\n\t};\n\n\tthis.finishNow = function () {\n\t\tthis._node.style.webkitTransition = 'none';\n\t\t// TODO: this isn't really right; you need to actually finish the queue\n\n\t\treturn this;\n\t}\n\n\tvar DURATION = 600;\n\n\tthis.pause = function () {\n\t\tthis._isPaused = true;\n\t}\n\n\tthis.resume = function () {\n\t\tthis._isPaused = false;\n\t\tthis._processAnimation();\n\t}\n\n\tthis.animate = function (props, duration, easing, callback) {\n\t\t//this.clear();\n\t\treturn this.then(props, duration, easing, callback);\n\t};\n\n\tthis.now = function (props, duration, easing, callback) {\n\t\tthis.clear();\n\t\treturn this.then(props, duration, easing, callback);\n\t}\n\n\tthis.then = function (props, duration, easing, callback) {\n\t\tif (arguments.length == 1 && typeof props === 'function') {\n\t\t\treturn this.callback(props);\n\t\t}\n\t\tthis._animationQueue.push({\n\t\t\ttype: \"animate\",\n\t\t\tprops: props,\n\t\t\tduration: duration || DURATION,\n\t\t\tcallback: callback && bind(this, callback),\n\t\t\teasing: easing\n\t\t});\n\t\tif (this._animationQueue.length == 1 && !this._animating) {\n\t\t\tthis._processAnimation();\n\t\t}\n\t\treturn this;\n\t};\n\n\tthis.callback = function (fn) {\n\t\tthis._animationQueue.push({\n\t\t\ttype: \"callback\",\n\t\t\tduration: 0,\n\t\t\tcallback: fn && bind(this, fn)\n\t\t});\n\t\tif (this._animationQueue.length == 1 && !this._animating) {\n\t\t\tthis._processAnimation();\n\t\t}\n\t\treturn this;\n\t}\n\n\tthis.wait = function (duration, callback) {\n\t\tthis._animationQueue.push({\n\t\t\ttype: \"wait\",\n\t\t\tduration: duration,\n\t\t\tcallback: callback\n\t\t});\n\t\tif (this._animationQueue.length == 1 && !this._animating) {\n\t\t\tthis._processAnimation();\n\t\t}\n\t\treturn this;\n\t};\n\n\tthis.fadeIn = function (duration, callback) {\n\t\tthis.show();\n\n\t\tif (this._node.style.opacity == 1) {\n\t\t\tif (callback) {\n\t\t\t\tcallback();\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tthis.then({\n\t\t\topacity: 1\n\t\t}, duration, null, callback);\n\t\treturn this;\n\t};\n\n\tthis.fadeOut = function (duration, callback) {\n\t\tif (this._node.style.opacity == 0) {\n\t\t\tthis.hide();\n\t\t\tif (callback) {\n\t\t\t\tcallback();\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tthis.then({\n\t\t\topacity: 0\n\t\t}, duration, null, bind(this, function () {\n\t\t\tthis.hide();\n\t\t\tif (callback) {\n\t\t\t\tcallback();\n\t\t\t}\n\t\t}));\n\n\t\treturn this;\n\t};\n\n});\n\n","pre":true},"sdk/timestep/ui/backend/canvas/ImageView.js":{"path":"sdk/timestep/ui/backend/canvas/ImageView.js","friendlyPath":".backend.canvas.ImageView","directory":"sdk/timestep/ui/backend/canvas/","filename":"ImageView.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * package ui.backend.canvas.ImageView;\n *\n * canvas.ImageView implementation.\n */\n\njsio(\"import util.path\");\njsio(\"import std.uri as URI\");\n\njsio(\"import ui.View as View\")\njsio(\"import ui.resource.Image as Image\");\n\nvar imageCache = {};\n\n/**\n * @extends ui.View\n */\nvar sdk_timestep_ui_backend_canvas_ImageView=__class__;var ImageView = exports=sdk_timestep_ui_backend_canvas_ImageView(function sdk_timestep_ui_backend_canvas_ImageView(){return this.init&&this.init.apply(this,arguments)},View, function (supr) {\n\n\t/** \n\t * Options:\n\t *   autoSize - See .setImage()\n\t */\n\n\t/**\n\t * Return this view's Image object.\n\t */\n\n\tthis.getImage = function () {\n\t\treturn this._img;\n\t};\n\n\tthis.getImageFromCache = function(url, forceReload) {\n\t\tvar img;\n\t\tif (!forceReload) {\n\t\t\timg = imageCache[url];\n\t\t}\n\t\tif (!img) {\n\t\t\timageCache[url] = img = new Image({\n\t\t\t\turl: url,\n\t\t\t\tforceReload: !!forceReload\n\t\t\t});\n\t\t}\n\t\treturn img;\n\t};\n\n\tthis.updateOpts = function (opts) {\n\t\tvar opts = supr(this, 'updateOpts', arguments);\n\t\t\n\t\tif ('autoSize' in opts) {\n\t\t\tthis._autoSize = !!opts.autoSize;\n\t\t}\n\n\t\tif (opts.image) {\n\t\t\tthis.setImage(opts.image);\n\t\t} else {\n\t\t\tthis.needsReflow();\n\t\t}\n\n\t\treturn opts;\n\t}\n\n\t/**\n\t * Set the image of the view from an Image object or string.\n\t * Options:\n\t *   autoSize - Automatically set view size from image dimensions.\n\t */\n\n\tthis.setImage = function (img, opts) {\n\t\tvar forceReload = opts && opts.forceReload;\n\t\tif (typeof img == 'string') {\n\t\t\timg = this.getImageFromCache(img, forceReload);\n\t\t}\n\n\t\tthis._img = img;\n\n\t\tif (this._img) {\n\t\t\tthis._autoSize = (opts && ('autoSize' in opts)) ? opts.autoSize : this._autoSize;\n\t\t\tif (this._autoSize) {\n\t\t\t\t// sprited resources will know their dimensions immediately\n\t\t\t\tif (this._img.getWidth() > 0 && this._img.getHeight() > 0) {\n\t\t\t\t\tthis.autoSize();\n\t\t\t\t} else {\n\t\t\t\t\t// non-sprited resources need to load first\n\t\t\t\t\tthis._img.doOnLoad(this, 'autoSize');\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis._img.doOnLoad(this, 'needsRepaint');\n\t\t}\n\t};\n\n\t/**\n\t * Pass a function to load once the Image object is loaded, or a list of\n\t * arguments that call lib.Callback::run() implicitly.\n\t */\n\t\n\tthis.doOnLoad = function () {\n\t\tif (arguments.length == 1) {\n\t\t\tthis._img.doOnLoad(this, arguments[0]);\n\t\t} else {\n\t\t\tthis._img.doOnLoad.apply(this._img, arguments);\n\t\t}\n\t\treturn this;\n\t};\n\n\t/**\n\t * Automatically resize the view to the size of the image.\n\t */\n\t\n\tthis.autoSize = function () {\n\t\tif (this._img) {\n\t\t\tthis.style.width = this._img.getWidth();\n\t\t\tthis.style.height = this._img.getHeight();\n\n\t\t\tif (this.style.fixedAspectRatio) {\n\t\t\t\tthis.style.enforceAspectRatio(this.style.width, this.style.height);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Get original width of the Image object.\n\t */\n\t\n\tthis.getOrigWidth = this.getOrigW = function () {\n\t\treturn this._img.getOrigW();\n\t};\n\n\t/**\n\t * Get original height of the Image object.\n\t */\n\n\tthis.getOrigHeight = this.getOrigH = function () {\n\t\treturn this._img.getOrigH();\n\t};\n\n\t/**\n\t * Render this image onto a canvas.\n\t */\n\n\tthis.render = function (ctx) {\n\t\tif (!this._img) { return; }\n\n\t\tvar s = this.style;\n\t\tvar w = s.width;\n\t\tvar h = s.height;\n\t\tthis._img.render(ctx, 0, 0, w, h);\n\t}\n\n\t/**\n\t * Return a human-readable tag for this view.\n\t */\n\n\tvar _loc = window.location.toString();\n\tvar _host = window.location.hostname;\n\t\n\tthis.getTag = function () {\n\t\tvar tag;\n\t\tif (this._img) {\n\t\t\tvar url = this._img.getOriginalURL();\n\t\t\tif (this._cachedTag && url == this._cachedTag.url) {\n\t\t\t\ttag = this._cachedTag.tag;\n\t\t\t} else {\n\t\t\t\tvar uri = URI.relativeTo(url, _loc);\n\t\t\t\tvar host = uri.getHost();\n\t\t\t\ttag = util.path.splitExt(uri.getFile()).basename + (host && host != _host ? ':' + host : '');\n\n\t\t\t\tthis._cachedTag = {\n\t\t\t\t\turl: url,\n\t\t\t\t\ttag: tag\n\t\t\t\t};\n\t\t\t}\n\t\t};\n\n\t\treturn (tag || '') + ':ImageView' + this.uid;\n\t}\n});\n","pre":true},"sdk/timestep/ui/backend/canvas/TextView.js":{"path":"sdk/timestep/ui/backend/canvas/TextView.js","friendlyPath":".backend.canvas.TextView","directory":"sdk/timestep/ui/backend/canvas/","filename":"TextView.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * package ui.backend.canvas.TextView;\n *\n * canvas.TextView implementation.\n */\n\njsio(\"import ui.View as View\");\njsio(\"import ui.resource.Image as Image\");\njsio(\"import ui.layout.Padding as Padding\");\njsio(\"import device\");\njsio(\"import .util.FragmentBuffer as FragmentBuffer\");\njsio(\"import .TextFlow\");\n\njsio(\"import ...legacySettings as legacySettings\");\n\nvar messageFont = true; // Report first font error message\n\nvar textViewID = 1;\n\n/**\n * @extends ui.View\n */\nvar sdk_timestep_ui_backend_canvas_TextView=__class__;var TextView = exports=sdk_timestep_ui_backend_canvas_TextView(function sdk_timestep_ui_backend_canvas_TextView(){return this.init&&this.init.apply(this,arguments)},View, function (supr) {\n\n\tvar DEPRECATED = {\n\t\tmultiline: { replacement: \"wrap\" },\n\t\ttextAlign: { replacement: \"horizontalAlign\" },\n\t\tlineWidth: { replacement: \"strokeWidth\" },\n\t\tstrokeStyle: { replacement: \"strokeColor\" },\n\t\toutlineColor: { replacement: \"strokeColor\" }\n\t};\n\n\tvar defaults = {\n\t\t// layout properties...\n\t\twrap: false,\n\t\tautoSize: false,\n\t\tautoFontSize: true,\n\t\tpadding: new Padding(0),\n\t\tlineHeight: 1.2,\n\n\t\t// font properties...\n\t\tcolor: \"#000000\",\n\t\tfontFamily: device.defaultFontFamily,\n\t\tfontWeight: device.defaultFontWeight,\n\t\tsize: 128,\n\t\tstrokeWidth: 2,\n\t\tshadowWidth: 2,\n\t\tstrokeColor: null,\n\t\tshadowColor: null,\n\n\t\t// alignment properties...\n\t\tverticalAlign: \"middle\",\n\t\thorizontalAlign: \"center\",\n\n\t\t// misc properties...\n\t\tbuffer: false, // GLOBAL.NATIVE && !device.simulatingMobileNative,\n\t\tbackgroundColor: null\n\n\n\t};\n\n\tvar clearCache = {\n\t\t// basic widget properties...\n\t\twidth: true,\n\t\theight: true,\n\n\t\t// layout properties...\n\t\twrap: true,\n\t\tautoSize: true,\n\t\tautoFontSize: true,\n\t\tpadding: true,\n\t\tlineHeight: true,\n\n\t\t// font properties...\n\t\tcolor: false,\n\t\tfontFamily: true,\n\t\tfontWeight: true,\n\t\tsize: true,\n\t\tstrokeWidth: true,\n\t\tshadowWidth: true,\n\t\tstrokeColor: false,\n\t\tshadowColor: false,\n\n\t\t// alignment properties...\n\t\tverticalAlign: true,\n\t\thorizontalAlign: true,\n\n\t\t// misc properties...\n\t\tbackgroundColor: false,\n\t\ttext: true\n\t};\n\tvar clearCacheKeys = Object.keys(clearCache);\n\n\tvar hashItems = {\n\t\t// font properties...\n\t\tcolor: true,\n\t\tfontFamily: true,\n\t\tfontWeight: true,\n\t\tsize: true,\n\t\tstrokeWidth: true,\n\t\tshadowWidth: true,\n\t\tstrokeColor: false,\n\t\tshadowColor: false,\n\n\t\t// misc properties...\n\t\tbackgroundColor: true,\n\t\ttext: true\n\t};\n\tvar hashItemsKeys = Object.keys(hashItems);\n\n\tvar savedOpts = [\n\t\t\"width\",\n\t\t\"height\",\n\t\t\"size\"\n\t];\n\n\tvar fontBuffer = new FragmentBuffer();\n\n\tfontBuffer.onGetHash = function (desc) {\n\t\treturn desc.textView.getHash();\n\t};\n\n\tthis.init = function (opts) {\n\t\tthis._opts = {};\n\t\tthis._optsLast = {};\n\t\tthis.updateCache();\n\n\t\tthis._textFlow = new TextFlow({target: this});\n\t\tthis._textFlow.subscribe(\"ChangeWidth\", this, \"onChangeWidth\");\n\t\tthis._textFlow.subscribe(\"ChangeHeight\", this, \"onChangeHeight\");\n\t\tthis._textFlow.subscribe(\"ChangeSize\", this, \"onChangeSize\");\n\t\t\n\t\tsupr(this, 'init', [merge(opts, defaults)]);\n\n\t\tthis._id = textViewID++;\n\t};\n\n\tthis.onChangeWidth = function (width) {\n\t\tthis.updateOpts({width: width}, true);\n\t};\n\n\tthis.onChangeHeight = function (height) {\n\t\tthis.updateOpts({height: height}, true);\n\t};\n\n\tthis.onChangeSize = function (size, ctx) {\n\t\tthis.updateOpts({size: size}, true);\n\t\tif (ctx) {\n\t\t\tctx.font = this._opts.fontWeight + \" \" + this._opts.size + \"px \" + this._opts.fontFamily;\n\t\t}\n\t};\n\n\t// These options might have been changed to make the text fit, restore them...\n\tthis._restoreOpts = function () {\n\t\tvar optsLast = this._optsLast;\n\t\tvar optsKey;\n\t\tvar i = savedOpts.length;\n\t\twhile (i) {\n\t\t\toptsKey = savedOpts[--i];\n\t\t\tif (optsKey in optsLast) {\n\t\t\t\tthis._opts[optsKey] = optsLast[optsKey];\n\t\t\t}\n\t\t}\n\t};\n\n\t// Check if the cache should be updated...\n\tthis._checkOpts = function (opts) {\n\t\tvar optsLast = this._optsLast;\n\t\tvar optsKey;\n\t\tvar i = clearCacheKeys.length;\n\n\t\tthis._cacheUpdate = this._cacheUpdate || !Object.keys(this._opts).length;\n\t\tif (this._cacheUpdate) {\n\t\t\tthis._hash = false;\n\t\t}\n\t\twhile (i) {\n\t\t\toptsKey = clearCacheKeys[--i];\n\t\t\tif ((optsKey in opts) && clearCache[optsKey] && (optsLast[optsKey] !== opts[optsKey])) {\n\t\t\t\tthis._cacheUpdate = true;\n\t\t\t}\n\t\t\tif (optsKey in opts) {\n\t\t\t\toptsLast[optsKey] = opts[optsKey];\n\t\t\t} else if (optsKey in this._opts) {\n\t\t\t\toptsLast[optsKey] = this._opts[optsKey];\n\t\t\t} else {\n\t\t\t\toptsLast[optsKey] = defaults[optsKey];\n\t\t\t}\n\t\t}\n\t};\n\n\tthis._checkDeprecatedOpts = function (opts) {\n\t\topts.allowVerticalSizing = !legacySettings.disableVerticalAutoSize;\n\t\tfor (var k in DEPRECATED) {\n\t\t\tif (k in opts) {\n\t\t\t\tvar dep = DEPRECATED[k];\n\t\t\t\tif (DEBUG && !dep.hasWarned) {\n\t\t\t\t\tconsole.warn(\"TextView opts.\" + k + \" is deprecated, please use \" + dep.replacement + \"...\");\n\t\t\t\t\tdep.hasWarned = true;\n\t\t\t\t}\n\t\t\t\topts[dep.replacement] = opts[k];\n\t\t\t}\n\t\t}\n\t\tvar font = opts.font;\n\t\tif (font) {\n\t\t\tif (DEBUG && messageFont) {\n\t\t\t\tconsole.warn(\"TextView opts.font is deprecated, please use fontFamily and size...\");\n\t\t\t\tmessageFont = false;\n\t\t\t}\n\t\t\twhile (font.length && (font[0] === \" \")) {\n\t\t\t\tfont = font.substr(1 - font.length);\n\t\t\t}\n\t\t\tvar i = font.indexOf(' ');\n\t\t\tif (i !== -1) {\n\t\t\t\topts.size = parseInt(font.substr(0, i).replace(/[pxtem\\s]/gi, \"\"), 10);\n\t\t\t\topts.fontFamily = font.substr(i + 1 - font.length);\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.updateCache = function () {\n\t\tthis._cacheUpdate = true;\n\t\tthis._hash = false;\n\t};\n\n\tthis.updateOpts = function (opts, dontCheck) {\n\t\t// update emoticon data\n\t\tif (opts.emoticonData) {\n\t\t\tfor (var key in opts.emoticonData.data) {\n\t\t\t\tvar data = opts.emoticonData.data[key];\n\t\t\t\tif (!data.image) {\n\t\t\t\t\tdata.image = new Image({url: data.url});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (this._opts.buffer) {\n\t\t\tfontBuffer.releaseBin(this.getHash());\n\t\t}\n\t\tthis.updateCache();\n\n\t\tthis._checkDeprecatedOpts(opts);\n\n\t\tif (\"padding\" in opts) {\n\t\t\tthis.style.padding = new Padding(opts.padding);\n\t\t}\n\n\t\tif (!dontCheck) {\n\t\t\tthis._restoreOpts();\n\t\t\tthis._checkOpts(opts);\n\t\t\tif (this._cacheUpdate) {\n\t\t\t\topts.hash = false;\n\t\t\t} else {\n\t\t\t\tsupr(this, \"updateOpts\", arguments);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\topts = supr(this, \"updateOpts\", arguments);\n\n\t\t(\"text\" in opts) && this.setText(opts.text);\n\t\t!dontCheck && this._textFlow.setOpts(this._opts);\n\n\t\treturn opts;\n\t};\n\n\tthis._updateCtx = function (ctx) {\n\t\tvar opts = this._opts;\n\n\t\tctx.textAlign = \"left\";\n\t\tctx.textBaseline = \"top\";\n\t\tctx.fillStyle = opts.color;\n\t\tctx.font = opts.fontWeight + \" \" + opts.size + \"px \" + opts.fontFamily;\n\t\tctx.lineWidth = this.getStrokeWidth();\n\t};\n\n\tthis._renderToCtx = function (ctx, offsetX, offsetY) {\n\t\tvar opts = this._opts;\n\t\tvar cache = this._textFlow.getCache();\n\t\tvar maxWidth = opts.autoFontSize ? this._textFlow.getActualWidth() : 1000000;\n\t\tvar item;\n\t\tvar word;\n\t\tvar color = opts.color;\n\t\tvar strokeColor = opts.strokeColor;\n\t\tvar shadowColor = opts.shadowColor;\n\t\tvar lineOffset = this.getStrokeWidth() * 0.5;\n\t\tvar x, y;\n\t\tvar i = cache.length;\n\n\t\tif (legacySettings.textViewColor && this.color) {\n\t\t\tcolor = this.color;\n\t\t}\n\n\t\tthis._updateCtx(ctx);\n\n\t\tif (strokeColor) {\n\t\t\tctx.strokeStyle = strokeColor;\n\t\t}\n\n\t\twhile (i) {\n\t\t\titem = cache[--i];\n\t\t\tword = item.word;\n\n\t\t\tx = offsetX + item.x;\n\t\t\ty = offsetY + item.y;\n\t\t\t\n\t\t\tvar emoticonData = (word[0] == '(') && opts.emoticonData && opts.emoticonData.data[word];\n\t\t\tif (emoticonData) {\n\t\t\t\t//ctx.fillStyle = color;\n\t\t\t\t//ctx.fillRect(x + lineOffset, y + lineOffset, opts.size, opts.size);\n\t\t\t\tif (emoticonData.image) {\n\t\t\t\t\temoticonData.image.render(ctx, x + lineOffset, y + lineOffset, opts.size, opts.size);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t} else {\n\t\t\t\tif (strokeColor) {\n\t\t\t\t\tctx.strokeText(word, x + lineOffset, y + lineOffset, maxWidth);\n\t\t\t\t}\n\t\t\t\tif (shadowColor) {\n\t\t\t\t\tvar shadowOffset = this._opts.shadowWidth || 0;\n\t\t\t\t\tctx.fillStyle = shadowColor;\n\t\t\t\t\tctx.fillText(word, x + lineOffset + shadowOffset, y + lineOffset + shadowOffset, maxWidth);\n\t\t\t\t}\n\n\t\t\t\tctx.fillStyle = color;\n\t\t\t\tctx.fillText(word, x + lineOffset, y + lineOffset, maxWidth);\n\t\t\t}\n\t\t}\n\t\tif (this._opts.debug) {\n\t\t\tctx.strokeStyle = 'black';\n\t\t\tctx.strokeRect(x, y, item.width, this.style.height - 2 * y);\n\t\t\tctx.strokeStyle = 'red';\n\t\t\tctx.strokeRect(0, 0, this.style.width, this.style.height);\n\t\t}\n\t};\n\n\tthis._renderBuffer = function (ctx) {\n\t\tvar fontBufferCtx = fontBuffer.getContext();\n\t\tvar offsetRect = this._textFlow.getOffsetRect();\n\t\tvar width = offsetRect.width;\n\t\tvar height = offsetRect.height;\n\t\tvar cache = this._textFlow.getCache();\n\t\tvar desc;\n\n\t\tif (width && height) {\n\t\t\tthis._opts.lineCount = cache[cache.length - 1].line;\n\t\t\toffsetRect.text = this._opts.text;\n\t\t\toffsetRect.textView = this;\n\t\t\t// When we support clearing offscreen buffers then this line can be activated instead of the next one...\n\t\t\t// desc = fontBuffer.getPositionForText(offsetRect) || fontBuffer.getPositionForText(offsetRect);\n\t\t\tdesc = fontBuffer.getPositionForText(offsetRect);\n\t\t\tif (desc != null) {\n\t\t\t\tif (this._cacheUpdate) {\n\t\t\t\t\tfontBufferCtx.clearRect(desc.x, desc.y, desc.width, desc.height);\n\t\t\t\t\tthis._renderToCtx(fontBufferCtx, desc.x - offsetRect.x, desc.y - offsetRect.y);\n\t\t\t\t}\n\t\t\t\tctx.drawImage(fontBuffer.getCanvas(), desc.x, desc.y, width, height, offsetRect.x, offsetRect.y, width, height);\n\t\t\t} else {\n\t\t\t\tthis._opts.buffer = false;\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.computeSize = function (ctx) {\n\t\tif (this._cacheUpdate) {\n\t\t\tthis._updateCtx(ctx);\n\t\t\tvar opts = this._opts;\n\t\t\tthis._textFlow.reflow(ctx, 1 + (opts.autoFontSize ? 4 : 0) + (opts.autoSize ? 2 : 0) + (opts.wrap ? 1 : 0));\n\t\t}\n\t}\n\n\tthis.render = function (ctx) {\n\t\tthis.computeSize(ctx);\n\t\tif (!this._textFlow.getCache().length) {\n\t\t\tthis._cacheUpdate = false;\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._opts.buffer) {\n\t\t\tthis._renderBuffer(ctx);\n\t\t} else {\n\t\t\tvar strokeWidthOffset = -this.getStrokeWidth()/2;\n\t\t\tthis._renderToCtx(ctx, strokeWidthOffset, strokeWidthOffset);\n\t\t}\n\n\t\tthis._cacheUpdate = false;\n\t};\n\n\tthis.clearBuffers = function () {\n\t\tfontBuffer.clearBuffer();\n\t};\n\n\tthis.getFontBuffer = function () {\n\t\treturn fontBuffer;\n\t};\n\n\tthis.setText = function (textData) {\n\t\tvar text = (textData != undefined) ? textData.toString() : \"\";\n\n\t\tvar emoticonData = this._opts.emoticonData;\n\t\tif (emoticonData) {\n\t\t\tfor (var key in emoticonData.map) {\n\t\t\t\tvar re = new RegExp(key.replace(/[-\\/\\\\^$*+?.()|[\\]{}]/g, '\\\\$&'), 'g');\n\t\t\t\ttext = text.replace(re, emoticonData.map[key]);\n\t\t\t}\n\t\t}\n\n\t\tif (this._opts.text !== text) {\n\t\t\tif (this._opts.buffer) {\n\t\t\t\tfontBuffer.releaseBin(this.getHash());\n\t\t\t}\n\n\t\t\tthis._restoreOpts();\n\t\t\tthis._opts.text = text;\n\t\t\tthis.updateCache();\n\t\t\tthis.needsRepaint();\n\t\t}\n\t};\n\n\tthis.getStrokeWidth = function () {\n\t\treturn this._opts.strokeColor ? this._opts.strokeWidth : 0;\n\t};\n\n\tthis.getText = function () {\n\t\treturn this._opts.text;\n\t};\n\n\tthis.getTag = function () {\n\t\treturn \"TextView\" + this.uid + \":\" + (this.tag || (this._opts.text || \"\").substring(0, 20));\n\t};\n\n\tthis.getOpts = function () {\n\t\treturn this._opts;\n\t};\n\n\tthis.getHash = function () {\n\t\tif (!this._hash) {\n\t\t\tthis._hash = \"\";\n\n\t\t\tvar opts = this._opts;\n\t\t\tvar i = hashItemsKeys.length;\n\t\t\twhile (i) {\n\t\t\t\tthis._hash += opts[hashItemsKeys[--i]];\n\t\t\t}\n\t\t}\n\t\treturn this._hash;\n\n\t\t// When we support clearing offscreen buffers we can use this instead of the code above...\n\t\t// return 't' + this._id;\n\t};\n\n\tthis.reflow = function () {\n\t\tthis._restoreOpts();\n\t\tthis._cacheUpdate = true;\n\t};\n});\n\nexports.clearBuffers = TextView.prototype.clearBuffers;\nexports.getFontBuffer = TextView.prototype.getFontBuffer;\n","pre":true},"sdk/timestep/ui/layout/Padding.js":{"path":"sdk/timestep/ui/layout/Padding.js","friendlyPath":"ui.layout.Padding","directory":"sdk/timestep/ui/layout/","filename":"Padding.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @package ui.layout.Padding;\n *\n * A simple class to express padding views.\n */\n\nPadding=__class__;exports = Padding=Padding(function Padding(){return this.init&&this.init.apply(this,arguments)},function () {\n\tthis.init =\n\tthis.update = function (args) {\n\t\tif (args instanceof Padding) {\n\t\t\tthis.top = args.top;\n\t\t\tthis.right = args.right;\n\t\t\tthis.bottom = args.bottom;\n\t\t\tthis.left = args.left;\n\t\t\treturn;\n\t\t}\n\t\tif (typeof args == 'string') {\n\t\t\targs = args.split(/\\s+/).map(function (piece) { return parseFloat(piece); });\n\t\t}\n\n\t\tif (!args || !args.length) { args = [args || 0]; }\n\n\t\tswitch (args.length) {\n\t\t\tcase 1:\n\t\t\t\tthis.left = this.right = this.top = this.bottom = args[0];\n\t\t\t\tbreak;\n\t\t\tcase 2:\n\t\t\t\tthis.top = this.bottom = args[0];\n\t\t\t\tthis.left = this.right = args[1];\n\t\t\t\tbreak;\n\t\t\tcase 3:\n\t\t\t\tthis.top = args[0];\n\t\t\t\tthis.left = this.right = args[1];\n\t\t\t\tthis.bottom = args[2];\n\t\t\t\tbreak;\n\t\t\tcase 4:\n\t\t\t\tthis.top = args[0];\n\t\t\t\tthis.right = args[1];\n\t\t\t\tthis.bottom = args[2];\n\t\t\t\tthis.left = args[3];\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tthis.getVertical = function () { return this.top + this.bottom; }\n\tthis.getHorizontal = function () { return this.left + this.right; }\n\n\tthis.toString = function () { return [this.top, this.right, this.bottom, this.left].join(' '); }\n});","pre":true},"sdk/timestep/ui/backend/canvas/util/FragmentBuffer.js":{"path":"sdk/timestep/ui/backend/canvas/util/FragmentBuffer.js","friendlyPath":".util.FragmentBuffer","directory":"sdk/timestep/ui/backend/canvas/util/","filename":"FragmentBuffer.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\njsio(\"import device\");\njsio(\"import .FragmentBin\");\njsio(\"import .SortedLinkedList as SortedList\");\n\nvar sdk_timestep_ui_backend_canvas_util_FragmentBuffer=__class__;var FragmentBuffer = exports=sdk_timestep_ui_backend_canvas_util_FragmentBuffer(function sdk_timestep_ui_backend_canvas_util_FragmentBuffer(){return this.init&&this.init.apply(this,arguments)},function () {\n\tvar debug = false;\n\tthis.init = function (opts) {\n\t\tthis.opts = merge(opts, {});\n\t\tthis._cache = {};\n\t\tthis._decriptions = [];\n\t\twindow.addEventListener('pageshow', bind(this, 'clearBuffer'), false);\n\t};\n\n\tvar sort = function (a, b) {\n\t\treturn a.size() > b.size();\n\t};\n\n\tthis._build = function () {\n\t    var Canvas = device.get('Canvas');\n        this._canvas = new Canvas({width: 1024, height: 1024});\n        this._ctx = this.getCanvas().getContext('2d', bind(this, function() {\n\t\t\tlogger.log(\"{fragment-buffer} Reacting to lost canvas by clearing text buffer\");\n\t\t\t// On canvas loss:\n\t\t\tthis._canvas = null;\n\t\t\tthis.clearBuffer();\n\t\t}));\n\t\tthis._ctx.clearRect(0, 0, 1024, 1024);\n\t\tthis._ctx.textAlign = 'left';\n\t\tthis._ctx.textBaseline = 'middle';\n\t\tthis._ctx.globalCompositeOperation = 'source-over';\n\t\tthis._binList = new SortedList(sort);\n\t\tvar head = new FragmentBin({\n\t\t\tx: 0,\n\t\t\ty: 0,\n\t\t\twidth: 1024,\n\t\t\theight: 1024\n\t\t});\n\t\tthis._binList.insert(head);\n\t\tdebug && window.open().document.body.appendChild(this._canvas);\n\t};\n\n\tthis.getCanvas = function () {\n\t\tif (!this._canvas) {\n\t\t\tthis._build();\n\t\t}\n\t\treturn this._canvas;\n\t};\n\n\tthis.getContext = function () {\n\t\tif (!this._ctx) {\n\t\t\tthis._build();\n\t\t}\n\t\treturn this._ctx;\n\t};\n\n\tthis.onGetHash = function (description) {\n\t\tthrow Error('onGetHash should be implemented.');\n\t};\n\n\tvar randomColor = function () {\n\t\tvar color = 'rgba(' +\n\t\t\t\t\t(Math.random()*255).toFixed() + ',' +\n\t\t\t\t\t(Math.random()*255).toFixed() + ',' +\n\t\t\t\t\t(Math.random()*255).toFixed() + ',' +\n\t\t\t\t\t'1)';\n\t\treturn color;\n\t};\n\n\tthis._insertText = function (description) {\n\t\tvar width = Math.ceil(description.width) + 1;\n\t\tvar height = Math.ceil(description.height) + 1;\n\t\tvar iter = this._binList.iterator();\n\t\tvar bin = null;\n\t\tvar found = false;\n\t\twhile (iter.hasNext() && !found) {\n\t\t\tbin = iter.next();\n\t\t\tif (!bin.filled && bin.width >= width && bin.height >= height) {\n\t\t\t\tfound = true;\n\t\t\t} else {\n\t\t\t\t//we don't want to insert in filled bins\n\t\t\t\tbin = null;\n\t\t\t}\n\t\t}\n\t\tif (bin) {\n\t\t\tnewBins = bin.split(width, height);\n\t\t\tfor (var i = 0; i < newBins.length; i++) {\n\t\t\t\tthis._binList.insert(newBins[i]);\n\t\t\t}\n\t\t} else {\n\t\t\tlogger.log('buffer full, further TextViews will not be cached');\n\t\t\t// When we support clearing buffers then this should be enabled again...\n\t\t\t// this.clearBuffer();\n\t\t}\n\n\t\treturn bin;\n\t};\n\n\t/**\n\t* debugging code to verify overlapping bins aren't created.\n\t*/\n\tvar rectIntersectsRect = function (r1, r2) {\n\t\tvar ax1 = r1.x;\n\t\tvar ax2 = r1.x + r1.width;\n\t\tvar ay1 = r1.y;\n\t\tvar ay2 = r1.y + r1.height;\n\t\tvar bx1 = r2.x;\n\t\tvar bx2 = r2.x + r2.width;\n\t\tvar by1 = r2.y;\n\t\tvar by2 = r2.y + r2.height;\n\t\treturn ax1 < bx2 && ax2 > bx1 && ay1 < by2 && ay2 > by1;\n\t};\n\n\tvar debugCheck = function (bin, list) {\n\t\tif (!bin) { return;}\n\t\tvar iter = list.iterator();\n\t\tvar ok = true;\n\t\twhile (iter.hasNext() && ok) {\n\t\t\tvar next = iter.next();\n\t\t\tok = next == bin || !rectIntersectsRect(next, bin);\n\t\t\tif (!ok) {\n\t\t\t\tlogger.error('rect overlaps');\n\t\t\t\tlogger.error(iter.current(), bin);\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.getPositionForText = function (description) {\n\t\tvar hash = this.onGetHash(description);\n\t\tvar width = Math.ceil(description.width) + 1;\n\n\t\tif (!this._cache[hash] && width > 0) {\n\t\t\tthis._cache[hash] = this._insertText(description, false);\n\t\t\tthis._decriptions.push(description);\n\t\t}\n\t\tif (debug && false) {\n\t\t\tdebugCheck(description, this._binList);\n\t\t}\n\t\treturn this._cache[hash];\n\t};\n\n\tthis.releaseBin = function (hash) {\n\t\tif (this._cache[hash]) {\n\t\t\t// When we support clearin buffers then this should be enabled again...\n\t\t\t// this._cache[hash].filled = false;\n\t\t\t// delete this._cache[hash];\n\t\t}\n\t};\n\n\tthis.clearBuffer = function () {\n\t\tthis._cache = {};\n\t\tthis._binList = new SortedList(sort);\n\t\tthis._binList.insert(new FragmentBin({\n\t\t\tx: 0,\n\t\t\ty: 0,\n\t\t\twidth: 1024,\n\t\t\theight: 1024\n\t\t}));\n\t\tthis._ctx && this._ctx.clearRect(0, 0, 1024, 1024);\n\t\twhile (this._decriptions.length) {\n\t\t\tthis._decriptions.pop().textView.updateCache();\n\t\t}\n\t};\n});\n","pre":true},"sdk/timestep/ui/backend/canvas/util/FragmentBin.js":{"path":"sdk/timestep/ui/backend/canvas/util/FragmentBin.js","friendlyPath":".FragmentBin","directory":"sdk/timestep/ui/backend/canvas/util/","filename":"FragmentBin.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * TextBins are used in the FragmentBuffer caching of TextViews.\n **/\nvar sdk_timestep_ui_backend_canvas_util_FragmentBin=__class__;var FragmentBin = exports=sdk_timestep_ui_backend_canvas_util_FragmentBin(function sdk_timestep_ui_backend_canvas_util_FragmentBin(){return this.init&&this.init.apply(this,arguments)},'TextBin', function (logger, supr) {\n\tthis.init = function (opts) {\n\t\tthis.width = opts.width;\n\t\tthis.height = opts.height;\n\t\tthis.x = opts.x;\n\t\tthis.y = opts.y;\n\t};\n\n\tthis.size = function () {\n\t\treturn this.width * this.height;\n\t};\n\n\tthis.split = function (x, y) {\n\t\tvar newBins = [this];\n\t\tif (this.width > 10 && this.height > 10) {\n\t\t\tif (this.height - y > 10) {\n\t\t\t\tvar bin1 = new FragmentBin({\n\t\t\t\t\tx: this.x,\n\t\t\t\t\ty: this.y + y,\n\t\t\t\t\twidth: this.width,\n\t\t\t\t\theight: this.height - y\n\t\t\t\t});\n\t\t\t\tnewBins.push(bin1);\n\t\t\t}\n\t\t\tif (this.width - x > 10) {\n\t\t\t\tvar bin2 = new FragmentBin({\n\t\t\t\t\tx: this.x + x,\n\t\t\t\t\ty: this.y,\n\t\t\t\t\twidth: this.width - x,\n\t\t\t\t\theight: y\n\t\t\t\t});\n\t\t\t\tnewBins.push(bin2);\n\t\t\t}\n\t\t}\n\t\tthis.width = x;\n\t\tthis.height = y;\n\t\tthis.filled = true;\n\n\t\treturn newBins;\n\t};\n});","pre":true},"sdk/timestep/ui/backend/canvas/util/SortedLinkedList.js":{"path":"sdk/timestep/ui/backend/canvas/util/SortedLinkedList.js","friendlyPath":".SortedLinkedList","directory":"sdk/timestep/ui/backend/canvas/util/","filename":"SortedLinkedList.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\nIterator=__class__;var Iterator=Iterator(function Iterator(){return this.init&&this.init.apply(this,arguments)},'Iterator', function (logger, supr) {\n\tthis.init = this.update = function (list) {\n\t\tthis._list = list || this._list;\n\t\tthis._current = list.head;\n\t\tthis._count = 0;\n\t};\n\n\tthis.next = function () {\n\t\tvar data = this._current.data;\n\t\tthis._current = this._current.next;\n\t\tthis._count++;\n\t\treturn data;\n\t};\n\n\tthis.current = function () {\n\t\treturn this._current.data;\n\t};\n\n\tthis.insertBefore = function (data) {\n\t\tthis._current.insertBefore(data);\t\n\t\tthis._list.count++;\n\t};\n\n\tthis.insertAfter = function (data) {\n\t\tthis._current.insertAfter(data);\t\n\t\tthis._list.count++;\n\t};\n\n\tthis.remove = function () {\n\t\tthis._current.prev.remove();\n\t\tif (this._current.prev == this._current) {\n\t\t\tthis._list.head = null;\n\t\t}\n\t\tthis._list.count--;\n\t};\n\n\tthis.hasNext = function () {\n\t\treturn this._count < this._list.count;\n\t};\n\n\tthis.atHead = function () {\n\t\treturn this._current == this._list.head;\n\t};\n});\n\nItem=__class__;var Item=Item(function Item(){return this.init&&this.init.apply(this,arguments)},'Item', function (logger, supr) {\n\tthis.init = function (data, prev, next) {\n\t\tthis.data = data;\n\t\tthis.prev = prev || this; \n\t\tthis.next = next || this;\n\t};\n\n\tthis.insertBefore = function (data) {\n\t\tvar item = new Item(data, this.prev, this);\n\t\tthis.prev.next = item;\n\t\tthis.prev = item;\n\t};\n\t\n\tthis.insertAfter = function (data) {\n\t\tvar item = new Item(data, this, this.next);\n\t\tthis.next.prev = item;\n\t\tthis.next = item;\n\t};\n\n\tthis.remove = function () {\n\t\tthis.prev.next = this.next;\n\t\tthis.next.prev = this.prev;\n\t};\n});\n\nvar sdk_timestep_ui_backend_canvas_util_SortedLinkedList=__class__;exports=sdk_timestep_ui_backend_canvas_util_SortedLinkedList(function sdk_timestep_ui_backend_canvas_util_SortedLinkedList(){return this.init&&this.init.apply(this,arguments)},'SortedLinkedList', function (logger, supr) {\n\tthis.init = function (comparator) {\n\t\tthis.head = null;\n\t\tthis._comparator = comparator;\n\t\tthis.count = 0;\n\t};\n\n\tthis.append = function (data) {\n\t\tthis._head.insertAfter(data);\n\t\tthis.count++;\n\t};\n\n\tthis.insert = function (data) {\n\t\tif (!this.head) {\n\t\t\tthis.head = new Item(data);\n\t\t\tthis.count++;\n\t\t} else {\n\t\t\tvar i = this.iterator();\n\t\t\tvar d = i.current();\t\n\t\t\tvar found = false;\n\t\t\twhile (i.hasNext() && !found) {\n\t\t\t\tfound = !this._comparator(data, d);\n\t\t\t\tif (!found) {\n\t\t\t\t\ti.next();\t\n\t\t\t\t\td = i.current();\n\t\t\t\t}\n\t\t\t}\n\t\t\ti.insertBefore(data);\n\t\t\tif (found && i.atHead()) {\n\t\t\t\tthis.head = this.head.prev;\t\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.iterator = function () {\n\t\treturn new Iterator(this);\n\t};\n});\n","pre":true},"sdk/timestep/ui/backend/canvas/TextFlow.js":{"path":"sdk/timestep/ui/backend/canvas/TextFlow.js","friendlyPath":".TextFlow","directory":"sdk/timestep/ui/backend/canvas/","filename":"TextFlow.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\njsio(\"import lib.Enum as Enum\");\njsio(\"import lib.PubSub as PubSub\");\n\nvar textFlowMode = Enum(\n\t\"NONE\",\n\t\"WRAP\",\n\t\"AUTOSIZE\",\n\t\"AUTOSIZE_WRAP\",\n\t\"AUTOFONTSIZE\",\n\t\"AUTOFONTSIZE_WRAP\",\n\t\"AUTOFONTSIZE_AUTOSIZE\",\n\t\"AUTOFONTSIZE_WRAP_AUTOSIZE\"\n);\n\nvar sdk_timestep_ui_backend_canvas_TextFlow=__class__;var TextFlow = exports=sdk_timestep_ui_backend_canvas_TextFlow(function sdk_timestep_ui_backend_canvas_TextFlow(){return this.init&&this.init.apply(this,arguments)},PubSub, function (supr) {\n\tthis.init = function (opts) {\n\t\tsupr(this, \"init\", arguments);\n\n\t\tthis._target = opts.target;\n\t\tthis._lineWidth = 0;\n\t\tthis._line = [];\n\t\tthis._lines = [];\n\n\t\tthis._cache = [];\n\t\tthis._cacheSize = 0;\n\n\t\tthis._maxWordWidth = 0;\n\t\tthis._maxWidth = 0;\n\t\tthis._maxHeight = 0;\n\n\t\tthis._heightFound = 0;\n\n\t\tthis._offsetRect = {x: 0, y: 0, width: 0, height: 0};\n\t};\n\n\tthis.measureText = function (ctx, text) {\n\t\tvar opts = this._opts;\n\t\t\n\t\tvar emoticonData = (text[0] == '(') && opts.emoticonData && opts.emoticonData.data[text];\n\t\tif (emoticonData) {\n\t\t\treturn opts.size;\n\t\t} else {\n\t\t\treturn ctx.measureText(text).width;\n\t\t}\n\t};\n\n\t// Split the text into a list containing the word and the width of the word...\n\tthis._lineSplit = function (ctx) {\n\t\tvar opts = this._opts;\n\t\tvar spaceWidth = opts.wrapCharacter ? 0 : ctx.measureText(\" \").width;\n\t\tvar text = opts.text || \"\";\n\t\tvar words = \n\t\t\t\topts.wrapCharacter\n\t\t\t\t\t? text.replace(/\\t/g, \" \").match(/\\S[。，]?|[\\n]/g) || []\n\t\t\t\t\t: (opts.wrap || (opts.horizontalAlign === \"justify\")) \n\t\t\t\t\t\t? (text.replace(/\\t/g, \" \").match(/\\S+|[\\n]| +(?= )/g) || [])\n\t\t\t\t\t\t: text.split(\"\\n\");\n\n\t\tvar word;\n\t\tvar splitWords = [];\n\t\tfor (i in words) {\n\t\t\tword = words[i];\n\t\t\tvar eStart = -1;\n\t\t\tvar lastSplit = 0;\n\t\t\tfor (var index = 0; index < word.length; index++) {\n\t\t\t\tvar c = word[index];\n\t\t\t\tif (c == '(') {\n\t\t\t\t\teStart = index;\n\t\t\t\t} else if (c == ')') {\n\t\t\t\t\tif (eStart > -1) {\n\t\t\t\t\t\t(eStart - lastSplit > 0) && splitWords.push(word.substring(lastSplit, eStart));\n\t\t\t\t\t\tsplitWords.push(word.substring(eStart, index + 1));\n\t\t\t\t\t\tlastSplit = index + 1;\n\t\t\t\t\t\teStart = -1;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (lastSplit < word.length) {\n\t\t\t\tsplitWords.push(word.substring(lastSplit));\n\t\t\t}\n\t\t}\n\t\twords = splitWords;\n\t\tvar currentWord = 0;\n\t\tvar wordCount = words.length;\n\n\t\tthis._line = [];\n\t\tthis._lineWidth = 0;\n\t\tthis._maxWordWidth = 0;\n\n\t\tif ((opts.hardWrap || exports.hardWrap) && (words.length === 1) && (this.measureText(ctx, text) > this.getActualWidth())) {\n\t\t\twords = [];\n\n\t\t\tvar actualWidth = this.getActualWidth();\n\t\t\tvar s = \"\";\n\t\t\tvar i = 0;\n\n\t\t\twhile (i < text.length) {\n\t\t\t\tvar c = text[i++];\n\t\t\t\tif (ctx.measureText(s + c).width >= actualWidth) {\n\t\t\t\t\twords.push(s);\n\t\t\t\t\ts = c;\n\t\t\t\t} else {\n\t\t\t\t\ts += c;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (s !== \"\") {\n\t\t\t\twords.push(s);\n\t\t\t}\n\t\t\twordCount = words.length;\n\t\t}\n\n\t\twhile (currentWord < wordCount) {\n\t\t\tword = {word: words[currentWord], width: this.measureText(ctx, words[currentWord]), line: 1};\n\t\t\tthis._line.push(word);\n\t\t\tthis._lineWidth += word.width + spaceWidth;\n\t\t\tthis._maxWordWidth = Math.max(this._maxWordWidth, word.width);\n\t\t\tcurrentWord++;\n\t\t}\n\t\tthis._lineWidth -= spaceWidth;\n\t};\n\n\tthis._measureWords = function (ctx) {\n\t\tvar spaceWidth = this._opts.wrapCharacter ? 0 : ctx.measureText(\" \").width;\n\t\tvar currentWord = 0;\n\t\tvar wordCount = this._line.length;\n\n\t\tthis._lineWidth = 0;\n\t\tthis._maxWordWidth = 0;\n\n\t\twhile (currentWord < wordCount) {\n\t\t\tword = this._line[currentWord];\n\t\t\tword.line = 1;\n\t\t\tword.width = this.measureText(ctx, word.word);\n\t\t\tthis._lineWidth += word.width + spaceWidth;\n\t\t\tthis._maxWordWidth = Math.max(this._maxWordWidth, word.width);\n\t\t\tcurrentWord++;\n\t\t}\n\t\tthis._lineWidth -= spaceWidth;\n\t};\n\n\t// Split the single line into multiple lines which fit into the available width...\n\tthis._wrap = function (ctx, width) {\n\t\tvar spaceWidth = this._opts.wrapCharacter ? 0 : ctx.measureText(\" \").width;\n\t\tvar word;\n\t\tvar currentWidth = 0;\n\t\tvar lines = [];\n\t\tvar line = [];\n\t\tvar s = \"\";\n\n\t\tthis._lines = lines;\n\t\tthis._maxWidth = 0;\n\n\t\tvar currentWord = 0;\n\t\tvar wordCount = this._line.length;\n\n\t\tif (this._opts.horizontalAlign === \"justify\") {\n\t\t\twhile (currentWord < wordCount) {\n\t\t\t\tword = this._line[currentWord++];\n\t\t\t\tcurrentWidth += word.width + spaceWidth;\n\t\t\t\tif (word.word === \"\\n\") {\n\t\t\t\t\tlines.push(line);\n\t\t\t\t\tline = [];\n\t\t\t\t\tcurrentWidth = 0;\n\t\t\t\t} else if (currentWidth > width) {\n\t\t\t\t\tline.length && lines.push(line);\n\t\t\t\t\tline = [word];\n\t\t\t\t\tcurrentWidth = word.width + spaceWidth;\n\t\t\t\t} else {\n\t\t\t\t\tline.push(word);\n\t\t\t\t}\n\t\t\t}\n\t\t\tline.length && lines.push(line);\n\t\t} else {\n\t\t\t// Note: this algorithm isn't 100% accurate because we are going\n\t\t\t// to use the cumulative width of the line (sum up widths of all\n\t\t\t// measured words plus space widths), which on some platforms will\n\t\t\t// actually be slightly longer than the actual line length.  Usually\n\t\t\t// we're only off by a few pixels, so it doesn't matter.  However,\n\t\t\t// if we remeasured each line after computing the full line length,\n\t\t\t// we'd end up with a shorter line than we expected, and if we then\n\t\t\t// resize our view to fit the width and try to wrap text again, we'd\n\t\t\t// find that the width of the line is now longer than the width of \n\t\t\t// the view, resulting in the line wrapping shorter than the previous\n\t\t\t// time (unnecessarily).  Additionally, this extra measure is \n\t\t\t// expensive, so we'll just use our rough approximation. \n\t\t\twhile (currentWord < wordCount) {\n\t\t\t\tword = this._line[currentWord++];\n\t\t\t\t// currentWidth = ctx.measureText(s).width;\n\t\t\t\tif (word.word === \"\\n\") {\n\t\t\t\t\t//lines.push([{word: s, width: currentWidth, line: lines.length}]);\n\t\t\t\t\t//s = \"\";\n\t\t\t\t\tlines.push(line);\n\t\t\t\t\tcurrentWidth = 0;\n\t\t\t\t} else {\n\t\t\t\t\tvar isLineEmpty = !line.length;\n\t\t\t\t\t//var isLineEmpty = !s.length;\n\t\t\t\t\tvar hasSpace = !isLineEmpty && !this._opts.wrapCharacter;\n\t\t\t\t\tvar offset = hasSpace ? spaceWidth : 0;\n\t\t\t\t\tif (currentWidth + word.width + offset > width) {\n\t\t\t\t\t\tvar wordWidth = word.width;\n\n\t\t\t\t\t\t// if word is longer than the entire line width\n\t\t\t\t\t\tif (wordWidth > width) {\n\t\t\t\t\t\t\tvar current = word.word;\n\n\t\t\t\t\t\t\t// split word into lines\n\t\t\t\t\t\t\tvar wordPiece = \"\";\n\t\t\t\t\t\t\tfor (var i = 0, n = current.length; i < n; ++i) {\n\t\t\t\t\t\t\t\tif ((isLineEmpty && !wordPiece) || this.measureText(ctx, wordPiece + current[i]) + offset + currentWidth <= width) {\n\t\t\t\t\t\t\t\t\twordPiece += current[i];\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t/*\n\t\t\t\t\t\t\t\t\tvar line = s + (hasSpace ? \" \" : \"\") + wordPiece;\n\t\t\t\t\t\t\t\t\tcurrentWidth = ctx.measureText(line).width;\n\t\t\t\t\t\t\t\t\tlines.push([{word: line, width: currentWidth, line: lines.length}]);\n\t\t\t\t\t\t\t\t\t*/\n\t\t\t\t\t\t\t\t\tcurrentWidth = this.measureText(ctx, wordPiece);\n\t\t\t\t\t\t\t\t\tline.push({word: wordPiece, width: currentWidth, line: lines.length});\n\t\t\t\t\t\t\t\t\tlines.push(line);\n\t\t\t\t\t\t\t\t\tline = [];\n\t\t\t\t\t\t\t\t\tcurrentWidth = 0;\n\t\t\t\t\t\t\t\t\toffset = 0;\n\t\t\t\t\t\t\t\t\t//s = \"\";\n\t\t\t\t\t\t\t\t\tisLineEmpty = true;\n\t\t\t\t\t\t\t\t\thasSpace = false;\n\t\t\t\t\t\t\t\t\twordPiece = current[i];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (wordPiece) {\n\t\t\t\t\t\t\t\t/*\n\t\t\t\t\t\t\t\tvar line = s + (hasSpace ? \" \" : \"\") + wordPiece;\n\t\t\t\t\t\t\t\tcurrentWidth = ctx.measureText(line).width;\n\t\t\t\t\t\t\t\tlines.push([{word: line, width: currentWidth, line: lines.length}]);\n\t\t\t\t\t\t\t\t*/\n\t\t\t\t\t\t\t\tcurrentWidth = this.measureText(ctx, wordPiece);\n\t\t\t\t\t\t\t\tline.push({word: wordPiece, width: currentWidth, line: lines.length});\n\t\t\t\t\t\t\t\t//lines.push(line);\n\t\t\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t//(!isLineEmpty) && lines.push([{word: s, width: currentWidth, line: lines.length}]);\n\t\t\t\t\t\t\t(!isLineEmpty) && lines.push(line);\n\t\t\t\t\t\t\t//s = word.word;\n\t\t\t\t\t\t\tline = [word];\n\t\t\t\t\t\t\tcurrentWidth = word.width;\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tline.push(word);\n\t\t\t\t\t\t//s += (hasSpace ? \" \" : \"\") + word.word;\n\t\t\t\t\t\tcurrentWidth += word.width + offset;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t//if (s !== \"\") {\n\t\t\tif (line.length > 0) {\n\t\t\t\t//lines.push([{word: s, width: currentWidth, line: lines.length}]);\n\t\t\t\tlines.push(line);\n\t\t\t}\n\t\t}\n\t};\n\n\tthis._getLineSize = function (lineCount) {\n\t\tvar opts = this._opts;\n\t\treturn ((lineCount <= 1) ? 1 : opts.lineHeight) * opts.size;\n\t};\n\n\t// Calculate the position of each word on the line...\n\tthis._wordFlow = function (ctx) {\n\t\tvar spaceWidth = this._opts.wrapCharacter ? 0 : ctx.measureText(\" \").width;\n\t\tvar lines = this._lines;\n\n\t\tthis._cache = [];\n\t\tthis._cacheSize = 0;\n\n\t\tthis._maxWidth = 0;\n\t\tthis._maxHeight = 0;\n\n\t\tvar currentLine = 0;\n\t\tvar lineCount = lines.length;\n\t\tvar lineSize = this._getLineSize(lineCount);\n\t\tvar y = 0;\n\n\t\twhile (currentLine < lineCount) {\n\t\t\tvar line = lines[currentLine++];\n\t\t\tvar currentWord = 0;\n\t\t\tvar wordCount = line.length;\n\t\t\tvar x = 0;\n\n\t\t\twhile (currentWord < wordCount) {\n\t\t\t\tvar word = line[currentWord++];\n\n\t\t\t\tword.x = x;\n\t\t\t\tword.y = y;\n\t\t\t\tword.line = currentLine;\n\t\t\t\tthis._cache[this._cacheSize++] = word;\n\n\t\t\t\tx += word.width + spaceWidth;\n\t\t\t}\n\n\t\t\ty += lineSize;\n\t\t\tx -= spaceWidth;\n\n\t\t\tthis._maxWidth = Math.max(this._maxWidth, x);\n\t\t\tthis._maxHeight = Math.max(this._maxHeight, y);\n\t\t}\n\t};\n\n\t// Check if the given width fits into the available size, if not the resize the font...\n\tthis._checkWidth = function (ctx, width) {\n\t\tif (this._opts.text === \"\") {\n\t\t\treturn false;\n\t\t}\n\t\tvar opts = this._opts;\n\n\t\tif (width > this.getActualWidth()) {\n\t\t\tvar size = (opts.size * this._target.style.width / width) | 0;\n\t\t\t(opts.size !== size) && this.publish(\"ChangeSize\", size, ctx);\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t};\n\n\tthis._checkHeight = function (ctx, loSize, hiSize, cb) {\n\t\tif (this._opts.text === \"\") {\n\t\t\treturn;\n\t\t}\n\t\tif (Math.abs(hiSize - loSize) < 2) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar pivot = Math.max((loSize + hiSize) >> 1, 1);\n\t\tthis.publish(\"ChangeSize\", pivot, ctx);\n\t\tcb();\n\t\tif (pivot === 1) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar opts = this._opts;\n\t\tvar lineSize = this._getLineSize(this._lines.length);\n\t\tif ((this._lines.length * lineSize > this.getActualHeight())) {\n\t\t\tthis._checkHeight(ctx, loSize, pivot, cb);\n\t\t} else {\n\t\t\tthis._heightFound = opts.size;\n\t\t\tthis._checkHeight(ctx, pivot, hiSize, cb);\n\t\t}\n\t};\n\n\tthis._horizontalAlign = function (ctx) {\n\t\tvar cache = this._cache;\n\t\tvar spaceWidth = this._opts.wrapCharacter ? 0 : ctx.measureText(\" \").width;\n\t\tvar lastLineSpaceWidth = spaceWidth;\n\t\tvar lastLine = cache[cache.length - 1].line;\n\t\tvar paddingLeft = this.getPaddingLeft();\n\t\tvar div = {left: -1, center: 2, right: 1, justify: 3}[this._opts.horizontalAlign];\n\t\tvar actualWidth = this.getActualWidth();\n\t\tvar width;\n\t\tvar offset;\n\t\tvar line;\n\t\tvar x;\n\n\t\tif (!cache.length) {\n\t\t\treturn;\n\t\t}\n\t\tif (div === 3) {\n\t\t\tspaceWidth = 0;\n\t\t}\n\n\t\tvar firstWordOnLine;\n\t\tvar currentWord = 0;\n\t\tvar wordCount = cache.length;\n\t\twhile (currentWord < wordCount) {\n\t\t\tfirstWordOnLine = currentWord;\n\t\t\tline = cache[currentWord].line;\n\t\t\twidth = 0;\n\t\t\twhile ((currentWord < wordCount) && (line === cache[currentWord].line)) {\n\t\t\t\twidth += cache[currentWord].width + spaceWidth;\n\t\t\t\tcurrentWord++;\n\t\t\t}\n\t\t\tif (div === -1) { // left...\n\t\t\t\twhile (firstWordOnLine < currentWord) {\n\t\t\t\t\tcache[firstWordOnLine++].x += paddingLeft;\n\t\t\t\t}\n\t\t\t} else if (div === 3) { // justify...\n\t\t\t\toffset = (line < cache[cache.length - 1].line) ? (actualWidth - width) / (currentWord - firstWordOnLine - 1) : spaceWidth;\n\t\t\t\tx = paddingLeft;\n\t\t\t\twhile (firstWordOnLine < currentWord) {\n\t\t\t\t\tcache[firstWordOnLine].x = x;\n\t\t\t\t\tx += cache[firstWordOnLine].width + offset;\n\t\t\t\t\tif (line === lastLine) {\n\t\t\t\t\t\tx += lastLineSpaceWidth;\n\t\t\t\t\t}\n\t\t\t\t\tfirstWordOnLine++;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\toffset = (actualWidth - width + spaceWidth) / div + paddingLeft;\n\t\t\t\twhile (firstWordOnLine < currentWord) {\n\t\t\t\t\tcache[firstWordOnLine++].x += offset;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n\n\tthis._verticalAlign = function () {\n\t\tvar lineCount = this._lines.length;\n\t\tvar div = {top: -1, middle: 2, bottom: 1}[this._opts.verticalAlign];\n\t\tvar cache = this._cache;\n\t\tvar actualHeight = this.getActualHeight();\n\t\tvar offset;\n\t\tvar i = cache.length;\n\n\t\tif (!cache.length) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (div === -1) {\n\t\t\toffset = this.getPaddingTop();\n\t\t} else {\n\t\t\tvar lineSize = this._getLineSize(lineCount);\n\t\t\toffset = (actualHeight - lineCount * lineSize) / div + this.getPaddingTop();\n\t\t}\n\t\twhile (i) {\n\t\t\tcache[--i].y += offset;\n\t\t}\n\n\t\tthis._offsetRect.y += offset;\n\t};\n\n\tthis.reflow = function (ctx, mode) {\n\t\tvar opts = this._opts;\n\t\tvar actualWidth = this.getActualWidth();\n\t\tvar actualHeight = this.getActualHeight();\n\n\t\tthis._lineSplit(ctx);\n\n\t\tswitch (mode) {\n\t\t\tcase textFlowMode.NONE:\n\t\t\t\tthis._lines = [this._line];\n\t\t\t\tthis._wordFlow(ctx);\n\t\t\t\tbreak;\n\n\t\t\tcase textFlowMode.WRAP:\n\t\t\t\tthis._wrap(ctx, actualWidth);\n\t\t\t\tthis._wordFlow(ctx);\n\t\t\t\tbreak;\n\n\t\t\tcase textFlowMode.AUTOSIZE:\n\t\t\tcase textFlowMode.AUTOFONTSIZE_AUTOSIZE:\n\t\t\t\tthis._lines = [this._line];\n\t\t\t\tthis._wordFlow(ctx);\n\n\t\t\t\tif (this._opts.fitWidth || actualWidth < this._maxWidth) {\n\t\t\t\t\tthis.publish(\"ChangeWidth\", this._maxWidth + this.getHorizontalPadding());\n\t\t\t\t}\n\n\t\t\t\tif (this._opts.fitHeight || actualHeight < this._maxHeight) {\n\t\t\t\t\tthis.publish(\"ChangeHeight\", this._maxHeight + this.getVerticalPadding());\n\t\t\t\t}\n\t\t\t\tbreak;\n\n\t\t\tcase textFlowMode.AUTOSIZE_WRAP:\n\t\t\t\tthis._wrap(ctx, actualWidth);\n\t\t\t\tthis._wordFlow(ctx);\n\n\t\t\t\tif (this._opts.fitWidth || actualWidth < this._maxWidth) {\n\t\t\t\t\tthis.publish(\"ChangeWidth\", this._maxWidth + this.getHorizontalPadding());\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif (this._opts.fitHeight  || actualHeight < this._maxHeight) {\n\t\t\t\t\tthis.publish(\"ChangeHeight\", this._maxHeight + this.getVerticalPadding());\n\t\t\t\t}\n\n\t\t\t\tbreak;\n\n\t\t\tcase textFlowMode.AUTOFONTSIZE:\n\t\t\t\tthis._checkWidth(ctx, this._lineWidth) && this._lineSplit(ctx);\n\t\t\t\tthis._lines = [this._line];\n\t\t\t\t// Don't use the lineHeight here because it's a single line\n\t\t\t\tif (opts.allowVerticalSizing && opts.size > this.getActualHeight()) {\n\t\t\t\t\tvar cb = bind(\n\t\t\t\t\t\tthis,\n\t\t\t\t\t\tfunction () {\n\t\t\t\t\t\t\tthis._measureWords(ctx);\n\t\t\t\t\t\t\tthis._wordFlow(ctx);\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\n\t\t\t\t\tthis._checkHeight(ctx, 1, opts.size, cb);\n\t\t\t\t\tthis.publish(\"ChangeSize\", this._heightFound, ctx);\n\t\t\t\t\tcb();\n\t\t\t\t} else {\n\t\t\t\t\tthis._wordFlow(ctx);\n\t\t\t\t}\n\t\t\t\tbreak;\n\n\t\t\tcase textFlowMode.AUTOFONTSIZE_WRAP:\n\t\t\t\tthis._wrap(ctx, actualWidth);\n\t\t\t\tthis._wordFlow(ctx);\n\n\t\t\t\tvar lineCount = this._lines.length;\n\t\t\t\tvar lineSize = this._getLineSize(lineCount);\n\t\t\t\tif (opts.allowVerticalSizing && lineCount * lineSize > this.getActualHeight()) {\n\t\t\t\t\tvar cb = bind(\n\t\t\t\t\t\tthis,\n\t\t\t\t\t\tfunction () {\n\t\t\t\t\t\t\tthis._measureWords(ctx);\n\t\t\t\t\t\t\tthis._wrap(ctx, actualWidth);\n\t\t\t\t\t\t\tthis._wordFlow(ctx);\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\n\t\t\t\t\tthis._checkHeight(ctx, 1, opts.size, cb);\n\t\t\t\t\tthis.publish(\"ChangeSize\", this._heightFound, ctx);\n\t\t\t\t\tcb();\n\t\t\t\t}\n\n\t\t\t\tbreak;\n\n\t\t\tcase textFlowMode.AUTOFONTSIZE_WRAP_AUTOSIZE:\n\t\t\t\tthis._wrap(ctx, actualWidth);\n\t\t\t\tthis._wordFlow(ctx);\n\n\t\t\t\t(actualHeight < this._maxHeight) && this.publish(\"ChangeHeight\", this._maxHeight + this.getVerticalPadding());\n\t\t\t\tbreak;\n\t\t}\n\n\t\tvar cache = this._cache;\n\t\tvar lastCacheItem = cache[cache.length - 1];\n\n\t\tif (!cache.length) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar strokeWidth = this._target.getStrokeWidth();\n\t\tvar lineSize = Math.ceil(opts.size * opts.lineHeight + strokeWidth);\n\t\tthis._offsetRect.x = this.getPaddingLeft();\n\t\tthis._offsetRect.y = this.getPaddingTop();\n\t\tthis._offsetRect.width = this.getActualWidth();\n\t\tthis._offsetRect.height = lastCacheItem.line * lineSize;\n\n\t\tthis._horizontalAlign(ctx);\n\t\tthis._verticalAlign();\n\n\t\tif (lastCacheItem.line === 1) {\n\t\t\tthis._offsetRect.x = cache[0].x;\n\t\t\tthis._offsetRect.width = lastCacheItem.x + lastCacheItem.width - cache[0].x;\n\t\t}\n\n\t\tthis._offsetRect.width += strokeWidth;\n\t};\n\n\tthis.setOpts = function (opts) {\n\t\tthis._opts = opts;\n\t};\n\n\tthis.getCache = function () {\n\t\treturn this._cache;\n\t};\n\n\tthis.getHorizontalPadding = function () {\n\t\tvar padding = this._target.style.padding;\n\n\t\treturn padding.left + padding.right;\n\t};\n\n\tthis.getPaddingLeft = function () {\n\t\treturn this._target.style.padding.left;\n\t};\n\n\tthis.getActualWidth = function () {\n\t\treturn this._target.style.width - this.getHorizontalPadding();\n\t};\n\n\tthis.getVerticalPadding = function () {\n\t\tvar padding = this._target.style.padding;\n\n\t\treturn padding.top + padding.bottom;\n\t};\n\n\tthis.getPaddingTop = function () {\n\t\treturn this._target.style.padding.top;\n\t};\n\n\tthis.getActualHeight = function () {\n\t\treturn this._target.style.height - this.getVerticalPadding();\n\t};\n\n\tthis.getOffsetRect = function () {\n\t\treturn this._offsetRect;\n\t};\n});\n","pre":true},"sdk/timestep/ui/legacySettings.js":{"path":"sdk/timestep/ui/legacySettings.js","friendlyPath":"...legacySettings","directory":"sdk/timestep/ui/","filename":"legacySettings.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\nexports = {\n\tdisableVerticalAutoSize: false,\n\ttextViewColor: false // use this.color in TextView if true\n}\n","pre":true},"sdk/timestep/ui/backend/canvas/ViewDebugger.js":{"path":"sdk/timestep/ui/backend/canvas/ViewDebugger.js","friendlyPath":".backend.canvas.ViewDebugger","directory":"sdk/timestep/ui/backend/canvas/","filename":"ViewDebugger.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\njsio(\"import std.js as JS\");\n\nvar sdk_timestep_ui_backend_canvas_ViewDebugger=__class__;exports=sdk_timestep_ui_backend_canvas_ViewDebugger(function sdk_timestep_ui_backend_canvas_ViewDebugger(){return this.init&&this.init.apply(this,arguments)},function () {\n\t\n\tthis.init = function (target, opts) {\n\t\tthis._target = target;\n\t\tthis._opts = opts = JS.merge(opts, {\n\t\t\ttrackClicks: false,\n\t\t\toutline: false,\n\t\t\tflash: false\n\t\t});\n\t\t\n\t\tthis.outline = opts.outline;\n\t\tthis.trackClicks = opts.trackClicks;\n\t\tthis.flash = opts.flash;\n\t\t\n\t\tthis._flashState = 0;\n\t\tthis._nextFlash = 0;\n\t}\n\t\n\tthis.preRender = function (ctx) {\n\t\tif (!this._time) { this._time = +new Date(); }\n\t\tvar prevTime = this._time;\n\t\tthis._time = +new Date();\n\t\tthis._dt = this._time - prevTime;\n\t\t\n\t\tvar s = this._target.style;\n\t\tif (this.outline) {\n\t\t\tctx.save();\n\t\t\tctx.globalAlpha = 0.2;\n\t\t\tctx.strokeStyle = 'black';\n\t\t\tctx.lineWidth = 1.0;\n\t\t\tctx.strokeRect(0, 0, s.width, s.height);\n\t\t\tctx.restore();\n\t\t}\n\t}\n\t\n\tthis.postRender = function (ctx) {\n\t\t\tvar s = this._target.style;\n\n\t\tvar t = this._target;\n\t\tif (this.trackClicks) {\n\t\t\tfor (var i = t._clicks.length - 1; i >= 0; --i) {\n\t\t\t\tvar c = t._clicks[i];\n\t\t\t\tctx.setFillStyle('rgba(0, 0, 0, ' + c.o + ')');\n\t\t\t\tc.o -= 0.4 * this._dt / 1000;\n\t\t\t\tif (c.o > 0) {\n\t\t\t\t\tctx.circle(c.x, c.y, 15);\n\t\t\t\t\tctx.fill();\n\t\t\t\t} else {\n\t\t\t\t\tt._clicks.splice(i, 1);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t\n\t\tif (this.flash) {\n\t\t\tswitch(this._flashState) {\n\t\t\t\tcase 0:\n\t\t\t\t\tctx.setFillStyle('rgba(0, 0, 0, 0.5)');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 1:\n\t\t\t\t\tctx.setFillStyle('rgba(0, 0, 0, 0)');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 2:\n\t\t\t\t\tctx.setFillStyle('rgba(255, 255, 255, 0.5)');\n\t\t\t\t\tbreak;\n\t\t\t\tcase 3:\n\t\t\t\t\tctx.setFillStyle('rgba(0, 0, 0, 0)');\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\t\n\t\t\tvar now = +new Date();\n\t\t\tif (now > this._nextFlash) {\n\t\t\t\tthis._flashState = (this._flashState + 1) % 4;\n\t\t\t\tthis._nextFlash = now + 300;\n\t\t\t}\n\t\t\t\n\t\t\tctx.fillRect(0, 0, t.style.width, t.style.height);\n\t\t}\n\t}\n});\n","pre":true},"sdk/timestep/ui/init.js":{"path":"sdk/timestep/ui/init.js","friendlyPath":"ui.init","directory":"sdk/timestep/ui/","filename":"init.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\njsio(\"import .View\");\njsio(\"import .layout.BackingExtension\");\njsio(\"import .Engine\");","pre":true},"sdk/timestep/ui/layout/BackingExtension.js":{"path":"sdk/timestep/ui/layout/BackingExtension.js","friendlyPath":".layout.BackingExtension","directory":"sdk/timestep/ui/layout/","filename":"BackingExtension.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\njsio(\"import ..View\");\njsio(\"import ..backend.strPad as strPad\");\njsio(\"import ..backend.BaseBacking\");\njsio(\"import .BoxLayout\");\njsio(\"import .LinearLayout\");\njsio(\"import .Padding\");\n\njsio(\"import util.setProperty\");\n\nvar layoutProps = {\n\t\t'layout': {value: false, cb: '_onSetLayout'},\n\t\t'inLayout': {value: true, cb: '_onInLayout'},\n\t\t'order': {value: 0, cb: '_onOrder'},\n\t\t'direction': {value: 'down', cb: '_onLayoutChange'},\n\t\t'flex': {value: 0, cb: '_onLayoutChange'},\n\t\t'halign': {value: 'start'}, 'halignSelf': {value: undefined},\n\t\t'valign': {value: 'start'}, 'valignSelf': {value: undefined},\n\n\t\t'centerX': {value: false},\n\t\t'centerY': {value: false},\n\n\t\t'top': {value: undefined, cb: '_onLayoutChange'},\n\t\t'right': {value: undefined, cb: '_onLayoutChange'},\n\t\t'bottom': {value: undefined, cb: '_onLayoutChange'},\n\t\t'left': {value: undefined, cb: '_onLayoutChange'},\n\n\t\t'justifyContent': {value: 'start', cb: '_onLayoutChange'},\n\t\t'sizeContainerToFit': {value: false, cb: '_onLayoutChange'},\n\n\t\t'minWidth': {value: undefined, cb: '_onLayoutChange'},\n\t\t'minHeight': {value: undefined, cb: '_onLayoutChange'},\n\t\t'maxWidth': {value: undefined, cb: '_onLayoutChange'},\n\t\t'maxHeight': {value: undefined, cb: '_onLayoutChange'},\n\n\t\t'layoutWidth': {value: undefined, cb: '_onLayoutChange'},\n\t\t'layoutHeight': {value: undefined, cb: '_onLayoutChange'},\n\n\t\t'fixedAspectRatio': {value: false, cb: '_onFixedAspectRatio'},\n\t\t'aspectRatio': {value: null, cb: '_onLayoutChange'},\n\n\t\t'margin': {value: null, cb: '_onMarginChange'}\n\t};\n\nfor (var key in layoutProps) {\n\tbackend.BaseBacking.addProperty(key, layoutProps[key]);\n}\n\nutil.setProperty(backend.BaseBacking.prototype, 'padding', {\n\tget: function () {\n\t\treturn this._padding || (this._padding = new Padding());\n\t},\n\tset: function (value) {\n\t\tif (this._padding) {\n\t\t\tthis._padding.update(value);\n\t\t} else {\n\t\t\tthis._padding = new Padding(value);\n\t\t}\n\n\t\tthis._onLayoutChange();\n\t}\n});\n\nView.addExtension({\n\textend: function (ViewBacking) {\n\n\t\tvar proto = ViewBacking.prototype;\n\n\t\tproto._sortOrder = strPad.initialValue;\n\t\tproto._onOrder = function (_, order) {\n\t\t\tthis._sortOrder = strPad.pad(order);\n\t\t\tthis._onLayoutChange();\n\t\t};\n\t\t\n\t\tproto._onMarginChange = function (key, value) {\n\t\t\tif (this._cachedMargin) {\n\t\t\t\tthis._cachedMargin.update(value);\n\t\t\t} else {\n\t\t\t\tthis._cachedMargin = new Padding(value);\n\t\t\t}\n\n\t\t\tthis.top = this._cachedMargin.top;\n\t\t\tthis.bottom = this._cachedMargin.bottom;\n\t\t\tthis.left = this._cachedMargin.left;\n\t\t\tthis.right = this._cachedMargin.right;\n\n\t\t\tthis._onLayoutChange();\n\t\t}\n\n\t\tproto._onFixedAspectRatio = function (key, value) {\n\t\t\tif (value) {\n\t\t\t\tthis.updateAspectRatio();\n\t\t\t}\n\t\t}\n\n\t\tproto.updateAspectRatio = function (w, h) {\n\t\t\tthis.aspectRatio = (w || this.width) / (h || this.height);\n\t\t}\n\n\t\tproto.enforceAspectRatio = function(iw, ih, isTimeout) {\n\t\t\tif (iw && ih) {\n\t\t\t\tthis.updateAspectRatio(iw, ih);\n\t\t\t}\n\t\t\tvar parent = this._view.getSuperview();\n\t\t\tvar opts = this._view._opts;\n\t\t\tiw = iw || opts.width;\n\t\t\tih = ih || opts.height;\n\t\t\tif (opts.width) {\n\t\t\t\tiw = opts.width;\n\t\t\t\tih = opts.width / this.aspectRatio;\n\t\t\t}\n\t\t\telse if (opts.height) {\n\t\t\t\tih = opts.height;\n\t\t\t\tiw = opts.height * this.aspectRatio;\n\t\t\t}\n\t\t\telse if (parent) {\n\t\t\t\tif (this.layoutWidth && parent.style.width) {\n\t\t\t\t\tiw = parent.style.width * parseFloat(this.layoutWidth) / 100;\n\t\t\t\t\tih = iw / this.aspectRatio;\n\t\t\t\t}\n\t\t\t\telse if (this.layoutHeight && parent.style.height) {\n\t\t\t\t\tih = parent.style.height * parseFloat(this.layoutHeight) / 100;\n\t\t\t\t\tiw = ih * this.aspectRatio;\n\t\t\t\t}\n\t\t\t\telse if (this.flex && parent.style.direction == 'horizontal' && this.width) {\n\t\t\t\t\tiw = this.width;\n\t\t\t\t\tih = iw / this.aspectRatio;\n\t\t\t\t}\n\t\t\t\telse if (this.flex && parent.style.direction == 'vertical' && this.height) {\n\t\t\t\t\tih = this.height;\n\t\t\t\t\tiw = ih * this.aspectRatio;\n\t\t\t\t}\n\t\t\t\telse if (!isTimeout) {\n\t\t\t\t\tsetTimeout(bind(this, 'enforceAspectRatio', iw, ih, true), 0);\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis.width = iw;\n\t\t\tthis.height = ih;\n\t\t};\n\n\t\tproto._onSetLayout = function (key, which) {\n\t\t\tswitch (which) {\n\t\t\t\tcase 'linear':\n\t\t\t\t\tthis._view.__layout = new LinearLayout({view: this._view});\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'box':\n\t\t\t\t\tthis._view.__layout = new BoxLayout({view: this._view});\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t};\n\n\t\tproto._onInLayout = function (key, value) {\n\t\t\tvar layout = this._superview && this._superview.__layout;\n\t\t\tif (layout) {\n\t\t\t\tif (value) {\n\t\t\t\t\tlayout.add(this._view);\n\t\t\t\t} else {\n\t\t\t\t\tlayout.remove(this._view);\n\t\t\t\t\tthis._view.needsReflow();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t\n\t\t// var isPercent = /%$/;\n\t\t// proto._onLayoutSizeChange = function (key, value, oldValue) {\n\t\t// \t// Subscribes a view to parent resize events when the view is in the hierarchy and\n\t\t// \t// contains a percentage height or width.\n\t\t// \t//\n\t\t// \t// NOTE: a view only sets up resize listeners once -- if layoutWidth is set to a percent and then reset\n\t\t// \t// to not have a percent, it will still get reflow events when its superview resizes.  We could\n\t\t// \t// remove the listeners once the view no longer has percentages.\n\t\t// \tif (!this._hasResizeListeners && (isPercent.test(this._layoutWidth) || isPercent.test(this._layoutHeight))) {\n\t\t// \t\tthis._hasResizeListeners = true;\n\t\t// \t\tthis._view.on('ViewAdded', bind(this, function () {\n\t\t// \t\t\tif (this.__superviewResize) {\n\t\t// \t\t\t\tthis.__superviewResize();\n\t\t// \t\t\t}\n\t\t\t\t\t\n\t\t// \t\t\tvar superview = this._view.getSuperview();\n\t\t// \t\t\tvar onResize = bind(this._view, 'needsReflow');\n\t\t// \t\t\tsuperview.on('Resize', onResize);\n\t\t\t\t\t\n\t\t// \t\t\tthis.__superviewResize = bind(this, function () {\n\t\t// \t\t\t\tthis.__superviewResize = null;\n\t\t// \t\t\t\tsuperview.removeListener('Resize', onResize);\n\t\t// \t\t\t});\n\t\t// \t\t}));\n\t\t\t\t\n\t\t// \t\tthis._view.on('ViewRemoved', bind(this, function (superview) {\n\t\t// \t\t\tif (this.__superviewResize) { this.__superviewResize(); }\n\t\t// \t\t}));\n\t\t// \t}\n\t\t\t\n\t\t// \tthis._onLayoutChange();\n\t\t// }\n\n\t\tproto._onLayoutChange = function () {\n\t\t\tvar superview = this.getSuperview();\n\t\t\tif (superview && superview.__layout) {\n\t\t\t\tsuperview.needsReflow();\n\t\t\t}\n\n\t\t\tthis._view.needsReflow();\n\t\t}\n\t}\n});\n","pre":true},"sdk/timestep/ui/layout/BoxLayout.js":{"path":"sdk/timestep/ui/layout/BoxLayout.js","friendlyPath":".BoxLayout","directory":"sdk/timestep/ui/layout/","filename":"BoxLayout.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\nvar sdk_timestep_ui_layout_BoxLayout=__class__;var BoxLayout = exports=sdk_timestep_ui_layout_BoxLayout(function sdk_timestep_ui_layout_BoxLayout(){return this.init&&this.init.apply(this,arguments)},function () {\n\n\tvar cls = this.constructor;\n\n\tthis.reflowsChildren = false;\n\n\tthis.init = function (opts) {\n\t\tthis._view = opts.view;\n\n\t\tcls.initParentListener(opts.view);\n\t}\n\n\tthis.reflow = function (force) {\n\t\tvar view = this._view;\n\t\tvar sv = view.getSuperview();\n\t\tvar style = view.style;\n\n\t\tif (sv && (force || !style.inLayout || !sv.style.layout || sv.__layout && !sv.__layout.reflowsChildren)) {\n\t\t\tcls.reflowX(view, sv.style.width);\n\t\t\tcls.reflowY(view, sv.style.height);\n\t\t}\n\n\n\t}\n\n\tcls.addParentListener = function (view) {\n\t\tif (view.style.__removeSuperviewResize) {\n\t\t\tview.style.__removeSuperviewResize();\n\t\t}\n\n\t\t// reflow on parent view resize\n\t\tvar onResize = bind(view, 'needsReflow');\n\t\tvar superview = view.getSuperview();\n\t\tsuperview && superview.on('Resize', onResize);\n\n\t\t// store a closure to unsubscribe this event\n\t\tview.style.__removeSuperviewResize = bind(view.style, function () {\n\t\t\tthis.__removeSuperviewResize = null;\n\t\t\tsuperview && superview.removeListener('Resize', onResize);\n\t\t});\n\t}\n\n\tcls.initParentListener = function (view) {\n\t\tif (view.__root) { this.addParentListener(view); }\n\n\t\tview.on('ViewAdded', bind(this, 'addParentListener', view));\n\t\tview.on('ViewRemoved', bind(view.style, function () {\n\t\t\tthis.__removeSuperviewResize && this.__removeSuperviewResize();\n\t\t}));\n\t}\n\n\tcls.reflowX = function (view, svWidth, padding) {\n\t\tif (!svWidth) { return; }\n\n\t\tvar s = view.style;\n\t\tvar availWidth = (svWidth - (padding && padding.getHorizontal() || 0));\n\n\t\t// compute the width\n\t\tvar w = 0;\n\t\tif (s.layoutWidth == 'wrapContent') {\n\t\t\t// find the maximal right edge\n\t\t\tvar views = view.getSubviews();\n\t\t\tfor (var i = 0, v; v = views[i]; ++i) {\n\t\t\t\tvar right = v.style.x + v.style.width * v.style.scale;\n\t\t\t\tif (right > w) {\n\t\t\t\t\tw = right;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tvar sv = view.getSuperview();\n\t\t\tw = s.right != undefined && s.left != undefined ? availWidth / s.scale - (s.left || 0) - (s.right || 0)\n\t\t\t\t: (s.layoutWidth && s.layoutWidth.charAt(s.layoutWidth.length-1) == '%') ? (availWidth / s.scale) * (parseFloat(s.layoutWidth) / 100)\n\t\t\t\t: view._opts.width ? view._opts.width\n\t\t\t\t: s.aspectRatio ? (view._opts.height || s.height) * s.aspectRatio\n\t\t\t\t: (sv.style.direction == \"horizontal\" && typeof s.flex == \"number\") ? availWidth * s.flex / sv._flexSum\n\t\t\t\t: view._opts.autoSize ? s.width\n\t\t\t\t: availWidth / s.scale || s.width;\n\t\t}\n\n\t\tif (s.centerX) { s.x = (availWidth - s.scale * w) / 2 + (padding && padding.left || 0); }\n\t\tif (s.left == undefined && s.right != undefined) { s.x = availWidth - s.scale * w - s.right - (padding && padding.right || 0); }\n\t\tif (s.left != undefined) { s.x = s.left + (padding && padding.left || 0); }\n\n\t\ts.width = w;\n\n\t\tif (s.centerAnchor) {\n\t\t\ts.anchorX = w / 2;\n\t\t}\n\t}\n\n\tcls.reflowY = function (view, svHeight, padding) {\n\t\tif (!svHeight) { return; }\n\n\t\tvar s = view.style;\n\t\tvar availHeight = (svHeight - (padding && padding.getVertical() || 0));\n\n\t\t// compute the height\n\t\tvar h = 0;\n\t\tif (s.layoutHeight == 'wrapContent') {\n\t\t\t// find the maximal right edge\n\t\t\tvar views = view.getSubviews();\n\t\t\tfor (var i = 0, v; v = views[i]; ++i) {\n\t\t\t\tvar bottom = v.style.y + v.style.height * v.style.scale;\n\t\t\t\tif (bottom > h) {\n\t\t\t\t\th = bottom;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tvar sv = view.getSuperview();\n\t\t\th = s.top != undefined && s.bottom != undefined ? availHeight / s.scale - (s.top || 0) - (s.bottom || 0)\n\t\t\t\t: (s.layoutHeight && s.layoutHeight.charAt(s.layoutHeight.length-1) == '%') ? (availHeight / s.scale) * (parseFloat(s.layoutHeight) / 100)\n\t\t\t\t: view._opts.height ? view._opts.height\n\t\t\t\t: s.aspectRatio ? (view._opts.width || s.width) / s.aspectRatio\n\t\t\t\t: (sv.style.direction == \"vertical\" && typeof s.flex == \"number\") ? availHeight * s.flex / sv._flexSum\n\t\t\t\t: view._opts.autoSize ? s.height\n\t\t\t\t: availHeight / s.scale || s.height;\n\t\t}\n\n\t\tif (s.centerY) { s.y = (availHeight - s.scale * h) / 2 + (padding && padding.top || 0); }\n\t\tif (s.top == undefined && s.bottom != undefined) { s.y = availHeight - s.scale * h - s.bottom - (padding && padding.bottom || 0); }\n\t\tif (s.top != undefined) { s.y = s.top + (padding && padding.top || 0); }\n\n\t\ts.height = h;\n\n\t\tif (s.centerAnchor) {\n\t\t\ts.anchorY = h / 2;\n\t\t}\n\t}\n});\n\n","pre":true},"sdk/timestep/ui/layout/LinearLayout.js":{"path":"sdk/timestep/ui/layout/LinearLayout.js","friendlyPath":".LinearLayout","directory":"sdk/timestep/ui/layout/","filename":"LinearLayout.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * package ui.layout.LinearLayout;\n *\n * A class to direct the layout of its parent view, set through opts.parent.\n */\n\njsio(\"import ui.layout.Padding as Padding\");\n\njsio(\"import .BoxLayout\");\n\nvar DEBUG = false;\n\n// TODO: native\n// TODO: Resize event on width/height change\n// TODO: reflow on subview visibility change\n\nvar sdk_timestep_ui_layout_LinearLayout=__class__;exports=sdk_timestep_ui_layout_LinearLayout(function sdk_timestep_ui_layout_LinearLayout(){return this.init&&this.init.apply(this,arguments)},BoxLayout, function (supr) {\n\n\t// set to true to tell other layouts not to try to control the child layout\n\tthis.reflowsChildren = true;\n\n\tthis.init = function (opts) {\n\t\tthis._view = opts.view;\n\t\tthis._view.subscribe('SubviewAdded', this, '_onSubviewAdded');\n\t\tthis._view.subscribe('SubviewRemoved', this, '_onSubviewRemoved');\n\n\t\tthis.setDirection(opts.isVertical ? 'vertical' : 'horizontal');\n\n\t\tthis._views = [];\n\t\tvar subviews = this._view.getSubviews();\n\t\tfor (var i = 0, view; view = subviews[i]; ++i) {\n\t\t\tif (view.style.inLayout) {\n\t\t\t\tthis._views.push(this._initLayoutView(view));\n\t\t\t}\n\t\t}\n\n\t\tthis._forwardEvents();\n\n\t\tthis._debug = DEBUG;\n\t}\n\n\tthis._onSubviewRemoved = function (view) {\n\t\tif (view.style.inLayout) {\n\t\t\tthis.remove(view);\n\t\t}\n\t}\n\n\tthis._onSubviewAdded = function (view) {\n\t\tif (view.style.inLayout) {\n\t\t\tthis.add(view);\n\t\t}\n\t}\n\n\tthis.debug = function () { this._debug = true; return this; }\n\n\t/**\n\t * Set which language to use, for horizontal or vertical layout.\n\t * @param String direction One of \"horizontal\" or \"vertical\".\n\t */\n\n\tthis.setDirection = function (direction) {\n\t\tthis._direction = direction;\n\n\t\tvar isVertical = direction == 'vertical';\n\t\tthis._propPos = isVertical ? 'y' : 'x';\n\t\tthis._propPosOpp = isVertical ? 'x' : 'y';\n\t\tthis._propDim = isVertical ? 'height' : 'width';\n\t\tthis._minPropDim = isVertical ? 'minHeight' : 'minWidth';\n\t\tthis._maxPropDim = isVertical ? 'maxHeight' : 'maxWidth';\n\t\tthis._propDimOpp = isVertical ? 'width' : 'height';\n\t\tthis._propSideA = isVertical ? 'top' : 'left';\n\t\tthis._propSideB = isVertical ? 'bottom' : 'right';\n\n\t\tthis._flexProp = isVertical ? 'vflex' : 'hflex';\n\n\t\tthis._view.needsReflow();\n\t\treturn this;\n\t}\n\n\tthis.getDirection = function () { return this._direction; }\n\n\t/**\n\t * Events to proxy to the parent view from this layout.\n\t */\n\tthis._events = ['ViewWillAppear', 'ViewDidAppear', 'ViewWillDisappear', 'ViewDidDisappear'];\n\n\tthis._forwardEvents = function () {\n\t\tfor (var i = 0, a; a = this._events[i]; ++i) {\n\t\t\tthis._view.subscribe(a, this, '_forwardSignal', a);\n\t\t}\n\t};\n\n\tthis._events = ['ViewWillAppear', 'ViewDidAppear', 'ViewWillDisappear', 'ViewDidDisappear'];\n\n\t/**\n\t * Emit events on the children. Variable arguments.\n\t */\n\n\tthis._forwardSignal = function () {\n\t\tfor (var i = 0, v; v = this._views[i]; ++i) {\n\t\t\tv.view.publish.apply(v.view, arguments);\n\t\t}\n\t};\n\n\t/**\n\t * Initialize a subview controlled by this layout.\n\t */\n\n\tthis._initLayoutView = function (view) {\n\t\tview.style.inLayout = true;\n\n\t\tthis._debug && logger.log(this._view.uid, 'adding view', view.uid, this._propDim, view.style[this._propDim]);\n\n\t\tthis._view.connectEvent(view, 'Resize', bind(this, 'reflow'));\n\n\t\treturn {\n\t\t\tview: view,\n\t\t\tindex: 0,\n\t\t\ttoString: toStringSort\n\t\t};\n\t};\n\n\tfunction toStringSort () {\n\t\treturn this.view.style._sortOrder + this.index;\n\t}\n\n\t/**\n\t * Return the size of this element (in its cardinal direction).\n\t */\n\n\tthis.getSize = function () {\n\t\treturn this._size;\n\t};\n\n\t/**\n\t * Return the index of a subview.\n\t */\n\n\tthis.getViewIndex = function (view) {\n\t\tfor (var i = 0, d; d = this._views[i]; ++i) {\n\t\t\tif (d.view == view) {\n\t\t\t\treturn i;\n\t\t\t}\n\t\t}\n\t\treturn -1;\n\t};\n\n\t/**\n\t * Add an array of subviews to this element in batch (prevent reflow each\n\t * time).\n\t */\n\n\tthis.addSubviews = function (views) {\n\t\tthis._debug && logger.log(this._view.uid, \"adding\", views.length, \"views\");\n\t\tif (isArray(views)) {\n\t\t\tfor (var i = 0, n = views.length; i < n; ++i) {\n\t\t\t\tvar view = views[i];\n\t\t\t\tif (view) {\n\t\t\t\t\tthis._views.push(this._initLayoutView(view));\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis._view.needsReflow();\n\t\t} else {\n\t\t\tthis.insertBefore(views);\n\t\t}\n\n\t\treturn this;\n\t}\n\n\t/**\n\t * Return the list of subviews controlled by this layout.\n\t */\n\n\tthis.getSubviews = function () {\n\t\treturn this._views.map(function (v) { return v.view; });\n\t};\n\n\t/**\n\t * Remove a subview controlled by this layout.\n\t */\n\n\tthis.remove = function (view) {\n\t\tvar i = this.getViewIndex(view);\n\t\tif (i != -1) {\n\t\t\tthis._views.splice(i, 1);\n\t\t\tthis._view.disconnectEvent(view, 'Resize');\n\t\t\tthis._view.needsReflow();\n\t\t\treturn;\n\t\t}\n\t}\n\n\t/**\n\t * Insert a subview before another subview in this hierarchy.\n\t */\n\n\tthis.add =\n\tthis.insertBefore = function (view, before) {\n\n\t\tif (this.getViewIndex(view) != -1) { return; }\n\n\t\tvar item = this._initLayoutView(view);\n\t\tvar added = false;\n\t\tif (before) {\n\t\t\tvar i = this.getViewIndex(before);\n\t\t\tif (i != -1) {\n\t\t\t\tthis._views.splice(i, 0, item);\n\t\t\t\tadded = true;\n\t\t\t}\n\t\t}\n\n\t\tif (!added) {\n\t\t\tthis._views.push(item);\n\t\t}\n\n\t\tthis._view.needsReflow();\n\t}\n\n\t/**\n\t * Insert a subview after another subview in this hierarchy.\n\t */\n\n\tthis.insertAfter = function (view, after) {\n\n\t\tif (this.getViewIndex(view) != -1) { return; }\n\n\t\tvar item = this._initLayoutView(view);\n\t\tvar added = false;\n\t\tif (after) {\n\t\t\tvar i = this.getViewIndex(after);\n\t\t\tif (i != -1) {\n\t\t\t\tthis._views.splice(i + 1, 0, item);\n\t\t\t\tadded = true;\n\t\t\t}\n\t\t}\n\n\t\tif (!added) {\n\t\t\tthis._views.unshift(item);\n\t\t}\n\n\t\tthis._view.needsReflow();\n\t}\n\n\t/**\n\t * Reflow logic.\n\t */\n\n\tthis.reflow = function () {\n\t\tsupr(this, 'reflow', arguments);\n\n\t\t// style.order is first, then default to standard view sort order\n\t\tvar n = 0;\n\t\tfor (var i = 0, v; v = this._views[i]; ++i) {\n\t\t\tif (v.view.style.visible) {\n\t\t\t\t// TODO: this won't work on native\n\t\t\t\tv.index = v.view.style.__sortKey;\n\n\t\t\t\t++n;\n\t\t\t}\n\t\t}\n\n\t\tif (!n) { return; }\n\n\t\tthis._views.sort();\n\n\t\tif (DEBUG) {\n\t\t\tvar uid = this._view.uid;\n\t\t\t// _debug.views[uid] = +new Date();\n\t\t}\n\n\t\tvar layoutStyle = this._view.style;\n\t\tif (layoutStyle.direction != this._direction) {\n\t\t\tthis.setDirection(layoutStyle.direction);\n\t\t}\n\n\t\tvar scale = this._view.getPosition().scale;\n\n\t\tvar isVertical = this._direction == 'vertical';\n\t\tvar propDim = this._propDim;\n\t\tvar propDimOpp = this._propDimOpp;\n\t\tvar minPropDim = this._minPropDim;\n\t\tvar propA = this._propSideA;\n\t\tvar propB = this._propSideB;\n\t\tvar padding = layoutStyle.padding;\n\t\tvar paddingSum = padding && (isVertical ? padding.getVertical() : padding.getHorizontal()) || 0;\n\t\tvar parentDim = layoutStyle[propDim];\n\t\tvar views = this._views;\n\n\t\tthis._debug && logger.log('reflow() view', uid + ':', views.length, 'subview(s)');\n\n\t\t// compute the total size of the fixed views and count\n\t\t// how many dynamically sized views we have\n\t\tvar sum = 0;\n\t\tvar flexSum = 0;\n\t\tvar paddingOpp = padding && (isVertical ? padding.getHorizontal() : padding.getVertical()) || 0;\n\t\tfor (var i = 0, v; v = views[i]; ++i) {\n\t\t\tvar s = v.view.style;\n\t\t\tif (!s.visible) { continue; }\n\n\t\t\tv.margins = (s[propA] || 0) + (s[propB] || 0);\n\n\t\t\tif (isVertical && s.layoutHeight && s.layoutHeight.charAt(s.layoutHeight.length-1) == '%') {\n\t\t\t\tsum += parentDim * parseFloat(s.layoutHeight) / 100;\n\t\t\t} else if (!isVertical && s.layoutWidth && s.layoutWidth.charAt(s.layoutWidth.length-1) == '%') {\n\t\t\t\tsum += parentDim * parseFloat(s.layoutWidth) / 100;\n\t\t\t} else if (s.flex) {\n\t\t\t\tflexSum += s.flex;\n\t\t\t\tv.baseSize = s[minPropDim] || 0;\n\t\t\t\tsum += v.baseSize;\n\t\t\t} else {\n\t\t\t\tsum += (s[propDim] || 0) * s.scale + v.margins;\n\t\t\t}\n\n\t\t\t// LinearViews should reflow the opposite direction\n\t\t\tif (padding) {\n\t\t\t\ts.x = padding.left;\n\t\t\t\ts.y = padding.top;\n\t\t\t}\n\t\t}\n\t\tthis._view._flexSum = flexSum;\n\t\tfor (var i = 0, v; v = views[i]; ++i) {\n\t\t\tBoxLayout.reflowX(v.view, layoutStyle.width, padding);\n\t\t\tBoxLayout.reflowY(v.view, layoutStyle.height, padding);\n\t\t}\n\n\t\tif (flexSum && parentDim == undefined) { return; }\n\n\t\t// compute available space\n\t\tvar availableSpace = parentDim - paddingSum;\n\t\tif (availableSpace < 0) { return; }\n\n\t\t// if there's a flex subview or (?), the total size is the availableSpace\n\t\t// otherwise the totalSize is the sum of the subview sizes\n\t\tvar justifyContent = layoutStyle.justifyContent;\n\t\tvar totalSize = (flexSum || justifyContent != 'start' ? availableSpace : sum) + paddingSum;\n\t\tvar flexSize = availableSpace - sum;\n\n\t\t//\n\t\tvar layoutDim = isVertical ? 'layoutHeight' : 'layoutWidth';\n\t\tif (!flexSum && layoutStyle[layoutDim] == 'wrapContent') {\n\t\t\tthis._debug && logger.log('  view', uid, '(sizing to fit)', propDim, '=', totalSize + 'px', '(' + paddingSum + 'px padding)');\n\t\t\tlayoutStyle[propDim] = totalSize;\n\t\t}\n\n\t\t// compute the space for each flexible view\n\t\tvar flexUsed = 0;\n\t\tvar balance = 0;\n\t\tfor (var i = 0, v; v = views[i]; ++i) {\n\t\t\tvar s = v.view.style;\n\t\t\tif (!s.visible) { continue; }\n\n\t\t\tif (s.flex) {\n\t\t\t\t// compute the ideal space for the flex view\n\t\t\t\tvar idealSpace = v.baseSize + flexSize * (s.flex / flexSum) / s.scale + balance;\n\n\t\t\t\t// round to the nearest screen pixel (take into account the global scale of the layout view)\n\t\t\t\tvar roundedSpace = Math.round(idealSpace / scale) * scale;\n\n\t\t\t\t// propogate the balance into the next view space computation\n\t\t\t\tbalance = idealSpace - roundedSpace;\n\n\t\t\t\t// store the actual space for the view, which is the computed space minus the margins\n\t\t\t\tv.dim = roundedSpace - v.margins;\n\n\t\t\t\t// account for maximal bound\n\t\t\t\tif (v.dim > s[this._maxPropDim]) {\n\t\t\t\t\tv.dim = s[this._maxPropDim];\n\t\t\t\t}\n\n\t\t\t\t// keep track of used flex space\n\t\t\t\tflexUsed += roundedSpace;\n\t\t\t}\n\t\t}\n\n\t\tvar flexRemaining = flexSize - flexUsed;\n\n\t\t// set the position of the views\n\t\tvar pos = padding && padding[propA] || 0;\n\t\tvar gap = 0;\n\t\tif (flexRemaining > 0) {\n\t\t\t// there's unused space, so justify our views\n\t\t\tswitch (justifyContent) {\n\t\t\t\tcase 'end':\n\t\t\t\t\tpos += flexRemaining;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'center':\n\t\t\t\t\tpos += flexRemaining / 2;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'space':\n\t\t\t\t\tgap = flexRemaining / (n - 1) || 0;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'space-outside':\n\t\t\t\t\tgap = flexRemaining / (n + 1) || 0;\n\t\t\t\t\tpos += gap;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'start':\n\t\t\t\tdefault:\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\t// position and size views!\n\t\tvar propPos = this._propPos;\n\t\tfor (var i = 0, v; v = views[i]; ++i) {\n\t\t\tvar s = v.view.style;\n\t\t\tif (!s.visible) { continue; }\n\n\t\t\t// set position\n\t\t\ts[propPos] = pos + (s[propA] || 0);\n\n\t\t\tthis._debug && logger.log('  view', uid, 'layout subview', v.view.uid, propPos, '=', s[propPos]);\n\n\t\t\tif (s.flex) {\n\t\t\t\t// set width\n\t\t\t\ts[propDim] = v.dim;\n\t\t\t\tif (s.aspectRatio) {\n\t\t\t\t\ts.enforceAspectRatio()\n\t\t\t\t}\n\n\t\t\t\tthis._debug && logger.log('  view', uid, 'layout subview', v.view.uid, propDim, '=', s[propDim]);\n\t\t\t}\n\n\t\t\t// advance position\n\t\t\tpos += gap + (s[propDim] || 0) * s.scale + v.margins;\n\t\t}\n\n\t\tif (this._size != totalSize) {\n\t\t\tthis._size = totalSize;\n\t\t\tthis._view.publish('LayoutResize', totalSize);\n\t\t}\n\t};\n});\n\n","pre":true},"sdk/gc/debugging/nativeShim.js":{"path":"sdk/gc/debugging/nativeShim.js","friendlyPath":"gc.debugging.nativeShim","directory":"sdk/gc/debugging/","filename":"nativeShim.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\njsio(\"import lib.PubSub\");\njsio(\"import lib.Callback\");\n\nvar testContactList = [\n];\n\n// for (var i = testContactList.length; i < 1000; ++i) {\n// \ttestContactList.push({id: i, name: username(), phones: [{number: '123456789'}]});\n// }\n\nexports.backButton = new lib.PubSub();\n\nexports.dialogs = {\n\t\n\tshowDialog: function () {\n\t\tlogger.log(\"Showing a dialog!\");\n\t},\n\n\tshowAppRater: function () {\n\t\tlogger.log(\"Showing rate dialog!\");\n\t}\n\n};\n\n\nvar _withContacts = new lib.Callback();\n_withContacts.fire();\n\nexports.contacts = merge(new lib.PubSub(), {\n\t\n\tgetContactList: function () {\n\t\treturn testContactList;\n\t},\n\n\twithContacts: function () { _withContacts.forward(arguments); },\n\n\tsendAutomatedSMS: function (phone, msg, cb) {\n\t\tlogger.log('Send Automated SMS:', phone, msg);\n\t\tcb && cb();\n\t},\n\n\tsendSMS: function (phone, msg, cb) {\n\t\tlogger.log('Send SMS:', phone, msg);\n\t\tcb && cb();\n\t},\n\n\tgetPicture: function (id) {\n\t\treturn null;\n\t},\n\t\n\tgetPictures: function (ids) {\n\t\treturn null;\n\t},\n\n\tgetPictureBase64: function (id) {\n\t\treturn null;\n\t}\n\n});\n\nvar _withPhoneNumber = new lib.Callback();\n_withPhoneNumber.fire(null);\n\nvar _withPhoneNumber = new lib.Callback();\n_withPhoneNumber.fire(null);\n\nexports.profile = {\n\tfullName: \"\",\n\n\tgetPicture: function (id) {\n\t\treturn null;\n\t},\n\n\tgetPictureBase64: function (id) {\n\t\treturn null;\n\t},\n\n\twithPhoneNumber: function () { _withPhoneNumber.forward(arguments); }\n};\n\nexports.sound = {\n\tplaySound: function (url, volume) {\n\t\tlogger.log('NATIVE shim: play a sound');\n\t},\n\tloadSound: function (url) {\n\t\tlogger.log('NATIVE shim: load a sound');\n\t},\n\tpauseSound: function (url) {\n\t\tlogger.log('NATIVE shim: pause a sound');\n\t},\n\tstopSound: function (url) {\n\t\tlogger.log('NATIVE shim: stop a sound');\n\t},\n\tsetVolume: function (url, volume) {\n\t\tlogger.log('NATIVE shim: set the volume of a sound');\n\t},\n\tloadBackgroundMusic: function (url) {\n\t\tlogger.log('NATIVE shim: load background music');\n\t},\n\tplayBackgroundMusic: function (url) {\n\t\tlogger.log('NATIVE shim: play background music');\n\t},\n\tregisterMusic: function (url) {\n\t\tlogger.log('NATIVE shim: register background music');\n\t}\n};\n\nexports.events = {\n\tregisterHandler: function(eventName) {\n\t\tlogger.log('NATIVE shim: register an event handler for the ' + eventName + ' event');\n\t}\n};\n\nexports.plugins = {\n\tsendEvent: function(plugin, eventName) {\n\t\tlogger.log('NATIVE shim: send a ' + eventName + ' event to the ' + plugin + ' plugin');\n\t}\n};\n\nexports.alerts = new lib.PubSub();\nmerge(exports.alerts, {\n\tonNotificationLoad: function () {},\n\tshowNotification: function () {\n\t\treturn -1;\n\t},\n\tshowRecurringNotification: function () {\n\t\tlogger.log(\"Setting up a recurring notification!\");\n\t\treturn -1;\n\t}\n});\n\nexports.social = new lib.PubSub();\n\n//import .auth.conn;\n//auth.conn.webAutoLogin();\n\nif (!GLOBAL.NATIVE) {\n\tGLOBAL.NATIVE = exports;\n}\n","pre":true},"sdk/jsio/std/JSON.js":{"path":"sdk/jsio/std/JSON.js","friendlyPath":"std.JSON","directory":"sdk/jsio/std/","filename":"JSON.js","src":"// Based on json2.js (version 2009-09-29) http://www.JSON.org/json2.js\n// exports createGlobal, stringify, parse, stringifyDate\n\n/**\n * if a global JSON object doesn't exist, create one\n */\nexports.createGlobal = function() {\n\tif(typeof JSON == 'undefined') { JSON = {}; }\n\tif(typeof JSON.stringify !== 'function') {\n\t\tJSON.stringify = exports.stringify;\n\t}\n\tif(typeof JSON.parse !== 'function') {\n\t\tJSON.parse = exports.parse;\n\t}\n};\n\n;(function() {\n\tvar cx = /[\\u0000\\u00ad\\u0600-\\u0604\\u070f\\u17b4\\u17b5\\u200c-\\u200f\\u2028-\\u202f\\u2060-\\u206f\\ufeff\\ufff0-\\uffff]/g,\n\t\tescapable = /[\\\\\\\"\\x00-\\x1f\\x7f-\\x9f\\u00ad\\u0600-\\u0604\\u070f\\u17b4\\u17b5\\u200c-\\u200f\\u2028-\\u202f\\u2060-\\u206f\\ufeff\\ufff0-\\uffff]/g,\n\t\tgap,\n\t\tindent,\n\t\tmeta = {\t// table of character substitutions\n\t\t\t'\\b': '\\\\b',\n\t\t\t'\\t': '\\\\t',\n\t\t\t'\\n': '\\\\n',\n\t\t\t'\\f': '\\\\f',\n\t\t\t'\\r': '\\\\r',\n\t\t\t'\"' : '\\\\\"',\n\t\t\t'\\\\': '\\\\\\\\'\n\t\t},\n\t\trep;\n\t\n\tfunction quote(string) {\n\t\t// quote the string if it doesn't contain control characters, quote characters, and backslash characters\n\t\t// otherwise, replace those characters with safe escape sequences\n\t\tescapable.lastIndex = 0;\n\t\treturn escapable.test(string)\n\t\t\t? '\"' + string.replace(escapable, function (a) {\n\t\t\t\t\tvar c = meta[a];\n\t\t\t\t\treturn typeof c === 'string' ? c : '\\\\u' + ('0000' + a.charCodeAt(0).toString(16)).slice(-4);\n\t\t\t\t}) + '\"'\n\t\t\t: '\"' + string + '\"';\n\t}\n\t\n\t// Produce a string from holder[key].\n\tfunction str(key, holder) {\n\t\tvar mind = gap, value = holder[key];\n\t\t\n\t\t// If the value has a toJSON method, call it to obtain a replacement value.\n\t\tif (value && typeof value === 'object' && typeof value.toJSON === 'function') {\n\t\t\tvalue = value.toJSON(key);\n\t\t}\n\t\t\n\t\t// If we were called with a replacer function, then call the replacer to\n\t\t// obtain a replacement value.\n\t\tif (typeof rep === 'function') { value = rep.call(holder, key, value); }\n\t\t\n\t\tswitch (typeof value) {\n\t\t\tcase 'string':\n\t\t\t\treturn quote(value);\n\t\t\tcase 'number':\n\t\t\t\t// JSON numbers must be finite\n\t\t\t\treturn isFinite(value) ? String(value) : 'null';\n\t\t\tcase 'boolean':\n\t\t\t\treturn String(value);\n\t\t\tcase 'object': // object, array, date, null\n\t\t\t\tif (value === null) { return 'null'; } // typeof null == 'object'\n\t\t\t\tif (value.constructor === Date) { return exports.stringifyDate(value); }\n\t\t\t\n\t\t\t\tgap += indent;\n\t\t\t\tvar partial = [];\n\t\t\t\t\n\t\t\t\t// Is the value an array?\n\t\t\t\tif (value.constructor === Array) {\n\t\t\t\t\tvar length = value.length;\n\t\t\t\t\tfor (var i = 0; i < length; i += 1) {\n\t\t\t\t\t\tpartial[i] = str(i, value) || 'null';\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t// Join all of the elements together, separated with commas, and wrap them in brackets.\n\t\t\t\t\tvar v = partial.length === 0 ? '[]' :\n\t\t\t\t\t\tgap ? '[\\n' + gap +\n\t\t\t\t\t\t\t\tpartial.join(',\\n' + gap) + '\\n' +\n\t\t\t\t\t\t\t\t\tmind + ']' :\n\t\t\t\t\t\t\t  '[' + partial.join(',') + ']';\n\t\t\t\t\tgap = mind;\n\t\t\t\t\treturn v;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif (rep && typeof rep === 'object') { // rep is an array\n\t\t\t\t\tvar length = rep.length;\n\t\t\t\t\tfor (var i = 0; i < length; i += 1) {\n\t\t\t\t\t\tvar k = rep[i];\n\t\t\t\t\t\tif (typeof k === 'string') {\n\t\t\t\t\t\t\tvar v = str(k, value);\n\t\t\t\t\t\t\tif (v) {\n\t\t\t\t\t\t\t\tpartial.push(quote(k) + (gap ? ': ' : ':') + v);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else { // iterate through all of the keys in the object.\n\t\t\t\t\tfor (var k in value) {\n\t\t\t\t\t\tif (Object.hasOwnProperty.call(value, k)) {\n\t\t\t\t\t\t\tvar v = str(k, value);\n\t\t\t\t\t\t\tif (v) {\n\t\t\t\t\t\t\t\tpartial.push(quote(k) + (gap ? ': ' : ':') + v);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Join all of the member texts together, separated with commas,\n\t\t\t\t// and wrap them in braces.\n\t\t\t\tvar v = partial.length === 0 ? '{}' :\n\t\t\t\t\tgap ? '{\\n' + gap + partial.join(',\\n' + gap) + '\\n' +\n\t\t\t\t\t\t\tmind + '}' : '{' + partial.join(',') + '}';\n\t\t\t\tgap = mind;\n\t\t\t\treturn v;\n\t\t}\n\t}\n\n\n\t/**\n\t * The stringify method takes a value and an optional replacer, and an optional\n\t * space parameter, and returns a JSON text. The replacer can be a function\n\t * that can replace values, or an array of strings that will select the keys.\n \t * A default replacer method can be provided. Use of the space parameter can\n\t * produce text that is more easily readable.\n\t */\n\texports.stringify = function (value, replacer, space) {\n\t\tgap = '';\n\t\tindent = '';\n\t\t\n\t\t// If the space parameter is a number, make an indent string containing that many spaces.\n\t\tif (typeof space === 'number') {\n\t\t\tfor (var i = 0; i < space; i += 1) {\n\t\t\t\tindent += ' ';\n\t\t\t}\n\t\t} else if (typeof space === 'string') {\n\t\t\tindent = space;\n\t\t}\n\t\t\n\t\t// If there is a replacer, it must be a function or an array.\n\t\trep = replacer;\n\t\tif (replacer && typeof replacer !== 'function' &&\n\t\t\t\t(typeof replacer !== 'object' ||\n\t\t\t\t typeof replacer.length !== 'number')) {\n\t\t\tthrow new Error('JSON stringify: invalid replacer');\n\t\t}\n\t\t\n\t\t// Make a fake root object containing our value under the key of ''.\n\t\t// Return the result of stringifying the value.\n\t\treturn str('', {'': value});\n\t};\n\t\n\texports.stringifyDate = function(d) {\n\t\tvar year = d.getUTCFullYear(),\n\t\t\tmonth = d.getUTCMonth() + 1,\n\t\t\tday = d.getUTCDate(),\n\t\t\thours = d.getUTCHours(),\n\t\t\tminutes = d.getUTCMinutes(),\n\t\t\tseconds = d.getUTCSeconds(),\n\t\t\tms = d.getUTCMilliseconds();\n\t\t\n\t\tif (month < 10) { month = '0' + month; }\n\t\tif (day < 10) { day = '0' + day; }\n\t\tif (hours < 10) { hours = '0' + hours; }\n\t\tif (minutes < 10) { minutes = '0' + minutes; }\n\t\tif (seconds < 10) { seconds = '0' + seconds; }\n\t\tif (ms < 10) { ms = '00' + ms; }\n\t\telse if (ms < 100) { ms = '0' + ms; }\n\n\t\treturn '\"' + year\n\t\t\t+ '-' + month\n\t\t\t+ '-' + day\n\t\t\t+ 'T' + hours\n\t\t\t+ ':' + minutes\n\t\t\t+ ':' + seconds\n\t\t\t+ '.' + ms\n\t\t\t+ 'Z\"';\n\t}\n\t\n\t/**\n\t * The parse method takes a text and an optional reviver function, and returns\n\t * a JavaScript value if the text is a valid JSON text.\n\t */\n\texports.parse = function (text, reviver) {\n\t\t// Parsing happens in four stages. In the first stage, we replace certain\n\t\t// Unicode characters with escape sequences. JavaScript handles many characters\n\t\t// incorrectly, either silently deleting them, or treating them as line endings.\n\t\tcx.lastIndex = 0;\n\t\tif (cx.test(text)) {\n\t\t\ttext = text.replace(cx, function (a) {\n\t\t\t\treturn '\\\\u' +\n\t\t\t\t\t('0000' + a.charCodeAt(0).toString(16)).slice(-4);\n\t\t\t});\n\t\t}\n\t\t\n\t\t// In the second stage, we run the text against regular expressions that look\n\t\t// for non-JSON patterns. We are especially concerned with '()' and 'new'\n\t\t// because they can cause invocation, and '=' because it can cause mutation.\n\t\t// But just to be safe, we want to reject all unexpected forms.\n\n\t\t// We split the second stage into 4 regexp operations in order to work around\n\t\t// crippling inefficiencies in IE's and Safari's regexp engines. First we\n\t\t// replace the JSON backslash pairs with '@' (a non-JSON character). Second, we\n\t\t// replace all simple value tokens with ']' characters. Third, we delete all\n\t\t// open brackets that follow a colon or comma or that begin the text. Finally,\n\t\t// we look to see that the remaining characters are only whitespace or ']' or\n\t\t// ',' or ':' or '{' or '}'. If that is so, then the text is safe for eval.\n\n\t\tif (/^[\\],:{}\\s]*$/\n\t\t\t\t.test(text.replace(/\\\\(?:[\"\\\\\\/bfnrt]|u[0-9a-fA-F]{4})/g, '@')\n\t\t\t\t.replace(/\"[^\"\\\\\\n\\r]*\"|true|false|null|-?\\d+(?:\\.\\d*)?(?:[eE][+\\-]?\\d+)?/g, ']')\n\t\t\t\t.replace(/(?:^|:|,)(?:\\s*\\[)+/g, '')))\n\t\t{\n\t\t\tvar j = eval('(' + text + ')');\n\t\t\tif(!reviver) {\n\t\t\t\treturn j;\n\t\t\t} else {\n\t\t\t\t// In the optional fourth stage, we recursively walk the new structure, passing\n\t\t\t\t// each name/value pair to a reviver function for possible transformation.\n\t\t\t\tvar walk = function(holder, key) {\n\t\t\t\t\t// The walk method is used to recursively walk the resulting structure so\n\t\t\t\t\t// that modifications can be made.\n\t\t\t\t\tvar k, v, value = holder[key];\n\t\t\t\t\tif (value && typeof value === 'object') {\n\t\t\t\t\t\tfor (k in value) {\n\t\t\t\t\t\t\tif (Object.hasOwnProperty.call(value, k)) {\n\t\t\t\t\t\t\t\tv = walk(value, k);\n\t\t\t\t\t\t\t\tif (v !== undefined) {\n\t\t\t\t\t\t\t\t\tvalue[k] = v;\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tdelete value[k];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn reviver.call(holder, key, value);\n\t\t\t\t}\n\t\t\t\treturn walk({'': j}, '');\n\t\t\t}\n\t\t}\n\n\t\t// If the text is not JSON parseable, then a SyntaxError is thrown.\n\t\tthrow new SyntaxError('JSON.parse');\n\t};\n}());","pre":true},"sdk/jsio/preprocessors/import.js":{"path":"sdk/jsio/preprocessors/import.js","friendlyPath":"preprocessors.import","directory":"sdk/jsio/preprocessors/","filename":"import.js","src":"var importExpr = /^(\\s*)(import\\s+[^=+*\"'\\r\\n;\\/]+|from\\s+[^=+\"'\\r\\n;\\/]+)(;|\\/|$)/gm;\n\nfunction replace(raw, p1, p2, p3) {\n\tif (!/\\/\\//.test(p1)) {\n\t\treturn p1 + 'jsio(\"' + p2 + '\")' + p3;\n\t}\n\treturn raw;\n}\n\nexports = function (path, moduleDef, opts) {\n\tmoduleDef.src = moduleDef.src.replace(importExpr, replace);\n}\n","pre":true},"sdk/jsio/preprocessors/cls.js":{"path":"sdk/jsio/preprocessors/cls.js","friendlyPath":"preprocessors.cls","directory":"sdk/jsio/preprocessors/","filename":"cls.js","src":"\n// var F = exports = Class\n// exports = Class\nvar classExport = /^(.*?)exports\\s*=\\s*Class\\s*\\(/gm;\n\n// var F = Class\n// exports.F = Class\n// var F = exports.F = Class\nvar class2Export = /^(.*?[ \\t]+)?([a-zA-Z0-9\\.$]+)\\s*=\\s*Class\\s*\\(/gm;\n\nfunction replacer(base, prefix, name) {\n\tif (/\\/\\//.test(base)) {\n\t\treturn base;\n\t}\n\treturn name + '=__class__;' + (prefix || '') + name + '=' + name + '(function ' + name.replace(/[\\.]/g, '_') + '(){return this.init&&this.init.apply(this,arguments)},';\n}\n\nexports = function(path, moduleDef, opts) {\n\tvar moduleCtor = moduleDef.path.replace(/(^[.\\/]+|\\.([^.]+?)$)/g, '').replace(/[\\:\\\\\\/\\-\\. ]/g, '_');\n\tmoduleDef.src = moduleDef.src\n\t\t.replace(classExport, 'var ' + moduleCtor + '=__class__;$1exports=' + moduleCtor + '(function ' + moduleCtor + '(){return this.init&&this.init.apply(this,arguments)},')\n\t\t.replace(class2Export, replacer);\n}\n","pre":true},"sdk/gc/browser/simulateDevice.js":{"path":"sdk/gc/browser/simulateDevice.js","friendlyPath":".simulateDevice","directory":"sdk/gc/browser/","filename":"simulateDevice.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\njsio(\"import lib.Enum\");\n\nexports.simulate = function (params) {\n\tif (params.userAgent) {\n\t\tvar navigator = window.navigator;\n\t\tvar shim = window.navigator = {};\n\t\tfor (var i in navigator) {\n\t\t\tshim[i] = navigator[i];\n\t\t}\n\n\t\tshim.userAgent = params.userAgent;\n\t}\n\n\twindow.devicePixelRatio = params.devicePixelRatio || 1;\n\n\tjsio(\"import device\");\n\n\tvar deviceName = params.name.toLowerCase();\n\t\n\tdevice.simulating = params;\n\tdevice.simulatingMobileNative = params.target == \"native-android\" || params.target == \"native-ios\";\n\tdevice.simulatingMobileBrowser = params.target == \"browser-desktop\" || params.target == \"browser-mobile\";\n\t\n\tif (device.simulatingMobileBrowser) {\n\t\tdevice.isMobileBrowser = true;\n\t\tdevice.setUseDOM(true);\n\t}\n\n\tif (device.simulatingMobileNative) {\n\t\tdevice.setUseDOM(false);\n\t}\n\n}\n","pre":true},"sdk/gc/debugging/connect.js":{"path":"sdk/gc/debugging/connect.js","friendlyPath":"..debugging.connect","directory":"sdk/gc/debugging/","filename":"connect.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n// this whole file should not get included in release\nif (DEBUG) {\n\tjsio(\"import net\");\n\tjsio(\"import net.protocols.Cuppa\");\n\n\tjsio(\"import ._DEBUG\");\n\n\tvar _conn;\n\tGLOBAL._DEBUG = new _DEBUG();\n\n\texports.getConn = function () { return _conn; }\n\n\texports.connect = function (opts, cb) {\n\t\tvar transport = opts && opts.transport;\n\t\tvar connectOpts = opts && opts.opts;\n\n\t\tif (!transport) {\n\t\t\tif (window.parent != window) {\n\t\t\t\t// in iframe\n\t\t\t\ttransport = 'postmessage';\n\t\t\t\tconnectOpts = {\n\t\t\t\t\tport: '__debug_timestep_inspector__',\n\t\t\t\t\twin: window.parent\n\t\t\t\t};\n\t\t\t} else {\n\t\t\t\t// assume we're on a mobile device\n\t\t\t\ttransport = 'csp';\n\t\t\t\tconnectOpts = {\n\t\t\t\t\turl: 'http://' + window.location.host + '/plugins/native_debugger/mobile_csp'\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\t_conn = new DebugConn();\n\t\t_conn.onConnect(bind(GLOBAL, cb, _conn));\n\t\tnet.connect(_conn, transport, connectOpts);\n\n\t\treturn _conn;\n\t}\n\nDebugConn=__class__;\tvar DebugConn=DebugConn(function DebugConn(){return this.init&&this.init.apply(this,arguments)},net.protocols.Cuppa, function (supr) {\n\n\t\tthis.init = function () {\n\t\t\tsupr(this, 'init', arguments);\n\n\t\t\tthis._clients = [];\n\t\t}\n\n\t\tthis.setApp = function (app) {\n\t\t\tthis._clients.forEach(function (client) {\n\t\t\t\tif (client.setApp) {\n\t\t\t\t\tclient.setApp(app);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tthis.addClient = function (client) {\n\t\t\tthis._clients.push(client);\n\t\t\tclient.setConn(this);\n\t\t}\n\n\t\tthis.initLogProxy = function () {\n\t\t\tjsio(\"import .logProxy\");\n\t\t\tlogProxy.install(this);\n\t\t}\n\n\t\tthis.initRemoteEval = function () {\n\t\t\tjsio(\"import .remoteEval\");\n\t\t\tremoteEval.install(this);\n\t\t}\n\t});\n\n\tif ('onerror' in window) {\n\t\twindow.addEventListener('error', function (e) {\n\t\t\tjsio(\"import squill.Widget\");\n\t\t\tvar errDialog = new squill.Widget({\n\t\t\t\tparent: document.body,\n\t\t\t\tstyle: {\n\t\t\t\t\tposition: 'absolute',\n\t\t\t\t\tzIndex: 1000,\n\t\t\t\t\tbackground: 'rgba(0, 0, 0, 0.5)',\n\t\t\t\t\tdisplay: 'flex',\n\t\t\t\t\tflexDirection: 'column',\n\t\t\t\t\tjustifyContent: 'center',\n\t\t\t\t\tpadding: '0px 20px',\n\t\t\t\t\ttop: '0px',\n\t\t\t\t\tbottom: '0px',\n\t\t\t\t\tleft: '0px',\n\t\t\t\t\tright: '0px',\n\t\t\t\t\topacity: 0,\n\t\t\t\t\ttransition: 'opacity 0.5s'\n\t\t\t\t},\n\t\t\t\tchildren: [\n\t\t\t\t\t{\n\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\tbackground: 'rgba(255, 255, 255, 0.85)',\n\t\t\t\t\t\t\tpadding: '10px 20px 20px',\n\t\t\t\t\t\t\tborderRadius: '5px',\n\t\t\t\t\t\t\tborder: '3px solid red',\n\t\t\t\t\t\t\tboxShadow: 'inset 0px 0px 3px black'\n\t\t\t\t\t\t},\n\t\t\t\t\t\tchildren: [\n\t\t\t\t\t\t\t{tag: 'h3', text: 'an uncaught error occurred!'},\n\t\t\t\t\t\t\t{tag: 'div', text: e.message, style: {fontFamily: 'monospace', wordWrap: 'break-word', marginBottom: '10px'}},\n\t\t\t\t\t\t\t{id: 'halt', type: 'button', text: 'halt'},\n\t\t\t\t\t\t\t{id: 'resume', type: 'button', text: 'resume'}\n\t\t\t\t\t\t]\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t\t});\n\n\t\t\tsetTimeout(function () {\n\t\t\t\terrDialog.getElement().style.opacity = 1;\n\t\t\t}, 0);\n\n\t\t\terrDialog.halt.on('Select', function () {\n\t\t\t\terrDialog.remove();\n\t\t\t});\n\n\t\t\terrDialog.resume.on('Select', function () {\n\t\t\t\tjsio(\"import timer\");\n\t\t\t\ttimer.start();\n\t\t\t\terrDialog.remove();\n\t\t\t});\n\t\t});\n\t}\n}\n","pre":true},"sdk/jsio/net.js":{"path":"sdk/jsio/net.js","friendlyPath":"net","directory":"sdk/jsio/","filename":"net.js","baseMod":"net","basePath":"sdk/jsio","src":"jsio('import net.env');\njsio('import std.JSON as JSON');\n\nJSON.createGlobal(); // create the global JSON object if it doesn't already exist\n\n/**\n * @namespace\n */\n\nexports.listen = function(server, transportName, opts) {\n\tif (!transportName) {\n\t\tthrow logger.error('No transport provided for net.listen');\n\t}\n\t\n\tvar ctor = typeof transportName == 'string' ? net.env.getListener(transportName) : transportName,\n\t\tlistener = new ctor(server, opts);\n\n\tlistener.listen();\n\treturn listener;\n}\n\nexports.connect = function(protocolInstance, transportName, opts) {\n\tvar ctor = typeof transportName == 'string' ? net.env.getConnector(transportName) : transportName,\n\t\tconnector = new ctor(protocolInstance, opts);\n\tconnector.connect();\n\treturn connector;\n}\n\nexports.quickServer = function(protocolClass) {\n\tjsio('import net.interfaces');\n\treturn new net.interfaces.Server(protocolClass);\n}\n","pre":true},"sdk/jsio/net/env/browser/csp.js":{"path":"sdk/jsio/net/env/browser/csp.js","friendlyPath":"net.env.browser.csp","directory":"sdk/jsio/net/env/browser/","filename":"csp.js","src":"jsio('import net.interfaces');\njsio('from net.csp.client import CometSession');\njsio('import std.utf8 as utf8');\n\n/**\n * @extends net.interfaces.Connector\n */\nexports.Connector=__class__;exports.Connector=exports.Connector(function exports_Connector(){return this.init&&this.init.apply(this,arguments)},net.interfaces.Connector, function() {\n\tthis.connect = function() {\n\t\tthis._state = net.interfaces.STATE.CONNECTING;\n\t\t\n\t\tvar conn = new CometSession();\n\t\tconn.onconnect = bind(this, 'cometSessionOnConnect', conn);\n\t\tconn.ondisconnect = bind(this, 'onDisconnect');\n\t\t\n\t\tlogger.debug('opening the connection');\n\t\tif (!this._opts.encoding) { this._opts.encoding = 'plain'; }\n\t\tconn.connect(this._opts.url, this._opts);//{encoding: 'plain'});\n\t}\n\t\n\tthis.cometSessionOnConnect = function(conn) {\n\t\tlogger.debug('conn has opened');\n\t\tthis.onConnect(new Transport(conn));\n\t}\n});\n\nTransport=__class__;var Transport=Transport(function Transport(){return this.init&&this.init.apply(this,arguments)},net.interfaces.Transport, function() {\n\tthis.init = function(conn) {\n\t\tthis._conn = conn;\n\t}\n\t\n\tthis.makeConnection = function(protocol) {\n\t\tthis._conn.onread = bind(protocol, 'dataReceived');\n\t}\n\t\n\tthis.write = function(data) {\n\t\tthis._conn.write(data);\n\t}\n\t\n\tthis.loseConnection = function(protocol) {\n\t\tthis._conn.close();\n\t}\n});\n","pre":true},"sdk/jsio/net/interfaces.js":{"path":"sdk/jsio/net/interfaces.js","friendlyPath":"net.interfaces","directory":"sdk/jsio/net/","filename":"interfaces.js","src":"// Sort of like a twisted protocol\njsio('import net');\njsio('import lib.Enum as Enum');\n\nvar ctx = jsio.__env.global;\n\nexports.Protocol=__class__;exports.Protocol=exports.Protocol(function exports_Protocol(){return this.init&&this.init.apply(this,arguments)},function() {\n\tthis.connectionMade = function(isReconnect) {}\n\tthis.dataReceived = function(data) {}\n\tthis.connectionLost = function(reason) {}\n\t\n\tthis._connectionMade = function() {\n\t\tthis._isConnected = true;\n\t\tthis.connectionMade.apply(this, arguments);\n\t}\n\n\tthis._connectionLost = function() {\n\t\tthis._isConnected = true;\n\t\tthis.connectionLost.apply(this, arguments);\n\t}\n\n\tthis._isConnected = false;\n\tthis.isConnected = function() {\n\t\treturn !!this._isConnected;\n\t}\n\t\n\t\n});\n\nexports.Client=__class__;exports.Client=exports.Client(function exports_Client(){return this.init&&this.init.apply(this,arguments)},function() {\n\tthis.init = function(protocol) {\n\t\tthis._protocol = protocol;\n\t}\n\t\n\tthis.connect = function(transportName, opts) {\n\t\tthis._remote = new this._protocol();\n\t\tthis._remote._client = this;\n\t\tnet.connect(this._remote, transportName, opts);\n\t}\n});\n\n// Sort of like a twisted factory\nexports.Server=__class__;exports.Server=exports.Server(function exports_Server(){return this.init&&this.init.apply(this,arguments)},function() {\n\tthis.init = function(protocolClass) {\n\t\tthis._protocolClass = protocolClass;\n\t}\n\n\tthis.buildProtocol = function() {\n\t\treturn new this._protocolClass();\n\t}\n\t\n\tthis.listen = function(how, port) {\n\t\treturn net.listen(this, how, port);\n\t}\n});\n\nexports.Transport=__class__;exports.Transport=exports.Transport(function exports_Transport(){return this.init&&this.init.apply(this,arguments)},function() {\n\tthis._encoding = 'plain'\n\tthis.write = function(data, encoding) {\n\t\tthrow new Error(\"Not implemented\");\n\t}\n\tthis.getPeer = function() {\n\t\tthrow new Error(\"Not implemented\");\n\t}\n\tthis.setEncoding = function(encoding) {\n\t\tthis._encoding = encoding;\n\t}\n\tthis.getEncoding = function() {\n\t\treturn this._encoding;\n\t}\n});\n\nexports.Listener=__class__;exports.Listener=exports.Listener(function exports_Listener(){return this.init&&this.init.apply(this,arguments)},function() {\n\tthis.init = function(server, opts) {\n\t\tthis._server = server;\n\t\tthis._opts = opts || {};\n\t}\n\t\n\tthis.onConnect = function(transport) {\n\t\t//try {\n\t\t\tvar p = this._server.buildProtocol();\n\t\t\tp.transport = transport;\n\t\t\tp.server = this._server;\n\t\t\ttransport.protocol = p;\n\t\t\ttransport.makeConnection(p);\n\t\t\tp._connectionMade();\n\t\t//} catch(e) {\n\t\t//\tlogger.error(e);\n\t\t//}\n\t}\n\t\n\tthis.listen = function() { throw new Error('Abstract class'); }\n\tthis.stop = function() {}\n});\n\nexports.STATE = Enum('INITIAL', 'DISCONNECTED', 'CONNECTING', 'CONNECTED');\nexports.Connector=__class__;exports.Connector=exports.Connector(function exports_Connector(){return this.init&&this.init.apply(this,arguments)},function() {\n\tthis.init = function(protocol, opts) {\n\t\tthis._protocol = protocol;\n\t\tthis._opts = opts;\n\t\tthis._state = exports.STATE.INITIAL;\n\t}\n\t\n\tthis.getState = function() { return this._state; }\n\t\n\tthis.onConnect = function(transport) {\n\t\tthis._state = exports.STATE.CONNECTED;\n\n\t\ttransport.makeConnection(this._protocol);\n\t\tthis._protocol.transport = transport;\n\t\ttry {\n\t\t\tthis._protocol._connectionMade();\n\t\t} catch(e) {\n\t\t\tthrow logger.error(e);\n\t\t}\n\t}\n\t\n\tthis.onDisconnect = function(err) {\n\t\tvar wasConnected = this._state == exports.STATE.CONNECTED;\n\t\tthis._state = exports.STATE.DISCONNECTED;\n\t\t\n\t\ttry {\n\t\t\tthis._protocol._connectionLost(err, wasConnected);\n\t\t} catch(e) {\n\t\t\tthrow logger.error(e);\n\t\t}\n\t}\n\t\n\tthis.getProtocol = function() { return this._protocol; }\n});\n","pre":true},"sdk/jsio/net/csp/client.js":{"path":"sdk/jsio/net/csp/client.js","friendlyPath":"net.csp.client","directory":"sdk/jsio/net/csp/","filename":"client.js","src":"jsio('import std.base64 as base64');\njsio('import std.utf8 as utf8');\njsio('import std.uri as uri'); \njsio('import net.errors as errors');\njsio('import .transports');\njsio('import lib.Enum as Enum');\n\nvar READYSTATE = exports.READYSTATE = Enum({\n\tINITIAL: 0,\n\tCONNECTING: 1,\n\tCONNECTED: 2,\n\tDISCONNECTING: 3,\n\tDISCONNECTED:  4\n});\n\n\nexports.CometSession=__class__;exports.CometSession=exports.CometSession(function exports_CometSession(){return this.init&&this.init.apply(this,arguments)},function(supr) {\n\tvar id = 0;\n\tvar kDefaultBackoff = 50;\n\tvar kDefaultTimeoutInterval = 45000;\n\tvar kDefaultHandshakeTimeout = 10000;\n\tthis.init = function() {\n\t\tthis._id = ++id;\n\t\tthis._url = null;\n\t\tthis.readyState = READYSTATE.INITIAL;\n\t\tthis._sessionKey = null;\n\t\tthis._transport = null;\n\t\tthis._options = null;\n\t\t\n\t\tthis._utf8ReadBuffer = \"\";\n\t\tthis._writeBuffer = \"\";\n\t\t\n\t\tthis._packetsInFlight = null;\n\t\tthis._lastEventId = null;\n\t\tthis._lastSentId = null;\n\t\t\n\t\tthis._handshakeLater = null;\n\t\tthis._handshakeBackoff = kDefaultBackoff;\n\t\tthis._handshakeRetryTimer = null;\n\t\tthis._handshakeTimeoutTimer = null;\n\n\t\tthis._timeoutTimer = null;\n\n\t\t\n\t\tthis._writeBackoff = kDefaultBackoff;\n\t\tthis._cometBackoff = kDefaultBackoff;\n\t\t\n\t\tthis._nullInBuffer = false;\n\t\tthis._nullInFlight= false;\n\t\tthis._nullSent = false;\n\t\tthis._nullReceived = false;\n\t}\n\t\n\t\n\tthis.setEncoding = function(encoding) {\n\t\tif (encoding == this._options.encoding) { \n\t\t\treturn; \n\t\t}\n\t\tif (encoding != 'utf8' && encoding != 'plain') {\n\t\t\tthrow new errors.InvalidEncodingError();\n\t\t}\n\t\tif (encoding == 'plain' && this._buffer) {\n\t\t\tvar buffer = this._utf8ReadBuffer;\n\t\t\tthis._utf8ReadBuffer = \"\";\n\t\t\tthis._doOnRead(buffer);\n\t\t}\n\t\tthis._options.encoding = encoding;\n\t}\n\n\n\tthis.connect = function(url, options) {\n\t\tthis._url = url.replace(/\\/$/,'');\n\t\tthis._options = options || {};\n\t\t\n\t\tthis._options.encoding = this._options.encoding || 'utf8';\n\t\tthis.setEncoding(this._options.encoding); // enforce encoding constraints\n\t\t\n\t\tthis._options.connectTimeout = this._options.connectTimeout || kDefaultHandshakeTimeout;\n\t\t\n\t\tvar transportClass = transports.chooseTransport(url, this._options);\n\t\tthis._transport = new transportClass();\n\t\t\n\t\tthis._transport.handshakeFailure = bind(this, this._handshakeFailure);\n\t\tthis._transport.handshakeSuccess = bind(this, this._handshakeSuccess);\n\t\t\n\t\tthis._transport.cometFailure = bind(this, this._cometFailure);\n\t\tthis._transport.cometSuccess = bind(this, this._cometSuccess);\n\t\t\n\t\tthis._transport.sendFailure = bind(this, this._writeFailure);\n\t\tthis._transport.sendSuccess = bind(this, this._writeSuccess);\n\t\tthis.readyState = READYSTATE.CONNECTING;\n\t\tthis._transport.handshake(this._url, this._options);\n\t\t\n\t\tthis._handshakeTimeoutTimer = setTimeout(bind(this, this._handshakeTimeout), \n\t\t\tthis._options.connectTimeout);\n\t}\n\n\tthis.write = function(data, encoding) {\n\t\tif (this.readyState != READYSTATE.CONNECTED) {\n\t\t\tthrow new errors.ReadyStateError();\n\t\t}\n\t\tencoding = encoding || this._options.encoding || 'utf8';\n\t\tif (encoding == 'utf8') {\n\t\t\tdata = utf8.encode(data);\n\t\t}\n\t\tthis._writeBuffer += data;\n\t\tthis._doWrite();\n\t}\n\t\n\t// Close due to protocol error\n\tthis._protocolError = function(msg) {\n\t\tlogger.debug('_protocolError', msg);\n\t\t// Immediately fire the onclose\n\t\t// send a null packet to the server\n\t\t// don't wait for a null packet back.\n\t\tthis.readyState = READYSTATE.DISCONNECTED;\n\t\tthis._doWrite(true);\n\t\tthis._doOnDisconnect(new errors.ServerProtocolError(msg));\n\t}\n\t\n\tthis._receivedNullPacket = function() {\n\t\tlogger.debug('_receivedNullPacket');\n\t\t// send a null packet back to the server\n\t\tthis._receivedNull = true;\n\t\t\n\t\t// send our own null packet back. (maybe)\n\t\tif (!(this._nullInFlight || this._nullInBuffer || this._nullSent)) {\n\t\t\tthis.readyState = READYSTATE.DISCONNECTING;\n\t\t\tthis._doWrite(true);\n\t\t}\n\t\telse {\n\t\t\tthis.readyState = READYSTATE.DISCONNECTED;\n\t\t}\n\t\t\n\t\t// fire an onclose\n\t\tthis._doOnDisconnect(new errors.ConnectionClosedCleanly());\n\n\t}\n\t\n\tthis._sentNullPacket = function() {\n\t\tlogger.debug('_sentNullPacket');\n\t\tthis._nullSent = true;\n\t\tif (this._nullSent && this._nullReceived) {\n\t\t\tthis.readyState = READYSTATE.DISCONNECTED;\n\t\t}\n\t}\n\t\n\t\n\t// User Calls close\n\tthis.close = function(err) {\n\t\tlogger.debug('close called', err, 'readyState', this.readyState);\n\n\t\t// \n\t\tswitch(this.readyState) {\n\t\t\tcase READYSTATE.CONNECTING:\n\t\t\t\tclearTimeout(this._handshakeRetryTimer);\n\t\t\t\tclearTimeout(this._handshakeTimeoutTimer);\n\t\t\t\tthis.readyState = READYSTATE.DISCONNECTED;\n\t\t\t\tthis._doOnDisconnect(err);\n\t\t\t\tbreak;\n\t\t\tcase READYSTATE.CONNECTED:\n\t\t\t\tthis.readyState = READYSTATE.DISCONNECTING;\n\t\t\t\tthis._doWrite(true);\n\t\t\t\tclearTimeout(this._timeoutTimer);\n\t\t\t\tbreak;\n\t\t\tcase READYSTATE.DISCONNECTED:\n\t\t\t\tthrow new errors.ReadyStateError(\"Session is already disconnected\");\n\t\t\t\tbreak;\n\t\t}\n\t\t\n\t\t\n\t\tthis._opened = false; // what is this used for???\n\t\tthis.readyState = READYSTATE.DISCONNECTED;\n\t\t\n\t\tthis._doOnDisconnect(err);\n\t\tthis._sessionKey = null;\n\t}\n\t\n\tthis._handshakeTimeout = function() {\n\t\tlogger.debug('handshake timeout');\n\t\tthis._handshakeTimeoutTimer = null;\n\t\tclearTimeout(this._handshakeRetryTimer);\n\t\tif (this.readyState == READYSTATE.CONNECTING) {\n\t\t\tthis.readyState = READYSTATE.DISCONNECTED;\n\t\t}\n\t\t\n\t\tthis._doOnDisconnect(new errors.ServerUnreachable());\n\t}\n\t\n\tthis._handshakeSuccess = function(data) {\n\t\tlogger.debug('handshake success', data);\n\t\tif (this.readyState != READYSTATE.CONNECTING) { \n\t\t\tlogger.debug('received handshake success in invalid readyState:', this.readyState);\n\t\t\treturn; \n\t\t}\n\t\tclearTimeout(this._handshakeTimeoutTimer);\n\t\tthis._handshakeTimeoutTimer = null;\n\t\tthis._sessionKey = data.response.session;\n\t\tthis._opened = true;\n\t\tthis.readyState = READYSTATE.CONNECTED;\n\t\tthis._doOnConnect();\n\t\tthis._doConnectComet();\n\t}\n\t\n\tthis._handshakeFailure = function(data) {\n\t\tlogger.debug('handshake failure', data);\n\t\tif (this.readyState != READYSTATE.CONNECTING) { return; }\n\t\tif (data.status == 404) {\n\t\t\tclearTimeout(this._handshakeTimeoutTimer);\n\t\t\treturn this._doOnDisconnect(new errors.ServerUnreachable());\n\t\t}\n\t\t\n\t\tlogger.debug('trying again in ', this._handshakeBackoff);\n\t\tthis._handshakeRetryTimer = setTimeout(bind(this, function() {\n\t\t\tthis._handshakeRetryTimer = null;\n\t\t\tthis._transport.handshake(this._url, this._options);\n\t\t}), this._handshakeBackoff);\n\t\t\n\t\tthis._handshakeBackoff *= 2;\n\t}\n\t\n\tthis._writeSuccess = function() {\n\t\tif (this.readyState != READYSTATE.CONNECTED && this.readyState != READYSTATE.DISCONNECTING) {\n\t\t\treturn;\n\t\t}\n\t\tif (this._nullInFlight) {\n\t\t\treturn this._sentNullPacket();\n\t\t}\n\t\tthis._resetTimeoutTimer();\n\t\tthis.writeBackoff = kDefaultBackoff;\n\t\tthis._packetsInFlight = null;\n\t\tif (this._writeBuffer || this._nullInBuffer) {\n\t\t\tthis._doWrite(this._nullInBuffer);\n\t\t}\n\t}\n\t\n\tthis._writeFailure = function() {\n\t\tif (this.readyState != READYSTATE.CONNECTED && this.READYSTATE != READYSTATE.DISCONNECTING) { return; }\n\t\tthis._writeTimer = setTimeout(bind(this, function() {\n\t\t\tthis._writeTimer = null;\n\t\t\tthis.__doWrite(this._nullInBuffer);\n\t\t}), this._writeBackoff);\n\t\tthis._writeBackoff *= 2;\n\t}\t\n\n\tthis._doWrite = function(sendNull) {\n\t\tif (this._packetsInFlight) {\n\t\t\tif (sendNull) {\n\t\t\t\tthis._nullInBuffer = true;\n\t\t\t\treturn; \n\t\t\t}\n\t\t\treturn;\n\t\t}\n\t\tthis.__doWrite(sendNull);\n\t}\n\t\n\tthis.__doWrite = function(sendNull) {\n\t\tlogger.debug('_writeBuffer:', this._writeBuffer);\n\t\tif (!this._packetsInFlight && this._writeBuffer) {\n\t\t\tthis._packetsInFlight = [this._transport.encodePacket(++this._lastSentId, this._writeBuffer, this._options)];\n\t\t\tthis._writeBuffer = \"\";\n\t\t}\n\t\tif (sendNull && !this._writeBuffer) {\n\t\t\tif (!this._packetsInFlight) {\n\t\t\t\tthis._packetsInFlight = [];\n\t\t\t}\n\t\t\tthis._packetsInFlight.push([++this._lastSentId, 0, null]);\n\t\t\tthis._nullInFlight = true;\n\t\t}\n\t\tif (!this._packetsInFlight) {\n\t\t\tlogger.debug(\"no packets to send\");\n\t\t\treturn;\n\t\t}\n\t\tlogger.debug('sending packets:', JSON.stringify(this._packetsInFlight));\n\t\tthis._transport.send(this._url, this._sessionKey, this._lastEventId || 0, JSON.stringify(this._packetsInFlight), this._options);\n\t}\n\t\n\tthis._doConnectComet = function() {\n\t\tlogger.debug('_doConnectComet');\n//\t\treturn;\n\t\tthis._transport.comet(this._url, this._sessionKey, this._lastEventId || 0, this._options);\n\t}\n\n\tthis._cometFailure = function(data) {\n\t\tif (this.readyState != READYSTATE.CONNECTED) { return; }\n\t\tif (data.status == 404 && data.response == 'Session not found') {\n\t\t\treturn this.close(new errors.ExpiredSession(data));\n\t\t}\n\t\t\n\t\tthis._cometTimer = setTimeout(bind(this, '_doConnectComet'), this._cometBackoff);\n\t\tthis._cometBackoff *= 2;\n\t}\n\t\n\tthis._cometSuccess = function(data) {\n\t\tif (this.readyState != READYSTATE.CONNECTED && this.readyState != READYSTATE.DISCONNECTING) { return; }\n\t\tlogger.debug('comet Success:', data);\n\t\tthis._cometBackoff = kDefaultBackoff;\n\t\tthis._resetTimeoutTimer();\n\t\t\n\t\tvar response = data.response;\n\t\tfor (var i = 0, packet; (packet = response[i]) || i < response.length; i++) {\n\t\t\tlogger.debug('process packet:', packet);\n\t\t\tif (packet === null) {\n\t\t\t\treturn this.close(new errors.ServerProtocolError(data));\n\t\t\t}\n\t\t\tlogger.debug('process packet', packet);\n\t\t\tvar ackId = packet[0];\n\t\t\tvar encoding = packet[1];\n\t\t\tvar data = packet[2];\n\t\t\tif (typeof(this._lastEventId) == 'number' && ackId <= this._lastEventId) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (typeof(this._lastEventId) == 'number' && ackId != this._lastEventId+1) {\n\t\t\t\treturn this._protocolError(\"Ack id too high\");\n\t\t\t}\n\t\t\tthis._lastEventId = ackId;\n\t\t\tif (data == null) {\n\t\t\t\treturn this._receivedNullPacket();\n\t\t\t}\n\t\t\tif (encoding == 1) { // base64 encoding\n\t\t\t\ttry {\n\t\t\t\t\tlogger.debug('before base64 decode:', data);\n\t\t\t\t\tdata = base64.decode(data);\n\t\t\t\t\tlogger.debug('after base64 decode:', data);\n\t\t\t\t} catch(e) {\n\t\t\t\t\treturn this._protocolError(\"Unable to decode base64 payload\");\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (this._options.encoding == 'utf8') {\n\t\t\t\t// TODO: need an incremental utf8 decoder for this stuff.\n\t\t\t\tthis._utf8ReadBuffer += data;\n\t\t\t\tlogger.debug('before utf8 decode, _utf8ReadBuffer:', this._utf8ReadBuffer);\n\t\t\t\tvar result = utf8.decode(this._utf8ReadBuffer);\n\t\t\t\tdata = result[0];\n\t\t\t\tthis._utf8ReadBuffer = this._utf8ReadBuffer.slice(result[1]);\n\t\t\t\tlogger.debug('after utf8 decode, _utf8ReadBuffer:', this._utf8ReadBuffer, 'data:', data );\n\t\t\t}\n\t\t\tlogger.debug('dispatching data:', data);\n\n\t\t\t// TODO: possibly catch this error in production? but not in dev\n\t\t\tthis._doOnRead(data);\n\t\t}\n\t\t\n\t\tif (this.readyState != READYSTATE.CONNECTED && this.readyState != READYSTATE.DISCONNECTING) { return; }\n\t\t\n\t\t// reconnect comet last, after we process all of the packet ids\n\t\tthis._doConnectComet();\n\t\t\n\t}\n\n\tthis._doOnRead = function(data) {\n\t\tif (typeof(this.onread) == 'function') {\n\t\t\tlogger.debug('call onread function', data);\n\t\t\tthis.onread(data);\n\t\t}\n\t\telse {\n\t\t\tlogger.debug('skipping onread callback (function missing)');\n\t\t}\n\t}\n\t\n\tthis._doOnDisconnect = function(err) {\n\t\tif (typeof(this.ondisconnect) == 'function') {\n\t\t\tlogger.debug('call ondisconnect function', err);\n\t\t\tthis.ondisconnect(err);\n\t\t}\n\t\telse {\n\t\t\tlogger.debug('skipping ondisconnect callback (function missing)');\n\t\t}\n\t}\n\t\n\tthis._doOnConnect = function() {\n\t\tif (typeof(this.onconnect) == 'function') {\n\t\t\tlogger.debug('call onconnect function');\n\t\t\ttry {\n\t\t\t\tthis.onconnect();\n\t\t\t} catch(e) {\n\t\t\t\tlogger.debug('onconnect caused errror', e);\n\t\t\t\t// throw error later\n\t\t\t\tsetTimeout(function() { throw e }, 0);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tlogger.debug('skipping onconnect callback (function missing)');\n\t\t}\n\t}\n\n\tthis._resetTimeoutTimer = function() {\n\t\tclearTimeout(this._timeoutTimer);\n\t\tthis._timeoutTimer = setTimeout(bind(this, function() {\n\t\t\tlogger.debug('connection timeout expired');\n\t\t\tthis.close(new errors.ConnectionTimeout())\n\t\t}), this._getTimeoutInterval())\n\t}\n\t\n\tthis._getTimeoutInterval = function() {\n\t\treturn kDefaultTimeoutInterval;\n\t}\n\n});\n","pre":true},"sdk/jsio/std/base64.js":{"path":"sdk/jsio/std/base64.js","friendlyPath":"std.base64","directory":"sdk/jsio/std/","filename":"base64.js","src":"/*\n\"URL-safe\" Base64 Codec, by Jacob Rus\n\nThis library happily strips off as many trailing '=' as are included in the\ninput to 'decode', and doesn't worry whether its length is an even multiple\nof 4. It does not include trailing '=' in its own output. It uses the\n'URL safe' base64 alphabet, where the last two characters are '-' and '_'.\n\n--------------------\n\nCopyright (c) 2009 Jacob Rus\n\nPermission is hereby granted, free of charge, to any person\nobtaining a copy of this software and associated documentation\nfiles (the \"Software\"), to deal in the Software without\nrestriction, including without limitation the rights to use,\ncopy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the\nSoftware is furnished to do so, subject to the following\nconditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES\nOF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\nHOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\nWHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\nFROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\nOTHER DEALINGS IN THE SOFTWARE.\n*/\n\nvar alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_',\n\ttrailingPad = '=',\n\tpadChar = alphabet.charAt(alphabet.length - 1);\n\nvar decodeMap = {};\nfor (var i = 0, len = alphabet.length; i < len; i++) {\n\tdecodeMap[alphabet.charAt(i)] = i;\n}\n\n// use this regexp in the decode function to sniff out invalid characters.\nvar alphabet_inverse = new RegExp('[^' + alphabet.replace('-', '\\\\-') + ']');\n\nexports.Base64CodecError=__class__;exports.Base64CodecError=exports.Base64CodecError(function exports_Base64CodecError(){return this.init&&this.init.apply(this,arguments)},Error, function(supr) {\n\tthis.name = 'Base64CodecError';\n\t\n\tthis.init = function(message) {\n\t\tthis.message = message;\n\t}\n});\n\nvar assertOrBadInput = function (exp, message) {\n\tif (!exp) { throw new exports.Base64CodecError(message) };\n};\n\nexports.encode = function (bytes, skipPadding) {\n\tassertOrBadInput(!(/[^\\x00-\\xFF]/.test(bytes)), // disallow two-byte chars\n\t\t'Input contains out-of-range characters.');\n\tvar paddingSize = bytes.length % 3;\n\tvar padding = '\\x00\\x00\\x00'.slice(paddingSize || 3);\n\tbytes += padding; // pad with null bytes\n\tvar out_array = [];\n\tfor (var i=0, n=bytes.length; i < n; i+=3) {\n\t\tvar newchars = (\n\t\t\t(bytes.charCodeAt(i)   << 020) +\n\t\t\t(bytes.charCodeAt(i+1) << 010) +\n\t\t\t(bytes.charCodeAt(i+2)));\n\t\tout_array.push(\n\t\t\talphabet.charAt((newchars >> 18) & 077),\n\t\t\talphabet.charAt((newchars >> 12) & 077),\n\t\t\talphabet.charAt((newchars >> 6)  & 077),\n\t\t\talphabet.charAt((newchars)       & 077));\n\t};\n\t\n\tout_array.length -= padding.length;\n\tvar ret = out_array.join('');\n\tif (!skipPadding) {\n\t\tif (paddingSize == 1) {\n\t\t\tret += '==';\n\t\t} else if (paddingSize == 2) {\n\t\t\tret += '=';\n\t\t}\n\t}\n\t\n\treturn ret;\n};\n\nexports.decode = function (b64text) {\n\tlogger.debug('decode', b64text);\n\tb64text = b64text.replace(/\\s/g, ''); // kill whitespace\n\t\n\t// strip trailing pad characters from input; // XXX maybe some better way?\n\tvar i = b64text.length;\n\twhile (b64text.charAt(--i) === trailingPad) {};\n\tb64text = b64text.slice(0, i + 1);\n\t\n\tassertOrBadInput(!alphabet_inverse.test(b64text), 'Input contains out-of-range characters.');\n\t\n\tvar padLength = 4 - ((b64text.length % 4) || 4),\n\t\tpadding = Array(padLength + 1).join(padChar);\n\t\n\tb64text += padding; // pad with last letter of alphabet\n\t\n\tvar out_array = [],\n\t\tlength = i + padLength + 1; // length of b64text\n\t\n\tfor (var i = 0; i < length; i += 4) {\n\t\tnewchars = (\n\t\t\t(decodeMap[b64text.charAt(i)]   << 18) +\n\t\t\t(decodeMap[b64text.charAt(i+1)] << 12) +\n\t\t\t(decodeMap[b64text.charAt(i+2)] << 6)  +\n\t\t\t(decodeMap[b64text.charAt(i+3)]));\n\t\tout_array.push(\n\t\t\t(newchars >> 020) & 0xFF,\n\t\t\t(newchars >> 010) & 0xFF, \n\t\t\t(newchars)\t\t& 0xFF);\n\t};\n\t\n\tlength = (out_array.length -= padLength);\n\t\n\t// Safari fromCharCode can't be passed more than 65536 arguments at once\n\tvar result,\n\t\tMAX_CHUNK = 65536;\n\t\n\tif (length > MAX_CHUNK) {\n\t\tresult = [];\n\t\tvar i = 0, j = 0;\n\t\twhile (i < length) {\n\t\t\tresult[j++] = String.fromCharCode.apply(String, out_array.slice(i, i + MAX_CHUNK));\n\t\t\ti += MAX_CHUNK;\n\t\t}\n\t\tresult = result.join('');\n\t} else {\n\t\tresult = String.fromCharCode.apply(String, out_array);\n\t}\n\tlogger.debug('decoded', result);\n\treturn result;\n};\n","pre":true},"sdk/jsio/std/utf8.js":{"path":"sdk/jsio/std/utf8.js","friendlyPath":"std.utf8","directory":"sdk/jsio/std/","filename":"utf8.js","src":"/*\nFast incremental JavaScript UTF-8 encoder/decoder, by Jacob Rus.\n\nAPI for decode from Orbited: as far as I know, the first incremental\nJavaScript UTF-8 decoder.\n\nInspired by the observation by Johan Sundström published at:\nhttp://ecmanaut.blogspot.com/2006/07/encoding-decoding-utf8-in-javascript.html\n\nNote that this code throws an error for invalid UTF-8. Because it is so much\nfaster than previous implementations, the recommended way to do lenient\nparsing is to first try this decoder, and then fall back on a slower lenient\ndecoder if necessary for the particular use case.\n\n--------------------\n\nCopyright (c) 2009 Jacob Rus\n\nPermission is hereby granted, free of charge, to any person\nobtaining a copy of this software and associated documentation\nfiles (the \"Software\"), to deal in the Software without\nrestriction, including without limitation the rights to use,\ncopy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the\nSoftware is furnished to do so, subject to the following\nconditions:\n\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES\nOF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\nHOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\nWHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\nFROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\nOTHER DEALINGS IN THE SOFTWARE.\n*/\n//var utf8 = this.utf8 = exports;\n\nexports.UnicodeCodecError = function (message) { \n\tthis.message = message; \n};\n\nvar UnicodeCodecError = exports.UnicodeCodecError;\n\nUnicodeCodecError.prototype.toString = function () {\n\treturn 'UnicodeCodecError' + (this.message ? ': ' + this.message : '');\n};\n\nexports.encode = function (unicode_string) {\n\t// Unicode encoder: Given an arbitrary unicode string, returns a string\n\t// of characters with code points in range 0x00 - 0xFF corresponding to\n\t// the bytes of the utf-8 representation of those characters.\n\ttry {\n\t\treturn unescape(encodeURIComponent(unicode_string));\n\t}\n\tcatch (err) {\n\t\tthrow new UnicodeCodecError('invalid input string');\n\t};\n};\nexports.decode = function (bytes) {\n\t// Unicode decoder: Given a string of characters with code points in\n\t// range 0x00 - 0xFF, which, when interpreted as bytes, are valid UTF-8,\n\t// returns the corresponding Unicode string, along with the number of\n\t// bytes in the input string which were successfully parsed.\n\t//\n\t// Unlike most JavaScript utf-8 encode/decode implementations, properly\n\t// deals with partial multi-byte characters at the end of the byte string.\n\tif (/[^\\x00-\\xFF]/.test(bytes)) {\n\t\tthrow new UnicodeCodecError('invalid utf-8 bytes');\n\t};\n\tvar len, len_parsed;\n\tlen = len_parsed = bytes.length;\n\tvar last = len - 1;\n\t// test for non-ascii final byte. if last byte is ascii (00-7F) we're done.\n\tif (bytes.charCodeAt(last) >= 0x80) {\n\t\t// loop through last 3 bytes looking for first initial byte of unicode\n\t\t// multi-byte character. If the initial byte is 4th from the end, we'll\n\t\t// parse the whole string.\n\t\tfor (var i = 1; i <= 3; i++) {\n\t\t\t// initial bytes are in range C0-FF\n\t\t\tif (bytes.charCodeAt(len - i) >= 0xC0) {\n\t\t\t\tlen_parsed = len - i;\n\t\t\t\tbreak;\n\t\t\t};\n\t\t};\n\t\ttry {\n\t\t\t// if the last few bytes are a complete multi-byte character, parse\n\t\t\t// everything (by setting len_parsed)\n\t\t\tdecodeURIComponent(escape(bytes.slice(len_parsed)));\n\t\t\tlen_parsed = len;\n\t\t}\n\t\tcatch (err) { /* pass */ };\n\t};\n\ttry {\n\t\treturn [\n\t\t\tdecodeURIComponent(escape(bytes.slice(0, len_parsed))),\n\t\t\tlen_parsed\n\t\t];\n\t}\n\tcatch (err) {\n\t\tthrow new UnicodeCodecError('invalid utf-8 bytes');\n\t};\n};\n","pre":true},"sdk/jsio/net/errors.js":{"path":"sdk/jsio/net/errors.js","friendlyPath":"net.errors","directory":"sdk/jsio/net/","filename":"errors.js","src":"var makeErrorClass = function(name, _code) {\n\tvar toString = function() {\n\t\treturn name + (this.message ? ': ' + this.message : '');\n\t}\n\n\tvar ctor = function(data) {\n\t\tif (typeof data == 'string') {\n\t\t\tthis.message = data;\n\t\t} else {\n\t\t\tthis.data = data;\n\t\t}\n\t}\n\t\n\tctor.prototype = {\n\t\ttype: name,\n\t\ttoString: toString\n\t};\n\t\n\treturn ctor;\n}\n\nexports.ReadyStateError = makeErrorClass(\"ReadyStateError\");\nexports.InvalidEncodingError = makeErrorClass(\"InvalidEncodingError\");\nexports.ExpiredSession = makeErrorClass(\"ExpiredSession\");\n\nexports.ServerUnreachable = makeErrorClass(\"ServerUnreachable\", 100);\nexports.ConnectionTimeout = makeErrorClass(\"ConnectionTimeout\", 101);\n\nexports.ServerProtocolError = makeErrorClass(\"ServerProtocolError\", 200);\n\nexports.ServerClosedConnection = makeErrorClass(\"ServerClosedConnection\", 301);\nexports.ConnectionClosedCleanly = makeErrorClass(\"ConnectionClosedCleanly\", 300);","pre":true},"sdk/jsio/net/csp/transports.js":{"path":"sdk/jsio/net/csp/transports.js","friendlyPath":".transports","directory":"sdk/jsio/net/csp/","filename":"transports.js","src":"jsio('import std.uri as uri'); \njsio('import std.base64 as base64');\njsio('from util.browserdetect import BrowserDetect');\n\n;(function() {\n\tvar doc;\n\texports.getDoc = function() {\n\t\tif (doc) { return doc; }\n\t\ttry {\n\t\t\tdoc = window.ActiveXObject && new ActiveXObject('htmlfile');\n\t\t\tif (doc) {\n\t\t\t\tdoc.open().write('<html></html>');\n\t\t\t\tdoc.close();\n\t\t\t\twindow.attachEvent('onunload', function() {\n\t\t\t\t\ttry { doc.body.innerHTML = ''; } catch(e) {}\n\t\t\t\t\tdoc = null;\n\t\t\t\t});\n\t\t\t}\n\t\t} catch(e) {}\n\t\t\n\t\tif (!doc) { doc = document; }\n\t\treturn doc;\n\t};\n\n\texports.XHR = function() {\n\t\tvar win = window,\n\t\t\tdoc = exports.getDoc();\n\t\t//if (doc.parentWindow) { win = doc.parentWindow; }\n\t\t\n\t\treturn new (exports.XHR = win.XMLHttpRequest ? win.XMLHttpRequest\n\t\t\t: function() { return win.ActiveXObject && new win.ActiveXObject('Msxml2.XMLHTTP') || null; });\n\t}\n\t\n\texports.createXHR = function() { return new exports.XHR(); }\n\n})();\n\nfunction isLocalFile(url) { return /^file:\\/\\//.test(url); }\nfunction isWindowDomain(url) { return uri.isSameDomain(url, window.location.href); }\n\nvar xhrSupportsBinary = undefined;\nfunction checkXHRBinarySupport(xhr) {\n\txhrSupportsBinary = !!xhr.sendAsBinary;\n}\n\nfunction canUseXHR(url) {\n\t// always use jsonp for local files\n\tif (isLocalFile(url)) { return false; }\n\t\n\t// try to create an XHR using the same function the XHR transport uses\n\tvar xhr = new exports.XHR();\n\tif (!xhr) { return false; }\n\t\n\tcheckXHRBinarySupport(xhr);\n\t\n\t// if the URL requested is the same domain as the window,\n\t// then we can use same-domain XHRs\n\tif (isWindowDomain(url)) { return true; }\n\t\n\t// if the URL requested is a different domain than the window,\n\t// then we need to check for cross-domain support\n\tif (window.XMLHttpRequest\n\t\t\t&& (xhr.__proto__ == XMLHttpRequest.prototype // WebKit Bug 25205\n\t\t\t\t|| xhr instanceof window.XMLHttpRequest)\n\t\t\t&& xhr.withCredentials !== undefined\n\t\t|| window.XDomainRequest \n\t\t\t&& xhr instanceof window.XDomainRequest) {\n\t\treturn true;\n\t}\n};\n\nvar transports = exports.transports = {};\n\nexports.chooseTransport = function(url, options) {\n\tswitch(options.preferredTransport) {\n\t\tcase 'jsonp':\n\t\t\treturn transports.jsonp;\n\t\tcase 'xhr':\n\t\tdefault:\n\t\t\tif (canUseXHR(url)) { return transports.xhr; };\n\t\t\treturn transports.jsonp;\n\t}\n};\n\n// TODO: would be nice to use these somewhere...\n\nvar PARAMS = {\n\t'xhrstream':   {\"is\": \"1\", \"bs\": \"\\n\"},\n\t'xhrpoll':     {\"du\": \"0\"},\n\t'xhrlongpoll': {},\n\t'sselongpoll': {\"bp\": \"data: \", \"bs\": \"\\r\\n\", \"se\": \"1\"},\n\t'ssestream':   {\"bp\": \"data: \", \"bs\": \"\\r\\n\", \"se\": \"1\", \"is\": \"1\"}\n};\n\nexports.Transport=__class__;exports.Transport=exports.Transport(function exports_Transport(){return this.init&&this.init.apply(this,arguments)},function(supr) {\n\tthis.handshake = function(url, options) {\n\t\tthrow new Error(\"handshake Not Implemented\"); \n\t};\n\tthis.comet = function(url, sessionKey, lastEventId, options) { \n\t\tthrow new Error(\"comet Not Implemented\"); \n\t};\n\tthis.send = function(url, sessionKey, data, options) { \n\t\tthrow new Error(\"send Not Implemented\");\n\t};\n\tthis.encodePacket = function(packetId, data, options) { \n\t\tthrow new Error(\"encodePacket Not Implemented\"); \n\t};\n\tthis.abort = function() { \n\t\tthrow new Error(\"abort Not Implemented\"); \n\t};\n});\n\nbaseTransport=__class__;var baseTransport=baseTransport(function baseTransport(){return this.init&&this.init.apply(this,arguments)},exports.Transport, function(supr) {\n\tthis.init = function() {\n\t\tthis._aborted = false;\n\t\tthis._handshakeArgs = {ct:'application/javascript'};\n\t\tthis._handshakeData = '{}'\n\t};\n\t\n\tthis.handshake = function(url, options) {\n\t\tlogger.debug('handshake:', url, options);\n\t\tthis._makeRequest('send', url + '/handshake', \n\t\t\t\t\t\t  this._handshakeArgs,\n\t\t\t\t\t\t  this._handshakeData,\n\t\t\t\t\t\t  this.handshakeSuccess, \n\t\t\t\t\t\t  this.handshakeFailure);\n\t};\n\t\n\tthis.comet = function(url, sessionKey, lastEventId, options) {\n\t\tlogger.debug('comet:', url, sessionKey, lastEventId, options);\n\t\tvar args = {\n\t\t\ts: sessionKey,\n\t\t\ta: lastEventId\n\t\t};\n\t\tthis._makeRequest('comet', url + '/comet', \n\t\t\t\t\t\t  args,\n\t\t\t\t\t\t  null,\n\t\t\t\t\t\t  this.cometSuccess, \n\t\t\t\t\t\t  this.cometFailure);\n\t};\n\t\n\tthis.send = function(url, sessionKey, lastEventId, data, options) {\n\t\t//logger.debug('send:', url, sessionKey, data, options);\n\t\tvar args = {\n\t\t\ts: sessionKey,\n\t\t\ta: lastEventId\n\t\t};\n\t\tthis._makeRequest('send', url + '/send', \n\t\t\t\t\t\t  args,\n\t\t\t\t\t\t  data,\n\t\t\t\t\t\t  this.sendSuccess, \n\t\t\t\t\t\t  this.sendFailure);\n\t};\n});\n\ntransports.xhr=__class__;transports.xhr=transports.xhr(function transports_xhr(){return this.init&&this.init.apply(this,arguments)},baseTransport, function(supr) {\n\t\n\tthis.init = function() {\n\t\tsupr(this, 'init');\n\t\n\t\tthis._xhr = {\n\t\t\t'send': new exports.XHR(),\n\t\t\t'comet': new exports.XHR()\n\t\t};\n\t};\n\n\tthis.abort = function() {\n\t\tthis._aborted = true;\n\t\tfor(var i in this._xhr) {\n\t\t\tif(this._xhr.hasOwnProperty(i)) {\n\t\t\t\tthis._abortXHR(i);\n\t\t\t}\n\t\t}\n\t};\n\t\n\tthis._abortXHR = function(type) {\n\t\tlogger.debug('aborting XHR');\n\n\t\tvar xhr = this._xhr[type];\n\t\ttry {\n\t\t\tif('onload' in xhr) {\n\t\t\t\txhr.onload = xhr.onerror = xhr.ontimeout = null;\n\t\t\t} else if('onreadystatechange' in xhr) {\n\t\t\t\txhr.onreadystatechange = null;\n\t\t\t}\n\t\t\tif(xhr.abort) { xhr.abort(); }\n\t\t} catch(e) {\n\t\t\tlogger.debug('error aborting xhr', e);\n\t\t}\n\t\t\n\t\t// do not reuse aborted XHRs\n\t\tthis._xhr[type] = new exports.XHR();\n\t};\n\t\n\tthis.encodePacket = function(packetId, data, options) {\n\t\t// we don't need to base64 encode things unless there's a null character in there\n\t\treturn !xhrSupportsBinary ? [ packetId, 1, base64.encode(data) ] : [ packetId, 0, data ];\n\t};\n\n\tfunction onReadyStateChange(xhr, rType, cb, eb) {\n\t\ttry {\n\t\t\tvar data = {status: xhr.status};\n\t\t} catch(e) { eb({response: 'Could not access status'}); }\n\t\t\n\t\ttry {\n\t\t\tif(xhr.readyState != 4) { return; }\n\t\t\t\n\t\t\tdata.response = eval(xhr.responseText);\n\t\t\tif(data.status != 200) { \n\t\t\t\tlogger.debug('XHR failed with status ', xhr.status);\n\t\t\t\teb(data);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t\n\t\t\tlogger.debug('XHR data received');\n\t\t} catch(e) {\n\t\t\tlogger.debug('Error in XHR::onReadyStateChange', e);\n\t\t\teb(data);\n\t\t\tthis._abortXHR(rType);\n\t\t\tlogger.debug('done handling XHR error');\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tcb(data);\n\t};\n\n\t/**\n\t * even though we encode the POST body as in application/x-www-form-urlencoded\n\t */\n\tthis._makeRequest = function(rType, url, args, data, cb, eb) {\n\t\tif (this._aborted) { return; }\n\t\tvar xhr = this._xhr[rType];\n\t\txhr.open('POST', url + '?' + uri.buildQuery(args)); // must open XHR first\n\t\txhr.setRequestHeader('Content-Type', 'text/plain'); // avoid preflighting\n\t\tif('onload' in xhr) {\n\t\t\txhr.onload = bind(this, onReadyStateChange, xhr, rType, cb, eb);\n\t\t\txhr.onerror = xhr.ontimeout = eb;\n\t\t} else if('onreadystatechange' in xhr) {\n\t\t\txhr.onreadystatechange = bind(this, onReadyStateChange, xhr, rType, cb, eb);\n\t\t}\n\t\t// NOTE WELL: Firefox (and probably everyone else) likes to encode our nice\n\t\t//\t\t\t\t\t\tbinary strings as utf8. Don't let them! Say no to double utf8\n\t\t//\t\t\t\t\t\tencoding. Once is good, twice isn't better.\n\t\t// if (xhrSupportsBinary) {\n\t\t// \t\txhr.setRequestHeader('x-CSP-SendAsBinary', 'true');\n\t\t// }\n\t\tsetTimeout(function() {\n\t\t\txhr[xhrSupportsBinary ? 'sendAsBinary' : 'send'](data || null)\n\t\t}, 0);\n\t};\n});\n\nvar EMPTY_FUNCTION = function() {},\n\tSLICE = Array.prototype.slice;\n\ntransports.jsonp=__class__;transports.jsonp=transports.jsonp(function transports_jsonp(){return this.init&&this.init.apply(this,arguments)},baseTransport, function(supr) {\n\tvar doc;\n\t\n\tvar createIframe = function() {\n\t\tvar doc = exports.getDoc();\n\t\tif (!doc.body) { return false; }\n\t\t\n\t\tvar i = doc.createElement(\"iframe\");\n\t\twith(i.style) { display = 'block'; width = height = border = margin = padding = '0'; overflow = visibility = 'hidden'; position = 'absolute'; top = left = '-999px'; }\n\t\ti.cbId = 0;\n\t\tdoc.body.appendChild(i);\n\t\ti.src = 'about:blank';\n\t\treturn i;\n\t};\n\n\tvar cleanupIframe = function(ifr) {\n\t\tvar win = ifr.contentWindow, doc = win.document;\n\t\tlogger.debug('removing script tags');\n\t\t\n\t\tvar scripts = doc.getElementsByTagName('script');\n\t\tfor (var i = scripts.length - 1; i >= 0; --i) {\n\t\t\tdoc.body.removeChild(scripts[i]);\n\t\t}\n\t\t\n\t\tlogger.debug('deleting iframe callbacks');\n\t\twin['cb' + ifr.cbId] = win['eb' + ifr.cbId] = EMPTY_FUNCTION;\n\t};\n\n\tvar removeIframe = function(ifr) {\n\t\tsetTimeout(function() {\n\t\t\tif(ifr && ifr.parentNode) { ifr.parentNode.removeChild(ifr); }\n\t\t}, 60000);\n\t};\n\n\tthis.init = function() {\n\t\tsupr(this, 'init');\n\n\t\tthis._onReady = [];\n\t\tthis._isReady = false;\n\n\t\tthis._createIframes();\n\t};\n\n\tthis._createIframes = function() {\n\t\tthis._ifr = {\n\t\t\tsend: createIframe(),\n\t\t\tcomet: createIframe()\n\t\t};\n\t\t\n\t\tif(this._ifr.send === false) { return setTimeout(bind(this, '_createIframes'), 100); }\n\t\t\n\t\tthis._isReady = true;\n\n\t\tvar readyArgs = this._onReady;\n\t\tthis._onReady = [];\n\t\tfor(var i = 0, args; args = readyArgs[i]; ++i) {\n\t\t\tthis._makeRequest.apply(this, args);\n\t\t}\n\t};\n\n\tthis.encodePacket = function(packetId, data, options) {\n\t\treturn [ packetId, 1, base64.encode(data) ];\n\t};\n\n\tthis.abort = function() {\n\t\tthis._aborted = true;\n\t\tfor(var i in this._ifr) {\n\t\t\tif(this._ifr.hasOwnProperty(i)) {\n\t\t\t\tvar ifr = this._ifr[i];\n\t\t\t\tcleanupIframe(ifr);\n\t\t\t\tremoveIframe(ifr);\n\t\t\t}\n\t\t}\n\t};\n\t\n\tthis._makeRequest = function(rType, url, args, data, cb, eb) {\n\t\tif(!this._isReady) { return this._onReady.push(arguments); }\n\t\t\n\t\tvar ifr = this._ifr[rType],\n\t\t\tid = ++ifr.cbId,\n\t\t\treq = {\n\t\t\t\ttype: rType,\n\t\t\t\tid: id,\n\t\t\t\tcb: cb,\n\t\t\t\teb: eb,\n\t\t\t\tcbName: 'cb' + id,\n\t\t\t\tebName: 'eb' + id,\n\t\t\t\tcompleted: false\n\t\t\t};\n\t\t\n\t\targs.d = data;\n\t\targs.n = Math.random();\t\n\t\tswitch(rType) {\n\t\t\tcase 'send': args.rs = ';'; args.rp = req.cbName; break;\n\t\t\tcase 'comet': args.bs = ';'; args.bp = req.cbName; break;\n\t\t}\n\t\t\n\t\treq.url = url + '?' + uri.buildQuery(args)\n\t\t\n\t\tsetTimeout(bind(this, '_request', req), 0);\n\t}\n\t\n\tthis._request = function(req) {\n\t\tvar ifr = this._ifr[req.type],\n\t\t\twin = ifr.contentWindow,\n\t\t\tdoc = win.document,\n\t\t\tbody = doc.body;\n                /*added by skysbird for opera support*/\n                if (!body){return setTimeout(bind(this,'_request',req),100); }\n\t\twin[req.ebName] = bind(this, checkForError, req);\n\t\twin[req.cbName] = bind(this, onSuccess, req);\n\t\t\n\t\tif(BrowserDetect.isWebKit) {\n\t\t\t// this will probably cause loading bars in Safari -- might want to rethink?\n\t\t\tdoc.open();\n\t\t\tdoc.write('<scr'+'ipt src=\"'+req.url+'\"></scr'+'ipt><scr'+'ipt>'+ebName+'(false)</scr'+'ipt>');\n\t\t\tdoc.close();\n\t\t} else {\n\t\t\tvar s = doc.createElement('script');\n\t\t\ts.src = req.url;\n\t\t\t\n\t\t\t// IE\n\t\t\tif(s.onreadystatechange === null) { s.onreadystatechange = bind(this, onReadyStateChange, req, s); }\n\t\t\tbody.appendChild(s);\n\t\t\t\n\t\t\tif(!BrowserDetect.isIE) {\n\t\t\t\tvar s = doc.createElement('script');\n\t\t\t\ts.innerHTML = req.ebName+'(false)';\n\t\t\t\tbody.appendChild(s);\n\t\t\t}\n\t\t}\n\t\t\n\t\tkillLoadingBar();\n\t};\n\t\n\tfunction onSuccess(req, response) {\n\t\tlogger.debug('successful: ', req.url, response);\n\t\treq.completed = true;\n\t\t\n\t\tlogger.debug('calling the cb');\n\t\treq.cb.call(GLOBAL, {status: 200, response: response});\n\t\tlogger.debug('cb called');\n\t}\n\t\n\t// IE6/7 onReadyStateChange\n\tfunction onReadyStateChange(req, scriptTag) {\n\t\tif (scriptTag && scriptTag.readyState != 'loaded') { return; }\n\t\tscriptTag.onreadystatechange = function() {};\n\t\tcheckForError.call(this, req);\n\t}\n\n\tfunction checkForError(req, response) {\n\t\tcleanupIframe(this._ifr[req.type]);\n\t\t\n\t\tif (!req.completed) {\n\t\t\tvar data = {\n\t\t\t\tstatus: response ? 200 : 404,\n\t\t\t\tresponse: response || 'Unable to load resouce'\n\t\t\t};\n\t\t\t\n\t\t\tlogger.debug('error making request:', req.url, data);\n\t\t\tlogger.debug('calling eb');\n\t\t\treq.eb.call(GLOBAL, data);\n\t\t}\n\t}\n\t\n\tvar killLoadingBar = BrowserDetect.isFirefox || BrowserDetect.isOpera ? function() {\n\t\tvar b = document.body;\n\t\tif (!b) { return; }\n\t\t\n\t\tif (!killLoadingBar.iframe) { killLoadingBar.iframe = document.createElement('iframe'); }\n\t\tb.insertBefore(killLoadingBar.iframe, b.firstChild);\n\t\tb.removeChild(killLoadingBar.iframe);\n\t} : function() {};\n});\n\t\n","pre":true},"sdk/jsio/util/browserdetect.js":{"path":"sdk/jsio/util/browserdetect.js","friendlyPath":"util.browserdetect","directory":"sdk/jsio/util/","filename":"browserdetect.js","src":"exports.BrowserDetect = new function() {\n\tvar versionSearchString;\n\tvar dataBrowser = [\n\t\t{\n\t\t\tstring: navigator.userAgent,\n\t\t\tsubString: \"Chrome\"\n\t\t},\n\t\t{\n\t\t\tstring: navigator.userAgent,\n\t\t\tsubString: \"OmniWeb\",\n\t\t\tversionSearch: \"OmniWeb/\"\n\t\t},\n\t\t{\n\t\t\tstring: navigator.vendor,\n\t\t\tsubString: \"Apple\",\n\t\t\tidentity: \"Safari\",\n\t\t\tversionSearch: \"Version\"\n\t\t},\n\t\t{\n\t\t\tprop: window.opera,\n\t\t\tidentity: \"Opera\"\n\t\t},\n\t\t{\n\t\t\tstring: navigator.vendor,\n\t\t\tsubString: \"iCab\"\n\t\t},\n\t\t{\n\t\t\tstring: navigator.vendor,\n\t\t\tsubString: \"KDE\",\n\t\t\tidentity: \"Konqueror\"\n\t\t},\n\t\t{\n\t\t\tstring: navigator.userAgent,\n\t\t\tsubString: \"Firefox\"\n\t\t},\n\t\t{\n\t\t\tstring: navigator.vendor,\n\t\t\tsubString: \"Camino\"\n\t\t},\n\t\t{\t\t// for newer Netscapes (6+)\n\t\t\tstring: navigator.userAgent,\n\t\t\tsubString: \"Netscape\"\n\t\t},\n\t\t{\n\t\t\tstring: navigator.userAgent,\n\t\t\tsubString: \"MSIE\",\n\t\t\tidentity: \"IE\",\n\t\t\tversionSearch: \"MSIE\"\n\t\t},\n\t\t{\n\t\t\tstring: navigator.userAgent,\n\t\t\tsubString: \"Gecko\",\n\t\t\tidentity: \"Mozilla\",\n\t\t\tversionSearch: \"rv\"\n\t\t},\n\t\t{ \t\t// for older Netscapes (4-)\n\t\t\tstring: navigator.userAgent,\n\t\t\tsubString: \"Mozilla\",\n\t\t\tidentity: \"Netscape\",\n\t\t\tversionSearch: \"Mozilla\"\n\t\t}\n\t];\n\t\n\tvar dataOS = [\n\t\t{\n\t\t\tstring: navigator.platform,\n\t\t\tsubString: \"Win\",\n\t\t\tidentity: \"Windows\"\n\t\t},\n\t\t{\n\t\t\tstring: navigator.platform,\n\t\t\tsubString: \"Mac\"\n\t\t},\n\t\t{\n\t\t\tstring: navigator.userAgent,\n\t\t\tsubString: \"iPhone\",\n\t\t\tidentity: \"iPhone/iPod\"\n\t\t},\n\t\t{\n\t\t\tstring: navigator.platform,\n\t\t\tsubString: \"Linux\"\n\t\t}\n\t];\n\t\n\tfunction searchString(data) {\n\t\tfor (var i=0,item;item=data[i];i++)\t{\n\t\t\tvar dataString = item.string;\n\t\t\tvar dataProp = item.prop;\n\t\t\titem.identity = item.identity || item.subString;\n\t\t\tversionSearchString = item.versionSearch || item.identity;\n\t\t\tif (dataString) {\n\t\t\t\tif (dataString.indexOf(item.subString) != -1)\n\t\t\t\t\treturn item.identity;\n\t\t\t} else if (dataProp)\n\t\t\t\treturn item.identity;\n\t\t}\n\t}\n\t\n\tfunction searchVersion(dataString) {\n\t\tvar index = dataString.indexOf(versionSearchString);\n\t\tif (index == -1) return;\n\t\treturn parseFloat(dataString.substring(index+versionSearchString.length+1));\n\t}\n\t\n\tthis.browser = searchString(dataBrowser) || \"unknown\";\n\tthis.version = searchVersion(navigator.userAgent)\n\t\t|| searchVersion(navigator.appVersion)\n\t\t|| \"unknown\";\n\tthis.OS = searchString(dataOS) || \"unknown\";\n\tthis.isWebKit = RegExp(\" AppleWebKit/\").test(navigator.userAgent);\n\tthis['is'+this.browser] = this.version;\n};","pre":true},"sdk/jsio/net/env/browser/postmessage.js":{"path":"sdk/jsio/net/env/browser/postmessage.js","friendlyPath":"net.env.browser.postmessage","directory":"sdk/jsio/net/env/browser/","filename":"postmessage.js","src":"jsio(\"import net.interfaces\");\njsio(\"from util.browser import $\");\njsio(\"import std.uuid\");\n\n/**\n * @extends net.interfaces.Listener\n */\nexports.Listener=__class__;exports.Listener=exports.Listener(function exports_Listener(){return this.init&&this.init.apply(this,arguments)},net.interfaces.Listener, function(supr) {\n\tvar ID = 0;\n\t\n\tthis.init = function() {\n\t\tsupr(this, 'init', arguments);\n\t\tthis._clients = {};\n\t\tif (!this._opts.clientUrl) {\n\t\t\tthis._opts.clientUrl = jsio.__dir + '/networkConsole.html';\n\t\t}\n\n\t\tthis._port = '' + (this._opts.port || '');\n\t}\n\n\tthis.listen = function() {\n\t\t$.onEvent(window, 'message', bind(this, '_onMessage'));\n\t}\n\n\tthis.getButton = function(url, text) {\n\t\tvar button = $({\n\t\t\ttagName: 'button',\n\t\t\ttext: text || 'launch client',\n\t\t\tclassName: 'clientButton'\n\t\t});\n\t\t$.onEvent(button, 'click', bind(this, 'openWindow', url || this._opts.clientUrl));\n\t\treturn button; \n\t}\n\t\n\tvar uniqueId = 1;\n\tthis.openWindow = function (url) {\n\t\tvar options = { menubar: 'no', location: 'no', toolbar: 'no',\n\t\t\twidth: 550, height: 350, // left: 200, top: 200,\n\t\t\tscrollbars: 'yes', status: 'yes', resizable: 'yes' };\n\t\t\n\t\tvar arr = [];\n\t\tfor (var i in options) { arr.push(i + '=' + options[i]) }\n\t\tvar win = window.open(url, 'W' + uniqueId++, arr.join(','));\n\t\twin.focus();\n\t}\n\t\n\tthis._onMessage = function (evt) {\n\t\tif (this._port != evt.data.substring(0, this._port.length)) { return; }\n\t\tvar data = evt.data.substring(this._port.length);\n\n\t\ttry {\n\t\t\tdata = JSON.parse(data);\n\t\t} catch (e) {\n\t\t\tlogger.warn('invalid packet', evt.data);\n\t\t\treturn;\n\t\t}\n\n\t\tswitch (data.type) {\n\t\t\tcase 'open':\n\t\t\t\tvar transport = this._clients[data.uid] = new exports.Transport(evt.source, this._port, data.uid);\n\t\t\t\tevt.source.postMessage(this._port + JSON.stringify({\"type\":\"open\", uid: data.uid}), '*');\n\t\t\t\tthis.onConnect(transport);\n\t\t\t\tbreak;\n\t\t\tcase 'data':\n\t\t\t\tvar transport = this._clients[data.uid];\n\t\t\t\tif (transport) { transport.onData(data.payload); }\n\t\t\t\tbreak;\n\t\t\tcase 'close':\n\t\t\t\tvar transport = this._clients[data.uid];\n\t\t\t\tif (transport) { transport.onClose(); }\n\t\t\t\tevt.source.postMessage(this._port + JSON.stringify({\"type\":\"close\", uid: data.uid}), '*');\n\t\t\t\tdelete this._clients[data.uid];\n\t\t\t\tbreak;\n\t\t}\n\t}\n});\n\n/**\n * @extends net.interfaces.Connector\n */\nexports.Connector=__class__;exports.Connector=exports.Connector(function exports_Connector(){return this.init&&this.init.apply(this,arguments)},net.interfaces.Connector, function() {\n\tthis.connect = function() {\n\t\tthis._port = '' + (this._opts.port || '');\n\t\tthis._win = this._opts.win || window.opener || window.parent;\n\t\t$.onEvent(window, 'message', bind(this, '_onMessage'));\n\n\t\tthis._uid = std.uuid.uuid();\n\t\tthis._win.postMessage(this._port + JSON.stringify({type: 'open', uid: this._uid}), '*');\n\t}\n\t\n\tthis._onMessage = function(evt) {\n\t\tif (this._port != evt.data.substring(0, this._port.length)) { return; }\n\t\tvar data = evt.data.substring(this._port.length);\n\n\t\t// At the moment, we include the uid in the data.  If we have many clients\n\t\t// on the same port with different UIDs then this would get expensive, but\n\t\t// this is a very rare use case for postmessage.\n\t\ttry {\n\t\t\tdata = JSON.parse(data);\n\t\t} catch (e) {\n\t\t\tlogger.warn('invalid packet', evt.data);\n\t\t\treturn;\n\t\t}\n\n\t\tswitch (data.type) {\n\t\t\tcase 'open':\n\t\t\t\tthis._transport = new exports.Transport(evt.source, this._port, this._uid);\n\t\t\t\tthis.onConnect(this._transport);\n\t\t\t\tbreak;\n\t\t\tcase 'close':\n\t\t\t\tif (data.uid != this._uid) { return; }\n\t\t\t\tthis._transport.onClose();\n\t\t\t\tbreak;\n\t\t\tcase 'data':\n\t\t\t\tif (data.uid != this._uid) { return; }\n\t\t\t\tthis._transport.onData(data.payload);\n\t\t\t\tbreak;\n\t\t}\n\t}\n});\n\n/**\n * @extends net.interfaces.Transport\n */\nexports.Transport=__class__;exports.Transport=exports.Transport(function exports_Transport(){return this.init&&this.init.apply(this,arguments)},net.interfaces.Transport, function() {\n\tthis.init = function (win, port, uid) {if (!uid) debugger\n\t\tthis._win = win;\n\t\tthis._port = port;\n\t\tthis._uid = uid; // unique identifier for clients\n\t}\n\t\n\tthis.makeConnection = function (protocol) {\n\t\tthis._protocol = protocol;\n\t}\n\t\n\tthis.write = function (data, encoding) {\n\t\tif (this.encoding == 'utf8') {\n\t\t\tthis._win.postMessage(this._port + JSON.stringify({type: 'data', uid: this._uid, payload: utf8.encode(data)}), '*');\n\t\t} else {\n\t\t\tthis._win.postMessage(this._port + JSON.stringify({type: 'data', uid: this._uid, payload: data}), '*');\n\t\t} \n\t}\n\t\n\tthis.loseConnection = function (protocol) {\n\t\tthis._win.postMessage(this._port + JSON.stringify({type: 'close', uid: this._uid, code: 301}), '*');\n\t}\n\t\n\tthis.onData = function () { this._protocol.dataReceived.apply(this._protocol, arguments); }\n\tthis.onClose = function () { this._protocol._connectionLost.apply(this._protocol, arguments); }\n});\n","pre":true},"sdk/jsio/std/uuid.js":{"path":"sdk/jsio/std/uuid.js","friendlyPath":"std.uuid","directory":"sdk/jsio/std/","filename":"uuid.js","src":"/*\nBased on Math.uuid.js 1.4 by Robert Kieffer\n\n----\nCopyright (c) 2008, Robert Kieffer\nAll rights reserved.\n\nRedistribution and use in source and binary forms, with or without\nmodification, are permitted provided that the following conditions are met:\n\n  * Redistributions of source code must retain the above copyright notice,\n\tthis list of conditions and the following disclaimer.\n  * Redistributions in binary form must reproduce the above copyright\n\tnotice, this list of conditions and the following disclaimer in the\n\tdocumentation and/or other materials provided with the distribution.\n  * Neither the name of Robert Kieffer nor the names of its contributors\n\tmay be used to endorse or promote products derived from this software\n\twithout specific prior written permission.\n  \nTHIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\"\nAND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE\nIMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE\nARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE\nLIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR\nCONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF\nSUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS\nINTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN\nCONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\nARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\nPOSSIBILITY OF SUCH DAMAGE.\n\n*/\n\n\n\n/*\n * Generate a random uuid.\n *\n * USAGE: uuid.uuid(length, radix)\n *   length - the desired number of characters\n *   radix  - the number of allowable values for each character.\n *\n * EXAMPLES:\n *   // No arguments  - returns RFC4122, version 4 ID\n *   >>> std.uuid()\n *   \"92329D39-6F5C-4520-ABFC-AAB64544E172\"\n * \n *   // One argument - returns ID of the specified length\n *   >>> std.uuid(15)\t // 15 character ID (default base=62)\n *   \"VcydxgltxrVZSTV\"\n *\n *   // Two arguments - returns ID of the specified length, and radix. (Radix must be <= 62)\n *   >>> std.uuid(8, 2)  // 8 character ID (base=2)\n *   \"01001010\"\n *   >>> std.uuid(8, 10) // 8 character ID (base=10)\n *   \"47473046\"\n *   >>> std.uuid(8, 16) // 8 character ID (base=16)\n *   \"098F4D35\"\n */\n\n\nvar CHARS = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'.split(''); \nexports.uuid = function (len, radix) {\n\tvar chars = CHARS, uuid = [], rnd = Math.random;\n\tradix = radix || chars.length;\n\n\tif (len) {\n\t\t// Compact form\n\t\tfor (var i = 0; i < len; i++) uuid[i] = chars[0 | rnd()*radix];\n\t} else {\n\t\t// rfc4122, version 4 form\n\t\tvar r;\n\n\t\t// rfc4122 requires these characters\n\t\tuuid[8] = uuid[13] = uuid[18] = uuid[23] = '-';\n\t\tuuid[14] = '4';\n\n\t\t// Fill in random data.  At i==19 set the high bits of clock sequence as\n\t\t// per rfc4122, sec. 4.1.5\n\t\tfor (var i = 0; i < 36; i++) {\n\t\t\tif (!uuid[i]) {\n\t\t\t\tr = 0 | rnd()*16;\n\t\t\t\tuuid[i] = chars[(i == 19) ? (r & 0x3) | 0x8 : r & 0xf];\n\t\t\t}\n\t\t}\n\t}\n\treturn uuid.join('');\n};\n\n","pre":true},"sdk/jsio/net/env.js":{"path":"sdk/jsio/net/env.js","friendlyPath":"net.env","directory":"sdk/jsio/net/","filename":"env.js","src":"function getObj(objectName, transportName, envName) {\n\t\n\ttry {\n\t\tvar DYNAMIC_IMPORT_ENV = 'from .env.' + (envName || jsio.__env.name) + '.' + transportName + ' import ' + objectName + ' as result';\n\t\tjsio(DYNAMIC_IMPORT_ENV);\n\t} catch(e) {\n\t\tthrow logger.error('Invalid transport (', transportName, ') or environment (', envName, ')');\n\t}\n\treturn result;\n}\n\nexports.getListener = bind(this, getObj, 'Listener');\nexports.getConnector = bind(this, getObj, 'Connector');\n","pre":true},"sdk/jsio/net/protocols/Cuppa.js":{"path":"sdk/jsio/net/protocols/Cuppa.js","friendlyPath":"net.protocols.Cuppa","directory":"sdk/jsio/net/protocols/","filename":"Cuppa.js","src":"\"use import\";\n\njsio(\"import lib.Callback\");\njsio(\"import lib.PubSub\");\n\njsio(\"from net.protocols.rtjp import RTJPProtocol\");\n\nError=__class__;var Error=Error(function Error(){return this.init&&this.init.apply(this,arguments)},function() {\n\tthis.init = function(protocol, id, msg, details, requestId) {\n\t\tthis.id = id;\n\t\tthis.msg = msg;\n\t\tthis.details = details;\n\t\tthis.requestId = requestId;\n\t}\n});\n\nRPCRequest=__class__;var RPCRequest=RPCRequest(function RPCRequest(){return this.init&&this.init.apply(this,arguments)},function() {\n\tthis.init = function(protocol, id) {\n\t\tthis.protocol = protocol;\n\t\tthis.id = id;\n\t\tthis._onError = new lib.Callback();\n\t\tthis._onSuccess = new lib.Callback();\n\t}\n\n\tthis.onError = function() { this._onError.forward(arguments); }\n\tthis.onSuccess = function() { this._onSuccess.forward(arguments); }\n\t\n\tthis.bindLater = function(l) {\n\t\tvar args = [].slice(arguments, 1);\n\t\tthis._onError.forward([l, l.fail].concat(args));\n\t\tthis._onSuccess.forward([l, l.succed].concat(args));\n\t\treturn l;\n\t}\n\t\n\t\n});\n\nReceivedRequest=__class__;var ReceivedRequest=ReceivedRequest(function ReceivedRequest(){return this.init&&this.init.apply(this,arguments)},function() {\n\tthis.type = \"request\"\n\n\tthis.init = function(protocol, id, name, args, target) {\n\t\tthis.protocol = protocol\n\t\tthis.id = id;\n\t\tthis.name = name\n\t\tthis.responded = false;\n\t\tthis.args = args;\n\t\tthis.target = target;\n\t}\n\n\tthis.error = function(msg, details) {\n\t\tif (this.responded) { throw new Error(\"already responded\"); }\n\t\tif (this._timer) { \n\t\t\tclearTimeout(this._timer); \n\t\t\tthis._timer = null; \n\t\t}\n\t\targs = {\n\t\t\tid: this.id,\n\t\t\tmsg: msg + \"\"\n\t\t}\n\t\tif (details !== undefined) { args.details = details }\n\t\tthis.responded = true;        \n\t\tthis.protocol.sendFrame('ERROR', args);\n\t}\n\n\tthis.respond = function(args) {\n\t\tif (this.responded) { throw new Error(\"already responded\"); }\n\t\tif (this._timer) { \n\t\t\tclearTimeout(this._timer); \n\t\t\tthis._timer = null; \n\t\t}\n\t\tthis.responded = true;\n\t\tthis.protocol.sendFrame('RESPONSE', {\n\t\t\tid: this.id,\n\t\t\targs: args == undefined ? {} : args // python cuppa ignores responses with undefined args\n\t\t});\n\t}\n\t\n\tthis.timeoutAfter = function(duration, msg) {\n\t\tif (this.responded) { return; }\n\t\tif (this._timer) { clearTimeout(this._timer); }\n\t\tthis._timer = setTimeout(bind(this, '_timeout', msg), duration);\n\t}\n\t\n\tthis._timeout = function(msg) {\n\t\tif (!this.responded) {\n\t\t\tthis.error(msg);\n\t\t}\n\t}\n    \n});\n\nReceivedEvent=__class__;var ReceivedEvent=ReceivedEvent(function ReceivedEvent(){return this.init&&this.init.apply(this,arguments)},function() {\n\tthis.init = function(protocol, id, name, args, target) {\n\t\tthis.id = id;\n\t\tthis.name = name;\n\t\tthis.args = args;\n\t\tthis.target = target;\n\t}\n});\n\n/**\n * @extends net.protocols.rtjp.RTJPProtocol;\n */\nvar sdk_jsio_net_protocols_Cuppa=__class__;exports=sdk_jsio_net_protocols_Cuppa(function sdk_jsio_net_protocols_Cuppa(){return this.init&&this.init.apply(this,arguments)},RTJPProtocol, function(supr) {\n\tthis.init = function() {\n\t\tsupr(this, 'init', arguments);\n\t\t\n\t\tthis._onConnect = new lib.Callback();\n\t\tthis._onDisconnect = new lib.Callback();\n\t\t\n\t\tthis._requests = {};\n\t\t\n\t\tthis.onEvent = new lib.PubSub();\n\t\tthis.onRequest = new lib.PubSub();\n\t}\n\t\n\tthis.disconnect = function() { this.transport.loseConnection(); }\n\t\n\t// pass something to call (ctx, method, args...) when connected\n\tthis.onConnect = function() { this._onConnect.forward(arguments); }\n\tthis.onDisconnect = function() { this._onDisconnect.forward(arguments); }\n\t\n\tthis.reset = function() {\n\t\tthis._onConnect.reset();\n\t\tthis._onDisconnect.reset();\n\t}\n\t\n\t// called when we're connected\n\tthis.connectionMade = function() {\n\t\tthis._isConnected = true;\n\t\tthis._onConnect.fire();\n\t}\n\t\n\tthis.connectionLost = function(err) {\n\t\tfor (var i in this._requests) {\n\t\t\tvar req = this._requests[i];\n\t\t\tdelete this._requests[i];\n\t\t\treq._onError.fire(err);\n\t\t}\n\t\t\n\t\tthis._isConnected = false;\n\t\tthis._onDisconnect.fire(err);\n\t}\n\t\n\tthis.sendRequest = function(name, args, target, cb) {\n\t\tif (arguments.length > 4) { // allow bound functions (e.g. [this, 'onResponse', 123])\n\t\t\tcb = bind.apply(GLOBAL, Array.prototype.slice.call(arguments, 3));\n\t\t}\n\t\t\n\t\tvar frameArgs = {\n\t\t\tname: name,\n\t\t\targs: args\n\t\t};\n\t\t\n\t\tif (target) { frameArgs.target = target; }\n\t\t\n\t\tvar id = this.sendFrame('RPC', frameArgs),\n\t\t\treq = this._requests[id] = new RPCRequest(this, id);\n\t\t\n\t\tif (cb) {\n\t\t\treq.onSuccess(GLOBAL, cb, false); // will call cb(false, args...)\n\t\t\treq.onError(GLOBAL, cb); // will call cb(err)\n\t\t}\n\t\t\n\t\treturn req;\n\t}\n\t\n\tthis.sendEvent = function(name, args, target) {\n\t\tthis.sendFrame('EVENT', {name: name, args: args, target: target || null});\n\t}\n\t\n\tthis.frameReceived = function(id, name, args) {\n\t\tlogger.debug('RECEIVED', id, name, args);\n\t\tswitch(name.toUpperCase()) {\n\t\t\tcase 'RESPONSE':\n\t\t\t\tvar req = this._requests[args.id];\n\t\t\t\tif (!req) { return; }\n\t\t\t\tdelete this._requests[args.id];\n\t\t\t\treq._onSuccess.fire(args.args);\n\t\t\t\tbreak;\n\t\t\tcase 'ERROR':\n\t\t\t\tvar msg = args.msg || 'unknown',\n\t\t\t\t\trequestId = args.id,\n\t\t\t\t\treq = this._requests[requestId],\n\t\t\t\t\terr = new Error(this, id, msg, args.details, requestId);\n\t\t\t\t\n\t\t\t\tif (!req) {\n\t\t\t\t\treturn this.errorReceived && this.errorReceived(err);\n\t\t\t\t} else {\n\t\t\t\t\tdelete this._requests[requestId];\n\t\t\t\t\treq._onError.fire(err);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'RPC':\n\t\t\tcase 'EVENT':\n\t\t\t\tif (!args.name) {\n\t\t\t\t\treturn self.sendFrame('ERROR', { 'id': args.id || id, 'msg': 'missing \"name\"' });\n\t\t\t\t}\n\t\t\t\tvar frameArgs = args.args || {},\n\t\t\t\t\ttarget = args.target || null,\n\t\t\t\t\tisRPC = name.toUpperCase() == 'RPC',\n\t\t\t\t\treqCtor = isRPC ? ReceivedRequest : ReceivedEvent,\n\t\t\t\t\tpubTarget = isRPC ? this.onRequest : this.onEvent,\n\t\t\t\t\treq = new reqCtor(this, args.id || id, args.name, frameArgs, target);\n\t\t\t\t\n\t\t\t\tpubTarget.publish(req.name, req);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t}\n\t}\n});\n","pre":true},"sdk/jsio/net/protocols/rtjp.js":{"path":"sdk/jsio/net/protocols/rtjp.js","friendlyPath":"net.protocols.rtjp","directory":"sdk/jsio/net/protocols/","filename":"rtjp.js","src":"jsio('import net.interfaces');\njsio('from net.protocols.delimited import DelimitedProtocol');\n\n/**\n * @extends net.protocols.delimited.DelimitedProtocol\n */\nexports.RTJPProtocol=__class__;exports.RTJPProtocol=exports.RTJPProtocol(function exports_RTJPProtocol(){return this.init&&this.init.apply(this,arguments)},DelimitedProtocol, function(supr) {\n\tthis.init = function() {\n\t\tvar delimiter = '\\r\\n';\n\t\tsupr(this, 'init', [delimiter]);\n\t\tthis.frameId = 0;\n\t}\n\n\tthis.connectionMade = function() {\n\t\tif (this._client && this._client.connectionMade) { this._client.connectionMade(); }\n\t\tlogger.debug(\"connectionMade\");\n\t}\n\t\n\tvar error = function(e) {\n\t\tlogger.error(e);\n\t}\n\t\n\t// Inherit and overwrite\n\tthis.frameReceived = function(id, name, args) {\n\t}\n\n\t// Public\n\tthis.sendFrame = function(name, args) {\n\t\tif (!args) {\n\t\t\targs = {}\n\t\t}\n\t\tlogger.debug('sendFrame', name, JSON.stringify(args));\n\t\tthis.sendLine(JSON.stringify([++this.frameId, name, args]));\n\t\treturn this.frameId;\n\t}\n\n\tthis.lineReceived = function(line) {\n\t\ttry {\n\t\t\tvar frame = JSON.parse(line);\n\t\t\tif (frame.length != 3) {\n\t\t\t\treturn error.call(this, \"Invalid frame length\");\n\t\t\t}\n\t\t\tif (typeof(frame[0]) != \"number\") {\n\t\t\t\treturn error.call(this, \"Invalid frame id\");\n\t\t\t}\n\t\t\tif (typeof(frame[1]) != \"string\") {\n\t\t\t\treturn error.call(this, \"Invalid frame name\");\n\t\t\t}\n\t\t\tlogger.debug(\"frameReceived:\", frame[0], frame[1], JSON.stringify(frame[2]));\n\t\t} catch(e) {\n\t\t\terror.call(this, e);\n\t\t}\n\t\t\n\t\tif (frame) {\n\t\t\tthis.frameReceived(frame[0], frame[1], frame[2]);\n\t\t}\n\t}\n\n\tthis.connectionLost = function() {\n\t\tlogger.debug('conn lost');\n\t}\n});\n\n\n\n","pre":true},"sdk/jsio/net/protocols/delimited.js":{"path":"sdk/jsio/net/protocols/delimited.js","friendlyPath":"net.protocols.delimited","directory":"sdk/jsio/net/protocols/","filename":"delimited.js","src":"jsio('import net.interfaces');\n\n/**\n * @extends net.interfaces.Protocol\n */\nexports.DelimitedProtocol=__class__;exports.DelimitedProtocol=exports.DelimitedProtocol(function exports_DelimitedProtocol(){return this.init&&this.init.apply(this,arguments)},net.interfaces.Protocol, function(supr) {\n\n\tthis.init = function(delimiter) {\n\t\tif (!delimiter) {\n\t\t\tdelimiter = '\\r\\n'\n\t\t}\n\t\tthis.delimiter = delimiter;\n\t\tthis.buffer = \"\"\n\t}\n\t\n\tthis.connectionMade = function() {\n\t\tlogger.debug('connectionMade');\n\t}\n\t\n\tthis.dataReceived = function(data) {\n\t\tif (!data) { return; }\n\t\tlogger.debug('dataReceived:(' + data.length + ')', data);\n\t\tlogger.debug('last 2:', JSON.stringify(data.slice(data.length-2)));\n\t\tthis.buffer += data;\n\t\tvar i;\n\t\twhile ((i = this.buffer.indexOf(this.delimiter)) != -1) {\n\t\t\tvar line = this.buffer.slice(0, i);\n\t\t\tthis.buffer = this.buffer.slice(i + this.delimiter.length);\n\t\t\tthis.lineReceived(line);\n\t\t}\n\t}\n\n\tthis.lineReceived = function(line) {\n\t\tlogger.debug('Not implemented, lineReceived:', line);\n\t}\n\tthis.sendLine = function(line) {\n\t\tlogger.debug('WRITE:', JSON.stringify(line + this.delimiter));\n\t\tthis.transport.write(line + this.delimiter);\n\t}\n\tthis.connectionLost = function() {\n\t\tlogger.debug('connectionLost');\n\t}\n});\n\n","pre":true},"sdk/gc/debugging/_DEBUG.js":{"path":"sdk/gc/debugging/_DEBUG.js","friendlyPath":"._DEBUG","directory":"sdk/gc/debugging/","filename":"_DEBUG.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n// this whole file should not get included in release\nif (DEBUG) {\n\n\t/*\n\t * Tools for traversing views from the JS console.\n\t * This class ends up being in the global scope:\n\t *   GLOBAL._DEBUG = new exports();\n\t */\nvar sdk_gc_debugging__DEBUG=__class__;\texports=sdk_gc_debugging__DEBUG(function sdk_gc_debugging__DEBUG(){return this.init&&this.init.apply(this,arguments)},function () {\n\n\t\tthis.screenshot = function (cb) {\n\t\t\tjsio(\"import device\");\n\t\t\tvar canvas = GC.app.engine.getElement();\n\n\t\t\tvar Canvas = device.get('Canvas');\n\t\t\tvar _debugCanvas = new Canvas({\n\t\t\t\t\twidth: canvas.width,\n\t\t\t\t\theight: canvas.height\n\t\t\t\t});\n\t\t\t\n\t\t\tif (_debugCanvas && _debugCanvas.toDataURL) {\n\t\t\t\tvar ctx = _debugCanvas.getContext('2d');\n\t\t\t\tvar reDomain = /^https?:\\/\\/(.*?)\\//;\n\t\t\t\tvar origDrawImage = ctx.drawImage;\n\t\t\t\tctx.drawImage = function (img, sx, sy, sw, sh, dx, dy, dw, dh) {\n\t\t\t\t\tvar match = img.src.match(reDomain);\n\t\t\t\t\tif (match && match[1] != location.host) {\n\t\t\t\t\t\tif (dw != undefined && dh != undefined) {\n\t\t\t\t\t\t\tthis.drawBrokenImage(dx, dy, dw, dh);\n\t\t\t\t\t\t} else if (dx != undefined) {\n\t\t\t\t\t\t\tthis.drawBrokenImage(dx, dy, sw, sh);\n\t\t\t\t\t\t} else if (sw != undefined) {\n\t\t\t\t\t\t\tthis.drawBrokenImage(sx, sy, sw, sh);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tthis.drawBrokenImage(sx, sy, img.width, img.height);\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\torigDrawImage.apply(this, arguments);\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tctx.drawBrokenImage = function (x, y, w, h) {\n\t\t\t\t\tvar lineWidth = 6;\n\t\t\t\t\tx = x || 0;\n\t\t\t\t\ty = y || 0;\n\t\t\t\t\tif (w && h) {\n\t\t\t\t\t\tthis.save();\n\t\t\t\t\t\tthis.clipRect(x, y, w, h);\n\t\t\t\t\t\tthis.fillStyle = 'rgba(0, 0, 0, 0.5)';\n\t\t\t\t\t\tthis.fillRect(x, y, w, h);\n\t\t\t\t\t\tthis.lineWidth = lineWidth;\n\t\t\t\t\t\tthis.strokeStyle = 'rgba(255, 255, 255, 0.5)';\n\t\t\t\t\t\tthis.strokeRect(x + lineWidth / 2, y + lineWidth / 2, w - lineWidth, h - lineWidth);\n\t\t\t\t\t\tthis.strokeStyle = 'rgba(255, 0, 0)';\n\t\t\t\t\t\tthis.fillStyle = 'red';\n\t\t\t\t\t\tthis.font = 'bold 15px Helvetica';\n\t\t\t\t\t\tthis.textAlign = 'center';\n\t\t\t\t\t\tthis.textBaseline = 'middle';\n\t\t\t\t\t\tthis.fillText(\"X\", x + w / 2, y + h / 2);\n\t\t\t\t\t\tthis.restore();\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tGC.app.engine.getView().__view.wrapRender(ctx, {});\n\n\t\t\t\ttry {\n\t\t\t\t\tvar base64Image = _debugCanvas.toDataURL('image/png');\n\t\t\t\t} catch (e) {\n\t\t\t\t\tcb({\n\t\t\t\t\t\tNOT_SUPPORTED: true,\n\t\t\t\t\t\terror: e\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif (base64Image) {\n\t\t\t\t\tcb(null, {\n\t\t\t\t\t\twidth: _debugCanvas.width,\n\t\t\t\t\t\theight: _debugCanvas.height,\n\t\t\t\t\t\tbase64Image: base64Image\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tcb({\n\t\t\t\t\tNOT_SUPPORTED: true\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tthis.traverse = function (f) { return GC.app && this.traverseView(f, GC.app.view); }\n\t\tthis.traverseView = function (f, view) {\n\t\t\tvar data = f(view);\n\t\t\tvar subviews = view.getSubviews().map(bind(this, 'traverseView', f));\n\t\t\treturn {\n\t\t\t\tuid: view.uid,\n\t\t\t\tdata: data,\n\t\t\t\tsubviews: subviews.length ? subviews : undefined\n\t\t\t};\n\t\t}\n\n\t\tthis.find = function (f) { return GC.app && this.findView(f, GC.app.view); }\n\t\tthis.findView = function (f, view) {\n\t\t\tif (f(view)) { return view; }\n\t\t\tvar subviews = view.getSubviews();\n\t\t\tfor (var i = 0, sub; sub = subviews[i]; ++i) {\n\t\t\t\tvar res = this.findView(f, sub);\n\t\t\t\tif (res) { return res; }\n\t\t\t}\n\n\t\t\treturn false;\n\t\t}\n\n\t\tvar _isHighlighting = false;\n\t\tvar _highlightViews = [];\n\n\t\tvar _renderHighlights = (function () {\n\t\t\tvar prev = null;\n\t\t\tvar highlight = 0;\n\t\t\tvar fadeIn = true;\n\t\t\tvar FADE_IN_TIME = 1000;\n\t\t\treturn function (ctx) {\n\t\t\t\tvar now = Date.now();\n\t\t\t\tvar dt = 0;\n\t\t\t\tif (prev) {\n\t\t\t\t\tdt = now - prev;\n\t\t\t\t}\n\n\t\t\t\tprev = now;\n\n\t\t\t\tif (fadeIn) {\n\t\t\t\t\thighlight += dt;\n\t\t\t\t\tif (highlight >= FADE_IN_TIME) {\n\t\t\t\t\t\tfadeIn = false;\n\t\t\t\t\t\thighlight = FADE_IN_TIME;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\thighlight -= dt;\n\t\t\t\t\tif (highlight < 0) {\n\t\t\t\t\t\tfadeIn = true;\n\t\t\t\t\t\thighlight = 0;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t_highlightViews.forEach(function (view) {\n\t\t\t\t\tvar pos = view.getPosition();\n\t\t\t\t\tvar gray = Math.round(255 * highlight / FADE_IN_TIME);\n\t\t\t\t\tctx.save();\n\t\t\t\t\tctx.fillStyle = 'rgba(' + gray + ',' + gray + ',' + gray + ',' + gray / 512 + ')';\n\t\t\t\t\tctx.strokeStyle = 'rgba(' + gray + ',0,0,1)';\n\t\t\t\t\tctx.rotate(pos.r);\n\t\t\t\t\tctx.fillRect(pos.x, pos.y, pos.width, pos.height);\n\t\t\t\t\tctx.strokeRect(pos.x - 0.5, pos.y - 0.5, pos.width + 1, pos.height + 1);\n\t\t\t\t\tctx.restore();\n\t\t\t\t});\n\t\t\t}\n\t\t})();\n\n\t\tthis.unhighlightViews = function () {\n\t\t\t_highlightViews = [];\n\t\t}\n\n\t\tthis.highlightView = function (view) {\n\t\t\tif (_highlightViews.indexOf(view) == -1) {\n\t\t\t\t_highlightViews.push(view);\n\t\t\t\tif (!_isHighlighting) {\n\t\t\t\t\t_isHighlighting = true;\n\t\t\t\t\tGC.app.engine.on('Render', _renderHighlights);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis.unhighlightView = function (view) {\n\t\t\tvar i = _highlightViews.indexOf(view);\n\t\t\tif (i != -1) {\n\t\t\t\t_highlightViews.splice(i, 1);\n\t\t\t}\n\t\t}\n\n\t\tthis.getViewByID = function (uid) { return this.find(function (view) { return view.uid == uid; }); }\n\n\t\tthis.pack = function () { return GC.app && this.packView(GC.app.view); }\n\t\tthis.packView = function (view) {\n\t\t\tjsio(\"import ui.ImageView\");\n\t\t\tjsio(\"import ui.ImageScaleView\");\n\t\t\tjsio(\"import ui.TextView\");\n\n\t\t\treturn this.traverseView(function (view) {\n\n\t\t\t\tif (view instanceof ui.ImageView || view instanceof ui.ImageScaleView) {\n\t\t\t\t\tvar img = view.getImage();\n\t\t\t\t\tif (img) {\n\t\t\t\t\t\tvar imageData = img.getOriginalURL() || img.getMap();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (view.getScaleMethod) {\n\t\t\t\t\t\tvar scaleMethod = view.getScaleMethod();\n\t\t\t\t\t\tif (/slice$/.test(scaleMethod)) {\n\t\t\t\t\t\t\tvar sourceSlices = view._opts.sourceSlices;\n\t\t\t\t\t\t\tvar destSlices = view._opts.destSlices;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (view instanceof ui.TextView) {\n\t\t\t\t\tvar text = view.getText();\n\t\t\t\t}\n\n\t\t\t\tvar s = view.style;\n\t\t\t\treturn {\n\t\t\t\t\tx: s.x != 0 ? s.x : undefined,\n\t\t\t\t\ty: s.y != 0 ? s.y : undefined,\n\t\t\t\t\twidth: s.width,\n\t\t\t\t\theight: s.height,\n\t\t\t\t\tscale: s.scale != 1 ? s.scale : undefined,\n\t\t\t\t\tsourceSlices: sourceSlices,\n\t\t\t\t\tdestSlices: destSlices,\n\t\t\t\t\tscaleMethod: scaleMethod,\n\t\t\t\t\timage: imageData,\n\t\t\t\t\ttext: text,\n\t\t\t\t\tvisible: s.visible == false ? false : undefined,\n\t\t\t\t\topacity: s.opacity != 1 ? s.opacity : undefined,\n\t\t\t\t\ttag: view.getTag()\n\t\t\t\t};\n\t\t\t}, view);\n\t\t}\n\n\t\tthis.unpack = function (data) {\n\t\t\tjsio(\"import ui.View\");\n\t\t\tjsio(\"import ui.ImageView\");\n\t\t\tjsio(\"import ui.resource.Image\");\n\t\t\tjsio(\"import ui.TextView\");\n\t\t\tjsio(\"import ui.ScrollView\");\n\n\t\t\tfunction buildView (superview, data) {\n\t\t\t\tvar view;\n\n\t\t\t\tvar opts = data.data;\n\t\t\t\topts.x = opts.x || 0;\n\t\t\t\topts.y = opts.y || 0;\n\t\t\t\topts.visible = 'visible' in opts ? opts.visible : true;\n\t\t\t\topts.opacity = 'opacity' in opts ? opts.opacity : 1;\n\t\t\t\topts.scale = opts.scale || 1;\n\t\t\t\tif (opts.image) {\n\t\t\t\t\tvar img = opts.image;\n\t\t\t\t\tview = new ui.ImageView({\n\t\t\t\t\t\tx: opts.x,\n\t\t\t\t\t\ty: opts.y,\n\t\t\t\t\t\twidth: opts.width,\n\t\t\t\t\t\theight: opts.height,\n\t\t\t\t\t\tscale: opts.scale,\n\t\t\t\t\t\tclip: opts.clip,\n\n\t\t\t\t\t\tscaleMethod: opts.scaleMethod,\n\t\t\t\t\t\tslices: opts.slices,\n\n\t\t\t\t\t\tsuperview: superview,\n\t\t\t\t\t\timage: typeof img == 'string' ? img : new ui.resource.Image({\n\t\t\t\t\t\t\turl: img.url,\n\t\t\t\t\t\t\tsourceX: img.x,\n\t\t\t\t\t\t\tsourceY: img.y,\n\t\t\t\t\t\t\tsourceW: img.width,\n\t\t\t\t\t\t\tsourceH: img.height,\n\t\t\t\t\t\t\tmarginTop: img.marginTop,\n\t\t\t\t\t\t\tmarginRight: img.marginRight,\n\t\t\t\t\t\t\tmarginBottom: img.marginBottom,\n\t\t\t\t\t\t\tmarginLeft: img.marginLeft\n\t\t\t\t\t\t}),\n\t\t\t\t\t\tvisible: opts.visible,\n\t\t\t\t\t\topacity: opts.opacity,\n\t\t\t\t\t\ttag: opts.tag\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tview = new (opts.text ? ui.TextView : (opts.clip ? ui.ScrollView : ui.View))({\n\t\t\t\t\t\tx: opts.x,\n\t\t\t\t\t\ty: opts.y,\n\t\t\t\t\t\tclip: opts.clip,\n\t\t\t\t\t\twidth: opts.width,\n\t\t\t\t\t\theight: opts.height,\n\t\t\t\t\t\ttext: opts.text,\n\t\t\t\t\t\tsuperview: superview,\n\t\t\t\t\t\tscale: opts.scale,\n\t\t\t\t\t\tvisible: opts.visible,\n\t\t\t\t\t\topacity: opts.opacity,\n\t\t\t\t\t\ttag: opts.tag\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tview.uid = data.uid;\n\n\t\t\t\tif (data.subviews) {\n\t\t\t\t\tfor (var i = 0, sub; sub = data.subviews[i]; ++i) {\n\t\t\t\t\t\tbuildView(view, sub);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tGC.app.view.updateOpts(data.data);\n\t\t\tfor (var i = 0, sub; sub = data.subviews[i]; ++i) {\n\t\t\t\tbuildView(GC.app.view, sub);\n\t\t\t}\n\t\t}\n\n\t\tthis.eachView = function (list, f) {\n\t\t\tfor (var i = 0, n = list.length; i < n; ++i) {\n\t\t\t\tvar view = this.getViewByID(list[i]);\n\t\t\t\tif (view) {\n\t\t\t\t\tf(view, list[i]);\n\t\t\t\t} else {\n\t\t\t\t\tlogger.warn('view', list[i], 'not found');\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis.hideViews = function (/* id1, id2, id3, ... */) {\n\t\t\tthis.eachView(arguments, function (view) { view.style.visible = false; });\n\t\t}\n\n\t\tthis.showViews = function (/* id1, id2, id3, ... */) {\n\t\t\tthis.eachView(arguments, function (view) { view.style.visible = true; });\n\t\t}\n\n\t\tthis.hideAllViews = function () {\n\t\t\tthis.traverse(function (view) { view.style.visible = false; });\n\t\t}\n\n\t\tthis.showAllViews = function () {\n\t\t\tthis.traverse(function (view) { view.style.visible = true; });\n\t\t}\n\n\t\tthis.hideViewRange = function (a, b) {\n\t\t\tvar range = [];\n\t\t\tfor (var i = a; i < b; ++i) {\n\t\t\t\trange.push(i);\n\t\t\t}\n\n\t\t\tthis.hideViews.apply(this, range);\n\t\t}\n\n\t\tthis.showViewRange = function (a, b) {\n\t\t\tvar range = [];\n\t\t\tfor (var i = a; i < b; ++i) {\n\t\t\t\trange.push(i);\n\t\t\t}\n\n\t\t\tthis.showViews.apply(this, range);\n\t\t}\n\t});\n}","pre":true},"sdk/timestep/ui/ImageView.js":{"path":"sdk/timestep/ui/ImageView.js","friendlyPath":"ui.ImageView","directory":"sdk/timestep/ui/","filename":"ImageView.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @class ui.ImageView;\n * Import the ImageView from the Canvas/DOM rendering backend.\n *\n * @doc http://doc.gameclosure.com/api/ui-imageview.html\n * @docsrc https://github.com/gameclosure/doc/blob/master/api/ui/imageview.md\n */\n\njsio(\"import device\");\nexports = device.importUI('ImageView');\n","pre":true},"sdk/timestep/ui/ImageScaleView.js":{"path":"sdk/timestep/ui/ImageScaleView.js","friendlyPath":"ui.ImageScaleView","directory":"sdk/timestep/ui/","filename":"ImageScaleView.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @class ui.ImageScaleView\n *\n * @doc http://doc.gameclosure.com/api/ui-imageview.html#class-ui.imagescaleview\n * @docsrc https://github.com/gameclosure/doc/blob/master/api/ui/imageview.md\n */\n\njsio(\"import ui.View\");\njsio(\"import ui.resource.Image as Image\");\n\nvar sdk_timestep_ui_ImageScaleView=__class__;exports=sdk_timestep_ui_ImageScaleView(function sdk_timestep_ui_ImageScaleView(){return this.init&&this.init.apply(this,arguments)},ui.View, function (supr) {\n\n\tvar defaults = {\n\t\timage: null,\n\t\tautoSize: false,\n\t\tscaleMethod: 'stretch',\n\t\trenderCenter: true\n\t};\n\n\tthis.init = function (opts) {\n\t\tsupr(this, 'init', [merge(opts, defaults)]);\n\t};\n\n\tthis.getScaleMethod = function () {\n\t\treturn this._scaleMethod;\n\t};\n\n\tthis.updateSlices = function (opts) {\n\t\t// reset slice cache\n\t\tthis._renderCacheKey = {};\n\t\tthis._sliceCache = [];\n\t\tfor (var i = 0; i < 9; ++i) {\n\t\t\tvar row = [this._img.getSource(), 0, 0, 0, 0, 0, 0, 0, 0];\n\t\t\trow.render = false;\n\t\t\tthis._sliceCache.push(row);\n\t\t}\n\n\t\topts.destSlices = opts.destSlices || opts.sourceSlices;\n\t\t// {horizontal: {left: n, center: n, right: n}, vertical: {top: n, middle: n, bottom: n}}\n\t\tthis._sourceSlices = opts.sourceSlices;\n\t\t// {horizontal: {left: n, right: n}, vertical: {top: n, bottom: n}}\n\t\tthis._destSlices = opts.destSlices;\n\n\t\tthis._imgScale = opts.imgScale || 1;\n\n\t\tif (!opts.sourceSlices || !(opts.sourceSlices.horizontal || opts.sourceSlices.vertical)) {\n\t\t\tthrow new Error('slice views require sourceSlices.horizontal and/or sourceSlices.vertical');\n\t\t}\n\n\t\tif (opts.scaleMethod === '2slice') {\n\t\t\tif (opts.sourceSlices.horizontal && opts.destSlices.horizontal) {\n\t\t\t\tif (opts.destSlices.horizontal.left) {\n\t\t\t\t\topts.sourceSlices.horizontal.center = opts.sourceSlices.horizontal.right;\n\t\t\t\t\topts.sourceSlices.horizontal.right = 0;\n\t\t\t\t} else if (opts.destSlices.horizontal.right) {\n\t\t\t\t\topts.sourceSlices.horizontal.center = opts.sourceSlices.horizontal.left;\n\t\t\t\t\topts.sourceSlices.horizontal.left = 0;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (opts.sourceSlices.vertical && opts.destSlices.vertical) {\n\t\t\t\tif (opts.destSlices.vertical.top) {\n\t\t\t\t\topts.sourceSlices.vertical.middle = opts.sourceSlices.vertical.bottom;\n\t\t\t\t\topts.sourceSlices.vertical.bottom = 0;\n\t\t\t\t} else if (opts.destSlices.vertical.bottom) {\n\t\t\t\t\topts.sourceSlices.vertical.middle = opts.sourceSlices.vertical.bottom;\n\t\t\t\t\topts.sourceSlices.vertical.bottom = 0;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (opts.sourceSlices.horizontal) {\n\t\t\tvar src = opts.sourceSlices.horizontal;\n\t\t\tvar slices = [src.left || 0, src.center || 0, src.right || 0];\n\t\t\tif (src.center == undefined && this._img) { // also captures null, but ignores 0\n\t\t\t\tvar width = this._img.getWidth();\n\t\t\t\tslices[1] = width ? width - slices[0] - slices[2] : 0;\n\t\t\t}\n\n\t\t\tthis._sourceSlicesHor = slices;\n\t\t\tthis._destSlicesHor = [\n\t\t\t\t(this._destSlices.horizontal.left || 0) * this._imgScale,\n\t\t\t\t0,\n\t\t\t\t(this._destSlices.horizontal.right || 0) * this._imgScale\n\t\t\t];\n\t\t} else {\n\t\t\tthis._sourceSlicesHor = [0, 100, 0];\n\t\t\tthis._destSlicesHor = [0, 100, 0];\n\t\t}\n\n\t\tif (opts.sourceSlices.vertical) {\n\t\t\tvar src = opts.sourceSlices.vertical;\n\t\t\tvar slices = [src.top || 0, src.middle || 0, src.bottom || 0];\n\t\t\tif (src.middle == undefined && this._img) {\n\t\t\t\tvar height = this._img.getHeight();\n\t\t\t\tslices[1] = height ? height - slices[0] - slices[2] : 0;\n\t\t\t}\n\n\t\t\tthis._sourceSlicesVer = slices;\n\t\t\tthis._destSlicesVer = [\n\t\t\t\t(this._destSlices.vertical.top || 0) * this._imgScale,\n\t\t\t\t0,\n\t\t\t\t(this._destSlices.vertical.bottom || 0) * this._imgScale\n\t\t\t];\n\t\t} else {\n\t\t\tthis._sourceSlicesVer = [0, 100, 0];\n\t\t\tthis._destSlicesVer = [0, 100, 0];\n\t\t}\n\t};\n\n\tthis.updateOpts = function (opts) {\n\t\topts = merge(supr(this, 'updateOpts', arguments), this._opts);\n\n\t\tif (opts.scaleMethod) {\n\t\t\tif (this._scaleMethod != opts.scaleMethod) {\n\t\t\t\tvar key = opts.scaleMethod;\n\t\t\t\tif (/slice$/.test(key)) {\n\t\t\t\t\tkey = 'slice';\n\t\t\t\t}\n\n\t\t\t\tthis.render = renderFunctions[key];\n\t\t\t\tthis._renderCacheKey = {};\n\t\t\t\tthis._scaleMethod = opts.scaleMethod;\n\t\t\t\tthis._isSlice = this._scaleMethod.slice(1) == 'slice';\n\t\t\t}\n\t\t}\n\n\t\tif ('debug' in opts) {\n\t\t\tthis.debug = !!opts.debug;\n\t\t}\n\n\t\tif (this._isSlice && this._img) {\n\t\t\tthis.updateSlices(opts);\n\t\t}\n\n\t\tif (opts.image) {\n\t\t\tthis.setImage(opts.image, opts);\n\t\t}\n\t\tif (opts.verticalAlign) {\n\t\t\tthis._renderCacheKey = {};\n\t\t\tthis._verticalAlign = opts.verticalAlign;\n\t\t}\n\t\tif (opts.align || opts.horizontalAlign) {\n\t\t\tthis._align = opts.align || opts.horizontalAlign;\n\t\t}\n\n\t\t// tile mode\n\t\tif ('rows' in opts) {\n\t\t\tthis.rows = opts.rows;\n\t\t}\n\t\tif ('columns' in opts) {\n\t\t\tthis.columns = opts.columns;\n\t\t}\n\t\tvar r = this.rows;\n\t\tvar c = this.columns;\n\t\tif (this._scaleMethod == 'tile' && (!(r || c) || (r && c))) {\n\t\t\tthrow new Error('tile views must define either rows or columns');\n\t\t}\n\n\t\treturn opts;\n\t};\n\n\tthis._computeSlices = function (w, h, absScale) {\n\t\tvar bounds = this._img.getBounds();\n\t\tvar iw = bounds.width;\n\t\tvar ih = bounds.height;\n\t\tif (iw <= 0 || ih <= 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar image = this._img.getSource();\n\t\tvar sourceSlicesHor = this._sourceSlicesHor;\n\t\tvar sourceSlicesVer = this._sourceSlicesVer;\n\t\tvar destSlicesHor = [];\n\t\tvar destSlicesVer = [];\n\n\t\tif (sourceSlicesHor) {\n\t\t\tvar ratio = this.style.fixedAspectRatio ? h / ih : 1;\n\t\t\tdestSlicesHor[0] = this._destSlicesHor[0] * ratio;\n\t\t\tdestSlicesHor[2] = this._destSlicesHor[2] * ratio;\n\t\t\tdestSlicesHor[1] = w - destSlicesHor[0] - destSlicesHor[2];\n\n\t\t\tif (destSlicesHor[1] < 0) {\n\t\t\t\tdestSlicesHor[0] = (destSlicesHor[0] * w / (destSlicesHor[0] + destSlicesHor[2])) | 0;\n\t\t\t\tdestSlicesHor[1] = 0;\n\t\t\t\tdestSlicesHor[2] = w - destSlicesHor[0];\n\t\t\t}\n\t\t}\n\n\t\tif (sourceSlicesVer) {\n\t\t\tvar ratio = this.style.fixedAspectRatio ? w / iw : 1;\n\t\t\tdestSlicesVer[0] = this._destSlicesVer[0] * ratio;\n\t\t\tdestSlicesVer[2] = this._destSlicesVer[2] * ratio;\n\t\t\tdestSlicesVer[1] = h - destSlicesVer[0] - destSlicesVer[2];\n\n\t\t\tif (destSlicesVer[1] < 0) {\n\t\t\t\tdestSlicesVer[0] = (destSlicesVer[0] * h / (destSlicesVer[0] + destSlicesVer[2])) | 0;\n\t\t\t\tdestSlicesVer[1] = 0;\n\t\t\t\tdestSlicesVer[2] = h - destSlicesVer[0];\n\t\t\t}\n\t\t}\n\n\t\tvar marginLeft = bounds.marginLeft,\n\t\t\torigLeftSlice = sourceSlicesHor[0] + bounds.marginLeft;\n\t\tif (origLeftSlice && destSlicesHor[0]) {\n\t\t\tmarginLeft *= destSlicesHor[0] / origLeftSlice;\n\t\t}\n\n\t\tvar marginRight = bounds.marginRight,\n\t\t\torigRightSlice = sourceSlicesHor[2] + bounds.marginRight;\n\t\tif (origRightSlice && destSlicesHor[2]) {\n\t\t\tmarginRight *= destSlicesHor[2] / origRightSlice;\n\t\t}\n\n\t\tvar marginTop = bounds.marginTop,\n\t\t\torigTopSlice = sourceSlicesVer[0] + bounds.marginTop;\n\t\tif (origTopSlice && destSlicesVer[0]) {\n\t\t\tmarginTop *= destSlicesVer[0] / origTopSlice;\n\t\t}\n\n\t\tvar marginBottom = bounds.marginBottom,\n\t\t\torigBottomSlice = sourceSlicesVer[2] + bounds.marginBottom;\n\t\tif (origBottomSlice && destSlicesVer[2]) {\n\t\t\tmarginBottom *= destSlicesVer[2] / origBottomSlice;\n\t\t}\n\n\t\tif (destSlicesHor[0]) {\n\t\t\tdestSlicesHor[0] -= marginLeft;\n\t\t} else {\n\t\t\tdestSlicesHor[1] -= marginLeft;\n\t\t}\n\n\t\tif (destSlicesVer[0]) {\n\t\t\tdestSlicesVer[0] -= marginTop;\n\t\t} else {\n\t\t\tdestSlicesVer[1] -= marginTop;\n\t\t}\n\n\t\tif (destSlicesHor[2]) {\n\t\t\tdestSlicesHor[2] -= marginRight;\n\t\t} else {\n\t\t\tdestSlicesHor[1] -= marginRight;\n\t\t}\n\n\t\tif (destSlicesVer[2]) {\n\t\t\tdestSlicesVer[2] -= marginBottom;\n\t\t} else {\n\t\t\tdestSlicesVer[1] -= marginBottom;\n\t\t}\n\n\t\tvar heightBalance = 0;\n\t\tvar sx, sw, sh;\n\t\tvar sy = bounds.y;\n\t\tvar dx, dw, dh;\n\t\tvar dy = marginTop;\n\t\tvar i, j;\n\n\t\tfor (j = 0; j < 3; j++) {\n\t\t\tvar widthBalance = 0;\n\t\t\tvar idealHeight = destSlicesVer[j] + heightBalance;\n\t\t\tvar roundedHeight = Math.round(absScale * idealHeight) / absScale;\n\t\t\theightBalance = idealHeight - roundedHeight;\n\n\t\t\tsh = sourceSlicesVer[j];\n\t\t\tdh = roundedHeight;\n\t\t\tsx = bounds.x;\n\t\t\tdx = marginLeft;\n\t\t\tfor (i = 0; i < 3; i++) {\n\t\t\t\tvar idealWidth = destSlicesHor[i] + widthBalance;\n\t\t\t\tvar roundedWidth = Math.round(absScale * idealWidth) / absScale;\n\t\t\t\twidthBalance = idealWidth - roundedWidth;\n\n\t\t\t\tsw = sourceSlicesHor[i];\n\t\t\t\tdw = roundedWidth;\n\n\t\t\t\tvar cache = this._sliceCache[j * 3 + i];\n\t\t\t\tif (sw > 0 && sh > 0 && dw > 0 && dh > 0) {\n\t\t\t\t\tcache[1] = sx;\n\t\t\t\t\tcache[2] = sy;\n\t\t\t\t\tcache[3] = sw;\n\t\t\t\t\tcache[4] = sh;\n\t\t\t\t\tcache[5] = dx;\n\t\t\t\t\tcache[6] = dy;\n\t\t\t\t\tcache[7] = dw;\n\t\t\t\t\tcache[8] = dh;\n\t\t\t\t\tcache.render = true;\n\t\t\t\t} else {\n\t\t\t\t\tcache.render = false;\n\t\t\t\t}\n\n\t\t\t\tsx += sw;\n\t\t\t\tdx += dw;\n\t\t\t}\n\t\t\tsy += sh;\n\t\t\tdy += dh;\n\n\t\t\tmarginTop = 0;\n\t\t}\n\t};\n\n\tthis.getImage = function () {\n\t\treturn this._img;\n\t};\n\n\tthis.setImage = function (img, opts) {\n\t\tthis._renderCacheKey = {};\n\t\tvar autoSized = false;\n\t\tvar sw, sh, iw, ih, bounds;\n\t\topts = merge(opts, this._opts);\n\n\t\tif (typeof img == 'string') {\n\t\t\tbounds = GCResources.getMap()[img];\n\t\t\tif (bounds) {\n\t\t\t\tiw = bounds.w + bounds.marginLeft + bounds.marginRight;\n\t\t\t\tih = bounds.h + bounds.marginTop + bounds.marginBottom;\n\t\t\t}\n\t\t} else if (img instanceof Image && img.isLoaded()) {\n\t\t\tbounds = img.getBounds();\n\t\t\tiw = bounds.width + bounds.marginLeft + bounds.marginRight;\n\t\t\tih = bounds.height + bounds.marginTop + bounds.marginBottom;\n\t\t}\n\n\t\tif (!bounds) {\n\t\t\tif (typeof img == 'string') {\n\t\t\t\timg = new Image({url: img});\n\t\t\t}\n\n\t\t\tif (img) {\n\t\t\t\tif (!img.isError()) {\n\t\t\t\t\timg.doOnLoad(this, 'setImage', img, opts);\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tif (opts.autoSize && this._scaleMethod == 'stretch' && !((opts.width || opts.layoutWidth) && (opts.height || opts.layoutHeight))) {\n\t\t\tautoSized = true;\n\t\t\tif (this.style.fixedAspectRatio) {\n\t\t\t\tthis.style.enforceAspectRatio(iw, ih);\n\t\t\t} else {\n\t\t\t\tthis.style.width = iw;\n\t\t\t\tthis.style.height = ih;\n\t\t\t}\n\t\t}\n\n\t\tthis._opts.image = this._img = (typeof img == 'string') ? new Image({url: img}) : img;\n\n\t\tif (this._img) {\n\t\t\tif (this._isSlice) {\n\t\t\t\tthis.updateSlices({\n\t\t\t\t\tscaleMethod: this._opts.scaleMethod,\n\t\t\t\t\tsourceSlices: this._opts.sourceSlices,\n\t\t\t\t\tdestSlices: this._opts.destSlices\n\t\t\t\t});\n\n\t\t\t\tvar sourceSlicesHor = this._sourceSlicesHor;\n\t\t\t\tvar sourceSlicesVer = this._sourceSlicesVer;\n\t\t\t\tif (sourceSlicesHor) {\n\t\t\t\t\tsw = sourceSlicesHor[0] + sourceSlicesHor[1] + sourceSlicesHor[2];\n\t\t\t\t\tvar sourceScaleX = iw / sw;\n\t\t\t\t\tsourceSlicesHor[0] = sourceSlicesHor[0] * sourceScaleX - bounds.marginLeft;\n\t\t\t\t\tsourceSlicesHor[1] *= sourceScaleX;\n\t\t\t\t\tsourceSlicesHor[2] = sourceSlicesHor[2] * sourceScaleX - bounds.marginRight;\n\t\t\t\t}\n\t\t\t\tif (sourceSlicesVer) {\n\t\t\t\t\tsh = sourceSlicesVer[0] + sourceSlicesVer[1] + sourceSlicesVer[2];\n\t\t\t\t\tvar sourceScaleY = ih / sh;\n\t\t\t\t\tsourceSlicesVer[0] = sourceSlicesVer[0] * sourceScaleY - bounds.marginTop;\n\t\t\t\t\tsourceSlicesVer[1] *= sourceScaleY;\n\t\t\t\t\tsourceSlicesVer[2] = sourceSlicesVer[2] * sourceScaleY - bounds.marginBottom;\n\t\t\t\t}\n\t\t\t\t[0, 2].forEach(function(num) {\n\t\t\t\t\tif (sourceSlicesHor && sourceSlicesHor[num] < 0) {\n\t\t\t\t\t\tsourceSlicesHor[1] += sourceSlicesHor[num];\n\t\t\t\t\t\tsourceSlicesHor[num] = 0;\n\t\t\t\t\t}\n\t\t\t\t\tif (sourceSlicesVer && sourceSlicesVer[num] < 0) {\n\t\t\t\t\t\tsourceSlicesVer[1] += sourceSlicesVer[num];\n\t\t\t\t\t\tsourceSlicesVer[num] = 0;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (opts && opts.autoSize && !autoSized) {\n\t\t\t\tthis._img.doOnLoad(this, 'autoSize');\n\t\t\t}\n\n\t\t\tthis._img.doOnLoad(this, 'needsRepaint');\n\t\t}\n\t};\n\n\tthis.doOnLoad = function () {\n\t\tif (arguments.length == 1) {\n\t\t\tthis._img.doOnLoad(this, arguments[0]);\n\t\t} else {\n\t\t\tthis._img.doOnLoad.apply(this._img, arguments);\n\t\t}\n\t\treturn this;\n\t};\n\n\tthis.autoSize = function () {\n\t\tif (this._img && this._img.isLoaded()) {\n\t\t\tthis.style.width = this._img.getWidth() || this._opts.width;\n\t\t\tthis.style.height = this._img.getHeight() || this._opts.height;\n\t\t}\n\t};\n\n\tthis.getOrigWidth = this.getOrigW = function () {\n\t\treturn this._img.getOrigW();\n\t};\n\n\tthis.getOrigHeight = this.getOrigH = function () {\n\t\treturn this._img.getOrigH();\n\t};\n\n\tfunction renderCoverOrContain(ctx, opts) {\n\t\tif (!this._img) { return; }\n\n\t\tvar max = Math.max;\n\t\tvar min = Math.min;\n\t\tvar s = this.style;\n\t\tvar w = s.width;\n\t\tvar h = s.height;\n\t\tvar cachedKey = this._renderCacheKey;\n\t\tvar cache = this._renderCache || (this._renderCache = {x: 0, y: 0, w: 0, h: 0});\n\t\tif (cachedKey.width != w || cachedKey.height != h) {\n\t\t\tcachedKey.width = w;\n\t\t\tcachedKey.height = h;\n\n\t\t\tvar bounds = this._img.getBounds();\n\t\t\tvar marginLeft = bounds.marginLeft;\n\t\t\tvar marginRight = bounds.marginRight;\n\t\t\tvar marginTop = bounds.marginTop;\n\t\t\tvar marginBottom = bounds.marginBottom;\n\t\t\tvar sw = bounds.width;\n\t\t\tvar sh = bounds.height;\n\t\t\tvar ow = sw + marginLeft + marginRight;\n\t\t\tvar oh = sh + marginTop + marginBottom;\n\t\t\tvar scale = 1;\n\t\t\tvar targetRatio = ow / oh;\n\t\t\tvar ratio = w / h;\n\n\t\t\tvar isCover = this._scaleMethod == 'cover';\n\t\t\tif (isCover ? ratio > targetRatio : ratio < targetRatio) {\n\t\t\t\tscale = w / ow;\n\t\t\t} else {\n\t\t\t\tscale = h / oh;\n\t\t\t}\n\n\t\t\tvar dw = sw * scale;\n\t\t\tvar dh = sh * scale;\n\t\t\tvar fw = ow * scale;\n\t\t\tvar fh = oh * scale;\n\n\t\t\tcache.x = this._align == 'left'\n\t\t\t\t? marginLeft * scale\n\t\t\t\t: this._align == 'right'\n\t\t\t\t\t? w - (sw + marginRight) * scale\n\t\t\t\t\t: (w - dw) / 2;\n\t\t\tcache.y = this._verticalAlign == 'top'\n\t\t\t\t? marginTop * scale\n\t\t\t\t: this._verticalAlign == 'bottom'\n\t\t\t\t\t? h - (sh + marginBottom) * scale\n\t\t\t\t\t: (h - dh) / 2;\n\n\t\t\tcache.w = dw;\n\t\t\tcache.h = dh;\n\t\t\tcache.sx = bounds.x;\n\t\t\tcache.sy = bounds.y;\n\t\t\tcache.sw = sw;\n\t\t\tcache.sh = sh;\n\n\t\t\tif (isCover) {\n\t\t\t\tif (fh > h) {\n\t\t\t\t\tif (this._verticalAlign == 'bottom') {\n\t\t\t\t\t\tcache.y = max(0, h - marginBottom * scale - dh);\n\t\t\t\t\t\tcache.h = min(dh, h - marginBottom * scale);\n\t\t\t\t\t\tcache.sy += max(0, sh - cache.h / scale);\n\t\t\t\t\t\tcache.sh = cache.h / scale;\n\t\t\t\t\t} else if (this._verticalAlign == 'top') {\n\t\t\t\t\t\tcache.y = marginTop * scale;\n\t\t\t\t\t\tcache.h = min(dh, h - cache.y);\n\t\t\t\t\t\tcache.sh = cache.h / scale;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tcache.y = max(0, (h - dh) / 2);\n\t\t\t\t\t\tcache.h = min(dh, h);\n\t\t\t\t\t\tcache.sh = cache.h / scale;\n\t\t\t\t\t\tcache.sy = max(cache.sy, cache.sy + (sh - cache.sh) / 2);\n\t\t\t\t\t}\n\t\t\t\t} else if (fw > w) {\n\t\t\t\t\tif (this._align == 'right') {\n\t\t\t\t\t\tcache.x = max(0, w - marginRight * scale - dw);\n\t\t\t\t\t\tcache.w = min(dw, w - marginRight * scale);\n\t\t\t\t\t\tcache.sx += max(0, sw - cache.w / scale);\n\t\t\t\t\t\tcache.sw = cache.w / scale;\n\t\t\t\t\t} else if (this._align == 'left') {\n\t\t\t\t\t\tcache.x = marginLeft * scale;\n\t\t\t\t\t\tcache.w = min(dw, w - cache.x);\n\t\t\t\t\t\tcache.sw = cache.w / scale;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tcache.x = max(0, (w - dw) / 2);\n\t\t\t\t\t\tcache.w = min(dw, w);\n\t\t\t\t\t\tcache.sw = cache.w / scale;\n\t\t\t\t\t\tcache.sx = max(cache.sx, cache.sx + (sw - cache.sw) / 2);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis._img.render(ctx, cache.sx, cache.sy, cache.sw, cache.sh, cache.x, cache.y, cache.w, cache.h);\n\n\t\tif (this.debug) {\n\t\t\tctx.strokeStyle = debugColors[0];\n\t\t\tctx.strokeRect(0, 0, s.width, s.height);\n\t\t}\n\t}\n\n\tvar renderFunctions = {\n\t\t'none': function (ctx, opts) {\n\t\t\tthis._img && this._img.render(ctx, 0, 0);\n\t\t},\n\t\t'stretch': function (ctx, opts) {\n\t\t\tvar s = this.style;\n\t\t\tvar w = s.width;\n\t\t\tvar h = s.height;\n\t\t\tthis._img && this._img.render(ctx, 0, 0, w, h);\n\t\t},\n\t\t'contain': renderCoverOrContain,\n\t\t'cover': renderCoverOrContain,\n\t\t'tile': function (ctx, opts) {\n\t\t\tif (!this._img) { return; }\n\n\t\t\tvar s = this.style;\n\t\t\tvar w = s.width;\n\t\t\tvar h = s.height;\n\n\t\t\tvar bounds = this._img.getBounds();\n\t\t\tvar iw = bounds.width;\n\t\t\tvar ih = bounds.height;\n\n\t\t\tvar x = 0, y = 0;\n\n\t\t\tif (this.rows) {\n\t\t\t\tvar targetHeight = h / this.rows;\n\t\t\t\tvar targetRatio = targetHeight / ih;\n\t\t\t\tvar targetWidth = iw * targetRatio;\n\t\t\t\tfor (var i = 0; i < this.rows; i++) {\n\t\t\t\t\twhile (x < w) {\n\t\t\t\t\t\tthis._img.render(ctx, x, y, targetWidth, targetHeight);\n\t\t\t\t\t\tif (this.debug) {\n\t\t\t\t\t\t\tctx.strokeStyle = debugColors[i % 3];\n\t\t\t\t\t\t\tctx.strokeRect(x + 0.5, y + 0.5, targetWidth - 1, targetHeight - 1);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tx += targetWidth;\n\t\t\t\t\t}\n\t\t\t\t\ty += targetHeight;\n\t\t\t\t\tx = 0;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse if (this.columns) {\n\t\t\t\tvar targetWidth = w / this.columns;\n\t\t\t\tvar targetRatio = targetWidth / iw;\n\t\t\t\tvar targetHeight = ih * targetRatio;\n\t\t\t\tfor (var i = 0; i < this.columns; i++) {\n\t\t\t\t\twhile (y < h) {\n\t\t\t\t\t\tthis._img.render(ctx, x, y, targetWidth, targetHeight);\n\t\t\t\t\t\tif (this.debug) {\n\t\t\t\t\t\t\tctx.strokeStyle = debugColors[i % 3];\n\t\t\t\t\t\t\tctx.strokeRect(x + 0.5, y + 0.5, targetWidth - 1, targetHeight - 1);\n\t\t\t\t\t\t}\n\t\t\t\t\t\ty += targetHeight;\n\t\t\t\t\t}\n\t\t\t\t\tx += targetWidth;\n\t\t\t\t\ty = 0;\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\t'slice': function (ctx, opts) {\n\t\t\tif (!this._img) { return; }\n\n\t\t\tvar s = this.style;\n\t\t\tvar w = s.width;\n\t\t\tvar h = s.height;\n\t\t\tvar scale = s.scale;\n\t\t\tvar cachedKey = this._renderCacheKey;\n\t\t\tif (cachedKey.width != w || cachedKey.height != h || cachedKey.absScale != scale) {\n\t\t\t\tcachedKey.width = w;\n\t\t\t\tcachedKey.height = h;\n\t\t\t\tcachedKey.absScale = scale;\n\t\t\t\tthis._computeSlices(w, h, scale);\n\t\t\t}\n\n\t\t\tfor (var i = 0; i < 9; i++) {\n\t\t\t\tthis._drawSlice(ctx, this._sliceCache[i], i);\n\t\t\t}\n\t\t}\n\t};\n\n\tthis._drawSlice = function (ctx, sliceData, i) {\n\t\tif (!sliceData.render || (!this._opts.renderCenter && (i == 4))) { return; }\n\t\tctx.drawImage.apply(ctx, sliceData);\n\t\tif (this.debug) {\n\t\t\tctx.strokeStyle = debugColors[i % 3];\n\t\t\tctx.strokeRect(sliceData[5] + 0.5, sliceData[6] + 0.5,\n\t\t\t\tsliceData[7] - 1, sliceData[8] - 1);\n\t\t}\n\t};\n\n\tvar debugColors = ['#FF0000', '#00FF00', '#0000FF'];\n\n\tthis.getTag = function () {\n\t\treturn 'ImageScaleView' + this.uid + ':' + (this._img && this._img._map.url.substring(0, 16));\n\t};\n});\n","pre":true},"sdk/timestep/ui/TextView.js":{"path":"sdk/timestep/ui/TextView.js","friendlyPath":"ui.TextView","directory":"sdk/timestep/ui/","filename":"TextView.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @class ui.TextView;\n * Import the Canvas/DOM implementation of TextView.\n *\n * @doc http://doc.gameclosure.com/api/ui-text.html#class-ui.textview\n * @docsrc https://github.com/gameclosure/doc/blob/master/api/ui/text.md\n */\n\njsio(\"import device\");\n\nexports = device.importUI('TextView');\n","pre":true},"sdk/timestep/ui/ScrollView.js":{"path":"sdk/timestep/ui/ScrollView.js","friendlyPath":"ui.ScrollView","directory":"sdk/timestep/ui/","filename":"ScrollView.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @class ui.ScrollView;\n *\n * @doc http://doc.gameclosure.com/api/ui-scrollview.html\n * @docsrc https://github.com/gameclosure/doc/blob/master/api/ui/scrollview.md\n */\njsio(\"import animate\");\njsio(\"import device\");\n\njsio(\"import event.input.dispatch as input\");\njsio(\"import event.input.InputEvent as InputEvent\");\n\njsio(\"import math.geom.Rect as Rect\");\njsio(\"import math.geom.Point as Point\");\njsio(\"import math.geom.Circle as Circle\");\njsio(\"import math.geom.intersect as intersect\");\n\njsio(\"import ui.View as View\");\njsio(\"import ui.backend.ReflowManager as ReflowManager\");\n\nvar _reflowMgr = ReflowManager.get();\n\nvar DEBUG = true;\nvar USE_CLIPPING = false;\n// var USE_CLIPPING = !device.useDOM && !device.isMobile;\n\nif (DEBUG) {\n\tvar _debug = {\n\t\tbounds: []\n\t};\n}\n/*function customEaseOut(x) {\n\tvar x = (1 - x);\n\tx *= x;\n\treturn 1 - x * x;\n}*/\n\n/**\n * @extends ui.View\n */\nvar sdk_timestep_ui_ScrollView=__class__;exports=sdk_timestep_ui_ScrollView(function sdk_timestep_ui_ScrollView(){return this.init&&this.init.apply(this,arguments)},View, function (supr) {\n\n\tthis.tag = \"ScrollView\";\n\n\tif (USE_CLIPPING) {\n\n\t\t// extend the default backing ctor\nthis.BackingCtor=__class__;\t\tthis.BackingCtor=this.BackingCtor(function this_BackingCtor(){return this.init&&this.init.apply(this,arguments)},View.prototype.BackingCtor, function () {\n\n\t\t\tfunction clippedWrapRender(contentView, backing, ctx, opts) {\n\t\t\t\tif (!backing.visible) { return; }\n\n\t\t\t\tif (!backing.__firstRender) { _reflowMgr.add(backing._view); }\n\n\t\t\t\t// non-native case only\n\t\t\t\tif (backing._needsSort) { backing._needsSort = false; backing._subviews.sort(); }\n\n\t\t\t\tctx.save();\n\t\t\t\tctx.translate(backing.x + backing.anchorX, backing.y + backing.anchorY);\n\n\t\t\t\tif (backing.r) { ctx.rotate(backing.r); }\n\n\t\t\t\t// clip this render to be within its view;\n\t\t\t\tif (backing.scale != 1) { ctx.scale(backing.scale, backing.scale); }\n\t\t\t\tif (backing.opacity != 1) { ctx.globalAlpha *= backing.opacity; }\n\n\t\t\t\tctx.translate(-backing.anchorX, -backing.anchorY);\n\n\t\t\t\t// if (backing._circle) { ctx.translate(-backing.width / 2, -backing.height / 2); }\n\n\t\t\t\tif (backing.clip) { ctx.clipRect(0, 0, backing.width, backing.height); }\n\t\t\t\t// var filters = this.getFilters();\n\t\t\t\t// ctx.setFilters(filters);\n\n\t\t\t\ttry {\n\t\t\t\t\tif (backing.backgroundColor) {\n\t\t\t\t\t\tctx.fillStyle = backing.backgroundColor;\n\t\t\t\t\t\tctx.fillRect(0, 0, backing.width, backing.height);\n\t\t\t\t\t}\n\n\t\t\t\t\tbacking._view.render && backing._view.render(ctx, opts);\n\n\t\t\t\t\tvar viewport = opts.viewport;\n\t\t\t\t\tvar subviews = backing._subviews;\n\n\t\t\t\t\tvar i = 0, subview;\n\t\t\t\t\twhile (subview = subviews[i++]) {\n\t\t\t\t\t\tif (subview == contentView) {\n\t\t\t\t\t\t\tclippedWrapRender(contentView, subview.__view, ctx, opts);\n\n\t\t\t\t\t\t\t// restore the old viewport it was changed\n\t\t\t\t\t\t\topts.viewport = viewport;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tvar pos = subview.getPosition(viewport.src);\n\t\t\t\t\t\t\tgetBoundingRectangle(pos);\n\n\t\t\t\t\t\t\tif (intersect.isRectAndRect(pos, viewport)) {\n\t\t\t\t\t\t\t\tclippedWrapRender(contentView, subview.__view, ctx, opts);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (DEBUG) {\n\t\t\t\t\t\t\t\t_debug.bounds.push(pos);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} catch(e) {\n\t\t\t\t \tlogger.error(backing._view, e.message, e.stack);\n\t\t\t\t} finally {\n\t\t\t\t\t// ctx.clearFilters();\n\t\t\t\t\tctx.restore();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.wrapRender = function (ctx, opts) {\n\n\t\t\t\tclippedWrapRender(this._view._contentView, this, ctx, opts);\n\n\t\t\t\tif (DEBUG) {\n\t\t\t\t\tvar viewport = opts.viewport;\n\n\t\t\t\t\tctx.save();\n\t\t\t\t\tctx.translate(this.x + this.anchorX, this.y + this.anchorY);\n\t\t\t\t\tif (this.r) { ctx.rotate(this.r); }\n\t\t\t\t\tif (this.scale != 1) { ctx.scale(this.scale, this.scale); }\n\t\t\t\t\tctx.translate(-this.anchorX, -this.anchorY);\n\n\t\t\t\t\tctx.fillStyle = 'rgba(255, 0, 0, 0.2)';\n\t\t\t\t\tctx.fillRect(viewport.x, viewport.y, viewport.width, viewport.height);\n\n\t\t\t\t\tctx.translate(-viewport.x, -viewport.y);\n\n\t\t\t\t\tctx.fillStyle = 'rgba(255, 255, 255, 0.2)';\n\t\t\t\t\tfor (var i = 0, bounds; (bounds = _debug.bounds[i]); ++i) {\n\t\t\t\t\t\tctx.fillRect(bounds.x, bounds.y, bounds.width, bounds.height);\n\t\t\t\t\t}\n\t\t\t\t\t_debug.bounds = [];\n\t\t\t\t\tctx.restore();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t};\n\n\tvar defaults = {\n\t\toffsetX: 0,\n\t\toffsetY: 0,\n\t\tscrollY: true,\n\t\tscrollX: true,\n\t\tclip: true,\n\t\tbounce: true,\n\t\tbounceRadius: 50, // [number] or 'bounds'\n\t\tdrag: true,\n\t\tinertia: true,\n\t\tdragRadius: 10,\n\t\tsnapPixels: undefined,\n\t\tuseLayoutBounds: false,\n\t\tlayout: 'box'\n\t};\n\n\tthis.init = function (opts) {\n\n\t\topts = merge(opts, defaults);\n\n\t\tthis._acceleration = 15;\n\n\t\tthis._animState = {\n\t\t\tlastDelta: 0,\n\t\t\toffset: 0\n\t\t};\n\n\t\tthis._snapPixels = 1;\n\n\t\tthis._contentView = new View({\n\t\t\tx: opts.offsetX,\n\t\t\ty: opts.offsetY,\n\t\t\tinfinite: true,\n\t\t\ttag: 'ContentView',\n\t\t\tlayout: 'box',\n\t\t\tlayoutWidth: '100%',\n\t\t\tlayoutHeight: '100%'\n\t\t});\n\n\t\tthis._bounceRadius = opts.bounceRadius;\n\t\tthis._scrollBounds = {\n\t\t\tminX: -Number.MAX_VALUE,\n\t\t\tminY: -Number.MAX_VALUE,\n\t\t\tmaxX: Number.MAX_VALUE,\n\t\t\tmaxY: Number.MAX_VALUE\n\t\t};\n\n\t\tthis._viewport = new Rect();\n\t\tthis._viewport.src = this._contentView;\n\n\t\tsupr(this, 'init', [opts]);\n\t\tsupr(this, 'addSubview', [this._contentView]);\n\n\t\t// this.__layout = this._contentView.__layout;\n\t}\n\n\tthis.updateOpts = function (opts) {\n\t\tsupr(this, 'updateOpts', arguments);\n\n\t\tif ('useLayoutBounds' in opts) {\n\t\t\tif (opts.useLayoutBounds) {\n\t\t\t\tthis.subscribe('LayoutResize', this, '_updateLayoutBounds');\n\t\t\t\tthis._updateLayoutBounds();\n\t\t\t} else {\n\t\t\t\tthis.unsubscribe('LayoutResize', this, '_updateLayoutBounds');\n\t\t\t}\n\t\t}\n\n\t\tif ('scrollBounds' in opts) {\n\t\t\tthis.setScrollBounds(opts.scrollBounds);\n\t\t}\n\n\t\treturn opts;\n\t};\n\n\tthis._updateLayoutBounds = function () {\n\t\tif (!this.style.layout || !this._opts.useLayoutBounds) { return; }\n\n\t\tvar bounds = this._scrollBounds;\n\t\tbounds.minX = bounds.minY = bounds.maxX = bounds.maxY = 0;\n\t\tthis._contentView.getSubviews().forEach(function(sv) {\n\t\t\tbounds.minX = Math.min(bounds.minX, sv.style.x);\n\t\t\tbounds.minY = Math.min(bounds.minY, sv.style.y);\n\t\t\tbounds.maxX = Math.max(bounds.maxX, sv.style.x + sv.style.width);\n\t\t\tbounds.maxY = Math.max(bounds.maxY, sv.style.y + sv.style.height);\n\t\t});\n\t};\n\n\tthis.buildView = function () {\n\t\tthis._snapPixels = this._opts.snapPixels || 1 / this.getPosition().scale;\n\t};\n\n\tthis.addSubview = function (view) {\n\t\tthis._contentView.addSubview(view);\n\t\tthis._updateLayoutBounds();\n\t};\n\tthis.removeSubview = function (view) {\n\t\tthis._contentView.removeSubview(view);\n\t\tthis._updateLayoutBounds();\n\t};\n\n\tthis.removeAllSubviews = function () {\n\t\tthis._contentView.removeAllSubviews();\n\t};\n\n\tthis.addFixedView = function (view) { return supr(this, 'addSubview', [view]); };\n\tthis.removeFixedView = function (view) { return supr(this, 'removeSubview', [view]); };\n\n\tvar PI_2 = Math.PI / 2;\n\n\tthis.getStyleBounds = function () {\n\t\tvar bounds = this._scrollBounds;\n\t\tvar minY = -bounds.maxY;\n\t\tvar maxY = -bounds.minY < minY ? minY : -bounds.minY;\n\t\tvar minX = -bounds.maxX;\n\t\tvar maxX = -bounds.minX < minX ? minX : -bounds.minX;\n\t\treturn {\n\t\t\tminY: Math.min(minY + this.style.height, maxY),\n\t\t\tmaxY: maxY,\n\t\t\tminX: Math.min(minX + this.style.width, maxX),\n\t\t\tmaxX: maxX\n\t\t};\n\t};\n\n\tthis.getOffset = function () { return new Point(this._contentView.style); };\n\tthis.getOffsetX = function () { return this._contentView.style.x; };\n\tthis.getOffsetY = function () { return this._contentView.style.y; };\n\n\tthis.setOffset = function (x, y) {\n\t\tvar style = this._contentView.style,\n\t\t\tdelta = {\n\t\t\t\tx: 0,\n\t\t\t\ty: 0\n\t\t\t};\n\n\t\tvar bounds = this.getStyleBounds();\n\n\t\tif (typeof x == 'number') {\n\t\t\tif (this._isBouncing) {\n\t\t\t\t// do nothing\n\t\t\t} else if (this._canBounce) {\n\t\t\t\tif (x < bounds.minX) {\n\t\t\t\t\tvar temp = (bounds.minX - x) / this._bounceRadius;\n\t\t\t\t\tx = bounds.minX - Math.atan(temp) * this._bounceRadius / PI_2;\n\t\t\t\t}\n\n\t\t\t\tif (x > bounds.maxX) {\n\t\t\t\t\tvar temp = (x - bounds.maxX) / this._bounceRadius;\n\t\t\t\t\tx = bounds.maxX + Math.atan(temp) * this._bounceRadius / PI_2;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (x < bounds.minX) { x = bounds.minX; }\n\t\t\t\tif (x > bounds.maxX) { x = bounds.maxX; }\n\t\t\t}\n\n\t\t\tif (x != style.x) {\n\t\t\t\tdelta.x = x - style.x;\n\t\t\t\tstyle.x = (x / this._snapPixels | 0) * this._snapPixels;\n\t\t\t}\n\t\t}\n\n\t\tif (typeof y == 'number') {\n\t\t\tif (this._isBouncing) {\n\t\t\t\t// do nothing\n\t\t\t} else if (this._canBounce) {\n\t\t\t\tif (y < bounds.minY) {\n\t\t\t\t\tvar temp = (bounds.minY - y) / this._bounceRadius;\n\t\t\t\t\ty = bounds.minY - Math.atan(temp) * this._bounceRadius / PI_2;\n\t\t\t\t}\n\n\t\t\t\tif (y > bounds.maxY) {\n\t\t\t\t\tvar temp = (y - bounds.maxY) / this._bounceRadius;\n\t\t\t\t\ty = bounds.maxY + Math.atan(temp) * this._bounceRadius / PI_2;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (y < bounds.minY) { y = bounds.minY; }\n\t\t\t\tif (y > bounds.maxY) { y = bounds.maxY; }\n\t\t\t}\n\n\t\t\tif (y != style.y) {\n\t\t\t\tdelta.y = y - style.y;\n\t\t\t\tstyle.y = (y / this._snapPixels | 0) * this._snapPixels;\n\t\t\t}\n\t\t}\n\n\t\tthis.publish('Scrolled', delta);\n\t};\n\n\tthis.isScrolling = function () { return this.isDragging() || this._anim && this._anim.hasFrames(); };\n\n\tthis.stopScrolling = function () {\n\t\tthis._anim && this._anim.now({}, 1);\n\t};\n\n\tthis.onInputStart = function (evt, pt) {\n\t\tif (this._opts.drag) {\n\t\t\tthis.startDrag({radius: this._opts.dragRadius * this._snapPixels});\n\n\t\t\tif (this._anim && this._anim.hasFrames()) {\n\t\t\t\tthis._anim.clear();\n\t\t\t}\n\n\t\t\tevt.cancel();\n\t\t}\n\t};\n\n\tthis.onDragStart = function (dragEvt) {\n\t\tinput.clearOverState(dragEvt.id);\n\n\t\tthis._contentView.getInput().blockEvents = true;\n\t\tthis._startBounce();\n\t\tthis._animState.offset = this.getOffset();\n\t\tthis._anim = animate(this._animState).clear();\n\t};\n\n\tthis.onDrag = function (dragEvt, moveEvt, delta) {\n\t\tvar state = this._animState;\n\t\tstate.dt = delta.t;\n\t\tstate.lastDelta = delta;\n\n\t\tif (!this._opts.scrollY) { delta.y = 0; }\n\t\tif (!this._opts.scrollX) { delta.x = 0; }\n\n\t\tthis.setOffset(state.offset.x += delta.x, state.offset.y += delta.y);\n\t\tmoveEvt.cancel();\n\t};\n\n\tthis.onDragStop = function (dragEvt, selectEvt) {\n\t\tthis._contentView.getInput().blockEvents = false;\n\n\t\tif (this._opts.inertia) {\n\t\t\tvar delta = new Point(this._animState.lastDelta).scale(this._acceleration);\n\t\t\tvar offset = this._animState.offset;\n\t\t\tvar distance = delta.getMagnitude();\n\n\t\t\t// if we overshot the bounds, don't waste time animating the acceleration.\n\t\t\tvar bounds = this.getStyleBounds();\n\t\t\tvar target = new Point(offset).add(delta);\n\t\t\tif (target.y < bounds.minY - this._bounceRadius) {\n\t\t\t\tif (offset.y < bounds.minY) {\n\t\t\t\t\tdistance = 0;\n\t\t\t\t} else {\n\t\t\t\t\tdelta.y += (bounds.minY - this._bounceRadius - target.y);\n\t\t\t\t\tdistance = delta.getMagnitude();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (target.y > bounds.maxY + this._bounceRadius) {\n\t\t\t\tif (offset.y > bounds.maxY) {\n\t\t\t\t\tdistance = 0;\n\t\t\t\t} else {\n\t\t\t\t\tdelta.y -= (target.y - (bounds.maxY - this._bounceRadius));\n\t\t\t\t\tdistance = delta.getMagnitude();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (target.x < bounds.minX - this._bounceRadius) {\n\t\t\t\tif (offset.x < bounds.minX) {\n\t\t\t\t\tdistance = 0;\n\t\t\t\t} else {\n\t\t\t\t\tdelta.x += (bounds.minX - this._bounceRadius - target.x);\n\t\t\t\t\tdistance = delta.getMagnitude();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (target.x > bounds.maxX + this._bounceRadius) {\n\t\t\t\tif (offset.x > bounds.maxX) {\n\t\t\t\t\tdistance = 0;\n\t\t\t\t} else {\n\t\t\t\t\tdelta.x -= (target.x - (bounds.maxY - this._bounceRadius));\n\t\t\t\t\tdistance = delta.getMagnitude();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (distance) {\n\t\t\t\tthis._anim.now(bind(this, function (tt, t) {\n\t\t\t\t\tthis.setOffset(\n\t\t\t\t\t\toffset.x + delta.x * tt,\n\t\t\t\t\t\toffset.y + delta.y * tt);\n\t\t\t\t}), 100 * Math.log((distance + 1) * 100), animate.easeOut).then(bind(this, function () {\n\t\t\t\t\tthis._endBounce(offset);\n\t\t\t\t}));\n\t\t\t} else {\n\t\t\t\tthis._endBounce(offset);\n\t\t\t}\n\t\t}\n\t};\n\n\t\n\tthis._startBounce = function () {\n\t\tthis._isBouncing = false;\n\t\tif (this._opts.inertia && this._opts.bounce) {\n\t\t\tthis._canBounce = true;\n\t\t}\n\t};\n\n\tthis._endBounce = function () {\n\t\tvar offset = this.getOffset();\n\t\tvar bounds = this.getStyleBounds();\n\n\t\tvar dx = 0;\n\t\tvar dy = 0;\n\n\t\tvar ty = offset.y, tx = offset.x;\n\t\tif (offset.y < bounds.minY) {\n\t\t\tty = bounds.minY;\n\t\t} else if (offset.y > bounds.maxY) {\n\t\t\tty = bounds.maxY;\n\t\t}\n\n\t\tif (offset.x < bounds.minX) {\n\t\t\ttx = bounds.minX;\n\t\t} else if (offset.x > bounds.maxX) {\n\t\t\ttx = bounds.maxX;\n\t\t}\n\n\t\tdy = ty - offset.y;\n\t\tdx = tx - offset.x;\n\n\t\tif (dy === 0 && dx === 0) { return; }\n\n\t\tthis._isBouncing = true;\n\t\tthis._anim.now(bind(this, function (tt, t) {\n\t\t\tthis.setOffset(\n\t\t\t\toffset.x + dx * tt,\n\t\t\t\toffset.y + dy * tt);\n\t\t}), 500, animate.easeInOut).then(bind(this, function () {\n\t\t\tthis._canBounce = false;\n\t\t\tthis._isBouncing = false;\n\n\t\t\t// Ensure that after the bounce an update to the bounds has not\n\t\t\t// been ignored.\n\t\t\tthis.scrollTo(undefined, undefined, 0);\n\t\t}));\n\t};\n\n\tthis.setScrollBounds = function (bounds) {\n\t\tif (bounds) {\n\t\t\tif ('minX' in bounds) { this._scrollBounds.minX = bounds.minX || 0; }\n\t\t\tif ('minY' in bounds) { this._scrollBounds.minY = bounds.minY || 0; }\n\t\t\tif ('maxX' in bounds) { this._scrollBounds.maxX = bounds.maxX || 0; }\n\t\t\tif ('maxY' in bounds) { this._scrollBounds.maxY = bounds.maxY || 0; }\n\n\t\t\t// If not in the middle of a bounce animation,\n\t\t\tif (!this._canBounce) {\n\t\t\t\t// Scroll to current position with duration 0. If the bounds have\n\t\t\t\t// changed, this will move the scroll position immediately to a valid\n\t\t\t\t// position.\n\t\t\t\tthis.scrollTo(undefined, undefined, 0);\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.getScrollBounds = function () { return this._scrollBounds; }\n\n\tthis.addOffset = function (x, y) {\n\t\tthis.setOffset(\n\t\t\t\tx != undefined && x != null && (this._contentView.style.x + x),\n\t\t\t\ty != undefined && y != null && (this._contentView.style.y + y)\n\t\t\t);\n\t}\n\t\n\tthis.getContentView = function () { return this._contentView; }\n\n\t/* @deprecated */\n\tthis.getFullWidth = function () { return this._contentView.style.width; }\n\t/* @deprecated */\n\tthis.getFullHeight= function () { return this._contentView.style.height; }\n\t\n\tfunction getBoundingRectangle(pos) {\n\t\tif (!pos.r) { return; }\n\n\t\tvar w = pos.width;\n\t\tvar h = pos.height;\n\t\tvar cr = Math.cos(pos.r);\n\t\tvar sr = Math.sin(pos.r);\n\n\t\tvar x1 = pos.x;\n\t\tvar y1 = pos.y;\n\n\t\tvar x = w;\n\t\tvar y = 0;\n\n\t\tvar x2 = x1 + x * cr - y * sr;\n\t\tvar y2 = y1 + x * sr + y * cr;\n\n\t\ty += h;\n\n\t\tvar x3 = x1 + x * cr - y * sr;\n\t\tvar y3 = y1 + x * sr + y * cr;\n\n\t\tx -= w;\n\n\t\tvar x4 = x1 + x * cr - y * sr;\n\t\tvar y4 = y1 + x * sr + y * cr;\n\n\t\tpos.x = Math.min(x1, x2, x3, x4);\n\t\tpos.y = Math.min(y1, y2, y3, y4);\n\n\t\tpos.width = Math.max(x1, x2, x3, x4) - pos.x;\n\t\tpos.height = Math.max(y1, y2, y3, y4) - pos.y;\n\t\tpos.r = 0;\n\t};\n\n\tfunction intersect(viewport, prevViewport) {\n\t\tvar pos = viewport.src.getPosition(prevViewport.src);\n\n\t\tpos.x = (prevViewport.x - pos.x) / pos.scale;\n\t\tpos.y = (prevViewport.y - pos.y) / pos.scale;\n\t\tpos.width = prevViewport.width / pos.scale;\n\t\tpos.height = prevViewport.height / pos.scale;\n\t\tpos.r = -pos.r;\n\n\t\tgetBoundingRectangle(pos);\n\n\t\tviewport.intersectRect(pos);\n\t};\n\n\tthis.render = function (ctx, opts) {\n\t\tvar s = this.style;\n\t\tvar cvs = this._contentView.style;\n\n\t\tvar viewport = this._viewport;\n\n\t\tvar x = viewport.x;\n\t\tvar y = viewport.y;\n\t\tvar width = viewport.width;\n\t\tvar height = viewport.height;\n\n\t\tviewport.x = -cvs.x;\n\t\tviewport.y = -cvs.y;\n\n\t\t// TODO: does flooring versus rounding hurt us?\n\t\t// NOTE: + 0.5 | 0 for rounding DOES NOT work for negative numbers\n\t\tviewport.width = s.width * s.scale | 0;\n\t\tviewport.height = s.height * s.scale | 0;\n\n\t\tif (opts.viewport) {\n\t\t\tintersect(viewport, opts.viewport);\n\t\t}\n\n\t\topts.viewport = viewport;\n\n\t\treturn viewport.x != x || viewport.y != y || viewport.width != width || viewport.height != height;\n\t};\n\n\tthis.onInputScroll = function (evt) {\n\t\tif (this._opts.scrollY && evt.scrollAxis == input.VERTICAL_AXIS) {\n\t\t\tthis.addOffset(undefined, evt.scrollDelta * 40);\n\t\t} else if (this._opts.scrollX) {\n\t\t\tthis.addOffset(evt.scrollDelta * 40);\n\t\t}\n\n\t\tevt.cancel();\n\t};\n\n\tthis.scrollTo = function (x, y, opts, cb) {\n\t\tvar bounds = this.getStyleBounds();\n\t\tvar cvs = this._contentView.style;\n\n\t\tx = (x == null) ? cvs.x : -x;\n\t\ty = (y == null) ? cvs.y : -y;\n\n\t\tx = x < bounds.minX ? bounds.minX : x;\n\t\tx = x > bounds.maxX ? bounds.maxX : x;\n\t\ty = y < bounds.minY ? bounds.minY : y;\n\t\ty = y > bounds.maxY ? bounds.maxY : y;\n\n\t\tvar duration;\n\t\tif (typeof opts == 'number') {\n\t\t\t// legacy api\n\t\t\tduration = opts;\n\t\t} else {\n\t\t\tif (opts.duration) {\n\t\t\t\tduration = opts.duration;\n\t\t\t} else if (opts.speed) {\n\t\t\t\tvar dx = x - cvs.x;\n\t\t\t\tvar dy = y - cvs.y;\n\t\t\t\tvar distance = Math.sqrt(dx * dx + dy * dy);\n\t\t\t\tduration = distance / opts.speed * 1000;\n\t\t\t} else {\n\t\t\t\tduration = 500;\n\t\t\t}\n\n\t\t\tif (opts.maxDuration) {\n\t\t\t\tduration = Math.min(duration, opts.maxDuration);\n\t\t\t}\n\t\t}\n\n\t\tif (duration) {\n\t\t\tvar anim = animate(this._contentView).now({ x: x, y: y }, duration, animate.easeOut);\n\t\t\tif (cb) {\n\t\t\t\tanim.then(cb);\n\t\t\t}\n\t\t} else {\n\t\t\tcvs.x = x;\n\t\t\tcvs.y = y;\n\t\t\tcb && cb();\n\t\t}\n\t};\n});\n","pre":true},"sdk/jsio/math/geom/Circle.js":{"path":"sdk/jsio/math/geom/Circle.js","friendlyPath":"math.geom.Circle","directory":"sdk/jsio/math/geom/","filename":"Circle.js","src":"jsio(\"import .Point\");\n\n/**\n * @extends math.geom.Point\n * Models a circle given a radius.\n *   Circle(x, y, radius)\n *   Circle({x: default 0, y: default 0, radius: default 0})\n */\nvar sdk_jsio_math_geom_Circle=__class__;exports=sdk_jsio_math_geom_Circle(function sdk_jsio_math_geom_Circle(){return this.init&&this.init.apply(this,arguments)},Point, function(supr) {\n\tthis.init = function(a, b, c) {\n\t\tswitch(arguments.length) {\n\t\t\tcase 0:\n\t\t\t\tthis.x = 0;\n\t\t\t\tthis.y = 0;\n\t\t\t\tthis.radius = 0;\n\t\t\t\tbreak;\n\t\t\tcase 1:\n\t\t\tcase 2:\n\t\t\t\tthis.x = a.x || 0;\n\t\t\t\tthis.y = a.y || 0;\n\t\t\t\tthis.radius = a.radius || 0;\n\t\t\t\tbreak;\n\t\t\tcase 3:\n\t\t\t\tthis.x = a;\n\t\t\t\tthis.y = b;\n\t\t\t\tthis.radius = c;\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\t/**\n\t * Scale the position and radius of this circle by a percentage.\n\t */\n\t\n\tthis.scale = function(s) {\n\t\tsupr(this, 'scale', arguments);\n\t\tthis.radius *= s;\n\t\treturn this;\n\t}\n});","pre":true},"sdk/gc/debugging/logProxy.js":{"path":"sdk/gc/debugging/logProxy.js","friendlyPath":".logProxy","directory":"sdk/gc/debugging/","filename":"logProxy.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n// this whole file should not get included in release\nif (DEBUG) {\n\tfunction stringify(value) {\n\t\tif (value === null) {\n\t\t\treturn 'null';\n\t\t} else if (typeof value == 'object') {\n\t\t\tif (isArray(value)) {\n\t\t\t\tvalue = value.slice(0);\n\t\t\t\tfor (var i = 0, n = value.length; i < n; ++i) {\n\t\t\t\t\tvalue[i] = stringify(value[i]);\n\t\t\t\t}\n\t\t\t\treturn '[' + value.join(', ') + ']';\n\t\t\t} else if (value.__class__) {\n\t\t\t\treturn '[object ' + value.__class__ + ']';\n\t\t\t} else {\n\t\t\t\treturn Object.prototype.toString.call(value);\n\t\t\t}\n\t\t} else {\n\t\t\treturn String(value);\n\t\t}\n\t}\n\n\tvar _logBuffer = [];\n\tvar _isInstalled = false;\n\tvar _isEnabled = true;\n\n\t// insert a hook into the js.io logging system so that calls to logger get routed over the network\n\texports.install = function (conn) {\n\t\tif (_isInstalled) { return; }\n\t\t_isInstalled = true;\n\n\t\tjsio(\"import base\");\n\n\t\tvar oldLog = base.log;\n\n\t\t// don't buffer logs if we haven't connected within 10 seconds\n\t\tvar timeout = setTimeout(function () { _isEnabled = false; }, 10000);\n\t\tconn.onConnect(function () {\n\t\t\tclearTimeout(timeout);\n\t\t\texports.flushBuffer();\n\t\t});\n\n\t\tvar isLocked = false;\n\t\tbase.log = function () {\n\t\t\tif (_isEnabled && !isLocked) {\n\t\t\t\tisLocked = true; // prevent recursive loops if sendEvent decides to log stuff\n\n\t\t\t\t// convert arguments to strings\n\t\t\t\tvar n = arguments.length;\n\t\t\t\tvar args = new Array(n);\n\t\t\t\tfor (var i = 0; i < n; ++i) {\n\t\t\t\t\targs[i] = stringify(arguments[i]);\n\t\t\t\t}\n\n\t\t\t\t// buffer log lines\n\t\t\t\tif (!conn || !conn.isConnected()) {\n\t\t\t\t\t_logBuffer.push(args);\n\t\t\t\t} else {\n\t\t\t\t\t// flush logs\n\t\t\t\t\tif (_logBuffer[0]) {\n\t\t\t\t\t\tfor (var i = 0, log; log = _logBuffer[i]; ++i) {\n\t\t\t\t\t\t\tconn.sendEvent('LOG', log);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t_logBuffer = [];\n\t\t\t\t\t}\n\n\t\t\t\t\t// send log\n\t\t\t\t\tconn.sendEvent('LOG', args);\n\t\t\t\t}\n\n\t\t\t\tisLocked = false;\n\t\t\t}\n\n\t\t\treturn oldLog.apply(this, arguments);\n\t\t};\n\t}\n\n\texports.flushBuffer = function () {\n\t\t// we timed out, so bail\n\t\tif (!_logBuffer) { return conn.close(); }\n\n\t\t// if we buffered log messages, send them\n\t\tvar n = _logBuffer.length;\n\t\tfor (var i = 0; i < n; ++i) {\n\t\t\tconn.sendEvent('LOG', _logBuffer[i]);\n\t\t}\n\n\t\t_logBuffer = [];\n\t}\n}\n","pre":true},"sdk/gc/debugging/remoteEval.js":{"path":"sdk/gc/debugging/remoteEval.js","friendlyPath":".remoteEval","directory":"sdk/gc/debugging/","filename":"remoteEval.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n// this whole file should not get included in release\nif (DEBUG) {\n\n\tvar _isInstalled = false;\n\n\texports.install = function (conn) {\n\t\tif (_isInstalled) { return; }\n\t\t_isInstalled = true;\n\n\t\tconn.onError = function (err) {\n\t\t\tlogger.log('log protocol error:', err);\n\t\t}\n\t\t\n\t\tconn.onConnect(function () {\n\t\t\tconn.sendEvent(\"HANDSHAKE\", {\n\t\t\t\t\"type\": jsio.__env.name,\n\t\t\t\t\"appID\": CONFIG.appID,\n\t\t\t\t\"version\": CONFIG.version,\n\t\t\t\t\"title\": CONFIG.title,\n\t\t\t\t\"shortName\": CONFIG.shortName,\n\t\t\t\t\"userAgent\": navigator.userAgent,\n\t\t\t\t\"device\": GLOBAL.NATIVE ? NATIVE.device : null\n\t\t\t});\n\n\t\t\tlogger.log('DEBUGGING CONNECTION MADE');\n\t\t});\n\n\t\tconn.onDisconnect(function () {\n\t\t\tlogger.log('DEBUGGING CONNECTION LOST');\n\t\t});\n\n\t\tconn.onRequest.subscribe('EVAL', this, function (req) {\n\t\t\ttry {\n\t\t\t\tvar value;\n\t\t\t\tif (GLOBAL.NATIVE && NATIVE.eval) {\n\t\t\t\t\tvalue = NATIVE.eval(req.args, \"[console]\");\n\t\t\t\t} else {\n\t\t\t\t\tvalue = window.eval(req.args, \"[console]\");\n\t\t\t\t}\n\n\t\t\t\treq.respond(stringify(value));\n\t\t\t} catch (e) {\n\t\t\t\treq.error(e.name + \": \" + e.message);\n\t\t\t}\n\t\t});\n\t}\n}\n","pre":true},"sdk/gc/debugging/TimestepInspector.js":{"path":"sdk/gc/debugging/TimestepInspector.js","friendlyPath":"..debugging.TimestepInspector","directory":"sdk/gc/debugging/","filename":"TimestepInspector.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n// this whole file should not get included in release\nif (DEBUG) {\n\tjsio(\"import device\");\n\tjsio(\"import math.geom.Point as Point\");\n\tjsio(\"import ui.resource.Image as Image\");\n\tjsio(\"import ui.ImageView as ImageView\");\n\n\tjsio(\"import .OverlayRenderer\");\n\n\t// mapping for reading/writing style properties on a view\n\t// map: inspector id -> style property\n\tvar _propMap = {\n\t\trelX: 'x',\n\t\trelY: 'y',\n\t\trelR: 'r',\n\t\trelWidthPercent: 'widthPercent',\n\t\trelHeightPercent: 'heightPercent',\n\t\trelWidth: 'width',\n\t\trelHeight: 'height',\n\t\trelScale: 'scale',\n\t\topacity: 'opacity',\n\t\tzIndex: 'zIndex',\n\t\tvisible: 'visible',\n\t\tanchorX: 'anchorX',\n\t\tanchorY: 'anchorY',\n\t\toffsetX: 'offsetX',\n\t\toffsetY: 'offsetY',\n\t\tclip: 'clip',\n\t\tlayout: 'layout',\n\t\tinLayout: 'inLayout',\n\t\ttop: 'top',\n\t\tleft: 'left',\n\t\tbottom: 'bottom',\n\t\tright: 'right',\n\t\tflex: 'flex',\n\t\tdirection: 'direction',\n\t\tjustifyContent: 'justifyContent',\n\t\torder: 'order',\n\n\t\tlayoutWidth: 'layoutWidth',\n\t\tlayoutHeight: 'layoutHeight',\n\t\tcenterX: 'centerX',\n\t\tcenterY: 'centerY',\n\t\tminWidth: 'minWidth',\n\t\tminHeight: 'minHeight',\n\t\tmaxWidth: 'maxWidth',\n\t\tmaxHeight: 'maxHeight',\n\t};\n\n\tvar dispatchWindowEvent = function(eventName) {\n\t\tvar e = document.createEvent('Event');\n\t\te.initEvent(eventName, true, true);\n\t\twindow.dispatchEvent(e);\n\t};\n\nvar sdk_gc_debugging_TimestepInspector=__class__;\texports=sdk_gc_debugging_TimestepInspector(function sdk_gc_debugging_TimestepInspector(){return this.init&&this.init.apply(this,arguments)},function () {\n\t\tthis.init = function (conn) {\n\t\t\tthis._overlay = new OverlayRenderer();\n\t\t};\n\n\t\tthis.setConn = function (conn) {\n\t\t\tthis._conn = conn;\n\n\t\t\tif (CONFIG.splash) {\n\t\t\t\tvar prevHide = CONFIG.splash.hide;\n\t\t\t\tCONFIG.splash.hide = bind(this, function () {\n\t\t\t\t\tprevHide && prevHide.apply(this, arguments);\n\t\t\t\t\tif (this._conn) {\n\t\t\t\t\t\tthis._conn.onConnect(this, function () {\n\t\t\t\t\t\t\tthis._conn.sendEvent('HIDE_LOADING_IMAGE');\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconn.onEvent.subscribe('BATCH', this, function (evt) {\n\t\t\t\tvar i;\n\t\t\t\tfor (i in evt.args) {\n\t\t\t\t\tconn.onEvent.publish(evt.args[i].name, evt.args[i].args);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tconn.onEvent.subscribe('SET_NAME', this, function (evt) {\n\t\t\t\tGLOBAL._name = evt.args.name;\n\t\t\t\tlogging.setPrefix(evt.args.name + ': ');\n\t\t\t});\n\n\t\t\tvar _homeScreen = false;\n\t\t\tconn.onEvent.subscribe('HOME_BUTTON', this, function () {\n\t\t\t\tif (!GC) return;\n\n\t\t\t\tvar app = GC.app;\n\n\t\t\t\tif (this._homeScreen) {\n\t\t\t\t\tdispatchWindowEvent('pageshow');\n\t\t\t\t\tapp.engine.resume();\n\t\t\t\t} else {\n\t\t\t\t\tdispatchWindowEvent('pagehide');\n\t\t\t\t\tapp.engine.pause();\n\n\t\t\t\t\tvar canvas = document.getElementsByTagName('canvas');\n\t\t\t\t\tif (canvas.length) {\n\t\t\t\t\t\tcanvas = canvas[0];\n\t\t\t\t\t\tif (canvas.getContext) {\n\t\t\t\t\t\t\tvar ctx = canvas.getContext('2d');\n\t\t\t\t\t\t\tctx.fillStyle = '#000000';\n\t\t\t\t\t\t\tctx.fillRect(0, 0, canvas.width, canvas.height);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis._homeScreen ^= true;\n\t\t\t});\n\n\t\t\tconn.onEvent.subscribe('BACK_BUTTON', this, function (evt) {\n\t\t\t\tGLOBAL.NATIVE.backButton.emit('pressed');\n\t\t\t});\n\n\t\t\tconn.onRequest.subscribe('SCREENSHOT', this, function (req) {\n\t\t\t\tvar canv = GC.app.engine.getElement();\n\t\t\t\tif (canv && canv.toDataURL) {\n\t\t\t\t\treq.respond({\n\t\t\t\t\t\twidth: canv.width,\n\t\t\t\t\t\theight: canv.height,\n\t\t\t\t\t\tcanvasImg: canv.toDataURL('image/png')\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\treq.error({\n\t\t\t\t\t\tNOT_SUPPORTED: true\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tconn.onEvent.subscribe('MUTE', this, function (evt) {\n\t\t\t\tGLOBAL.ACCESSIBILITY.mute(evt.args.shouldMute);\n\t\t\t});\n\n\t\t\tvar _paused = false;\n\t\t\tconn.onEvent.subscribe('PAUSE', this, function () {\n\t\t\t\tif (!GC) return;\n\t\t\t\tvar app = GC.app;\n\n\t\t\t\tif (_paused) {\n\t\t\t\t\tapp.engine.resume();\n\t\t\t\t\tthis._overlay.stopTick();\n\t\t\t\t} else {\n\t\t\t\t\tapp.engine.pause();\n\t\t\t\t\tthis._overlay.startTick();\n\t\t\t\t}\n\t\t\t\t_paused = !_paused;\n\t\t\t});\n\n\t\t\tconn.onEvent.subscribe('STEP', this, function () {\n\t\t\t\tif (!GC) return;\n\t\t\t\tvar app = GC.app;\n\n\t\t\t\tapp.engine.stepFrame();\n\t\t\t\t_paused = true;\n\t\t\t});\n\n\t\t\tvar _input = null;\n\t\t\tconn.onRequest.subscribe('ADD_MOUSE_EVT', this, function (req) {\n\t\t\t\tif (!_input) { _input = new DebugInputHandler(conn); }\n\t\t\t\treq.respond();\n\t\t\t});\n\n\t\t\tconn.onRequest.subscribe('REMOVE_MOUSE_EVT', this, function (req) {\n\t\t\t\tif (_input) { _input.destroy(); }\n\t\t\t\treq.respond();\n\t\t\t});\n\n\t\t\tconn.onEvent.subscribe('SET_HIGHLIGHT', this, function (req) {\n\t\t\t\tthis._overlay.setHighlight(req.args.uid);\n\t\t\t\t//this._overlay.render();\n\t\t\t});\n\n\t\t\tconn.onEvent.subscribe('SET_SELECTED', this, function (req) {\n\t\t\t\tthis._overlay.setSelected(req.args.uid);\n\t\t\t\t//this._overlay.render();\n\t\t\t});\n\n\t\t\tfunction findBetterTag (view) {\n\t\t\t\tvar parent = view.getSuperview();\n\t\t\t\tfor (var key in parent) {\n\t\t\t\t\tif (parent[key] === view) {\n\t\t\t\t\t\treturn key;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tconn.onRequest.subscribe('GET_ROOT_UID', this, function (req) {\n\t\t\t\treq.respond({uid: GC.app.uid});\n\t\t\t});\n\n\t\t\tconn.onRequest.subscribe('GET_VIEW', this, function (req) {\n\t\t\t\tvar view = _DEBUG.getViewByID(req.args.uid);\n\t\t\t\tif (!view) {\n\t\t\t\t\treq.error('no view with id' + req.args.uid, {VIEW_NOT_FOUND: true});\n\t\t\t\t} else {\n\t\t\t\t\tvar sup = view.getSuperview();\n\n\t\t\t\t\t//create the optimal tag\n\t\t\t\t\tvar tag = view.getTag && view.getTag() || view.toString();\n\t\t\t\t\tvar betterTag = findBetterTag(view);\n\t\t\t\t\tif (betterTag) tag = betterTag + \":\" + tag;\n\n\t\t\t\t\treq.respond({\n\t\t\t\t\t\tuid: view.uid,\n\t\t\t\t\t\tsuperviewID: sup && sup.uid,\n\t\t\t\t\t\ttag: tag,\n\t\t\t\t\t\tsubviewIDs: view.getSubviews().map(function (view) { return view.uid; })\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tconn.onRequest.subscribe('REPLACE_IMAGE', this, function (req) {\n\t\t\t\tvar args = req.args;\n\t\t\t\tvar imgData = args.imgData;\n\t\t\t\tvar uid = args.uid;\n\n\t\t\t\tvar view = _DEBUG.getViewByID(uid);\n\t\t\t\tvar newImg = new Image();\n\n\t\t\t\tnewImg._srcImg.addEventListener(\"load\", function () {\n\t\t\t\t\tvar map = newImg._map;\n\t\t\t\t\tmap.width = newImg._srcImg.width,\n\t\t\t\t\tmap.height = newImg._srcImg.height,\n\t\t\t\t\tmap.x = 0;\n\t\t\t\t\tmap.y = 0;\n\t\t\t\t\tview.setImage(newImg);\n\t\t\t\t\tview.needsRepaint();\n\t\t\t\t}, false);\n\n\t\t\t\tnewImg._srcImg.src = imgData;\n\t\t\t});\n\n\t\t\tconn.onRequest.subscribe('GET_VIEW_PROPS', this, function (req) {\n\t\t\t\tvar args = req.args;\n\t\t\t\tvar view = _DEBUG.getViewByID(args.uid);\n\t\t\t\tif (!view) {\n\t\t\t\t\treturn req.error(\"VIEW_NOT_FOUND\");\n\t\t\t\t}\n\n\t\t\t\tvar s = view.style;\n\t\t\t\tvar p = view.getPosition();\n\t\t\t\tvar layout = view.__layout;\n\t\t\t\tvar ret = {};\n\t\t\t\tfor (var key in _propMap) {\n\t\t\t\t\tret[key] = s[_propMap[key]];\n\t\t\t\t}\n\n\t\t\t\tmerge(ret, {\n\t\t\t\t\tabsX: p.x,\n\t\t\t\t\tabsY: p.y,\n\t\t\t\t\tabsR: p.r,\n\t\t\t\t\tabsWidth: p.width,\n\t\t\t\t\tabsHeight: p.height,\n\t\t\t\t\tabsScale: p.scale,\n\n\t\t\t\t\tsubviews: layout && (typeof layout.getSubviews == 'function') && layout.getSubviews().length,\n\t\t\t\t\tdirection: layout && (typeof layout.getDirection == 'function') && layout.getDirection(),\n\t\t\t\t\tpadding: s.padding && s.padding.toString()\n\t\t\t\t});\n\n\t\t\t\tfor (var key in ret) {\n\t\t\t\t\tif (ret[key] == undefined) {\n\t\t\t\t\t\tret[key] = '-';\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tret.isImageView = view instanceof ImageView;\n\n\t\t\t\tif (ret.isImageView) {\n\t\t\t\t\tret.imagePath = view._opts.image || (view._img && view._img._map && view._img._map.url);\n\t\t\t\t\tif (ret.imagePath && ret.imagePath._map) {\n\t\t\t\t\t\tret.imagePath = ret.imagePath._map.url;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tret.uuid = args.uid;\n\n\t\t\t\tret.description = (view.constructor.name || 'View') + ' ' + args.uid + '\\n' + view.getTag();\n\n\t\t\t\treq.respond(ret);\n\t\t\t});\n\n\t\t\tconn.onRequest.subscribe('SET_VIEW_PROP', this, function (req) {\n\t\t\t\tvar args = req.args;\n\t\t\t\tvar view = _DEBUG.getViewByID(args.uid);\n\t\t\t\tif (!view) {\n\t\t\t\t\treturn req.error(\"VIEW_NOT_FOUND\");\n\t\t\t\t}\n\n\t\t\t\tvar key = args.key;\n\t\t\t\tvar value = args.value;\n\t\t\t\tif (key in _propMap) {\n\t\t\t\t\tview.style[_propMap[key]] = value;\n\t\t\t\t} else {\n\t\t\t\t\tswitch (key) {\n\t\t\t\t\t\tcase 'absX': break;\n\t\t\t\t\t\tcase 'absY': view.style.y = value; break;\n\t\t\t\t\t\tcase 'absWidth': view.style.width = value; break;\n\t\t\t\t\t\tcase 'absHeight': view.style.height = value; break;\n\t\t\t\t\t\tcase 'absScale': view.style.scale = value; break;\n\t\t\t\t\t\tcase 'padding': view.style.padding = value; break;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tvar _pollTimer = null;\n\t\t\tvar _pollView = null;\n\n\t\t\tconn.onEvent.subscribe('POLL_VIEW_POSITION', this, function (evt) {\n\n\t\t\t\tfunction poll() {\n\t\t\t\t\tif (_pollView) {\n\t\t\t\t\t\tvar eventData = _pollView.getPosition();\n\t\t\t\t\t\teventData.uid = _pollView.uid;\n\n\t\t\t\t\t\tconn.sendEvent('POLL_VIEW_POSITION', eventData);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t_pollView = _DEBUG.getViewByID(evt.args.uid);\n\t\t\t\tif (!_pollTimer && _pollView) {\n\t\t\t\t\t_pollTimer = setInterval(poll, 100);\n\t\t\t\t}\n\n\t\t\t\tif (!_pollView) {\n\t\t\t\t\tclearInterval(poll);\n\t\t\t\t\t_pollTimer = null;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tthis.setApp = function (app) {\n\t\t\tthis._conn.sendEvent('APP_READY', {uid: app.view.uid});\n\t\t\tapp.engine.unsubscribe('Render', this);\n\t\t\tapp.engine.subscribe('Render', this._overlay, 'render');\n\t\t}\n\t});\n\n\nDebugInputHandler=__class__;\tvar DebugInputHandler=DebugInputHandler(function DebugInputHandler(){return this.init&&this.init.apply(this,arguments)},function () {\n\n\t\tjsio(\"import device\");\n\t\tvar _simulateMouseMove = device.simulating && document.body.addEventListener;\n\n\t\tthis.init = function (conn) {\n\t\t\tthis.conn = conn;\n\t\t\tthis.onMouseMoveCapture = bind(this, this.onMouseMoveCapture);\n\t\t\tthis.setShiftDown = bind(this, this.setShiftDown);\n\t\t\tthis.onContextMenu = bind(this, this.onContextMenu);\n\n\t\t\tif (_simulateMouseMove) {\n\t\t\t\twindow.addEventListener('mousemove', this.onMouseMoveCapture, true);\n\n\t\t\t}\n\n\t\t\t//exports._overlay.setSize(GC.app.view.style.width, GC.app.view.style.height);\n\n\t\t\t//hacky hack to determine if the shift was set or not\n\t\t\twindow.addEventListener('mousedown', this.setShiftDown, true);\n\t\t\twindow.addEventListener('contextmenu', this.onContextMenu, true);\n\n\t\t\tGC.app.view.subscribe('InputMoveCapture', this, 'onInputMoveCapture');\n\t\t\t//GC.app.view.subscribe('InputStartCapture', this, 'onInputSelectCapture');\n\t\t}\n\n\t\tthis.setShiftDown = function (e) {\n\t\t\tif (e.which === 3 || e.button === 2) {\n\t\t\t\te.stopPropagation();\n\t\t\t\te.preventDefault();\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tthis._shiftDown = !!e.shiftKey;\n\n\t\t\tif (this._shiftDown) {\n\t\t\t\tthis.onInputSelectCapture(e);\n\t\t\t\te.stopPropagation();\n\t\t\t\te.preventDefault();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tjsio(\"import event.input.dispatch as dispatch\");\n\n\t\tthis.onContextMenu = function (e) {\n\t\t\tvar data = {\n\t\t\t\tpt: {x: e.pageX, y: e.pageY}\n\t\t\t};\n\n\t\t\t//get the views under the pointer\n\t\t\tvar clickEvt = {pt: [], trace: [], depth: 0};\n\t\t\tvar clickPt = new Point(e.pageX, e.pageY);\n\t\t\tdispatch.traceEvt(GC.app.view, clickEvt, clickPt);\n\n\t\t\tif (!clickEvt.trace.length) return;\n\t\t\tdata.active = clickEvt.trace[0].uid;\n\n\t\t\t//get the views under the pointer\n\t\t\tvar mockEvt = {pt: [], trace: [], depth: 0};\n\t\t\tvar mockPt = new Point(e.pageX, e.pageY);\n\n\t\t\tthis.traceEvt(GC.app.view, mockEvt, mockPt);\n\n\t\t\tdata.trace = [];\n\t\t\t//convert to small objects\n\t\t\tfor (var i = mockEvt.trace.length - 1, item; item = mockEvt.trace[i]; --i) {\n\t\t\t\tdata.trace.push({\n\t\t\t\t\tuid: item.view.uid,\n\t\t\t\t\ttag: item.view.getTag(),\n\t\t\t\t\tdepth: item.depth\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthis.conn.sendEvent('INPUT_TRACE', data);\n\n\t\t\te.stopPropagation();\n\t\t\te.preventDefault();\n\t\t\treturn false;\n\t\t}\n\n\t\tthis.destroy = function () {\n\t\t\tif (_simulateMouseMove) {\n\t\t\t\twindow.removeEventListener('mousedown', this.onMouseDownCapture, true);\n\t\t\t}\n\n\t\t\twindow.removeEventListener('mousedown', this.setShiftDown, true);\n\t\t\tGC.app.view.unsubscribe('InputMoveCapture', this, 'onInputMoveCapture');\n\t\t\t//GC.app.view.unsubscribe('InputStartCapture', this, 'onInputSelectCapture');\n\t\t}\n\n\t\tthis.onInputMoveCapture = function (evt, pt, allEvt, allPt) {\n\t\t\tvar trace = [];\n\n\t\t\t//loop backwards through the trace\n\t\t\tfor (var i = evt.trace.length - 1, view; view = evt.trace[i]; --i) {\n\t\t\t\ttrace.push(view.uid);\n\n\t\t\t\tvar superview = view.getSuperview();\n\t\t\t\twhile (superview && superview != evt.trace[i + 1]) {\n\t\t\t\t\ttrace.push(superview.uid);\n\t\t\t\t\tsuperview = superview.getSuperview();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tvar data = {\n\t\t\t\tx: pt.x,\n\t\t\t\ty: pt.y,\n\t\t\t\ttrace: trace\n\t\t\t};\n\n\t\t\tthis.conn.sendEvent('INPUT_MOVE', data);\n\t\t}\n\n\t\tthis.onInputSelectCapture = function (e) {\n\t\t\t//only send event if shift click\n\n\n\t\t\tvar evt = {pt: [], trace: [], depth: 0};\n\t\t\tvar pt = new Point(e.pageX, e.pageY);\n\t\t\tdispatch.traceEvt(GC.app.view, evt, pt);\n\n\t\t\tvar trace = [];\n\t\t\tfor (var i = evt.trace.length - 1, view; view = evt.trace[i]; --i) {\n\t\t\t\ttrace.push(view.uid);\n\n\t\t\t\tvar superview = view.getSuperview();\n\t\t\t\twhile (superview && superview != evt.trace[i + 1]) {\n\t\t\t\t\ttrace.push(superview.uid);\n\t\t\t\t\tsuperview = superview.getSuperview();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tvar data = {\n\t\t\t\tx: pt.x,\n\t\t\t\ty: pt.y,\n\t\t\t\ttrace: trace\n\t\t\t};\n\n\t\t\tthis.conn.sendEvent('INPUT_SELECT', data);\n\t\t}\n\n\t\tthis.traceEvt = function (view, evt, pt, depth) {\n\t\t\tdepth = depth || 0;\n\n\t\t\tvar localPt = view.style.localizePoint(new Point(pt));\n\n\t\t\t//if the point is contained add it to the trace\n\t\t\tif (view.containsLocalPoint(localPt)) {\n\t\t\t\tevt.trace.unshift({view: view, depth: depth});\n\t\t\t\tevt.pt[view.uid] = localPt;\n\t\t\t}\n\n\t\t\tvar subviews = view.getSubviews();\n\t\t\tfor (var i = subviews.length - 1; i >= 0; --i) {\n\t\t\t\tif (subviews[i].style.visible) {\n\t\t\t\t\t\tthis.traceEvt(subviews[i], evt, localPt, depth + 1);\n\t\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (subviews.length === 0) {\n\t\t\t\tevt.target = view;\n\t\t\t\treturn true;\n\t\t\t}\n\t\t};\n\n\t\tthis.onMouseMoveCapture = function (e) {\n\t\t\t//$.stopEvent(e);\n\n\t\t\t//get the event to the active target\n\t\t\tvar mockEvt = {pt: [], trace: [], depth: 0};\n\t\t\tvar mockPt = new Point(e.pageX, e.pageY);\n\t\t\tdispatch.traceEvt(GC.app.view, mockEvt, mockPt);\n\n\t\t\tthis.onInputMoveCapture(mockEvt, mockPt);\n\t\t}\n\t});\n}\n","pre":true},"sdk/gc/debugging/OverlayRenderer.js":{"path":"sdk/gc/debugging/OverlayRenderer.js","friendlyPath":".OverlayRenderer","directory":"sdk/gc/debugging/","filename":"OverlayRenderer.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n// this whole file should not get included in release\nif (DEBUG) {\n\tjsio(\"import device\");\n\nvar sdk_gc_debugging_OverlayRenderer=__class__;\tvar OverlayRenderer = exports=sdk_gc_debugging_OverlayRenderer(function sdk_gc_debugging_OverlayRenderer(){return this.init&&this.init.apply(this,arguments)},function () {\n\t\t\n\t\t// store the views we need to render\n\t\tthis._highlightViewUID = null;\n\t\tthis.setHighlight = function (uid) { this._highlightViewUID = uid; }\n\n\t\tthis._selectedViewUID = null;\n\t\tthis.setSelected = function (uid) { this._selectedViewUID = uid; }\n\n\t\tvar tick = 0;\n\t\tvar maxColor = 255;\n\t\tvar minColor = 100;\n\n\t\t//render the highlighted view\n\t\tvar _now = +new Date();\n\t\tvar _t = 0;\n\t\tfunction renderHighlight (pos, ctx) {\n\t\t\tif (!ctx) { return; }\n\t\t\tctx.save();\n\t\t\tctx.translate(pos.x, pos.y);\n\t\t\tctx.rotate(pos.r);\n\n\t\t\t// pulsate the blue\n\t\t\ttick += -(_now - (_now = new Date()));\n\n\t\t\tvar weight = (Math.sin(2 * Math.PI * tick / 1000) + 1) / 2;\n\t\t\tvar val = (weight * (maxColor - minColor)) + minColor | 0;\n\n\n\t\t\tvar color = '0,' + (val * .7 | 0) + ',' + (val | 0);\n\n\t\t\tctx.strokeStyle = 'rgba(' + color + ', 0.7)';\n\t\t\tctx.strokeRect(0, 0, pos.width, pos.height);\n\t\t\tctx.fillStyle = 'rgba(' + color + ', 0.6)';\n\t\t\tctx.fillRect(0, 0, pos.width, pos.height);\n\n\t\t\t//draw the cross hair\n\t\t\t//ctx.fillStyle = 'rgb(' + val + ',' + val + ',' + val +')';\n\t\t\tvar opacity = weight * (1 - 0.4) + 0.4;\n\t\t\tctx.fillStyle = 'rgba(255,255,255,' + (opacity.toFixed(2)) +')';\n\t\t\tctx.translate(pos.anchorX, pos.anchorY);\n\t\t\tctx.rotate(tick / 500);\n\n\t\t\tctx.fillRect(-0.5, -7, 1, 14);\n\t\t\tctx.fillRect(-7, -0.5, 14, 1);\n\n\t\t\tctx.restore();\n\t\t};\n\n\t\tfunction renderSelected (pos, ctx) {\n\t\t\tif (!ctx) { return; }\n\n\t\t\tctx.save();\n\t\t\tctx.translate(pos.x, pos.y);\n\t\t\tctx.rotate(pos.r);\n\t\t\tctx.strokeStyle = \"red\";\n\t\t\tctx.lineWidth = 1;\n\t\t\tctx.strokeRect(-0.5, -0.5, pos.width + 1, pos.height + 1);\n\t\t\tctx.restore();\n\t\t};\n\n\t\tif (!device.isMobile) {\n\t\t\tvar element = document.createElement('x');\n\t\t\tvar documentElement = document.documentElement;\n\t\t\tvar getComputedStyle = window.getComputedStyle;\n\t\t\tvar supportsPointerEvents = false;\n\t\t\tif (element && ('pointerEvents' in element.style)) {\n\t\t\t\telement.style.pointerEvents = 'auto';\n\t\t\t\telement.style.pointerEvents = 'x';\n\t\t\t\tdocumentElement.appendChild(element);\n\t\t\t\tsupportsPointerEvents = getComputedStyle && getComputedStyle(element, '').pointerEvents === 'auto';\n\t\t\t\tdocumentElement.removeChild(element);\n\t\t\t}\n\n\t\t\tif (device.simulating && document.body && document.body.appendChild && supportsPointerEvents) {\n\t\t\t\tvar canvas = new (device.get('Canvas'))();\n\t\t\t\tcanvas.style.cssText = 'position: absolute; left: 0; top: 0; z-index: 1000; pointer-events: none;';\n\t\t\t\tdocument.body.appendChild(canvas);\n\n\t\t\t\tthis.constructor.ctx = canvas.getContext('2d');\n\t\t\t}\n\t\t}\n\n\t\t// used to drive renderer separately when app is paused\n\t\tthis.startTick = function () {\n\t\t\tthis.stopTick();\n\t\t\tthis._tick = setInterval(bind(this, 'render'), 1000 / 30);\n\t\t};\n\n\t\t// used to stop renderer's timer when app is unpaused\n\t\tthis.stopTick = function () {\n\t\t\tif (this._tick) {\n\t\t\t\tclearInterval(this._tick);\n\t\t\t}\n\t\t};\n\n\t\tthis.setEnabled = function (isEnabled) {\n\t\t\tthis._isEnabled = isEnabled;\n\t\t\tif (OverlayRenderer.ctx) {\n\t\t\t\tOverlayRenderer.ctx.clear();\n\t\t\t}\n\t\t};\n\n\t\tthis.render = function (ctx) {\n\t\t\tif (!ctx) { return; }\n\t\t\t// if (!this._isEnabled) { return; }\n\n\t\t\t// on simulated devices, we have our own canvas\n\t\t\t// so size it to fit the screen (clearing it too)\n\t\t\tif (OverlayRenderer.ctx) {\n\t\t\t\tctx = OverlayRenderer.ctx;\n\t\t\t\tctx.canvas.width = device.screen.width;\n\t\t\t\tctx.canvas.height = device.screen.height;\n\t\t\t}\n\n\t\t\t// render highlighted views\n\t\t\tif (this._highlightViewUID !== null) {\n\t\t\t\tvar view = _DEBUG.getViewByID(this._highlightViewUID);\n\t\t\t\tvar pos = view && view.getPosition();\n\t\t\t\tif (pos) renderHighlight(pos, ctx);\n\t\t\t}\n\n\t\t\t// render selected views\n\t\t\tif (this._selectedViewUID !== null) {\n\t\t\t\tvar view = _DEBUG.getViewByID(this._selectedViewUID);\n\t\t\t\tvar pos = view && view.getPosition();\n\t\t\t\tif (pos) renderSelected(pos, ctx);\n\t\t\t}\n\t\t};\n\t});\n}\n\n","pre":true},"sdk/gc/API.js":{"path":"sdk/gc/API.js","friendlyPath":"gc.API","directory":"sdk/gc/","filename":"API.js","src":"/** @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n// Import this before importing GC\n// _api.client.init sets up the GC object for the client apis\n\njsio(\"import lib.PubSub\");\njsio(\"import lib.Callback\");\njsio(\"import std.uri as URI\");\njsio(\"import ui.Engine\");\njsio(\"import ui.View\");\njsio(\"import ui.StackView\");\n\njsio(\"import device\");\n\nif (device.simulatingMobileNative) {\n\tjsio('import .debugging.nativeShim');\n}\n\nif (!GLOBAL.CONFIG) { GLOBAL.CONFIG = {}; }\nif (!GLOBAL.DEBUG) { GLOBAL.DEBUG = false; }\n\nif (GLOBAL.CONFIG.isMuted) {\n\tjsio(\"import AudioManager\");\n\tGLOBAL.ACCESSIBILITY.mute(true);\n}\n\nvar sdk_gc_API=__class__;exports=sdk_gc_API(function sdk_gc_API(){return this.init&&this.init.apply(this,arguments)},lib.PubSub, function () {\n\n\tvar ua = navigator.userAgent;\n\tthis.isNative = /TeaLeaf/.test(ua);\n\tif (this.isNative) {\n\t\tthis.isIOS = /iPhone OS/.test(ua);\n\t\tthis.isAndroid = /Android/.test(ua);\n\t} else if (/(iPod|iPhone|iPad)/i.test(ua)) {\n\t\tthis.isMobileBrowser = true;\n\t\tthis.isIOS = true;\n\t\tthis.isUIWebView = !/Safari/.test(ua);\n\t} else if (/Android/.test(ua)) {\n\t\tthis.isMobileBrowser = true;\n\t\tthis.isAndroid = true;\n\t} else {\n\t\tthis.isDesktop = true;\n\t\tthis.isFacebook = GLOBAL.CONFIG.isFacebookApp;\n\t}\n\n\tthis.init = function (opts) {\n\t\tif (GLOBAL.ADDON_SOCIAL && ADDON_SOCIAL) {\n\t\t\tjsio(\"import GCSocial.GCSocial\", {suppressErrors: true});\n\t\t\tthis.social = GCSocial.GCSocial;\n\t\t\t\n\t\t\tGLOBAL.gcsocial = this.social; // deprecated\n\n\t\t\tthis.social.init({\n\t\t\t\tappID: GLOBAL.CONFIG.appID,\n\t\t\t\tshortName: GLOBAL.CONFIG.shortName,\n\t\t\t\tinviteURLTemplate: GLOBAL.CONFIG.inviteURLTemplate,\n\t\t\t\tendpoint: GLOBAL.CONFIG.servicesURL,\n\t\t\t});\n\n\t\t\tthis.track = gcsocial.tracker;\n\t\t}\n\n\t\twindow.addEventListener('pageshow', bind(this, '_onShow'), false);\n\n\t\twindow.addEventListener('pagehide', bind(this, '_onHide'), false);\n\n\t\tthis.isOnline = navigator.onLine;\n\n\t\twindow.addEventListener('online', bind(this, function () {\n\t\t\tif (!this.isOnline) {\n\t\t\t\tthis.isOnline = true;\n\t\t\t\tthis.publish('OnlineStateChanged', true);\n\t\t\t}\n\t\t}), false);\n\n\t\twindow.addEventListener('offline', bind(this, function () {\n\t\t\tif (this.isOnline) {\n\t\t\t\tthis.isOnline = false;\n\t\t\t\tthis.publish('OnlineStateChanged', false);\n\t\t\t}\n\t\t}), false);\n\n\t\t// var uri = new URI(window.location);\n\t\t// var campaign = uri.query('campaign') || \"NO CAMPAIGN\";\n\t\t//\n\t\t// XXX: The following lines cause a DOMException in some browsers\n\t\t// because we're using a <base> tag, which doesn't resolve the URL relative correctly.\n\t\t//get rid of it in case the game uses something\n\t\t// if (window.history && window.history.replaceState) {\n\t\t// \thistory.replaceState(null, null, uri.toString().replace(\"?campaign=\" + campaign, \"\"));\n\t\t// }\n\t\t//\n\t\t// if (!localStorage.getItem(\"campaignID\")) {\n\t\t// \tlocalStorage.setItem(\"campaignID\", campaign)\n\t\t// }\n\n\n\t\tif (CONFIG.version) {\n\t\t\tlogger.log('Version', CONFIG.version);\n\t\t}\n\t}\n\n\tGLOBAL.GC = new this.constructor();\n\n\tjsio(\"import .PluginManager\");\n\tthis.plugins = new PluginManager();\n\n\tGC.Application = ui.StackView;\n\n\t// this.track({\n\t// \tname: \"campaignID\",\n\t// \tcategory: \"campaign\",\n\t// \tsubcategory: \"id\",\n\t// \tdata: campaign\n\t// });\n\n\tjsio(\"import .UI\");\n\tGC.ui = new UI();\n\n\t// import .OverlayAPI;\n\t// GC.overlay = new OverlayAPI(this.env);\n\t\n\tvar map;\n\n\ttry {\n\t\tif (GLOBAL.CACHE) {\n\t\t\tmap = JSON.parse(GLOBAL.CACHE['spritesheets/map.json']);\n\t\t}\n\t} catch (e) {\n\t\tlogger.warn(\"spritesheet map failed to parse\", e);\n\t}\n\t\t\n\tjsio(\"import ui.resource.loader\");\n\tGC.resources = ui.resource.loader;\n\tGC.resources.setMap(map);\n\n\tif (GC.env == 'browser') { setTimeout(bind(this, '_onShow'), 0); }\n\n\tthis._onHide = function () {\n\t\t// signal to the app that the window is going away\n\t\tthis.app && this.app.onPause && this.app.onPause();\n\n\t\tthis.publish('Hide');\n\t\tthis.publish('AfterHide');\n\n\t\tif (this.tracker) {\n\t\t\tthis.tracker.endSession();\n\t\t}\n\t};\n\n\tthis._onShow = function () {\n\t\tthis.app && this.app.onResume && this.app.onResume();\n\n\t\tthis.publish('Show');\n\t\tthis.publish('AfterShow');\n\t}\n\n\tthis.buildApp = function (entry) {\n\t\tjsio(\"import src.Application as Application\");\n\n\t\tApplication.prototype.__root = true;\n\t\tthis.app = new Application();\n\t\tthis.buildEngine(merge({view: this.app}, this.app._settings));\n\t\treturn this.app;\n\t}\n\n\tthis.buildEngine = function (opts) {\n\t\tif (!opts) { opts = {}; }\n\t\tif (!opts.entry) { opts.entry = 'launchUI'; }\n\n\t\tvar view = opts.view;\n\t\tif (!view) {\n\t\t\tthrow \"a timestep.Engine must be created with a root view\";\n\t\t}\n\n\t\tif (!(view instanceof ui.View)) {\n\t\t\tthrow \"src/Application.js must export a Class that inherits from ui.View\";\n\t\t}\n\n\t\tview.subscribe('onLoadError', this, '_onAppLoadError');\n\n\t\tvar launch;\n\t\tif (typeof view[opts.entry] == 'function') {\n\t\t\tlaunch = bind(view, opts.entry);\n\t\t}\n\n\t\tview.view = view; // legacy, deprecated\n\t\tview.engine = new ui.Engine(opts);\n\t\tview.engine.show();\n\t\tview.engine.startLoop();\n\n\t\tview.initUI && view.initUI();\n\n\t\tvar settings = view._settings || {};\n\t\tvar preload = settings.preload;\n\t\tvar autoHide = CONFIG.splash && (CONFIG.splash.autoHide !== false);\n\t\tif (preload && preload.length) {\n\t\t\tvar cb = new lib.Callback();\n\t\t\tfor (var i = 0, group; group = preload[i]; ++i) {\n\t\t\t\tGC.resources.preload(group, cb.chain());\n\t\t\t}\n\n\t\t\t// note that hidePreloader takes a null cb argument to avoid\n\t\t\t// forwarding the preloader result as the callback\n\t\t\tif (autoHide) { cb.run(GC, 'hidePreloader', null); }\n\t\t\tif (launch) { cb.run(launch); }\n\t\t} else {\n\t\t\tif (autoHide) { GC.hidePreloader(); }\n\t\t\tlaunch && launch();\n\t\t}\n\t};\n\n\tthis._onAppLoadError = function (error) {\n\t\tlogger.error('encountered error when creating src Application: ', JSON.stringify(error));\n\t\tvar splash = CONFIG.splash;\n\t\tif (splash && splash.onAppLoadError) {\n\t\t\tsplash.onAppLoadError(error);\n\t\t}\n\t};\n\n\tthis.hidePreloader = function (cb) {\n\t\tvar splash = CONFIG.splash;\n\t\tif (splash && splash.hide && !splash.hidden) {\n\t\t\tsplash.hide(cb);\n\t\t\tsplash.hidden = true;\n\t\t} else {\n\t\t\tcb && cb();\n\t\t}\n\t};\n});","pre":true},"sdk/gc/PluginManager.js":{"path":"sdk/gc/PluginManager.js","friendlyPath":".PluginManager","directory":"sdk/gc/","filename":"PluginManager.js","src":"var sdk_gc_PluginManager=__class__;exports=sdk_gc_PluginManager(function sdk_gc_PluginManager(){return this.init&&this.init.apply(this,arguments)},function () {\n\tthis.init = function () {\n\t\tthis._plugins = {};\n\t}\n\n\tthis.register = function (name, plugin) {\n\t\tthis._plugins[name] = plugin;\n\t}\n\n\tthis.getPlugin = function (name) {\n\t\treturn this._plugins[name];\n\t}\n});\n","pre":true},"sdk/gc/UI.js":{"path":"sdk/gc/UI.js","friendlyPath":".UI","directory":"sdk/gc/","filename":"UI.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\njsio(\"from util.browser import $\");\njsio(\"import std.uri\");\njsio(\"import std.js as JS\");\njsio(\"import lib.Iterator\");\njsio(\"import lib.Callback\");\njsio(\"import device\");\njsio(\"import ui.widget.Spinner as Spinner\"); \n\nvar config = window.CONFIG;\n\nlogger.log(\"ITS \", GLOBAL.HTMLCanvasElement);\nvar uiExports = {\n\tGCView: function () {\n\t\tjsio(\"import ui.View\");\n\t\treturn ui.View;\n\t},\n\tGCImage: function () {\n\t\tjsio(\"import ui.resource.Image\");\n\t\treturn ui.resource.Image;\n\t},\n\tGCImageView: function () {\n\t\tjsio(\"import ui.ImageView\");\n\t\treturn ui.ImageView;\n\t},\n\tGCCanvas: getCanvasCtor,\n\tGCSprite: function () {\n\t\tjsio(\"import ui.SpriteView\");\n\t\treturn ui.SpriteView;\n\t},\n\tGCResources: function () { // deprecated\n\t\tjsio(\"import ui.resource.loader\");\n\t\treturn ui.resource.loader;\n\t}\n};\n\nvar sdk_gc_UI=__class__;exports=sdk_gc_UI(function sdk_gc_UI(){return this.init&&this.init.apply(this,arguments)},function () {\n\tvar loader = null;\n\tthis.cssFile = function (path, cb) {\n\t\t//if (!loader) { loader = jsio('import squill.cssLoad'); }\n\n\t\t// load from cache\n\t\tvar textContent = CACHE[path];\n\t\tif (textContent) {\n\t\t\t$({tag: 'style', text: textContent, parent: document.getElementsByTagName('head')[0]});\n\t\t\tsetTimeout(cb, 0);\n\t\t}\n\t\t\n\t\t//loader.get(path, cb);\n\t}\n\t\n\tthis._spinnerCounter = 0;\n\n\tjsio(\"import device\");\n\n\tvar baseScale;\n\tif (navigator.displayMetrics) {\n\t\tbaseScale = navigator.displayMetrics.densityDpi / 160;\n\t} else if (!CONFIG.scaleDPR && device.isMobileBrowser) {\n\t\tbaseScale = 1;\n\t} else {\n\t\tbaseScale = window.devicePixelRatio || 1;\n\t}\n\n\tthis._scale = baseScale;\n\n\tthis.setTargetDensity = function (target) {\n\t\tswitch (target) {\n\t\t\tcase 'high':\n\t\t\t\tthis._scale = baseScale * 0.5;\n\t\t\t\tbreak;\n\t\t\tcase 'medium':\n\t\t\t\tthis._scale = baseScale * 0.75;\n\t\t\t\tbreak;\n\t\t\tcase 'low':\n\t\t\tdefault:\n\t\t\t\tthis._scale = baseScale;\n\t\t\t\tbreak;\n\t\t}\n\n\t\tlogger.log('scale:', this._scale);\n\t}\n\n\tthis.getScale = function () {\n\t\treturn this._scale;\n\t}\n\n\tthis.getIntValue = function (val) {\n\t\treturn Math.round(val * this._scale) / this._scale;\n\t}\n\n\tthis.showSpinner = function () {\n\t\tif (this._spinnerCounter) {\n\t\t\t++this._spinnerCounter;\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tvar parent = GC.app.view;\n\t\tif (!parent) { return; }\n\t\t\n\t\t++this._spinnerCounter;\n\t\t\n\t\tif (!this._spinner) {\n\t\t\tvar dim = device.screen.devicePixelRatio * 50;\n\t\t\tthis._spinner = new Spinner({\n\t\t\t\twidth: dim,\n\t\t\t\theight: dim,\n\t\t\t\tx: parent.style.width / 2 - dim / 2,\n\t\t\t\ty: parent.style.height / 2 - dim / 2,\n\t\t\t\tparent: parent\n\t\t\t});\n\t\t} else {\n\t\t\tparent.addSubview(this._spinner);\n\t\t}\n\t}\n\t\n\tthis.hideSpinner = function () {\n\t\t--this._spinnerCounter;\n\t\tif (this._spinnerCounter <= 0) {\n\t\t\tthis._spinnerCounter = 0;\n\t\t\t\n\t\t\tthis._spinner && this._spinner.removeFromSuperview();\n\t\t}\n\t}\n\t\n\t// this.showDisplayNameDialog = function () {\n\t// \tthis.getDisplayNameDialog().show();\n\t// }\n\t\n\t// this.showAcceptInviteDialog = function (cb) {\n\t// \tGC.getConnection().withHandshake(this, function (err) {\n\t// \t\tif (err) { cb(err); return; }\n\t\t\t\n\t// \t\t// TODO: conn.getLoginDetails()\n\t// \t\tlogger.warn('put some real details in here');\n\n\t// \t\tvar details = {\n\t// \t\t\tfrom: 'Martin',\n\t// \t\t\tgame: 'Chess',\n\t// \t\t\tsummary: 'chess, 15 min, rated'\n\t// \t\t};\n\t\t\t\n\t// \t\tvar dialog = this.getAcceptInviteDialog();\n\t// \t\tdialog.setDetails(details);\n\t// \t\tdialog.delegate = function (action) {\n\t// \t\t\tswitch (action) {\n\t// \t\t\t\tcase 'accept':\n\t// \t\t\t\t\tGC.app.launchMultiplayerGame();\n\t// \t\t\t\t\tbreak;\n\t// \t\t\t\tcase 'decline':\n\t// \t\t\t\tdefault:\n\t// \t\t\t\t\tcb(action);\n\t// \t\t\t\t\tbreak;\n\t// \t\t\t}\n\t// \t\t};\n\t\t\t\n\t// \t\tdialog.show();\n\t\t\t\n\t// \t\tcb && cb('opened');\n\t// \t});\n\t// }\n\t\n\t// this.showChat = function () {\n\t// \tif (!this._chatMenu) {\n\t// \t\timport GCMenus.Chat;\n\t// \t\tthis._chatMenu = new GCMenus.Chat();\n\t// \t}\n\t\t\n\t// \tvar menuController = this.getMenuController();\n\t// \tif (menuController.isVisible()) {\n\t// \t\tmenuController.push(this._chatMenu);\n\t// \t} else {\n\t// \t\tmenuController.push(this._chatMenu, true);\n\t// \t\tmenuController.fadeIn();\n\t// \t\tthis._chatMenu.subscribeOnce('BeforeHide', this, function () {\n\t// \t\t\tmenuController.fadeOut();\n\t// \t\t});\n\t// \t}\n\t// }\n\t\n\t// this.alert = function (msg) {\n\t// \tthis.showDialog({title: '', message: msg});\n\t// }\n\t\n\t// this.showError = function (opts) {\n\t// \tthis.showDialog(merge(opts, {title: 'Error:', message: \"Sorry!\"}));\n\t// }\n\t\n\t// this.showDialog = function (opts) {\n\t// \timport GCDialogs.AlertDialog;\n\t// \tvar dialog = new GCDialogs.AlertDialog(opts);\n\t// \tdialog.show();\n\t// \treturn dialog;\n\t// }\n\t\n\t// this.getAcceptInviteDialog = function () {\n\t// \tif (!this._acceptInviteDialog) {\n\t// \t\timport GCDialogs.AcceptInviteDialog;\n\t// \t\tthis._acceptInviteDialog = new GCDialogs.AcceptInviteDialog();\n\t// \t}\n\t\t\n\t// \treturn this._acceptInviteDialog;\n\t// }\n\t\n\t// this.getDisplayNameDialog = function () {\n\t// \tif (!this._displayNameDialog) {\n\t// \t\timport GCDialogs.DisplayNameDialog;\n\t// \t\tthis._displayNameDialog = new GCDialogs.DisplayNameDialog();\n\t// \t}\n\t\t\n\t// \treturn this._displayNameDialog;\n\t// }\n\t\n\t// this.getParentNode = function () {\n\t// \tif (!this._parentNode) {\n\t// \t\timport timestep.doc;\n\t// \t\tthis._parentNode = timestep.doc.getElement();\n\t// \t}\n\t// \treturn this._parentNode;\n\t// }\n\t\n\t// this.showMainMenu = function (opts) {\n\t// \topts = merge(opts, {\n\t// \t\tfade: true,\n\t// \t\tbackToGame: false\n\t// \t});\n\t\t\n\t// \tvar controller = this.getMenuController();\n\t// \tvar mainMenu = this.getMainMenu();\n\t// \tmainMenu.setGameRunning(opts.backToGame);\n\t// \tcontroller.push(mainMenu);\n\t// \tif (opts.fade) { controller.fadeIn(); }\n\t// }\n\t\n\t// this.fadeOutMenus = function () { this.getMenuController().fadeOut(); }\n\t// this.fadeInMenus = function () { this.getMenuController().fadeIn(); }\n\t\n\t// this.getMenuController = function () {\n\t// \tif (!this._menuController) {\n\t// \t\timport GCMenus.MainMenu;\n\t// \t\timport squill.MenuController;\n\t// \t\tthis._menuController = new squill.MenuController({\n\t// \t\t\tcontroller: this,\n\t// \t\t\tparent: this.getParentNode(),\n\t// \t\t\tdelegate: GCMenus.MainMenu.delegate,\n\t// \t\t\tid: 'mainMenuController'\n\t// \t\t});\n\t// \t}\n\t\t\n\t// \treturn this._menuController;\n\t// }\n\t\n\t// this.getMainMenu = function () {\n\t// \tif (!this._mainMenu) {\n\t// \t\timport GCMenus.MainMenu;\n\t// \t\tthis._mainMenu = new GCMenus.MainMenu(merge(this._mainMenuOpts, {\n\t// \t\t\tsupports: {} //MANIFEST.supports\n\t// \t\t}));\n\t// \t}\n\t\t\n\t// \treturn this._mainMenu;\n\t// }\n\t\n\t// this.setMainMenuOpts = function (opts) {\n\t// \tthis._mainMenu = null;\n\t// \tthis._mainMenuOpts = merge(opts, {\n\t// \t\ttitle: 'Welcome!',\n\t// \t\timgLogo: 'resources/images/logo.png',\n\t// \t\timgSingle: 'resources/images/btnSingle.png',\n\t// \t\timgMulti: 'resources/images/btnMulti.png',\n\t// \t\tshowInvites: true,\n\t// \t\tshowGames: true,\n\t// \t\tquitGameOnShow: false\n\t// \t});\n\t\t\n\t// \treturn this;\n\t// }\n\t\n\t// this.getMainMenuOpts = function () { return this._mainMenuOpts; }\n\t\n\t// this.hideCursor = function () {\n\t// \tvar el = GC.app.getCanvas().getElement();\n\t// \tif (el) { el.style.cursor = 'none'; }\n\t// }\n\t\n\t// this.showCursor = function (name) {\n\t// \tvar el = GC.app.getCanvas().getElement();\n\t// \tif (el) { el.style.cursor = name || 'default'; }\n\t// }\n});\n\nvar cache = {};\nfor (var key in uiExports) {\n\tvar getter = bind(GLOBAL, function (key) {\n\t\t\treturn cache[key] || (cache[key] = uiExports[key]());\n\t\t}, key);\n\t\n\tif (GLOBAL.__defineGetter__) {\n\t\tGLOBAL.__defineGetter__(key, getter);\n\t} else {\n\t\tif (Object.defineProperty) {\n\t\t\tObject.defineProperty(GLOBAL, key, {get: getter});\n\t\t}\n\t}\n}\n\nfunction AsyncImageLoader(url, callback) {\n\tvar img = new ui.resource.Image({url: url});\n\timg.doOnLoad(function (success) { callback(img); });\n}\n\nfunction getCanvasCtor() {\n\tjsio(\"import device\");\n\tvar ctor = device.get('Canvas');\n\treturn ctor;\n}\n","pre":true},"sdk/jsio/lib/Iterator.js":{"path":"sdk/jsio/lib/Iterator.js","friendlyPath":"lib.Iterator","directory":"sdk/jsio/lib/","filename":"Iterator.js","src":"\"use import\";\n\n/**\n * Summary: Provides an object for iterating over the keys and values of\n * an object or array.  \n * Methods: \n *  - init(src) - src is the object to iterate over\n *  - next(): returns the current value and advances the iterator to the next value\n *  - loop(cb): iterate over all items immediately, calling cb with each item\n *  - asyncLoop(cb): iterate over all items asynchronously.  First argument to\n *     the callback is the item.  Second argument is a function `nextItem` that, \n *     when called, will cause the iterator to advance to the next element and \n *     call cb again.\n * Usage notes: asyncLoop is implemented to not be vulnerable to stack overflows.\n *     If cb immediately calls the nextItem function, it will not immediately \n *     result in a call to cb -- the stack will unwind to the asyncLoop call \n *     before continuing.\n */\n\njsio(\"import std.js as JS\");\n\nvar sdk_jsio_lib_Iterator=__class__;exports=sdk_jsio_lib_Iterator(function sdk_jsio_lib_Iterator(){return this.init&&this.init.apply(this,arguments)},function() {\n\tthis.init = function(src) {\n\t\tthis._src = src;\n\t\tthis._i = 0;\n\t\t\n\t\t// a call count prevents a stack overflow if the callback in\n\t\t// an aysncloop is called repeatedly for large arrays\n\t\tthis._calls = 0;\n\t\tif (JS.isArray(src)) {\n\t\t\tthis._isArray = true;\n\t\t} else if (Object.keys) {\n\t\t\tthis._keys = Object.keys(src);\n\t\t} else {\n\t\t\tvar k = this._keys = [];\n\t\t\tfor (var i in src) { if (src.hasOwnProperty(i)) { k.push(i); } }\n\t\t}\n\t}\n\t\n\tthis.nextKey = function() {\n\t\treturn this._keys[this._i++];\n\t}\n\t\n\tthis.next = function() {\n\t\tif (this._isArray) {\n\t\t\treturn this._src[this._i++] || exports.END_OF_LOOP;\n\t\t} else {\n\t\t\tvar key = this._keys[this._i++];\n\t\t\treturn key ? this._src[key] : exports.END_OF_LOOP;\n\t\t}\n\t}\n\t\n\tthis.loop = function(cb) {\n\t\tif (arguments.length > 1) { cb = bind.apply(this, arguments); }\n\t\tvar next;\n\t\tif (this._isArray) {\n\t\t\twhile((next = this.next())) {\n\t\t\t\tcb(next);\n\t\t\t}\n\t\t} else {\n\t\t\twhile((next = this.nextKey())) {\n\t\t\t\tcb(this._src[next], next);\n\t\t\t}\n\t\t}\n\t}\n\t\n\tthis.asyncLoop = function(cb) {\n\t\tif (arguments.length > 1) { cb = bind.apply(this, arguments); }\n\t\tthis._next = bind(this, '_onReturn', cb);\n\t\tthis._calls++;\n\t\tthis._asyncLoop(cb);\n\t}\n\t\n\tthis._asyncLoop = function(cb) {\n\t\tthis._inLoop = true;\n\t\twhile (this._calls) {\n\t\t\t--this._calls;\n\t\t\tcb(this.next(), this._next);\n\t\t}\n\t\tthis._inLoop = false;\n\t}\n\t\n\tthis._onReturn = function(cb) {\n\t\tthis._calls++;\n\t\tif (!this._inLoop) { this._asyncLoop(cb); }\n\t}\n});\n\nexports.END_OF_LOOP = new Error('jsio.Iterator.END_OF_LOOP');\n","pre":true},"sdk/timestep/ui/widget/Spinner.js":{"path":"sdk/timestep/ui/widget/Spinner.js","friendlyPath":"ui.widget.Spinner","directory":"sdk/timestep/ui/widget/","filename":"Spinner.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @class ui.widget.Spinner;\n */\njsio(\"import ui.View as View\");\n\nvar sdk_timestep_ui_widget_Spinner=__class__;exports=sdk_timestep_ui_widget_Spinner(function sdk_timestep_ui_widget_Spinner(){return this.init&&this.init.apply(this,arguments)},View, function (supr) {\n\n\tvar defaults = {\n\t\tcycles: 0.5,\n\t\tradius: 10,\n\t\tspokes: 20,\n\t\tthickness: 2,\n\t\ttrail: 10,\n\t\tcolor: '#ffffff',\n\t\tbackgroundColor: 'rgba(0, 0, 0, 0.5)',\n\t\tlayout: 'box'\n\t};\n\t\n\tthis.tag = 'Spinner';\n\tthis._t = 0;\n\t\n\tthis.init = function (opts) {\n\t\tthis._opts = merge(opts, defaults);\n\t\t\n\t\tthis._step = 2 * Math.PI / this._opts.spokes;\n\t\t\n\t\tsupr(this, 'init', [this._opts]);\n\t};\n\t\n\tthis.tick = function (dt) {\n\t\tthis._t += dt;\n\t\t\n\t\tvar r = (this._t / 1000 % (1 / this._opts.cycles)) * Math.PI;\n\t\t\n\t\tvar oldR = this._r;\n\t\tthis._r = r - (r % this._step);\n\t\t\n\t\tif (oldR != r) {\n\t\t\tthis.needsRepaint();\n\t\t}\n\t}\n\t\n\tthis.render = function (ctx) {\n\t\tctx.fillStyle = this._opts.backgroundColor;\n\t\t\n\t\tvar w = this.style.width,\n\t\t\t\th = this.style.height,\n\t\t\t\tradius = this._opts.radius,\n\t\t\t\ttrail = this._opts.trail,\n\t\t\t\tthickness = this._opts.thickness,\n\t\t\t\tx, y, i, j;\n\t\t\n\t\tfor (y = 0; y < radius; ++y) {\n\t\t\tj = y + 1;\n\t\t\tx = Math.round(radius - Math.sqrt(2 * j * radius - j * j));\n\t\t\tctx.fillRect(x, y, w - 2 * x, 1);\n\t\t}\n\t\t\n\t\ty = h - radius;\n\t\tctx.fillRect(0, radius, w, y - radius);\n\t\t\n\t\tfor (i = 0; i < radius; ++i) {\n\t\t\tj = radius - i;\n\t\t\tx = Math.round(radius - Math.sqrt(2 * j * radius - j * j));\n\t\t\tctx.fillRect(x, y + i, w - 2 * x, 1);\n\t\t}\n\t\t\n\t\tctx.fillStyle = this._opts.color;\n\t\tctx.translate(w / 2, h / 2);\n\t\tw /= 2;\n\t\tctx.rotate(this._r);\n\t\t\n\t\tfor (i = 0; i < this._opts.spokes; ++i) {\n\t\t\tctx.rotate(this._step);\n\t\t\tctx.globalAlpha = Math.max(0.1, (i - trail) / trail);\n\t\t\tctx.fillRect(10, -thickness / 2, w - 15, thickness);\n\t\t}\n\t}\n});\n","pre":true},"sdk/timestep/ui/SpriteView.js":{"path":"sdk/timestep/ui/SpriteView.js","friendlyPath":"ui.SpriteView","directory":"sdk/timestep/ui/","filename":"SpriteView.js","src":"/**\n * @license\n * This file is part of the Game Closure SDK.\n *\n * The Game Closure SDK is free software: you can redistribute it and/or modify\n * it under the terms of the Mozilla Public License v. 2.0 as published by Mozilla.\n\n * The Game Closure SDK is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * Mozilla Public License v. 2.0 for more details.\n\n * You should have received a copy of the Mozilla Public License v. 2.0\n * along with the Game Closure SDK.  If not, see <http://mozilla.org/MPL/2.0/>.\n */\n\n/**\n * @class ui.SpriteView\n * SpriteView pulls out sprited images and renders them at a given FPS\n * interval. A sprite consists of multiple *animations* (walk, run,\n * etc) which themselves consist of multiple *frames*.\n *\n * The sprite system pulls images from a given source format. Given\n * images like the following:\n *\n *     someFolder/spriteName-animationName-0001.png\n *     someFolder/spriteName-animationName-0002.png\n *\n * You'd instantiate a Sprite like so:\n * \n *     var mySprite = new SpriteView({url: \"someFolder/spriteName\"})\n * \n * The SpriteView class automatically find the images associated with that\n * sprite and generates the configuration for each of the animations.\n *\n * Then you would call this to start an animation:\n *\n *     mySprite.startAnimation(\"animationName\");\n *\n * @doc http://doc.gameclosure.com/api/ui-spriteview.html\n * @docsrc https://github.com/gameclosure/doc/blob/master/api/ui/spriteview.md\n */\n\njsio(\"import ui.ImageView as ImageView\");\njsio(\"import ui.resource.Image as Image\");\njsio(\"import ui.resource.loader\");\n\nvar sdk_timestep_ui_SpriteView=__class__;var SpriteView = exports=sdk_timestep_ui_SpriteView(function sdk_timestep_ui_SpriteView(){return this.init&&this.init.apply(this,arguments)},\"SpriteView\", ImageView, function (logger, supr) {\n\t\n\tthis.defaults = {\n\t\turl: null, // specified as a filename prefix, without an animation name or frame count\n\t\tgroupID: \"default\",\n\t\tframeRate: 15,\n\t\tdelay: 0,\n\t\temitFrameEvents: false,\n\t\tautoStart: false,\n\t\tloop: true\n\t};\n\n\tvar GROUPS = {};\n\n\tthis.tick = null;\n\n\tthis.init = function (opts) {\n\t\tthis._opts = opts = merge(opts, this.defaults);\n\t\topts.visible = false;\n\t\tsupr(this, 'init', [opts]);\n\n\t\t// toggle this flag manually to optimize SpriteViews\n\t\tthis.onScreen = true;\n\n\t\tthis.resetAllAnimations(opts);\n\t};\n\n\tthis.resetAllAnimations = function (opts) {\n\t\tthis.stopAnimation();\n\n\t\tthis._opts = opts = merge(opts, this.defaults);\n\n\t\tvar animations = SpriteView.allAnimations[opts.url];\n\t\t\n\t\tthis.groupID = opts.groupID;\n\t\tthis.frameRate = opts.frameRate;\n\t\t\n\t\tif (!GROUPS[this.groupID]) {\n\t\t\tGROUPS[this.groupID] = new Group();\n\t\t}\n\n\t\tthis._animations = {};\n\n\t\tif (opts.sheetData) {\n\t\t\tvar w = opts.sheetData.width || opts.width;\n\t\t\tvar h = opts.sheetData.height || opts.height;\n\t\t\tfor (var animName in opts.sheetData.anims) {\n\t\t\t\tif (!this._opts.defaultAnimation) {\n\t\t\t\t\tthis._opts.defaultAnimation = animName;\n\t\t\t\t}\n\t\t\t\tthis.loadFromSheet(animName, opts.sheetData.url, w, h,\n\t\t\t\t\topts.sheetData.offsetX || w, opts.sheetData.offsetY || h,\n\t\t\t\t\topts.sheetData.startX || 0, opts.sheetData.startY || 0,\n\t\t\t\t\topts.sheetData.anims[animName]);\n\t\t\t}\n\t\t} else {\n\t\t\tfor (var animName in animations) {\n\t\t\t\tif (!this._opts.defaultAnimation) {\n\t\t\t\t\tthis._opts.defaultAnimation = animName;\n\t\t\t\t}\n\t\t\t\tthis.addAnimation(animName, animations[animName]);\n\t\t\t}\n\t\t}\n\n\t\tif (opts.autoSize && this._opts.defaultAnimation) {\n\t\t\tvar frameImages = this._animations[this._opts.defaultAnimation].frames;\n\t\t\tif (frameImages[0]) {\n\t\t\t\tthis.style.width = frameImages[0].getWidth();\n\t\t\t\tthis.style.height = frameImages[0].getHeight();\n\t\t\t}\n\t\t}\n\n\t\topts.autoStart && this.startAnimation(this._opts.defaultAnimation, opts);\n\t};\n\n\tthis.loadFromSheet = function (animName, sheetUrl, width, height, offsetX, offsetY, startX, startY, frames) {\n\t\tvar frameImages = [];\n\t\tfor (var i = 0; i < frames.length; i++) {\n\t\t\tframeImages.push(new Image({\n\t\t\t\turl: sheetUrl,\n\t\t\t\tsourceW: width,\n\t\t\t\tsourceH: height,\n\t\t\t\tsourceX: startX + frames[i][0] * offsetX,\n\t\t\t\tsourceY: startY + frames[i][1] * offsetY\n\t\t\t}));\n\t\t}\n\t\tthis._animations[animName] = {\n\t\t\tframes: frameImages\n\t\t};\n\t};\n\n\tthis.addAnimation = function (animName, frameData) {\n\t\tif ( ! isArray(frameData) ) {\n\t\t\tframeData = SpriteView.allAnimations[frameData][animName];\n\t\t}\n\t\tvar frameImages = [];\n\t\tfor (var i = 0, frame; frame = frameData[i]; i++) {\n\t\t\tframeImages.push(this.getImageFromCache(frame.url));\n\t\t}\n\t\tthis._animations[animName] = {\n\t\t\tframes: frameImages\n\t\t};\n\t};\n\t\n\t/** Returns a ui.resource.Image for the given animation's frame. */\n\tthis.getFrame = function (animName, index) {\n\t\treturn this._animations[animName].frames[index];\n\t};\n\n\t/** Returns the number of frames in a given animation. */\n\tthis.getFrameCount = function (animName) {\n\t\treturn this._animations[animName].frames.length;\n\t};\n\n\tthis.getGroup = function (groupID) {\n\t\treturn GROUPS[groupID || this.groupID];\n\t};\n\n\t/**\n\t * Starts an animation. Default options:\n\t *     loop: false\n\t *     iterations: 1\n\t *     callback: null (called at the end of the animation)\n\t *     frame: 0 (frame to start on)\n\t *     randomFrame: false (start on a random frame of the animation)\n\t */\n\tthis.startAnimation = function (name, opts) {\n\t\topts = opts || {};\n\n\t\tif ( opts.randomFrame === true && opts.frame == null ) {\n\t\t\topts.frame = Math.random() * this._animations[name].frames.length | 0;\n\t\t}\n\n\t\tif (opts.loop === true) { opts.iterations = Infinity; }\n\n\t\tthis._iterationsLeft = opts.iterations || 1;\n\t\tthis._callback = opts.callback || null;\n\t\tthis._currentAnimationName = name;\n\t\tthis._currentFrame = opts.frame || 0;\n\t\tthis._dt = 0;\n\t\tthis._delay = 0;\n\n\t\tif (!this._animations[name]) {\n\t\t\tthrow new Error(\"Animation \" + name + \" does not exist: \" + this._opts.url + \".\");\n\t\t}\n\n\t\tif (!this.isPlaying) {\n\t\t\tthis.tick = this._tickSprite;\n\t\t\tGROUPS[this.groupID].add(this);\n\t\t\tthis.isPlaying = this.running = true;\n\t\t\tthis.style.visible = true;\n\t\t}\n\n\t\t// align the image for the first time\n\t\tthis._tickSprite(0);\n\t};\n\n\t/** Stops the current animation. This will make the sprite invisible. */\n\tthis.stopAnimation = function () {\n\t\tif (this.isPlaying) {\n\t\t\tthis.style.visible = false;\n\t\t\tthis.tick = null;\n\t\t\tthis.isPlaying = this.running = false;  //use isPlaying, this.running is deprecated\n\t\t\tthis.isPaused = this._isPaused = false; //use isPaused instead, _isPaused is deprecated\n\t\t\tGROUPS[this.groupID].remove(this.uid);\n\t\t}\n\t};\n\n\t/**\n\t * If this animation doesn't loop, stops the animation entirely.\n\t * Otherwise restarts the default animation. For instance, if you\n\t * had a default animation \"idle\", you could call\n\t *\n\t *     startAnimation('walk', {iterations: 2});\n\t *\n\t * and after 2 iterations of the 'walk' animation, it would go\n\t * back to the 'walk' animation.\n\t */\n\tthis.resetAnimation = function () {\n\t\tif (!this._opts.loop) {\n\t\t\tthis.stopAnimation();\n\t\t} else {\n\t\t\tthis.startAnimation(this._opts.defaultAnimation);\n\t\t}\n\t};\n\n\tthis.setFramerate = function (fps) {\n\t\tthis.frameRate = fps || 0.00001;\n\t};\n\n\tthis.pause = function () {\n\t\tthis.isPaused = this._isPaused = true;\n\t};\n\n\tthis.resume = function () {\n\t\tthis.isPaused = this._isPaused = false;\n\t};\n\n\tthis._tickSprite = function (dt) {\n\t\tif (this.isPaused) { return; }\n\n\t\tdt += this._dt;\n\n\t\tif (this._delay) {\n\t\t\tthis._delay -= dt;\n\t\t\tif (this._delay < 0) {\n\t\t\t\tthis._delay = 0;\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tvar anim = this._animations[this._currentAnimationName];\n\t\tvar stepTime = (1000 / this.frameRate);\n\t\tvar frameSteps = dt / stepTime | 0;\n\t\tvar prevFrame = this._currentFrame;\n\t\tthis._dt = dt - frameSteps * stepTime;\n\t\tthis._currentFrame = (this._currentFrame + frameSteps) % anim.frames.length;\n\n\t\tif (this._currentFrame < 0) {\n\t\t\tthis._currentFrame += anim.frames.length;\n\t\t}\n\n\t\tif (this.onScreen && (frameSteps !== 0 || dt === 0)) {\n\t\t\tvar image = this._animations[this._currentAnimationName].frames[this._currentFrame];\n\t\t\tthis.setImage(image);\n\n\t\t\tif (this._opts.emitFrameEvents) {\n\t\t\t\tfor (var i = 0; i < frameSteps; i++) {\n\t\t\t\t\tvar frame = (prevFrame + i) % anim.frames.length;\n\t\t\t\t\tthis.publish(this._currentAnimationName + '_' + frame);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tvar iterationsCompleted = (prevFrame + frameSteps) / anim.frames.length | 0;\n\t\tif (iterationsCompleted) {\n\t\t\tthis._delay = this._opts.delay;\n\t\t\tif (--this._iterationsLeft <= 0) {\n\t\t\t\tvar cb = this._callback;\n\t\t\t\tthis._callback = null;\n\n\t\t\t\tthis.resetAnimation();\n\t\t\t\tif (cb) cb();\n\t\t\t}\n\t\t}\n\t};\n});\n\nSpriteView.allAnimations = {};\nSpriteView.getGroup = SpriteView.prototype.getGroup;\n\n(function loadAnimations() {\n\t// build the animation frame map\n\tvar resourceMap = ui.resource.loader.getMap();\n\tvar allAnimations = SpriteView.allAnimations;\n\n\t// Generate the animations from the filenames in resourceMap.\n\t// These names must be sorted ascending so that the frames end up\n\t// in the correct order.\n\tvar filenames = Object.keys(resourceMap);\n\tfilenames.sort();\n\n\t// Based on the filenames, add each image to an animation map (where applicable).\n\tfor (var i in filenames) {\n\t\tvar k = filenames[i];\n\t\t// split a filename like this: /resources/images/creature-walking-0001.png\n\t\t//       into parts like this: '    animKey     '  name  ' anim  ' #  '\n\t\tvar match = /((?:.*)\\/.*?)[-_ ](.*?)[-_ ](\\d+)/.exec(k);\n\t\tif (match) {\n\t\t\tvar animKey = match[1];\n\t\t\tvar name = match[2];\n\t\t\tvar frameNumber = match[3];\n\t\t\tvar anim = (allAnimations[animKey] || (allAnimations[animKey] = {}));\n\t\t\tvar frameList = (anim[name] || (anim[name] = []));\n\t\t\tvar info = resourceMap[k];\n\t\t\tinfo.url = k;\n\t\t\tframeList.push(info);\n\t\t}\n\t}\n})();\n\n\n/**\n * Group class\n */\nGroup=__class__;var Group=Group(function Group(){return this.init&&this.init.apply(this,arguments)},jsio.__filename, function (logger) {\n\n\tthis.init = function () {\n\t\tthis.sprites = {};\n\t};\n\n\tthis.add = function (sprite) {\n\t\tthis.sprites[sprite.uid] = sprite;\n\t};\n\n\tthis.remove = function (uid) {\n\t\tdelete this.sprites[uid];\n\t};\n\n\tthis.pause = function () {\n\t\tthis._forEachSprite('pause');\n\t};\n\n\tthis.resume = function () {\n\t\tthis._forEachSprite('resume');\n\t};\n\n\tthis.stopAnimation = function () {\n\t\tthis._forEachSprite('stopAnimation');\n\t};\n\n\tthis.resetAnimation = function () {\n\t\tthis._forEachSprite('resetAnimation');\n\t};\n\n\tthis._forEachSprite = function (method) {\n\t\tfor (var i in this.sprites) {\n\t\t\tthis.sprites[i][method]();\n\t\t}\n\t};\n});\n","pre":true},"./src/Application.js":{"path":"./src/Application.js","friendlyPath":"src.Application","directory":"./src/","filename":"Application.js","baseMod":"src","basePath":".","src":"jsio(\"import ui.TextView as TextView\");\njsio(\"import src.box2d.common.math.b2Vec2 as b2Vec2\");\njsio(\"import src.box2d.collision.b2AABB as b2AABB\");\njsio(\"import src.box2d.collision.shapes.b2BoxDef as b2BoxDef\");\njsio(\"import src.box2d.dynamics.b2World as b2World\");\njsio(\"import src.box2d.dynamics.b2BodyDef as b2BodyDef\");\n\njsio(\"import src.demos.util as util\");\njsio(\"import src.demos.crank as crank\");\njsio(\"import src.demos.compound as compound\"); \njsio(\"import src.demos.pendulum as pendulum\");\njsio(\"import src.demos.stack as stack\");\n\nvar src_Application=__class__;exports=src_Application(function src_Application(){return this.init&&this.init.apply(this,arguments)},GC.Application, function () {\n\n\tthis.initUI = function () {\n\t\t//var textview = new TextView({\n\t\t//\tsuperview: this.view,\n\t\t//\tlayout: \"box\",\n\t\t//\ttext: \"Hello, world!\",\n\t\t//\tcolor: \"white\"\n\t\t//});\n\t\tthis.initWorld();\n\t\tGC.app.engine.on('Render', this.render.bind(this));\n\t\tthis.on('InputStart', this.drop.bind(this));\n\t};\n\n\tthis.initWorld = function(did) {\n\t\tif (!did) did = 0;\n\t\tthis._world = this.createWorld();\n\t\t//this._initId += did;\n\t\t//this._initId %= demos.InitWorlds.length;\n\t\t//if (this._initId < 0) \n\t\t//\tthis._initId = demos.InitWorlds.length + initId;\n\n\t\t//demos.InitWorlds[this._initId](this._world);\n\t\tutil.initWorld(this._world);\n\t\t//compound.initWorld(this._world);\n\t\t//crank.initWorld(this._world);\n\t\t//pendulum.initWorld(this._world);\n\t\t//stack.initWorld(this._world);\n\t};\n\n\tthis.createWorld = function() {\n\t\tvar worldAABB = new b2AABB();\n\t\tworldAABB.minVertex.Set(0, -this.style.height);\n\t\tworldAABB.maxVertex.Set(this.style.width, this.style.height);\n\n\t\t// gravity points down \n\t\tvar gravity = new b2Vec2(0, 300);\n\t\tvar doSleep = true;\n\n\t\tvar world = new b2World(worldAABB, gravity, doSleep);\n\n\t\tthis.createGround(world);\n\n\t\t// left border\n\t\tutil.createRect(world, 0, 0, 3, this.style.height);\n\t\t// right border\n\t\tutil.createRect(world, this.style.width-3, 0, 3, this.style.height);\n\t\treturn world;\n\t};\n\n\tthis.createGround = function(world) {\n\t\tvar groundSd = new b2BoxDef();\n\t\t// ground width and height\n\t\tgroundSd.extents.Set(this.style.width, 3);\n\t\tgroundSd.restitution = 0.2;\n\t\tvar groundBd = new b2BodyDef();\n\t\tgroundBd.AddShape(groundSd);\n\t\tgroundBd.position.Set(0, this.style.height);\n\t\treturn world.CreateBody(groundBd)\n\t};\n\n\tthis.drop = function(event, point) {\n\t\tutil.createCircle(this._world, point.x, point.y);\n\t};\n\n\tthis.render = function(context) {\n\t\tutil.drawWorld(this._world, context);\n\t};\n\n\tthis.tick = function(dt) {\n\t\tvar ts1 = 1.0/60;\n\t\tvar ts2 = dt/1000;\n\t\tthis._world.Step(ts2, 300);\n\t};\n\t\n\tthis.launchUI = function () {};\n});\n","pre":true},"./src/box2d/common/math/b2Vec2.js":{"path":"./src/box2d/common/math/b2Vec2.js","friendlyPath":"src.box2d.common.math.b2Vec2","directory":"./src/box2d/common/math/","filename":"b2Vec2.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\njsio(\"import .b2Math2 as b2Math\");\r\n\r\n// b2Vec2 has no constructor so that it\r\n// can be placed in a union.\r\n//var b2Vec2 = Class.create();\r\nb2Vec2=__class__;var b2Vec2=b2Vec2(function b2Vec2(){return this.init&&this.init.apply(this,arguments)},function()  {\r\n\r\n\tthis.init = function(x, y) {this.x=x; this.y=y;};\r\n\r\n\tthis.SetZero = function() { this.x = 0.0; this.y = 0.0; };\r\n\r\n\tthis.Set = function(x_, y_) {this.x=x_; this.y=y_;};\r\n\r\n\tthis.SetV = function(v) {this.x=v.x; this.y=v.y;};\r\n\r\n\tthis.Negative = function(){ return new b2Vec2(-this.x, -this.y); };\r\n\r\n\r\n\tthis.Copy = function(){\r\n\t\treturn new b2Vec2(this.x,this.y);\r\n\t};\r\n\r\n\tthis.sAdd = function(v)\r\n\t{\r\n\t\tthis.x += v.x; this.y += v.y;\r\n\t};\r\n\r\n\tthis.Subtract = function(v)\r\n\t{\r\n\t\tthis.x -= v.x; this.y -= v.y;\r\n\t};\r\n\r\n\tthis.Multiply = function(a)\r\n\t{\r\n\t\tthis.x *= a; this.y *= a;\r\n\t};\r\n\r\n\tthis.MulM = function(A)\r\n\t{\r\n\t\tvar tX = this.x;\r\n\t\tthis.x = A.col1.x * tX + A.col2.x * this.y;\r\n\t\tthis.y = A.col1.y * tX + A.col2.y * this.y;\r\n\t};\r\n\r\n\tthis.MulTM = function(A)\r\n\t{\r\n\t\tvar tX = b2Math.b2Dot(this, A.col1);\r\n\t\tthis.y = b2Math.b2Dot(this, A.col2);\r\n\t\tthis.x = tX;\r\n\t};\r\n\r\n\tthis.CrossVF = function(s)\r\n\t{\r\n\t\tvar tX = this.x;\r\n\t\tthis.x = s * this.y;\r\n\t\tthis.y = -s * tX;\r\n\t};\r\n\r\n\tthis.CrossFV = function(s)\r\n\t{\r\n\t\tvar tX = this.x;\r\n\t\tthis.x = -s * this.y;\r\n\t\tthis.y = s * tX;\r\n\t};\r\n\r\n\tthis.MinV = function(b)\r\n\t{\r\n\t\tthis.x = this.x < b.x ? this.x : b.x;\r\n\t\tthis.y = this.y < b.y ? this.y : b.y;\r\n\t};\r\n\r\n\tthis.MaxV = function(b)\r\n\t{\r\n\t\tthis.x = this.x > b.x ? this.x : b.x;\r\n\t\tthis.y = this.y > b.y ? this.y : b.y;\r\n\t};\r\n\r\n\tthis.Abs = function()\r\n\t{\r\n\t\tthis.x = Math.abs(this.x);\r\n\t\tthis.y = Math.abs(this.y);\r\n\t};\r\n\r\n\tthis.Length = function()\r\n\t{\r\n\t\treturn Math.sqrt(this.x * this.x + this.y * this.y);\r\n\t};\r\n\r\n\tthis.Normalize = function()\r\n\t{\r\n\t\tvar length = this.Length();\r\n\t\tif (length < Number.MIN_VALUE)\r\n\t\t{\r\n\t\t\treturn 0.0;\r\n\t\t}\r\n\t\tvar invLength = 1.0 / length;\r\n\t\tthis.x *= invLength;\r\n\t\tthis.y *= invLength;\r\n\r\n\t\treturn length;\r\n\t};\r\n\r\n\tthis.IsValid = function()\r\n\t{\r\n\t\treturn b2Math.b2IsValid(this.x) && b2Math.b2IsValid(this.y);\r\n        };\t\r\n});\r\n\r\nb2Vec2.Make = function(x_, y_){\r\n\treturn new b2Vec2(x_, y_);\r\n};\r\n\r\nexports = b2Vec2;\r\n","pre":true},"./src/box2d/common/math/b2Math2.js":{"path":"./src/box2d/common/math/b2Math2.js","friendlyPath":".b2Math2","directory":"./src/box2d/common/math/","filename":"b2Math2.js","src":"\n\nexports.b2IsValid = function(x)\n\t{\n\t\treturn isFinite(x);\n\t};\nexports.b2Dot = function(a, b)\n\t{\n\t\treturn a.x * b.x + a.y * b.y;\n\t};\n","pre":true},"./src/box2d/collision/b2AABB.js":{"path":"./src/box2d/collision/b2AABB.js","friendlyPath":"src.box2d.collision.b2AABB","directory":"./src/box2d/collision/","filename":"b2AABB.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\n\r\n// A manifold for two touching convex shapes.\r\n//var b2AABB = Class.create();\r\n//b2AABB.prototype = \r\n//{\r\n//\tIsValid: function(){\r\n//\t\t//var d = b2Math.SubtractVV(this.maxVertex, this.minVertex);\r\n//\t\tvar dX = this.maxVertex.x;\r\n//\t\tvar dY = this.maxVertex.y;\r\n//\t\tdX = this.maxVertex.x;\r\n//\t\tdY = this.maxVertex.y;\r\n//\t\tdX -= this.minVertex.x;\r\n//\t\tdY -= this.minVertex.y;\r\n//\t\tvar valid = dX >= 0.0 && dY >= 0.0;\r\n//\t\tvalid = valid && this.minVertex.IsValid() && this.maxVertex.IsValid();\r\n//\t\treturn valid;\r\n//\t},\r\n//\r\n//\tminVertex: new b2Vec2(),\r\n//\tmaxVertex: new b2Vec2(),\r\n//\tinitialize: function() {\r\n//\t\t// initialize instance variables for references\r\n//\t\tthis.minVertex = new b2Vec2();\r\n//\t\tthis.maxVertex = new b2Vec2();\r\n//\t\t//\r\n//}};\r\n\r\njsio(\"import ..common.math.b2Vec2 as b2Vec2\");\r\n\r\n// A manifold for two touching convex shapes.\r\nvar src_box2d_collision_b2AABB=__class__;var b2AABB = exports=src_box2d_collision_b2AABB(function src_box2d_collision_b2AABB(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\r\n\tthis.init = function() {\t\r\n\t\t// initialize instance variables for references\r\n\t\tthis.minVertex = new b2Vec2();\r\n\t\tthis.maxVertex = new b2Vec2();\r\n\t};\r\n\r\n\tthis.IsValid = function() {\r\n\t\t//var d = b2Math.SubtractVV(this.maxVertex, this.minVertex);\r\n\t\tvar dX = this.maxVertex.x;\r\n\t\tvar dY = this.maxVertex.y;\r\n\t\tdX = this.maxVertex.x;\r\n\t\tdY = this.maxVertex.y;\r\n\t\tdX -= this.minVertex.x;\r\n\t\tdY -= this.minVertex.y;\r\n\t\tvar valid = dX >= 0.0 && dY >= 0.0;\r\n\t\tvalid = valid && this.minVertex.IsValid() && this.maxVertex.IsValid();\r\n\t\treturn valid;\r\n\t};\r\n\t\r\n\t//this.minVertex = new b2Vec2();\r\n\t//this.maxVertex = new b2Vec2();\r\n});\r\n","pre":true},"./src/box2d/collision/shapes/b2BoxDef.js":{"path":"./src/box2d/collision/shapes/b2BoxDef.js","friendlyPath":"src.box2d.collision.shapes.b2BoxDef","directory":"./src/box2d/collision/shapes/","filename":"b2BoxDef.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\n\r\n\r\njsio(\"import .b2ShapeDef as b2ShapeDef\");\r\njsio(\"import .b2Shape as .b2Shape\");\r\njsio(\"import ...common.math.b2Vec2 as b2Vec2\");\r\n\r\n\r\nvar src_box2d_collision_shapes_b2BoxDef=__class__;var b2BoxDef = exports=src_box2d_collision_shapes_b2BoxDef(function src_box2d_collision_shapes_b2BoxDef(){return this.init&&this.init.apply(this,arguments)},b2ShapeDef, function(supr) {\r\n\tthis.init = function()\r\n\t{\r\n\t\tsupr(this, 'init');\r\n\r\n\t\t// The constructor for b2ShapeDef\r\n\t\tthis.type = b2Shape.e_unknownShape;\r\n\t\tthis.userData = null;\r\n\t\tthis.localPosition = new b2Vec2(0.0, 0.0);\r\n\t\tthis.localRotation = 0.0;\r\n\t\tthis.friction = 0.2;\r\n\t\tthis.restitution = 0.0;\r\n\t\tthis.density = 0.0;\r\n\t\tthis.categoryBits = 0x0001;\r\n\t\tthis.maskBits = 0xFFFF;\r\n\t\tthis.groupIndex = 0;\t\r\n\t\t//\r\n\r\n\t\tthis.type = b2Shape.e_boxShape;\r\n\t\tthis.extents = new b2Vec2(1.0, 1.0);\r\n\t};\r\n});\r\n\r\n\r\n","pre":true},"./src/box2d/collision/shapes/b2ShapeDef.js":{"path":"./src/box2d/collision/shapes/b2ShapeDef.js","friendlyPath":".b2ShapeDef","directory":"./src/box2d/collision/shapes/","filename":"b2ShapeDef.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\n\r\njsio(\"import .b2Shape as b2Shape\");\r\njsio(\"import ...common.math.b2Math2 as b2Math2\");\r\njsio(\"import ...common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import ...common.b2Settings as b2Settings\");\r\n\r\n\r\nvar src_box2d_collision_shapes_b2ShapeDef=__class__;var b2ShapeDef = exports=src_box2d_collision_shapes_b2ShapeDef(function src_box2d_collision_shapes_b2ShapeDef(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\tthis.init = function()\r\n\t{\r\n\t\tthis.type = b2Shape.e_unknownShape;\r\n\t\tthis.userData = null;\r\n\t\tthis.localPosition = new b2Vec2(0.0, 0.0);\r\n\t\tthis.localRotation = 0.0;\r\n\t\tthis.friction = 0.2;\r\n\t\tthis.restitution = 0.0;\r\n\t\tthis.density = 0.0;\r\n\t\tthis.categoryBits = 0x0001;\r\n\t\tthis.maskBits = 0xFFFF;\r\n\t\tthis.groupIndex = 0;\r\n\t};\r\n\r\n\t//virtual ~b2ShapeDef() {}\r\n\r\n\tthis.ComputeMass = function(massData)\r\n\t{\r\n\r\n\t\tmassData.center = new b2Vec2(0.0, 0.0)\r\n\r\n\t\tif (this.density == 0.0)\r\n\t\t{\r\n\t\t\tmassData.mass = 0.0;\r\n\t\t\tmassData.center.Set(0.0, 0.0);\r\n\t\t\tmassData.I = 0.0;\r\n\t\t};\r\n\r\n\t\tswitch (this.type)\r\n\t\t{\r\n\t\tcase b2Shape.e_circleShape:\r\n\t\t\t{\r\n\t\t\t\tvar circle = this;\r\n\t\t\t\tmassData.mass = this.density * b2Settings.b2_pi * circle.radius * circle.radius;\r\n\t\t\t\tmassData.center.Set(0.0, 0.0);\r\n\t\t\t\tmassData.I = 0.5 * (massData.mass) * circle.radius * circle.radius;\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\r\n\t\tcase b2Shape.e_boxShape:\r\n\t\t\t{\r\n\t\t\t\tvar box = this;\r\n\t\t\t\tmassData.mass = 4.0 * this.density * box.extents.x * box.extents.y;\r\n\t\t\t\tmassData.center.Set(0.0, 0.0);\r\n\t\t\t\tmassData.I = massData.mass / 3.0 * b2Math2.b2Dot(box.extents, box.extents);\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\r\n\t\tcase b2Shape.e_polyShape:\r\n\t\t\t{\r\n\t\t\t\tvar poly = this;\r\n\t\t\t\tb2Shape.PolyMass(massData, poly.vertices, poly.vertexCount, this.density);\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\r\n\t\tdefault:\r\n\t\t\tmassData.mass = 0.0;\r\n\t\t\tmassData.center.Set(0.0, 0.0);\r\n\t\t\tmassData.I = 0.0;\r\n\t\t\tbreak;\r\n\t\t}\r\n\t};\r\n});\r\n\r\n\t//type: 0,\r\n\t//userData: null,\r\n\t//localPosition: null,\r\n\t//localRotation: null,\r\n\t//friction: null,\r\n\t//restitution: null,\r\n\t//density: null,\r\n\r\n\t//// The collision category bits. Normally you would just set one bit.\r\n\t//categoryBits: 0,\r\n\r\n\t//// The collision mask bits. This states the categories that this\r\n\t//// shape would accept for collision.\r\n\t//maskBits: 0,\r\n\r\n\t//// Collision groups allow a certain group of objects to never collide (negative)\r\n\t//// or always collide (positive). Zero means no collision group. Non-zero group\r\n\t//// filtering always wins against the mask bits.\r\n\t//groupIndex: 0};\r\n","pre":true},"./src/box2d/collision/shapes/b2Shape.js":{"path":"./src/box2d/collision/shapes/b2Shape.js","friendlyPath":".b2Shape","directory":"./src/box2d/collision/shapes/","filename":"b2Shape.js","src":"/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\njsio(\"import ...common.math.b2Math as b2Math\");\r\njsio(\"import ...common.math.b2Math2 as b2Math2\");\r\njsio(\"import ...common.math.b2Mat22 as b2Mat22\");\r\njsio(\"import ...common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import ..b2Pair as b2Pair\");\r\n\r\n\r\n\r\n// Shapes are created automatically when a body is created.\r\n// Client code does not normally interact with shapes.\r\nvar src_box2d_collision_shapes_b2Shape=__class__;var b2Shape = exports=src_box2d_collision_shapes_b2Shape(function src_box2d_collision_shapes_b2Shape(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\r\n\tthis.TestPoint = function(p){return false};\r\n\r\n\tthis.GetUserData = function(){return this.m_userData;};\r\n\r\n\tthis.GetType = function(){\r\n\t\treturn this.m_type;\r\n\t};\r\n\r\n\t// Get the parent body of this shape.\r\n\tthis.GetBody = function(){\r\n\t\treturn this.m_body;\r\n\t};\r\n\r\n\tthis.GetPosition = function(){\r\n\t\treturn this.m_position;\r\n\t};\r\n\tthis.GetRotationMatrix = function(){\r\n\t\treturn this.m_R;\r\n\t};\r\n\r\n\t// Remove and then add proxy from the broad-phase.\r\n\t// This is used to refresh the collision filters.\r\n\tthis.ResetProxy = function(broadPhase){};\r\n\r\n\t// Get the next shape in the parent body's shape list.\r\n\tthis.GetNext = function(){\r\n\t\treturn this.m_next;\r\n\t};\r\n\r\n\t//--------------- Internals Below -------------------\r\n\tthis.init = function(def, body){\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_R = new b2Mat22();\r\n\t\tthis.m_position = new b2Vec2();\r\n\t\t//\r\n\r\n\t\tthis.m_userData = def.userData;\r\n\r\n\t\tthis.m_friction = def.friction;\r\n\t\tthis.m_restitution = def.restitution;\r\n\t\tthis.m_body = body;\r\n\r\n\t\tthis.m_proxyId = b2Pair.b2_nullProxy;\r\n\r\n\t\tthis.m_maxRadius = 0.0;\r\n\r\n\t\tthis.m_categoryBits = def.categoryBits;\r\n\t\tthis.m_maskBits = def.maskBits;\r\n\t\tthis.m_groupIndex = def.groupIndex;\r\n\t};\r\n\r\n\t// Internal use only. Do not call.\r\n\t//b2Shape::~b2Shape()\r\n\t//{\r\n\t//\tthis.m_body->m_world->m_broadPhase->this.DestroyProxy(this.m_proxyId);\r\n\t//}\r\n\r\n\r\n\tthis.DestroyProxy = function()\r\n\t{\r\n\t\tif (this.m_proxyId != b2Pair.b2_nullProxy)\r\n\t\t{\r\n\t\t\tthis.m_body.m_world.m_broadPhase.DestroyProxy(this.m_proxyId);\r\n\t\t\tthis.m_proxyId = b2Pair.b2_nullProxy;\r\n\t\t}\r\n\t},\r\n\r\n\r\n\t// Internal use only. Do not call.\r\n\tthis.Synchronize = function(position1, R1, position2, R2){};\r\n\tthis.QuickSync = function(position, R){};\r\n\tthis.Support = function(dX, dY, out){};\r\n\tthis.GetMaxRadius = function(){\r\n\t\treturn this.m_maxRadius;\r\n\t};\r\n\r\n\t//m_next: null,\r\n\r\n\t//m_R: new b2Mat22(),\r\n\t//m_position: new b2Vec2(),\r\n\r\n\t//m_type: 0,\r\n\r\n\t//m_userData: null,\r\n\r\n\t//m_body: null,\r\n\r\n\t//m_friction: null,\r\n\t//m_restitution: null,\r\n\r\n\t//m_maxRadius: null,\r\n\r\n\t//m_proxyId: 0,\r\n\t//m_categoryBits: 0,\r\n\t//m_maskBits: 0,\r\n\t//m_groupIndex: 0\r\n\r\n\r\n\r\n\t// b2ShapeType\r\n});\r\n\r\n// moved to b2ShapeFactory\r\n//exports.Create = function(def, body, center){\r\n//\t\tswitch (def.type)\r\n//\t\t{\r\n//\t\tcase b2Shape.e_circleShape:\r\n//\t\t\t{\r\n//\t\t\t\t//void* mem = body->m_world->m_blockAllocator.Allocate(sizeof(b2CircleShape));\r\n//\t\t\t\treturn new b2CircleShape(def, body, center);\r\n//\t\t\t}\r\n//\r\n//\t\tcase b2Shape.e_boxShape:\r\n//\t\tcase b2Shape.e_polyShape:\r\n//\t\t\t{\r\n//\t\t\t\t//void* mem = body->m_world->m_blockAllocator.Allocate(sizeof(b2PolyShape));\r\n//\t\t\t\treturn new b2PolyShape(def, body, center);\r\n//\t\t\t}\r\n//\t\t}\r\n//\r\n//\t\t//b2Settings.b2Assert(false);\r\n//\t\treturn null;\r\n//\t};\r\nexports.Destroy = function(shape)\r\n\t{\r\n\t\t/*b2BlockAllocator& allocator = shape->m_body->m_world->m_blockAllocator;\r\n\r\n\t\tswitch (shape.m_type)\r\n\t\t{\r\n\t\tcase b2Shape.e_circleShape:\r\n\t\t\tshape->~b2Shape();\r\n\t\t\tallocator.Free(shape, sizeof(b2CircleShape));\r\n\t\t\tbreak;\r\n\r\n\t\tcase b2Shape.e_polyShape:\r\n\t\t\tshape->~b2Shape();\r\n\t\t\tallocator.Free(shape, sizeof(b2PolyShape));\r\n\t\t\tbreak;\r\n\r\n\t\tdefault:\r\n\t\t\tb2Assert(false);\r\n\t\t}\r\n\r\n\t\tshape = NULL;*/\r\n\r\n\t\t// FROM DESTRUCTOR\r\n\t\tif (shape.m_proxyId != b2Pair.b2_nullProxy)\r\n\t\t\tshape.m_body.m_world.m_broadPhase.DestroyProxy(shape.m_proxyId);\r\n\t};\r\nexports.e_unknownShape = -1;\r\nexports.e_circleShape = 0;\r\nexports.e_boxShape = 1;\r\nexports.e_polyShape = 2;\r\nexports.e_meshShape = 3;\r\nexports.e_shapeTypeCount = 4;\r\nexports.PolyMass = function(massData, vs, count, rho)\r\n\t{\r\n\t\t//b2Settings.b2Assert(count >= 3);\r\n\r\n\t\t//var center = new b2Vec2(0.0, 0.0);\r\n\t\tvar center = new b2Vec2();\r\n\t\tcenter.SetZero();\r\n\r\n\t\tvar area = 0.0;\r\n\t\tvar I = 0.0;\r\n\r\n\t\t// pRef is the reference point for forming triangles.\r\n\t\t// It's location doesn't change the result (except for rounding error).\r\n\t\tvar pRef = new b2Vec2(0.0, 0.0);\r\n\r\n\t\tvar inv3 = 1.0 / 3.0;\r\n\r\n\t\tfor (var i = 0; i < count; ++i)\r\n\t\t{\r\n\t\t\t// Triangle vertices.\r\n\t\t\tvar p1 = pRef;\r\n\t\t\tvar p2 = vs[i];\r\n\t\t\tvar p3 = i + 1 < count ? vs[i+1] : vs[0];\r\n\r\n\t\t\tvar e1 = b2Math.SubtractVV(p2, p1);\r\n\t\t\tvar e2 = b2Math.SubtractVV(p3, p1);\r\n\r\n\t\t\tvar D = b2Math.b2CrossVV(e1, e2);\r\n\r\n\t\t\tvar triangleArea = 0.5 * D;\r\n\t\t\tarea += triangleArea;\r\n\r\n\t\t\t// Area weighted centroid\r\n\t\t\t// center += triangleArea * inv3 * (p1 + p2 + p3);\r\n\t\t\tvar tVec = new b2Vec2();\r\n\t\t\ttVec.SetV(p1);\r\n\t\t\ttVec.sAdd(p2);\r\n\t\t\ttVec.sAdd(p3);\r\n\t\t\ttVec.Multiply(inv3*triangleArea);\r\n\t\t\tcenter.sAdd(tVec);\r\n\r\n\t\t\tvar px = p1.x;\r\n\t\t\tvar py = p1.y;\r\n\t\t\tvar ex1 = e1.x;\r\n\t\t\tvar ey1 = e1.y;\r\n\t\t\tvar ex2 = e2.x;\r\n\t\t\tvar ey2 = e2.y;\r\n\r\n\t\t\tvar intx2 = inv3 * (0.25 * (ex1*ex1 + ex2*ex1 + ex2*ex2) + (px*ex1 + px*ex2)) + 0.5*px*px;\r\n\t\t\tvar inty2 = inv3 * (0.25 * (ey1*ey1 + ey2*ey1 + ey2*ey2) + (py*ey1 + py*ey2)) + 0.5*py*py;\r\n\r\n\t\t\tI += D * (intx2 + inty2);\r\n\t\t}\r\n\r\n\t\t// Total mass\r\n\t\tmassData.mass = rho * area;\r\n\r\n\t\t// Center of mass\r\n\t\t//b2Settings.b2Assert(area > Number.MIN_VALUE);\r\n\t\tcenter.Multiply( 1.0 / area );\r\n\t\tmassData.center = center;\r\n\r\n\t\t// Inertia tensor relative to the center.\r\n\t\tI = rho * (I - area * b2Math2.b2Dot(center, center));\r\n\t\tmassData.I = I;\r\n\t};\r\nexports.PolyCentroid = function(vs, count, out)\r\n\t{\r\n\t\t//b2Settings.b2Assert(count >= 3);\r\n\r\n\t\t//b2Vec2 c; c.Set(0.0f, 0.0f);\r\n\t\tvar cX = 0.0;\r\n\t\tvar cY = 0.0;\r\n\t\t//float32 area = 0.0f;\r\n\t\tvar area = 0.0;\r\n\r\n\t\t// pRef is the reference point for forming triangles.\r\n\t\t// It's location doesn't change the result (except for rounding error).\r\n\t\t//b2Vec2 pRef(0.0f, 0.0f);\r\n\t\tvar pRefX = 0.0;\r\n\t\tvar pRefY = 0.0;\r\n\t/*\r\n\t\t// This code would put the reference point inside the polygon.\r\n\t\tfor (var i = 0; i < count; ++i)\r\n\t\t{\r\n\t\t\t//pRef += vs[i];\r\n\t\t\tpRef.x += vs[i].x;\r\n\t\t\tpRef.y += vs[i].y;\r\n\t\t}\r\n\t\tpRef.x *= 1.0 / count;\r\n\t\tpRef.y *= 1.0 / count;\r\n\t*/\r\n\r\n\t\t//const float32 inv3 = 1.0f / 3.0f;\r\n\t\tvar inv3 = 1.0 / 3.0;\r\n\r\n\t\tfor (var i = 0; i < count; ++i)\r\n\t\t{\r\n\t\t\t// Triangle vertices.\r\n\t\t\t//b2Vec2 p1 = pRef;\r\n\t\t\tvar p1X = pRefX;\r\n\t\t\tvar p1Y = pRefY;\r\n\t\t\t//b2Vec2 p2 = vs[i];\r\n\t\t\tvar p2X = vs[i].x;\r\n\t\t\tvar p2Y = vs[i].y;\r\n\t\t\t//b2Vec2 p3 = i + 1 < count ? vs[i+1] : vs[0];\r\n\t\t\tvar p3X = i + 1 < count ? vs[i+1].x : vs[0].x;\r\n\t\t\tvar p3Y = i + 1 < count ? vs[i+1].y : vs[0].y;\r\n\r\n\t\t\t//b2Vec2 e1 = p2 - p1;\r\n\t\t\tvar e1X = p2X - p1X;\r\n\t\t\tvar e1Y = p2Y - p1Y;\r\n\t\t\t//b2Vec2 e2 = p3 - p1;\r\n\t\t\tvar e2X = p3X - p1X;\r\n\t\t\tvar e2Y = p3Y - p1Y;\r\n\r\n\t\t\t//float32 D = b2Cross(e1, e2);\r\n\t\t\tvar D = (e1X * e2Y - e1Y * e2X);\r\n\r\n\t\t\t//float32 triangleArea = 0.5f * D;\r\n\t\t\tvar triangleArea = 0.5 * D;\r\n\t\t\tarea += triangleArea;\r\n\r\n\t\t\t// Area weighted centroid\r\n\t\t\t//c += triangleArea * inv3 * (p1 + p2 + p3);\r\n\t\t\tcX += triangleArea * inv3 * (p1X + p2X + p3X);\r\n\t\t\tcY += triangleArea * inv3 * (p1Y + p2Y + p3Y);\r\n\t\t}\r\n\r\n\t\t// Centroid\r\n\t\t//b2Settings.b2Assert(area > Number.MIN_VALUE);\r\n\t\tcX *= 1.0 / area;\r\n\t\tcY *= 1.0 / area;\r\n\r\n\t\t// Replace return with 'out' vector\r\n\t\t//return c;\r\n\t\tout.Set(cX, cY);\r\n\t};\r\n","pre":true},"./src/box2d/common/math/b2Math.js":{"path":"./src/box2d/common/math/b2Math.js","friendlyPath":"...common.math.b2Math","directory":"./src/box2d/common/math/","filename":"b2Math.js","src":"﻿/* * Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\njsio(\"import .b2Vec2 as b2Vec2\");\r\njsio(\"import .b2Mat22 as b2Mat22\");\r\n\r\nb2Math=__class__;var b2Math=b2Math(function b2Math(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\t/*static public function b2InvSqrt(x)\r\n\t{\r\n\t\tfloat32 xhalf = 0.5f * x;\r\n\t\tint32 i = *(int32*)&x;\r\n\t\ti = 0x5f3759df - (i >> 1);\r\n\t\tx = *(float32*)&i;\r\n\t\tx = x * (1.5f - xhalf * x * x);\r\n\t\treturn x;\r\n\t}*/\r\n\r\n\t// A * B\r\n\r\n\t// A^T * B\r\n\r\n\t// exports.b2Random number in range [-1,1]\r\n\r\n\t/*inline float32 exports.b2Random(float32 lo, float32 hi)\r\n\t{\r\n\t\tfloat32 r = (float32)rand();\r\n\t\tr /= RAND_MAX;\r\n\t\tr = (hi - lo) * r + lo;\r\n\t\treturn r;\r\n\t}*/\r\n\r\n\t// \"Next Largest Power of 2\r\n\t// Given a binary integer value x, the next largest power of 2 can be computed by a SWAR algorithm\r\n\t// that recursively \"folds\" the upper bits into the lower bits. This process yields a bit vector with\r\n\t// the same most significant 1, but all 1's below it. Adding 1 to that value yields the next\r\n\t// largest power of 2. For a 32-bit value:\"\r\n\r\n\t// Temp vector functions to reduce calls to 'new'\r\n\t/*static public var tempVec = new b2Vec2();\r\n\r\n\tstatic public var tempAABB = new b2AABB();\t*/\r\n\r\n\tthis.init = function() {};\r\n});\r\n\r\n\r\n//b2Math.b2IsValid = function(x)\r\n//\t{\r\n//\t\treturn isFinite(x);\r\n//\t};\r\n//b2Math.b2Dot = function(a, b)\r\n//\t{\r\n//\t\treturn a.x * b.x + a.y * b.y;\r\n//\t};\r\nb2Math.b2CrossVV = function(a, b)\r\n\t{\r\n\t\treturn a.x * b.y - a.y * b.x;\r\n\t};\r\nb2Math.b2CrossVF = function(a, s)\r\n\t{\r\n\t\tvar v = new b2Vec2(s * a.y, -s * a.x);\r\n\t\treturn v;\r\n\t};\r\nb2Math.b2CrossFV = function(s, a)\r\n\t{\r\n\t\tvar v = new b2Vec2(-s * a.y, s * a.x);\r\n\t\treturn v;\r\n\t};\r\nb2Math.b2MulMV = function(A, v)\r\n\t{\r\n\t\tvar u = new b2Vec2(A.col1.x * v.x + A.col2.x * v.y, A.col1.y * v.x + A.col2.y * v.y);\r\n\t\treturn u;\r\n\t};\r\nb2Math.b2MulTMV = function(A, v)\r\n\t{\r\n\t\tvar u = new b2Vec2(b2Math.b2Dot(v, A.col1), b2Math.b2Dot(v, A.col2));\r\n\t\treturn u;\r\n\t};\r\nb2Math.AddVV = function(a, b)\r\n\t{\r\n\t\tvar v = new b2Vec2(a.x + b.x, a.y + b.y);\r\n\t\treturn v;\r\n\t};\r\nb2Math.SubtractVV = function(a, b)\r\n\t{\r\n\t\tvar v = new b2Vec2(a.x - b.x, a.y - b.y);\r\n\t\treturn v;\r\n\t};\r\nb2Math.MulFV = function(s, a)\r\n\t{\r\n\t\tvar v = new b2Vec2(s * a.x, s * a.y);\r\n\t\treturn v;\r\n\t};\r\nb2Math.AddMM = function(A, B)\r\n\t{\r\n\t\tvar C = new b2Mat22(0, b2Math.AddVV(A.col1, B.col1), b2Math.AddVV(A.col2, B.col2));\r\n\t\treturn C;\r\n\t};\r\nb2Math.b2MulMM = function(A, B)\r\n\t{\r\n\t\tvar C = new b2Mat22(0, b2Math.b2MulMV(A, B.col1), b2Math.b2MulMV(A, B.col2));\r\n\t\treturn C;\r\n\t};\r\nb2Math.b2MulTMM = function(A, B)\r\n\t{\r\n\t\tvar c1 = new b2Vec2(b2Math.b2Dot(A.col1, B.col1), b2Math.b2Dot(A.col2, B.col1));\r\n\t\tvar c2 = new b2Vec2(b2Math.b2Dot(A.col1, B.col2), b2Math.b2Dot(A.col2, B.col2));\r\n\t\tvar C = new b2Mat22(0, c1, c2);\r\n\t\treturn C;\r\n\t};\r\nb2Math.b2Abs = function(a)\r\n\t{\r\n\t\treturn a > 0.0 ? a : -a;\r\n\t};\r\nb2Math.b2AbsV = function(a)\r\n\t{\r\n\t\tvar b = new b2Vec2(b2Math.b2Abs(a.x), b2Math.b2Abs(a.y));\r\n\t\treturn b;\r\n\t};\r\nb2Math.b2AbsM = function(A)\r\n\t{\r\n\t\tvar B = new b2Mat22(0, b2Math.b2AbsV(A.col1), b2Math.b2AbsV(A.col2));\r\n\t\treturn B;\r\n\t};\r\nb2Math.b2Min = function(a, b)\r\n\t{\r\n\t\treturn a < b ? a : b;\r\n\t};\r\nb2Math.b2MinV = function(a, b)\r\n\t{\r\n\t\tvar c = new b2Vec2(b2Math.b2Min(a.x, b.x), b2Math.b2Min(a.y, b.y));\r\n\t\treturn c;\r\n\t};\r\nb2Math.b2Max = function(a, b)\r\n\t{\r\n\t\treturn a > b ? a : b;\r\n\t};\r\nb2Math.b2MaxV = function(a, b)\r\n\t{\r\n\t\tvar c = new b2Vec2(b2Math.b2Max(a.x, b.x), b2Math.b2Max(a.y, b.y));\r\n\t\treturn c;\r\n\t};\r\nb2Math.b2Clamp = function(a, low, high)\r\n\t{\r\n\t\treturn b2Math.b2Max(low, b2Math.b2Min(a, high));\r\n\t};\r\nb2Math.b2ClampV = function(a, low, high)\r\n\t{\r\n\t\treturn b2Math.b2MaxV(low, b2Math.b2MinV(a, high));\r\n\t};\r\nb2Math.b2Swap = function(a, b)\r\n\t{\r\n\t\tvar tmp = a[0];\r\n\t\ta[0] = b[0];\r\n\t\tb[0] = tmp;\r\n\t};\r\nb2Math.b2Random = function()\r\n\t{\r\n\t\treturn Math.random() * 2 - 1;\r\n\t};\r\nb2Math.b2NextPowerOfTwo = function(x)\r\n\t{\r\n\t\tx |= (x >> 1) & 0x7FFFFFFF;\r\n\t\tx |= (x >> 2) & 0x3FFFFFFF;\r\n\t\tx |= (x >> 4) & 0x0FFFFFFF;\r\n\t\tx |= (x >> 8) & 0x00FFFFFF;\r\n\t\tx |= (x >> 16)& 0x0000FFFF;\r\n\t\treturn x + 1;\r\n\t};\r\nb2Math.b2IsPowerOfTwo = function(x)\r\n\t{\r\n\t\tvar result = x > 0 && (x & (x - 1)) == 0;\r\n\t\treturn result;\r\n\t};\r\n\r\n//b2Math.tempVec2 = new b2Vec2();\r\n//b2Math.tempVec3 = new b2Vec2();\r\n//b2Math.tempVec4 = new b2Vec2();\r\n//b2Math.tempVec5 = new b2Vec2();\r\n//b2Math.tempMat = new b2Mat22();\r\n\r\nexports = b2Math;\r\n","pre":true},"./src/box2d/common/math/b2Mat22.js":{"path":"./src/box2d/common/math/b2Mat22.js","friendlyPath":".b2Mat22","directory":"./src/box2d/common/math/","filename":"b2Mat22.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\njsio(\"import .b2Vec2 as b2Vec2\");\r\n\r\nvar src_box2d_common_math_b2Mat22=__class__;var b2Mat22 = exports=src_box2d_common_math_b2Mat22(function src_box2d_common_math_b2Mat22(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\r\n\tthis.init = function(angle, c1, c2) {\r\n\t\tif (angle==null) angle = 0;\r\n\r\n\t\tthis.col1 = new b2Vec2();\r\n\t\tthis.col2 = new b2Vec2();\r\n\r\n\t\tif (c1!=null && c2!=null){\r\n\t\t\tthis.col1.SetV(c1);\r\n\t\t\tthis.col2.SetV(c2);\r\n\t\t} else{\r\n\t\t\tvar c = Math.cos(angle);\r\n\t\t\tvar s = Math.sin(angle);\r\n\t\t\tthis.col1.x = c; this.col2.x = -s;\r\n\t\t\tthis.col1.y = s; this.col2.y = c;\r\n\t\t}\r\n\t};\r\n\r\n\tthis.Set = function(angle)\r\n\t{\r\n\t\tvar c = Math.cos(angle);\r\n\t\tvar s = Math.sin(angle);\r\n\t\tthis.col1.x = c; this.col2.x = -s;\r\n\t\tthis.col1.y = s; this.col2.y = c;\r\n\t};\r\n\r\n\tthis.SetVV = function(c1, c2)\r\n\t{\r\n\t\tthis.col1.SetV(c1);\r\n\t\tthis.col2.SetV(c2);\r\n\t};\r\n\r\n\tthis.Copy = function(){\r\n\t\treturn new b2Mat22(0, this.col1, this.col2);\r\n\t};\r\n\r\n\tthis.SetM = function(m)\r\n\t{\r\n\t\tthis.col1.SetV(m.col1);\r\n\t\tthis.col2.SetV(m.col2);\r\n\t};\r\n\r\n\tthis.AddM = function(m)\r\n\t{\r\n\t\tthis.col1.x += m.col1.x;\r\n\t\tthis.col1.y += m.col1.y;\r\n\t\tthis.col2.x += m.col2.x;\r\n\t\tthis.col2.y += m.col2.y;\r\n\t};\r\n\r\n\tthis.SetIdentity = function()\r\n\t{\r\n\t\tthis.col1.x = 1.0; this.col2.x = 0.0;\r\n\t\tthis.col1.y = 0.0; this.col2.y = 1.0;\r\n\t};\r\n\r\n\tthis.SetZero = function()\r\n\t{\r\n\t\tthis.col1.x = 0.0; this.col2.x = 0.0;\r\n\t\tthis.col1.y = 0.0; this.col2.y = 0.0;\r\n\t};\r\n\r\n\tthis.Invert = function(out)\r\n\t{\r\n\t\tvar a = this.col1.x;\r\n\t\tvar b = this.col2.x;\r\n\t\tvar c = this.col1.y;\r\n\t\tvar d = this.col2.y;\r\n\t\t//var B = new b2Mat22();\r\n\t\tvar det = a * d - b * c;\r\n\t\t//b2Settings.b2Assert(det != 0.0);\r\n\t\tdet = 1.0 / det;\r\n\t\tout.col1.x =  det * d;\tout.col2.x = -det * b;\r\n\t\tout.col1.y = -det * c;\tout.col2.y =  det * a;\r\n\t\treturn out;\r\n\t};\r\n\r\n\t// this.Solve A * x = b\r\n\tthis.Solve = function(out, bX, bY)\r\n\t{\r\n\t\t//float32 a11 = this.col1.x, a12 = this.col2.x, a21 = this.col1.y, a22 = this.col2.y;\r\n\t\tvar a11 = this.col1.x;\r\n\t\tvar a12 = this.col2.x;\r\n\t\tvar a21 = this.col1.y;\r\n\t\tvar a22 = this.col2.y;\r\n\t\t//float32 det = a11 * a22 - a12 * a21;\r\n\t\tvar det = a11 * a22 - a12 * a21;\r\n\t\t//b2Settings.b2Assert(det != 0.0);\r\n\t\tdet = 1.0 / det;\r\n\t\tout.x = det * (a22 * bX - a12 * bY);\r\n\t\tout.y = det * (a11 * bY - a21 * bX);\r\n\r\n\t\treturn out;\r\n\t};\r\n\r\n\tthis.Abs = function()\r\n\t{\r\n\t\tthis.col1.Abs();\r\n\t\tthis.col2.Abs();\r\n\t};\r\n});\r\n","pre":true},"./src/box2d/collision/b2Pair.js":{"path":"./src/box2d/collision/b2Pair.js","friendlyPath":"..b2Pair","directory":"./src/box2d/collision/","filename":"b2Pair.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n// The pair manager is used by the broad-phase to quickly add/remove/find pairs\r\n// of overlapping proxies. It is based closely on code provided by Pierre Terdiman.\r\n// http:\r\n\r\n\r\njsio(\"import ..common.b2Settings as b2Settings\"); \r\n\r\nb2Pair=__class__;var b2Pair=b2Pair(function b2Pair(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\r\n\tthis.SetBuffered = function()\t{ this.status |= b2Pair.e_pairBuffered; };\r\n\tthis.ClearBuffered = function()\t{ this.status &= ~b2Pair.e_pairBuffered; };\r\n\tthis.IsBuffered = function(){ return (this.status & b2Pair.e_pairBuffered) == b2Pair.e_pairBuffered; };\r\n\r\n\tthis.SetRemoved = function()\t\t{ this.status |= b2Pair.e_pairRemoved; };\r\n\tthis.ClearRemoved = function()\t{ this.status &= ~b2Pair.e_pairRemoved; };\r\n\tthis.IsRemoved = function(){ return (this.status & b2Pair.e_pairRemoved) == b2Pair.e_pairRemoved; };\r\n\r\n\tthis.SetFinal = function()\t\t{ this.status |= b2Pair.e_pairFinal; };\r\n\tthis.IsFinal = function(){ return (this.status & b2Pair.e_pairFinal) == b2Pair.e_pairFinal; };\r\n\r\n\r\n\r\n\t// enum\r\n\r\n\tthis.init = function() {\r\n\t\tthis.userData = null;\r\n\t\tthis.proxyId1 = 0;\r\n\t\tthis.proxyId2 = 0;\r\n\t\tthis.next = 0;\r\n\t\tthis.status = 0;\r\n\t};\r\n});\r\n\r\n// STATIC\r\nb2Pair.b2_nullPair = b2Settings.USHRT_MAX;\r\nb2Pair.b2_nullProxy = b2Settings.USHRT_MAX;\r\nb2Pair.b2_tableCapacity = b2Settings.b2_maxPairs;\r\nb2Pair.b2_tableMask = b2Pair.b2_tableCapacity - 1;\r\nb2Pair.e_pairBuffered = 0x0001;\r\nb2Pair.e_pairRemoved = 0x0002;\r\nb2Pair.e_pairFinal = 0x0004;\r\n\r\nexports = b2Pair;\r\n","pre":true},"./src/box2d/common/b2Settings.js":{"path":"./src/box2d/common/b2Settings.js","friendlyPath":"..common.b2Settings","directory":"./src/box2d/common/","filename":"b2Settings.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\nvar src_box2d_common_b2Settings=__class__;var b2Settings = exports=src_box2d_common_b2Settings(function src_box2d_common_b2Settings(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\r\n\r\n\r\n\t// Define your unit system here. The default system is\r\n\t// meters-kilograms-seconds. For the tuning to work well,\r\n\t// your dynamic objects should be bigger than a pebble and smaller\r\n\t// than a house.\r\n\t//static public const b2Settings.b2_lengthUnitsPerMeter = 1.0;\r\n\r\n\t// Use this for pixels:\r\n\r\n\t// Global tuning constants based on MKS units.\r\n\r\n\t// Collision\r\n\r\n\t// Dynamics\r\n\r\n\t// Sleep\r\n\r\n\t// assert\r\n\r\n\tthis.init = function() {};\r\n});\r\n\r\nb2Settings.USHRT_MAX = 0x0000ffff;\r\nb2Settings.b2_pi = Math.PI;\r\nb2Settings.b2_massUnitsPerKilogram = 1.0;\r\nb2Settings.b2_timeUnitsPerSecond = 1.0;\r\nb2Settings.b2_lengthUnitsPerMeter = 30.0;\r\nb2Settings.b2_maxManifoldPoints = 2;\r\nb2Settings.b2_maxShapesPerBody = 64;\r\nb2Settings.b2_maxPolyVertices = 8;\r\nb2Settings.b2_maxProxies = 1024;\r\nb2Settings.b2_maxPairs = 8 * b2Settings.b2_maxProxies;\r\nb2Settings.b2_linearSlop = 0.005 * b2Settings.b2_lengthUnitsPerMeter;\r\nb2Settings.b2_angularSlop = 2.0 / 180.0 * b2Settings.b2_pi;\r\nb2Settings.b2_velocityThreshold = 1.0 * b2Settings.b2_lengthUnitsPerMeter / b2Settings.b2_timeUnitsPerSecond;\r\nb2Settings.b2_maxLinearCorrection = 0.2 * b2Settings.b2_lengthUnitsPerMeter;\r\nb2Settings.b2_maxAngularCorrection = 8.0 / 180.0 * b2Settings.b2_pi;\r\nb2Settings.b2_contactBaumgarte = 0.2;\r\nb2Settings.b2_timeToSleep = 0.5 * b2Settings.b2_timeUnitsPerSecond;\r\nb2Settings.b2_linearSleepTolerance = 0.01 * b2Settings.b2_lengthUnitsPerMeter / b2Settings.b2_timeUnitsPerSecond;\r\nb2Settings.b2_angularSleepTolerance = 2.0 / 180.0 / b2Settings.b2_timeUnitsPerSecond;\r\nb2Settings.b2Assert = function(a)\r\n\t{\r\n\t\tif (!a){\r\n\t\t\tvar nullVec;\r\n\t\t\tnullVec.x++;\r\n\t\t}\r\n\t};\r\n\r\nexports = b2Settings;\r\n","pre":true},"./src/box2d/dynamics/b2World.js":{"path":"./src/box2d/dynamics/b2World.js","friendlyPath":"src.box2d.dynamics.b2World","directory":"./src/box2d/dynamics/","filename":"b2World.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\njsio(\"import ..common.math.b2Math as b2Math\");\r\njsio(\"import .b2ContactManager as b2ContactManager\");\r\njsio(\"import .b2CollisionFilter as b2CollisionFilter\");\r\njsio(\"import .b2TimeStep as b2TimeStep\");\r\njsio(\"import .b2Body as b2Body\");\r\njsio(\"import .b2BodyDef as b2BodyDef\");\r\njsio(\"import .b2Island as b2Island\");\r\njsio(\"import .contacts.b2Contact as b2Contact\");\r\njsio(\"import .joints.b2JointFactory as b2JointFactory\");\r\n\r\njsio(\"import ..collision.b2BroadPhase as b2BroadPhase\");\r\n\r\n\r\nb2World=__class__;var b2World=b2World(function b2World(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\r\n\tthis.init = function(worldAABB, gravity, doSleep){\r\n\r\n\t\tthis.m_blockAllocator = null;\r\n\t\tthis.m_stackAllocator = null;\r\n\t\tthis.m_positionIterationCount = 0;\r\n\r\n\t\t// initialize instance variables for references\r\n\t\tthis.step = new b2TimeStep();\r\n\t\tthis.m_contactManager = new b2ContactManager();\r\n\r\n\t\tthis.m_listener = null;\r\n\t\tthis.m_filter = b2CollisionFilter.b2_defaultFilter;\r\n\r\n\t\tthis.m_bodyList = null;\r\n\t\tthis.m_contactList = null;\r\n\t\tthis.m_jointList = null;\r\n\r\n\t\tthis.m_bodyCount = 0;\r\n\t\tthis.m_contactCount = 0;\r\n\t\tthis.m_jointCount = 0;\r\n\r\n\t\tthis.m_bodyDestroyList = null;\r\n\r\n\t\tthis.m_allowSleep = doSleep;\r\n\r\n\t\tthis.m_gravity = gravity;\r\n\r\n\t\tthis.m_contactManager.m_world = this;\r\n\t\tthis.m_broadPhase = new b2BroadPhase(worldAABB, this.m_contactManager);\r\n\r\n\t\tvar bd = new b2BodyDef();\r\n\t\tthis.m_groundBody = this.CreateBody(bd);\r\n\t};\r\n\r\n\t//~b2World(){\r\n\t//\tthis.DestroyBody(this.m_groundBody);\r\n\t//\tdelete this.m_broadPhase;\r\n\t//}\r\n\r\n\t// Set a callback to notify you when a joint is implicitly destroyed\r\n\t// when an attached body is destroyed.\r\n\tthis.SetListener = function(listener){\r\n\t\tthis.m_listener = listener;\r\n\t};\r\n\r\n\t// Register a collision filter to provide specific control over collision.\r\n\t// Otherwise the default filter is used (b2CollisionFilter).\r\n\tthis.SetFilter = function(filter){\r\n\t\tthis.m_filter = filter;\r\n\t};\r\n\r\n\t// Create and destroy rigid bodies. Destruction is deferred until the\r\n\t// the next call to this.Step. This is done so that bodies may be destroyed\r\n\t// while you iterate through the contact list.\r\n\tthis.CreateBody = function(def){\r\n\t\t//void* mem = this.m_blockAllocator.Allocate(sizeof(b2Body));\r\n\t\tvar b = new b2Body(def, this);\r\n\t\tb.m_prev = null;\r\n\r\n\t\tb.m_next = this.m_bodyList;\r\n\t\tif (this.m_bodyList)\r\n\t\t{\r\n\t\t\tthis.m_bodyList.m_prev = b;\r\n\t\t}\r\n\t\tthis.m_bodyList = b;\r\n\t\t++this.m_bodyCount;\r\n\r\n\t\treturn b;\r\n\t};\r\n\t// Body destruction is deferred to make contact processing more robust.\r\n\tthis.DestroyBody = function(b)\r\n\t{\r\n\r\n\t\tif (b.m_flags & b2Body.e_destroyFlag)\r\n\t\t{\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Remove from normal body list.\r\n\t\tif (b.m_prev)\r\n\t\t{\r\n\t\t\tb.m_prev.m_next = b.m_next;\r\n\t\t}\r\n\r\n\t\tif (b.m_next)\r\n\t\t{\r\n\t\t\tb.m_next.m_prev = b.m_prev;\r\n\t\t}\r\n\r\n\t\tif (b == this.m_bodyList)\r\n\t\t{\r\n\t\t\tthis.m_bodyList = b.m_next;\r\n\t\t}\r\n\r\n\t\tb.m_flags |= b2Body.e_destroyFlag;\r\n\t\t//b2Settings.b2Assert(this.m_bodyCount > 0);\r\n\t\t--this.m_bodyCount;\r\n\r\n\t\t//b->~b2Body();\r\n\t\t//b.Destroy();\r\n\t\t// Add to the deferred destruction list.\r\n\t\tb.m_prev = null;\r\n\t\tb.m_next = this.m_bodyDestroyList;\r\n\t\tthis.m_bodyDestroyList = b;\r\n\t};\r\n\r\n\tthis.CleanBodyList = function()\r\n\t{\r\n\t\tthis.m_contactManager.m_destroyImmediate = true;\r\n\r\n\t\tvar b = this.m_bodyDestroyList;\r\n\t\twhile (b)\r\n\t\t{\r\n\t\t\t//b2Settings.b2Assert((b.m_flags & b2Body.e_destroyFlag) != 0);\r\n\r\n\t\t\t// Preserve the next pointer.\r\n\t\t\tvar b0 = b;\r\n\t\t\tb = b.m_next;\r\n\r\n\t\t\t// Delete the attached joints\r\n\t\t\tvar jn = b0.m_jointList;\r\n\t\t\twhile (jn)\r\n\t\t\t{\r\n\t\t\t\tvar jn0 = jn;\r\n\t\t\t\tjn = jn.next;\r\n\r\n\t\t\t\tif (this.m_listener)\r\n\t\t\t\t{\r\n\t\t\t\t\tthis.m_listener.NotifyJointDestroyed(jn0.joint);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tthis.DestroyJoint(jn0.joint);\r\n\t\t\t}\r\n\r\n\t\t\tb0.Destroy();\r\n\t\t\t//this.m_blockAllocator.Free(b0, sizeof(b2Body));\r\n\t\t}\r\n\r\n\t\t// Reset the list.\r\n\t\tthis.m_bodyDestroyList = null;\r\n\r\n\t\tthis.m_contactManager.m_destroyImmediate = false;\r\n\t};\r\n\r\n\tthis.CreateJoint = function(def){\r\n\t\tvar j = b2JointFactory.Create(def, this.m_blockAllocator);\r\n\r\n\t\t// Connect to the world list.\r\n\t\tj.m_prev = null;\r\n\t\tj.m_next = this.m_jointList;\r\n\t\tif (this.m_jointList)\r\n\t\t{\r\n\t\t\tthis.m_jointList.m_prev = j;\r\n\t\t}\r\n\t\tthis.m_jointList = j;\r\n\t\t++this.m_jointCount;\r\n\r\n\t\t// Connect to the bodies\r\n\t\tj.m_node1.joint = j;\r\n\t\tj.m_node1.other = j.m_body2;\r\n\t\tj.m_node1.prev = null;\r\n\t\tj.m_node1.next = j.m_body1.m_jointList;\r\n\t\tif (j.m_body1.m_jointList) j.m_body1.m_jointList.prev = j.m_node1;\r\n\t\tj.m_body1.m_jointList = j.m_node1;\r\n\r\n\t\tj.m_node2.joint = j;\r\n\t\tj.m_node2.other = j.m_body1;\r\n\t\tj.m_node2.prev = null;\r\n\t\tj.m_node2.next = j.m_body2.m_jointList;\r\n\t\tif (j.m_body2.m_jointList) j.m_body2.m_jointList.prev = j.m_node2;\r\n\t\tj.m_body2.m_jointList = j.m_node2;\r\n\r\n\t\t// If the joint prevents collisions, then reset collision filtering.\r\n\t\tif (def.collideConnected == false)\r\n\t\t{\r\n\t\t\t// Reset the proxies on the body with the minimum number of shapes.\r\n\t\t\tvar b = def.body1.m_shapeCount < def.body2.m_shapeCount ? def.body1 : def.body2;\r\n\t\t\tfor (var s = b.m_shapeList; s; s = s.m_next)\r\n\t\t\t{\r\n\t\t\t\ts.ResetProxy(this.m_broadPhase);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn j;\r\n\t};\r\n\tthis.DestroyJoint = function(j)\r\n\t{\r\n\r\n\t\tvar collideConnected = j.m_collideConnected;\r\n\r\n\t\t// Remove from the world.\r\n\t\tif (j.m_prev)\r\n\t\t{\r\n\t\t\tj.m_prev.m_next = j.m_next;\r\n\t\t}\r\n\r\n\t\tif (j.m_next)\r\n\t\t{\r\n\t\t\tj.m_next.m_prev = j.m_prev;\r\n\t\t}\r\n\r\n\t\tif (j == this.m_jointList)\r\n\t\t{\r\n\t\t\tthis.m_jointList = j.m_next;\r\n\t\t}\r\n\r\n\t\t// Disconnect from island graph.\r\n\t\tvar body1 = j.m_body1;\r\n\t\tvar body2 = j.m_body2;\r\n\r\n\t\t// Wake up touching bodies.\r\n\t\tbody1.WakeUp();\r\n\t\tbody2.WakeUp();\r\n\r\n\t\t// Remove from body 1\r\n\t\tif (j.m_node1.prev)\r\n\t\t{\r\n\t\t\tj.m_node1.prev.next = j.m_node1.next;\r\n\t\t}\r\n\r\n\t\tif (j.m_node1.next)\r\n\t\t{\r\n\t\t\tj.m_node1.next.prev = j.m_node1.prev;\r\n\t\t}\r\n\r\n\t\tif (j.m_node1 == body1.m_jointList)\r\n\t\t{\r\n\t\t\tbody1.m_jointList = j.m_node1.next;\r\n\t\t}\r\n\r\n\t\tj.m_node1.prev = null;\r\n\t\tj.m_node1.next = null;\r\n\r\n\t\t// Remove from body 2\r\n\t\tif (j.m_node2.prev)\r\n\t\t{\r\n\t\t\tj.m_node2.prev.next = j.m_node2.next;\r\n\t\t}\r\n\r\n\t\tif (j.m_node2.next)\r\n\t\t{\r\n\t\t\tj.m_node2.next.prev = j.m_node2.prev;\r\n\t\t}\r\n\r\n\t\tif (j.m_node2 == body2.m_jointList)\r\n\t\t{\r\n\t\t\tbody2.m_jointList = j.m_node2.next;\r\n\t\t}\r\n\r\n\t\tj.m_node2.prev = null;\r\n\t\tj.m_node2.next = null;\r\n\r\n\t\tb2Joint.Destroy(j, this.m_blockAllocator);\r\n\r\n\t\t//b2Settings.b2Assert(this.m_jointCount > 0);\r\n\t\t--this.m_jointCount;\r\n\r\n\t\t// If the joint prevents collisions, then reset collision filtering.\r\n\t\tif (collideConnected == false)\r\n\t\t{\r\n\t\t\t// Reset the proxies on the body with the minimum number of shapes.\r\n\t\t\tvar b = body1.m_shapeCount < body2.m_shapeCount ? body1 : body2;\r\n\t\t\tfor (var s = b.m_shapeList; s; s = s.m_next)\r\n\t\t\t{\r\n\t\t\t\ts.ResetProxy(this.m_broadPhase);\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\t// The world provides a single ground body with no collision shapes. You\r\n\t// can use this to simplify the creation of joints.\r\n\tthis.GetGroundBody = function(){\r\n\t\treturn this.m_groundBody;\r\n\t};\r\n\r\n\r\n\tthis.step = new b2TimeStep();\r\n\t// this.Step\r\n\tthis.Step = function(dt, iterations){\r\n\r\n\t\tvar b;\r\n\t\tvar other;\r\n\r\n\r\n\t\tthis.step.dt = dt;\r\n\t\tthis.step.iterations\t= iterations;\r\n\t\tif (dt > 0.0)\r\n\t\t{\r\n\t\t\tthis.step.inv_dt = 1.0 / dt;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tthis.step.inv_dt = 0.0;\r\n\t\t}\r\n\r\n\t\tthis.m_positionIterationCount = 0;\r\n\r\n\t\t// Handle deferred contact destruction.\r\n\t\tthis.m_contactManager.CleanContactList();\r\n\r\n\t\t// Handle deferred body destruction.\r\n\t\tthis.CleanBodyList();\r\n\r\n\t\t// Update contacts.\r\n\t\tthis.m_contactManager.Collide();\r\n\r\n\t\t// Size the island for the worst case.\r\n\t\tvar island = new b2Island(this.m_bodyCount, this.m_contactCount, this.m_jointCount, this.m_stackAllocator);\r\n\r\n\t\t// Clear all the island flags.\r\n\t\tfor (b = this.m_bodyList; b != null; b = b.m_next)\r\n\t\t{\r\n\t\t\tb.m_flags &= ~b2Body.e_islandFlag;\r\n\t\t}\r\n\t\tfor (var c = this.m_contactList; c != null; c = c.m_next)\r\n\t\t{\r\n\t\t\tc.m_flags &= ~b2Contact.e_islandFlag;\r\n\t\t}\r\n\t\tfor (var j = this.m_jointList; j != null; j = j.m_next)\r\n\t\t{\r\n\t\t\tj.m_islandFlag = false;\r\n\t\t}\r\n\r\n\t\t// Build and simulate all awake islands.\r\n\t\tvar stackSize = this.m_bodyCount;\r\n\t\t//var stack = (b2Body**)this.m_stackAllocator.Allocate(stackSize * sizeof(b2Body*));\r\n\t\tvar stack = new Array(this.m_bodyCount);\r\n\t\tfor (var k = 0; k < this.m_bodyCount; k++)\r\n\t\t\tstack[k] = null;\r\n\r\n\t\tfor (var seed = this.m_bodyList; seed != null; seed = seed.m_next)\r\n\t\t{\r\n\t\t\tif (seed.m_flags & (b2Body.e_staticFlag | b2Body.e_islandFlag | b2Body.e_sleepFlag | b2Body.e_frozenFlag))\r\n\t\t\t{\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\t// Reset island and stack.\r\n\t\t\tisland.Clear();\r\n\t\t\tvar stackCount = 0;\r\n\t\t\tstack[stackCount++] = seed;\r\n\t\t\tseed.m_flags |= b2Body.e_islandFlag;;\r\n\r\n\t\t\t// Perform a depth first search (DFS) on the constraint graph.\r\n\t\t\twhile (stackCount > 0)\r\n\t\t\t{\r\n\t\t\t\t// Grab the next body off the stack and add it to the island.\r\n\t\t\t\tb = stack[--stackCount];\r\n\t\t\t\tisland.AddBody(b);\r\n\r\n\t\t\t\t// Make sure the body is awake.\r\n\t\t\t\tb.m_flags &= ~b2Body.e_sleepFlag;\r\n\r\n\t\t\t\t// To keep islands, we don't\r\n\t\t\t\t// propagate islands across static bodies.\r\n\t\t\t\tif (b.m_flags & b2Body.e_staticFlag)\r\n\t\t\t\t{\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Search all contacts connected to this body.\r\n\t\t\t\tfor (var cn = b.m_contactList; cn != null; cn = cn.next)\r\n\t\t\t\t{\r\n\t\t\t\t\tif (cn.contact.m_flags & b2Contact.e_islandFlag)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tisland.AddContact(cn.contact);\r\n\t\t\t\t\tcn.contact.m_flags |= b2Contact.e_islandFlag;\r\n\r\n\t\t\t\t\tother = cn.other;\r\n\t\t\t\t\tif (other.m_flags & b2Body.e_islandFlag)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t//b2Settings.b2Assert(stackCount < stackSize);\r\n\t\t\t\t\tstack[stackCount++] = other;\r\n\t\t\t\t\tother.m_flags |= b2Body.e_islandFlag;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Search all joints connect to this body.\r\n\t\t\t\tfor (var jn = b.m_jointList; jn != null; jn = jn.next)\r\n\t\t\t\t{\r\n\t\t\t\t\tif (jn.joint.m_islandFlag == true)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tisland.AddJoint(jn.joint);\r\n\t\t\t\t\tjn.joint.m_islandFlag = true;\r\n\r\n\t\t\t\t\tother = jn.other;\r\n\t\t\t\t\tif (other.m_flags & b2Body.e_islandFlag)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t//b2Settings.b2Assert(stackCount < stackSize);\r\n\t\t\t\t\tstack[stackCount++] = other;\r\n\t\t\t\t\tother.m_flags |= b2Body.e_islandFlag;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tisland.Solve(this.step, this.m_gravity);\r\n\r\n\t\t\tthis.m_positionIterationCount = b2Math.b2Max(this.m_positionIterationCount, b2Island.m_positionIterationCount);\r\n\r\n\t\t\tif (this.m_allowSleep)\r\n\t\t\t{\r\n\t\t\t\tisland.UpdateSleep(dt);\r\n\t\t\t}\r\n\r\n\t\t\t// Post solve cleanup.\r\n\t\t\tfor (var i = 0; i < island.m_bodyCount; ++i)\r\n\t\t\t{\r\n\t\t\t\t// Allow static bodies to participate in other islands.\r\n\t\t\t\tb = island.m_bodies[i];\r\n\t\t\t\tif (b.m_flags & b2Body.e_staticFlag)\r\n\t\t\t\t{\r\n\t\t\t\t\tb.m_flags &= ~b2Body.e_islandFlag;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Handle newly frozen bodies.\r\n\t\t\t\tif (b.IsFrozen() && this.m_listener)\r\n\t\t\t\t{\r\n\t\t\t\t\tvar response = this.m_listener.NotifyBoundaryViolated(b);\r\n\t\t\t\t\tif (response == b2WorldListener.b2_destroyBody)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tthis.DestroyBody(b);\r\n\t\t\t\t\t\tb = null;\r\n\t\t\t\t\t\tisland.m_bodies[i] = null;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis.m_broadPhase.Commit();\r\n\r\n\t\t//this.m_stackAllocator.Free(stack);\r\n\t};\r\n\r\n\t// this.Query the world for all shapes that potentially overlap the\r\n\t// provided AABB. You provide a shape pointer buffer of specified\r\n\t// size. The number of shapes found is returned.\r\n\tthis.Query = function(aabb, shapes, maxCount){\r\n\r\n\t\t//void** results = (void**)this.m_stackAllocator.Allocate(maxCount * sizeof(void*));\r\n\t\tvar results = new Array();\r\n\t\tvar count = this.m_broadPhase.QueryAABB(aabb, results, maxCount);\r\n\r\n\t\tfor (var i = 0; i < count; ++i)\r\n\t\t{\r\n\t\t\tshapes[i] = results[i];\r\n\t\t}\r\n\r\n\t\t//this.m_stackAllocator.Free(results);\r\n\t\treturn count;\r\n\t};\r\n\r\n\t// You can use these to iterate over all the bodies, joints, and contacts.\r\n\tthis.GetBodyList = function(){\r\n\t\treturn this.m_bodyList;\r\n\t};\r\n\tthis.GetJointList = function(){\r\n\t\treturn this.m_jointList;\r\n\t};\r\n\tthis.GetContactList = function(){\r\n\t\treturn this.m_contactList;\r\n\t};\r\n\t\r\n});\r\nb2World.s_enablePositionCorrection = 1;\r\nb2World.s_enableWarmStarting = 1;\r\nexports = b2World;\r\n\r\n","pre":true},"./src/box2d/dynamics/b2ContactManager.js":{"path":"./src/box2d/dynamics/b2ContactManager.js","friendlyPath":".b2ContactManager","directory":"./src/box2d/dynamics/","filename":"b2ContactManager.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\njsio(\"import .contacts.b2ContactRegistry as b2Contact\");\r\njsio(\"import .contacts.b2NullContact as b2NullContact\");\r\njsio(\"import ..collision.b2PairCallback as b2PairCallback\");\r\n\r\n//var b2ContactManager = Class.create();\r\n//Object.extend(b2ContactManager.prototype, b2PairCallback.prototype);\r\n//Object.extend(b2ContactManager.prototype, \r\n\r\nvar src_box2d_dynamics_b2ContactManager=__class__;var b2ContactManager = exports=src_box2d_dynamics_b2ContactManager(function src_box2d_dynamics_b2ContactManager(){return this.init&&this.init.apply(this,arguments)},b2PairCallback, function(supr) {\r\n\r\n\tthis.init = function(){\r\n\t\tsupr(this, 'init');\r\n\t\t// The constructor for b2PairCallback\r\n\t\t//\r\n\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_nullContact = new b2NullContact();\r\n\t\t//\r\n\r\n\t\tthis.m_world = null;\r\n\t\tthis.m_destroyImmediate = false;\r\n\t};\r\n\r\n\t// This is a callback from the broadphase when two AABB proxies begin\r\n\t// to overlap. We create a b2Contact to manage the narrow phase.\r\n\tthis.PairAdded = function(proxyUserData1, proxyUserData2){\r\n\t\tvar shape1 = proxyUserData1;\r\n\t\tvar shape2 = proxyUserData2;\r\n\r\n\t\tvar body1 = shape1.m_body;\r\n\t\tvar body2 = shape2.m_body;\r\n\r\n\t\tif (body1.IsStatic() && body2.IsStatic())\r\n\t\t{\r\n\t\t\treturn this.m_nullContact;\r\n\t\t}\r\n\r\n\t\tif (shape1.m_body == shape2.m_body)\r\n\t\t{\r\n\t\t\treturn this.m_nullContact;\r\n\t\t}\r\n\r\n\t\tif (body2.IsConnected(body1))\r\n\t\t{\r\n\t\t\treturn this.m_nullContact;\r\n\t\t}\r\n\r\n\t\tif (this.m_world.m_filter != null && this.m_world.m_filter.ShouldCollide(shape1, shape2) == false)\r\n\t\t{\r\n\t\t\treturn this.m_nullContact;\r\n\t\t}\r\n\r\n\t\t// Ensure that body2 is dynamic (body1 is static or dynamic).\r\n\t\tif (body2.m_invMass == 0.0)\r\n\t\t{\r\n\t\t\tvar tempShape = shape1;\r\n\t\t\tshape1 = shape2;\r\n\t\t\tshape2 = tempShape;\r\n\t\t\t//b2Math.b2Swap(shape1, shape2);\r\n\t\t\tvar tempBody = body1;\r\n\t\t\tbody1 = body2;\r\n\t\t\tbody2 = tempBody;\r\n\t\t\t//b2Math.b2Swap(body1, body2);\r\n\t\t}\r\n\r\n\t\t// Call the factory.\r\n\t\tvar contact = b2Contact.Create(shape1, shape2, this.m_world.m_blockAllocator);\r\n\r\n\t\tif (contact == null)\r\n\t\t{\r\n\t\t\treturn this.m_nullContact;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t// Insert into the world.\r\n\t\t\tcontact.m_prev = null;\r\n\t\t\tcontact.m_next = this.m_world.m_contactList;\r\n\t\t\tif (this.m_world.m_contactList != null)\r\n\t\t\t{\r\n\t\t\t\tthis.m_world.m_contactList.m_prev = contact;\r\n\t\t\t}\r\n\t\t\tthis.m_world.m_contactList = contact;\r\n\t\t\tthis.m_world.m_contactCount++;\r\n\t\t}\r\n\r\n\t\treturn contact;\r\n\t};\r\n\r\n\t// This is a callback from the broadphase when two AABB proxies cease\r\n\t// to overlap. We destroy the b2Contact.\r\n\tthis.PairRemoved = function(proxyUserData1, proxyUserData2, pairUserData){\r\n\r\n\t\tif (pairUserData == null)\r\n\t\t{\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tvar c = pairUserData;\r\n\t\tif (c != this.m_nullContact)\r\n\t\t{\r\n\t\t\t//b2Settings.b2Assert(this.m_world.m_contactCount > 0);\r\n\t\t\tif (this.m_destroyImmediate == true)\r\n\t\t\t{\r\n\t\t\t\tthis.DestroyContact(c);\r\n\t\t\t\tc = null;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tc.m_flags |= b2Contact.e_destroyFlag;\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\tthis.DestroyContact = function(c)\r\n\t{\r\n\r\n\t\t//b2Settings.b2Assert(this.m_world.m_contactCount > 0);\r\n\r\n\t\t// Remove from the world.\r\n\t\tif (c.m_prev)\r\n\t\t{\r\n\t\t\tc.m_prev.m_next = c.m_next;\r\n\t\t}\r\n\r\n\t\tif (c.m_next)\r\n\t\t{\r\n\t\t\tc.m_next.m_prev = c.m_prev;\r\n\t\t}\r\n\r\n\t\tif (c == this.m_world.m_contactList)\r\n\t\t{\r\n\t\t\tthis.m_world.m_contactList = c.m_next;\r\n\t\t}\r\n\r\n\t\t// If there are contact points, then disconnect from the island graph.\r\n\t\tif (c.GetManifoldCount() > 0)\r\n\t\t{\r\n\t\t\tvar body1 = c.m_shape1.m_body;\r\n\t\t\tvar body2 = c.m_shape2.m_body;\r\n\t\t\tvar node1 = c.m_node1;\r\n\t\t\tvar node2 = c.m_node2;\r\n\r\n\t\t\t// Wake up touching bodies.\r\n\t\t\tbody1.WakeUp();\r\n\t\t\tbody2.WakeUp();\r\n\r\n\t\t\t// Remove from body 1\r\n\t\t\tif (node1.prev)\r\n\t\t\t{\r\n\t\t\t\tnode1.prev.next = node1.next;\r\n\t\t\t}\r\n\r\n\t\t\tif (node1.next)\r\n\t\t\t{\r\n\t\t\t\tnode1.next.prev = node1.prev;\r\n\t\t\t}\r\n\r\n\t\t\tif (node1 == body1.m_contactList)\r\n\t\t\t{\r\n\t\t\t\tbody1.m_contactList = node1.next;\r\n\t\t\t}\r\n\r\n\t\t\tnode1.prev = null;\r\n\t\t\tnode1.next = null;\r\n\r\n\t\t\t// Remove from body 2\r\n\t\t\tif (node2.prev)\r\n\t\t\t{\r\n\t\t\t\tnode2.prev.next = node2.next;\r\n\t\t\t}\r\n\r\n\t\t\tif (node2.next)\r\n\t\t\t{\r\n\t\t\t\tnode2.next.prev = node2.prev;\r\n\t\t\t}\r\n\r\n\t\t\tif (node2 == body2.m_contactList)\r\n\t\t\t{\r\n\t\t\t\tbody2.m_contactList = node2.next;\r\n\t\t\t}\r\n\r\n\t\t\tnode2.prev = null;\r\n\t\t\tnode2.next = null;\r\n\t\t}\r\n\r\n\t\t// Call the factory.\r\n\t\tb2Contact.Destroy(c, this.m_world.m_blockAllocator);\r\n\t\t--this.m_world.m_contactCount;\r\n\t};\r\n\r\n\r\n\t// Destroy any contacts marked for deferred destruction.\r\n\tthis.CleanContactList = function()\r\n\t{\r\n\t\tvar c = this.m_world.m_contactList;\r\n\t\twhile (c != null)\r\n\t\t{\r\n\t\t\tvar c0 = c;\r\n\t\t\tc = c.m_next;\r\n\r\n\t\t\tif (c0.m_flags & b2Contact.e_destroyFlag)\r\n\t\t\t{\r\n\t\t\t\tthis.DestroyContact(c0);\r\n\t\t\t\tc0 = null;\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\r\n\t// This is the top level collision call for the time step. Here\r\n\t// all the narrow phase collision is processed for the world\r\n\t// contact list.\r\n\tthis.Collide = function()\r\n\t{\r\n\t\tvar body1;\r\n\t\tvar body2;\r\n\t\tvar node1;\r\n\t\tvar node2;\r\n\r\n\t\tfor (var c = this.m_world.m_contactList; c != null; c = c.m_next)\r\n\t\t{\r\n\t\t\tif (c.m_shape1.m_body.IsSleeping() &&\r\n\t\t\t\tc.m_shape2.m_body.IsSleeping())\r\n\t\t\t{\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tvar oldCount = c.GetManifoldCount();\r\n\t\t\tc.Evaluate();\r\n\r\n\t\t\tvar newCount = c.GetManifoldCount();\r\n\r\n\t\t\tif (oldCount == 0 && newCount > 0)\r\n\t\t\t{\r\n\t\t\t\t//b2Settings.b2Assert(c.GetManifolds().pointCount > 0);\r\n\r\n\t\t\t\t// Connect to island graph.\r\n\t\t\t\tbody1 = c.m_shape1.m_body;\r\n\t\t\t\tbody2 = c.m_shape2.m_body;\r\n\t\t\t\tnode1 = c.m_node1;\r\n\t\t\t\tnode2 = c.m_node2;\r\n\r\n\t\t\t\t// Connect to body 1\r\n\t\t\t\tnode1.contact = c;\r\n\t\t\t\tnode1.other = body2;\r\n\r\n\t\t\t\tnode1.prev = null;\r\n\t\t\t\tnode1.next = body1.m_contactList;\r\n\t\t\t\tif (node1.next != null)\r\n\t\t\t\t{\r\n\t\t\t\t\tnode1.next.prev = c.m_node1;\r\n\t\t\t\t}\r\n\t\t\t\tbody1.m_contactList = c.m_node1;\r\n\r\n\t\t\t\t// Connect to body 2\r\n\t\t\t\tnode2.contact = c;\r\n\t\t\t\tnode2.other = body1;\r\n\r\n\t\t\t\tnode2.prev = null;\r\n\t\t\t\tnode2.next = body2.m_contactList;\r\n\t\t\t\tif (node2.next != null)\r\n\t\t\t\t{\r\n\t\t\t\t\tnode2.next.prev = node2;\r\n\t\t\t\t}\r\n\t\t\t\tbody2.m_contactList = node2;\r\n\t\t\t}\r\n\t\t\telse if (oldCount > 0 && newCount == 0)\r\n\t\t\t{\r\n\t\t\t\t// Disconnect from island graph.\r\n\t\t\t\tbody1 = c.m_shape1.m_body;\r\n\t\t\t\tbody2 = c.m_shape2.m_body;\r\n\t\t\t\tnode1 = c.m_node1;\r\n\t\t\t\tnode2 = c.m_node2;\r\n\r\n\t\t\t\t// Remove from body 1\r\n\t\t\t\tif (node1.prev)\r\n\t\t\t\t{\r\n\t\t\t\t\tnode1.prev.next = node1.next;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (node1.next)\r\n\t\t\t\t{\r\n\t\t\t\t\tnode1.next.prev = node1.prev;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (node1 == body1.m_contactList)\r\n\t\t\t\t{\r\n\t\t\t\t\tbody1.m_contactList = node1.next;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tnode1.prev = null;\r\n\t\t\t\tnode1.next = null;\r\n\r\n\t\t\t\t// Remove from body 2\r\n\t\t\t\tif (node2.prev)\r\n\t\t\t\t{\r\n\t\t\t\t\tnode2.prev.next = node2.next;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (node2.next)\r\n\t\t\t\t{\r\n\t\t\t\t\tnode2.next.prev = node2.prev;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (node2 == body2.m_contactList)\r\n\t\t\t\t{\r\n\t\t\t\t\tbody2.m_contactList = node2.next;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tnode2.prev = null;\r\n\t\t\t\tnode2.next = null;\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n});\r\n","pre":true},"./src/box2d/dynamics/contacts/b2ContactRegistry.js":{"path":"./src/box2d/dynamics/contacts/b2ContactRegistry.js","friendlyPath":".contacts.b2ContactRegistry","directory":"./src/box2d/dynamics/contacts/","filename":"b2ContactRegistry.js","src":"jsio(\"import ...collision.shapes.b2Shape as b2Shape\");\njsio(\"import .b2ContactRegister as b2ContactRegister\");\njsio(\"import .b2CircleContact as b2CircleContact\");\njsio(\"import .b2PolyAndCircleContact as b2PolyAndCircleContact\");\njsio(\"import .b2PolyContact as b2PolyContact\");\n\nb2Contact=__class__;var b2Contact=b2Contact(function b2Contact(){return this.init&&this.init.apply(this,arguments)},function() {});\n\nb2Contact.AddType = function(createFcn, destroyFcn, type1, type2)\n\t{\n\t\t//b2Settings.b2Assert(b2Shape.e_unknownShape < type1 && type1 < b2Shape.e_shapeTypeCount);\n\t\t//b2Settings.b2Assert(b2Shape.e_unknownShape < type2 && type2 < b2Shape.e_shapeTypeCount);\n\n\t\tb2Contact.s_registers[type1][type2].createFcn = createFcn;\n\t\tb2Contact.s_registers[type1][type2].destroyFcn = destroyFcn;\n\t\tb2Contact.s_registers[type1][type2].primary = true;\n\n\t\tif (type1 != type2)\n\t\t{\n\t\t\tb2Contact.s_registers[type2][type1].createFcn = createFcn;\n\t\t\tb2Contact.s_registers[type2][type1].destroyFcn = destroyFcn;\n\t\t\tb2Contact.s_registers[type2][type1].primary = false;\n\t\t}\n\t};\n\nb2Contact.InitializeRegisters = function(){\n\t\tb2Contact.s_registers = new Array(b2Shape.e_shapeTypeCount);\n\t\tfor (var i = 0; i < b2Shape.e_shapeTypeCount; i++){\n\t\t\tb2Contact.s_registers[i] = new Array(b2Shape.e_shapeTypeCount);\n\t\t\tfor (var j = 0; j < b2Shape.e_shapeTypeCount; j++){\n\t\t\t\tb2Contact.s_registers[i][j] = new b2ContactRegister();\n\t\t\t}\n\t\t}\n\n\t\tb2Contact.AddType(b2CircleContact.Create, b2CircleContact.Destroy, b2Shape.e_circleShape, b2Shape.e_circleShape);\n\t\tb2Contact.AddType(b2PolyAndCircleContact.Create, b2PolyAndCircleContact.Destroy, b2Shape.e_polyShape, b2Shape.e_circleShape);\n\t\tb2Contact.AddType(b2PolyContact.Create, b2PolyContact.Destroy, b2Shape.e_polyShape, b2Shape.e_polyShape);\n\n\t};\nb2Contact.Create = function(shape1, shape2, allocator){\n\t\tif (b2Contact.s_initialized == false)\n\t\t{\n\t\t\tb2Contact.InitializeRegisters();\n\t\t\tb2Contact.s_initialized = true;\n\t\t}\n\n\t\tvar type1 = shape1.m_type;\n\t\tvar type2 = shape2.m_type;\n\n\t\t//b2Settings.b2Assert(b2Shape.e_unknownShape < type1 && type1 < b2Shape.e_shapeTypeCount);\n\t\t//b2Settings.b2Assert(b2Shape.e_unknownShape < type2 && type2 < b2Shape.e_shapeTypeCount);\n\n\t\tvar createFcn = b2Contact.s_registers[type1][type2].createFcn;\n\t\tif (createFcn)\n\t\t{\n\t\t\tif (b2Contact.s_registers[type1][type2].primary)\n\t\t\t{\n\t\t\t\treturn createFcn(shape1, shape2, allocator);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvar c = createFcn(shape2, shape1, allocator);\n\t\t\t\tfor (var i = 0; i < c.GetManifoldCount(); ++i)\n\t\t\t\t{\n\t\t\t\t\tvar m = c.GetManifolds()[ i ];\n\t\t\t\t\tm.normal = m.normal.Negative();\n\t\t\t\t}\n\t\t\t\treturn c;\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\treturn null;\n\t\t}\n\t};\n\nb2Contact.Destroy = function(contact, allocator){\n\t\t//b2Settings.b2Assert(b2Contact.s_initialized == true);\n\n\t\tif (contact.GetManifoldCount() > 0)\n\t\t{\n\t\t\tcontact.m_shape1.m_body.WakeUp();\n\t\t\tcontact.m_shape2.m_body.WakeUp();\n\t\t}\n\n\t\tvar type1 = contact.m_shape1.m_type;\n\t\tvar type2 = contact.m_shape2.m_type;\n\n\t\t//b2Settings.b2Assert(b2Shape.e_unknownShape < type1 && type1 < b2Shape.e_shapeTypeCount);\n\t\t//b2Settings.b2Assert(b2Shape.e_unknownShape < type2 && type2 < b2Shape.e_shapeTypeCount);\n\n\t\tvar destroyFcn = b2Contact.s_registers[type1][type2].destroyFcn;\n\t\tdestroyFcn(contact, allocator);\n\t};\nb2Contact.e_islandFlag = 0x0001;\nb2Contact.e_destroyFlag = 0x0002;\nb2Contact.s_registers = null;\nb2Contact.s_initialized = false;\n\nexports = b2Contact;\n","pre":true},"./src/box2d/dynamics/contacts/b2ContactRegister.js":{"path":"./src/box2d/dynamics/contacts/b2ContactRegister.js","friendlyPath":".b2ContactRegister","directory":"./src/box2d/dynamics/contacts/","filename":"b2ContactRegister.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\n\r\nvar src_box2d_dynamics_contacts_b2ContactRegister=__class__;var b2ContactRegister = exports=src_box2d_dynamics_contacts_b2ContactRegister(function src_box2d_dynamics_contacts_b2ContactRegister(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\tthis.init = function() {\r\n\t\tthis.createFcn = null;\r\n\t\tthis.destroyFcn = null;\r\n\t\tthis.primary = null;\r\n\t};\r\n});\r\n\r\n\r\n\r\n","pre":true},"./src/box2d/dynamics/contacts/b2CircleContact.js":{"path":"./src/box2d/dynamics/contacts/b2CircleContact.js","friendlyPath":".b2CircleContact","directory":"./src/box2d/dynamics/contacts/","filename":"b2CircleContact.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\njsio(\"import .b2Contact as b2Contact\");\r\njsio(\"import .b2ContactNode as b2ContactNode\");\r\njsio(\"import ...collision.b2Collision as b2Collision\");\r\njsio(\"import ...collision.b2Manifold as b2Manifold\");\r\njsio(\"import ...common.math.b2Math as b2Math\");\r\n\r\nb2CircleContact=__class__;var b2CircleContact=b2CircleContact(function b2CircleContact(){return this.init&&this.init.apply(this,arguments)},b2Contact, function(supr) {\r\n\r\n\tthis.init = function(s1, s2) {\r\n\t\r\n\t\tsupr(this, 'init', s1, s2);\r\n\t\t// The constructor for b2Contact\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_node1 = new b2ContactNode();\r\n\t\tthis.m_node2 = new b2ContactNode();\r\n\t\t//\r\n\t\tthis.m_flags = 0;\r\n\r\n\t\tif (!s1 || !s2){\r\n\t\t\tthis.m_shape1 = null;\r\n\t\t\tthis.m_shape2 = null;\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis.m_shape1 = s1;\r\n\t\tthis.m_shape2 = s2;\r\n\r\n\t\tthis.m_manifoldCount = 0;\r\n\r\n\t\tthis.m_friction = Math.sqrt(this.m_shape1.m_friction * this.m_shape2.m_friction);\r\n\t\tthis.m_restitution = b2Math.b2Max(this.m_shape1.m_restitution, this.m_shape2.m_restitution);\r\n\r\n\t\tthis.m_prev = null;\r\n\t\tthis.m_next = null;\r\n\r\n\t\tthis.m_node1.contact = null;\r\n\t\tthis.m_node1.prev = null;\r\n\t\tthis.m_node1.next = null;\r\n\t\tthis.m_node1.other = null;\r\n\r\n\t\tthis.m_node2.contact = null;\r\n\t\tthis.m_node2.prev = null;\r\n\t\tthis.m_node2.next = null;\r\n\t\tthis.m_node2.other = null;\r\n\t\t//\r\n\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_manifold = [new b2Manifold()];\r\n\t\t//\r\n\r\n\t\t//super(shape1, shape2);\r\n\r\n\t\t//b2Settings.b2Assert(this.m_shape1.m_type == b2Shape.e_circleShape);\r\n\t\t//b2Settings.b2Assert(this.m_shape2.m_type == b2Shape.e_circleShape);\r\n\t\tthis.m_manifold[0].pointCount = 0;\r\n\t\tthis.m_manifold[0].points[0].normalImpulse = 0.0;\r\n\t\tthis.m_manifold[0].points[0].tangentImpulse = 0.0;\r\n\t};\r\n\t//~b2CircleContact() {}\r\n\r\n\tthis.Evaluate = function(){\r\n\t\tb2Collision.b2CollideCircle(this.m_manifold[0], this.m_shape1, this.m_shape2, false);\r\n\r\n\t\tif (this.m_manifold[0].pointCount > 0)\r\n\t\t{\r\n\t\t\tthis.m_manifoldCount = 1;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tthis.m_manifoldCount = 0;\r\n\t\t}\r\n\t};\r\n\r\n\tthis.GetManifolds = function()\r\n\t{\r\n\t\treturn this.m_manifold;\r\n\t};\r\n\r\n\tthis.m_manifold = [new b2Manifold()];\r\n});\r\n\r\nb2CircleContact.Create = function(shape1, shape2, allocator){\r\n\t\treturn new b2CircleContact(shape1, shape2);\r\n\t};\r\nb2CircleContact.Destroy = function(contact, allocator){\r\n\t\t//\r\n\t};\r\n\r\nexports = b2CircleContact;\r\n\r\n","pre":true},"./src/box2d/dynamics/contacts/b2Contact.js":{"path":"./src/box2d/dynamics/contacts/b2Contact.js","friendlyPath":".b2Contact","directory":"./src/box2d/dynamics/contacts/","filename":"b2Contact.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\n\r\n\r\n\r\n//typedef b2Contact* b2ContactCreateFcn(b2Shape* shape1, b2Shape* shape2, b2BlockAllocator* allocator);\r\n//typedef void b2ContactDestroyFcn(b2Contact* contact, b2BlockAllocator* allocator);\r\njsio(\"import ...collision.shapes.b2Shape as b2Shape\");\r\njsio(\"import .b2ContactNode as b2ContactNode\");\r\njsio(\"import .b2ContactRegister as b2ContactRegister\");\r\n\r\n//import .b2CircleContact as b2CircleContact;\r\n//import .b2PolyAndCircleContact as b2PolyAndCircleContact;\r\n//import .b2PolyContact as b2PolyContact;\r\n\r\nb2Contact=__class__;var b2Contact=b2Contact(function b2Contact(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\tthis.GetManifolds = function(){return null};\r\n\tthis.GetManifoldCount = function()\r\n\t{\r\n\t\treturn this.m_manifoldCount;\r\n\t};\r\n\r\n\tthis.GetNext = function(){\r\n\t\treturn this.m_next;\r\n\t};\r\n\r\n\tthis.GetShape1 = function(){\r\n\t\treturn this.m_shape1;\r\n\t};\r\n\r\n\tthis.GetShape2 = function(){\r\n\t\treturn this.m_shape2;\r\n\t};\r\n\r\n\t//--------------- Internals Below -------------------\r\n\r\n\t// this.m_flags\r\n\t// enum\r\n\r\n\r\n\tthis.init = function(s1, s2)\r\n\t{\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_node1 = new b2ContactNode();\r\n\t\tthis.m_node2 = new b2ContactNode();\r\n\t\t//\r\n\r\n\t\tthis.m_flags = 0;\r\n\r\n\t\tif (!s1 || !s2){\r\n\t\t\tthis.m_shape1 = null;\r\n\t\t\tthis.m_shape2 = null;\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis.m_shape1 = s1;\r\n\t\tthis.m_shape2 = s2;\r\n\r\n\t\tthis.m_manifoldCount = 0;\r\n\r\n\t\tthis.m_friction = Math.sqrt(this.m_shape1.m_friction * this.m_shape2.m_friction);\r\n\t\tthis.m_restitution = b2Math.b2Max(this.m_shape1.m_restitution, this.m_shape2.m_restitution);\r\n\r\n\t\tthis.m_prev = null;\r\n\t\tthis.m_next = null;\r\n\r\n\t\tthis.m_node1.contact = null;\r\n\t\tthis.m_node1.prev = null;\r\n\t\tthis.m_node1.next = null;\r\n\t\tthis.m_node1.other = null;\r\n\r\n\t\tthis.m_node2.contact = null;\r\n\t\tthis.m_node2.prev = null;\r\n\t\tthis.m_node2.next = null;\r\n\t\tthis.m_node2.other = null;\r\n\t};\r\n\r\n\t//virtual ~b2Contact() {}\r\n\r\n\tthis.Evaluate = function(){};\r\n\r\n\t//this.m_flags = 0;\r\n\r\n\t// World pool and list pointers.\r\n\t//m_prev = null;\r\n\t//m_next: null,\r\n\r\n\t//// Nodes for connecting bodies.\r\n\t//m_node1: new b2ContactNode(),\r\n\t//m_node2: new b2ContactNode(),\r\n\r\n\t//m_shape1: null,\r\n\t//m_shape2: null,\r\n\r\n\t//m_manifoldCount: 0,\r\n\r\n\t//// Combined friction\r\n\t//m_friction: null,\r\n\t//m_restitution: null\r\n});\r\n\r\n//b2Contact.e_islandFlag = 0x0001;\r\n//b2Contact.e_destroyFlag = 0x0002;\r\n\r\n//b2Contact.AddType = function(createFcn, destroyFcn, type1, type2)\r\n//\t{\r\n//\t\t//b2Settings.b2Assert(b2Shape.e_unknownShape < type1 && type1 < b2Shape.e_shapeTypeCount);\r\n//\t\t//b2Settings.b2Assert(b2Shape.e_unknownShape < type2 && type2 < b2Shape.e_shapeTypeCount);\r\n//\r\n//\t\tb2Contact.s_registers[type1][type2].createFcn = createFcn;\r\n//\t\tb2Contact.s_registers[type1][type2].destroyFcn = destroyFcn;\r\n//\t\tb2Contact.s_registers[type1][type2].primary = true;\r\n//\r\n//\t\tif (type1 != type2)\r\n//\t\t{\r\n//\t\t\tb2Contact.s_registers[type2][type1].createFcn = createFcn;\r\n//\t\t\tb2Contact.s_registers[type2][type1].destroyFcn = destroyFcn;\r\n//\t\t\tb2Contact.s_registers[type2][type1].primary = false;\r\n//\t\t}\r\n//\t};\r\n//\r\n//b2Contact.InitializeRegisters = function(){\r\n//\t\tb2Contact.s_registers = new Array(b2Shape.e_shapeTypeCount);\r\n//\t\tfor (var i = 0; i < b2Shape.e_shapeTypeCount; i++){\r\n//\t\t\tb2Contact.s_registers[i] = new Array(b2Shape.e_shapeTypeCount);\r\n//\t\t\tfor (var j = 0; j < b2Shape.e_shapeTypeCount; j++){\r\n//\t\t\t\tb2Contact.s_registers[i][j] = new b2ContactRegister();\r\n//\t\t\t}\r\n//\t\t}\r\n//\r\n//\t\tb2Contact.AddType(b2CircleContact.Create, b2CircleContact.Destroy, b2Shape.e_circleShape, b2Shape.e_circleShape);\r\n//\t\tb2Contact.AddType(b2PolyAndCircleContact.Create, b2PolyAndCircleContact.Destroy, b2Shape.e_polyShape, b2Shape.e_circleShape);\r\n//\t\tb2Contact.AddType(b2PolyContact.Create, b2PolyContact.Destroy, b2Shape.e_polyShape, b2Shape.e_polyShape);\r\n//\r\n//\t};\r\n//b2Contact.Create = function(shape1, shape2, allocator){\r\n//\t\tif (b2Contact.s_initialized == false)\r\n//\t\t{\r\n//\t\t\tb2Contact.InitializeRegisters();\r\n//\t\t\tb2Contact.s_initialized = true;\r\n//\t\t}\r\n//\r\n//\t\tvar type1 = shape1.m_type;\r\n//\t\tvar type2 = shape2.m_type;\r\n//\r\n//\t\t//b2Settings.b2Assert(b2Shape.e_unknownShape < type1 && type1 < b2Shape.e_shapeTypeCount);\r\n//\t\t//b2Settings.b2Assert(b2Shape.e_unknownShape < type2 && type2 < b2Shape.e_shapeTypeCount);\r\n//\r\n//\t\tvar createFcn = b2Contact.s_registers[type1][type2].createFcn;\r\n//\t\tif (createFcn)\r\n//\t\t{\r\n//\t\t\tif (b2Contact.s_registers[type1][type2].primary)\r\n//\t\t\t{\r\n//\t\t\t\treturn createFcn(shape1, shape2, allocator);\r\n//\t\t\t}\r\n//\t\t\telse\r\n//\t\t\t{\r\n//\t\t\t\tvar c = createFcn(shape2, shape1, allocator);\r\n//\t\t\t\tfor (var i = 0; i < c.GetManifoldCount(); ++i)\r\n//\t\t\t\t{\r\n//\t\t\t\t\tvar m = c.GetManifolds()[ i ];\r\n//\t\t\t\t\tm.normal = m.normal.Negative();\r\n//\t\t\t\t}\r\n//\t\t\t\treturn c;\r\n//\t\t\t}\r\n//\t\t}\r\n//\t\telse\r\n//\t\t{\r\n//\t\t\treturn null;\r\n//\t\t}\r\n//\t};\r\n//\r\n//b2Contact.Destroy = function(contact, allocator){\r\n//\t\t//b2Settings.b2Assert(b2Contact.s_initialized == true);\r\n//\r\n//\t\tif (contact.GetManifoldCount() > 0)\r\n//\t\t{\r\n//\t\t\tcontact.m_shape1.m_body.WakeUp();\r\n//\t\t\tcontact.m_shape2.m_body.WakeUp();\r\n//\t\t}\r\n//\r\n//\t\tvar type1 = contact.m_shape1.m_type;\r\n//\t\tvar type2 = contact.m_shape2.m_type;\r\n//\r\n//\t\t//b2Settings.b2Assert(b2Shape.e_unknownShape < type1 && type1 < b2Shape.e_shapeTypeCount);\r\n//\t\t//b2Settings.b2Assert(b2Shape.e_unknownShape < type2 && type2 < b2Shape.e_shapeTypeCount);\r\n//\r\n//\t\tvar destroyFcn = b2Contact.s_registers[type1][type2].destroyFcn;\r\n//\t\tdestroyFcn(contact, allocator);\r\n//\t};\r\n//b2Contact.s_registers = null;\r\n//b2Contact.s_initialized = false;\r\n//\r\nexports = b2Contact;\r\n","pre":true},"./src/box2d/dynamics/contacts/b2ContactNode.js":{"path":"./src/box2d/dynamics/contacts/b2ContactNode.js","friendlyPath":".b2ContactNode","directory":"./src/box2d/dynamics/contacts/","filename":"b2ContactNode.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\n\r\n\r\n\r\nvar src_box2d_dynamics_contacts_b2ContactNode=__class__;var b2ContactNode = exports=src_box2d_dynamics_contacts_b2ContactNode(function src_box2d_dynamics_contacts_b2ContactNode(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\tthis.init = function() {\r\n\t\tthis.other = null;\r\n\t\tthis.contact = null;\r\n\t\tthis.prev = null;\r\n\t\tthis.next = null;\r\n\t};\r\n});\r\n\r\n\r\n\r\n","pre":true},"./src/box2d/collision/b2Collision.js":{"path":"./src/box2d/collision/b2Collision.js","friendlyPath":"...collision.b2Collision","directory":"./src/box2d/collision/","filename":"b2Collision.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\njsio(\"import ..common.b2Settings as b2Settings\");\r\njsio(\"import ..common.math.b2Math2 as b2Math\");\r\njsio(\"import ..common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import .ClipVertex as ClipVertex\");\r\n\r\n\r\nb2Collision=__class__;var b2Collision=b2Collision(function b2Collision(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\r\n\t// Null feature\r\n\t// Find the separation between poly1 and poly2 for a give edge normal on poly1.\r\n\r\n\t// Find the max separation between poly1 and poly2 using edge normals\r\n\t// from poly1.\r\n\r\n\t// Find edge normal of max separation on A - return if separating axis is found\r\n\t// Find edge normal of max separation on B - return if separation axis is found\r\n\t// Choose reference edge(minA, minB)\r\n\t// Find incident edge\r\n\t// Clip\r\n\t// The normal points from 1 to 2\r\n\tthis.init = function() {};\r\n});\r\n\r\nb2Collision.b2_nullFeature = 0x000000ff;\r\nb2Collision.ClipSegmentToLine = function(vOut, vIn, normal, offset) {\r\n\t// Start with no output points\r\n\tvar numOut = 0;\r\n\r\n\tvar vIn0 = vIn[0].v;\r\n\tvar vIn1 = vIn[1].v;\r\n\r\n\t// Calculate the distance of end points to the line\r\n\tvar distance0 = b2Math.b2Dot(normal, vIn[0].v) - offset;\r\n\tvar distance1 = b2Math.b2Dot(normal, vIn[1].v) - offset;\r\n\r\n\t// If the points are behind the plane\r\n\tif (distance0 <= 0.0) vOut[numOut++] = vIn[0];\r\n\tif (distance1 <= 0.0) vOut[numOut++] = vIn[1];\r\n\r\n\t// If the points are on different sides of the plane\r\n\tif (distance0 * distance1 < 0.0)\r\n\t{\r\n\t\t// Find intersection point of edge and plane\r\n\t\tvar interp = distance0 / (distance0 - distance1);\r\n\t\t// expanded for performance\r\n\t\tvar tVec = vOut[numOut].v;\r\n\t\ttVec.x = vIn0.x + interp * (vIn1.x - vIn0.x);\r\n\t\ttVec.y = vIn0.y + interp * (vIn1.y - vIn0.y);\r\n\t\tif (distance0 > 0.0)\r\n\t\t{\r\n\t\t\tvOut[numOut].id = vIn[0].id;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tvOut[numOut].id = vIn[1].id;\r\n\t\t}\r\n\t\t++numOut;\r\n\t}\r\n\r\n\treturn numOut;\r\n};\r\n\r\nb2Collision.EdgeSeparation = function(poly1, edge1, poly2) {\r\n\tvar vert1s = poly1.m_vertices;\r\n\tvar count2 = poly2.m_vertexCount;\r\n\tvar vert2s = poly2.m_vertices;\r\n\r\n\t// Convert normal from into poly2's frame.\r\n\t//b2Settings.b2Assert(edge1 < poly1.m_vertexCount);\r\n\r\n\t//var normal = b2Math.b2MulMV(poly1.m_R, poly1->m_normals[edge1]);\r\n\tvar normalX = poly1.m_normals[edge1].x;\r\n\tvar normalY = poly1.m_normals[edge1].y;\r\n\tvar tX = normalX;\r\n\tvar tMat = poly1.m_R;\r\n\tnormalX = tMat.col1.x * tX + tMat.col2.x * normalY;\r\n\tnormalY = tMat.col1.y * tX + tMat.col2.y * normalY;\r\n\t// ^^^^^^^ normal.MulM(poly1.m_R);\r\n\r\n\t//var normalLocal2 = b2Math.b2MulTMV(poly2.m_R, normal);\r\n\tvar normalLocal2X = normalX;\r\n\tvar normalLocal2Y = normalY;\r\n\ttMat = poly2.m_R;\r\n\ttX = normalLocal2X * tMat.col1.x + normalLocal2Y * tMat.col1.y;\r\n\tnormalLocal2Y = normalLocal2X * tMat.col2.x + normalLocal2Y * tMat.col2.y;\r\n\tnormalLocal2X = tX;\r\n\t// ^^^^^ normalLocal2.MulTM(poly2.m_R);\r\n\r\n\t// Find support vertex on poly2 for -normal.\r\n\tvar vertexIndex2 = 0;\r\n\tvar minDot = Number.MAX_VALUE;\r\n\tfor (var i = 0; i < count2; ++i)\r\n\t{\r\n\t\t//var dot = b2Math.b2Dot(vert2s[i], normalLocal2);\r\n\t\tvar tVec = vert2s[i];\r\n\t\tvar dot = tVec.x * normalLocal2X + tVec.y * normalLocal2Y;\r\n\t\tif (dot < minDot)\r\n\t\t{\r\n\t\t\tminDot = dot;\r\n\t\t\tvertexIndex2 = i;\r\n\t\t}\r\n\t}\r\n\r\n\t//b2Vec2 v1 = poly1->m_position + b2Mul(poly1->m_R, vert1s[edge1]);\r\n\ttMat = poly1.m_R;\r\n\tvar v1X = poly1.m_position.x + (tMat.col1.x * vert1s[edge1].x + tMat.col2.x * vert1s[edge1].y)\r\n\tvar v1Y = poly1.m_position.y + (tMat.col1.y * vert1s[edge1].x + tMat.col2.y * vert1s[edge1].y)\r\n\r\n\t//b2Vec2 v2 = poly2->m_position + b2Mul(poly2->m_R, vert2s[vertexIndex2]);\r\n\ttMat = poly2.m_R;\r\n\tvar v2X = poly2.m_position.x + (tMat.col1.x * vert2s[vertexIndex2].x + tMat.col2.x * vert2s[vertexIndex2].y)\r\n\tvar v2Y = poly2.m_position.y + (tMat.col1.y * vert2s[vertexIndex2].x + tMat.col2.y * vert2s[vertexIndex2].y)\r\n\r\n\t//var separation = b2Math.b2Dot( b2Math.SubtractVV( v2, v1 ) , normal);\r\n\tv2X -= v1X;\r\n\tv2Y -= v1Y;\r\n\t//var separation = b2Math.b2Dot( v2 , normal);\r\n\tvar separation = v2X * normalX + v2Y * normalY;\r\n\treturn separation;\r\n};\r\n\r\nb2Collision.FindMaxSeparation = function(edgeIndex /*int ptr*/, poly1, poly2, conservative){\r\n\tvar count1 = poly1.m_vertexCount;\r\n\r\n\t// Vector pointing from the origin of poly1 to the origin of poly2.\r\n\t//var d = b2Math.SubtractVV( poly2.m_position, poly1.m_position );\r\n\tvar dX = poly2.m_position.x - poly1.m_position.x;\r\n\tvar dY = poly2.m_position.y - poly1.m_position.y;\r\n\r\n\t//var dLocal1 = b2Math.b2MulTMV(poly1.m_R, d);\r\n\tvar dLocal1X = (dX * poly1.m_R.col1.x + dY * poly1.m_R.col1.y);\r\n\tvar dLocal1Y = (dX * poly1.m_R.col2.x + dY * poly1.m_R.col2.y);\r\n\r\n\t// Get support vertex hint for our search\r\n\tvar edge = 0;\r\n\tvar maxDot = -Number.MAX_VALUE;\r\n\tfor (var i = 0; i < count1; ++i)\r\n\t{\r\n\t\t//var dot = b2Math.b2Dot(poly.m_normals[i], dLocal1);\r\n\t\tvar dot = (poly1.m_normals[i].x * dLocal1X + poly1.m_normals[i].y * dLocal1Y);\r\n\t\tif (dot > maxDot)\r\n\t\t{\r\n\t\t\tmaxDot = dot;\r\n\t\t\tedge = i;\r\n\t\t}\r\n\t}\r\n\r\n\t// Get the separation for the edge normal.\r\n\tvar s = b2Collision.EdgeSeparation(poly1, edge, poly2);\r\n\tif (s > 0.0 && conservative == false)\r\n\t{\r\n\t\treturn s;\r\n\t}\r\n\r\n\t// Check the separation for the neighboring edges.\r\n\tvar prevEdge = edge - 1 >= 0 ? edge - 1 : count1 - 1;\r\n\tvar sPrev = b2Collision.EdgeSeparation(poly1, prevEdge, poly2);\r\n\tif (sPrev > 0.0 && conservative == false)\r\n\t{\r\n\t\treturn sPrev;\r\n\t}\r\n\r\n\tvar nextEdge = edge + 1 < count1 ? edge + 1 : 0;\r\n\tvar sNext = b2Collision.EdgeSeparation(poly1, nextEdge, poly2);\r\n\tif (sNext > 0.0 && conservative == false)\r\n\t{\r\n\t\treturn sNext;\r\n\t}\r\n\r\n\t// Find the best edge and the search direction.\r\n\tvar bestEdge = 0;\r\n\tvar bestSeparation;\r\n\tvar increment = 0;\r\n\tif (sPrev > s && sPrev > sNext)\r\n\t{\r\n\t\tincrement = -1;\r\n\t\tbestEdge = prevEdge;\r\n\t\tbestSeparation = sPrev;\r\n\t}\r\n\telse if (sNext > s)\r\n\t{\r\n\t\tincrement = 1;\r\n\t\tbestEdge = nextEdge;\r\n\t\tbestSeparation = sNext;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t// pointer out\r\n\t\tedgeIndex[0] = edge;\r\n\t\treturn s;\r\n\t}\r\n\r\n\twhile (true)\r\n\t{\r\n\r\n\t\tif (increment == -1)\r\n\t\t\tedge = bestEdge - 1 >= 0 ? bestEdge - 1 : count1 - 1;\r\n\t\telse\r\n\t\t\tedge = bestEdge + 1 < count1 ? bestEdge + 1 : 0;\r\n\r\n\t\ts = b2Collision.EdgeSeparation(poly1, edge, poly2);\r\n\t\tif (s > 0.0 && conservative == false)\r\n\t\t{\r\n\t\t\treturn s;\r\n\t\t}\r\n\r\n\t\tif (s > bestSeparation)\r\n\t\t{\r\n\t\t\tbestEdge = edge;\r\n\t\t\tbestSeparation = s;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\r\n\t// pointer out\r\n\tedgeIndex[0] = bestEdge;\r\n\treturn bestSeparation;\r\n};\r\n\r\nb2Collision.FindIncidentEdge = function(c, poly1, edge1, poly2){\r\n\tvar count1 = poly1.m_vertexCount;\r\n\tvar vert1s = poly1.m_vertices;\r\n\tvar count2 = poly2.m_vertexCount;\r\n\tvar vert2s = poly2.m_vertices;\r\n\r\n\t// Get the vertices associated with edge1.\r\n\tvar vertex11 = edge1;\r\n\tvar vertex12 = edge1 + 1 == count1 ? 0 : edge1 + 1;\r\n\r\n\t// Get the normal of edge1.\r\n\tvar tVec = vert1s[vertex12];\r\n\t//var normal1Local1 = b2Math.b2CrossVF( b2Math.SubtractVV( vert1s[vertex12], vert1s[vertex11] ), 1.0);\r\n\tvar normal1Local1X = tVec.x;\r\n\tvar normal1Local1Y = tVec.y;\r\n\ttVec = vert1s[vertex11];\r\n\tnormal1Local1X -= tVec.x;\r\n\tnormal1Local1Y -= tVec.y;\r\n\tvar tX = normal1Local1X;\r\n\tnormal1Local1X = normal1Local1Y;\r\n\tnormal1Local1Y = -tX;\r\n\t// ^^^^ normal1Local1.CrossVF(1.0);\r\n\r\n\tvar invLength = 1.0 / Math.sqrt(normal1Local1X*normal1Local1X + normal1Local1Y*normal1Local1Y);\r\n\tnormal1Local1X *= invLength;\r\n\tnormal1Local1Y *= invLength;\r\n\t// ^^^^normal1Local1.Normalize();\r\n\t//var normal1 = b2Math.b2MulMV(poly1.m_R, normal1Local1);\r\n\tvar normal1X = normal1Local1X;\r\n\tvar normal1Y = normal1Local1Y;\r\n\r\n\ttX = normal1X;\r\n\tvar tMat = poly1.m_R;\r\n\tnormal1X = tMat.col1.x * tX + tMat.col2.x * normal1Y;\r\n\tnormal1Y = tMat.col1.y * tX + tMat.col2.y * normal1Y;\r\n\t// ^^^^ normal1.MulM(poly1.m_R);\r\n\r\n\t//var normal1Local2 = b2Math.b2MulTMV(poly2.m_R, normal1);\r\n\tvar normal1Local2X = normal1X;\r\n\tvar normal1Local2Y = normal1Y;\r\n\ttMat = poly2.m_R;\r\n\ttX = normal1Local2X * tMat.col1.x + normal1Local2Y * tMat.col1.y;\r\n\tnormal1Local2Y = normal1Local2X * tMat.col2.x + normal1Local2Y * tMat.col2.y;\r\n\tnormal1Local2X = tX;\r\n\t// ^^^^ normal1Local2.MulTM(poly2.m_R);\r\n\r\n\t// Find the incident edge on poly2.\r\n\tvar vertex21 = 0;\r\n\tvar vertex22 = 0;\r\n\tvar minDot = Number.MAX_VALUE;\r\n\tfor (var i = 0; i < count2; ++i)\r\n\t{\r\n\t\tvar i1 = i;\r\n\t\tvar i2 = i + 1 < count2 ? i + 1 : 0;\r\n\r\n\t\t//var normal2Local2 = b2Math.b2CrossVF( b2Math.SubtractVV( vert2s[i2], vert2s[i1] ), 1.0);\r\n\t\ttVec = vert2s[i2];\r\n\t\tvar normal2Local2X = tVec.x;\r\n\t\tvar normal2Local2Y = tVec.y;\r\n\t\ttVec = vert2s[i1];\r\n\t\tnormal2Local2X -= tVec.x;\r\n\t\tnormal2Local2Y -= tVec.y;\r\n\t\ttX = normal2Local2X;\r\n\t\tnormal2Local2X = normal2Local2Y;\r\n\t\tnormal2Local2Y = -tX;\r\n\t\t// ^^^^ normal2Local2.CrossVF(1.0);\r\n\r\n\t\tinvLength = 1.0 / Math.sqrt(normal2Local2X*normal2Local2X + normal2Local2Y*normal2Local2Y);\r\n\t\tnormal2Local2X *= invLength;\r\n\t\tnormal2Local2Y *= invLength;\r\n\t\t// ^^^^ normal2Local2.Normalize();\r\n\r\n\t\t//var dot = b2Math.b2Dot(normal2Local2, normal1Local2);\r\n\t\tvar dot = normal2Local2X * normal1Local2X + normal2Local2Y * normal1Local2Y;\r\n\t\tif (dot < minDot)\r\n\t\t{\r\n\t\t\tminDot = dot;\r\n\t\t\tvertex21 = i1;\r\n\t\t\tvertex22 = i2;\r\n\t\t}\r\n\t}\r\n\r\n\tvar tClip;\r\n\t// Build the clip vertices for the incident edge.\r\n\ttClip = c[0];\r\n\t//tClip.v = b2Math.AddVV(poly2.m_position, b2Math.b2MulMV(poly2.m_R, vert2s[vertex21]));\r\n\ttVec = tClip.v;\r\n\ttVec.SetV(vert2s[vertex21]);\r\n\ttVec.MulM(poly2.m_R);\r\n\ttVec.sAdd(poly2.m_position);\r\n\r\n\ttClip.id.features.referenceFace = edge1;\r\n\ttClip.id.features.incidentEdge = vertex21;\r\n\ttClip.id.features.incidentVertex = vertex21;\r\n\r\n\ttClip = c[1];\r\n\t//tClip.v = b2Math.AddVV(poly2.m_position, b2Math.b2MulMV(poly2.m_R, vert2s[vertex22]));\r\n\ttVec = tClip.v;\r\n\ttVec.SetV(vert2s[vertex22]);\r\n\ttVec.MulM(poly2.m_R);\r\n\ttVec.sAdd(poly2.m_position);\r\n\ttClip.id.features.referenceFace = edge1;\r\n\ttClip.id.features.incidentEdge = vertex21;\r\n\ttClip.id.features.incidentVertex = vertex22;\r\n};\r\n\r\nb2Collision.b2CollidePolyTempVec = new b2Vec2();\r\n\r\nb2Collision.b2CollidePoly = function(manifold, polyA, polyB, conservative) {\r\n\tmanifold.pointCount = 0;\r\n\r\n\tvar edgeA = 0;\r\n\tvar edgeAOut = [edgeA];\r\n\tvar separationA = b2Collision.FindMaxSeparation(edgeAOut, polyA, polyB, conservative);\r\n\tedgeA = edgeAOut[0];\r\n\tif (separationA > 0.0 && conservative == false)\r\n\t\treturn;\r\n\r\n\tvar edgeB = 0;\r\n\tvar edgeBOut = [edgeB];\r\n\tvar separationB = b2Collision.FindMaxSeparation(edgeBOut, polyB, polyA, conservative);\r\n\tedgeB = edgeBOut[0];\r\n\tif (separationB > 0.0 && conservative == false)\r\n\t\treturn;\r\n\r\n\tvar poly1;\r\n\tvar poly2;\r\n\tvar edge1 = 0;\r\n\tvar flip = 0;\r\n\tvar k_relativeTol = 0.98;\r\n\tvar k_absoluteTol = 0.001;\r\n\r\n\t// TODO_ERIN use \"radius\" of poly for absolute tolerance.\r\n\tif (separationB > k_relativeTol * separationA + k_absoluteTol)\r\n\t{\r\n\t\tpoly1 = polyB;\r\n\t\tpoly2 = polyA;\r\n\t\tedge1 = edgeB;\r\n\t\tflip = 1;\r\n\t}\r\n\telse\r\n\t{\r\n\t\tpoly1 = polyA;\r\n\t\tpoly2 = polyB;\r\n\t\tedge1 = edgeA;\r\n\t\tflip = 0;\r\n\t}\r\n\r\n\tvar incidentEdge = [new ClipVertex(), new ClipVertex()];\r\n\tb2Collision.FindIncidentEdge(incidentEdge, poly1, edge1, poly2);\r\n\r\n\tvar count1 = poly1.m_vertexCount;\r\n\tvar vert1s = poly1.m_vertices;\r\n\r\n\tvar v11 = vert1s[edge1];\r\n\tvar v12 = edge1 + 1 < count1 ? vert1s[edge1+1] : vert1s[0];\r\n\r\n\t//var dv = b2Math.SubtractVV(v12, v11);\r\n\tvar dvX = v12.x - v11.x;\r\n\tvar dvY = v12.y - v11.y;\r\n\r\n\t//var sideNormal = b2Math.b2MulMV(poly1.m_R, b2Math.SubtractVV(v12, v11));\r\n\tvar sideNormalX = v12.x - v11.x;\r\n\tvar sideNormalY = v12.y - v11.y;\r\n\r\n\tvar tX = sideNormalX;\r\n\tvar tMat = poly1.m_R;\r\n\tsideNormalX = tMat.col1.x * tX + tMat.col2.x * sideNormalY;\r\n\tsideNormalY = tMat.col1.y * tX + tMat.col2.y * sideNormalY;\r\n\t// ^^^^ sideNormal.MulM(poly1.m_R);\r\n\r\n\tvar invLength = 1.0 / Math.sqrt(sideNormalX*sideNormalX + sideNormalY*sideNormalY);\r\n\tsideNormalX *= invLength;\r\n\tsideNormalY *= invLength;\r\n\t// ^^^^ sideNormal.Normalize();\r\n\r\n\t//var frontNormal = b2Math.b2CrossVF(sideNormal, 1.0);\r\n\tvar frontNormalX = sideNormalX;\r\n\tvar frontNormalY = sideNormalY;\r\n\ttX = frontNormalX;\r\n\tfrontNormalX = frontNormalY;\r\n\tfrontNormalY = -tX;\r\n\t// ^^^^ frontNormal.CrossVF(1.0);\r\n\r\n\t// Expanded for performance\r\n\t//v11 = b2Math.AddVV(poly1.m_position, b2Math.b2MulMV(poly1.m_R, v11));\r\n\tvar v11X = v11.x;\r\n\tvar v11Y = v11.y;\r\n\ttX = v11X;\r\n\ttMat = poly1.m_R;\r\n\tv11X = tMat.col1.x * tX + tMat.col2.x * v11Y;\r\n\tv11Y = tMat.col1.y * tX + tMat.col2.y * v11Y;\r\n\t// ^^^^ v11.MulM(poly1.m_R);\r\n\tv11X += poly1.m_position.x;\r\n\tv11Y += poly1.m_position.y;\r\n\t//v12 = b2Math.AddVV(poly1.m_position, b2Math.b2MulMV(poly1.m_R, v12));\r\n\tvar v12X = v12.x;\r\n\tvar v12Y = v12.y;\r\n\ttX = v12X;\r\n\ttMat = poly1.m_R;\r\n\tv12X = tMat.col1.x * tX + tMat.col2.x * v12Y;\r\n\tv12Y = tMat.col1.y * tX + tMat.col2.y * v12Y;\r\n\t// ^^^^ v12.MulM(poly1.m_R);\r\n\tv12X += poly1.m_position.x;\r\n\tv12Y += poly1.m_position.y;\r\n\r\n\t//var frontOffset = b2Math.b2Dot(frontNormal, v11);\r\n\tvar frontOffset = frontNormalX * v11X + frontNormalY * v11Y;\r\n\t//var sideOffset1 = -b2Math.b2Dot(sideNormal, v11);\r\n\tvar sideOffset1 = -(sideNormalX * v11X + sideNormalY * v11Y);\r\n\t//var sideOffset2 = b2Math.b2Dot(sideNormal, v12);\r\n\tvar sideOffset2 = sideNormalX * v12X + sideNormalY * v12Y;\r\n\r\n\t// Clip incident edge against extruded edge1 side edges.\r\n\tvar clipPoints1 = [new ClipVertex(), new ClipVertex()];\r\n\tvar clipPoints2 = [new ClipVertex(), new ClipVertex()];\r\n\r\n\tvar np = 0;\r\n\r\n\t// Clip to box side 1\r\n\tb2Collision.b2CollidePolyTempVec.Set(-sideNormalX, -sideNormalY);\r\n\tnp = b2Collision.ClipSegmentToLine(clipPoints1, incidentEdge, b2Collision.b2CollidePolyTempVec, sideOffset1);\r\n\r\n\tif (np < 2)\r\n\t\treturn;\r\n\r\n\t// Clip to negative box side 1\r\n\tb2Collision.b2CollidePolyTempVec.Set(sideNormalX, sideNormalY);\r\n\tnp = b2Collision.ClipSegmentToLine(clipPoints2, clipPoints1,  b2Collision.b2CollidePolyTempVec, sideOffset2);\r\n\r\n\tif (np < 2)\r\n\t\treturn;\r\n\r\n\t// Now clipPoints2 contains the clipped points.\r\n\tif (flip){\r\n\t\tmanifold.normal.Set(-frontNormalX, -frontNormalY);\r\n\t}\r\n\telse{\r\n\t\tmanifold.normal.Set(frontNormalX, frontNormalY);\r\n\t}\r\n\t// ^^^^ manifold.normal = flip ? frontNormal.Negative() : frontNormal;\r\n\r\n\tvar pointCount = 0;\r\n\tfor (var i = 0; i < b2Settings.b2_maxManifoldPoints; ++i)\r\n\t{\r\n\t\t//var separation = b2Math.b2Dot(frontNormal, clipPoints2[i].v) - frontOffset;\r\n\t\tvar tVec = clipPoints2[i].v;\r\n\t\tvar separation = (frontNormalX * tVec.x + frontNormalY * tVec.y) - frontOffset;\r\n\r\n\t\tif (separation <= 0.0 || conservative == true)\r\n\t\t{\r\n\t\t\tvar cp = manifold.points[ pointCount ];\r\n\t\t\tcp.separation = separation;\r\n\t\t\tcp.position.SetV( clipPoints2[i].v );\r\n\t\t\tcp.id.Set( clipPoints2[i].id );\r\n\t\t\tcp.id.features.flip = flip;\r\n\t\t\t++pointCount;\r\n\t\t}\r\n\t}\r\n\r\n\tmanifold.pointCount = pointCount;\r\n};\r\n\r\nb2Collision.b2CollideCircle = function(manifold, circle1, circle2, conservative){\r\n\tmanifold.pointCount = 0;\r\n\r\n\t//var d = b2Math.SubtractVV(circle2.m_position, circle1.m_position);\r\n\tvar dX = circle2.m_position.x - circle1.m_position.x;\r\n\tvar dY = circle2.m_position.y - circle1.m_position.y;\r\n\t//var distSqr = b2Math.b2Dot(d, d);\r\n\tvar distSqr = dX * dX + dY * dY;\r\n\tvar radiusSum = circle1.m_radius + circle2.m_radius;\r\n\tif (distSqr > radiusSum * radiusSum && conservative == false)\r\n\t{\r\n\t\treturn;\r\n\t}\r\n\r\n\tvar separation;\r\n\tif (distSqr < Number.MIN_VALUE)\r\n\t{\r\n\t\tseparation = -radiusSum;\r\n\t\tmanifold.normal.Set(0.0, 1.0);\r\n\t}\r\n\telse\r\n\t{\r\n\t\tvar dist = Math.sqrt(distSqr);\r\n\t\tseparation = dist - radiusSum;\r\n\t\tvar a = 1.0 / dist;\r\n\t\tmanifold.normal.x = a * dX;\r\n\t\tmanifold.normal.y = a * dY;\r\n\t}\r\n\r\n\tmanifold.pointCount = 1;\r\n\tvar tPoint = manifold.points[0];\r\n\ttPoint.id.set_key(0);\r\n\ttPoint.separation = separation;\r\n\t//tPoint.position = b2Math.SubtractVV(circle2.m_position, b2Math.MulFV(circle2.m_radius, manifold.normal));\r\n\ttPoint.position.x = circle2.m_position.x - (circle2.m_radius * manifold.normal.x);\r\n\ttPoint.position.y = circle2.m_position.y - (circle2.m_radius * manifold.normal.y);\r\n};\r\n\r\nb2Collision.b2CollidePolyAndCircle = function(manifold, poly, circle, conservative){\r\n\tmanifold.pointCount = 0;\r\n\tvar tPoint;\r\n\r\n\tvar dX;\r\n\tvar dY;\r\n\r\n\t// Compute circle position in the frame of the polygon.\r\n\t//var xLocal = b2Math.b2MulTMV(poly.m_R, b2Math.SubtractVV(circle.m_position, poly.m_position));\r\n\tvar xLocalX = circle.m_position.x - poly.m_position.x;\r\n\tvar xLocalY = circle.m_position.y - poly.m_position.y;\r\n\tvar tMat = poly.m_R;\r\n\tvar tX = xLocalX * tMat.col1.x + xLocalY * tMat.col1.y;\r\n\txLocalY = xLocalX * tMat.col2.x + xLocalY * tMat.col2.y;\r\n\txLocalX = tX;\r\n\r\n\tvar dist;\r\n\r\n\t// Find the min separating edge.\r\n\tvar normalIndex = 0;\r\n\tvar separation = -Number.MAX_VALUE;\r\n\tvar radius = circle.m_radius;\r\n\tfor (var i = 0; i < poly.m_vertexCount; ++i)\r\n\t{\r\n\t\t//var s = b2Math.b2Dot(poly.m_normals[i], b2Math.SubtractVV(xLocal, poly.m_vertices[i]));\r\n\t\tvar s = poly.m_normals[i].x * (xLocalX-poly.m_vertices[i].x) + poly.m_normals[i].y * (xLocalY-poly.m_vertices[i].y);\r\n\t\tif (s > radius)\r\n\t\t{\r\n\t\t\t// Early out.\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (s > separation)\r\n\t\t{\r\n\t\t\tseparation = s;\r\n\t\t\tnormalIndex = i;\r\n\t\t}\r\n\t}\r\n\r\n\t// If the center is inside the polygon ...\r\n\tif (separation < Number.MIN_VALUE)\r\n\t{\r\n\t\tmanifold.pointCount = 1;\r\n\t\t//manifold.normal = b2Math.b2MulMV(poly.m_R, poly.m_normals[normalIndex]);\r\n\t\tvar tVec = poly.m_normals[normalIndex];\r\n\t\tmanifold.normal.x = tMat.col1.x * tVec.x + tMat.col2.x * tVec.y;\r\n\t\tmanifold.normal.y = tMat.col1.y * tVec.x + tMat.col2.y * tVec.y;\r\n\r\n\t\ttPoint = manifold.points[0];\r\n\t\ttPoint.id.features.incidentEdge = normalIndex;\r\n\t\ttPoint.id.features.incidentVertex = b2Collision.b2_nullFeature;\r\n\t\ttPoint.id.features.referenceFace = b2Collision.b2_nullFeature;\r\n\t\ttPoint.id.features.flip = 0;\r\n\t\ttPoint.position.x = circle.m_position.x - radius * manifold.normal.x;\r\n\t\ttPoint.position.y = circle.m_position.y - radius * manifold.normal.y;\r\n\t\t//tPoint.position = b2Math.SubtractVV(circle.m_position , b2Math.MulFV(radius , manifold.normal));\r\n\t\ttPoint.separation = separation - radius;\r\n\t\treturn;\r\n\t}\r\n\r\n\t// Project the circle center onto the edge segment.\r\n\tvar vertIndex1 = normalIndex;\r\n\tvar vertIndex2 = vertIndex1 + 1 < poly.m_vertexCount ? vertIndex1 + 1 : 0;\r\n\t//var e = b2Math.SubtractVV(poly.m_vertices[vertIndex2] , poly.m_vertices[vertIndex1]);\r\n\tvar eX = poly.m_vertices[vertIndex2].x - poly.m_vertices[vertIndex1].x;\r\n\tvar eY = poly.m_vertices[vertIndex2].y - poly.m_vertices[vertIndex1].y;\r\n\t//var length = e.Normalize();\r\n\tvar length = Math.sqrt(eX*eX + eY*eY);\r\n\teX /= length;\r\n\teY /= length;\r\n\r\n\t// If the edge length is zero ...\r\n\tif (length < Number.MIN_VALUE)\r\n\t{\r\n\t\t//d = b2Math.SubtractVV(xLocal , poly.m_vertices[vertIndex1]);\r\n\t\tdX = xLocalX - poly.m_vertices[vertIndex1].x;\r\n\t\tdY = xLocalY - poly.m_vertices[vertIndex1].y;\r\n\t\t//dist = d.Normalize();\r\n\t\tdist = Math.sqrt(dX*dX + dY*dY);\r\n\t\tdX /= dist;\r\n\t\tdY /= dist;\r\n\t\tif (dist > radius)\r\n\t\t{\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tmanifold.pointCount = 1;\r\n\t\t//manifold.normal = b2Math.b2MulMV(poly.m_R, d);\r\n\t\tmanifold.normal.Set(tMat.col1.x * dX + tMat.col2.x * dY, tMat.col1.y * dX + tMat.col2.y * dY);\r\n\t\ttPoint = manifold.points[0];\r\n\t\ttPoint.id.features.incidentEdge = b2Collision.b2_nullFeature;\r\n\t\ttPoint.id.features.incidentVertex = vertIndex1;\r\n\t\ttPoint.id.features.referenceFace = b2Collision.b2_nullFeature;\r\n\t\ttPoint.id.features.flip = 0;\r\n\t\t//tPoint.position = b2Math.SubtractVV(circle.m_position , b2Math.MulFV(radius , manifold.normal));\r\n\t\ttPoint.position.x = circle.m_position.x - radius * manifold.normal.x;\r\n\t\ttPoint.position.y = circle.m_position.y - radius * manifold.normal.y;\r\n\t\ttPoint.separation = dist - radius;\r\n\t\treturn;\r\n\t}\r\n\r\n\t// Project the center onto the edge.\r\n\t//var u = b2Math.b2Dot(b2Math.SubtractVV(xLocal , poly.m_vertices[vertIndex1]) , e);\r\n\tvar u = (xLocalX-poly.m_vertices[vertIndex1].x) * eX + (xLocalY-poly.m_vertices[vertIndex1].y) * eY;\r\n\r\n\ttPoint = manifold.points[0];\r\n\ttPoint.id.features.incidentEdge = b2Collision.b2_nullFeature;\r\n\ttPoint.id.features.incidentVertex = b2Collision.b2_nullFeature;\r\n\ttPoint.id.features.referenceFace = b2Collision.b2_nullFeature;\r\n\ttPoint.id.features.flip = 0;\r\n\r\n\tvar pX, pY;\r\n\tif (u <= 0.0)\r\n\t{\r\n\t\tpX = poly.m_vertices[vertIndex1].x;\r\n\t\tpY = poly.m_vertices[vertIndex1].y;\r\n\t\ttPoint.id.features.incidentVertex = vertIndex1;\r\n\t}\r\n\telse if (u >= length)\r\n\t{\r\n\t\tpX = poly.m_vertices[vertIndex2].x;\r\n\t\tpY = poly.m_vertices[vertIndex2].y;\r\n\t\ttPoint.id.features.incidentVertex = vertIndex2;\r\n\t}\r\n\telse\r\n\t{\r\n\t\t//p = b2Math.AddVV(poly.m_vertices[vertIndex1] , b2Math.MulFV(u, e));\r\n\t\tpX = eX * u + poly.m_vertices[vertIndex1].x;\r\n\t\tpY = eY * u + poly.m_vertices[vertIndex1].y;\r\n\t\ttPoint.id.features.incidentEdge = vertIndex1;\r\n\t}\r\n\r\n\t//d = b2Math.SubtractVV(xLocal , p);\r\n\tdX = xLocalX - pX;\r\n\tdY = xLocalY - pY;\r\n\t//dist = d.Normalize();\r\n\tdist = Math.sqrt(dX*dX + dY*dY);\r\n\tdX /= dist;\r\n\tdY /= dist;\r\n\tif (dist > radius)\r\n\t{\r\n\t\treturn;\r\n\t}\r\n\r\n\tmanifold.pointCount = 1;\r\n\t//manifold.normal = b2Math.b2MulMV(poly.m_R, d);\r\n\tmanifold.normal.Set(tMat.col1.x * dX + tMat.col2.x * dY, tMat.col1.y * dX + tMat.col2.y * dY);\r\n\t//tPoint.position = b2Math.SubtractVV(circle.m_position , b2Math.MulFV(radius , manifold.normal));\r\n\ttPoint.position.x = circle.m_position.x - radius * manifold.normal.x;\r\n\ttPoint.position.y = circle.m_position.y - radius * manifold.normal.y;\r\n\ttPoint.separation = dist - radius;\r\n};\r\n\r\nb2Collision.b2TestOverlap = function(a, b){\r\n\tvar t1 = b.minVertex;\r\n\tvar t2 = a.maxVertex;\r\n\t//d1 = b2Math.SubtractVV(b.minVertex, a.maxVertex);\r\n\tvar d1X = t1.x - t2.x;\r\n\tvar d1Y = t1.y - t2.y;\r\n\t//d2 = b2Math.SubtractVV(a.minVertex, b.maxVertex);\r\n\tt1 = a.minVertex;\r\n\tt2 = b.maxVertex;\r\n\tvar d2X = t1.x - t2.x;\r\n\tvar d2Y = t1.y - t2.y;\r\n\r\n\tif (d1X > 0.0 || d1Y > 0.0)\r\n\t\treturn false;\r\n\r\n\tif (d2X > 0.0 || d2Y > 0.0)\r\n\t\treturn false;\r\n\r\n\treturn true;\r\n};\r\n\r\nexports = b2Collision;\r\n","pre":true},"./src/box2d/collision/ClipVertex.js":{"path":"./src/box2d/collision/ClipVertex.js","friendlyPath":".ClipVertex","directory":"./src/box2d/collision/","filename":"ClipVertex.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\n\r\n\r\njsio(\"import ..common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import .b2ContactID as b2ContactID\");\r\n\r\nvar src_box2d_collision_ClipVertex=__class__;var ClipVertex = exports=src_box2d_collision_ClipVertex(function src_box2d_collision_ClipVertex(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\tthis.init = function() {\r\n\r\n\t\t// initialize instance variables for references\r\n\t\tthis.v = new b2Vec2();\r\n\t\tthis.id = new b2ContactID();\r\n\t};\r\n});\r\n\r\n\r\n","pre":true},"./src/box2d/collision/b2ContactID.js":{"path":"./src/box2d/collision/b2ContactID.js","friendlyPath":".b2ContactID","directory":"./src/box2d/collision/","filename":"b2ContactID.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\njsio(\"import .Features as Features\");\r\n\r\n// We use contact ids to facilitate warm starting.\r\nvar src_box2d_collision_b2ContactID=__class__;var b2ContactID = exports=src_box2d_collision_b2ContactID(function src_box2d_collision_b2ContactID(){return this.init&&this.init.apply(this,arguments)}, function() {\r\n\tthis.init = function(){\r\n\t\t// initialize instance variables for references\r\n\t\tthis.features = new Features();\r\n\r\n\t\tthis.features._m_id = this;\r\n\t\tthis._key = 0;\r\n\t};\r\n\r\n\tthis.Set = function(id){\r\n\t\tthis.set_key(id._key);\r\n\t};\r\n\r\n\tthis.Copy = function(){\r\n\t\tvar id = new b2ContactID();\r\n\t\tid.set_key(this._key);\r\n\t\treturn id;\r\n\t};\r\n\r\n\tthis.get_key = function(){\r\n\t\treturn this._key;\r\n\t};\r\n\tthis.set_key = function(value) {\r\n\t\tthis._key = value;\r\n\t\tthis.features._referenceFace = this._key & 0x000000ff;\r\n\t\tthis.features._incidentEdge = ((this._key & 0x0000ff00) >> 8) & 0x000000ff;\r\n\t\tthis.features._incidentVertex = ((this._key & 0x00ff0000) >> 16) & 0x000000ff;\r\n\t\tthis.features._flip = ((this._key & 0xff000000) >> 24) & 0x000000ff;\r\n\t};\r\n});\r\n","pre":true},"./src/box2d/collision/Features.js":{"path":"./src/box2d/collision/Features.js","friendlyPath":".Features","directory":"./src/box2d/collision/","filename":"Features.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\n// We use contact ids to facilitate warm starting.\r\nvar src_box2d_collision_Features=__class__;var Features = exports=src_box2d_collision_Features(function src_box2d_collision_Features(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\r\n\tthis.init = function() {\r\n\t\tthis._flip = 0;\r\n\t\tthis._m_id = null;\r\n\t\tthis._referenceFace = 0;\r\n\t\tthis._incidentVertex = 0;\r\n\t\tthis._incidentEdge = 0;\r\n\t\tthis._incidentVertex = 0;\r\n\t};\r\n\tthis.set_referenceFace = function(value) {\r\n\t\tthis._referenceFace = value;\r\n\t\tthis._m_id._key = (this._m_id._key & 0xffffff00) | (this._referenceFace & 0x000000ff)\r\n\t};\r\n\tthis.get_referenceFace = function(){\r\n\t\treturn this._referenceFace;\r\n\t};\r\n\tthis.set_incidentEdge = function(value){\r\n\t\tthis._incidentEdge = value;\r\n\t\tthis._m_id._key = (this._m_id._key & 0xffff00ff) | ((this._incidentEdge << 8) & 0x0000ff00)\r\n\t},\r\n\tthis.get_incidentEdge = function(){\r\n\t\treturn this._incidentEdge;\r\n\t};\r\n\tthis.set_incidentVertex = function(value){\r\n\t\tthis._incidentVertex = value;\r\n\t\tthis._m_id._key = (this._m_id._key & 0xff00ffff) | ((this._incidentVertex << 16) & 0x00ff0000)\r\n\t};\r\n\tthis.get_incidentVertex = function(){\r\n\t\treturn this._incidentVertex;\r\n\t};\r\n\tthis.set_flip = function(value){\r\n\t\tthis._flip = value;\r\n\t\tthis._m_id._key = (this._m_id._key & 0x00ffffff) | ((this._flip << 24) & 0xff000000)\r\n\t};\r\n\tthis.get_flip = function(){\r\n\t\treturn this._flip;\r\n\t};\r\n});\r\n","pre":true},"./src/box2d/collision/b2Manifold.js":{"path":"./src/box2d/collision/b2Manifold.js","friendlyPath":"...collision.b2Manifold","directory":"./src/box2d/collision/","filename":"b2Manifold.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\njsio(\"import ..common.b2Settings as b2Settings\");\r\njsio(\"import ..common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import .b2ContactPoint as b2ContactPoint\");\r\n\r\n// A manifold for two touching convex shapes.\r\nvar src_box2d_collision_b2Manifold=__class__;var b2Manifold = exports=src_box2d_collision_b2Manifold(function src_box2d_collision_b2Manifold(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\r\n\tthis.init = function(){\r\n\t\tthis.points = new Array(b2Settings.b2_maxManifoldPoints);\r\n\t\tfor (var i = 0; i < b2Settings.b2_maxManifoldPoints; i++){\r\n\t\t\tthis.points[i] = new b2ContactPoint();\r\n\t\t}\r\n\t\tthis.normal = new b2Vec2();\r\n\t\tthis.pointCount = 0;\r\n\t};\r\n});\r\n","pre":true},"./src/box2d/collision/b2ContactPoint.js":{"path":"./src/box2d/collision/b2ContactPoint.js","friendlyPath":".b2ContactPoint","directory":"./src/box2d/collision/","filename":"b2ContactPoint.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\njsio(\"import ..common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import .b2ContactID as .b2ContactID\");\r\n\r\n// We use contact ids to facilitate warm starting.\r\nvar src_box2d_collision_b2ContactPoint=__class__;var b2ContactPoint = exports=src_box2d_collision_b2ContactPoint(function src_box2d_collision_b2ContactPoint(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\tthis.init = function() {\r\n\t\t// initialize instance variables for references\r\n\t\tthis.position = new b2Vec2();\r\n\t\tthis.id = new b2ContactID();\r\n\t\tthis.separation = null;\r\n\t\tthis.normalImpulse = null;\r\n\t\tthis.tangentImpulse = null;\r\n\t};\t\r\n});\r\n","pre":true},"./src/box2d/dynamics/contacts/b2PolyAndCircleContact.js":{"path":"./src/box2d/dynamics/contacts/b2PolyAndCircleContact.js","friendlyPath":".b2PolyAndCircleContact","directory":"./src/box2d/dynamics/contacts/","filename":"b2PolyAndCircleContact.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\njsio(\"import .b2Contact as b2Contact\");\r\njsio(\"import .b2ContactNode as b2ContactNode\");\r\njsio(\"import ...collision.shapes.b2Shape as b2Shape\");\r\njsio(\"import ...collision.b2Collision as b2Collision\");\r\njsio(\"import ...collision.b2Manifold as b2Manifold\");\r\njsio(\"import ...common.math.b2Math as b2Math\");\r\njsio(\"import ...common.b2Settings as b2Settings\");\r\n\r\nvar src_box2d_dynamics_contacts_b2PolyAndCircleContact=__class__;var b2PolyAndCircleContact = exports=src_box2d_dynamics_contacts_b2PolyAndCircleContact(function src_box2d_dynamics_contacts_b2PolyAndCircleContact(){return this.init&&this.init.apply(this,arguments)},b2Contact, function(supr) {\r\n\r\n\tthis.init = function(s1, s2) {\r\n\t\tsupr(this, 'init', s1, s2);\r\n\r\n\t\t// The constructor for b2Contact\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_node1 = new b2ContactNode();\r\n\t\tthis.m_node2 = new b2ContactNode();\r\n\t\t//\r\n\t\tthis.m_flags = 0;\r\n\r\n\t\tif (!s1 || !s2){\r\n\t\t\tthis.m_shape1 = null;\r\n\t\t\tthis.m_shape2 = null;\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis.m_shape1 = s1;\r\n\t\tthis.m_shape2 = s2;\r\n\r\n\t\tthis.m_manifoldCount = 0;\r\n\r\n\t\tthis.m_friction = Math.sqrt(this.m_shape1.m_friction * this.m_shape2.m_friction);\r\n\t\tthis.m_restitution = b2Math.b2Max(this.m_shape1.m_restitution, this.m_shape2.m_restitution);\r\n\r\n\t\tthis.m_prev = null;\r\n\t\tthis.m_next = null;\r\n\r\n\t\tthis.m_node1.contact = null;\r\n\t\tthis.m_node1.prev = null;\r\n\t\tthis.m_node1.next = null;\r\n\t\tthis.m_node1.other = null;\r\n\r\n\t\tthis.m_node2.contact = null;\r\n\t\tthis.m_node2.prev = null;\r\n\t\tthis.m_node2.next = null;\r\n\t\tthis.m_node2.other = null;\r\n\t\t//\r\n\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_manifold = [new b2Manifold()];\r\n\t\t//\r\n\r\n\t\t//super(shape1, shape2);\r\n\r\n\t\tb2Settings.b2Assert(this.m_shape1.m_type == b2Shape.e_polyShape);\r\n\t\tb2Settings.b2Assert(this.m_shape2.m_type == b2Shape.e_circleShape);\r\n\t\tthis.m_manifold[0].pointCount = 0;\r\n\t\tthis.m_manifold[0].points[0].normalImpulse = 0.0;\r\n\t\tthis.m_manifold[0].points[0].tangentImpulse = 0.0;\r\n\t};\r\n\t//~b2PolyAndCircleContact() {}\r\n\r\n\tthis.Evaluate = function(){\r\n\t\tb2Collision.b2CollidePolyAndCircle(this.m_manifold[0], this.m_shape1, this.m_shape2, false);\r\n\r\n\t\tif (this.m_manifold[0].pointCount > 0)\r\n\t\t{\r\n\t\t\tthis.m_manifoldCount = 1;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tthis.m_manifoldCount = 0;\r\n\t\t}\r\n\t};\r\n\r\n\tthis.GetManifolds = function()\r\n\t{\r\n\t\treturn this.m_manifold;\r\n\t};\r\n});\r\n\r\nb2PolyAndCircleContact.Create = function(shape1, shape2, allocator){\r\n\t\treturn new b2PolyAndCircleContact(shape1, shape2);\r\n\t};\r\n\r\nb2PolyAndCircleContact.Destroy = function(contact, allocator){\r\n\t\t//\r\n\t};\r\n\r\nexports = b2PolyAndCircleContact;\r\n\r\n","pre":true},"./src/box2d/dynamics/contacts/b2PolyContact.js":{"path":"./src/box2d/dynamics/contacts/b2PolyContact.js","friendlyPath":".b2PolyContact","directory":"./src/box2d/dynamics/contacts/","filename":"b2PolyContact.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\n\r\njsio(\"import .b2Contact as b2Contact\");\r\njsio(\"import .b2ContactNode as b2ContactNode\");\r\njsio(\"import ...collision.b2Manifold as b2Manifold\");\r\njsio(\"import ...collision.b2Collision as b2Collision\");\r\njsio(\"import ...common.math.b2Math as b2Math\");\r\n\r\nb2PolyContact=__class__;var b2PolyContact=b2PolyContact(function b2PolyContact(){return this.init&&this.init.apply(this,arguments)},b2Contact, function(supr) {\r\n\r\n\tthis.init = function(s1, s2) {\r\n\t\tsupr(this, 'init', s1, s2);\r\n\t\t// The constructor for b2Contact\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_node1 = new b2ContactNode();\r\n\t\tthis.m_node2 = new b2ContactNode();\r\n\t\t//\r\n\t\tthis.m_flags = 0;\r\n\r\n\t\tif (!s1 || !s2){\r\n\t\t\tthis.m_shape1 = null;\r\n\t\t\tthis.m_shape2 = null;\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis.m_shape1 = s1;\r\n\t\tthis.m_shape2 = s2;\r\n\r\n\t\tthis.m_manifoldCount = 0;\r\n\r\n\t\tthis.m_friction = Math.sqrt(this.m_shape1.m_friction * this.m_shape2.m_friction);\r\n\t\tthis.m_restitution = b2Math.b2Max(this.m_shape1.m_restitution, this.m_shape2.m_restitution);\r\n\r\n\t\tthis.m_prev = null;\r\n\t\tthis.m_next = null;\r\n\r\n\t\tthis.m_node1.contact = null;\r\n\t\tthis.m_node1.prev = null;\r\n\t\tthis.m_node1.next = null;\r\n\t\tthis.m_node1.other = null;\r\n\r\n\t\tthis.m_node2.contact = null;\r\n\t\tthis.m_node2.prev = null;\r\n\t\tthis.m_node2.next = null;\r\n\t\tthis.m_node2.other = null;\r\n\t\t//\r\n\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m0 = new b2Manifold();\r\n\t\tthis.m_manifold = [new b2Manifold()];\r\n\t\t//\r\n\r\n\t\t//super(shape1, shape2);\r\n\t\t//b2Settings.b2Assert(this.m_shape1.m_type == b2Shape.e_polyShape);\r\n\t\t//b2Settings.b2Assert(this.m_shape2.m_type == b2Shape.e_polyShape);\r\n\t\tthis.m_manifold[0].pointCount = 0;\r\n\t};\r\n\t//~b2PolyContact() {}\r\n\r\n\t// store temp manifold to reduce calls to new\r\n\r\n\tthis.Evaluate = function(){\r\n\t\tvar tMani = this.m_manifold[0];\r\n\t\t// replace memcpy\r\n\t\t// memcpy(&this.m0, &this.m_manifold, sizeof(b2Manifold));\r\n\t\t//this.m0.points = new Array(tMani.pointCount);\r\n\t\tvar tPoints = this.m0.points;\r\n\r\n\t\tfor (var k = 0; k < tMani.pointCount; k++){\r\n\t\t\tvar tPoint = tPoints[k];\r\n\t\t\tvar tPoint0 = tMani.points[k];\r\n\t\t\t//tPoint.separation = tPoint0.separation;\r\n\t\t\ttPoint.normalImpulse = tPoint0.normalImpulse;\r\n\t\t\ttPoint.tangentImpulse = tPoint0.tangentImpulse;\r\n\t\t\t//tPoint.position.SetV( tPoint0.position );\r\n\r\n\t\t\ttPoint.id = tPoint0.id.Copy();\r\n\r\n\t\t\t/*this.m0.points[k].id.features = new Features();\r\n\t\t\tthis.m0.points[k].id.features.referenceFace = this.m_manifold[0].points[k].id.features.referenceFace;\r\n\t\t\tthis.m0.points[k].id.features.incidentEdge = this.m_manifold[0].points[k].id.features.incidentEdge;\r\n\t\t\tthis.m0.points[k].id.features.incidentVertex = this.m_manifold[0].points[k].id.features.incidentVertex;\r\n\t\t\tthis.m0.points[k].id.features.flip = this.m_manifold[0].points[k].id.features.flip;*/\r\n\t\t}\r\n\t\t//this.m0.normal.SetV( tMani.normal );\r\n\t\tthis.m0.pointCount = tMani.pointCount;\r\n\r\n\t\tb2Collision.b2CollidePoly(tMani, this.m_shape1, this.m_shape2, false);\r\n\r\n\t\t// Match contact ids to facilitate warm starting.\r\n\t\tif (tMani.pointCount > 0)\r\n\t\t{\r\n\t\t\tvar match = [false, false];\r\n\r\n\t\t\t// Match old contact ids to new contact ids and copy the\r\n\t\t\t// stored impulses to warm start the solver.\r\n\t\t\tfor (var i = 0; i < tMani.pointCount; ++i)\r\n\t\t\t{\r\n\t\t\t\tvar cp = tMani.points[ i ];\r\n\r\n\t\t\t\tcp.normalImpulse = 0.0;\r\n\t\t\t\tcp.tangentImpulse = 0.0;\r\n\t\t\t\tvar idKey = cp.id.key;\r\n\r\n\t\t\t\tfor (var j = 0; j < this.m0.pointCount; ++j)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tif (match[j] == true)\r\n\t\t\t\t\t\tcontinue;\r\n\r\n\t\t\t\t\tvar cp0 = this.m0.points[j];\r\n\t\t\t\t\tvar id0 = cp0.id;\r\n\r\n\t\t\t\t\tif (id0.key == idKey)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tmatch[j] = true;\r\n\t\t\t\t\t\tcp.normalImpulse = cp0.normalImpulse;\r\n\t\t\t\t\t\tcp.tangentImpulse = cp0.tangentImpulse;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tthis.m_manifoldCount = 1;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tthis.m_manifoldCount = 0;\r\n\t\t}\r\n\t};\r\n\r\n\tthis.GetManifolds = function()\r\n\t{\r\n\t\treturn this.m_manifold;\r\n\t};\r\n});\r\n\r\nb2PolyContact.Create = function(shape1, shape2, allocator){\r\n\t\t//void* mem = allocator->Allocate(sizeof(b2PolyContact));\r\n\t\treturn new b2PolyContact(shape1, shape2);\r\n\t};\r\n\r\nb2PolyContact.Destroy = function(contact, allocator){\r\n\t\t//((b2PolyContact*)contact)->~b2PolyContact();\r\n\t\t//allocator->Free(contact, sizeof(b2PolyContact));\r\n\t};\r\n\r\nexports = b2PolyContact;\r\n","pre":true},"./src/box2d/dynamics/contacts/b2NullContact.js":{"path":"./src/box2d/dynamics/contacts/b2NullContact.js","friendlyPath":".contacts.b2NullContact","directory":"./src/box2d/dynamics/contacts/","filename":"b2NullContact.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\njsio(\"import .b2Contact as b2Contact\");\r\njsio(\"import .b2ContactNode as b2ContactNode\");\r\n\r\nvar src_box2d_dynamics_contacts_b2NullContact=__class__;var b2NullContact = exports=src_box2d_dynamics_contacts_b2NullContact(function src_box2d_dynamics_contacts_b2NullContact(){return this.init&&this.init.apply(this,arguments)},b2Contact, function(supr) {\r\n\tthis.init = function(s1, s2) {\r\n\t\tsupr(this, 'init', s1, s2);\r\n\r\n\t\t// The constructor for b2Contact\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_node1 = new b2ContactNode();\r\n\t\tthis.m_node2 = new b2ContactNode();\r\n\t\t//\r\n\t\tthis.m_flags = 0;\r\n\r\n\t\tif (!s1 || !s2){\r\n\t\t\tthis.m_shape1 = null;\r\n\t\t\tthis.m_shape2 = null;\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis.m_shape1 = s1;\r\n\t\tthis.m_shape2 = s2;\r\n\r\n\t\tthis.m_manifoldCount = 0;\r\n\r\n\t\tthis.m_friction = Math.sqrt(this.m_shape1.m_friction * this.m_shape2.m_friction);\r\n\t\tthis.m_restitution = b2Math.b2Max(this.m_shape1.m_restitution, this.m_shape2.m_restitution);\r\n\r\n\t\tthis.m_prev = null;\r\n\t\tthis.m_next = null;\r\n\r\n\t\tthis.m_node1.contact = null;\r\n\t\tthis.m_node1.prev = null;\r\n\t\tthis.m_node1.next = null;\r\n\t\tthis.m_node1.other = null;\r\n\r\n\t\tthis.m_node2.contact = null;\r\n\t\tthis.m_node2.prev = null;\r\n\t\tthis.m_node2.next = null;\r\n\t\tthis.m_node2.other = null;\r\n\t\t//\r\n\t};\r\n\tthis.Evaluate = function() {};\r\n\tthis.GetManifolds = function(){ return null; };\r\n});\r\n\r\n","pre":true},"./src/box2d/collision/b2PairCallback.js":{"path":"./src/box2d/collision/b2PairCallback.js","friendlyPath":"..collision.b2PairCallback","directory":"./src/box2d/collision/","filename":"b2PairCallback.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\n\r\nvar src_box2d_collision_b2PairCallback=__class__;var b2PairCallback = exports=src_box2d_collision_b2PairCallback(function src_box2d_collision_b2PairCallback(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\t//virtual ~b2PairCallback() {}\r\n\r\n\t// This returns the new pair user data.\r\n\tthis.PairAdded = function(proxyUserData1, proxyUserData2){return null},\r\n\r\n\t// This should free the pair's user data. In extreme circumstances, it is possible\r\n\t// this will be called with null pairUserData because the pair never existed.\r\n\tthis.PairRemoved = function(proxyUserData1, proxyUserData2, pairUserData){},\r\n\tthis.init = function() {};\r\n});\r\n\r\n\r\n","pre":true},"./src/box2d/dynamics/b2CollisionFilter.js":{"path":"./src/box2d/dynamics/b2CollisionFilter.js","friendlyPath":".b2CollisionFilter","directory":"./src/box2d/dynamics/","filename":"b2CollisionFilter.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\nb2CollisionFilter=__class__;var b2CollisionFilter=b2CollisionFilter(function b2CollisionFilter(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\r\n\r\n\t// Return true if contact calculations should be performed between these two shapes.\r\n\tthis.ShouldCollide = function(shape1, shape2){\r\n\t\tif (shape1.m_groupIndex == shape2.m_groupIndex && shape1.m_groupIndex != 0)\r\n\t\t{\r\n\t\t\treturn shape1.m_groupIndex > 0;\r\n\t\t}\r\n\r\n\t\tvar collide = (shape1.m_maskBits & shape2.m_categoryBits) != 0 && (shape1.m_categoryBits & shape2.m_maskBits) != 0;\r\n\t\treturn collide;\r\n\t};\r\n\r\n\tthis.init = function() {};\r\n});\r\n\r\nb2CollisionFilter.b2_defaultFilter = new b2CollisionFilter;\r\nexports = b2CollisionFilter;\r\n\r\n","pre":true},"./src/box2d/dynamics/b2TimeStep.js":{"path":"./src/box2d/dynamics/b2TimeStep.js","friendlyPath":".b2TimeStep","directory":"./src/box2d/dynamics/","filename":"b2TimeStep.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\n\r\nvar src_box2d_dynamics_b2TimeStep=__class__;var b2TimeStep = exports=src_box2d_dynamics_b2TimeStep(function src_box2d_dynamics_b2TimeStep(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\tthis.init = function() {\r\n\t\tthis.dt = null;\r\n\t\tthis.inv_dt = null;\r\n\t\tthis.iterations = 0;\r\n\t};\r\n});\r\n","pre":true},"./src/box2d/dynamics/b2Body.js":{"path":"./src/box2d/dynamics/b2Body.js","friendlyPath":".b2Body","directory":"./src/box2d/dynamics/","filename":"b2Body.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\njsio(\"import ..common.b2Settings as b2Settings\");\r\njsio(\"import ..common.math.b2Math as b2Math\");\r\njsio(\"import ..common.math.b2Math2 as b2Math2\");\r\njsio(\"import ..common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import ..common.math.b2Mat22 as b2Mat22\");\r\njsio(\"import ..collision.shapes.b2Shape as b2Shape\");\r\njsio(\"import ..collision.shapes.b2MassData as b2MassData\");\r\njsio(\"import ..collision.shapes.b2ShapeFactory as b2ShapeFactory\");\r\n\r\n\r\n// A rigid body. Internal computation are done in terms\r\n// of the center of mass position. The center of mass may\r\n// be offset from the body's origin.\r\nb2Body=__class__;var b2Body=b2Body(function b2Body(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\r\n\t// Set the position of the body's origin and rotation (radians).\r\n\t// This breaks any contacts and wakes the other bodies.\r\n\tthis.SetOriginPosition = function(position, rotation){\r\n\t\tif (this.IsFrozen())\r\n\t\t{\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis.m_rotation = rotation;\r\n\t\tthis.m_R.Set(this.m_rotation);\r\n\t\tthis.m_position = b2Math.AddVV(position , b2Math.b2MulMV(this.m_R, this.m_center));\r\n\r\n\t\tthis.m_position0.SetV(this.m_position);\r\n\t\tthis.m_rotation0 = this.m_rotation;\r\n\r\n\t\tfor (var s = this.m_shapeList; s != null; s = s.m_next)\r\n\t\t{\r\n\t\t\ts.Synchronize(this.m_position, this.m_R, this.m_position, this.m_R);\r\n\t\t}\r\n\r\n\t\tthis.m_world.m_broadPhase.Commit();\r\n\t};\r\n\r\n\t// Get the position of the body's origin. The body's origin does not\r\n\t// necessarily coincide with the center of mass. It depends on how the\r\n\t// shapes are created.\r\n\tthis.GetOriginPosition = function(){\r\n\t\treturn b2Math.SubtractVV(this.m_position, b2Math.b2MulMV(this.m_R, this.m_center));\r\n\t};\r\n\r\n\t// Set the position of the body's center of mass and rotation (radians).\r\n\t// This breaks any contacts and wakes the other bodies.\r\n\tthis.SetCenterPosition = function(position, rotation){\r\n\t\tif (this.IsFrozen())\r\n\t\t{\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis.m_rotation = rotation;\r\n\t\tthis.m_R.Set(this.m_rotation);\r\n\t\tthis.m_position.SetV( position );\r\n\r\n\t\tthis.m_position0.SetV(this.m_position);\r\n\t\tthis.m_rotation0 = this.m_rotation;\r\n\r\n\t\tfor (var s = this.m_shapeList; s != null; s = s.m_next)\r\n\t\t{\r\n\t\t\ts.Synchronize(this.m_position, this.m_R, this.m_position, this.m_R);\r\n\t\t}\r\n\r\n\t\tthis.m_world.m_broadPhase.Commit();\r\n\t};\r\n\r\n\t// Get the position of the body's center of mass. The body's center of mass\r\n\t// does not necessarily coincide with the body's origin. It depends on how the\r\n\t// shapes are created.\r\n\tthis.GetCenterPosition = function(){\r\n\t\treturn this.m_position;\r\n\t};\r\n\r\n\t// Get the rotation in radians.\r\n\tthis.GetRotation = function(){\r\n\t\treturn this.m_rotation;\r\n\t};\r\n\r\n\tthis.GetRotationMatrix = function(){\r\n\t\treturn this.m_R;\r\n\t};\r\n\r\n\t// Set/Get the linear velocity of the center of mass.\r\n\tthis.SetLinearVelocity = function(v){\r\n\t\tthis.m_linearVelocity.SetV(v);\r\n\t};\r\n\tthis.GetLinearVelocity = function(){\r\n\t\treturn this.m_linearVelocity;\r\n\t};\r\n\r\n\t// Set/Get the angular velocity.\r\n\tthis.SetAngularVelocity = function(w){\r\n\t\tthis.m_angularVelocity = w;\r\n\t};\r\n\tthis.GetAngularVelocity = function(){\r\n\t\treturn this.m_angularVelocity;\r\n\t};\r\n\r\n\t// Apply a force at a world point. Additive.\r\n\tthis.ApplyForce = function(force, point)\r\n\t{\r\n\t\tif (this.IsSleeping() == false)\r\n\t\t{\r\n\t\t\tthis.m_force.Add( force );\r\n\t\t\tthis.m_torque += b2Math.b2CrossVV(b2Math.SubtractVV(point, this.m_position), force);\r\n\t\t}\r\n\t};\r\n\r\n\t// Apply a torque. Additive.\r\n\tthis.ApplyTorque = function(torque)\r\n\t{\r\n\t\tif (this.IsSleeping() == false)\r\n\t\t{\r\n\t\t\tthis.m_torque += torque;\r\n\t\t}\r\n\t};\r\n\r\n\t// Apply an impulse at a point. This immediately modifies the velocity.\r\n\tthis.ApplyImpulse = function(impulse, point)\r\n\t{\r\n\t\tif (this.IsSleeping() == false)\r\n\t\t{\r\n\t\t\tthis.m_linearVelocity.Add( b2Math.MulFV(this.m_invMass, impulse) );\r\n\t\t\tthis.m_angularVelocity += ( this.m_invI * b2Math.b2CrossVV( b2Math.SubtractVV(point, this.m_position), impulse)  );\r\n\t\t}\r\n\t};\r\n\r\n\tthis.GetMass = function(){\r\n\t\treturn this.m_mass;\r\n\t};\r\n\r\n\tthis.GetInertia = function(){\r\n\t\treturn this.m_I;\r\n\t};\r\n\r\n\t// Get the world coordinates of a point give the local coordinates\r\n\t// relative to the body's center of mass.\r\n\tthis.GetWorldPoint = function(localPoint){\r\n\t\treturn b2Math.AddVV(this.m_position , b2Math.b2MulMV(this.m_R, localPoint));\r\n\t};\r\n\r\n\t// Get the world coordinates of a vector given the local coordinates.\r\n\tthis.GetWorldVector = function(localVector){\r\n\t\treturn b2Math.b2MulMV(this.m_R, localVector);\r\n\t};\r\n\r\n\t// Returns a local point relative to the center of mass given a world point.\r\n\tthis.GetLocalPoint = function(worldPoint){\r\n\t\treturn b2Math.b2MulTMV(this.m_R, b2Math.SubtractVV(worldPoint, this.m_position));\r\n\t};\r\n\r\n\t// Returns a local vector given a world vector.\r\n\tthis.GetLocalVector = function(worldVector){\r\n\t\treturn b2Math.b2MulTMV(this.m_R, worldVector);\r\n\t};\r\n\r\n\t// Is this body static (immovable)?\r\n\tthis.IsStatic = function(){\r\n\t\treturn (this.m_flags & b2Body.e_staticFlag) == b2Body.e_staticFlag;\r\n\t};\r\n\r\n\tthis.IsFrozen = function()\r\n\t{\r\n\t\treturn (this.m_flags & b2Body.e_frozenFlag) == b2Body.e_frozenFlag;\r\n\t};\r\n\r\n\t// Is this body sleeping (not simulating).\r\n\tthis.IsSleeping = function(){\r\n\t\treturn (this.m_flags & b2Body.e_sleepFlag) == b2Body.e_sleepFlag;\r\n\t};\r\n\r\n\t// You can disable sleeping on this particular body.\r\n\tthis.AllowSleeping = function(flag)\r\n\t{\r\n\t\tif (flag)\r\n\t\t{\r\n\t\t\tthis.m_flags |= b2Body.e_allowSleepFlag;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tthis.m_flags &= ~b2Body.e_allowSleepFlag;\r\n\t\t\tthis.WakeUp();\r\n\t\t}\r\n\t};\r\n\r\n\t// Wake up this body so it will begin simulating.\r\n\tthis.WakeUp = function(){\r\n\t\tthis.m_flags &= ~b2Body.e_sleepFlag;\r\n\t\tthis.m_sleepTime = 0.0;\r\n\t};\r\n\r\n\t// Get the list of all shapes attached to this body.\r\n\tthis.GetShapeList = function(){\r\n\t\treturn this.m_shapeList;\r\n\t};\r\n\r\n\tthis.GetContactList = function()\r\n\t{\r\n\t\treturn this.m_contactList;\r\n\t};\r\n\r\n\tthis.GetJointList = function()\r\n\t{\r\n\t\treturn this.m_jointList;\r\n\t};\r\n\r\n\t// Get the next body in the world's body list.\r\n\tthis.GetNext = function(){\r\n\t\treturn this.m_next;\r\n\t};\r\n\r\n\tthis.GetUserData = function(){\r\n\t\treturn this.m_userData;\r\n\t};\r\n\r\n\t//--------------- Internals Below -------------------\r\n\r\n\tthis.init = function(bd, world){\r\n\t\t// initialize instance variables for references\r\n\t\tthis.sMat0 = new b2Mat22();\r\n\t\tthis.m_position = new b2Vec2();\r\n\t\tthis.m_R = new b2Mat22(0);\r\n\t\tthis.m_position0 = new b2Vec2();\r\n\t\t//\r\n\r\n\t\tvar i = 0;\r\n\t\tvar sd;\r\n\t\tvar massData;\r\n\r\n\t\tthis.m_flags = 0;\r\n\t\tthis.m_position.SetV( bd.position );\r\n\t\tthis.m_rotation = bd.rotation;\r\n\t\tthis.m_R.Set(this.m_rotation);\r\n\t\tthis.m_position0.SetV(this.m_position);\r\n\t\tthis.m_rotation0 = this.m_rotation;\r\n\t\tthis.m_world = world;\r\n\r\n\t\tthis.m_linearDamping = b2Math.b2Clamp(1.0 - bd.linearDamping, 0.0, 1.0);\r\n\t\tthis.m_angularDamping = b2Math.b2Clamp(1.0 - bd.angularDamping, 0.0, 1.0);\r\n\r\n\t\tthis.m_force = new b2Vec2(0.0, 0.0);\r\n\t\tthis.m_torque = 0.0;\r\n\r\n\t\tthis.m_mass = 0.0;\r\n\r\n\t\tvar massDatas = new Array(b2Settings.b2_maxShapesPerBody);\r\n\t\tfor (i = 0; i < b2Settings.b2_maxShapesPerBody; i++){\r\n\t\t\tmassDatas[i] = new b2MassData();\r\n\t\t}\r\n\r\n\t\t// Compute the shape mass properties, the bodies total mass and COM.\r\n\t\tthis.m_shapeCount = 0;\r\n\t\tthis.m_center = new b2Vec2(0.0, 0.0);\r\n\t\tfor (i = 0; i < b2Settings.b2_maxShapesPerBody; ++i)\r\n\t\t{\r\n\t\t\tsd = bd.shapes[i];\r\n\t\t\tif (sd == null) break;\r\n\t\t\tmassData = massDatas[ i ];\r\n\t\t\tsd.ComputeMass(massData);\r\n\t\t\tthis.m_mass += massData.mass;\r\n\t\t\t//this.m_center += massData->mass * (sd->localPosition + massData->center);\r\n\t\t\tthis.m_center.x += massData.mass * (sd.localPosition.x + massData.center.x);\r\n\t\t\tthis.m_center.y += massData.mass * (sd.localPosition.y + massData.center.y);\r\n\t\t\t++this.m_shapeCount;\r\n\t\t}\r\n\r\n\t\t// Compute center of mass, and shift the origin to the COM.\r\n\t\tif (this.m_mass > 0.0)\r\n\t\t{\r\n\t\t\tthis.m_center.Multiply( 1.0 / this.m_mass );\r\n\t\t\tthis.m_position.sAdd( b2Math.b2MulMV(this.m_R, this.m_center) );\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tthis.m_flags |= b2Body.e_staticFlag;\r\n\t\t}\r\n\r\n\t\t// Compute the moment of inertia.\r\n\t\tthis.m_I = 0.0;\r\n\t\tfor (i = 0; i < this.m_shapeCount; ++i)\r\n\t\t{\r\n\t\t\tsd = bd.shapes[i];\r\n\t\t\tmassData = massDatas[ i ];\r\n\t\t\tthis.m_I += massData.I;\r\n\t\t\tvar r = b2Math.SubtractVV( b2Math.AddVV(sd.localPosition, massData.center), this.m_center );\r\n\t\t\tthis.m_I += massData.mass * b2Math2.b2Dot(r, r);\r\n\t\t}\r\n\r\n\t\tif (this.m_mass > 0.0)\r\n\t\t{\r\n\t\t\tthis.m_invMass = 1.0 / this.m_mass;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tthis.m_invMass = 0.0;\r\n\t\t}\r\n\r\n\t\tif (this.m_I > 0.0 && bd.preventRotation == false)\r\n\t\t{\r\n\t\t\tthis.m_invI = 1.0 / this.m_I;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tthis.m_I = 0.0;\r\n\t\t\tthis.m_invI = 0.0;\r\n\t\t}\r\n\r\n\t\t// Compute the center of mass velocity.\r\n\t\tthis.m_linearVelocity = b2Math.AddVV(bd.linearVelocity, b2Math.b2CrossFV(bd.angularVelocity, this.m_center));\r\n\t\tthis.m_angularVelocity = bd.angularVelocity;\r\n\r\n\t\tthis.m_jointList = null;\r\n\t\tthis.m_contactList = null;\r\n\t\tthis.m_prev = null;\r\n\t\tthis.m_next = null;\r\n\r\n\t\t// Create the shapes.\r\n\t\tthis.m_shapeList = null;\r\n\t\tfor (i = 0; i < this.m_shapeCount; ++i)\r\n\t\t{\r\n\t\t\tsd = bd.shapes[i];\r\n\t\t\tvar shape = b2ShapeFactory.Create(sd, this, this.m_center);\r\n\t\t\tshape.m_next = this.m_shapeList;\r\n\t\t\tthis.m_shapeList = shape;\r\n\t\t}\r\n\r\n\t\tthis.m_sleepTime = 0.0;\r\n\t\tif (bd.allowSleep)\r\n\t\t{\r\n\t\t\tthis.m_flags |= b2Body.e_allowSleepFlag;\r\n\t\t}\r\n\t\tif (bd.isSleeping)\r\n\t\t{\r\n\t\t\tthis.m_flags |= b2Body.e_sleepFlag;\r\n\t\t}\r\n\r\n\t\tif ((this.m_flags & b2Body.e_sleepFlag)  || this.m_invMass == 0.0)\r\n\t\t{\r\n\t\t\tthis.m_linearVelocity.Set(0.0, 0.0);\r\n\t\t\tthis.m_angularVelocity = 0.0;\r\n\t\t}\r\n\r\n\t\tthis.m_userData = bd.userData;\r\n\t};\r\n\t// does not support destructors\r\n\t/*~b2Body(){\r\n\t\tb2Shape* s = this.m_shapeList;\r\n\t\twhile (s)\r\n\t\t{\r\n\t\t\tb2Shape* s0 = s;\r\n\t\t\ts = s->this.m_next;\r\n\r\n\t\t\tb2Shape::this.Destroy(s0);\r\n\t\t}\r\n\t}*/\r\n\r\n\tthis.Destroy = function(){\r\n\t\tvar s = this.m_shapeList;\r\n\t\twhile (s)\r\n\t\t{\r\n\t\t\tvar s0 = s;\r\n\t\t\ts = s.m_next;\r\n\r\n\t\t\tb2Shape.Destroy(s0);\r\n\t\t}\r\n\t};\r\n\r\n\t// Temp mat\r\n\tthis.sMat0 = new b2Mat22();\r\n\tthis.SynchronizeShapes = function(){\r\n\t\t//b2Mat22 R0(this.m_rotation0);\r\n\t\tthis.sMat0.Set(this.m_rotation0);\r\n\t\tfor (var s = this.m_shapeList; s != null; s = s.m_next)\r\n\t\t{\r\n\t\t\ts.Synchronize(this.m_position0, this.sMat0, this.m_position, this.m_R);\r\n\t\t}\r\n\t};\r\n\r\n\tthis.QuickSyncShapes = function(){\r\n\t\tfor (var s = this.m_shapeList; s != null; s = s.m_next)\r\n\t\t{\r\n\t\t\ts.QuickSync(this.m_position, this.m_R);\r\n\t\t}\r\n\t};\r\n\r\n\t// This is used to prevent connected bodies from colliding.\r\n\t// It may lie, depending on the collideConnected flag.\r\n\tthis.IsConnected = function(other){\r\n\t\tfor (var jn = this.m_jointList; jn != null; jn = jn.next)\r\n\t\t{\r\n\t\t\tif (jn.other == other)\r\n\t\t\t\treturn jn.joint.m_collideConnected == false;\r\n\t\t}\r\n\r\n\t\treturn false;\r\n\t};\r\n\r\n\tthis.Freeze = function(){\r\n\t\tthis.m_flags |= b2Body.e_frozenFlag;\r\n\t\tthis.m_linearVelocity.SetZero();\r\n\t\tthis.m_angularVelocity = 0.0;\r\n\r\n\t\tfor (var s = this.m_shapeList; s != null; s = s.m_next)\r\n\t\t{\r\n\t\t\ts.DestroyProxy();\r\n\t\t}\r\n\t};\r\n\r\n});\r\n\r\nb2Body.e_staticFlag = 0x0001;\r\nb2Body.e_frozenFlag = 0x0002;\r\nb2Body.e_islandFlag = 0x0004;\r\nb2Body.e_sleepFlag = 0x0008;\r\nb2Body.e_allowSleepFlag = 0x0010;\r\nb2Body.e_destroyFlag = 0x0020;\r\n\r\nexports = b2Body;\r\n\r\n//\tm_flags: 0,\r\n//\r\n//\tm_position: new b2Vec2(),\r\n//\tm_rotation: null,\r\n//\tm_R: new b2Mat22(0),\r\n//\r\n//\t// Conservative advancement data.\r\n//\tm_position0: new b2Vec2(),\r\n//\tm_rotation0: null,\r\n//\r\n//\tm_linearVelocity: null,\r\n//\tm_angularVelocity: null,\r\n//\r\n//\tm_force: null,\r\n//\tm_torque: null,\r\n//\r\n//\tm_center: null,\r\n//\r\n//\tm_world: null,\r\n//\tm_prev: null,\r\n//\tm_next: null,\r\n//\r\n//\tm_shapeList: null,\r\n//\tm_shapeCount: 0,\r\n//\r\n//\tm_jointList: null,\r\n//\tm_contactList: null,\r\n//\r\n//\tm_mass: null,\r\n//\tm_invMass: null,\r\n//\tm_I: null,\r\n//\tm_invI: null,\r\n//\r\n//\tm_linearDamping: null,\r\n//\tm_angularDamping: null,\r\n//\r\n//\tm_sleepTime: null,\r\n//\r\n//\tm_userData: null};\r\n","pre":true},"./src/box2d/collision/shapes/b2MassData.js":{"path":"./src/box2d/collision/shapes/b2MassData.js","friendlyPath":"..collision.shapes.b2MassData","directory":"./src/box2d/collision/shapes/","filename":"b2MassData.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\njsio(\"import ...common.math.b2Vec2 as b2Vec2\");\r\n\r\nvar src_box2d_collision_shapes_b2MassData=__class__;var b2MassData = exports=src_box2d_collision_shapes_b2MassData(function src_box2d_collision_shapes_b2MassData(){return this.init&&this.init.apply(this,arguments)},function() { \r\n\tthis.init = function() {\r\n\t\t// initialize instance variables for references\r\n\t\tthis.center = new b2Vec2(0,0);\r\n\t\tthis.I = 0.0;\r\n\t\tthis.mass = 0.0;\r\n\t};\r\n});\r\n","pre":true},"./src/box2d/collision/shapes/b2ShapeFactory.js":{"path":"./src/box2d/collision/shapes/b2ShapeFactory.js","friendlyPath":"..collision.shapes.b2ShapeFactory","directory":"./src/box2d/collision/shapes/","filename":"b2ShapeFactory.js","src":"\njsio(\"import .b2Shape as b2Shape\");\njsio(\"import .b2CircleShape as b2CircleShape\");\njsio(\"import .b2PolyShape as b2PolyShape\");\n\nexports.Create = function(def, body, center){\n\t\tswitch (def.type)\n\t\t{\n\t\tcase b2Shape.e_circleShape:\n\t\t\t{\n\t\t\t\t//void* mem = body->m_world->m_blockAllocator.Allocate(sizeof(b2CircleShape));\n\t\t\t\treturn new b2CircleShape(def, body, center);\n\t\t\t}\n\n\t\tcase b2Shape.e_boxShape:\n\t\tcase b2Shape.e_polyShape:\n\t\t\t{\n\t\t\t\t//void* mem = body->m_world->m_blockAllocator.Allocate(sizeof(b2PolyShape));\n\t\t\t\treturn new b2PolyShape(def, body, center);\n\t\t\t}\n\t\t}\n\n\t\t//b2Settings.b2Assert(false);\n\t\treturn null;\n\t};\n","pre":true},"./src/box2d/collision/shapes/b2CircleShape.js":{"path":"./src/box2d/collision/shapes/b2CircleShape.js","friendlyPath":".b2CircleShape","directory":"./src/box2d/collision/shapes/","filename":"b2CircleShape.js","src":"/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\njsio(\"import ...common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import ...common.math.b2Math as b2Math\");\r\njsio(\"import ...common.math.b2Mat22 as b2Mat22\");\r\njsio(\"import ..b2AABB as b2AABB\");\r\njsio(\"import ..b2Pair as b2Pair\");\r\njsio(\"import .b2Shape as b2Shape\");\r\n\r\n\r\n\r\nvar src_box2d_collision_shapes_b2CircleShape=__class__;var b2CircleShape = exports=src_box2d_collision_shapes_b2CircleShape(function src_box2d_collision_shapes_b2CircleShape(){return this.init&&this.init.apply(this,arguments)},b2Shape, function(supr) {\r\n\tthis.TestPoint = function(p){\r\n\t\t//var d = b2Math.SubtractVV(p, this.m_position);\r\n\t\tvar d = new b2Vec2();\r\n\t\td.SetV(p);\r\n\t\td.Subtract(this.m_position);\r\n\t\treturn b2Math.b2Dot(d, d) <= this.m_radius * this.m_radius;\r\n\t};\r\n\r\n\t//--------------- Internals Below -------------------\r\n\r\n\tthis.init = function(def, body, localCenter){\r\n\t\tsupr(this, 'init', [def], [body]);\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_R = new b2Mat22();\r\n\t\tthis.m_position = new b2Vec2();\r\n\t\t//\r\n\r\n\t\t// The constructor for b2Shape\r\n\t\tthis.m_userData = def.userData;\r\n\r\n\t\tthis.m_friction = def.friction;\r\n\t\tthis.m_restitution = def.restitution;\r\n\t\tthis.m_body = body;\r\n\r\n\t\tthis.m_proxyId = b2Pair.b2_nullProxy;\r\n\r\n\t\tthis.m_maxRadius = 0.0;\r\n\r\n\t\tthis.m_categoryBits = def.categoryBits;\r\n\t\tthis.m_maskBits = def.maskBits;\r\n\t\tthis.m_groupIndex = def.groupIndex;\r\n\t\t//\r\n\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_localPosition = new b2Vec2();\r\n\t\t//\r\n\r\n\t\t//super(def, body);\r\n\r\n\t\t//b2Settings.b2Assert(def.type == b2Shape.e_circleShape);\r\n\t\tvar circle = def;\r\n\r\n\t\t//this.m_localPosition = def.localPosition - localCenter;\r\n\t\tthis.m_localPosition.Set(def.localPosition.x - localCenter.x, def.localPosition.y - localCenter.y);\r\n\t\tthis.m_type = b2Shape.e_circleShape;\r\n\t\tthis.m_radius = circle.radius;\r\n\r\n\t\tthis.m_R.SetM(this.m_body.m_R);\r\n\t\t//b2Vec2 r = b2Mul(this.m_body->this.m_R, this.m_localPosition);\r\n\t\tvar rX = this.m_R.col1.x * this.m_localPosition.x + this.m_R.col2.x * this.m_localPosition.y;\r\n\t\tvar rY = this.m_R.col1.y * this.m_localPosition.x + this.m_R.col2.y * this.m_localPosition.y;\r\n\t\t//this.m_position = this.m_body->this.m_position + r;\r\n\t\tthis.m_position.x = this.m_body.m_position.x + rX;\r\n\t\tthis.m_position.y = this.m_body.m_position.y + rY;\r\n\t\t//this.m_maxRadius = r.Length() + this.m_radius;\r\n\t\tthis.m_maxRadius = Math.sqrt(rX*rX+rY*rY) + this.m_radius;\r\n\r\n\t\tvar aabb = new b2AABB();\r\n\t\taabb.minVertex.Set(this.m_position.x - this.m_radius, this.m_position.y - this.m_radius);\r\n\t\taabb.maxVertex.Set(this.m_position.x + this.m_radius, this.m_position.y + this.m_radius);\r\n\r\n\t\tvar broadPhase = this.m_body.m_world.m_broadPhase;\r\n\t\tif (broadPhase.InRange(aabb))\r\n\t\t{\r\n\t\t\tthis.m_proxyId = broadPhase.CreateProxy(aabb, this);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tthis.m_proxyId = b2Pair.b2_nullProxy;\r\n\t\t}\r\n\r\n\t\tif (this.m_proxyId == b2Pair.b2_nullProxy)\r\n\t\t{\r\n\t\t\tthis.m_body.Freeze();\r\n\t\t}\r\n\t};\r\n\r\n\tthis.Synchronize = function(position1, R1, position2, R2){\r\n\t\tthis.m_R.SetM(R2);\r\n\t\t//this.m_position = position2 + b2Mul(R2, this.m_localPosition);\r\n\t\tthis.m_position.x = (R2.col1.x * this.m_localPosition.x + R2.col2.x * this.m_localPosition.y) + position2.x;\r\n\t\tthis.m_position.y = (R2.col1.y * this.m_localPosition.x + R2.col2.y * this.m_localPosition.y) + position2.y;\r\n\r\n\t\tif (this.m_proxyId == b2Pair.b2_nullProxy)\r\n\t\t{\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Compute an AABB that covers the swept shape (may miss some rotation effect).\r\n\t\t//b2Vec2 p1 = position1 + b2Mul(R1, this.m_localPosition);\r\n\t\tvar p1X = position1.x + (R1.col1.x * this.m_localPosition.x + R1.col2.x * this.m_localPosition.y);\r\n\t\tvar p1Y = position1.y + (R1.col1.y * this.m_localPosition.x + R1.col2.y * this.m_localPosition.y);\r\n\t\t//b2Vec2 lower = b2Min(p1, this.m_position);\r\n\t\tvar lowerX = Math.min(p1X, this.m_position.x);\r\n\t\tvar lowerY = Math.min(p1Y, this.m_position.y);\r\n\t\t//b2Vec2 upper = b2Max(p1, this.m_position);\r\n\t\tvar upperX = Math.max(p1X, this.m_position.x);\r\n\t\tvar upperY = Math.max(p1Y, this.m_position.y);\r\n\r\n\t\tvar aabb = new b2AABB();\r\n\t\taabb.minVertex.Set(lowerX - this.m_radius, lowerY - this.m_radius);\r\n\t\taabb.maxVertex.Set(upperX + this.m_radius, upperY + this.m_radius);\r\n\r\n\t\tvar broadPhase = this.m_body.m_world.m_broadPhase;\r\n\t\tif (broadPhase.InRange(aabb))\r\n\t\t{\r\n\t\t\tbroadPhase.MoveProxy(this.m_proxyId, aabb);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tthis.m_body.Freeze();\r\n\t\t}\r\n\t};\r\n\r\n\tthis.QuickSync = function(position, R){\r\n\t\tthis.m_R.SetM(R);\r\n\t\t//this.m_position = position + b2Mul(R, this.m_localPosition);\r\n\t\tthis.m_position.x = (R.col1.x * this.m_localPosition.x + R.col2.x * this.m_localPosition.y) + position.x;\r\n\t\tthis.m_position.y = (R.col1.y * this.m_localPosition.x + R.col2.y * this.m_localPosition.y) + position.y;\r\n\t};\r\n\r\n\r\n\tthis.ResetProxy = function(broadPhase){\r\n\t\tif (this.m_proxyId == b2Pair.b2_nullProxy)\r\n\t\t{\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tvar proxy = broadPhase.GetProxy(this.m_proxyId);\r\n\r\n\t\tbroadPhase.DestroyProxy(this.m_proxyId);\r\n\t\tproxy = null;\r\n\r\n\t\tvar aabb = new b2AABB();\r\n\t\taabb.minVertex.Set(this.m_position.x - this.m_radius, this.m_position.y - this.m_radius);\r\n\t\taabb.maxVertex.Set(this.m_position.x + this.m_radius, this.m_position.y + this.m_radius);\r\n\r\n\t\tif (broadPhase.InRange(aabb))\r\n\t\t{\r\n\t\t\tthis.m_proxyId = broadPhase.CreateProxy(aabb, this);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tthis.m_proxyId = b2Pair.b2_nullProxy;\r\n\t\t}\r\n\r\n\t\tif (this.m_proxyId == b2Pair.b2_nullProxy)\r\n\t\t{\r\n\t\t\tthis.m_body.Freeze();\r\n\t\t}\r\n\t};\r\n\r\n\r\n\tthis.Support = function(dX, dY, out){\r\n\t\t//b2Vec2 u = d;\r\n\t\t//u.Normalize();\r\n\t\tvar len = Math.sqrt(dX*dX + dY*dY);\r\n\t\tdX /= len;\r\n\t\tdY /= len;\r\n\t\t//return this.m_position + this.m_radius * u;\r\n\t\tout.Set(\tthis.m_position.x + this.m_radius*dX,\r\n\t\t\t\t\tthis.m_position.y + this.m_radius*dY);\r\n\t};\r\n});\r\n\r\n\r\n\r\n","pre":true},"./src/box2d/collision/shapes/b2PolyShape.js":{"path":"./src/box2d/collision/shapes/b2PolyShape.js","friendlyPath":".b2PolyShape","directory":"./src/box2d/collision/shapes/","filename":"b2PolyShape.js","src":"/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\n\r\n\r\n\r\n// A convex polygon. The position of the polygon (m_position) is the\r\n// position of the centroid. The vertices of the incoming polygon are pre-rotated\r\n// according to the local rotation. The vertices are also shifted to be centered\r\n// on the centroid. Since the local rotation is absorbed into the vertex\r\n// coordinates, the polygon rotation is equal to the body rotation. However,\r\n// the polygon position is centered on the polygon centroid. This simplifies\r\n// some collision algorithms.\r\n\r\njsio(\"import .b2Shape as b2Shape\");\r\njsio(\"import ..b2AABB as b2AABB\");\r\njsio(\"import ..b2OBB as b2OBB\");\r\njsio(\"import ..b2Pair as b2Pair\");\r\njsio(\"import ...common.b2Settings as b2Settings\");\r\njsio(\"import ...common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import ...common.math.b2Math as b2Math\");\r\njsio(\"import ...common.math.b2Mat22 as b2Mat22\");\r\n\r\nvar src_box2d_collision_shapes_b2PolyShape=__class__;var b2PolyShape = exports=src_box2d_collision_shapes_b2PolyShape(function src_box2d_collision_shapes_b2PolyShape(){return this.init&&this.init.apply(this,arguments)},b2Shape, function(supr) {\r\n\r\n\tthis.TestPoint = function(p){\r\n\r\n\t\t//var pLocal = b2Math.b2MulTMV(this.m_R, b2Math.SubtractVV(p, this.m_position));\r\n\t\tvar pLocal = new b2Vec2();\r\n\t\tpLocal.SetV(p);\r\n\t\tpLocal.Subtract(this.m_position);\r\n\t\tpLocal.MulTM(this.m_R);\r\n\r\n\t\tfor (var i = 0; i < this.m_vertexCount; ++i)\r\n\t\t{\r\n\t\t\t//var dot = b2Math.b2Dot(this.m_normals[i], b2Math.SubtractVV(pLocal, this.m_vertices[i]));\r\n\t\t\tvar tVec = new b2Vec2();\r\n\t\t\ttVec.SetV(pLocal);\r\n\t\t\ttVec.Subtract(this.m_vertices[i]);\r\n\r\n\t\t\tvar dot = b2Math.b2Dot(this.m_normals[i], tVec);\r\n\t\t\tif (dot > 0.0)\r\n\t\t\t{\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn true;\r\n\t};\r\n\r\n\t//--------------- Internals Below -------------------\r\n\t// Temp vec for b2Shape.PolyCentroid\r\n\r\n\tthis.init = function(def, body, newOrigin){\r\n\t\tsupr(this, 'init', [def], [body]);\r\n\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_R = new b2Mat22();\r\n\t\tthis.m_position = new b2Vec2();\r\n\t\t//\r\n\r\n\t\t// The constructor for b2Shape\r\n\t\tthis.m_userData = def.userData;\r\n\r\n\t\tthis.m_friction = def.friction;\r\n\t\tthis.m_restitution = def.restitution;\r\n\t\tthis.m_body = body;\r\n\r\n\t\tthis.m_proxyId = b2Pair.b2_nullProxy;\r\n\r\n\t\tthis.m_maxRadius = 0.0;\r\n\r\n\t\tthis.m_categoryBits = def.categoryBits;\r\n\t\tthis.m_maskBits = def.maskBits;\r\n\t\tthis.m_groupIndex = def.groupIndex;\r\n\t\t//\r\n\r\n\t\t// initialize instance variables for references\r\n\t\tthis.syncAABB = new b2AABB();\r\n\t\tthis.syncMat = new b2Mat22();\r\n\t\tthis.m_localCentroid = new b2Vec2();\r\n\t\tthis.m_localOBB = new b2OBB();\r\n\t\t//\r\n\r\n\r\n\t\t//super(def, body);\r\n\r\n\t\tvar i = 0;\r\n\r\n\r\n\t\tvar hX;\r\n\t\tvar hY;\r\n\r\n\t\tvar tVec;\r\n\r\n\t\tvar aabb = new b2AABB();\r\n\r\n\t\t// Vertices\r\n\t\tthis.m_vertices = new Array(b2Settings.b2_maxPolyVertices);\r\n\t\tthis.m_coreVertices = new Array(b2Settings.b2_maxPolyVertices);\r\n\t\t//for (i = 0; i < b2Settings.b2_maxPolyVertices; i++)\r\n\t\t//\tthis.m_vertices[i] = new b2Vec2();\r\n\r\n\t\t// Normals\r\n\t\tthis.m_normals = new Array(b2Settings.b2_maxPolyVertices);\r\n\t\t//for (i = 0; i < b2Settings.b2_maxPolyVertices; i++)\r\n\t\t//\tthis.m_normals[i] = new b2Vec2();\r\n\r\n\t\t//b2Settings.b2Assert(def.type == b2Shape.e_boxShape || def.type == b2Shape.e_polyShape);\r\n\t\tthis.m_type = b2Shape.e_polyShape;\r\n\r\n\t\tvar localR = new b2Mat22(def.localRotation);\r\n\r\n\t\t// Get the vertices transformed into the body frame.\r\n\t\tif (def.type == b2Shape.e_boxShape)\r\n\t\t{\r\n\t\t\t//this.m_localCentroid = def.localPosition - newOrigin;\r\n\t\t\tthis.m_localCentroid.x = def.localPosition.x - newOrigin.x;\r\n\t\t\tthis.m_localCentroid.y = def.localPosition.y - newOrigin.y;\r\n\r\n\t\t\tvar box = def;\r\n\t\t\tthis.m_vertexCount = 4;\r\n\t\t\thX = box.extents.x;\r\n\t\t\thY = box.extents.y;\r\n\r\n\t\t\t//hc.x = b2Max(0.0f, h.x - 2.0f * b2_linearSlop);\r\n\t\t\tvar hcX = Math.max(0.0, hX - 2.0 * b2Settings.b2_linearSlop);\r\n\t\t\t//hc.y = b2Max(0.0f, h.y - 2.0f * b2_linearSlop);\r\n\t\t\tvar hcY = Math.max(0.0, hY - 2.0 * b2Settings.b2_linearSlop);\r\n\r\n\t\t\t//this.m_vertices[0] = b2Mul(localR, b2Vec2(h.x, h.y));\r\n\t\t\ttVec = this.m_vertices[0] = new b2Vec2();\r\n\t\t\ttVec.x = localR.col1.x * hX + localR.col2.x * hY;\r\n\t\t\ttVec.y = localR.col1.y * hX + localR.col2.y * hY;\r\n\t\t\t//this.m_vertices[1] = b2Mul(localR, b2Vec2(-h.x, h.y));\r\n\t\t\ttVec = this.m_vertices[1] = new b2Vec2();\r\n\t\t\ttVec.x = localR.col1.x * -hX + localR.col2.x * hY;\r\n\t\t\ttVec.y = localR.col1.y * -hX + localR.col2.y * hY;\r\n\t\t\t//this.m_vertices[2] = b2Mul(localR, b2Vec2(-h.x, -h.y));\r\n\t\t\ttVec = this.m_vertices[2] = new b2Vec2();\r\n\t\t\ttVec.x = localR.col1.x * -hX + localR.col2.x * -hY;\r\n\t\t\ttVec.y = localR.col1.y * -hX + localR.col2.y * -hY;\r\n\t\t\t//this.m_vertices[3] = b2Mul(localR, b2Vec2(h.x, -h.y));\r\n\t\t\ttVec = this.m_vertices[3] = new b2Vec2();\r\n\t\t\ttVec.x = localR.col1.x * hX + localR.col2.x * -hY;\r\n\t\t\ttVec.y = localR.col1.y * hX + localR.col2.y * -hY;\r\n\r\n\t\t\t//this.m_coreVertices[0] = b2Mul(localR, b2Vec2(hc.x, hc.y));\r\n\t\t\ttVec = this.m_coreVertices[0] = new b2Vec2();\r\n\t\t\ttVec.x = localR.col1.x * hcX + localR.col2.x * hcY;\r\n\t\t\ttVec.y = localR.col1.y * hcX + localR.col2.y * hcY;\r\n\t\t\t//this.m_coreVertices[1] = b2Mul(localR, b2Vec2(-hc.x, hc.y));\r\n\t\t\ttVec = this.m_coreVertices[1] = new b2Vec2();\r\n\t\t\ttVec.x = localR.col1.x * -hcX + localR.col2.x * hcY;\r\n\t\t\ttVec.y = localR.col1.y * -hcX + localR.col2.y * hcY;\r\n\t\t\t//this.m_coreVertices[2] = b2Mul(localR, b2Vec2(-hc.x, -hc.y));\r\n\t\t\ttVec = this.m_coreVertices[2] = new b2Vec2();\r\n\t\t\ttVec.x = localR.col1.x * -hcX + localR.col2.x * -hcY;\r\n\t\t\ttVec.y = localR.col1.y * -hcX + localR.col2.y * -hcY;\r\n\t\t\t//this.m_coreVertices[3] = b2Mul(localR, b2Vec2(hc.x, -hc.y));\r\n\t\t\ttVec = this.m_coreVertices[3] = new b2Vec2();\r\n\t\t\ttVec.x = localR.col1.x * hcX + localR.col2.x * -hcY;\r\n\t\t\ttVec.y = localR.col1.y * hcX + localR.col2.y * -hcY;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tvar poly = def;\r\n\r\n\t\t\tthis.m_vertexCount = poly.vertexCount;\r\n\t\t\t//b2Settings.b2Assert(3 <= this.m_vertexCount && this.m_vertexCount <= b2Settings.b2_maxPolyVertices);\r\n\t\t\t//b2Vec2 centroid = b2Shape.PolyCentroid(poly->vertices, poly->vertexCount);\r\n\t\t\tb2Shape.PolyCentroid(poly.vertices, poly.vertexCount, b2PolyShape.tempVec);\r\n\t\t\tvar centroidX = b2PolyShape.tempVec.x;\r\n\t\t\tvar centroidY = b2PolyShape.tempVec.y;\r\n\t\t\t//this.m_localCentroid = def->localPosition + b2Mul(localR, centroid) - newOrigin;\r\n\t\t\tthis.m_localCentroid.x = def.localPosition.x + (localR.col1.x * centroidX + localR.col2.x * centroidY) - newOrigin.x;\r\n\t\t\tthis.m_localCentroid.y = def.localPosition.y + (localR.col1.y * centroidX + localR.col2.y * centroidY) - newOrigin.y;\r\n\r\n\t\t\tfor (i = 0; i < this.m_vertexCount; ++i)\r\n\t\t\t{\r\n\t\t\t\tthis.m_vertices[i] = new b2Vec2();\r\n\t\t\t\tthis.m_coreVertices[i] = new b2Vec2();\r\n\r\n\t\t\t\t//this.m_vertices[i] = b2Mul(localR, poly->vertices[i] - centroid);\r\n\t\t\t\thX = poly.vertices[i].x - centroidX;\r\n\t\t\t\thY = poly.vertices[i].y - centroidY;\r\n\t\t\t\tthis.m_vertices[i].x = localR.col1.x * hX + localR.col2.x * hY;\r\n\t\t\t\tthis.m_vertices[i].y = localR.col1.y * hX + localR.col2.y * hY;\r\n\r\n\t\t\t\t//b2Vec2 u = this.m_vertices[i];\r\n\t\t\t\tvar uX = this.m_vertices[i].x;\r\n\t\t\t\tvar uY = this.m_vertices[i].y;\r\n\t\t\t\t//float32 length = u.Length();\r\n\t\t\t\tvar length = Math.sqrt(uX*uX + uY*uY);\r\n\t\t\t\tif (length > Number.MIN_VALUE)\r\n\t\t\t\t{\r\n\t\t\t\t\tuX *= 1.0 / length;\r\n\t\t\t\t\tuY *= 1.0 / length;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t//this.m_coreVertices[i] = this.m_vertices[i] - 2.0f * b2_linearSlop * u;\r\n\t\t\t\tthis.m_coreVertices[i].x = this.m_vertices[i].x - 2.0 * b2Settings.b2_linearSlop * uX;\r\n\t\t\t\tthis.m_coreVertices[i].y = this.m_vertices[i].y - 2.0 * b2Settings.b2_linearSlop * uY;\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t// Compute bounding box. TODO_ERIN optimize OBB\r\n\t\t//var minVertex = new b2Vec2(Number.MAX_VALUE, Number.MAX_VALUE);\r\n\t\tvar minVertexX = Number.MAX_VALUE;\r\n\t\tvar minVertexY = Number.MAX_VALUE;\r\n\t\tvar maxVertexX = -Number.MAX_VALUE;\r\n\t\tvar maxVertexY = -Number.MAX_VALUE;\r\n\t\tthis.m_maxRadius = 0.0;\r\n\t\tfor (i = 0; i < this.m_vertexCount; ++i)\r\n\t\t{\r\n\t\t\tvar v = this.m_vertices[i];\r\n\t\t\t//minVertex = b2Math.b2MinV(minVertex, this.m_vertices[i]);\r\n\t\t\tminVertexX = Math.min(minVertexX, v.x);\r\n\t\t\tminVertexY = Math.min(minVertexY, v.y);\r\n\t\t\t//maxVertex = b2Math.b2MaxV(maxVertex, this.m_vertices[i]);\r\n\t\t\tmaxVertexX = Math.max(maxVertexX, v.x);\r\n\t\t\tmaxVertexY = Math.max(maxVertexY, v.y);\r\n\t\t\t//this.m_maxRadius = b2Max(this.m_maxRadius, v.Length());\r\n\t\t\tthis.m_maxRadius = Math.max(this.m_maxRadius, v.Length());\r\n\t\t}\r\n\r\n\t\tthis.m_localOBB.R.SetIdentity();\r\n\t\t//this.m_localOBB.center = 0.5 * (minVertex + maxVertex);\r\n\t\tthis.m_localOBB.center.Set((minVertexX + maxVertexX) * 0.5, (minVertexY + maxVertexY) * 0.5);\r\n\t\t//this.m_localOBB.extents = 0.5 * (maxVertex - minVertex);\r\n\t\tthis.m_localOBB.extents.Set((maxVertexX - minVertexX) * 0.5, (maxVertexY - minVertexY) * 0.5);\r\n\r\n\t\t// Compute the edge normals and next index map.\r\n\t\tvar i1 = 0;\r\n\t\tvar i2 = 0;\r\n\t\tfor (i = 0; i < this.m_vertexCount; ++i)\r\n\t\t{\r\n\t\t\tthis.m_normals[i] =  new b2Vec2();\r\n\t\t\ti1 = i;\r\n\t\t\ti2 = i + 1 < this.m_vertexCount ? i + 1 : 0;\r\n\t\t\t//b2Vec2 edge = this.m_vertices[i2] - this.m_vertices[i1];\r\n\t\t\t//var edgeX = this.m_vertices[i2].x - this.m_vertices[i1].x;\r\n\t\t\t//var edgeY = this.m_vertices[i2].y - this.m_vertices[i1].y;\r\n\t\t\t//this.m_normals[i] = b2Cross(edge, 1.0f);\r\n\t\t\tthis.m_normals[i].x = this.m_vertices[i2].y - this.m_vertices[i1].y;\r\n\t\t\tthis.m_normals[i].y = -(this.m_vertices[i2].x - this.m_vertices[i1].x);\r\n\t\t\tthis.m_normals[i].Normalize();\r\n\t\t}\r\n\r\n\t\t// Ensure the polygon in convex. TODO_ERIN compute convex hull.\r\n\t\tfor (i = 0; i < this.m_vertexCount; ++i)\r\n\t\t{\r\n\t\t\ti1 = i;\r\n\t\t\ti2 = i + 1 < this.m_vertexCount ? i + 1 : 0;\r\n\r\n\t\t\t//b2Settings.b2Assert(b2Math.b2CrossVV(this.m_normals[i1], this.m_normals[i2]) > Number.MIN_VALUE);\r\n\t\t}\r\n\r\n\t\tthis.m_R.SetM(this.m_body.m_R);\r\n\t\t//this.m_position.SetV( this.m_body.m_position  + b2Mul(this.m_body->this.m_R, this.m_localCentroid) );\r\n\t\tthis.m_position.x = this.m_body.m_position.x + (this.m_R.col1.x * this.m_localCentroid.x + this.m_R.col2.x * this.m_localCentroid.y);\r\n\t\tthis.m_position.y = this.m_body.m_position.y + (this.m_R.col1.y * this.m_localCentroid.x + this.m_R.col2.y * this.m_localCentroid.y);\r\n\r\n\t\t//var R = b2Math.b2MulMM(this.m_R, this.m_localOBB.R);\r\n\t\t\t//R.col1 = b2MulMV(this.m_R, this.m_localOBB.R.col1);\r\n\t\t\tb2PolyShape.tAbsR.col1.x = this.m_R.col1.x * this.m_localOBB.R.col1.x + this.m_R.col2.x * this.m_localOBB.R.col1.y;\r\n\t\t\tb2PolyShape.tAbsR.col1.y = this.m_R.col1.y * this.m_localOBB.R.col1.x + this.m_R.col2.y * this.m_localOBB.R.col1.y;\r\n\t\t\t//R.col2 = b2MulMV(this.m_R, this.m_localOBB.R.col2)\r\n\t\t\tb2PolyShape.tAbsR.col2.x = this.m_R.col1.x * this.m_localOBB.R.col2.x + this.m_R.col2.x * this.m_localOBB.R.col2.y;\r\n\t\t\tb2PolyShape.tAbsR.col2.y = this.m_R.col1.y * this.m_localOBB.R.col2.x + this.m_R.col2.y * this.m_localOBB.R.col2.y;\r\n\t\t//var absR = b2Math.b2AbsM(R);\r\n\t\tb2PolyShape.tAbsR.Abs()\r\n\r\n\t\t//h = b2Math.b2MulMV(b2PolyShape.tAbsR, this.m_localOBB.extents);\r\n\t\thX = b2PolyShape.tAbsR.col1.x * this.m_localOBB.extents.x + b2PolyShape.tAbsR.col2.x * this.m_localOBB.extents.y;\r\n\t\thY = b2PolyShape.tAbsR.col1.y * this.m_localOBB.extents.x + b2PolyShape.tAbsR.col2.y * this.m_localOBB.extents.y;\r\n\r\n\t\t//var position = this.m_position + b2Mul(this.m_R, this.m_localOBB.center);\r\n\t\tvar positionX = this.m_position.x + (this.m_R.col1.x * this.m_localOBB.center.x + this.m_R.col2.x * this.m_localOBB.center.y);\r\n\t\tvar positionY = this.m_position.y + (this.m_R.col1.y * this.m_localOBB.center.x + this.m_R.col2.y * this.m_localOBB.center.y);\r\n\r\n\t\t//aabb.minVertex = b2Math.SubtractVV(this.m_position, h);\r\n\t\taabb.minVertex.x = positionX - hX;\r\n\t\taabb.minVertex.y = positionY - hY;\r\n\t\t//aabb.maxVertex = b2Math.AddVV(this.m_position, h);\r\n\t\taabb.maxVertex.x = positionX + hX;\r\n\t\taabb.maxVertex.y = positionY + hY;\r\n\r\n\t\tvar broadPhase = this.m_body.m_world.m_broadPhase;\r\n\t\tif (broadPhase.InRange(aabb))\r\n\t\t{\r\n\t\t\tthis.m_proxyId = broadPhase.CreateProxy(aabb, this);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tthis.m_proxyId = b2Pair.b2_nullProxy;\r\n\t\t}\r\n\r\n\t\tif (this.m_proxyId == b2Pair.b2_nullProxy)\r\n\t\t{\r\n\t\t\tthis.m_body.Freeze();\r\n\t\t}\r\n\t};\r\n\r\n\t// Temp AABB for Synch function\r\n\t//syncAABB: new b2AABB(),\r\n\t//syncMat: new b2Mat22(),\r\n\tthis.Synchronize = function(position1, R1, position2, R2){\r\n\t\t// The body transform is copied for convenience.\r\n\t\tthis.m_R.SetM(R2);\r\n\t\t//this.m_position = this.m_body->this.m_position + b2Mul(this.m_body->this.m_R, this.m_localCentroid)\r\n\t\tthis.m_position.x = this.m_body.m_position.x + (R2.col1.x * this.m_localCentroid.x + R2.col2.x * this.m_localCentroid.y);\r\n\t\tthis.m_position.y = this.m_body.m_position.y + (R2.col1.y * this.m_localCentroid.x + R2.col2.y * this.m_localCentroid.y);\r\n\r\n\t\tif (this.m_proxyId == b2Pair.b2_nullProxy)\r\n\t\t{\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t//b2AABB aabb1, aabb2;\r\n\t\tvar hX;\r\n\t\tvar hY;\r\n\r\n\t\t//b2Mat22 obbR = b2Mul(R1, this.m_localOBB.R);\r\n\t\t\tvar v1 = R1.col1;\r\n\t\t\tvar v2 = R1.col2;\r\n\t\t\tvar v3 = this.m_localOBB.R.col1;\r\n\t\t\tvar v4 = this.m_localOBB.R.col2;\r\n\t\t\t//this.syncMat.col1 = b2MulMV(R1, this.m_localOBB.R.col1);\r\n\t\t\tthis.syncMat.col1.x = v1.x * v3.x + v2.x * v3.y;\r\n\t\t\tthis.syncMat.col1.y = v1.y * v3.x + v2.y * v3.y;\r\n\t\t\t//this.syncMat.col2 = b2MulMV(R1, this.m_localOBB.R.col2);\r\n\t\t\tthis.syncMat.col2.x = v1.x * v4.x + v2.x * v4.y;\r\n\t\t\tthis.syncMat.col2.y = v1.y * v4.x + v2.y * v4.y;\r\n\t\t//b2Mat22 absR = b2Abs(obbR);\r\n\t\tthis.syncMat.Abs();\r\n\t\t//b2Vec2 center = position1 + b2Mul(R1, this.m_localCentroid + this.m_localOBB.center);\r\n\t\thX = this.m_localCentroid.x + this.m_localOBB.center.x;\r\n\t\thY = this.m_localCentroid.y + this.m_localOBB.center.y;\r\n\t\tvar centerX = position1.x + (R1.col1.x * hX + R1.col2.x * hY);\r\n\t\tvar centerY = position1.y + (R1.col1.y * hX + R1.col2.y * hY);\r\n\t\t//b2Vec2 h = b2Mul(this.syncMat, this.m_localOBB.extents);\r\n\t\thX = this.syncMat.col1.x * this.m_localOBB.extents.x + this.syncMat.col2.x * this.m_localOBB.extents.y;\r\n\t\thY = this.syncMat.col1.y * this.m_localOBB.extents.x + this.syncMat.col2.y * this.m_localOBB.extents.y;\r\n\t\t//aabb1.minVertex = center - h;\r\n\t\tthis.syncAABB.minVertex.x = centerX - hX;\r\n\t\tthis.syncAABB.minVertex.y = centerY - hY;\r\n\t\t//aabb1.maxVertex = center + h;\r\n\t\tthis.syncAABB.maxVertex.x = centerX + hX;\r\n\t\tthis.syncAABB.maxVertex.y = centerY + hY;\r\n\r\n\t\t//b2Mat22 obbR = b2Mul(R2, this.m_localOBB.R);\r\n\t\t\tv1 = R2.col1;\r\n\t\t\tv2 = R2.col2;\r\n\t\t\tv3 = this.m_localOBB.R.col1;\r\n\t\t\tv4 = this.m_localOBB.R.col2;\r\n\t\t\t//this.syncMat.col1 = b2MulMV(R1, this.m_localOBB.R.col1);\r\n\t\t\tthis.syncMat.col1.x = v1.x * v3.x + v2.x * v3.y;\r\n\t\t\tthis.syncMat.col1.y = v1.y * v3.x + v2.y * v3.y;\r\n\t\t\t//this.syncMat.col2 = b2MulMV(R1, this.m_localOBB.R.col2);\r\n\t\t\tthis.syncMat.col2.x = v1.x * v4.x + v2.x * v4.y;\r\n\t\t\tthis.syncMat.col2.y = v1.y * v4.x + v2.y * v4.y;\r\n\t\t//b2Mat22 absR = b2Abs(obbR);\r\n\t\tthis.syncMat.Abs();\r\n\t\t//b2Vec2 center = position2 + b2Mul(R2, this.m_localCentroid + this.m_localOBB.center);\r\n\t\thX = this.m_localCentroid.x + this.m_localOBB.center.x;\r\n\t\thY = this.m_localCentroid.y + this.m_localOBB.center.y;\r\n\t\tcenterX = position2.x + (R2.col1.x * hX + R2.col2.x * hY);\r\n\t\tcenterY = position2.y + (R2.col1.y * hX + R2.col2.y * hY);\r\n\t\t//b2Vec2 h = b2Mul(absR, this.m_localOBB.extents);\r\n\t\thX = this.syncMat.col1.x * this.m_localOBB.extents.x + this.syncMat.col2.x * this.m_localOBB.extents.y;\r\n\t\thY = this.syncMat.col1.y * this.m_localOBB.extents.x + this.syncMat.col2.y * this.m_localOBB.extents.y;\r\n\t\t//aabb2.minVertex = center - h;\r\n\t\t//aabb2.maxVertex = center + h;\r\n\r\n\t\t//aabb.minVertex = b2Min(aabb1.minVertex, aabb2.minVertex);\r\n\t\tthis.syncAABB.minVertex.x = Math.min(this.syncAABB.minVertex.x, centerX - hX);\r\n\t\tthis.syncAABB.minVertex.y = Math.min(this.syncAABB.minVertex.y, centerY - hY);\r\n\t\t//aabb.maxVertex = b2Max(aabb1.maxVertex, aabb2.maxVertex);\r\n\t\tthis.syncAABB.maxVertex.x = Math.max(this.syncAABB.maxVertex.x, centerX + hX);\r\n\t\tthis.syncAABB.maxVertex.y = Math.max(this.syncAABB.maxVertex.y, centerY + hY);\r\n\r\n\t\tvar broadPhase = this.m_body.m_world.m_broadPhase;\r\n\t\tif (broadPhase.InRange(this.syncAABB))\r\n\t\t{\r\n\t\t\tbroadPhase.MoveProxy(this.m_proxyId, this.syncAABB);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tthis.m_body.Freeze();\r\n\t\t}\r\n\t};\r\n\r\n\tthis.QuickSync = function(position, R){\r\n\t\t//this.m_R = R;\r\n\t\tthis.m_R.SetM(R);\r\n\t\t//this.m_position = position + b2Mul(R, this.m_localCentroid);\r\n\t\tthis.m_position.x = position.x + (R.col1.x * this.m_localCentroid.x + R.col2.x * this.m_localCentroid.y);\r\n\t\tthis.m_position.y = position.y + (R.col1.y * this.m_localCentroid.x + R.col2.y * this.m_localCentroid.y);\r\n\t};\r\n\r\n\tthis.ResetProxy = function(broadPhase){\r\n\r\n\t\tif (this.m_proxyId == b2Pair.b2_nullProxy)\r\n\t\t{\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tvar proxy = broadPhase.GetProxy(this.m_proxyId);\r\n\r\n\t\tbroadPhase.DestroyProxy(this.m_proxyId);\r\n\t\tproxy = null;\r\n\r\n\t\tvar R = b2Math.b2MulMM(this.m_R, this.m_localOBB.R);\r\n\t\tvar absR = b2Math.b2AbsM(R);\r\n\t\tvar h = b2Math.b2MulMV(absR, this.m_localOBB.extents);\r\n\t\t//var position = this.m_position + b2Mul(this.m_R, this.m_localOBB.center);\r\n\t\tvar position = b2Math.b2MulMV(this.m_R, this.m_localOBB.center);\r\n\t\tposition.sAdd(this.m_position);\r\n\r\n\t\tvar aabb = new b2AABB();\r\n\t\t//aabb.minVertex = position - h;\r\n\t\taabb.minVertex.SetV(position);\r\n\t\taabb.minVertex.Subtract(h);\r\n\t\t//aabb.maxVertex = position + h;\r\n\t\taabb.maxVertex.SetV(position);\r\n\t\taabb.maxVertex.sAdd(h);\r\n\r\n\t\tif (broadPhase.InRange(aabb))\r\n\t\t{\r\n\t\t\tthis.m_proxyId = broadPhase.CreateProxy(aabb, this);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tthis.m_proxyId = b2Pair.b2_nullProxy;\r\n\t\t}\r\n\r\n\t\tif (this.m_proxyId == b2Pair.b2_nullProxy)\r\n\t\t{\r\n\t\t\tthis.m_body.Freeze();\r\n\t\t}\r\n\t};\r\n\r\n\r\n\tthis.Support = function(dX, dY, out){\r\n\t\t//b2Vec2 dLocal = b2MulT(this.m_R, d);\r\n\t\tvar dLocalX = (dX*this.m_R.col1.x + dY*this.m_R.col1.y);\r\n\t\tvar dLocalY = (dX*this.m_R.col2.x + dY*this.m_R.col2.y);\r\n\r\n\t\tvar bestIndex = 0;\r\n\t\t//float32 bestValue = b2Dot(this.m_vertices[0], dLocal);\r\n\t\tvar bestValue = (this.m_coreVertices[0].x * dLocalX + this.m_coreVertices[0].y * dLocalY);\r\n\t\tfor (var i = 1; i < this.m_vertexCount; ++i)\r\n\t\t{\r\n\t\t\t//float32 value = b2Dot(this.m_vertices[i], dLocal);\r\n\t\t\tvar value = (this.m_coreVertices[i].x * dLocalX + this.m_coreVertices[i].y * dLocalY);\r\n\t\t\tif (value > bestValue)\r\n\t\t\t{\r\n\t\t\t\tbestIndex = i;\r\n\t\t\t\tbestValue = value;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t//return this.m_position + b2Mul(this.m_R, this.m_vertices[bestIndex]);\r\n\t\tout.Set(\tthis.m_position.x + (this.m_R.col1.x * this.m_coreVertices[bestIndex].x + this.m_R.col2.x * this.m_coreVertices[bestIndex].y),\r\n\t\t\t\t\tthis.m_position.y + (this.m_R.col1.y * this.m_coreVertices[bestIndex].x + this.m_R.col2.y * this.m_coreVertices[bestIndex].y));\r\n\r\n\t};\r\n});\r\n\r\n\r\n\t// Local position of the shape centroid in parent body frame.\r\n//\tm_localCentroid: new b2Vec2(),\r\n//\r\n//\t// Local position oriented bounding box. The OBB center is relative to\r\n//\t// shape centroid.\r\n//\tm_localOBB: new b2OBB(),\r\n//\tm_vertices: null,\r\n//\tm_coreVertices: null,\r\n//\tm_vertexCount: 0,\r\n//\tm_normals: null});\r\n\r\nexports.tempVec = new b2Vec2();\r\nexports.tAbsR = new b2Mat22();\r\n","pre":true},"./src/box2d/collision/b2OBB.js":{"path":"./src/box2d/collision/b2OBB.js","friendlyPath":"..b2OBB","directory":"./src/box2d/collision/","filename":"b2OBB.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\njsio(\"import ..common.math.b2Mat22 as b2Mat22\");\r\njsio(\"import ..common.math.b2Vec2 as b2Vec2\");\r\n\r\n// A manifold for two touching convex shapes.\r\nvar src_box2d_collision_b2OBB=__class__;var b2OBB = exports=src_box2d_collision_b2OBB(function src_box2d_collision_b2OBB(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\r\n\tthis.init = function() {\r\n\t\t// initialize instance variables for references\r\n\t\tthis.R = new b2Mat22();\r\n\t\tthis.center = new b2Vec2();\r\n\t\tthis.extents = new b2Vec2();\r\n\t};\r\n});\r\n","pre":true},"./src/box2d/dynamics/b2BodyDef.js":{"path":"./src/box2d/dynamics/b2BodyDef.js","friendlyPath":".b2BodyDef","directory":"./src/box2d/dynamics/","filename":"b2BodyDef.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\njsio(\"import ..common.b2Settings as b2Settings\");\r\njsio(\"import ..common.math.b2Vec2 as b2Vec2\");\r\n\r\n\r\nvar src_box2d_dynamics_b2BodyDef=__class__;var b2BodyDef = exports=src_box2d_dynamics_b2BodyDef(function src_box2d_dynamics_b2BodyDef(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\tthis.init = function()\r\n\t{\r\n\t\t// initialize instance variables for references\r\n\t\tthis.shapes = new Array();\r\n\t\t//\r\n\r\n\t\tthis.userData = null;\r\n\t\tfor (var i = 0; i < b2Settings.b2_maxShapesPerBody; i++){\r\n\t\t\tthis.shapes[i] = null;\r\n\t\t}\r\n\t\tthis.position = new b2Vec2(0.0, 0.0);\r\n\t\tthis.rotation = 0.0;\r\n\t\tthis.linearVelocity = new b2Vec2(0.0, 0.0);\r\n\t\tthis.angularVelocity = 0.0;\r\n\t\tthis.linearDamping = 0.0;\r\n\t\tthis.angularDamping = 0.0;\r\n\t\tthis.allowSleep = true;\r\n\t\tthis.isSleeping = false;\r\n\t\tthis.preventRotation = false;\r\n\t};\r\n\r\n\tthis.AddShape = function(shape)\r\n\t{\r\n\t\tfor (var i = 0; i < b2Settings.b2_maxShapesPerBody; ++i)\r\n\t\t{\r\n\t\t\tif (this.shapes[i] == null)\r\n\t\t\t{\r\n\t\t\t\tthis.shapes[i] = shape;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n});\r\n","pre":true},"./src/box2d/dynamics/b2Island.js":{"path":"./src/box2d/dynamics/b2Island.js","friendlyPath":".b2Island","directory":"./src/box2d/dynamics/","filename":"b2Island.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\n\r\n\r\n\r\n/*\r\nPosition Correction Notes\r\n=========================\r\nI tried the several algorithms for position correction of the 2D revolute joint.\r\nI looked at these systems:\r\n- simple pendulum (1m diameter sphere on massless 5m stick) with initial angular velocity of 100 rad/s.\r\n- suspension bridge with 30 1m long planks of length 1m.\r\n- multi-link chain with 30 1m long links.\r\n\r\nHere are the algorithms:\r\n\r\nBaumgarte - A fraction of the position error is added to the velocity error. There is no\r\nseparate position solver.\r\n\r\nPseudo Velocities - After the velocity solver and position integration,\r\nthe position error, Jacobian, and effective mass are recomputed. Then\r\nthe velocity constraints are solved with pseudo velocities and a fraction\r\nof the position error is added to the pseudo velocity error. The pseudo\r\nvelocities are initialized to zero and there is no warm-starting. After\r\nthe position solver, the pseudo velocities are added to the positions.\r\nThis is also called the First Order World method or the Position LCP method.\r\n\r\nModified Nonlinear Gauss-Seidel (NGS) - Like Pseudo Velocities except the\r\nposition error is re-computed for each constraint and the positions are updated\r\nafter the constraint is solved. The radius vectors (aka Jacobians) are\r\nre-computed too (otherwise the algorithm has horrible instability). The pseudo\r\nvelocity states are not needed because they are effectively zero at the beginning\r\nof each iteration. Since we have the current position error, we allow the\r\niterations to terminate early if the error becomes smaller than b2_linearSlop.\r\n\r\nFull NGS or just NGS - Like Modified NGS except the effective mass are re-computed\r\neach time a constraint is solved.\r\n\r\nHere are the results:\r\nBaumgarte - this is the cheapest algorithm but it has some stability problems,\r\nespecially with the bridge. The chain links separate easily close to the root\r\nand they jitter struggle to pull together. This is one of the most common\r\nmethods in the field. The big drawback is that the position correction artificially\r\naffects the momentum, thus leading to instabilities and false bounce. I used a\r\nbias factor of 0.2. A larger bias factor makes the bridge less stable, a smaller\r\nfactor makes joints and contacts more spongy.\r\n\r\nPseudo Velocities - the is more stable than the Baumgarte method. The bridge is\r\nstable. However, joints still separate with large angular velocities. Drag the\r\nsimple pendulum in a circle quickly and the joint will separate. The chain separates\r\neasily and does not recover. I used a bias factor of 0.2. A larger value lead to\r\nthe bridge collapsing when a heavy cube drops on it.\r\n\r\nModified NGS - this algorithm is better in some ways than Baumgarte and Pseudo\r\nVelocities, but in other ways it is worse. The bridge and chain are much more\r\nstable, but the simple pendulum goes unstable at high angular velocities.\r\n\r\nFull NGS - stable in all tests. The joints display good stiffness. The bridge\r\nstill sags, but this is better than infinite forces.\r\n\r\nRecommendations\r\nPseudo Velocities are not really worthwhile because the bridge and chain cannot\r\nrecover from joint separation. In other cases the benefit over Baumgarte is small.\r\n\r\nModified NGS is not a robust method for the revolute joint due to the violent\r\ninstability seen in the simple pendulum. Perhaps it is viable with other constraint\r\ntypes, especially scalar constraints where the effective mass is a scalar.\r\n\r\nThis leaves Baumgarte and Full NGS. Baumgarte has small, but manageable instabilities\r\nand is very fast. I don't think we can escape Baumgarte, especially in highly\r\ndemanding cases where high constraint fidelity is not needed.\r\n\r\nFull NGS is robust and easy on the eyes. I recommend this option for\r\nhigher fidelity simulation and certainly for suspension bridges and long chains.\r\nFull NGS might be a good choice for ragdolls, especially motorized ragdolls where\r\njoint separation can be problematic. The number of NGS iterations can be reduced\r\nfor better performance without harming robustness much.\r\n\r\nEach joint in a can be handled differently in the position solver. So I recommend\r\na system where the user can select the algorithm on a per joint basis. I would\r\nprobably default to the slower Full NGS and let the user select the faster\r\nBaumgarte method in performance critical scenarios.\r\n*/\r\n\r\njsio(\"import ..common.b2Settings as b2Settings\");\r\njsio(\"import ..common.math.b2Math as b2Math\");\r\njsio(\"import ..common.math.b2Math2 as b2Math2\");\r\njsio(\"import .contacts.b2ContactSolver as b2ContactSolver\");\r\njsio(\"import .b2World as b2World\");\r\njsio(\"import .b2Body as b2Body\");\r\n\r\nb2Island=__class__;var b2Island=b2Island(function b2Island(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\r\n\tthis.init = function(bodyCapacity, contactCapacity, jointCapacity, allocator)\r\n\t{\r\n\t\tvar i = 0;\r\n\r\n\t\tthis.m_bodyCapacity = bodyCapacity;\r\n\t\tthis.m_contactCapacity = contactCapacity;\r\n\t\tthis.m_jointCapacity\t = jointCapacity;\r\n\t\tthis.m_bodyCount = 0;\r\n\t\tthis.m_contactCount = 0;\r\n\t\tthis.m_jointCount = 0;\r\n\r\n\r\n\t\t//this.m_bodies = (b2Body**)allocator->Allocate(bodyCapacity * sizeof(b2Body*));\r\n\t\tthis.m_bodies = new Array(bodyCapacity);\r\n\t\tfor (i = 0; i < bodyCapacity; i++)\r\n\t\t\tthis.m_bodies[i] = null;\r\n\r\n\t\t//this.m_contacts = (b2Contact**)allocator->Allocate(contactCapacity\t * sizeof(b2Contact*));\r\n\t\tthis.m_contacts = new Array(contactCapacity);\r\n\t\tfor (i = 0; i < contactCapacity; i++)\r\n\t\t\tthis.m_contacts[i] = null;\r\n\r\n\t\t//this.m_joints = (b2Joint**)allocator->Allocate(jointCapacity * sizeof(b2Joint*));\r\n\t\tthis.m_joints = new Array(jointCapacity);\r\n\t\tfor (i = 0; i < jointCapacity; i++)\r\n\t\t\tthis.m_joints[i] = null;\r\n\r\n\t\tthis.m_allocator = allocator;\r\n\t};\r\n\t//~b2Island();\r\n\r\n\tthis.Clear = function()\r\n\t{\r\n\t\tthis.m_bodyCount = 0;\r\n\t\tthis.m_contactCount = 0;\r\n\t\tthis.m_jointCount = 0;\r\n\t};\r\n\r\n\tthis.Solve = function(step, gravity)\r\n\t{\r\n\t\tvar i = 0;\r\n\t\tvar b;\r\n\r\n\t\tfor (i = 0; i < this.m_bodyCount; ++i)\r\n\t\t{\r\n\t\t\tb = this.m_bodies[i];\r\n\r\n\t\t\tif (b.m_invMass == 0.0)\r\n\t\t\t\tcontinue;\r\n\r\n\t\t\tb.m_linearVelocity.sAdd( b2Math.MulFV (step.dt, b2Math.AddVV(gravity, b2Math.MulFV( b.m_invMass, b.m_force ) ) ) );\r\n\t\t\tb.m_angularVelocity += step.dt * b.m_invI * b.m_torque;\r\n\r\n\t\t\t//b.m_linearVelocity *= b.m_linearDamping;\r\n\t\t\tb.m_linearVelocity.Multiply(b.m_linearDamping);\r\n\t\t\tb.m_angularVelocity *= b.m_angularDamping;\r\n\r\n\t\t\t// Store positions for conservative advancement.\r\n\t\t\tb.m_position0.SetV(b.m_position);\r\n\t\t\tb.m_rotation0 = b.m_rotation;\r\n\t\t}\r\n\r\n\t\tvar contactSolver = new b2ContactSolver(this.m_contacts, this.m_contactCount, this.m_allocator);\r\n\r\n\t\t// Pre-solve\r\n\t\tcontactSolver.PreSolve();\r\n\r\n\t\tfor (i = 0; i < this.m_jointCount; ++i)\r\n\t\t{\r\n\t\t\tthis.m_joints[i].PrepareVelocitySolver();\r\n\t\t}\r\n\r\n\t\t// this.Solve velocity constraints.\r\n\t\tfor (i = 0; i < step.iterations; ++i)\r\n\t\t{\r\n\t\t\tcontactSolver.SolveVelocityConstraints();\r\n\r\n\t\t\tfor (var j = 0; j < this.m_jointCount; ++j)\r\n\t\t\t{\r\n\t\t\t\tthis.m_joints[j].SolveVelocityConstraints(step);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Integrate positions.\r\n\t\tfor (i = 0; i < this.m_bodyCount; ++i)\r\n\t\t{\r\n\t\t\tb = this.m_bodies[i];\r\n\r\n\t\t\tif (b.m_invMass == 0.0)\r\n\t\t\t\tcontinue;\r\n\r\n\t\t\t//b.m_position.Add( b2Math.MulFV (step.dt, b.m_linearVelocity) );\r\n\t\t\tb.m_position.x += step.dt * b.m_linearVelocity.x;\r\n\t\t\tb.m_position.y += step.dt * b.m_linearVelocity.y;\r\n\t\t\tb.m_rotation += step.dt * b.m_angularVelocity;\r\n\r\n\t\t\tb.m_R.Set(b.m_rotation);\r\n\t\t}\r\n\r\n\t\tfor (i = 0; i < this.m_jointCount; ++i)\r\n\t\t{\r\n\t\t\tthis.m_joints[i].PreparePositionSolver();\r\n\t\t}\r\n\r\n\t\t// this.Solve position constraints.\r\n\t\tif (b2World.s_enablePositionCorrection)\r\n\t\t{\r\n\t\t\tfor (b2Island.m_positionIterationCount = 0; b2Island.m_positionIterationCount < step.iterations; ++b2Island.m_positionIterationCount)\r\n\t\t\t{\r\n\t\t\t\tvar contactsOkay = contactSolver.SolvePositionConstraints(b2Settings.b2_contactBaumgarte);\r\n\r\n\t\t\t\tvar jointsOkay = true;\r\n\t\t\t\tfor (i = 0; i < this.m_jointCount; ++i)\r\n\t\t\t\t{\r\n\t\t\t\t\tvar jointOkay = this.m_joints[i].SolvePositionConstraints();\r\n\t\t\t\t\tjointsOkay = jointsOkay && jointOkay;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (contactsOkay && jointsOkay)\r\n\t\t\t\t{\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Post-solve.\r\n\t\tcontactSolver.PostSolve();\r\n\r\n\t\t// Synchronize shapes and reset forces.\r\n\t\tfor (i = 0; i < this.m_bodyCount; ++i)\r\n\t\t{\r\n\t\t\tb = this.m_bodies[i];\r\n\r\n\t\t\tif (b.m_invMass == 0.0)\r\n\t\t\t\tcontinue;\r\n\r\n\t\t\tb.m_R.Set(b.m_rotation);\r\n\r\n\t\t\tb.SynchronizeShapes();\r\n\t\t\tb.m_force.Set(0.0, 0.0);\r\n\t\t\tb.m_torque = 0.0;\r\n\t\t}\r\n\t};\r\n\r\n\tthis.UpdateSleep = function(dt)\r\n\t{\r\n\t\tvar i = 0;\r\n\t\tvar b;\r\n\r\n\t\tvar minSleepTime = Number.MAX_VALUE;\r\n\r\n\t\tvar linTolSqr = b2Settings.b2_linearSleepTolerance * b2Settings.b2_linearSleepTolerance;\r\n\t\tvar angTolSqr = b2Settings.b2_angularSleepTolerance * b2Settings.b2_angularSleepTolerance;\r\n\r\n\t\tfor (i = 0; i < this.m_bodyCount; ++i)\r\n\t\t{\r\n\t\t\tb = this.m_bodies[i];\r\n\t\t\tif (b.m_invMass == 0.0)\r\n\t\t\t{\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tif ((b.m_flags & b2Body.e_allowSleepFlag) == 0)\r\n\t\t\t{\r\n\t\t\t\tb.m_sleepTime = 0.0;\r\n\t\t\t\tminSleepTime = 0.0;\r\n\t\t\t}\r\n\r\n\t\t\tif ((b.m_flags & b2Body.e_allowSleepFlag) == 0 ||\r\n\t\t\t\tb.m_angularVelocity * b.m_angularVelocity > angTolSqr ||\r\n\t\t\t\tb2Math2.b2Dot(b.m_linearVelocity, b.m_linearVelocity) > linTolSqr)\r\n\t\t\t{\r\n\t\t\t\tb.m_sleepTime = 0.0;\r\n\t\t\t\tminSleepTime = 0.0;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tb.m_sleepTime += dt;\r\n\t\t\t\tminSleepTime = b2Math.b2Min(minSleepTime, b.m_sleepTime);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (minSleepTime >= b2Settings.b2_timeToSleep)\r\n\t\t{\r\n\t\t\tfor (i = 0; i < this.m_bodyCount; ++i)\r\n\t\t\t{\r\n\t\t\t\tb = this.m_bodies[i];\r\n\t\t\t\tb.m_flags |= b2Body.e_sleepFlag;\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\tthis.AddBody = function(body)\r\n\t{\r\n\t\t//b2Settings.b2Assert(this.m_bodyCount < this.m_bodyCapacity);\r\n\t\tthis.m_bodies[this.m_bodyCount++] = body;\r\n\t};\r\n\r\n\tthis.AddContact = function(contact)\r\n\t{\r\n\t\t//b2Settings.b2Assert(this.m_contactCount < this.m_contactCapacity);\r\n\t\tthis.m_contacts[this.m_contactCount++] = contact;\r\n\t};\r\n\r\n\tthis.AddJoint = function(joint)\r\n\t{\r\n\t\t//b2Settings.b2Assert(this.m_jointCount < this.m_jointCapacity);\r\n\t\tthis.m_joints[this.m_jointCount++] = joint;\r\n\t};\r\n\r\n});\r\nb2Island.m_positionIterationCount = 0;\r\nexports = b2Island;\r\n\r\n","pre":true},"./src/box2d/dynamics/contacts/b2ContactSolver.js":{"path":"./src/box2d/dynamics/contacts/b2ContactSolver.js","friendlyPath":".contacts.b2ContactSolver","directory":"./src/box2d/dynamics/contacts/","filename":"b2ContactSolver.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\njsio(\"import ...common.b2Settings as b2Settings\");\r\njsio(\"import ...common.math.b2Math as b2Math\");\r\njsio(\"import ...dynamics.b2World as b2World\");\r\njsio(\"import .b2ContactConstraint as b2ContactConstraint\");\r\n\r\n\r\nvar src_box2d_dynamics_contacts_b2ContactSolver=__class__;var b2ContactSolver = exports=src_box2d_dynamics_contacts_b2ContactSolver(function src_box2d_dynamics_contacts_b2ContactSolver(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\tthis.init = function(contacts, contactCount, allocator){\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_constraints = new Array();\r\n\t\t//\r\n\r\n\t\tthis.m_allocator = allocator;\r\n\r\n\t\tvar i = 0;\r\n\t\tvar tVec;\r\n\t\tvar tMat;\r\n\r\n\t\tthis.m_constraintCount = 0;\r\n\t\tfor (i = 0; i < contactCount; ++i)\r\n\t\t{\r\n\t\t\tthis.m_constraintCount += contacts[i].GetManifoldCount();\r\n\t\t}\r\n\r\n\t\t// fill array\r\n\t\tfor (i = 0; i < this.m_constraintCount; i++){\r\n\t\t\tthis.m_constraints[i] = new b2ContactConstraint();\r\n\t\t}\r\n\r\n\t\tvar count = 0;\r\n\t\tfor (i = 0; i < contactCount; ++i)\r\n\t\t{\r\n\t\t\tvar contact = contacts[i];\r\n\t\t\tvar b1 = contact.m_shape1.m_body;\r\n\t\t\tvar b2 = contact.m_shape2.m_body;\r\n\t\t\tvar manifoldCount = contact.GetManifoldCount();\r\n\t\t\tvar manifolds = contact.GetManifolds();\r\n\t\t\tvar friction = contact.m_friction;\r\n\t\t\tvar restitution = contact.m_restitution;\r\n\r\n\t\t\t//var v1 = b1.m_linearVelocity.Copy();\r\n\t\t\tvar v1X = b1.m_linearVelocity.x;\r\n\t\t\tvar v1Y = b1.m_linearVelocity.y;\r\n\t\t\t//var v2 = b2.m_linearVelocity.Copy();\r\n\t\t\tvar v2X = b2.m_linearVelocity.x;\r\n\t\t\tvar v2Y = b2.m_linearVelocity.y;\r\n\t\t\tvar w1 = b1.m_angularVelocity;\r\n\t\t\tvar w2 = b2.m_angularVelocity;\r\n\r\n\t\t\tfor (var j = 0; j < manifoldCount; ++j)\r\n\t\t\t{\r\n\t\t\t\tvar manifold = manifolds[ j ];\r\n\r\n\t\t\t\t//b2Settings.b2Assert(manifold.pointCount > 0);\r\n\r\n\t\t\t\t//var normal = manifold.normal.Copy();\r\n\t\t\t\tvar normalX = manifold.normal.x;\r\n\t\t\t\tvar normalY = manifold.normal.y;\r\n\r\n\t\t\t\t//b2Settings.b2Assert(count < this.m_constraintCount);\r\n\t\t\t\tvar c = this.m_constraints[ count ];\r\n\t\t\t\tc.body1 = b1;\r\n\t\t\t\tc.body2 = b2;\r\n\t\t\t\tc.manifold = manifold;\r\n\t\t\t\t//c.normal = normal;\r\n\t\t\t\tc.normal.x = normalX;\r\n\t\t\t\tc.normal.y = normalY;\r\n\t\t\t\tc.pointCount = manifold.pointCount;\r\n\t\t\t\tc.friction = friction;\r\n\t\t\t\tc.restitution = restitution;\r\n\r\n\t\t\t\tfor (var k = 0; k < c.pointCount; ++k)\r\n\t\t\t\t{\r\n\t\t\t\t\tvar cp = manifold.points[ k ];\r\n\t\t\t\t\tvar ccp = c.points[ k ];\r\n\r\n\t\t\t\t\tccp.normalImpulse = cp.normalImpulse;\r\n\t\t\t\t\tccp.tangentImpulse = cp.tangentImpulse;\r\n\t\t\t\t\tccp.separation = cp.separation;\r\n\r\n\t\t\t\t\t//var r1 = b2Math.SubtractVV( cp.position, b1.m_position );\r\n\t\t\t\t\tvar r1X = cp.position.x - b1.m_position.x;\r\n\t\t\t\t\tvar r1Y = cp.position.y - b1.m_position.y;\r\n\t\t\t\t\t//var r2 = b2Math.SubtractVV( cp.position, b2.m_position );\r\n\t\t\t\t\tvar r2X = cp.position.x - b2.m_position.x;\r\n\t\t\t\t\tvar r2Y = cp.position.y - b2.m_position.y;\r\n\r\n\t\t\t\t\t//ccp.localAnchor1 = b2Math.b2MulTMV(b1.m_R, r1);\r\n\t\t\t\t\ttVec = ccp.localAnchor1;\r\n\t\t\t\t\ttMat = b1.m_R;\r\n\t\t\t\t\ttVec.x = r1X * tMat.col1.x + r1Y * tMat.col1.y;\r\n\t\t\t\t\ttVec.y = r1X * tMat.col2.x + r1Y * tMat.col2.y;\r\n\r\n\t\t\t\t\t//ccp.localAnchor2 = b2Math.b2MulTMV(b2.m_R, r2);\r\n\t\t\t\t\ttVec = ccp.localAnchor2;\r\n\t\t\t\t\ttMat = b2.m_R;\r\n\t\t\t\t\ttVec.x = r2X * tMat.col1.x + r2Y * tMat.col1.y;\r\n\t\t\t\t\ttVec.y = r2X * tMat.col2.x + r2Y * tMat.col2.y;\r\n\r\n\t\t\t\t\tvar r1Sqr = r1X * r1X + r1Y * r1Y;\r\n\t\t\t\t\tvar r2Sqr = r2X * r2X + r2Y * r2Y;\r\n\r\n\t\t\t\t\t//var rn1 = b2Math.b2Dot(r1, normal);\r\n\t\t\t\t\tvar rn1 = r1X*normalX + r1Y*normalY;\r\n\t\t\t\t\t//var rn2 = b2Math.b2Dot(r2, normal);\r\n\t\t\t\t\tvar rn2 = r2X*normalX + r2Y*normalY;\r\n\t\t\t\t\tvar kNormal = b1.m_invMass + b2.m_invMass;\r\n\t\t\t\t\tkNormal += b1.m_invI * (r1Sqr - rn1 * rn1) + b2.m_invI * (r2Sqr - rn2 * rn2);\r\n\t\t\t\t\t//b2Settings.b2Assert(kNormal > Number.MIN_VALUE);\r\n\t\t\t\t\tccp.normalMass = 1.0 / kNormal;\r\n\r\n\t\t\t\t\t//var tangent = b2Math.b2CrossVF(normal, 1.0);\r\n\t\t\t\t\tvar tangentX = normalY\r\n\t\t\t\t\tvar tangentY = -normalX;\r\n\r\n\t\t\t\t\t//var rt1 = b2Math.b2Dot(r1, tangent);\r\n\t\t\t\t\tvar rt1 = r1X*tangentX + r1Y*tangentY;\r\n\t\t\t\t\t//var rt2 = b2Math.b2Dot(r2, tangent);\r\n\t\t\t\t\tvar rt2 = r2X*tangentX + r2Y*tangentY;\r\n\t\t\t\t\tvar kTangent = b1.m_invMass + b2.m_invMass;\r\n\t\t\t\t\tkTangent += b1.m_invI * (r1Sqr - rt1 * rt1) + b2.m_invI * (r2Sqr - rt2 * rt2);\r\n\t\t\t\t\t//b2Settings.b2Assert(kTangent > Number.MIN_VALUE);\r\n\t\t\t\t\tccp.tangentMass = 1.0 /  kTangent;\r\n\r\n\t\t\t\t\t// Setup a velocity bias for restitution.\r\n\t\t\t\t\tccp.velocityBias = 0.0;\r\n\t\t\t\t\tif (ccp.separation > 0.0)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tccp.velocityBias = -60.0 * ccp.separation;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t//var vRel = b2Math.b2Dot(c.normal, b2Math.SubtractVV( b2Math.SubtractVV( b2Math.AddVV( v2, b2Math.b2CrossFV(w2, r2)), v1 ), b2Math.b2CrossFV(w1, r1)));\r\n\t\t\t\t\tvar tX = v2X + (-w2*r2Y) - v1X - (-w1*r1Y);\r\n\t\t\t\t\tvar tY = v2Y + (w2*r2X) - v1Y - (w1*r1X);\r\n\t\t\t\t\t//var vRel = b2Dot(c.normal, tX/Y);\r\n\t\t\t\t\tvar vRel = c.normal.x*tX + c.normal.y*tY;\r\n\t\t\t\t\tif (vRel < -b2Settings.b2_velocityThreshold)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tccp.velocityBias += -c.restitution * vRel;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t++count;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t//b2Settings.b2Assert(count == this.m_constraintCount);\r\n\t};\r\n\t//~b2ContactSolver();\r\n\r\n\tthis.PreSolve = function(){\r\n\t\tvar tVec;\r\n\t\tvar tVec2;\r\n\t\tvar tMat;\r\n\r\n\t\t// Warm start.\r\n\t\tfor (var i = 0; i < this.m_constraintCount; ++i)\r\n\t\t{\r\n\t\t\tvar c = this.m_constraints[ i ];\r\n\r\n\t\t\tvar b1 = c.body1;\r\n\t\t\tvar b2 = c.body2;\r\n\t\t\tvar invMass1 = b1.m_invMass;\r\n\t\t\tvar invI1 = b1.m_invI;\r\n\t\t\tvar invMass2 = b2.m_invMass;\r\n\t\t\tvar invI2 = b2.m_invI;\r\n\t\t\t//var normal = new b2Vec2(c.normal.x, c.normal.y);\r\n\t\t\tvar normalX = c.normal.x;\r\n\t\t\tvar normalY = c.normal.y;\r\n\t\t\t//var tangent = b2Math.b2CrossVF(normal, 1.0);\r\n\t\t\tvar tangentX = normalY;\r\n\t\t\tvar tangentY = -normalX;\r\n\r\n\t\t\tvar j = 0;\r\n\t\t\tvar tCount = 0;\r\n\t\t\tif (b2World.s_enableWarmStarting)\r\n\t\t\t{\r\n\t\t\t\ttCount = c.pointCount;\r\n\t\t\t\tfor (j = 0; j < tCount; ++j)\r\n\t\t\t\t{\r\n\t\t\t\t\tvar ccp = c.points[ j ];\r\n\t\t\t\t\t//var P = b2Math.AddVV( b2Math.MulFV(ccp.normalImpulse, normal), b2Math.MulFV(ccp.tangentImpulse, tangent));\r\n\t\t\t\t\tvar PX = ccp.normalImpulse*normalX + ccp.tangentImpulse*tangentX;\r\n\t\t\t\t\tvar PY = ccp.normalImpulse*normalY + ccp.tangentImpulse*tangentY;\r\n\r\n\t\t\t\t\t//var r1 = b2Math.b2MulMV(b1.m_R, ccp.localAnchor1);\r\n\t\t\t\t\ttMat = b1.m_R;\r\n\t\t\t\t\ttVec = ccp.localAnchor1;\r\n\t\t\t\t\tvar r1X = tMat.col1.x * tVec.x + tMat.col2.x * tVec.y;\r\n\t\t\t\t\tvar r1Y = tMat.col1.y * tVec.x + tMat.col2.y * tVec.y;\r\n\r\n\t\t\t\t\t//var r2 = b2Math.b2MulMV(b2.m_R, ccp.localAnchor2);\r\n\t\t\t\t\ttMat = b2.m_R;\r\n\t\t\t\t\ttVec = ccp.localAnchor2;\r\n\t\t\t\t\tvar r2X = tMat.col1.x * tVec.x + tMat.col2.x * tVec.y;\r\n\t\t\t\t\tvar r2Y = tMat.col1.y * tVec.x + tMat.col2.y * tVec.y;\r\n\r\n\t\t\t\t\t//b1.m_angularVelocity -= invI1 * b2Math.b2CrossVV(r1, P);\r\n\t\t\t\t\tb1.m_angularVelocity -= invI1 * (r1X * PY - r1Y * PX);\r\n\t\t\t\t\t//b1.m_linearVelocity.Subtract( b2Math.MulFV(invMass1, P) );\r\n\t\t\t\t\tb1.m_linearVelocity.x -= invMass1 * PX;\r\n\t\t\t\t\tb1.m_linearVelocity.y -= invMass1 * PY;\r\n\t\t\t\t\t//b2.m_angularVelocity += invI2 * b2Math.b2CrossVV(r2, P);\r\n\t\t\t\t\tb2.m_angularVelocity += invI2 * (r2X * PY - r2Y * PX);\r\n\t\t\t\t\t//b2.m_linearVelocity.Add( b2Math.MulFV(invMass2, P) );\r\n\t\t\t\t\tb2.m_linearVelocity.x += invMass2 * PX;\r\n\t\t\t\t\tb2.m_linearVelocity.y += invMass2 * PY;\r\n\r\n\t\t\t\t\tccp.positionImpulse = 0.0;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse{\r\n\t\t\t\ttCount = c.pointCount;\r\n\t\t\t\tfor (j = 0; j < tCount; ++j)\r\n\t\t\t\t{\r\n\t\t\t\t\tvar ccp2 = c.points[ j ];\r\n\t\t\t\t\tccp2.normalImpulse = 0.0;\r\n\t\t\t\t\tccp2.tangentImpulse = 0.0;\r\n\r\n\t\t\t\t\tccp2.positionImpulse = 0.0;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\tthis.SolveVelocityConstraints = function(){\r\n\t\tvar j = 0;\r\n\t\tvar ccp;\r\n\t\tvar r1X;\r\n\t\tvar r1Y;\r\n\t\tvar r2X;\r\n\t\tvar r2Y;\r\n\t\tvar dvX;\r\n\t\tvar dvY;\r\n\t\tvar lambda;\r\n\t\tvar newImpulse;\r\n\t\tvar PX;\r\n\t\tvar PY;\r\n\r\n\t\tvar tMat;\r\n\t\tvar tVec;\r\n\r\n\t\tfor (var i = 0; i < this.m_constraintCount; ++i)\r\n\t\t{\r\n\t\t\tvar c = this.m_constraints[ i ];\r\n\t\t\tvar b1 = c.body1;\r\n\t\t\tvar b2 = c.body2;\r\n\t\t\tvar b1_angularVelocity = b1.m_angularVelocity;\r\n\t\t\tvar b1_linearVelocity = b1.m_linearVelocity;\r\n\t\t\tvar b2_angularVelocity = b2.m_angularVelocity;\r\n\t\t\tvar b2_linearVelocity = b2.m_linearVelocity;\r\n\r\n\t\t\tvar invMass1 = b1.m_invMass;\r\n\t\t\tvar invI1 = b1.m_invI;\r\n\t\t\tvar invMass2 = b2.m_invMass;\r\n\t\t\tvar invI2 = b2.m_invI;\r\n\t\t\t//var normal = new b2Vec2(c.normal.x, c.normal.y);\r\n\t\t\tvar normalX = c.normal.x;\r\n\t\t\tvar normalY = c.normal.y;\r\n\t\t\t//var tangent = b2Math.b2CrossVF(normal, 1.0);\r\n\t\t\tvar tangentX = normalY;\r\n\t\t\tvar tangentY = -normalX;\r\n\r\n\t\t\t// Solver normal constraints\r\n\t\t\tvar tCount = c.pointCount;\r\n\t\t\tfor (j = 0; j < tCount; ++j)\r\n\t\t\t{\r\n\t\t\t\tccp = c.points[ j ];\r\n\r\n\t\t\t\t//r1 = b2Math.b2MulMV(b1.m_R, ccp.localAnchor1);\r\n\t\t\t\ttMat = b1.m_R;\r\n\t\t\t\ttVec = ccp.localAnchor1;\r\n\t\t\t\tr1X = tMat.col1.x * tVec.x + tMat.col2.x * tVec.y\r\n\t\t\t\tr1Y = tMat.col1.y * tVec.x + tMat.col2.y * tVec.y\r\n\t\t\t\t//r2 = b2Math.b2MulMV(b2.m_R, ccp.localAnchor2);\r\n\t\t\t\ttMat = b2.m_R;\r\n\t\t\t\ttVec = ccp.localAnchor2;\r\n\t\t\t\tr2X = tMat.col1.x * tVec.x + tMat.col2.x * tVec.y\r\n\t\t\t\tr2Y = tMat.col1.y * tVec.x + tMat.col2.y * tVec.y\r\n\r\n\t\t\t\t// Relative velocity at contact\r\n\t\t\t\t//var dv = b2Math.SubtractVV( b2Math.AddVV( b2.m_linearVelocity, b2Math.b2CrossFV(b2.m_angularVelocity, r2)), b2Math.SubtractVV(b1.m_linearVelocity, b2Math.b2CrossFV(b1.m_angularVelocity, r1)));\r\n\t\t\t\t//dv = b2Math.SubtractVV(b2Math.SubtractVV( b2Math.AddVV( b2.m_linearVelocity, b2Math.b2CrossFV(b2.m_angularVelocity, r2)), b1.m_linearVelocity), b2Math.b2CrossFV(b1.m_angularVelocity, r1));\r\n\t\t\t\tdvX = b2_linearVelocity.x + (-b2_angularVelocity * r2Y) - b1_linearVelocity.x - (-b1_angularVelocity * r1Y);\r\n\t\t\t\tdvY = b2_linearVelocity.y + (b2_angularVelocity * r2X) - b1_linearVelocity.y - (b1_angularVelocity * r1X);\r\n\r\n\t\t\t\t// Compute normal impulse\r\n\t\t\t\t//var vn = b2Math.b2Dot(dv, normal);\r\n\t\t\t\tvar vn = dvX * normalX + dvY * normalY;\r\n\t\t\t\tlambda = -ccp.normalMass * (vn - ccp.velocityBias);\r\n\r\n\t\t\t\t// b2Clamp the accumulated impulse\r\n\t\t\t\tnewImpulse = b2Math.b2Max(ccp.normalImpulse + lambda, 0.0);\r\n\t\t\t\tlambda = newImpulse - ccp.normalImpulse;\r\n\r\n\t\t\t\t// Apply contact impulse\r\n\t\t\t\t//P = b2Math.MulFV(lambda, normal);\r\n\t\t\t\tPX = lambda * normalX;\r\n\t\t\t\tPY = lambda * normalY;\r\n\r\n\t\t\t\t//b1.m_linearVelocity.Subtract( b2Math.MulFV( invMass1, P ) );\r\n\t\t\t\tb1_linearVelocity.x -= invMass1 * PX;\r\n\t\t\t\tb1_linearVelocity.y -= invMass1 * PY;\r\n\t\t\t\tb1_angularVelocity -= invI1 * (r1X * PY - r1Y * PX);\r\n\r\n\t\t\t\t//b2.m_linearVelocity.Add( b2Math.MulFV( invMass2, P ) );\r\n\t\t\t\tb2_linearVelocity.x += invMass2 * PX;\r\n\t\t\t\tb2_linearVelocity.y += invMass2 * PY;\r\n\t\t\t\tb2_angularVelocity += invI2 * (r2X * PY - r2Y * PX);\r\n\r\n\t\t\t\tccp.normalImpulse = newImpulse;\r\n\r\n\r\n\r\n\t\t\t\t// MOVED FROM BELOW\r\n\t\t\t\t// Relative velocity at contact\r\n\t\t\t\t//var dv = b2.m_linearVelocity + b2Cross(b2.m_angularVelocity, r2) - b1.m_linearVelocity - b2Cross(b1.m_angularVelocity, r1);\r\n\t\t\t\t//dv =  b2Math.SubtractVV(b2Math.SubtractVV(b2Math.AddVV(b2.m_linearVelocity, b2Math.b2CrossFV(b2.m_angularVelocity, r2)), b1.m_linearVelocity), b2Math.b2CrossFV(b1.m_angularVelocity, r1));\r\n\t\t\t\tdvX = b2_linearVelocity.x + (-b2_angularVelocity * r2Y) - b1_linearVelocity.x - (-b1_angularVelocity * r1Y);\r\n\t\t\t\tdvY = b2_linearVelocity.y + (b2_angularVelocity * r2X) - b1_linearVelocity.y - (b1_angularVelocity * r1X);\r\n\r\n\t\t\t\t// Compute tangent impulse\r\n\t\t\t\tvar vt = dvX*tangentX + dvY*tangentY;\r\n\t\t\t\tlambda = ccp.tangentMass * (-vt);\r\n\r\n\t\t\t\t// b2Clamp the accumulated impulse\r\n\t\t\t\tvar maxFriction = c.friction * ccp.normalImpulse;\r\n\t\t\t\tnewImpulse = b2Math.b2Clamp(ccp.tangentImpulse + lambda, -maxFriction, maxFriction);\r\n\t\t\t\tlambda = newImpulse - ccp.tangentImpulse;\r\n\r\n\t\t\t\t// Apply contact impulse\r\n\t\t\t\t//P = b2Math.MulFV(lambda, tangent);\r\n\t\t\t\tPX = lambda * tangentX;\r\n\t\t\t\tPY = lambda * tangentY;\r\n\r\n\t\t\t\t//b1.m_linearVelocity.Subtract( b2Math.MulFV( invMass1, P ) );\r\n\t\t\t\tb1_linearVelocity.x -= invMass1 * PX;\r\n\t\t\t\tb1_linearVelocity.y -= invMass1 * PY;\r\n\t\t\t\tb1_angularVelocity -= invI1 * (r1X * PY - r1Y * PX);\r\n\r\n\t\t\t\t//b2.m_linearVelocity.Add( b2Math.MulFV( invMass2, P ) );\r\n\t\t\t\tb2_linearVelocity.x += invMass2 * PX;\r\n\t\t\t\tb2_linearVelocity.y += invMass2 * PY;\r\n\t\t\t\tb2_angularVelocity += invI2 * (r2X * PY - r2Y * PX);\r\n\r\n\t\t\t\tccp.tangentImpulse = newImpulse;\r\n\t\t\t}\r\n\r\n\r\n\r\n\t\t\t// Solver tangent constraints\r\n\t\t\t// MOVED ABOVE FOR EFFICIENCY\r\n\t\t\t/*for (j = 0; j < tCount; ++j)\r\n\t\t\t{\r\n\t\t\t\tccp = c.points[ j ];\r\n\r\n\t\t\t\t//r1 = b2Math.b2MulMV(b1.m_R, ccp.localAnchor1);\r\n\t\t\t\ttMat = b1.m_R;\r\n\t\t\t\ttVec = ccp.localAnchor1;\r\n\t\t\t\tr1X = tMat.col1.x * tVec.x + tMat.col2.x * tVec.y\r\n\t\t\t\tr1Y = tMat.col1.y * tVec.x + tMat.col2.y * tVec.y\r\n\t\t\t\t//r2 = b2Math.b2MulMV(b2.m_R, ccp.localAnchor2);\r\n\t\t\t\ttMat = b2.m_R;\r\n\t\t\t\ttVec = ccp.localAnchor2;\r\n\t\t\t\tr2X = tMat.col1.x * tVec.x + tMat.col2.x * tVec.y\r\n\t\t\t\tr2Y = tMat.col1.y * tVec.x + tMat.col2.y * tVec.y\r\n\r\n\t\t\t\t// Relative velocity at contact\r\n\t\t\t\t//var dv = b2.m_linearVelocity + b2Cross(b2.m_angularVelocity, r2) - b1.m_linearVelocity - b2Cross(b1.m_angularVelocity, r1);\r\n\t\t\t\t//dv =  b2Math.SubtractVV(b2Math.SubtractVV(b2Math.AddVV(b2.m_linearVelocity, b2Math.b2CrossFV(b2.m_angularVelocity, r2)), b1.m_linearVelocity), b2Math.b2CrossFV(b1.m_angularVelocity, r1));\r\n\t\t\t\tdvX = b2_linearVelocity.x + (-b2_angularVelocity * r2Y) - b1_linearVelocity.x - (-b1_angularVelocity * r1Y);\r\n\t\t\t\tdvY = b2_linearVelocity.y + (b2_angularVelocity * r2X) - b1_linearVelocity.y - (b1_angularVelocity * r1X);\r\n\r\n\t\t\t\t// Compute tangent impulse\r\n\t\t\t\tvar vt = dvX*tangentX + dvY*tangentY;\r\n\t\t\t\tlambda = ccp.tangentMass * (-vt);\r\n\r\n\t\t\t\t// b2Clamp the accumulated impulse\r\n\t\t\t\tvar maxFriction = c.friction * ccp.normalImpulse;\r\n\t\t\t\tnewImpulse = b2Math.b2Clamp(ccp.tangentImpulse + lambda, -maxFriction, maxFriction);\r\n\t\t\t\tlambda = newImpulse - ccp.tangentImpulse;\r\n\r\n\t\t\t\t// Apply contact impulse\r\n\t\t\t\t//P = b2Math.MulFV(lambda, tangent);\r\n\t\t\t\tPX = lambda * tangentX;\r\n\t\t\t\tPY = lambda * tangentY;\r\n\r\n\t\t\t\t//b1.m_linearVelocity.Subtract( b2Math.MulFV( invMass1, P ) );\r\n\t\t\t\tb1_linearVelocity.x -= invMass1 * PX;\r\n\t\t\t\tb1_linearVelocity.y -= invMass1 * PY;\r\n\t\t\t\tb1_angularVelocity -= invI1 * (r1X * PY - r1Y * PX);\r\n\r\n\t\t\t\t//b2.m_linearVelocity.Add( b2Math.MulFV( invMass2, P ) );\r\n\t\t\t\tb2_linearVelocity.x += invMass2 * PX;\r\n\t\t\t\tb2_linearVelocity.y += invMass2 * PY;\r\n\t\t\t\tb2_angularVelocity += invI2 * (r2X * PY - r2Y * PX);\r\n\r\n\t\t\t\tccp.tangentImpulse = newImpulse;\r\n\t\t\t}*/\r\n\r\n\t\t\t// Update angular velocity\r\n\t\t\tb1.m_angularVelocity = b1_angularVelocity;\r\n\t\t\tb2.m_angularVelocity = b2_angularVelocity;\r\n\t\t}\r\n\t};\r\n\r\n\tthis.SolvePositionConstraints = function(beta){\r\n\t\tvar minSeparation = 0.0;\r\n\r\n\t\tvar tMat;\r\n\t\tvar tVec;\r\n\r\n\t\tfor (var i = 0; i < this.m_constraintCount; ++i)\r\n\t\t{\r\n\t\t\tvar c = this.m_constraints[ i ];\r\n\t\t\tvar b1 = c.body1;\r\n\t\t\tvar b2 = c.body2;\r\n\t\t\tvar b1_position = b1.m_position;\r\n\t\t\tvar b1_rotation = b1.m_rotation;\r\n\t\t\tvar b2_position = b2.m_position;\r\n\t\t\tvar b2_rotation = b2.m_rotation;\r\n\r\n\t\t\tvar invMass1 = b1.m_invMass;\r\n\t\t\tvar invI1 = b1.m_invI;\r\n\t\t\tvar invMass2 = b2.m_invMass;\r\n\t\t\tvar invI2 = b2.m_invI;\r\n\t\t\t//var normal = new b2Vec2(c.normal.x, c.normal.y);\r\n\t\t\tvar normalX = c.normal.x;\r\n\t\t\tvar normalY = c.normal.y;\r\n\t\t\t//var tangent = b2Math.b2CrossVF(normal, 1.0);\r\n\t\t\tvar tangentX = normalY;\r\n\t\t\tvar tangentY = -normalX;\r\n\r\n\t\t\t// Solver normal constraints\r\n\t\t\tvar tCount = c.pointCount;\r\n\t\t\tfor (var j = 0; j < tCount; ++j)\r\n\t\t\t{\r\n\t\t\t\tvar ccp = c.points[ j ];\r\n\r\n\t\t\t\t//r1 = b2Math.b2MulMV(b1.m_R, ccp.localAnchor1);\r\n\t\t\t\ttMat = b1.m_R;\r\n\t\t\t\ttVec = ccp.localAnchor1;\r\n\t\t\t\tvar r1X = tMat.col1.x * tVec.x + tMat.col2.x * tVec.y\r\n\t\t\t\tvar r1Y = tMat.col1.y * tVec.x + tMat.col2.y * tVec.y\r\n\t\t\t\t//r2 = b2Math.b2MulMV(b2.m_R, ccp.localAnchor2);\r\n\t\t\t\ttMat = b2.m_R;\r\n\t\t\t\ttVec = ccp.localAnchor2;\r\n\t\t\t\tvar r2X = tMat.col1.x * tVec.x + tMat.col2.x * tVec.y\r\n\t\t\t\tvar r2Y = tMat.col1.y * tVec.x + tMat.col2.y * tVec.y\r\n\r\n\t\t\t\t//var p1 = b2Math.AddVV(b1.m_position, r1);\r\n\t\t\t\tvar p1X = b1_position.x + r1X;\r\n\t\t\t\tvar p1Y = b1_position.y + r1Y;\r\n\r\n\t\t\t\t//var p2 = b2Math.AddVV(b2.m_position, r2);\r\n\t\t\t\tvar p2X = b2_position.x + r2X;\r\n\t\t\t\tvar p2Y = b2_position.y + r2Y;\r\n\r\n\t\t\t\t//var dp = b2Math.SubtractVV(p2, p1);\r\n\t\t\t\tvar dpX = p2X - p1X;\r\n\t\t\t\tvar dpY = p2Y - p1Y;\r\n\r\n\t\t\t\t// Approximate the current separation.\r\n\t\t\t\t//var separation = b2Math.b2Dot(dp, normal) + ccp.separation;\r\n\t\t\t\tvar separation = (dpX*normalX + dpY*normalY) + ccp.separation;\r\n\r\n\t\t\t\t// Track max constraint error.\r\n\t\t\t\tminSeparation = b2Math.b2Min(minSeparation, separation);\r\n\r\n\t\t\t\t// Prevent large corrections and allow slop.\r\n\t\t\t\tvar C = beta * b2Math.b2Clamp(separation + b2Settings.b2_linearSlop, -b2Settings.b2_maxLinearCorrection, 0.0);\r\n\r\n\t\t\t\t// Compute normal impulse\r\n\t\t\t\tvar dImpulse = -ccp.normalMass * C;\r\n\r\n\t\t\t\t// b2Clamp the accumulated impulse\r\n\t\t\t\tvar impulse0 = ccp.positionImpulse;\r\n\t\t\t\tccp.positionImpulse = b2Math.b2Max(impulse0 + dImpulse, 0.0);\r\n\t\t\t\tdImpulse = ccp.positionImpulse - impulse0;\r\n\r\n\t\t\t\t//var impulse = b2Math.MulFV( dImpulse, normal );\r\n\t\t\t\tvar impulseX = dImpulse * normalX;\r\n\t\t\t\tvar impulseY = dImpulse * normalY;\r\n\r\n\t\t\t\t//b1.m_position.Subtract( b2Math.MulFV( invMass1, impulse ) );\r\n\t\t\t\tb1_position.x -= invMass1 * impulseX;\r\n\t\t\t\tb1_position.y -= invMass1 * impulseY;\r\n\t\t\t\tb1_rotation -= invI1 * (r1X * impulseY - r1Y * impulseX);\r\n\t\t\t\tb1.m_R.Set(b1_rotation);\r\n\r\n\t\t\t\t//b2.m_position.Add( b2Math.MulFV( invMass2, impulse ) );\r\n\t\t\t\tb2_position.x += invMass2 * impulseX;\r\n\t\t\t\tb2_position.y += invMass2 * impulseY;\r\n\t\t\t\tb2_rotation += invI2 * (r2X * impulseY - r2Y * impulseX);\r\n\t\t\t\tb2.m_R.Set(b2_rotation);\r\n\t\t\t}\r\n\t\t\t// Update body rotations\r\n\t\t\tb1.m_rotation = b1_rotation;\r\n\t\t\tb2.m_rotation = b2_rotation;\r\n\t\t}\r\n\r\n\t\treturn minSeparation >= -b2Settings.b2_linearSlop;\r\n\t};\r\n\r\n\tthis.PostSolve = function(){\r\n\t\tfor (var i = 0; i < this.m_constraintCount; ++i)\r\n\t\t{\r\n\t\t\tvar c = this.m_constraints[ i ];\r\n\t\t\tvar m = c.manifold;\r\n\r\n\t\t\tfor (var j = 0; j < c.pointCount; ++j)\r\n\t\t\t{\r\n\t\t\t\tvar mPoint = m.points[j];\r\n\t\t\t\tvar cPoint = c.points[j];\r\n\t\t\t\tmPoint.normalImpulse = cPoint.normalImpulse;\r\n\t\t\t\tmPoint.tangentImpulse = cPoint.tangentImpulse;\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n});\r\n","pre":true},"./src/box2d/dynamics/contacts/b2ContactConstraint.js":{"path":"./src/box2d/dynamics/contacts/b2ContactConstraint.js","friendlyPath":".b2ContactConstraint","directory":"./src/box2d/dynamics/contacts/","filename":"b2ContactConstraint.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\njsio(\"import ...common.b2Settings as b2Settings\");\r\njsio(\"import ...common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import .b2ContactConstraintPoint as b2ContactConstraintPoint\");\r\n\r\n\r\nvar src_box2d_dynamics_contacts_b2ContactConstraint=__class__;var b2ContactConstraint = exports=src_box2d_dynamics_contacts_b2ContactConstraint(function src_box2d_dynamics_contacts_b2ContactConstraint(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\tthis.init = function(){\r\n\t\tthis.points = null;\r\n\t\tthis.normal = new b2Vec2();\r\n\t\tthis.manifold = null;\r\n\t\tthis.body1 = null;\r\n\t\tthis.body2 = null;\r\n\t\tthis.friction = null;\r\n\t\tthis.restitution = null;\r\n\t\tthis.pointCount = 0;\r\n\r\n\t\t// initialize instance variables for references\r\n\t\tthis.normal = new b2Vec2();\r\n\t\t//\r\n\r\n\t\tthis.points = new Array(b2Settings.b2_maxManifoldPoints);\r\n\t\tfor (var i = 0; i < b2Settings.b2_maxManifoldPoints; i++){\r\n\t\t\tthis.points[i] = new b2ContactConstraintPoint();\r\n\t\t}\r\n\r\n\r\n\t};\r\n});\r\n","pre":true},"./src/box2d/dynamics/contacts/b2ContactConstraintPoint.js":{"path":"./src/box2d/dynamics/contacts/b2ContactConstraintPoint.js","friendlyPath":".b2ContactConstraintPoint","directory":"./src/box2d/dynamics/contacts/","filename":"b2ContactConstraintPoint.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\n\r\njsio(\"import ...common.math.b2Vec2 as b2Vec2\");\r\n\r\nvar src_box2d_dynamics_contacts_b2ContactConstraintPoint=__class__;var b2ContactConstraintPoint = exports=src_box2d_dynamics_contacts_b2ContactConstraintPoint(function src_box2d_dynamics_contacts_b2ContactConstraintPoint(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\r\n\tthis.init = function() {\r\n\t\t// initialize instance variables for references\r\n\t\tthis.localAnchor1 = new b2Vec2();\r\n\t\tthis.localAnchor2 = new b2Vec2();\r\n\r\n\t\tthis.normalImpulse = null;\r\n\t\tthis.tangentImpulse = null;\r\n\t\tthis.positionImpulse = null;\r\n\t\tthis.normalMass = null;\r\n\t\tthis.tangentMass = null;\r\n\t\tthis.separation = null;\r\n\t\tthis.velocityBias = null;\r\n\t};\r\n});\r\n","pre":true},"./src/box2d/dynamics/joints/b2JointFactory.js":{"path":"./src/box2d/dynamics/joints/b2JointFactory.js","friendlyPath":".joints.b2JointFactory","directory":"./src/box2d/dynamics/joints/","filename":"b2JointFactory.js","src":"\njsio(\"import .b2Joint as b2Joint\");\njsio(\"import .b2DistanceJoint as b2DistanceJoint\");\njsio(\"import .b2GearJoint as b2GearJoint\");\njsio(\"import .b2MouseJoint as b2MouseJoint\");\njsio(\"import .b2PrismaticJoint as b2PrismaticJoint\");\njsio(\"import .b2PulleyJoint as b2PulleyJoint\");\njsio(\"import .b2RevoluteJoint as b2RevoluteJoint\");\n\nexports.Create = function(def, allocator){\n\t\tvar joint = null;\n\n\t\tswitch (def.type)\n\t\t{\n\t\tcase b2Joint.e_distanceJoint:\n\t\t\t{\n\t\t\t\t//void* mem = allocator->Allocate(sizeof(b2DistanceJoint));\n\t\t\t\tjoint = new b2DistanceJoint(def);\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase b2Joint.e_mouseJoint:\n\t\t\t{\n\t\t\t\t//void* mem = allocator->Allocate(sizeof(b2MouseJoint));\n\t\t\t\tjoint = new b2MouseJoint(def);\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase b2Joint.e_prismaticJoint:\n\t\t\t{\n\t\t\t\t//void* mem = allocator->Allocate(sizeof(b2PrismaticJoint));\n\t\t\t\tjoint = new b2PrismaticJoint(def);\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase b2Joint.e_revoluteJoint:\n\t\t\t{\n\t\t\t\t//void* mem = allocator->Allocate(sizeof(b2RevoluteJoint));\n\t\t\t\tjoint = new b2RevoluteJoint(def);\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase b2Joint.e_pulleyJoint:\n\t\t\t{\n\t\t\t\t//void* mem = allocator->Allocate(sizeof(b2PulleyJoint));\n\t\t\t\tjoint = new b2PulleyJoint(def);\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase b2Joint.e_gearJoint:\n\t\t\t{\n\t\t\t\t//void* mem = allocator->Allocate(sizeof(b2GearJoint));\n\t\t\t\tjoint = new b2GearJoint(def);\n\t\t\t}\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\t//b2Settings.b2Assert(false);\n\t\t\tbreak;\n\t\t}\n\n\t\treturn joint;\n\t};\n","pre":true},"./src/box2d/dynamics/joints/b2Joint.js":{"path":"./src/box2d/dynamics/joints/b2Joint.js","friendlyPath":".b2Joint","directory":"./src/box2d/dynamics/joints/","filename":"b2Joint.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\njsio(\"import .b2JointNode as b2JointNode\");\r\n\r\nb2Joint=__class__;var b2Joint=b2Joint(function b2Joint(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\tthis.GetType = function(){\r\n\t\treturn this.m_type;\r\n\t};\r\n\r\n\tthis.GetAnchor1 = function(){return null;};\r\n\tthis.GetAnchor2 = function(){return null;};\r\n\r\n\tthis.GetReactionForce = function(invTimeStep){return null;};\r\n\tthis.GetReactionTorque = function(invTimeStep){return 0.0;};\r\n\r\n\tthis.GetBody1 = function()\r\n\t{\r\n\t\treturn this.m_body1;\r\n\t};\r\n\r\n\tthis.GetBody2 = function()\r\n\t{\r\n\t\treturn this.m_body2;\r\n\t};\r\n\r\n\tthis.GetNext = function(){\r\n\t\treturn this.m_next;\r\n\t};\r\n\r\n\tthis.GetUserData = function(){\r\n\t\treturn this.m_userData;\r\n\t};\r\n\r\n\t//--------------- Internals Below -------------------\r\n\tthis.init = function(def) {\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_node1 = new b2JointNode();\r\n\t\tthis.m_node2 = new b2JointNode();\r\n\t\t//\r\n\r\n\t\tthis.m_type = def.type;\r\n\t\tthis.m_prev = null;\r\n\t\tthis.m_next = null;\r\n\t\tthis.m_body1 = def.body1;\r\n\t\tthis.m_body2 = def.body2;\r\n\t\tthis.m_collideConnected = def.collideConnected;\r\n\t\tthis.m_islandFlag = false;\r\n\t\tthis.m_userData = def.userData;\r\n\t};\r\n\t//virtual ~b2Joint() {}\r\n\r\n\tthis.PrepareVelocitySolver = function(){};\r\n\tthis.SolveVelocityConstraints = function(step){};\r\n\r\n\t// This returns true if the position errors are within tolerance.\r\n\tthis.PreparePositionSolver = function(){};\r\n\tthis.SolvePositionConstraints = function(){return false;};\r\n\r\n\t// ENUMS\r\n\r\n\t// enum b2JointType\r\n\r\n\t// enum b2LimitState\r\n\r\n});\r\n\r\n\r\nb2Joint.Destroy = function(joint, allocator){\r\n\t\t/*joint->~b2Joint();\r\n\t\tswitch (joint.m_type)\r\n\t\t{\r\n\t\tcase b2Joint.e_distanceJoint:\r\n\t\t\tallocator->Free(joint, sizeof(b2DistanceJoint));\r\n\t\t\tbreak;\r\n\r\n\t\tcase b2Joint.e_mouseJoint:\r\n\t\t\tallocator->Free(joint, sizeof(b2MouseJoint));\r\n\t\t\tbreak;\r\n\r\n\t\tcase b2Joint.e_prismaticJoint:\r\n\t\t\tallocator->Free(joint, sizeof(b2PrismaticJoint));\r\n\t\t\tbreak;\r\n\r\n\t\tcase b2Joint.e_revoluteJoint:\r\n\t\t\tallocator->Free(joint, sizeof(b2RevoluteJoint));\r\n\t\t\tbreak;\r\n\r\n\t\tcase b2Joint.e_pulleyJoint:\r\n\t\t\tallocator->Free(joint, sizeof(b2PulleyJoint));\r\n\t\t\tbreak;\r\n\r\n\t\tcase b2Joint.e_gearJoint:\r\n\t\t\tallocator->Free(joint, sizeof(b2GearJoint));\r\n\t\t\tbreak;\r\n\r\n\t\tdefault:\r\n\t\t\tb2Assert(false);\r\n\t\t\tbreak;\r\n\t\t}*/\r\n\t};\r\nb2Joint.e_unknownJoint = 0;\r\nb2Joint.e_revoluteJoint = 1;\r\nb2Joint.e_prismaticJoint = 2;\r\nb2Joint.e_distanceJoint = 3;\r\nb2Joint.e_pulleyJoint = 4;\r\nb2Joint.e_mouseJoint = 5;\r\nb2Joint.e_gearJoint = 6;\r\nb2Joint.e_inactiveLimit = 0;\r\nb2Joint.e_atLowerLimit = 1;\r\nb2Joint.e_atUpperLimit = 2;\r\nb2Joint.e_equalLimits = 3;\r\n\r\nexports = b2Joint;\r\n","pre":true},"./src/box2d/dynamics/joints/b2JointNode.js":{"path":"./src/box2d/dynamics/joints/b2JointNode.js","friendlyPath":".b2JointNode","directory":"./src/box2d/dynamics/joints/","filename":"b2JointNode.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\nvar src_box2d_dynamics_joints_b2JointNode=__class__;var b2JointNode = exports=src_box2d_dynamics_joints_b2JointNode(function src_box2d_dynamics_joints_b2JointNode(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\tthis.init = function() {\r\n\t\tthis.other = null;\r\n\t\tthis.joint = null;\r\n\t\tthis.prev = null;\r\n\t\tthis.next = null;\r\n\t};\r\n});\r\n","pre":true},"./src/box2d/dynamics/joints/b2DistanceJoint.js":{"path":"./src/box2d/dynamics/joints/b2DistanceJoint.js","friendlyPath":".b2DistanceJoint","directory":"./src/box2d/dynamics/joints/","filename":"b2DistanceJoint.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\n\r\n// C = norm(p2 - p1) - L\r\n// u = (p2 - p1) / norm(p2 - p1)\r\n// Cdot = dot(u, v2 + cross(w2, r2) - v1 - cross(w1, r1))\r\n// J = [-u -cross(r1, u) u cross(r2, u)]\r\n// K = J * invM * JT\r\n//   = invMass1 + invI1 * cross(r1, u)^2 + invMass2 + invI2 * cross(r2, u)^2\r\n\r\njsio(\"import ...common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import ...common.math.b2Math as b2Math\");\r\njsio(\"import .b2Joint as b2Joint\");\r\njsio(\"import .b2JointNode as b2JointNode\");\r\n\r\nvar src_box2d_dynamics_joints_b2DistanceJoint=__class__;var b2DistanceJoint = exports=src_box2d_dynamics_joints_b2DistanceJoint(function src_box2d_dynamics_joints_b2DistanceJoint(){return this.init&&this.init.apply(this,arguments)},b2Joint, function(supr) {\r\n\t//--------------- Internals Below -------------------\r\n\r\n\tthis.init = function(def){\r\n\t\tsupr(this, 'init', [def]);\r\n\r\n\t\tthis.lm_mass = null;\r\n\t\t// The constructor for b2Joint\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_node1 = new b2JointNode();\r\n\t\tthis.m_node2 = new b2JointNode();\r\n\t\t//\r\n\t\tthis.m_type = def.type;\r\n\t\tthis.m_prev = null;\r\n\t\tthis.m_next = null;\r\n\t\tthis.m_body1 = def.body1;\r\n\t\tthis.m_body2 = def.body2;\r\n\t\tthis.m_collideConnected = def.collideConnected;\r\n\t\tthis.m_islandFlag = false;\r\n\t\tthis.m_userData = def.userData;\r\n\t\t//\r\n\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_localAnchor1 = new b2Vec2();\r\n\t\tthis.m_localAnchor2 = new b2Vec2();\r\n\t\tthis.m_u = new b2Vec2();\r\n\t\t//\r\n\r\n\t\t//super(def);\r\n\r\n\t\tvar tMat;\r\n\t\tvar tX;\r\n\t\tvar tY;\r\n\t\t//this.m_localAnchor1 = b2MulT(this.m_body1->m_R, def->anchorPoint1 - this.m_body1->m_position);\r\n\t\ttMat = this.m_body1.m_R;\r\n\t\ttX = def.anchorPoint1.x - this.m_body1.m_position.x;\r\n\t\ttY = def.anchorPoint1.y - this.m_body1.m_position.y;\r\n\t\tthis.m_localAnchor1.x = tX*tMat.col1.x + tY*tMat.col1.y;\r\n\t\tthis.m_localAnchor1.y = tX*tMat.col2.x + tY*tMat.col2.y;\r\n\t\t//this.m_localAnchor2 = b2MulT(this.m_body2->m_R, def->anchorPoint2 - this.m_body2->m_position);\r\n\t\ttMat = this.m_body2.m_R;\r\n\t\ttX = def.anchorPoint2.x - this.m_body2.m_position.x;\r\n\t\ttY = def.anchorPoint2.y - this.m_body2.m_position.y;\r\n\t\tthis.m_localAnchor2.x = tX*tMat.col1.x + tY*tMat.col1.y;\r\n\t\tthis.m_localAnchor2.y = tX*tMat.col2.x + tY*tMat.col2.y;\r\n\r\n\t\t//b2Vec2 d = def->anchorPoint2 - def->anchorPoint1;\r\n\t\ttX = def.anchorPoint2.x - def.anchorPoint1.x;\r\n\t\ttY = def.anchorPoint2.y - def.anchorPoint1.y;\r\n\t\t//this.m_length = d.Length();\r\n\t\tthis.m_length = Math.sqrt(tX*tX + tY*tY);\r\n\t\tthis.m_impulse = 0.0;\r\n\t};\r\n\r\n\tthis.PrepareVelocitySolver = function(){\r\n\r\n\t\tvar tMat;\r\n\r\n\t\t// Compute the effective mass matrix.\r\n\t\t//b2Vec2 r1 = b2Mul(this.m_body1->m_R, this.m_localAnchor1);\r\n\t\ttMat = this.m_body1.m_R;\r\n\t\tvar r1X = tMat.col1.x * this.m_localAnchor1.x + tMat.col2.x * this.m_localAnchor1.y;\r\n\t\tvar r1Y = tMat.col1.y * this.m_localAnchor1.x + tMat.col2.y * this.m_localAnchor1.y;\r\n\t\t//b2Vec2 r2 = b2Mul(this.m_body2->m_R, this.m_localAnchor2);\r\n\t\ttMat = this.m_body2.m_R;\r\n\t\tvar r2X = tMat.col1.x * this.m_localAnchor2.x + tMat.col2.x * this.m_localAnchor2.y;\r\n\t\tvar r2Y = tMat.col1.y * this.m_localAnchor2.x + tMat.col2.y * this.m_localAnchor2.y;\r\n\t\t//this.m_u = this.m_body2->m_position + r2 - this.m_body1->m_position - r1;\r\n\t\tthis.m_u.x = this.m_body2.m_position.x + r2X - this.m_body1.m_position.x - r1X;\r\n\t\tthis.m_u.y = this.m_body2.m_position.y + r2Y - this.m_body1.m_position.y - r1Y;\r\n\r\n\t\t// Handle singularity.\r\n\t\t//float32 length = this.m_u.Length();\r\n\t\tvar length = Math.sqrt(this.m_u.x*this.m_u.x + this.m_u.y*this.m_u.y);\r\n\t\tif (length > b2Settings.b2_linearSlop)\r\n\t\t{\r\n\t\t\t//this.m_u *= 1.0 / length;\r\n\t\t\tthis.m_u.Multiply( 1.0 / length );\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tthis.m_u.SetZero();\r\n\t\t}\r\n\r\n\t\t//float32 cr1u = b2Cross(r1, this.m_u);\r\n\t\tvar cr1u = (r1X * this.m_u.y - r1Y * this.m_u.x);\r\n\t\t//float32 cr2u = b2Cross(r2, this.m_u);\r\n\t\tvar cr2u = (r2X * this.m_u.y - r2Y * this.m_u.x);\r\n\t\t//this.m_mass = this.m_body1->m_invMass + this.m_body1->m_invI * cr1u * cr1u + this.m_body2->m_invMass + this.m_body2->m_invI * cr2u * cr2u;\r\n\t\tthis.m_mass = this.m_body1.m_invMass + this.m_body1.m_invI * cr1u * cr1u + this.m_body2.m_invMass + this.m_body2.m_invI * cr2u * cr2u;\r\n\t\t//b2Settings.b2Assert(this.m_mass > Number.MIN_VALUE);\r\n\t\tthis.m_mass = 1.0 / this.m_mass;\r\n\r\n\t\tif (b2World.s_enableWarmStarting)\r\n\t\t{\r\n\t\t\t//b2Vec2 P = this.m_impulse * this.m_u;\r\n\t\t\tvar PX = this.m_impulse * this.m_u.x;\r\n\t\t\tvar PY = this.m_impulse * this.m_u.y;\r\n\t\t\t//this.m_body1.m_linearVelocity -= this.m_body1.m_invMass * P;\r\n\t\t\tthis.m_body1.m_linearVelocity.x -= this.m_body1.m_invMass * PX;\r\n\t\t\tthis.m_body1.m_linearVelocity.y -= this.m_body1.m_invMass * PY;\r\n\t\t\t//this.m_body1.m_angularVelocity -= this.m_body1.m_invI * b2Cross(r1, P);\r\n\t\t\tthis.m_body1.m_angularVelocity -= this.m_body1.m_invI * (r1X * PY - r1Y * PX);\r\n\t\t\t//this.m_body2.m_linearVelocity += this.m_body2.m_invMass * P;\r\n\t\t\tthis.m_body2.m_linearVelocity.x += this.m_body2.m_invMass * PX;\r\n\t\t\tthis.m_body2.m_linearVelocity.y += this.m_body2.m_invMass * PY;\r\n\t\t\t//this.m_body2.m_angularVelocity += this.m_body2.m_invI * b2Cross(r2, P);\r\n\t\t\tthis.m_body2.m_angularVelocity += this.m_body2.m_invI * (r2X * PY - r2Y * PX);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tthis.m_impulse = 0.0;\r\n\t\t}\r\n\r\n\t};\r\n\r\n\tthis.SolveVelocityConstraints = function(step){\r\n\r\n\t\tvar tMat;\r\n\r\n\t\t//b2Vec2 r1 = b2Mul(this.m_body1->m_R, this.m_localAnchor1);\r\n\t\ttMat = this.m_body1.m_R;\r\n\t\tvar r1X = tMat.col1.x * this.m_localAnchor1.x + tMat.col2.x * this.m_localAnchor1.y;\r\n\t\tvar r1Y = tMat.col1.y * this.m_localAnchor1.x + tMat.col2.y * this.m_localAnchor1.y;\r\n\t\t//b2Vec2 r2 = b2Mul(this.m_body2->m_R, this.m_localAnchor2);\r\n\t\ttMat = this.m_body2.m_R;\r\n\t\tvar r2X = tMat.col1.x * this.m_localAnchor2.x + tMat.col2.x * this.m_localAnchor2.y;\r\n\t\tvar r2Y = tMat.col1.y * this.m_localAnchor2.x + tMat.col2.y * this.m_localAnchor2.y;\r\n\r\n\t\t// Cdot = dot(u, v + cross(w, r))\r\n\t\t//b2Vec2 v1 = this.m_body1->m_linearVelocity + b2Cross(this.m_body1->m_angularVelocity, r1);\r\n\t\tvar v1X = this.m_body1.m_linearVelocity.x + (-this.m_body1.m_angularVelocity * r1Y);\r\n\t\tvar v1Y = this.m_body1.m_linearVelocity.y + (this.m_body1.m_angularVelocity * r1X);\r\n\t\t//b2Vec2 v2 = this.m_body2->m_linearVelocity + b2Cross(this.m_body2->m_angularVelocity, r2);\r\n\t\tvar v2X = this.m_body2.m_linearVelocity.x + (-this.m_body2.m_angularVelocity * r2Y);\r\n\t\tvar v2Y = this.m_body2.m_linearVelocity.y + (this.m_body2.m_angularVelocity * r2X);\r\n\t\t//float32 Cdot = b2Dot(this.m_u, v2 - v1);\r\n\t\tvar Cdot = (this.m_u.x * (v2X - v1X) + this.m_u.y * (v2Y - v1Y));\r\n\t\t//float32 impulse = -this.m_mass * Cdot;\r\n\t\tvar impulse = -this.m_mass * Cdot;\r\n\t\tthis.m_impulse += impulse;\r\n\r\n\t\t//b2Vec2 P = impulse * this.m_u;\r\n\t\tvar PX = impulse * this.m_u.x;\r\n\t\tvar PY = impulse * this.m_u.y;\r\n\t\t//this.m_body1->m_linearVelocity -= this.m_body1->m_invMass * P;\r\n\t\tthis.m_body1.m_linearVelocity.x -= this.m_body1.m_invMass * PX;\r\n\t\tthis.m_body1.m_linearVelocity.y -= this.m_body1.m_invMass * PY;\r\n\t\t//this.m_body1->m_angularVelocity -= this.m_body1->m_invI * b2Cross(r1, P);\r\n\t\tthis.m_body1.m_angularVelocity -= this.m_body1.m_invI * (r1X * PY - r1Y * PX);\r\n\t\t//this.m_body2->m_linearVelocity += this.m_body2->m_invMass * P;\r\n\t\tthis.m_body2.m_linearVelocity.x += this.m_body2.m_invMass * PX;\r\n\t\tthis.m_body2.m_linearVelocity.y += this.m_body2.m_invMass * PY;\r\n\t\t//this.m_body2->m_angularVelocity += this.m_body2->m_invI * b2Cross(r2, P);\r\n\t\tthis.m_body2.m_angularVelocity += this.m_body2.m_invI * (r2X * PY - r2Y * PX);\r\n\t};\r\n\r\n\tthis.SolvePositionConstraints = function(){\r\n\r\n\t\tvar tMat;\r\n\r\n\t\t//b2Vec2 r1 = b2Mul(this.m_body1->m_R, this.m_localAnchor1);\r\n\t\ttMat = this.m_body1.m_R;\r\n\t\tvar r1X = tMat.col1.x * this.m_localAnchor1.x + tMat.col2.x * this.m_localAnchor1.y;\r\n\t\tvar r1Y = tMat.col1.y * this.m_localAnchor1.x + tMat.col2.y * this.m_localAnchor1.y;\r\n\t\t//b2Vec2 r2 = b2Mul(this.m_body2->m_R, this.m_localAnchor2);\r\n\t\ttMat = this.m_body2.m_R;\r\n\t\tvar r2X = tMat.col1.x * this.m_localAnchor2.x + tMat.col2.x * this.m_localAnchor2.y;\r\n\t\tvar r2Y = tMat.col1.y * this.m_localAnchor2.x + tMat.col2.y * this.m_localAnchor2.y;\r\n\t\t//b2Vec2 d = this.m_body2->m_position + r2 - this.m_body1->m_position - r1;\r\n\t\tvar dX = this.m_body2.m_position.x + r2X - this.m_body1.m_position.x - r1X;\r\n\t\tvar dY = this.m_body2.m_position.y + r2Y - this.m_body1.m_position.y - r1Y;\r\n\r\n\t\t//float32 length = d.Normalize();\r\n\t\tvar length = Math.sqrt(dX*dX + dY*dY);\r\n\t\tdX /= length;\r\n\t\tdY /= length;\r\n\t\t//float32 C = length - this.m_length;\r\n\t\tvar C = length - this.m_length;\r\n\t\tC = b2Math.b2Clamp(C, -b2Settings.b2_maxLinearCorrection, b2Settings.b2_maxLinearCorrection);\r\n\r\n\t\tvar impulse = -this.m_mass * C;\r\n\t\t//this.m_u = d;\r\n\t\tthis.m_u.Set(dX, dY);\r\n\t\t//b2Vec2 P = impulse * this.m_u;\r\n\t\tvar PX = impulse * this.m_u.x;\r\n\t\tvar PY = impulse * this.m_u.y;\r\n\r\n\t\t//this.m_body1->m_position -= this.m_body1->m_invMass * P;\r\n\t\tthis.m_body1.m_position.x -= this.m_body1.m_invMass * PX;\r\n\t\tthis.m_body1.m_position.y -= this.m_body1.m_invMass * PY;\r\n\t\t//this.m_body1->m_rotation -= this.m_body1->m_invI * b2Cross(r1, P);\r\n\t\tthis.m_body1.m_rotation -= this.m_body1.m_invI * (r1X * PY - r1Y * PX);\r\n\t\t//this.m_body2->m_position += this.m_body2->m_invMass * P;\r\n\t\tthis.m_body2.m_position.x += this.m_body2.m_invMass * PX;\r\n\t\tthis.m_body2.m_position.y += this.m_body2.m_invMass * PY;\r\n\t\t//this.m_body2->m_rotation -= this.m_body2->m_invI * b2Cross(r2, P);\r\n\t\tthis.m_body2.m_rotation += this.m_body2.m_invI * (r2X * PY - r2Y * PX);\r\n\r\n\t\tthis.m_body1.m_R.Set(this.m_body1.m_rotation);\r\n\t\tthis.m_body2.m_R.Set(this.m_body2.m_rotation);\r\n\r\n\t\treturn b2Math.b2Abs(C) < b2Settings.b2_linearSlop;\r\n\t};\r\n\r\n\tthis.GetAnchor1 = function(){\r\n\t\treturn b2Math.AddVV(this.m_body1.m_position , b2Math.b2MulMV(this.m_body1.m_R, this.m_localAnchor1));\r\n\t};\r\n\tthis.GetAnchor2 = function(){\r\n\t\treturn b2Math.AddVV(this.m_body2.m_position , b2Math.b2MulMV(this.m_body2.m_R, this.m_localAnchor2));\r\n\t};\r\n\r\n\tthis.GetReactionForce = function(invTimeStep)\r\n\t{\r\n\t\t//var F = (this.m_impulse * invTimeStep) * this.m_u;\r\n\t\tvar F = new b2Vec2();\r\n\t\tF.SetV(this.m_u);\r\n\t\tF.Multiply(this.m_impulse * invTimeStep);\r\n\t\treturn F;\r\n\t};\r\n\r\n\tthis.GetReactionTorque = function(invTimeStep)\r\n\t{\r\n\t\t//NOT_USED(invTimeStep);\r\n\t\treturn 0.0;\r\n\t};\r\n});\r\n\r\n\r\n","pre":true},"./src/box2d/dynamics/joints/b2GearJoint.js":{"path":"./src/box2d/dynamics/joints/b2GearJoint.js","friendlyPath":".b2GearJoint","directory":"./src/box2d/dynamics/joints/","filename":"b2GearJoint.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\njsio(\"import ...common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import .b2Joint as b2Joint\");\r\njsio(\"import .b2JointNode as b2JointNode\");\r\njsio(\"import .b2Jacobian as b2Jacobian\");\r\n\r\nvar src_box2d_dynamics_joints_b2GearJoint=__class__;var b2GearJoint = exports=src_box2d_dynamics_joints_b2GearJoint(function src_box2d_dynamics_joints_b2GearJoint(){return this.init&&this.init.apply(this,arguments)},b2Joint, function(supr) {\r\n\tthis.GetAnchor1 = function(){\r\n\t\t//return this.m_body1.m_position + b2MulMV(this.m_body1.m_R, this.m_localAnchor1);\r\n\t\tvar tMat = this.m_body1.m_R;\r\n\t\treturn new b2Vec2(\tthis.m_body1.m_position.x + (tMat.col1.x * this.m_localAnchor1.x + tMat.col2.x * this.m_localAnchor1.y),\r\n\t\t\t\t\t\t\tthis.m_body1.m_position.y + (tMat.col1.y * this.m_localAnchor1.x + tMat.col2.y * this.m_localAnchor1.y));\r\n\t};\r\n\tthis.GetAnchor2 = function(){\r\n\t\t//return this.m_body2->m_position + b2Mul(this.m_body2->m_R, this.m_localAnchor2);\r\n\t\tvar tMat = this.m_body2.m_R;\r\n\t\treturn new b2Vec2(\tthis.m_body2.m_position.x + (tMat.col1.x * this.m_localAnchor2.x + tMat.col2.x * this.m_localAnchor2.y),\r\n\t\t\t\t\t\t\tthis.m_body2.m_position.y + (tMat.col1.y * this.m_localAnchor2.x + tMat.col2.y * this.m_localAnchor2.y));\r\n\t};\r\n\r\n\tthis.GetReactionForce = function(invTimeStep){\r\n\t\t//b2Vec2 F(0.0f, 0.0f);\r\n\t\treturn new b2Vec2();\r\n\t};\r\n\tthis.GetReactionTorque = function(invTimeStep){\r\n\t\treturn 0.0;\r\n\t};\r\n\r\n\tthis.GetRatio = function(){\r\n\t\treturn this.m_ratio;\r\n\t};\r\n\r\n\t//--------------- Internals Below -------------------\r\n\r\n\tthis.init = function(def){\r\n\t\tsupr(this, 'init', [def]);\r\n\t\t// The constructor for b2Joint\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_node1 = new b2JointNode();\r\n\t\tthis.m_node2 = new b2JointNode();\r\n\t\t//\r\n\t\tthis.m_type = def.type;\r\n\t\tthis.m_prev = null;\r\n\t\tthis.m_next = null;\r\n\t\tthis.m_body1 = def.body1;\r\n\t\tthis.m_body2 = def.body2;\r\n\t\tthis.m_collideConnected = def.collideConnected;\r\n\t\tthis.m_islandFlag = false;\r\n\t\tthis.m_userData = def.userData;\r\n\t\t//\r\n\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_groundAnchor1 = new b2Vec2();\r\n\t\tthis.m_groundAnchor2 = new b2Vec2();\r\n\t\tthis.m_localAnchor1 = new b2Vec2();\r\n\t\tthis.m_localAnchor2 = new b2Vec2();\r\n\t\tthis.m_J = new b2Jacobian();\r\n\t\t//\r\n\r\n\t\t// Effective mass\r\n\t\tthis.m_mass = null;\r\n\r\n\t\t// parent constructor\r\n\t\t//super(def);\r\n\r\n\t\t//b2Settings.b2Assert(def.joint1.m_type == b2Joint.e_revoluteJoint || def.joint1.m_type == b2Joint.e_prismaticJoint);\r\n\t\t//b2Settings.b2Assert(def.joint2.m_type == b2Joint.e_revoluteJoint || def.joint2.m_type == b2Joint.e_prismaticJoint);\r\n\t\t//b2Settings.b2Assert(def.joint1.m_body1.IsStatic());\r\n\t\t//b2Settings.b2Assert(def.joint2.m_body1.IsStatic());\r\n\r\n\t\tthis.m_revolute1 = null;\r\n\t\tthis.m_prismatic1 = null;\r\n\t\tthis.m_revolute2 = null;\r\n\t\tthis.m_prismatic2 = null;\r\n\r\n\t\tvar coordinate1;\r\n\t\tvar coordinate2;\r\n\r\n\t\tthis.m_ground1 = def.joint1.m_body1;\r\n\t\tthis.m_body1 = def.joint1.m_body2;\r\n\t\tif (def.joint1.m_type == b2Joint.e_revoluteJoint)\r\n\t\t{\r\n\t\t\tthis.m_revolute1 = def.joint1;\r\n\t\t\tthis.m_groundAnchor1.SetV( this.m_revolute1.m_localAnchor1 );\r\n\t\t\tthis.m_localAnchor1.SetV( this.m_revolute1.m_localAnchor2 );\r\n\t\t\tcoordinate1 = this.m_revolute1.GetJointAngle();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tthis.m_prismatic1 = def.joint1;\r\n\t\t\tthis.m_groundAnchor1.SetV( this.m_prismatic1.m_localAnchor1 );\r\n\t\t\tthis.m_localAnchor1.SetV( this.m_prismatic1.m_localAnchor2 );\r\n\t\t\tcoordinate1 = this.m_prismatic1.GetJointTranslation();\r\n\t\t}\r\n\r\n\t\tthis.m_ground2 = def.joint2.m_body1;\r\n\t\tthis.m_body2 = def.joint2.m_body2;\r\n\t\tif (def.joint2.m_type == b2Joint.e_revoluteJoint)\r\n\t\t{\r\n\t\t\tthis.m_revolute2 = def.joint2;\r\n\t\t\tthis.m_groundAnchor2.SetV( this.m_revolute2.m_localAnchor1 );\r\n\t\t\tthis.m_localAnchor2.SetV( this.m_revolute2.m_localAnchor2 );\r\n\t\t\tcoordinate2 = this.m_revolute2.GetJointAngle();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tthis.m_prismatic2 = def.joint2;\r\n\t\t\tthis.m_groundAnchor2.SetV( this.m_prismatic2.m_localAnchor1 );\r\n\t\t\tthis.m_localAnchor2.SetV( this.m_prismatic2.m_localAnchor2 );\r\n\t\t\tcoordinate2 = this.m_prismatic2.GetJointTranslation();\r\n\t\t}\r\n\r\n\t\tthis.m_ratio = def.ratio;\r\n\r\n\t\tthis.m_constant = coordinate1 + this.m_ratio * coordinate2;\r\n\r\n\t\tthis.m_impulse = 0.0;\r\n\r\n\t};\r\n\r\n\tthis.PrepareVelocitySolver = function(){\r\n\t\tvar g1 = this.m_ground1;\r\n\t\tvar g2 = this.m_ground2;\r\n\t\tvar b1 = this.m_body1;\r\n\t\tvar b2 = this.m_body2;\r\n\r\n\t\t// temp vars\r\n\t\tvar ugX;\r\n\t\tvar ugY;\r\n\t\tvar rX;\r\n\t\tvar rY;\r\n\t\tvar tMat;\r\n\t\tvar tVec;\r\n\t\tvar crug;\r\n\r\n\t\tvar K = 0.0;\r\n\t\tthis.m_J.SetZero();\r\n\r\n\t\tif (this.m_revolute1)\r\n\t\t{\r\n\t\t\tthis.m_J.angular1 = -1.0;\r\n\t\t\tK += b1.m_invI;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t//b2Vec2 ug = b2MulMV(g1->m_R, this.m_prismatic1->m_localXAxis1);\r\n\t\t\ttMat = g1.m_R;\r\n\t\t\ttVec = this.m_prismatic1.m_localXAxis1;\r\n\t\t\tugX = tMat.col1.x * tVec.x + tMat.col2.x * tVec.y;\r\n\t\t\tugY = tMat.col1.y * tVec.x + tMat.col2.y * tVec.y;\r\n\t\t\t//b2Vec2 r = b2MulMV(b1->m_R, this.m_localAnchor1);\r\n\t\t\ttMat = b1.m_R;\r\n\t\t\trX = tMat.col1.x * this.m_localAnchor1.x + tMat.col2.x * this.m_localAnchor1.y;\r\n\t\t\trY = tMat.col1.y * this.m_localAnchor1.x + tMat.col2.y * this.m_localAnchor1.y;\r\n\r\n\t\t\t//var crug = b2Cross(r, ug);\r\n\t\t\tcrug = rX * ugY - rY * ugX;\r\n\t\t\t//this.m_J.linear1 = -ug;\r\n\t\t\tthis.m_J.linear1.Set(-ugX, -ugY);\r\n\t\t\tthis.m_J.angular1 = -crug;\r\n\t\t\tK += b1.m_invMass + b1.m_invI * crug * crug;\r\n\t\t}\r\n\r\n\t\tif (this.m_revolute2)\r\n\t\t{\r\n\t\t\tthis.m_J.angular2 = -this.m_ratio;\r\n\t\t\tK += this.m_ratio * this.m_ratio * b2.m_invI;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t//b2Vec2 ug = b2Mul(g2->m_R, this.m_prismatic2->m_localXAxis1);\r\n\t\t\ttMat = g2.m_R;\r\n\t\t\ttVec = this.m_prismatic2.m_localXAxis1;\r\n\t\t\tugX = tMat.col1.x * tVec.x + tMat.col2.x * tVec.y;\r\n\t\t\tugY = tMat.col1.y * tVec.x + tMat.col2.y * tVec.y;\r\n\t\t\t//b2Vec2 r = b2Mul(b2->m_R, this.m_localAnchor2);\r\n\t\t\ttMat = b2.m_R;\r\n\t\t\trX = tMat.col1.x * this.m_localAnchor2.x + tMat.col2.x * this.m_localAnchor2.y;\r\n\t\t\trY = tMat.col1.y * this.m_localAnchor2.x + tMat.col2.y * this.m_localAnchor2.y;\r\n\t\t\t//float32 crug = b2Cross(r, ug);\r\n\t\t\tcrug = rX * ugY - rY * ugX;\r\n\t\t\t//this.m_J.linear2 = -this.m_ratio * ug;\r\n\t\t\tthis.m_J.linear2.Set(-this.m_ratio*ugX, -this.m_ratio*ugY);\r\n\t\t\tthis.m_J.angular2 = -this.m_ratio * crug;\r\n\t\t\tK += this.m_ratio * this.m_ratio * (b2.m_invMass + b2.m_invI * crug * crug);\r\n\t\t}\r\n\r\n\t\t// Compute effective mass.\r\n\t\t//b2Settings.b2Assert(K > 0.0);\r\n\t\tthis.m_mass = 1.0 / K;\r\n\r\n\t\t// Warm starting.\r\n\t\t//b1.m_linearVelocity += b1.m_invMass * this.m_impulse * this.m_J.linear1;\r\n\t\tb1.m_linearVelocity.x += b1.m_invMass * this.m_impulse * this.m_J.linear1.x;\r\n\t\tb1.m_linearVelocity.y += b1.m_invMass * this.m_impulse * this.m_J.linear1.y;\r\n\t\tb1.m_angularVelocity += b1.m_invI * this.m_impulse * this.m_J.angular1;\r\n\t\t//b2.m_linearVelocity += b2.m_invMass * this.m_impulse * this.m_J.linear2;\r\n\t\tb2.m_linearVelocity.x += b2.m_invMass * this.m_impulse * this.m_J.linear2.x;\r\n\t\tb2.m_linearVelocity.y += b2.m_invMass * this.m_impulse * this.m_J.linear2.y;\r\n\t\tb2.m_angularVelocity += b2.m_invI * this.m_impulse * this.m_J.angular2;\r\n\t};\r\n\r\n\tthis.SolveVelocityConstraints = function(step){\r\n\t\tvar b1 = this.m_body1;\r\n\t\tvar b2 = this.m_body2;\r\n\r\n\t\tvar Cdot = this.m_J.Compute(\tb1.m_linearVelocity, b1.m_angularVelocity,\r\n\t\t\t\t\t\t\t\t\t\tb2.m_linearVelocity, b2.m_angularVelocity);\r\n\r\n\t\tvar impulse = -this.m_mass * Cdot;\r\n\t\tthis.m_impulse += impulse;\r\n\r\n\t\tb1.m_linearVelocity.x += b1.m_invMass * impulse * this.m_J.linear1.x;\r\n\t\tb1.m_linearVelocity.y += b1.m_invMass * impulse * this.m_J.linear1.y;\r\n\t\tb1.m_angularVelocity  += b1.m_invI * impulse * this.m_J.angular1;\r\n\t\tb2.m_linearVelocity.x += b2.m_invMass * impulse * this.m_J.linear2.x;\r\n\t\tb2.m_linearVelocity.y += b2.m_invMass * impulse * this.m_J.linear2.y;\r\n\t\tb2.m_angularVelocity  += b2.m_invI * impulse * this.m_J.angular2;\r\n\t};\r\n\r\n\tthis.SolvePositionConstraints = function(){\r\n\t\tvar linearError = 0.0;\r\n\r\n\t\tvar b1 = this.m_body1;\r\n\t\tvar b2 = this.m_body2;\r\n\r\n\t\tvar coordinate1;\r\n\t\tvar coordinate2;\r\n\t\tif (this.m_revolute1)\r\n\t\t{\r\n\t\t\tcoordinate1 = this.m_revolute1.GetJointAngle();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tcoordinate1 = this.m_prismatic1.GetJointTranslation();\r\n\t\t}\r\n\r\n\t\tif (this.m_revolute2)\r\n\t\t{\r\n\t\t\tcoordinate2 = this.m_revolute2.GetJointAngle();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tcoordinate2 = this.m_prismatic2.GetJointTranslation();\r\n\t\t}\r\n\r\n\t\tvar C = this.m_constant - (coordinate1 + this.m_ratio * coordinate2);\r\n\r\n\t\tvar impulse = -this.m_mass * C;\r\n\r\n\t\tb1.m_position.x += b1.m_invMass * impulse * this.m_J.linear1.x;\r\n\t\tb1.m_position.y += b1.m_invMass * impulse * this.m_J.linear1.y;\r\n\t\tb1.m_rotation += b1.m_invI * impulse * this.m_J.angular1;\r\n\t\tb2.m_position.x += b2.m_invMass * impulse * this.m_J.linear2.x;\r\n\t\tb2.m_position.y += b2.m_invMass * impulse * this.m_J.linear2.y;\r\n\t\tb2.m_rotation += b2.m_invI * impulse * this.m_J.angular2;\r\n\t\tb1.m_R.Set(b1.m_rotation);\r\n\t\tb2.m_R.Set(b2.m_rotation);\r\n\r\n\t\treturn linearError < b2Settings.b2_linearSlop;\r\n\t};\r\n\r\n});\r\n","pre":true},"./src/box2d/dynamics/joints/b2Jacobian.js":{"path":"./src/box2d/dynamics/joints/b2Jacobian.js","friendlyPath":".b2Jacobian","directory":"./src/box2d/dynamics/joints/","filename":"b2Jacobian.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\njsio(\"import ...common.math.b2Vec2 as b2Vec2\");\r\n\r\n\r\nvar src_box2d_dynamics_joints_b2Jacobian=__class__;var b2Jacobian = exports=src_box2d_dynamics_joints_b2Jacobian(function src_box2d_dynamics_joints_b2Jacobian(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\r\n\tthis.SetZero = function(){\r\n\t\tthis.linear1.SetZero(); this.angular1 = 0.0;\r\n\t\tthis.linear2.SetZero(); this.angular2 = 0.0;\r\n\t};\r\n\tthis.Set = function(x1, a1, x2, a2){\r\n\t\tthis.linear1.SetV(x1); this.angular1 = a1;\r\n\t\tthis.linear2.SetV(x2); this.angular2 = a2;\r\n\t};\r\n\tthis.Compute = function(x1, a1, x2, a2){\r\n\r\n\t\t//return b2Math.b2Dot(this.linear1, x1) + this.angular1 * a1 + b2Math.b2Dot(this.linear2, x2) + this.angular2 * a2;\r\n\t\treturn (this.linear1.x*x1.x + this.linear1.y*x1.y) + this.angular1 * a1 + (this.linear2.x*x2.x + this.linear2.y*x2.y) + this.angular2 * a2;\r\n\t};\r\n\tthis.init = function() {\r\n\t\t// initialize instance variables for references\r\n\t\tthis.linear1 = new b2Vec2();\r\n\t\tthis.linear2 = new b2Vec2();\r\n\t\tthis.angular1 = null;\r\n\t\tthis.angular2 = null;\r\n\t};\r\n});\r\n","pre":true},"./src/box2d/dynamics/joints/b2MouseJoint.js":{"path":"./src/box2d/dynamics/joints/b2MouseJoint.js","friendlyPath":".b2MouseJoint","directory":"./src/box2d/dynamics/joints/","filename":"b2MouseJoint.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\njsio(\"import ...common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import ...common.math.b2Math as b2Math\");\r\njsio(\"import ...common.math.b2Mat22 as b2Mat22\");\r\njsio(\"import .b2Joint as b2Joint\");\r\njsio(\"import .b2JointNode as b2JointNode\");\r\n\r\n\r\n// p = attached point, m = mouse point\r\n// C = p - m\r\n// Cdot = v\r\n//      = v + cross(w, r)\r\n// J = [I r_skew]\r\n// Identity used:\r\n// w k % (rx i + ry j) = w * (-ry i + rx j)\r\n\r\nvar src_box2d_dynamics_joints_b2MouseJoint=__class__;var b2MouseJoint = exports=src_box2d_dynamics_joints_b2MouseJoint(function src_box2d_dynamics_joints_b2MouseJoint(){return this.init&&this.init.apply(this,arguments)},b2Joint, function(supr) {\r\n\tthis.GetAnchor1 = function(){\r\n\t\treturn this.m_target;\r\n\t};\r\n\tthis.GetAnchor2 = function(){\r\n\t\tvar tVec = b2Math.b2MulMV(this.m_body2.m_R, this.m_localAnchor);\r\n\t\ttVec.Add(this.m_body2.m_position);\r\n\t\treturn tVec;\r\n\t};\r\n\r\n\tthis.GetReactionForce = function(invTimeStep)\r\n\t{\r\n\t\t//b2Vec2 F = invTimeStep * this.m_impulse;\r\n\t\tvar F = new b2Vec2();\r\n\t\tF.SetV(this.m_impulse);\r\n\t\tF.Multiply(invTimeStep);\r\n\t\treturn F;\r\n\t};\r\n\r\n\tthis.GetReactionTorque = function(invTimeStep)\r\n\t{\r\n\t\t//NOT_USED(invTimeStep);\r\n\t\treturn 0.0;\r\n\t};\r\n\r\n\tthis.SetTarget = function(target){\r\n\t\tthis.m_body2.WakeUp();\r\n\t\tthis.m_target = target;\r\n\t};\r\n\r\n\t//--------------- Internals Below -------------------\r\n\r\n\tthis.init = function(def){\r\n\t\tsupr(this, 'init', [def]);\r\n\t\t// The constructor for b2Joint\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_node1 = new b2JointNode();\r\n\t\tthis.m_node2 = new b2JointNode();\r\n\t\t//\r\n\t\tthis.m_type = def.type;\r\n\t\tthis.m_prev = null;\r\n\t\tthis.m_next = null;\r\n\t\tthis.m_body1 = def.body1;\r\n\t\tthis.m_body2 = def.body2;\r\n\t\tthis.m_collideConnected = def.collideConnected;\r\n\t\tthis.m_islandFlag = false;\r\n\t\tthis.m_userData = def.userData;\r\n\t\t//\r\n\r\n\t\t// initialize instance variables for references\r\n\t\tthis.K = new b2Mat22();\r\n\t\tthis.K1 = new b2Mat22();\r\n\t\tthis.K2 = new b2Mat22();\r\n\t\tthis.m_localAnchor = new b2Vec2();\r\n\t\tthis.m_target = new b2Vec2();\r\n\t\tthis.m_impulse = new b2Vec2();\r\n\t\tthis.m_ptpMass = new b2Mat22();\r\n\t\tthis.m_C = new b2Vec2();\r\n\t\t//\r\n\r\n\t\t//super(def);\r\n\r\n\t\tthis.m_target.SetV(def.target);\r\n\t\t//this.m_localAnchor = b2Math.b2MulTMV(this.m_body2.m_R, b2Math.SubtractVV( this.m_target, this.m_body2.m_position ) );\r\n\t\tvar tX = this.m_target.x - this.m_body2.m_position.x;\r\n\t\tvar tY = this.m_target.y - this.m_body2.m_position.y;\r\n\t\tthis.m_localAnchor.x = (tX * this.m_body2.m_R.col1.x + tY * this.m_body2.m_R.col1.y);\r\n\t\tthis.m_localAnchor.y = (tX * this.m_body2.m_R.col2.x + tY * this.m_body2.m_R.col2.y);\r\n\r\n\t\tthis.m_maxForce = def.maxForce;\r\n\t\tthis.m_impulse.SetZero();\r\n\r\n\t\tvar mass = this.m_body2.m_mass;\r\n\r\n\t\t// Frequency\r\n\t\tvar omega = 2.0 * b2Settings.b2_pi * def.frequencyHz;\r\n\r\n\t\t// Damping coefficient\r\n\t\tvar d = 2.0 * mass * def.dampingRatio * omega;\r\n\r\n\t\t// Spring stiffness\r\n\t\tvar k = mass * omega * omega;\r\n\r\n\t\t// magic formulas\r\n\t\tthis.m_gamma = 1.0 / (d + def.timeStep * k);\r\n\t\tthis.m_beta = def.timeStep * k / (d + def.timeStep * k);\r\n\t};\r\n\r\n\tthis.PrepareVelocitySolver = function(){\r\n\t\tvar b = this.m_body2;\r\n\r\n\t\tvar tMat;\r\n\r\n\t\t// Compute the effective mass matrix.\r\n\t\t//b2Vec2 r = b2Mul(b.m_R, this.m_localAnchor);\r\n\t\ttMat = b.m_R;\r\n\t\tvar rX = tMat.col1.x * this.m_localAnchor.x + tMat.col2.x * this.m_localAnchor.y;\r\n\t\tvar rY = tMat.col1.y * this.m_localAnchor.x + tMat.col2.y * this.m_localAnchor.y;\r\n\r\n\t\t// this.K    = [(1/m1 + 1/m2) * eye(2) - skew(r1) * invI1 * skew(r1) - skew(r2) * invI2 * skew(r2)]\r\n\t\t//      = [1/m1+1/m2     0    ] + invI1 * [r1.y*r1.y -r1.x*r1.y] + invI2 * [r1.y*r1.y -r1.x*r1.y]\r\n\t\t//        [    0     1/m1+1/m2]           [-r1.x*r1.y r1.x*r1.x]           [-r1.x*r1.y r1.x*r1.x]\r\n\t\tvar invMass = b.m_invMass;\r\n\t\tvar invI = b.m_invI;\r\n\r\n\t\t//b2Mat22 this.K1;\r\n\t\tthis.K1.col1.x = invMass;\tthis.K1.col2.x = 0.0;\r\n\t\tthis.K1.col1.y = 0.0;\t\tthis.K1.col2.y = invMass;\r\n\r\n\t\t//b2Mat22 this.K2;\r\n\t\tthis.K2.col1.x =  invI * rY * rY;\tthis.K2.col2.x = -invI * rX * rY;\r\n\t\tthis.K2.col1.y = -invI * rX * rY;\tthis.K2.col2.y =  invI * rX * rX;\r\n\r\n\t\t//b2Mat22 this.K = this.K1 + this.K2;\r\n\t\tthis.K.SetM(this.K1);\r\n\t\tthis.K.AddM(this.K2);\r\n\t\tthis.K.col1.x += this.m_gamma;\r\n\t\tthis.K.col2.y += this.m_gamma;\r\n\r\n\t\t//this.m_ptpMass = this.K.Invert();\r\n\t\tthis.K.Invert(this.m_ptpMass);\r\n\r\n\t\t//this.m_C = b.m_position + r - this.m_target;\r\n\t\tthis.m_C.x = b.m_position.x + rX - this.m_target.x;\r\n\t\tthis.m_C.y = b.m_position.y + rY - this.m_target.y;\r\n\r\n\t\t// Cheat with some damping\r\n\t\tb.m_angularVelocity *= 0.98;\r\n\r\n\t\t// Warm starting.\r\n\t\t//b2Vec2 P = this.m_impulse;\r\n\t\tvar PX = this.m_impulse.x;\r\n\t\tvar PY = this.m_impulse.y;\r\n\t\t//b.m_linearVelocity += invMass * P;\r\n\t\tb.m_linearVelocity.x += invMass * PX;\r\n\t\tb.m_linearVelocity.y += invMass * PY;\r\n\t\t//b.m_angularVelocity += invI * b2Cross(r, P);\r\n\t\tb.m_angularVelocity += invI * (rX * PY - rY * PX);\r\n\t};\r\n\r\n\tthis.SolveVelocityConstraints = function(step){\r\n\t\tvar body = this.m_body2;\r\n\r\n\t\tvar tMat;\r\n\r\n\t\t// Compute the effective mass matrix.\r\n\t\t//b2Vec2 r = b2Mul(body.m_R, this.m_localAnchor);\r\n\t\ttMat = body.m_R;\r\n\t\tvar rX = tMat.col1.x * this.m_localAnchor.x + tMat.col2.x * this.m_localAnchor.y;\r\n\t\tvar rY = tMat.col1.y * this.m_localAnchor.x + tMat.col2.y * this.m_localAnchor.y;\r\n\r\n\t\t// Cdot = v + cross(w, r)\r\n\t\t//b2Vec2 Cdot = body->m_linearVelocity + b2Cross(body->m_angularVelocity, r);\r\n\t\tvar CdotX = body.m_linearVelocity.x + (-body.m_angularVelocity * rY);\r\n\t\tvar CdotY = body.m_linearVelocity.y + (body.m_angularVelocity * rX);\r\n\t\t//b2Vec2 impulse = -b2Mul(this.m_ptpMass, Cdot + (this.m_beta * step->inv_dt) * this.m_C + this.m_gamma * this.m_impulse);\r\n\t\ttMat = this.m_ptpMass;\r\n\t\tvar tX = CdotX + (this.m_beta * step.inv_dt) * this.m_C.x + this.m_gamma * this.m_impulse.x;\r\n\t\tvar tY = CdotY + (this.m_beta * step.inv_dt) * this.m_C.y + this.m_gamma * this.m_impulse.y;\r\n\t\tvar impulseX = -(tMat.col1.x * tX + tMat.col2.x * tY);\r\n\t\tvar impulseY = -(tMat.col1.y * tX + tMat.col2.y * tY);\r\n\r\n\t\tvar oldImpulseX = this.m_impulse.x;\r\n\t\tvar oldImpulseY = this.m_impulse.y;\r\n\t\t//this.m_impulse += impulse;\r\n\t\tthis.m_impulse.x += impulseX;\r\n\t\tthis.m_impulse.y += impulseY;\r\n\t\tvar length = this.m_impulse.Length();\r\n\t\tif (length > step.dt * this.m_maxForce)\r\n\t\t{\r\n\t\t\t//this.m_impulse *= step.dt * this.m_maxForce / length;\r\n\t\t\tthis.m_impulse.Multiply(step.dt * this.m_maxForce / length);\r\n\t\t}\r\n\t\t//impulse = this.m_impulse - oldImpulse;\r\n\t\timpulseX = this.m_impulse.x - oldImpulseX;\r\n\t\timpulseY = this.m_impulse.y - oldImpulseY;\r\n\r\n\t\t//body.m_linearVelocity += body->m_invMass * impulse;\r\n\t\tbody.m_linearVelocity.x += body.m_invMass * impulseX;\r\n\t\tbody.m_linearVelocity.y += body.m_invMass * impulseY;\r\n\t\t//body.m_angularVelocity += body->m_invI * b2Cross(r, impulse);\r\n\t\tbody.m_angularVelocity += body.m_invI * (rX * impulseY - rY * impulseX);\r\n\t};\r\n\tthis.SolvePositionConstraints = function(){\r\n\t\treturn true;\r\n\t};\r\n});\r\n\r\n","pre":true},"./src/box2d/dynamics/joints/b2PrismaticJoint.js":{"path":"./src/box2d/dynamics/joints/b2PrismaticJoint.js","friendlyPath":".b2PrismaticJoint","directory":"./src/box2d/dynamics/joints/","filename":"b2PrismaticJoint.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\njsio(\"import ...common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import ...common.math.b2Math as b2Math\");\r\njsio(\"import .b2Jacobian as b2Jacobian\");\r\njsio(\"import .b2Joint as b2Joint\");\r\njsio(\"import .b2JointNode as b2JointNode\");\r\njsio(\"import ..b2World as b2World\");\r\n\r\n// Linear constraint (point-to-line)\r\n// d = p2 - p1 = x2 + r2 - x1 - r1\r\n// C = dot(ay1, d)\r\n// Cdot = dot(d, cross(w1, ay1)) + dot(ay1, v2 + cross(w2, r2) - v1 - cross(w1, r1))\r\n//      = -dot(ay1, v1) - dot(cross(d + r1, ay1), w1) + dot(ay1, v2) + dot(cross(r2, ay1), v2)\r\n// J = [-ay1 -cross(d+r1,ay1) ay1 cross(r2,ay1)]\r\n//\r\n// Angular constraint\r\n// C = a2 - a1 + a_initial\r\n// Cdot = w2 - w1\r\n// J = [0 0 -1 0 0 1]\r\n\r\n// Motor/Limit linear constraint\r\n// C = dot(ax1, d)\r\n// Cdot = = -dot(ax1, v1) - dot(cross(d + r1, ax1), w1) + dot(ax1, v2) + dot(cross(r2, ax1), v2)\r\n// J = [-ax1 -cross(d+r1,ax1) ax1 cross(r2,ax1)]\r\n\r\nvar src_box2d_dynamics_joints_b2PrismaticJoint=__class__;var b2PrismaticJoint = exports=src_box2d_dynamics_joints_b2PrismaticJoint(function src_box2d_dynamics_joints_b2PrismaticJoint(){return this.init&&this.init.apply(this,arguments)},b2Joint, function(supr) {\r\n\tthis.GetAnchor1 = function(){\r\n\t\tvar b1 = this.m_body1;\r\n\t\t//return b2Math.AddVV(b1.m_position, b2Math.b2MulMV(b1.m_R, this.m_localAnchor1));\r\n\t\tvar tVec = new b2Vec2();\r\n\t\ttVec.SetV(this.m_localAnchor1);\r\n\t\ttVec.MulM(b1.m_R);\r\n\t\ttVec.sAdd(b1.m_position);\r\n\t\treturn tVec;\r\n\t};\r\n\tthis.GetAnchor2 = function(){\r\n\t\tvar b2 = this.m_body2;\r\n\t\t//return b2Math.AddVV(b2.m_position, b2Math.b2MulMV(b2.m_R, this.m_localAnchor2));\r\n\t\tvar tVec = new b2Vec2();\r\n\t\ttVec.SetV(this.m_localAnchor2);\r\n\t\ttVec.MulM(b2.m_R);\r\n\t\ttVec.sAdd(b2.m_position);\r\n\t\treturn tVec;\r\n\t};\r\n\tthis.GetJointTranslation = function(){\r\n\t\tvar b1 = this.m_body1;\r\n\t\tvar b2 = this.m_body2;\r\n\r\n\t\tvar tMat;\r\n\r\n\t\t//var r1 = b2Math.b2MulMV(b1.m_R, this.m_localAnchor1);\r\n\t\ttMat = b1.m_R;\r\n\t\tvar r1X = tMat.col1.x * this.m_localAnchor1.x + tMat.col2.x * this.m_localAnchor1.y;\r\n\t\tvar r1Y = tMat.col1.y * this.m_localAnchor1.x + tMat.col2.y * this.m_localAnchor1.y;\r\n\t\t//var r2 = b2Math.b2MulMV(b2.m_R, this.m_localAnchor2);\r\n\t\ttMat = b2.m_R;\r\n\t\tvar r2X = tMat.col1.x * this.m_localAnchor2.x + tMat.col2.x * this.m_localAnchor2.y;\r\n\t\tvar r2Y = tMat.col1.y * this.m_localAnchor2.x + tMat.col2.y * this.m_localAnchor2.y;\r\n\t\t//var p1 = b2Math.AddVV(b1.m_position , r1);\r\n\t\tvar p1X = b1.m_position.x + r1X;\r\n\t\tvar p1Y = b1.m_position.y + r1Y;\r\n\t\t//var p2 = b2Math.AddVV(b2.m_position , r2);\r\n\t\tvar p2X = b2.m_position.x + r2X;\r\n\t\tvar p2Y = b2.m_position.y + r2Y;\r\n\t\t//var d = b2Math.SubtractVV(p2, p1);\r\n\t\tvar dX = p2X - p1X;\r\n\t\tvar dY = p2Y - p1Y;\r\n\t\t//var ax1 = b2Math.b2MulMV(b1.m_R, this.m_localXAxis1);\r\n\t\ttMat = b1.m_R;\r\n\t\tvar ax1X = tMat.col1.x * this.m_localXAxis1.x + tMat.col2.x * this.m_localXAxis1.y;\r\n\t\tvar ax1Y = tMat.col1.y * this.m_localXAxis1.x + tMat.col2.y * this.m_localXAxis1.y;\r\n\r\n\t\t//var translation = b2Math.b2Dot(ax1, d);\r\n\t\tvar translation = ax1X*dX + ax1Y*dY;\r\n\t\treturn translation;\r\n\t};\r\n\tthis.GetJointSpeed = function(){\r\n\t\tvar b1 = this.m_body1;\r\n\t\tvar b2 = this.m_body2;\r\n\r\n\t\tvar tMat;\r\n\r\n\t\t//var r1 = b2Math.b2MulMV(b1.m_R, this.m_localAnchor1);\r\n\t\ttMat = b1.m_R;\r\n\t\tvar r1X = tMat.col1.x * this.m_localAnchor1.x + tMat.col2.x * this.m_localAnchor1.y;\r\n\t\tvar r1Y = tMat.col1.y * this.m_localAnchor1.x + tMat.col2.y * this.m_localAnchor1.y;\r\n\t\t//var r2 = b2Math.b2MulMV(b2.m_R, this.m_localAnchor2);\r\n\t\ttMat = b2.m_R;\r\n\t\tvar r2X = tMat.col1.x * this.m_localAnchor2.x + tMat.col2.x * this.m_localAnchor2.y;\r\n\t\tvar r2Y = tMat.col1.y * this.m_localAnchor2.x + tMat.col2.y * this.m_localAnchor2.y;\r\n\t\t//var p1 = b2Math.AddVV(b1.m_position , r1);\r\n\t\tvar p1X = b1.m_position.x + r1X;\r\n\t\tvar p1Y = b1.m_position.y + r1Y;\r\n\t\t//var p2 = b2Math.AddVV(b2.m_position , r2);\r\n\t\tvar p2X = b2.m_position.x + r2X;\r\n\t\tvar p2Y = b2.m_position.y + r2Y;\r\n\t\t//var d = b2Math.SubtractVV(p2, p1);\r\n\t\tvar dX = p2X - p1X;\r\n\t\tvar dY = p2Y - p1Y;\r\n\t\t//var ax1 = b2Math.b2MulMV(b1.m_R, this.m_localXAxis1);\r\n\t\ttMat = b1.m_R;\r\n\t\tvar ax1X = tMat.col1.x * this.m_localXAxis1.x + tMat.col2.x * this.m_localXAxis1.y;\r\n\t\tvar ax1Y = tMat.col1.y * this.m_localXAxis1.x + tMat.col2.y * this.m_localXAxis1.y;\r\n\r\n\t\tvar v1 = b1.m_linearVelocity;\r\n\t\tvar v2 = b2.m_linearVelocity;\r\n\t\tvar w1 = b1.m_angularVelocity;\r\n\t\tvar w2 = b2.m_angularVelocity;\r\n\r\n\t\t//var speed = b2Math.b2Dot(d, b2Math.b2CrossFV(w1, ax1)) + b2Math.b2Dot(ax1, b2Math.SubtractVV( b2Math.SubtractVV( b2Math.AddVV( v2 , b2Math.b2CrossFV(w2, r2)) , v1) , b2Math.b2CrossFV(w1, r1)));\r\n\t\t//var b2D = (dX*(-w1 * ax1Y) + dY*(w1 * ax1X));\r\n\t\t//var b2D2 = (ax1X * ((( v2.x + (-w2 * r2Y)) - v1.x) - (-w1 * r1Y)) + ax1Y * ((( v2.y + (w2 * r2X)) - v1.y) - (w1 * r1X)));\r\n\t\tvar speed = (dX*(-w1 * ax1Y) + dY*(w1 * ax1X)) + (ax1X * ((( v2.x + (-w2 * r2Y)) - v1.x) - (-w1 * r1Y)) + ax1Y * ((( v2.y + (w2 * r2X)) - v1.y) - (w1 * r1X)));\r\n\r\n\t\treturn speed;\r\n\t};\r\n\tthis.GetMotorForce = function(invTimeStep){\r\n\t\treturn invTimeStep * this.m_motorImpulse;\r\n\t};\r\n\r\n\tthis.SetMotorSpeed = function(speed)\r\n\t{\r\n\t\tthis.m_motorSpeed = speed;\r\n\t};\r\n\r\n\tthis.SetMotorForce = function(force)\r\n\t{\r\n\t\tthis.m_maxMotorForce = force;\r\n\t};\r\n\r\n\tthis.GetReactionForce = function(invTimeStep)\r\n\t{\r\n\t\tvar tImp = invTimeStep * this.m_limitImpulse;\r\n\t\tvar tMat;\r\n\r\n\t\t//var ax1 = b2Math.b2MulMV(this.m_body1.m_R, this.m_localXAxis1);\r\n\t\ttMat = this.m_body1.m_R;\r\n\t\tvar ax1X = tImp * (tMat.col1.x * this.m_localXAxis1.x + tMat.col2.x * this.m_localXAxis1.y);\r\n\t\tvar ax1Y = tImp * (tMat.col1.y * this.m_localXAxis1.x + tMat.col2.y * this.m_localXAxis1.y);\r\n\t\t//var ay1 = b2Math.b2MulMV(this.m_body1.m_R, this.m_localYAxis1);\r\n\t\tvar ay1X = tImp * (tMat.col1.x * this.m_localYAxis1.x + tMat.col2.x * this.m_localYAxis1.y);\r\n\t\tvar ay1Y = tImp * (tMat.col1.y * this.m_localYAxis1.x + tMat.col2.y * this.m_localYAxis1.y);\r\n\r\n\t\t//return (invTimeStep * this.m_limitImpulse) * ax1 + (invTimeStep * this.m_linearImpulse) * ay1;\r\n\r\n\t\treturn new b2Vec2(ax1X+ay1X, ax1Y+ay1Y);\r\n\t};\r\n\r\n\tthis.GetReactionTorque = function(invTimeStep)\r\n\t{\r\n\t\treturn invTimeStep * this.m_angularImpulse;\r\n\t};\r\n\r\n\r\n\t//--------------- Internals Below -------------------\r\n\tthis.init = function(def){\r\n\t\tsupr(this, 'init', [def]);\r\n\t\t// The constructor for b2Joint\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_limitState = 0;\r\n\t\tthis.m_node1 = new b2JointNode();\r\n\t\tthis.m_node2 = new b2JointNode();\r\n\t\t//\r\n\t\tthis.m_type = def.type;\r\n\t\tthis.m_prev = null;\r\n\t\tthis.m_next = null;\r\n\t\tthis.m_body1 = def.body1;\r\n\t\tthis.m_body2 = def.body2;\r\n\t\tthis.m_collideConnected = def.collideConnected;\r\n\t\tthis.m_islandFlag = false;\r\n\t\tthis.m_userData = def.userData;\r\n\t\t//\r\n\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_localAnchor1 = new b2Vec2();\r\n\t\tthis.m_localAnchor2 = new b2Vec2();\r\n\t\tthis.m_localXAxis1 = new b2Vec2();\r\n\t\tthis.m_localYAxis1 = new b2Vec2();\r\n\t\tthis.m_linearJacobian = new b2Jacobian();\r\n\t\tthis.m_motorJacobian = new b2Jacobian();\r\n\t\t//\r\n\r\n\t\t//super(def);\r\n\r\n\t\tvar tMat;\r\n\t\tvar tX;\r\n\t\tvar tY;\r\n\r\n\t\t//this.m_localAnchor1 = b2Math.b2MulTMV(this.m_body1.m_R, b2Math.SubtractVV(def.anchorPoint , this.m_body1.m_position));\r\n\t\ttMat = this.m_body1.m_R;\r\n\t\ttX = (def.anchorPoint.x - this.m_body1.m_position.x);\r\n\t\ttY = (def.anchorPoint.y - this.m_body1.m_position.y);\r\n\t\tthis.m_localAnchor1.Set((tX*tMat.col1.x + tY*tMat.col1.y), (tX*tMat.col2.x + tY*tMat.col2.y));\r\n\r\n\t\t//this.m_localAnchor2 = b2Math.b2MulTMV(this.m_body2.m_R, b2Math.SubtractVV(def.anchorPoint , this.m_body2.m_position));\r\n\t\ttMat = this.m_body2.m_R;\r\n\t\ttX = (def.anchorPoint.x - this.m_body2.m_position.x);\r\n\t\ttY = (def.anchorPoint.y - this.m_body2.m_position.y);\r\n\t\tthis.m_localAnchor2.Set((tX*tMat.col1.x + tY*tMat.col1.y), (tX*tMat.col2.x + tY*tMat.col2.y));\r\n\r\n\t\t//this.m_localXAxis1 = b2Math.b2MulTMV(this.m_body1.m_R, def.axis);\r\n\t\ttMat = this.m_body1.m_R;\r\n\t\ttX = def.axis.x;\r\n\t\ttY = def.axis.y;\r\n\t\tthis.m_localXAxis1.Set((tX*tMat.col1.x + tY*tMat.col1.y), (tX*tMat.col2.x + tY*tMat.col2.y));\r\n\r\n\t\t//this.m_localYAxis1 = b2Math.b2CrossFV(1.0, this.m_localXAxis1);\r\n\t\tthis.m_localYAxis1.x = -this.m_localXAxis1.y;\r\n\t\tthis.m_localYAxis1.y = this.m_localXAxis1.x;\r\n\r\n\t\tthis.m_initialAngle = this.m_body2.m_rotation - this.m_body1.m_rotation;\r\n\r\n\t\tthis.m_linearJacobian.SetZero();\r\n\t\tthis.m_linearMass = 0.0;\r\n\t\tthis.m_linearImpulse = 0.0;\r\n\r\n\t\tthis.m_angularMass = 0.0;\r\n\t\tthis.m_angularImpulse = 0.0;\r\n\r\n\t\tthis.m_motorJacobian.SetZero();\r\n\t\tthis.m_motorMass = 0.0;\r\n\t\tthis.m_motorImpulse = 0.0;\r\n\t\tthis.m_limitImpulse = 0.0;\r\n\t\tthis.m_limitPositionImpulse = 0.0;\r\n\r\n\t\tthis.m_lowerTranslation = def.lowerTranslation;\r\n\t\tthis.m_upperTranslation = def.upperTranslation;\r\n\t\tthis.m_maxMotorForce = def.motorForce;\r\n\t\tthis.m_motorSpeed = def.motorSpeed;\r\n\t\tthis.m_enableLimit = def.enableLimit;\r\n\t\tthis.m_enableMotor = def.enableMotor;\r\n\t};\r\n\r\n\tthis.PrepareVelocitySolver = function(){\r\n\t\tvar b1 = this.m_body1;\r\n\t\tvar b2 = this.m_body2;\r\n\r\n\t\tvar tMat;\r\n\r\n\t\t// Compute the effective masses.\r\n\t\t//b2Vec2 r1 = b2Mul(b1->m_R, this.m_localAnchor1);\r\n\t\ttMat = b1.m_R;\r\n\t\tvar r1X = tMat.col1.x * this.m_localAnchor1.x + tMat.col2.x * this.m_localAnchor1.y;\r\n\t\tvar r1Y = tMat.col1.y * this.m_localAnchor1.x + tMat.col2.y * this.m_localAnchor1.y;\r\n\t\t//b2Vec2 r2 = b2Mul(b2->m_R, this.m_localAnchor2);\r\n\t\ttMat = b2.m_R;\r\n\t\tvar r2X = tMat.col1.x * this.m_localAnchor2.x + tMat.col2.x * this.m_localAnchor2.y;\r\n\t\tvar r2Y = tMat.col1.y * this.m_localAnchor2.x + tMat.col2.y * this.m_localAnchor2.y;\r\n\r\n\t\t//float32 invMass1 = b1->m_invMass, invMass2 = b2->m_invMass;\r\n\t\tvar invMass1 = b1.m_invMass;\r\n\t\tvar invMass2 = b2.m_invMass;\r\n\t\t//float32 invI1 = b1->m_invI, invI2 = b2->m_invI;\r\n\t\tvar invI1 = b1.m_invI;\r\n\t\tvar invI2 = b2.m_invI;\r\n\r\n\t\t// Compute point to line constraint effective mass.\r\n\t\t// J = [-ay1 -cross(d+r1,ay1) ay1 cross(r2,ay1)]\r\n\t\t//b2Vec2 ay1 = b2Mul(b1->m_R, this.m_localYAxis1);\r\n\t\ttMat = b1.m_R;\r\n\t\tvar ay1X = tMat.col1.x * this.m_localYAxis1.x + tMat.col2.x * this.m_localYAxis1.y;\r\n\t\tvar ay1Y = tMat.col1.y * this.m_localYAxis1.x + tMat.col2.y * this.m_localYAxis1.y;\r\n\t\t//b2Vec2 e = b2->m_position + r2 - b1->m_position;\r\n\t\tvar eX = b2.m_position.x + r2X - b1.m_position.x;\r\n\t\tvar eY = b2.m_position.y + r2Y - b1.m_position.y;\r\n\r\n\t\t//this.m_linearJacobian.Set(-ay1, -b2Math.b2Cross(e, ay1), ay1, b2Math.b2Cross(r2, ay1));\r\n\t\tthis.m_linearJacobian.linear1.x = -ay1X;\r\n\t\tthis.m_linearJacobian.linear1.y = -ay1Y;\r\n\t\tthis.m_linearJacobian.linear2.x = ay1X;\r\n\t\tthis.m_linearJacobian.linear2.y = ay1Y;\r\n\t\tthis.m_linearJacobian.angular1 = -(eX * ay1Y - eY * ay1X);\r\n\t\tthis.m_linearJacobian.angular2 = r2X * ay1Y - r2Y * ay1X;\r\n\r\n\t\tthis.m_linearMass =\tinvMass1 + invI1 * this.m_linearJacobian.angular1 * this.m_linearJacobian.angular1 +\r\n\t\t\t\t\t\tinvMass2 + invI2 * this.m_linearJacobian.angular2 * this.m_linearJacobian.angular2;\r\n\t\t//b2Settings.b2Assert(this.m_linearMass > Number.MIN_VALUE);\r\n\t\tthis.m_linearMass = 1.0 / this.m_linearMass;\r\n\r\n\t\t// Compute angular constraint effective mass.\r\n\t\tthis.m_angularMass = 1.0 / (invI1 + invI2);\r\n\r\n\t\t// Compute motor and limit terms.\r\n\t\tif (this.m_enableLimit || this.m_enableMotor)\r\n\t\t{\r\n\t\t\t// The motor and limit share a Jacobian and effective mass.\r\n\t\t\t//b2Vec2 ax1 = b2Mul(b1->m_R, this.m_localXAxis1);\r\n\t\t\ttMat = b1.m_R;\r\n\t\t\tvar ax1X = tMat.col1.x * this.m_localXAxis1.x + tMat.col2.x * this.m_localXAxis1.y;\r\n\t\t\tvar ax1Y = tMat.col1.y * this.m_localXAxis1.x + tMat.col2.y * this.m_localXAxis1.y;\r\n\t\t\t//this.m_motorJacobian.Set(-ax1, -b2Cross(e, ax1), ax1, b2Cross(r2, ax1));\r\n\t\t\tthis.m_motorJacobian.linear1.x = -ax1X; this.m_motorJacobian.linear1.y = -ax1Y;\r\n\t\t\tthis.m_motorJacobian.linear2.x = ax1X; this.m_motorJacobian.linear2.y = ax1Y;\r\n\t\t\tthis.m_motorJacobian.angular1 = -(eX * ax1Y - eY * ax1X);\r\n\t\t\tthis.m_motorJacobian.angular2 = r2X * ax1Y - r2Y * ax1X;\r\n\r\n\t\t\tthis.m_motorMass =\tinvMass1 + invI1 * this.m_motorJacobian.angular1 * this.m_motorJacobian.angular1 +\r\n\t\t\t\t\t\t\tinvMass2 + invI2 * this.m_motorJacobian.angular2 * this.m_motorJacobian.angular2;\r\n\t\t\t//b2Settings.b2Assert(this.m_motorMass > Number.MIN_VALUE);\r\n\t\t\tthis.m_motorMass = 1.0 / this.m_motorMass;\r\n\r\n\t\t\tif (this.m_enableLimit)\r\n\t\t\t{\r\n\t\t\t\t//b2Vec2 d = e - r1;\r\n\t\t\t\tvar dX = eX - r1X;\r\n\t\t\t\tvar dY = eY - r1Y;\r\n\t\t\t\t//float32 jointTranslation = b2Dot(ax1, d);\r\n\t\t\t\tvar jointTranslation = ax1X * dX + ax1Y * dY;\r\n\t\t\t\tif (b2Math.b2Abs(this.m_upperTranslation - this.m_lowerTranslation) < 2.0 * b2Settings.b2_linearSlop)\r\n\t\t\t\t{\r\n\t\t\t\t\tthis.m_limitState = b2Joint.e_equalLimits;\r\n\t\t\t\t}\r\n\t\t\t\telse if (jointTranslation <= this.m_lowerTranslation)\r\n\t\t\t\t{\r\n\t\t\t\t\tif (this.m_limitState != b2Joint.e_atLowerLimit)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tthis.m_limitImpulse = 0.0;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.m_limitState = b2Joint.e_atLowerLimit;\r\n\t\t\t\t}\r\n\t\t\t\telse if (jointTranslation >= this.m_upperTranslation)\r\n\t\t\t\t{\r\n\t\t\t\t\tif (this.m_limitState != b2Joint.e_atUpperLimit)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tthis.m_limitImpulse = 0.0;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.m_limitState = b2Joint.e_atUpperLimit;\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tthis.m_limitState = b2Joint.e_inactiveLimit;\r\n\t\t\t\t\tthis.m_limitImpulse = 0.0;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (this.m_enableMotor == false)\r\n\t\t{\r\n\t\t\tthis.m_motorImpulse = 0.0;\r\n\t\t}\r\n\r\n\t\tif (this.m_enableLimit == false)\r\n\t\t{\r\n\t\t\tthis.m_limitImpulse = 0.0;\r\n\t\t}\r\n\r\n\t\tif (b2World.s_enableWarmStarting)\r\n\t\t{\r\n\t\t\t//b2Vec2 P1 = this.m_linearImpulse * this.m_linearJacobian.linear1 + (this.m_motorImpulse + this.m_limitImpulse) * this.m_motorJacobian.linear1;\r\n\t\t\tvar P1X = this.m_linearImpulse * this.m_linearJacobian.linear1.x + (this.m_motorImpulse + this.m_limitImpulse) * this.m_motorJacobian.linear1.x;\r\n\t\t\tvar P1Y = this.m_linearImpulse * this.m_linearJacobian.linear1.y + (this.m_motorImpulse + this.m_limitImpulse) * this.m_motorJacobian.linear1.y;\r\n\t\t\t//b2Vec2 P2 = this.m_linearImpulse * this.m_linearJacobian.linear2 + (this.m_motorImpulse + this.m_limitImpulse) * this.m_motorJacobian.linear2;\r\n\t\t\tvar P2X = this.m_linearImpulse * this.m_linearJacobian.linear2.x + (this.m_motorImpulse + this.m_limitImpulse) * this.m_motorJacobian.linear2.x;\r\n\t\t\tvar P2Y = this.m_linearImpulse * this.m_linearJacobian.linear2.y + (this.m_motorImpulse + this.m_limitImpulse) * this.m_motorJacobian.linear2.y;\r\n\t\t\t//float32 L1 = this.m_linearImpulse * this.m_linearJacobian.angular1 - this.m_angularImpulse + (this.m_motorImpulse + this.m_limitImpulse) * this.m_motorJacobian.angular1;\r\n\t\t\tvar L1 = this.m_linearImpulse * this.m_linearJacobian.angular1 - this.m_angularImpulse + (this.m_motorImpulse + this.m_limitImpulse) * this.m_motorJacobian.angular1;\r\n\t\t\t//float32 L2 = this.m_linearImpulse * this.m_linearJacobian.angular2 + this.m_angularImpulse + (this.m_motorImpulse + this.m_limitImpulse) * this.m_motorJacobian.angular2;\r\n\t\t\tvar L2 = this.m_linearImpulse * this.m_linearJacobian.angular2 + this.m_angularImpulse + (this.m_motorImpulse + this.m_limitImpulse) * this.m_motorJacobian.angular2;\r\n\r\n\t\t\t//b1->m_linearVelocity += invMass1 * P1;\r\n\t\t\tb1.m_linearVelocity.x += invMass1 * P1X;\r\n\t\t\tb1.m_linearVelocity.y += invMass1 * P1Y;\r\n\t\t\t//b1->m_angularVelocity += invI1 * L1;\r\n\t\t\tb1.m_angularVelocity += invI1 * L1;\r\n\r\n\t\t\t//b2->m_linearVelocity += invMass2 * P2;\r\n\t\t\tb2.m_linearVelocity.x += invMass2 * P2X;\r\n\t\t\tb2.m_linearVelocity.y += invMass2 * P2Y;\r\n\t\t\t//b2->m_angularVelocity += invI2 * L2;\r\n\t\t\tb2.m_angularVelocity += invI2 * L2;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tthis.m_linearImpulse = 0.0;\r\n\t\t\tthis.m_angularImpulse = 0.0;\r\n\t\t\tthis.m_limitImpulse = 0.0;\r\n\t\t\tthis.m_motorImpulse = 0.0;\r\n\t\t}\r\n\r\n\t\tthis.m_limitPositionImpulse = 0.0;\r\n\r\n\t};\r\n\r\n\tthis.SolveVelocityConstraints = function(step){\r\n\t\tvar b1 = this.m_body1;\r\n\t\tvar b2 = this.m_body2;\r\n\r\n\t\tvar invMass1 = b1.m_invMass;\r\n\t\tvar invMass2 = b2.m_invMass;\r\n\t\tvar invI1 = b1.m_invI;\r\n\t\tvar invI2 = b2.m_invI;\r\n\r\n\t\tvar oldLimitImpulse;\r\n\r\n\t\t// Solve linear constraint.\r\n\t\tvar linearCdot = this.m_linearJacobian.Compute(b1.m_linearVelocity, b1.m_angularVelocity, b2.m_linearVelocity, b2.m_angularVelocity);\r\n\t\tvar linearImpulse = -this.m_linearMass * linearCdot;\r\n\t\tthis.m_linearImpulse += linearImpulse;\r\n\r\n\t\t//b1->m_linearVelocity += (invMass1 * linearImpulse) * this.m_linearJacobian.linear1;\r\n\t\tb1.m_linearVelocity.x += (invMass1 * linearImpulse) * this.m_linearJacobian.linear1.x;\r\n\t\tb1.m_linearVelocity.y += (invMass1 * linearImpulse) * this.m_linearJacobian.linear1.y;\r\n\t\t//b1->m_angularVelocity += invI1 * linearImpulse * this.m_linearJacobian.angular1;\r\n\t\tb1.m_angularVelocity += invI1 * linearImpulse * this.m_linearJacobian.angular1;\r\n\r\n\t\t//b2->m_linearVelocity += (invMass2 * linearImpulse) * this.m_linearJacobian.linear2;\r\n\t\tb2.m_linearVelocity.x += (invMass2 * linearImpulse) * this.m_linearJacobian.linear2.x;\r\n\t\tb2.m_linearVelocity.y += (invMass2 * linearImpulse) * this.m_linearJacobian.linear2.y;\r\n\t\t//b2.m_angularVelocity += invI2 * linearImpulse * this.m_linearJacobian.angular2;\r\n\t\tb2.m_angularVelocity += invI2 * linearImpulse * this.m_linearJacobian.angular2;\r\n\r\n\t\t// Solve angular constraint.\r\n\t\tvar angularCdot = b2.m_angularVelocity - b1.m_angularVelocity;\r\n\t\tvar angularImpulse = -this.m_angularMass * angularCdot;\r\n\t\tthis.m_angularImpulse += angularImpulse;\r\n\r\n\t\tb1.m_angularVelocity -= invI1 * angularImpulse;\r\n\t\tb2.m_angularVelocity += invI2 * angularImpulse;\r\n\r\n\t\t// Solve linear motor constraint.\r\n\t\tif (this.m_enableMotor && this.m_limitState != b2Joint.e_equalLimits)\r\n\t\t{\r\n\t\t\tvar motorCdot = this.m_motorJacobian.Compute(b1.m_linearVelocity, b1.m_angularVelocity, b2.m_linearVelocity, b2.m_angularVelocity) - this.m_motorSpeed;\r\n\t\t\tvar motorImpulse = -this.m_motorMass * motorCdot;\r\n\t\t\tvar oldMotorImpulse = this.m_motorImpulse;\r\n\t\t\tthis.m_motorImpulse = b2Math.b2Clamp(this.m_motorImpulse + motorImpulse, -step.dt * this.m_maxMotorForce, step.dt * this.m_maxMotorForce);\r\n\t\t\tmotorImpulse = this.m_motorImpulse - oldMotorImpulse;\r\n\r\n\t\t\t//b1.m_linearVelocity += (invMass1 * motorImpulse) * this.m_motorJacobian.linear1;\r\n\t\t\tb1.m_linearVelocity.x += (invMass1 * motorImpulse) * this.m_motorJacobian.linear1.x;\r\n\t\t\tb1.m_linearVelocity.y += (invMass1 * motorImpulse) * this.m_motorJacobian.linear1.y;\r\n\t\t\t//b1.m_angularVelocity += invI1 * motorImpulse * this.m_motorJacobian.angular1;\r\n\t\t\tb1.m_angularVelocity += invI1 * motorImpulse * this.m_motorJacobian.angular1;\r\n\r\n\t\t\t//b2->m_linearVelocity += (invMass2 * motorImpulse) * this.m_motorJacobian.linear2;\r\n\t\t\tb2.m_linearVelocity.x += (invMass2 * motorImpulse) * this.m_motorJacobian.linear2.x;\r\n\t\t\tb2.m_linearVelocity.y += (invMass2 * motorImpulse) * this.m_motorJacobian.linear2.y;\r\n\t\t\t//b2->m_angularVelocity += invI2 * motorImpulse * this.m_motorJacobian.angular2;\r\n\t\t\tb2.m_angularVelocity += invI2 * motorImpulse * this.m_motorJacobian.angular2;\r\n\t\t}\r\n\r\n\t\t// Solve linear limit constraint.\r\n\t\tif (this.m_enableLimit && this.m_limitState != b2Joint.e_inactiveLimit)\r\n\t\t{\r\n\t\t\tvar limitCdot = this.m_motorJacobian.Compute(b1.m_linearVelocity, b1.m_angularVelocity, b2.m_linearVelocity, b2.m_angularVelocity);\r\n\t\t\tvar limitImpulse = -this.m_motorMass * limitCdot;\r\n\r\n\t\t\tif (this.m_limitState == b2Joint.e_equalLimits)\r\n\t\t\t{\r\n\t\t\t\tthis.m_limitImpulse += limitImpulse;\r\n\t\t\t}\r\n\t\t\telse if (this.m_limitState == b2Joint.e_atLowerLimit)\r\n\t\t\t{\r\n\t\t\t\toldLimitImpulse = this.m_limitImpulse;\r\n\t\t\t\tthis.m_limitImpulse = b2Math.b2Max(this.m_limitImpulse + limitImpulse, 0.0);\r\n\t\t\t\tlimitImpulse = this.m_limitImpulse - oldLimitImpulse;\r\n\t\t\t}\r\n\t\t\telse if (this.m_limitState == b2Joint.e_atUpperLimit)\r\n\t\t\t{\r\n\t\t\t\toldLimitImpulse = this.m_limitImpulse;\r\n\t\t\t\tthis.m_limitImpulse = b2Math.b2Min(this.m_limitImpulse + limitImpulse, 0.0);\r\n\t\t\t\tlimitImpulse = this.m_limitImpulse - oldLimitImpulse;\r\n\t\t\t}\r\n\r\n\t\t\t//b1->m_linearVelocity += (invMass1 * limitImpulse) * this.m_motorJacobian.linear1;\r\n\t\t\tb1.m_linearVelocity.x += (invMass1 * limitImpulse) * this.m_motorJacobian.linear1.x;\r\n\t\t\tb1.m_linearVelocity.y += (invMass1 * limitImpulse) * this.m_motorJacobian.linear1.y;\r\n\t\t\t//b1->m_angularVelocity += invI1 * limitImpulse * this.m_motorJacobian.angular1;\r\n\t\t\tb1.m_angularVelocity += invI1 * limitImpulse * this.m_motorJacobian.angular1;\r\n\r\n\t\t\t//b2->m_linearVelocity += (invMass2 * limitImpulse) * this.m_motorJacobian.linear2;\r\n\t\t\tb2.m_linearVelocity.x += (invMass2 * limitImpulse) * this.m_motorJacobian.linear2.x;\r\n\t\t\tb2.m_linearVelocity.y += (invMass2 * limitImpulse) * this.m_motorJacobian.linear2.y;\r\n\t\t\t//b2->m_angularVelocity += invI2 * limitImpulse * this.m_motorJacobian.angular2;\r\n\t\t\tb2.m_angularVelocity += invI2 * limitImpulse * this.m_motorJacobian.angular2;\r\n\t\t}\r\n\t};\r\n\r\n\tthis.SolvePositionConstraints = function(){\r\n\r\n\t\tvar limitC;\r\n\t\tvar oldLimitImpulse;\r\n\r\n\t\tvar b1 = this.m_body1;\r\n\t\tvar b2 = this.m_body2;\r\n\r\n\t\tvar invMass1 = b1.m_invMass;\r\n\t\tvar invMass2 = b2.m_invMass;\r\n\t\tvar invI1 = b1.m_invI;\r\n\t\tvar invI2 = b2.m_invI;\r\n\r\n\t\tvar tMat;\r\n\r\n\t\t//b2Vec2 r1 = b2Mul(b1->m_R, this.m_localAnchor1);\r\n\t\ttMat = b1.m_R;\r\n\t\tvar r1X = tMat.col1.x * this.m_localAnchor1.x + tMat.col2.x * this.m_localAnchor1.y;\r\n\t\tvar r1Y = tMat.col1.y * this.m_localAnchor1.x + tMat.col2.y * this.m_localAnchor1.y;\r\n\t\t//b2Vec2 r2 = b2Mul(b2->m_R, this.m_localAnchor2);\r\n\t\ttMat = b2.m_R;\r\n\t\tvar r2X = tMat.col1.x * this.m_localAnchor2.x + tMat.col2.x * this.m_localAnchor2.y;\r\n\t\tvar r2Y = tMat.col1.y * this.m_localAnchor2.x + tMat.col2.y * this.m_localAnchor2.y;\r\n\t\t//b2Vec2 p1 = b1->m_position + r1;\r\n\t\tvar p1X = b1.m_position.x + r1X;\r\n\t\tvar p1Y = b1.m_position.y + r1Y;\r\n\t\t//b2Vec2 p2 = b2->m_position + r2;\r\n\t\tvar p2X = b2.m_position.x + r2X;\r\n\t\tvar p2Y = b2.m_position.y + r2Y;\r\n\t\t//b2Vec2 d = p2 - p1;\r\n\t\tvar dX = p2X - p1X;\r\n\t\tvar dY = p2Y - p1Y;\r\n\t\t//b2Vec2 ay1 = b2Mul(b1->m_R, this.m_localYAxis1);\r\n\t\ttMat = b1.m_R;\r\n\t\tvar ay1X = tMat.col1.x * this.m_localYAxis1.x + tMat.col2.x * this.m_localYAxis1.y;\r\n\t\tvar ay1Y = tMat.col1.y * this.m_localYAxis1.x + tMat.col2.y * this.m_localYAxis1.y;\r\n\r\n\t\t// Solve linear (point-to-line) constraint.\r\n\t\t//float32 linearC = b2Dot(ay1, d);\r\n\t\tvar linearC = ay1X*dX + ay1Y*dY;\r\n\t\t// Prevent overly large corrections.\r\n\t\tlinearC = b2Math.b2Clamp(linearC, -b2Settings.b2_maxLinearCorrection, b2Settings.b2_maxLinearCorrection);\r\n\t\tvar linearImpulse = -this.m_linearMass * linearC;\r\n\r\n\t\t//b1->m_position += (invMass1 * linearImpulse) * this.m_linearJacobian.linear1;\r\n\t\tb1.m_position.x += (invMass1 * linearImpulse) * this.m_linearJacobian.linear1.x;\r\n\t\tb1.m_position.y += (invMass1 * linearImpulse) * this.m_linearJacobian.linear1.y;\r\n\t\t//b1->m_rotation += invI1 * linearImpulse * this.m_linearJacobian.angular1;\r\n\t\tb1.m_rotation += invI1 * linearImpulse * this.m_linearJacobian.angular1;\r\n\t\t//b1->m_R.Set(b1->m_rotation);\r\n\t\t//b2->m_position += (invMass2 * linearImpulse) * this.m_linearJacobian.linear2;\r\n\t\tb2.m_position.x += (invMass2 * linearImpulse) * this.m_linearJacobian.linear2.x;\r\n\t\tb2.m_position.y += (invMass2 * linearImpulse) * this.m_linearJacobian.linear2.y;\r\n\t\tb2.m_rotation += invI2 * linearImpulse * this.m_linearJacobian.angular2;\r\n\t\t//b2->m_R.Set(b2->m_rotation);\r\n\r\n\t\tvar positionError = b2Math.b2Abs(linearC);\r\n\r\n\t\t// Solve angular constraint.\r\n\t\tvar angularC = b2.m_rotation - b1.m_rotation - this.m_initialAngle;\r\n\t\t// Prevent overly large corrections.\r\n\t\tangularC = b2Math.b2Clamp(angularC, -b2Settings.b2_maxAngularCorrection, b2Settings.b2_maxAngularCorrection);\r\n\t\tvar angularImpulse = -this.m_angularMass * angularC;\r\n\r\n\t\tb1.m_rotation -= b1.m_invI * angularImpulse;\r\n\t\tb1.m_R.Set(b1.m_rotation);\r\n\t\tb2.m_rotation += b2.m_invI * angularImpulse;\r\n\t\tb2.m_R.Set(b2.m_rotation);\r\n\r\n\t\tvar angularError = b2Math.b2Abs(angularC);\r\n\r\n\t\t// Solve linear limit constraint.\r\n\t\tif (this.m_enableLimit && this.m_limitState != b2Joint.e_inactiveLimit)\r\n\t\t{\r\n\r\n\t\t\t//b2Vec2 r1 = b2Mul(b1->m_R, this.m_localAnchor1);\r\n\t\t\ttMat = b1.m_R;\r\n\t\t\tr1X = tMat.col1.x * this.m_localAnchor1.x + tMat.col2.x * this.m_localAnchor1.y;\r\n\t\t\tr1Y = tMat.col1.y * this.m_localAnchor1.x + tMat.col2.y * this.m_localAnchor1.y;\r\n\t\t\t//b2Vec2 r2 = b2Mul(b2->m_R, this.m_localAnchor2);\r\n\t\t\ttMat = b2.m_R;\r\n\t\t\tr2X = tMat.col1.x * this.m_localAnchor2.x + tMat.col2.x * this.m_localAnchor2.y;\r\n\t\t\tr2Y = tMat.col1.y * this.m_localAnchor2.x + tMat.col2.y * this.m_localAnchor2.y;\r\n\t\t\t//b2Vec2 p1 = b1->m_position + r1;\r\n\t\t\tp1X = b1.m_position.x + r1X;\r\n\t\t\tp1Y = b1.m_position.y + r1Y;\r\n\t\t\t//b2Vec2 p2 = b2->m_position + r2;\r\n\t\t\tp2X = b2.m_position.x + r2X;\r\n\t\t\tp2Y = b2.m_position.y + r2Y;\r\n\t\t\t//b2Vec2 d = p2 - p1;\r\n\t\t\tdX = p2X - p1X;\r\n\t\t\tdY = p2Y - p1Y;\r\n\t\t\t//b2Vec2 ax1 = b2Mul(b1->m_R, this.m_localXAxis1);\r\n\t\t\ttMat = b1.m_R;\r\n\t\t\tvar ax1X = tMat.col1.x * this.m_localXAxis1.x + tMat.col2.x * this.m_localXAxis1.y;\r\n\t\t\tvar ax1Y = tMat.col1.y * this.m_localXAxis1.x + tMat.col2.y * this.m_localXAxis1.y;\r\n\r\n\t\t\t//float32 translation = b2Dot(ax1, d);\r\n\t\t\tvar translation = (ax1X*dX + ax1Y*dY);\r\n\t\t\tvar limitImpulse = 0.0;\r\n\r\n\t\t\tif (this.m_limitState == b2Joint.e_equalLimits)\r\n\t\t\t{\r\n\t\t\t\t// Prevent large angular corrections\r\n\t\t\t\tlimitC = b2Math.b2Clamp(translation, -b2Settings.b2_maxLinearCorrection, b2Settings.b2_maxLinearCorrection);\r\n\t\t\t\tlimitImpulse = -this.m_motorMass * limitC;\r\n\t\t\t\tpositionError = b2Math.b2Max(positionError, b2Math.b2Abs(angularC));\r\n\t\t\t}\r\n\t\t\telse if (this.m_limitState == b2Joint.e_atLowerLimit)\r\n\t\t\t{\r\n\t\t\t\tlimitC = translation - this.m_lowerTranslation;\r\n\t\t\t\tpositionError = b2Math.b2Max(positionError, -limitC);\r\n\r\n\t\t\t\t// Prevent large linear corrections and allow some slop.\r\n\t\t\t\tlimitC = b2Math.b2Clamp(limitC + b2Settings.b2_linearSlop, -b2Settings.b2_maxLinearCorrection, 0.0);\r\n\t\t\t\tlimitImpulse = -this.m_motorMass * limitC;\r\n\t\t\t\toldLimitImpulse = this.m_limitPositionImpulse;\r\n\t\t\t\tthis.m_limitPositionImpulse = b2Math.b2Max(this.m_limitPositionImpulse + limitImpulse, 0.0);\r\n\t\t\t\tlimitImpulse = this.m_limitPositionImpulse - oldLimitImpulse;\r\n\t\t\t}\r\n\t\t\telse if (this.m_limitState == b2Joint.e_atUpperLimit)\r\n\t\t\t{\r\n\t\t\t\tlimitC = translation - this.m_upperTranslation;\r\n\t\t\t\tpositionError = b2Math.b2Max(positionError, limitC);\r\n\r\n\t\t\t\t// Prevent large linear corrections and allow some slop.\r\n\t\t\t\tlimitC = b2Math.b2Clamp(limitC - b2Settings.b2_linearSlop, 0.0, b2Settings.b2_maxLinearCorrection);\r\n\t\t\t\tlimitImpulse = -this.m_motorMass * limitC;\r\n\t\t\t\toldLimitImpulse = this.m_limitPositionImpulse;\r\n\t\t\t\tthis.m_limitPositionImpulse = b2Math.b2Min(this.m_limitPositionImpulse + limitImpulse, 0.0);\r\n\t\t\t\tlimitImpulse = this.m_limitPositionImpulse - oldLimitImpulse;\r\n\t\t\t}\r\n\r\n\t\t\t//b1->m_position += (invMass1 * limitImpulse) * this.m_motorJacobian.linear1;\r\n\t\t\tb1.m_position.x += (invMass1 * limitImpulse) * this.m_motorJacobian.linear1.x;\r\n\t\t\tb1.m_position.y += (invMass1 * limitImpulse) * this.m_motorJacobian.linear1.y;\r\n\t\t\t//b1->m_rotation += invI1 * limitImpulse * this.m_motorJacobian.angular1;\r\n\t\t\tb1.m_rotation += invI1 * limitImpulse * this.m_motorJacobian.angular1;\r\n\t\t\tb1.m_R.Set(b1.m_rotation);\r\n\t\t\t//b2->m_position += (invMass2 * limitImpulse) * this.m_motorJacobian.linear2;\r\n\t\t\tb2.m_position.x += (invMass2 * limitImpulse) * this.m_motorJacobian.linear2.x;\r\n\t\t\tb2.m_position.y += (invMass2 * limitImpulse) * this.m_motorJacobian.linear2.y;\r\n\t\t\t//b2->m_rotation += invI2 * limitImpulse * this.m_motorJacobian.angular2;\r\n\t\t\tb2.m_rotation += invI2 * limitImpulse * this.m_motorJacobian.angular2;\r\n\t\t\tb2.m_R.Set(b2.m_rotation);\r\n\t\t}\r\n\r\n\t\treturn positionError <= b2Settings.b2_linearSlop && angularError <= b2Settings.b2_angularSlop;\r\n\r\n\t};\r\n});\r\n\r\n","pre":true},"./src/box2d/dynamics/joints/b2PulleyJoint.js":{"path":"./src/box2d/dynamics/joints/b2PulleyJoint.js","friendlyPath":".b2PulleyJoint","directory":"./src/box2d/dynamics/joints/","filename":"b2PulleyJoint.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\njsio(\"import ...common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import ...common.b2Settings as b2Settings\");\r\njsio(\"import .b2Joint as b2Joint\");\r\njsio(\"import .b2JointNode as b2JointNode\");\r\n\r\nb2PulleyJoint=__class__;var b2PulleyJoint=b2PulleyJoint(function b2PulleyJoint(){return this.init&&this.init.apply(this,arguments)},b2Joint, function(supr) {\r\n\tthis.GetAnchor1 = function(){\r\n\t\t//return this.m_body1->m_position + b2Mul(this.m_body1->m_R, this.m_localAnchor1);\r\n\t\tvar tMat = this.m_body1.m_R;\r\n\t\treturn new b2Vec2(\tthis.m_body1.m_position.x + (tMat.col1.x * this.m_localAnchor1.x + tMat.col2.x * this.m_localAnchor1.y),\r\n\t\t\t\t\t\t\tthis.m_body1.m_position.y + (tMat.col1.y * this.m_localAnchor1.x + tMat.col2.y * this.m_localAnchor1.y));\r\n\t};\r\n\tthis.GetAnchor2 = function(){\r\n\t\t//return this.m_body2->m_position + b2Mul(this.m_body2->m_R, this.m_localAnchor2);\r\n\t\tvar tMat = this.m_body2.m_R;\r\n\t\treturn new b2Vec2(\tthis.m_body2.m_position.x + (tMat.col1.x * this.m_localAnchor2.x + tMat.col2.x * this.m_localAnchor2.y),\r\n\t\t\t\t\t\t\tthis.m_body2.m_position.y + (tMat.col1.y * this.m_localAnchor2.x + tMat.col2.y * this.m_localAnchor2.y));\r\n\t};\r\n\r\n\tthis.GetGroundPoint1 = function(){\r\n\t\t//return this.m_ground->m_position + this.m_groundAnchor1;\r\n\t\treturn new b2Vec2(this.m_ground.m_position.x + this.m_groundAnchor1.x, this.m_ground.m_position.y + this.m_groundAnchor1.y);\r\n\t};\r\n\tthis.GetGroundPoint2 = function(){\r\n\t\treturn new b2Vec2(this.m_ground.m_position.x + this.m_groundAnchor2.x, this.m_ground.m_position.y + this.m_groundAnchor2.y);\r\n\t};\r\n\r\n\tthis.GetReactionForce = function(invTimeStep){\r\n\t\t//b2Vec2 F(0.0f, 0.0f);\r\n\t\treturn new b2Vec2();\r\n\t};\r\n\tthis.GetReactionTorque = function(invTimeStep){\r\n\t\treturn 0.0;\r\n\t};\r\n\r\n\tthis.GetLength1 = function(){\r\n\t\tvar tMat;\r\n\t\t//b2Vec2 p = this.m_body1->m_position + b2Mul(this.m_body1->m_R, this.m_localAnchor1);\r\n\t\ttMat = this.m_body1.m_R;\r\n\t\tvar pX = this.m_body1.m_position.x + (tMat.col1.x * this.m_localAnchor1.x + tMat.col2.x * this.m_localAnchor1.y);\r\n\t\tvar pY = this.m_body1.m_position.y + (tMat.col1.y * this.m_localAnchor1.x + tMat.col2.y * this.m_localAnchor1.y);\r\n\t\t//b2Vec2 s = this.m_ground->m_position + this.m_groundAnchor1;\r\n\t\t//b2Vec2 d = p - s;\r\n\t\tvar dX = pX - (this.m_ground.m_position.x + this.m_groundAnchor1.x);\r\n\t\tvar dY = pY - (this.m_ground.m_position.y + this.m_groundAnchor1.y);\r\n\t\treturn Math.sqrt(dX*dX + dY*dY);\r\n\t};\r\n\tthis.GetLength2 = function(){\r\n\t\tvar tMat;\r\n\t\t//b2Vec2 p = this.m_body2->m_position + b2Mul(this.m_body2->m_R, this.m_localAnchor2);\r\n\t\ttMat = this.m_body2.m_R;\r\n\t\tvar pX = this.m_body2.m_position.x + (tMat.col1.x * this.m_localAnchor2.x + tMat.col2.x * this.m_localAnchor2.y);\r\n\t\tvar pY = this.m_body2.m_position.y + (tMat.col1.y * this.m_localAnchor2.x + tMat.col2.y * this.m_localAnchor2.y);\r\n\t\t//b2Vec2 s = this.m_ground->m_position + this.m_groundAnchor2;\r\n\t\t//b2Vec2 d = p - s;\r\n\t\tvar dX = pX - (this.m_ground.m_position.x + this.m_groundAnchor2.x);\r\n\t\tvar dY = pY - (this.m_ground.m_position.y + this.m_groundAnchor2.y);\r\n\t\treturn Math.sqrt(dX*dX + dY*dY);\r\n\t};\r\n\r\n\tthis.GetRatio = function(){\r\n\t\treturn this.m_ratio;\r\n\t};\r\n\r\n\t//--------------- Internals Below -------------------\r\n\r\n\tthis.init = function(def){\r\n\t\tsupr(this, 'init', [def]);\r\n\t\tthis.m_pulleyMass = null;\r\n\t\tthis.m_limitMass1 = null;\r\n\t\tthis.m_limitMass2 = null;\r\n\t\t// Position impulses for accumulation.\r\n\t\tthis.m_limitPositionImpulse1 = null;\r\n\t\tthis.m_limitPositionImpulse2 = null;\r\n\r\n\t\tthis.m_limitState1 = 0;\r\n\t\tthis.m_limitState2 = 0;\r\n\r\n\t\t// The constructor for b2Joint\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_node1 = new b2JointNode();\r\n\t\tthis.m_node2 = new b2JointNode();\r\n\t\t//\r\n\t\tthis.m_type = def.type;\r\n\t\tthis.m_prev = null;\r\n\t\tthis.m_next = null;\r\n\t\tthis.m_body1 = def.body1;\r\n\t\tthis.m_body2 = def.body2;\r\n\t\tthis.m_collideConnected = def.collideConnected;\r\n\t\tthis.m_islandFlag = false;\r\n\t\tthis.m_userData = def.userData;\r\n\t\t//\r\n\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_groundAnchor1 = new b2Vec2();\r\n\t\tthis.m_groundAnchor2 = new b2Vec2();\r\n\t\tthis.m_localAnchor1 = new b2Vec2();\r\n\t\tthis.m_localAnchor2 = new b2Vec2();\r\n\t\tthis.m_u1 = new b2Vec2();\r\n\t\tthis.m_u2 = new b2Vec2();\r\n\t\t//\r\n\r\n\r\n\t\t// parent\r\n\t\t//super(def);\r\n\r\n\t\tvar tMat;\r\n\t\tvar tX;\r\n\t\tvar tY;\r\n\r\n\t\tthis.m_ground = this.m_body1.m_world.m_groundBody;\r\n\t\t//this.m_groundAnchor1 = def.groundPoint1 - this.m_ground.m_position;\r\n\t\tthis.m_groundAnchor1.x = def.groundPoint1.x - this.m_ground.m_position.x;\r\n\t\tthis.m_groundAnchor1.y = def.groundPoint1.y - this.m_ground.m_position.y;\r\n\t\t//this.m_groundAnchor2 = def.groundPoint2 - this.m_ground.m_position;\r\n\t\tthis.m_groundAnchor2.x = def.groundPoint2.x - this.m_ground.m_position.x;\r\n\t\tthis.m_groundAnchor2.y = def.groundPoint2.y - this.m_ground.m_position.y;\r\n\t\t//this.m_localAnchor1 = b2MulT(this.m_body1.m_R, def.anchorPoint1 - this.m_body1.m_position);\r\n\t\ttMat = this.m_body1.m_R;\r\n\t\ttX = def.anchorPoint1.x - this.m_body1.m_position.x;\r\n\t\ttY = def.anchorPoint1.y - this.m_body1.m_position.y;\r\n\t\tthis.m_localAnchor1.x = tX*tMat.col1.x + tY*tMat.col1.y;\r\n\t\tthis.m_localAnchor1.y = tX*tMat.col2.x + tY*tMat.col2.y;\r\n\t\t//this.m_localAnchor2 = b2MulT(this.m_body2.m_R, def.anchorPoint2 - this.m_body2.m_position);\r\n\t\ttMat = this.m_body2.m_R;\r\n\t\ttX = def.anchorPoint2.x - this.m_body2.m_position.x;\r\n\t\ttY = def.anchorPoint2.y - this.m_body2.m_position.y;\r\n\t\tthis.m_localAnchor2.x = tX*tMat.col1.x + tY*tMat.col1.y;\r\n\t\tthis.m_localAnchor2.y = tX*tMat.col2.x + tY*tMat.col2.y;\r\n\r\n\t\tthis.m_ratio = def.ratio;\r\n\r\n\t\t//var d1 = def.groundPoint1 - def.anchorPoint1;\r\n\t\ttX = def.groundPoint1.x - def.anchorPoint1.x;\r\n\t\ttY = def.groundPoint1.y - def.anchorPoint1.y;\r\n\t\tvar d1Len = Math.sqrt(tX*tX + tY*tY);\r\n\t\t//var d2 = def.groundPoint2 - def.anchorPoint2;\r\n\t\ttX = def.groundPoint2.x - def.anchorPoint2.x;\r\n\t\ttY = def.groundPoint2.y - def.anchorPoint2.y;\r\n\t\tvar d2Len = Math.sqrt(tX*tX + tY*tY);\r\n\r\n\t\tvar length1 = b2Math.b2Max(0.5 * b2PulleyJoint.b2_minPulleyLength, d1Len);\r\n\t\tvar length2 = b2Math.b2Max(0.5 * b2PulleyJoint.b2_minPulleyLength, d2Len);\r\n\r\n\t\tthis.m_constant = length1 + this.m_ratio * length2;\r\n\r\n\t\tthis.m_maxLength1 = b2Math.b2Clamp(def.maxLength1, length1, this.m_constant - this.m_ratio * b2PulleyJoint.b2_minPulleyLength);\r\n\t\tthis.m_maxLength2 = b2Math.b2Clamp(def.maxLength2, length2, (this.m_constant - b2PulleyJoint.b2_minPulleyLength) / this.m_ratio);\r\n\r\n\t\tthis.m_pulleyImpulse = 0.0;\r\n\t\tthis.m_limitImpulse1 = 0.0;\r\n\t\tthis.m_limitImpulse2 = 0.0;\r\n\r\n\t};\r\n\r\n\tthis.PrepareVelocitySolver = function(){\r\n\t\tvar b1 = this.m_body1;\r\n\t\tvar b2 = this.m_body2;\r\n\r\n\t\tvar tMat;\r\n\r\n\t\t//b2Vec2 r1 = b2Mul(b1->m_R, this.m_localAnchor1);\r\n\t\ttMat = b1.m_R;\r\n\t\tvar r1X = tMat.col1.x * this.m_localAnchor1.x + tMat.col2.x * this.m_localAnchor1.y;\r\n\t\tvar r1Y = tMat.col1.y * this.m_localAnchor1.x + tMat.col2.y * this.m_localAnchor1.y;\r\n\t\t//b2Vec2 r2 = b2Mul(b2->m_R, this.m_localAnchor2);\r\n\t\ttMat = b2.m_R;\r\n\t\tvar r2X = tMat.col1.x * this.m_localAnchor2.x + tMat.col2.x * this.m_localAnchor2.y;\r\n\t\tvar r2Y = tMat.col1.y * this.m_localAnchor2.x + tMat.col2.y * this.m_localAnchor2.y;\r\n\r\n\t\t//b2Vec2 p1 = b1->m_position + r1;\r\n\t\tvar p1X = b1.m_position.x + r1X;\r\n\t\tvar p1Y = b1.m_position.y + r1Y;\r\n\t\t//b2Vec2 p2 = b2->m_position + r2;\r\n\t\tvar p2X = b2.m_position.x + r2X;\r\n\t\tvar p2Y = b2.m_position.y + r2Y;\r\n\r\n\t\t//b2Vec2 s1 = this.m_ground->m_position + this.m_groundAnchor1;\r\n\t\tvar s1X = this.m_ground.m_position.x + this.m_groundAnchor1.x;\r\n\t\tvar s1Y = this.m_ground.m_position.y + this.m_groundAnchor1.y;\r\n\t\t//b2Vec2 s2 = this.m_ground->m_position + this.m_groundAnchor2;\r\n\t\tvar s2X = this.m_ground.m_position.x + this.m_groundAnchor2.x;\r\n\t\tvar s2Y = this.m_ground.m_position.y + this.m_groundAnchor2.y;\r\n\r\n\t\t// Get the pulley axes.\r\n\t\t//this.m_u1 = p1 - s1;\r\n\t\tthis.m_u1.Set(p1X - s1X, p1Y - s1Y);\r\n\t\t//this.m_u2 = p2 - s2;\r\n\t\tthis.m_u2.Set(p2X - s2X, p2Y - s2Y);\r\n\r\n\t\tvar length1 = this.m_u1.Length();\r\n\t\tvar length2 = this.m_u2.Length();\r\n\r\n\t\tif (length1 > b2Settings.b2_linearSlop)\r\n\t\t{\r\n\t\t\t//this.m_u1 *= 1.0f / length1;\r\n\t\t\tthis.m_u1.Multiply(1.0 / length1);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tthis.m_u1.SetZero();\r\n\t\t}\r\n\r\n\t\tif (length2 > b2Settings.b2_linearSlop)\r\n\t\t{\r\n\t\t\t//this.m_u2 *= 1.0f / length2;\r\n\t\t\tthis.m_u2.Multiply(1.0 / length2);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tthis.m_u2.SetZero();\r\n\t\t}\r\n\r\n\t\tif (length1 < this.m_maxLength1)\r\n\t\t{\r\n\t\t\tthis.m_limitState1 = b2Joint.e_inactiveLimit;\r\n\t\t\tthis.m_limitImpulse1 = 0.0;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tthis.m_limitState1 = b2Joint.e_atUpperLimit;\r\n\t\t\tthis.m_limitPositionImpulse1 = 0.0;\r\n\t\t}\r\n\r\n\t\tif (length2 < this.m_maxLength2)\r\n\t\t{\r\n\t\t\tthis.m_limitState2 = b2Joint.e_inactiveLimit;\r\n\t\t\tthis.m_limitImpulse2 = 0.0;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tthis.m_limitState2 = b2Joint.e_atUpperLimit;\r\n\t\t\tthis.m_limitPositionImpulse2 = 0.0;\r\n\t\t}\r\n\r\n\t\t// Compute effective mass.\r\n\t\t//var cr1u1 = b2Cross(r1, this.m_u1);\r\n\t\tvar cr1u1 = r1X * this.m_u1.y - r1Y * this.m_u1.x;\r\n\t\t//var cr2u2 = b2Cross(r2, this.m_u2);\r\n\t\tvar cr2u2 = r2X * this.m_u2.y - r2Y * this.m_u2.x;\r\n\r\n\t\tthis.m_limitMass1 = b1.m_invMass + b1.m_invI * cr1u1 * cr1u1;\r\n\t\tthis.m_limitMass2 = b2.m_invMass + b2.m_invI * cr2u2 * cr2u2;\r\n\t\tthis.m_pulleyMass = this.m_limitMass1 + this.m_ratio * this.m_ratio * this.m_limitMass2;\r\n\t\t//b2Settings.b2Assert(this.m_limitMass1 > Number.MIN_VALUE);\r\n\t\t//b2Settings.b2Assert(this.m_limitMass2 > Number.MIN_VALUE);\r\n\t\t//b2Settings.b2Assert(this.m_pulleyMass > Number.MIN_VALUE);\r\n\t\tthis.m_limitMass1 = 1.0 / this.m_limitMass1;\r\n\t\tthis.m_limitMass2 = 1.0 / this.m_limitMass2;\r\n\t\tthis.m_pulleyMass = 1.0 / this.m_pulleyMass;\r\n\r\n\t\t// Warm starting.\r\n\t\t//b2Vec2 P1 = (-this.m_pulleyImpulse - this.m_limitImpulse1) * this.m_u1;\r\n\t\tvar P1X = (-this.m_pulleyImpulse - this.m_limitImpulse1) * this.m_u1.x;\r\n\t\tvar P1Y = (-this.m_pulleyImpulse - this.m_limitImpulse1) * this.m_u1.y;\r\n\t\t//b2Vec2 P2 = (-this.m_ratio * this.m_pulleyImpulse - this.m_limitImpulse2) * this.m_u2;\r\n\t\tvar P2X = (-this.m_ratio * this.m_pulleyImpulse - this.m_limitImpulse2) * this.m_u2.x;\r\n\t\tvar P2Y = (-this.m_ratio * this.m_pulleyImpulse - this.m_limitImpulse2) * this.m_u2.y;\r\n\t\t//b1.m_linearVelocity += b1.m_invMass * P1;\r\n\t\tb1.m_linearVelocity.x += b1.m_invMass * P1X;\r\n\t\tb1.m_linearVelocity.y += b1.m_invMass * P1Y;\r\n\t\t//b1.m_angularVelocity += b1.m_invI * b2Cross(r1, P1);\r\n\t\tb1.m_angularVelocity += b1.m_invI * (r1X * P1Y - r1Y * P1X);\r\n\t\t//b2.m_linearVelocity += b2.m_invMass * P2;\r\n\t\tb2.m_linearVelocity.x += b2.m_invMass * P2X;\r\n\t\tb2.m_linearVelocity.y += b2.m_invMass * P2Y;\r\n\t\t//b2.m_angularVelocity += b2.m_invI * b2Cross(r2, P2);\r\n\t\tb2.m_angularVelocity += b2.m_invI * (r2X * P2Y - r2Y * P2X);\r\n\t};\r\n\r\n\tthis.SolveVelocityConstraints = function(step){\r\n\t\tvar b1 = this.m_body1;\r\n\t\tvar b2 = this.m_body2;\r\n\r\n\t\tvar tMat;\r\n\r\n\t\t//var r1 = b2Mul(b1.m_R, this.m_localAnchor1);\r\n\t\ttMat = b1.m_R;\r\n\t\tvar r1X = tMat.col1.x * this.m_localAnchor1.x + tMat.col2.x * this.m_localAnchor1.y;\r\n\t\tvar r1Y = tMat.col1.y * this.m_localAnchor1.x + tMat.col2.y * this.m_localAnchor1.y;\r\n\t\t//var r2 = b2Mul(b2.m_R, this.m_localAnchor2);\r\n\t\ttMat = b2.m_R;\r\n\t\tvar r2X = tMat.col1.x * this.m_localAnchor2.x + tMat.col2.x * this.m_localAnchor2.y;\r\n\t\tvar r2Y = tMat.col1.y * this.m_localAnchor2.x + tMat.col2.y * this.m_localAnchor2.y;\r\n\r\n\t\t// temp vars\r\n\t\tvar v1X;\r\n\t\tvar v1Y;\r\n\t\tvar v2X;\r\n\t\tvar v2Y;\r\n\t\tvar P1X;\r\n\t\tvar P1Y;\r\n\t\tvar P2X;\r\n\t\tvar P2Y;\r\n\t\tvar Cdot;\r\n\t\tvar impulse;\r\n\t\tvar oldLimitImpulse;\r\n\r\n\t\t//{\r\n\t\t\t//b2Vec2 v1 = b1->m_linearVelocity + b2Cross(b1->m_angularVelocity, r1);\r\n\t\t\tv1X = b1.m_linearVelocity.x + (-b1.m_angularVelocity * r1Y);\r\n\t\t\tv1Y = b1.m_linearVelocity.y + (b1.m_angularVelocity * r1X);\r\n\t\t\t//b2Vec2 v2 = b2->m_linearVelocity + b2Cross(b2->m_angularVelocity, r2);\r\n\t\t\tv2X = b2.m_linearVelocity.x + (-b2.m_angularVelocity * r2Y);\r\n\t\t\tv2Y = b2.m_linearVelocity.y + (b2.m_angularVelocity * r2X);\r\n\r\n\t\t\t//Cdot = -b2Dot(this.m_u1, v1) - this.m_ratio * b2Dot(this.m_u2, v2);\r\n\t\t\tCdot = -(this.m_u1.x * v1X + this.m_u1.y * v1Y) - this.m_ratio * (this.m_u2.x * v2X + this.m_u2.y * v2Y);\r\n\t\t\timpulse = -this.m_pulleyMass * Cdot;\r\n\t\t\tthis.m_pulleyImpulse += impulse;\r\n\r\n\t\t\t//b2Vec2 P1 = -impulse * this.m_u1;\r\n\t\t\tP1X = -impulse * this.m_u1.x;\r\n\t\t\tP1Y = -impulse * this.m_u1.y;\r\n\t\t\t//b2Vec2 P2 = -this.m_ratio * impulse * this.m_u2;\r\n\t\t\tP2X = -this.m_ratio * impulse * this.m_u2.x;\r\n\t\t\tP2Y = -this.m_ratio * impulse * this.m_u2.y;\r\n\t\t\t//b1.m_linearVelocity += b1.m_invMass * P1;\r\n\t\t\tb1.m_linearVelocity.x += b1.m_invMass * P1X;\r\n\t\t\tb1.m_linearVelocity.y += b1.m_invMass * P1Y;\r\n\t\t\t//b1.m_angularVelocity += b1.m_invI * b2Cross(r1, P1);\r\n\t\t\tb1.m_angularVelocity += b1.m_invI * (r1X * P1Y - r1Y * P1X);\r\n\t\t\t//b2.m_linearVelocity += b2.m_invMass * P2;\r\n\t\t\tb2.m_linearVelocity.x += b2.m_invMass * P2X;\r\n\t\t\tb2.m_linearVelocity.y += b2.m_invMass * P2Y;\r\n\t\t\t//b2.m_angularVelocity += b2.m_invI * b2Cross(r2, P2);\r\n\t\t\tb2.m_angularVelocity += b2.m_invI * (r2X * P2Y - r2Y * P2X);\r\n\t\t//}\r\n\r\n\t\tif (this.m_limitState1 == b2Joint.e_atUpperLimit)\r\n\t\t{\r\n\t\t\t//b2Vec2 v1 = b1->m_linearVelocity + b2Cross(b1->m_angularVelocity, r1);\r\n\t\t\tv1X = b1.m_linearVelocity.x + (-b1.m_angularVelocity * r1Y);\r\n\t\t\tv1Y = b1.m_linearVelocity.y + (b1.m_angularVelocity * r1X);\r\n\r\n\t\t\t//float32 Cdot = -b2Dot(this.m_u1, v1);\r\n\t\t\tCdot = -(this.m_u1.x * v1X + this.m_u1.y * v1Y);\r\n\t\t\timpulse = -this.m_limitMass1 * Cdot;\r\n\t\t\toldLimitImpulse = this.m_limitImpulse1;\r\n\t\t\tthis.m_limitImpulse1 = b2Math.b2Max(0.0, this.m_limitImpulse1 + impulse);\r\n\t\t\timpulse = this.m_limitImpulse1 - oldLimitImpulse;\r\n\t\t\t//b2Vec2 P1 = -impulse * this.m_u1;\r\n\t\t\tP1X = -impulse * this.m_u1.x;\r\n\t\t\tP1Y = -impulse * this.m_u1.y;\r\n\t\t\t//b1.m_linearVelocity += b1->m_invMass * P1;\r\n\t\t\tb1.m_linearVelocity.x += b1.m_invMass * P1X;\r\n\t\t\tb1.m_linearVelocity.y += b1.m_invMass * P1Y;\r\n\t\t\t//b1.m_angularVelocity += b1->m_invI * b2Cross(r1, P1);\r\n\t\t\tb1.m_angularVelocity += b1.m_invI * (r1X * P1Y - r1Y * P1X);\r\n\t\t}\r\n\r\n\t\tif (this.m_limitState2 == b2Joint.e_atUpperLimit)\r\n\t\t{\r\n\t\t\t//b2Vec2 v2 = b2->m_linearVelocity + b2Cross(b2->m_angularVelocity, r2);\r\n\t\t\tv2X = b2.m_linearVelocity.x + (-b2.m_angularVelocity * r2Y);\r\n\t\t\tv2Y = b2.m_linearVelocity.y + (b2.m_angularVelocity * r2X);\r\n\r\n\t\t\t//float32 Cdot = -b2Dot(this.m_u2, v2);\r\n\t\t\tCdot = -(this.m_u2.x * v2X + this.m_u2.y * v2Y);\r\n\t\t\timpulse = -this.m_limitMass2 * Cdot;\r\n\t\t\toldLimitImpulse = this.m_limitImpulse2;\r\n\t\t\tthis.m_limitImpulse2 = b2Math.b2Max(0.0, this.m_limitImpulse2 + impulse);\r\n\t\t\timpulse = this.m_limitImpulse2 - oldLimitImpulse;\r\n\t\t\t//b2Vec2 P2 = -impulse * this.m_u2;\r\n\t\t\tP2X = -impulse * this.m_u2.x;\r\n\t\t\tP2Y = -impulse * this.m_u2.y;\r\n\t\t\t//b2->m_linearVelocity += b2->m_invMass * P2;\r\n\t\t\tb2.m_linearVelocity.x += b2.m_invMass * P2X;\r\n\t\t\tb2.m_linearVelocity.y += b2.m_invMass * P2Y;\r\n\t\t\t//b2->m_angularVelocity += b2->m_invI * b2Cross(r2, P2);\r\n\t\t\tb2.m_angularVelocity += b2.m_invI * (r2X * P2Y - r2Y * P2X);\r\n\t\t}\r\n\t};\r\n\r\n\tthis.SolvePositionConstraints = function(){\r\n\t\tvar b1 = this.m_body1;\r\n\t\tvar b2 = this.m_body2;\r\n\r\n\t\tvar tMat;\r\n\r\n\t\t//b2Vec2 s1 = this.m_ground->m_position + this.m_groundAnchor1;\r\n\t\tvar s1X = this.m_ground.m_position.x + this.m_groundAnchor1.x;\r\n\t\tvar s1Y = this.m_ground.m_position.y + this.m_groundAnchor1.y;\r\n\t\t//b2Vec2 s2 = this.m_ground->m_position + this.m_groundAnchor2;\r\n\t\tvar s2X = this.m_ground.m_position.x + this.m_groundAnchor2.x;\r\n\t\tvar s2Y = this.m_ground.m_position.y + this.m_groundAnchor2.y;\r\n\r\n\t\t// temp vars\r\n\t\tvar r1X;\r\n\t\tvar r1Y;\r\n\t\tvar r2X;\r\n\t\tvar r2Y;\r\n\t\tvar p1X;\r\n\t\tvar p1Y;\r\n\t\tvar p2X;\r\n\t\tvar p2Y;\r\n\t\tvar length1;\r\n\t\tvar length2;\r\n\t\tvar C;\r\n\t\tvar impulse;\r\n\t\tvar oldLimitPositionImpulse;\r\n\r\n\t\tvar linearError = 0.0;\r\n\r\n\t\t{\r\n\t\t\t//var r1 = b2Mul(b1.m_R, this.m_localAnchor1);\r\n\t\t\ttMat = b1.m_R;\r\n\t\t\tr1X = tMat.col1.x * this.m_localAnchor1.x + tMat.col2.x * this.m_localAnchor1.y;\r\n\t\t\tr1Y = tMat.col1.y * this.m_localAnchor1.x + tMat.col2.y * this.m_localAnchor1.y;\r\n\t\t\t//var r2 = b2Mul(b2.m_R, this.m_localAnchor2);\r\n\t\t\ttMat = b2.m_R;\r\n\t\t\tr2X = tMat.col1.x * this.m_localAnchor2.x + tMat.col2.x * this.m_localAnchor2.y;\r\n\t\t\tr2Y = tMat.col1.y * this.m_localAnchor2.x + tMat.col2.y * this.m_localAnchor2.y;\r\n\r\n\t\t\t//b2Vec2 p1 = b1->m_position + r1;\r\n\t\t\tp1X = b1.m_position.x + r1X;\r\n\t\t\tp1Y = b1.m_position.y + r1Y;\r\n\t\t\t//b2Vec2 p2 = b2->m_position + r2;\r\n\t\t\tp2X = b2.m_position.x + r2X;\r\n\t\t\tp2Y = b2.m_position.y + r2Y;\r\n\r\n\t\t\t// Get the pulley axes.\r\n\t\t\t//this.m_u1 = p1 - s1;\r\n\t\t\tthis.m_u1.Set(p1X - s1X, p1Y - s1Y);\r\n\t\t\t//this.m_u2 = p2 - s2;\r\n\t\t\tthis.m_u2.Set(p2X - s2X, p2Y - s2Y);\r\n\r\n\t\t\tlength1 = this.m_u1.Length();\r\n\t\t\tlength2 = this.m_u2.Length();\r\n\r\n\t\t\tif (length1 > b2Settings.b2_linearSlop)\r\n\t\t\t{\r\n\t\t\t\t//this.m_u1 *= 1.0f / length1;\r\n\t\t\t\tthis.m_u1.Multiply( 1.0 / length1 );\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tthis.m_u1.SetZero();\r\n\t\t\t}\r\n\r\n\t\t\tif (length2 > b2Settings.b2_linearSlop)\r\n\t\t\t{\r\n\t\t\t\t//this.m_u2 *= 1.0f / length2;\r\n\t\t\t\tthis.m_u2.Multiply( 1.0 / length2 );\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tthis.m_u2.SetZero();\r\n\t\t\t}\r\n\r\n\t\t\tC = this.m_constant - length1 - this.m_ratio * length2;\r\n\t\t\tlinearError = b2Math.b2Max(linearError, Math.abs(C));\r\n\t\t\tC = b2Math.b2Clamp(C, -b2Settings.b2_maxLinearCorrection, b2Settings.b2_maxLinearCorrection);\r\n\t\t\timpulse = -this.m_pulleyMass * C;\r\n\r\n\t\t\tp1X = -impulse * this.m_u1.x;\r\n\t\t\tp1Y = -impulse * this.m_u1.y;\r\n\t\t\tp2X = -this.m_ratio * impulse * this.m_u2.x;\r\n\t\t\tp2Y = -this.m_ratio * impulse * this.m_u2.y;\r\n\r\n\t\t\tb1.m_position.x += b1.m_invMass * p1X;\r\n\t\t\tb1.m_position.y += b1.m_invMass * p1Y;\r\n\t\t\tb1.m_rotation += b1.m_invI * (r1X * p1Y - r1Y * p1X);\r\n\t\t\tb2.m_position.x += b2.m_invMass * p2X;\r\n\t\t\tb2.m_position.y += b2.m_invMass * p2Y;\r\n\t\t\tb2.m_rotation += b2.m_invI * (r2X * p2Y - r2Y * p2X);\r\n\r\n\t\t\tb1.m_R.Set(b1.m_rotation);\r\n\t\t\tb2.m_R.Set(b2.m_rotation);\r\n\t\t}\r\n\r\n\t\tif (this.m_limitState1 == b2Joint.e_atUpperLimit)\r\n\t\t{\r\n\t\t\t//b2Vec2 r1 = b2Mul(b1->m_R, this.m_localAnchor1);\r\n\t\t\ttMat = b1.m_R;\r\n\t\t\tr1X = tMat.col1.x * this.m_localAnchor1.x + tMat.col2.x * this.m_localAnchor1.y;\r\n\t\t\tr1Y = tMat.col1.y * this.m_localAnchor1.x + tMat.col2.y * this.m_localAnchor1.y;\r\n\t\t\t//b2Vec2 p1 = b1->m_position + r1;\r\n\t\t\tp1X = b1.m_position.x + r1X;\r\n\t\t\tp1Y = b1.m_position.y + r1Y;\r\n\r\n\t\t\t//this.m_u1 = p1 - s1;\r\n\t\t\tthis.m_u1.Set(p1X - s1X, p1Y - s1Y);\r\n\r\n\t\t\tlength1 = this.m_u1.Length();\r\n\r\n\t\t\tif (length1 > b2Settings.b2_linearSlop)\r\n\t\t\t{\r\n\t\t\t\t//this.m_u1 *= 1.0 / length1;\r\n\t\t\t\tthis.m_u1.x *= 1.0 / length1;\r\n\t\t\t\tthis.m_u1.y *= 1.0 / length1;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tthis.m_u1.SetZero();\r\n\t\t\t}\r\n\r\n\t\t\tC = this.m_maxLength1 - length1;\r\n\t\t\tlinearError = b2Math.b2Max(linearError, -C);\r\n\t\t\tC = b2Math.b2Clamp(C + b2Settings.b2_linearSlop, -b2Settings.b2_maxLinearCorrection, 0.0);\r\n\t\t\timpulse = -this.m_limitMass1 * C;\r\n\t\t\toldLimitPositionImpulse = this.m_limitPositionImpulse1;\r\n\t\t\tthis.m_limitPositionImpulse1 = b2Math.b2Max(0.0, this.m_limitPositionImpulse1 + impulse);\r\n\t\t\timpulse = this.m_limitPositionImpulse1 - oldLimitPositionImpulse;\r\n\r\n\t\t\t//P1 = -impulse * this.m_u1;\r\n\t\t\tp1X = -impulse * this.m_u1.x;\r\n\t\t\tp1Y = -impulse * this.m_u1.y;\r\n\r\n\t\t\tb1.m_position.x += b1.m_invMass * p1X;\r\n\t\t\tb1.m_position.y += b1.m_invMass * p1Y;\r\n\t\t\t//b1.m_rotation += b1.m_invI * b2Cross(r1, P1);\r\n\t\t\tb1.m_rotation += b1.m_invI * (r1X * p1Y - r1Y * p1X);\r\n\t\t\tb1.m_R.Set(b1.m_rotation);\r\n\t\t}\r\n\r\n\t\tif (this.m_limitState2 == b2Joint.e_atUpperLimit)\r\n\t\t{\r\n\t\t\t//b2Vec2 r2 = b2Mul(b2->m_R, this.m_localAnchor2);\r\n\t\t\ttMat = b2.m_R;\r\n\t\t\tr2X = tMat.col1.x * this.m_localAnchor2.x + tMat.col2.x * this.m_localAnchor2.y;\r\n\t\t\tr2Y = tMat.col1.y * this.m_localAnchor2.x + tMat.col2.y * this.m_localAnchor2.y;\r\n\t\t\t//b2Vec2 p2 = b2->m_position + r2;\r\n\t\t\tp2X = b2.m_position.x + r2X;\r\n\t\t\tp2Y = b2.m_position.y + r2Y;\r\n\r\n\t\t\t//this.m_u2 = p2 - s2;\r\n\t\t\tthis.m_u2.Set(p2X - s2X, p2Y - s2Y);\r\n\r\n\t\t\tlength2 = this.m_u2.Length();\r\n\r\n\t\t\tif (length2 > b2Settings.b2_linearSlop)\r\n\t\t\t{\r\n\t\t\t\t//this.m_u2 *= 1.0 / length2;\r\n\t\t\t\tthis.m_u2.x *= 1.0 / length2;\r\n\t\t\t\tthis.m_u2.y *= 1.0 / length2;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tthis.m_u2.SetZero();\r\n\t\t\t}\r\n\r\n\t\t\tC = this.m_maxLength2 - length2;\r\n\t\t\tlinearError = b2Math.b2Max(linearError, -C);\r\n\t\t\tC = b2Math.b2Clamp(C + b2Settings.b2_linearSlop, -b2Settings.b2_maxLinearCorrection, 0.0);\r\n\t\t\timpulse = -this.m_limitMass2 * C;\r\n\t\t\toldLimitPositionImpulse = this.m_limitPositionImpulse2;\r\n\t\t\tthis.m_limitPositionImpulse2 = b2Math.b2Max(0.0, this.m_limitPositionImpulse2 + impulse);\r\n\t\t\timpulse = this.m_limitPositionImpulse2 - oldLimitPositionImpulse;\r\n\r\n\t\t\t//P2 = -impulse * this.m_u2;\r\n\t\t\tp2X = -impulse * this.m_u2.x;\r\n\t\t\tp2Y = -impulse * this.m_u2.y;\r\n\r\n\t\t\t//b2.m_position += b2.m_invMass * P2;\r\n\t\t\tb2.m_position.x += b2.m_invMass * p2X;\r\n\t\t\tb2.m_position.y += b2.m_invMass * p2Y;\r\n\t\t\t//b2.m_rotation += b2.m_invI * b2Cross(r2, P2);\r\n\t\t\tb2.m_rotation += b2.m_invI * (r2X * p2Y - r2Y * p2X);\r\n\t\t\tb2.m_R.Set(b2.m_rotation);\r\n\t\t}\r\n\r\n\t\treturn linearError < b2Settings.b2_linearSlop;\r\n\t};\r\n});\r\n\r\nb2PulleyJoint.b2_minPulleyLength = b2Settings.b2_lengthUnitsPerMeter;\r\nexports = b2PulleyJoint;\r\n","pre":true},"./src/box2d/dynamics/joints/b2RevoluteJoint.js":{"path":"./src/box2d/dynamics/joints/b2RevoluteJoint.js","friendlyPath":".b2RevoluteJoint","directory":"./src/box2d/dynamics/joints/","filename":"b2RevoluteJoint.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\njsio(\"import ...common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import ...common.math.b2Mat22 as b2Mat22\");\r\njsio(\"import ...common.math.b2Math as b2Math\");\r\njsio(\"import ..b2World as b2World\");\r\njsio(\"import .b2Joint as b2Joint\");\r\njsio(\"import .b2JointNode as b2JointNode\");\r\n\r\n// Point-to-point constraint\r\n// C = p2 - p1\r\n// Cdot = v2 - v1\r\n//      = v2 + cross(w2, r2) - v1 - cross(w1, r1)\r\n// J = [-I -r1_skew I r2_skew ]\r\n// Identity used:\r\n// w k % (rx i + ry j) = w * (-ry i + rx j)\r\n\r\n// Motor constraint\r\n// Cdot = w2 - w1\r\n// J = [0 0 -1 0 0 1]\r\n// K = invI1 + invI2\r\n\r\nb2RevoluteJoint=__class__;var b2RevoluteJoint=b2RevoluteJoint(function b2RevoluteJoint(){return this.init&&this.init.apply(this,arguments)},b2Joint, function(supr) {\r\n\tthis.GetAnchor1 = function(){\r\n\t\tvar tMat = this.m_body1.m_R;\r\n\t\treturn new b2Vec2(\tthis.m_body1.m_position.x + (tMat.col1.x * this.m_localAnchor1.x + tMat.col2.x * this.m_localAnchor1.y),\r\n\t\t\t\t\t\t\tthis.m_body1.m_position.y + (tMat.col1.y * this.m_localAnchor1.x + tMat.col2.y * this.m_localAnchor1.y));\r\n\t};\r\n\tthis.GetAnchor2 = function(){\r\n\t\tvar tMat = this.m_body2.m_R;\r\n\t\treturn new b2Vec2(\tthis.m_body2.m_position.x + (tMat.col1.x * this.m_localAnchor2.x + tMat.col2.x * this.m_localAnchor2.y),\r\n\t\t\t\t\t\t\tthis.m_body2.m_position.y + (tMat.col1.y * this.m_localAnchor2.x + tMat.col2.y * this.m_localAnchor2.y));\r\n\t};\r\n\tthis.GetJointAngle = function(){\r\n\t\treturn this.m_body2.m_rotation - this.m_body1.m_rotation;\r\n\t};\r\n\tthis.GetJointSpeed = function(){\r\n\t\treturn this.m_body2.m_angularVelocity - this.m_body1.m_angularVelocity;\r\n\t};\r\n\tthis.GetMotorTorque = function(invTimeStep){\r\n\t\treturn  invTimeStep * this.m_motorImpulse;\r\n\t};\r\n\r\n\tthis.SetMotorSpeed = function(speed)\r\n\t{\r\n\t\tthis.m_motorSpeed = speed;\r\n\t};\r\n\r\n\tthis.SetMotorTorque = function(torque)\r\n\t{\r\n\t\tthis.m_maxMotorTorque = torque;\r\n\t};\r\n\r\n\tthis.GetReactionForce = function(invTimeStep)\r\n\t{\r\n\t\tvar tVec = this.m_ptpImpulse.Copy();\r\n\t\ttVec.Multiply(invTimeStep);\r\n\t\t//return invTimeStep * this.m_ptpImpulse;\r\n\t\treturn tVec;\r\n\t};\r\n\r\n\tthis.GetReactionTorque = function(invTimeStep)\r\n\t{\r\n\t\treturn invTimeStep * this.m_limitImpulse;\r\n\t};\r\n\r\n\t//--------------- Internals Below -------------------\r\n\r\n\tthis.init = function(def){\r\n\t\tsupr(this, 'init', [def]);\r\n\r\n\t\tthis.m_motorMass = null;\r\n\t\tthis.m_limitState = 0;\r\n\t\t// The constructor for b2Joint\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_node1 = new b2JointNode();\r\n\t\tthis.m_node2 = new b2JointNode();\r\n\t\t//\r\n\t\tthis.m_type = def.type;\r\n\t\tthis.m_prev = null;\r\n\t\tthis.m_next = null;\r\n\t\tthis.m_body1 = def.body1;\r\n\t\tthis.m_body2 = def.body2;\r\n\t\tthis.m_collideConnected = def.collideConnected;\r\n\t\tthis.m_islandFlag = false;\r\n\t\tthis.m_userData = def.userData;\r\n\t\t//\r\n\r\n\t\t// initialize instance variables for references\r\n\t\tthis.K = new b2Mat22();\r\n\t\tthis.K1 = new b2Mat22();\r\n\t\tthis.K2 = new b2Mat22();\r\n\t\tthis.K3 = new b2Mat22();\r\n\t\tthis.m_localAnchor1 = new b2Vec2();\r\n\t\tthis.m_localAnchor2 = new b2Vec2();\r\n\t\tthis.m_ptpImpulse = new b2Vec2();\r\n\t\tthis.m_ptpMass = new b2Mat22();\r\n\t\t//\r\n\r\n\t\t//super(def);\r\n\r\n\t\tvar tMat;\r\n\t\tvar tX;\r\n\t\tvar tY;\r\n\r\n\t\t//this.m_localAnchor1 = b2Math.b2MulTMV(this.m_body1.m_R, b2Math.SubtractVV( def.anchorPoint, this.m_body1.m_position));\r\n\t\ttMat = this.m_body1.m_R;\r\n\t\ttX = def.anchorPoint.x - this.m_body1.m_position.x;\r\n\t\ttY = def.anchorPoint.y - this.m_body1.m_position.y;\r\n\t\tthis.m_localAnchor1.x = tX * tMat.col1.x + tY * tMat.col1.y;\r\n\t\tthis.m_localAnchor1.y = tX * tMat.col2.x + tY * tMat.col2.y;\r\n\t\t//this.m_localAnchor2 = b2Math.b2MulTMV(this.m_body2.m_R, b2Math.SubtractVV( def.anchorPoint, this.m_body2.m_position));\r\n\t\ttMat = this.m_body2.m_R;\r\n\t\ttX = def.anchorPoint.x - this.m_body2.m_position.x;\r\n\t\ttY = def.anchorPoint.y - this.m_body2.m_position.y;\r\n\t\tthis.m_localAnchor2.x = tX * tMat.col1.x + tY * tMat.col1.y;\r\n\t\tthis.m_localAnchor2.y = tX * tMat.col2.x + tY * tMat.col2.y;\r\n\r\n\t\tthis.m_intialAngle = this.m_body2.m_rotation - this.m_body1.m_rotation;\r\n\r\n\t\tthis.m_ptpImpulse.Set(0.0, 0.0);\r\n\t\tthis.m_motorImpulse = 0.0;\r\n\t\tthis.m_limitImpulse = 0.0;\r\n\t\tthis.m_limitPositionImpulse = 0.0;\r\n\r\n\t\tthis.m_lowerAngle = def.lowerAngle;\r\n\t\tthis.m_upperAngle = def.upperAngle;\r\n\t\tthis.m_maxMotorTorque = def.motorTorque;\r\n\t\tthis.m_motorSpeed = def.motorSpeed;\r\n\t\tthis.m_enableLimit = def.enableLimit;\r\n\t\tthis.m_enableMotor = def.enableMotor;\r\n\t};\r\n\r\n\tthis.PrepareVelocitySolver = function(){\r\n\t\tvar b1 = this.m_body1;\r\n\t\tvar b2 = this.m_body2;\r\n\r\n\t\tvar tMat;\r\n\r\n\t\t// Compute the effective mass matrix.\r\n\t\t//b2Vec2 r1 = b2Mul(b1->m_R, this.m_localAnchor1);\r\n\t\ttMat = b1.m_R;\r\n\t\tvar r1X = tMat.col1.x * this.m_localAnchor1.x + tMat.col2.x * this.m_localAnchor1.y;\r\n\t\tvar r1Y = tMat.col1.y * this.m_localAnchor1.x + tMat.col2.y * this.m_localAnchor1.y;\r\n\t\t//b2Vec2 r2 = b2Mul(b2->m_R, this.m_localAnchor2);\r\n\t\ttMat = b2.m_R;\r\n\t\tvar r2X = tMat.col1.x * this.m_localAnchor2.x + tMat.col2.x * this.m_localAnchor2.y;\r\n\t\tvar r2Y = tMat.col1.y * this.m_localAnchor2.x + tMat.col2.y * this.m_localAnchor2.y;\r\n\r\n\t\t// this.K    = [(1/m1 + 1/m2) * eye(2) - skew(r1) * invI1 * skew(r1) - skew(r2) * invI2 * skew(r2)]\r\n\t\t//      = [1/m1+1/m2     0    ] + invI1 * [r1.y*r1.y -r1.x*r1.y] + invI2 * [r1.y*r1.y -r1.x*r1.y]\r\n\t\t//        [    0     1/m1+1/m2]           [-r1.x*r1.y r1.x*r1.x]           [-r1.x*r1.y r1.x*r1.x]\r\n\t\tvar invMass1 = b1.m_invMass;\r\n\t\tvar invMass2 = b2.m_invMass;\r\n\t\tvar invI1 = b1.m_invI;\r\n\t\tvar invI2 = b2.m_invI;\r\n\r\n\t\t//var this.K1 = new b2Mat22();\r\n\t\tthis.K1.col1.x = invMass1 + invMass2;\tthis.K1.col2.x = 0.0;\r\n\t\tthis.K1.col1.y = 0.0;\t\t\t\t\tthis.K1.col2.y = invMass1 + invMass2;\r\n\r\n\t\t//var this.K2 = new b2Mat22();\r\n\t\tthis.K2.col1.x =  invI1 * r1Y * r1Y;\tthis.K2.col2.x = -invI1 * r1X * r1Y;\r\n\t\tthis.K2.col1.y = -invI1 * r1X * r1Y;\tthis.K2.col2.y =  invI1 * r1X * r1X;\r\n\r\n\t\t//var this.K3 = new b2Mat22();\r\n\t\tthis.K3.col1.x =  invI2 * r2Y * r2Y;\tthis.K3.col2.x = -invI2 * r2X * r2Y;\r\n\t\tthis.K3.col1.y = -invI2 * r2X * r2Y;\tthis.K3.col2.y =  invI2 * r2X * r2X;\r\n\r\n\t\t//var this.K = b2Math.AddMM(b2Math.AddMM(this.K1, this.K2), this.K3);\r\n\t\tthis.K.SetM(this.K1);\r\n\t\tthis.K.AddM(this.K2);\r\n\t\tthis.K.AddM(this.K3);\r\n\r\n\t\t//this.m_ptpMass = this.K.Invert();\r\n\t\tthis.K.Invert(this.m_ptpMass);\r\n\r\n\t\tthis.m_motorMass = 1.0 / (invI1 + invI2);\r\n\r\n\t\tif (this.m_enableMotor == false)\r\n\t\t{\r\n\t\t\tthis.m_motorImpulse = 0.0;\r\n\t\t}\r\n\r\n\t\tif (this.m_enableLimit)\r\n\t\t{\r\n\t\t\tvar jointAngle = b2.m_rotation - b1.m_rotation - this.m_intialAngle;\r\n\t\t\tif (b2Math.b2Abs(this.m_upperAngle - this.m_lowerAngle) < 2.0 * b2Settings.b2_angularSlop)\r\n\t\t\t{\r\n\t\t\t\tthis.m_limitState = b2Joint.e_equalLimits;\r\n\t\t\t}\r\n\t\t\telse if (jointAngle <= this.m_lowerAngle)\r\n\t\t\t{\r\n\t\t\t\tif (this.m_limitState != b2Joint.e_atLowerLimit)\r\n\t\t\t\t{\r\n\t\t\t\t\tthis.m_limitImpulse = 0.0;\r\n\t\t\t\t}\r\n\t\t\t\tthis.m_limitState = b2Joint.e_atLowerLimit;\r\n\t\t\t}\r\n\t\t\telse if (jointAngle >= this.m_upperAngle)\r\n\t\t\t{\r\n\t\t\t\tif (this.m_limitState != b2Joint.e_atUpperLimit)\r\n\t\t\t\t{\r\n\t\t\t\t\tthis.m_limitImpulse = 0.0;\r\n\t\t\t\t}\r\n\t\t\t\tthis.m_limitState = b2Joint.e_atUpperLimit;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tthis.m_limitState = b2Joint.e_inactiveLimit;\r\n\t\t\t\tthis.m_limitImpulse = 0.0;\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tthis.m_limitImpulse = 0.0;\r\n\t\t}\r\n\r\n\t\t// Warm starting.\r\n\t\tif (b2World.s_enableWarmStarting)\r\n\t\t{\r\n\t\t\t//b1.m_linearVelocity.Subtract( b2Math.MulFV( invMass1, this.m_ptpImpulse) );\r\n\t\t\tb1.m_linearVelocity.x -= invMass1 * this.m_ptpImpulse.x;\r\n\t\t\tb1.m_linearVelocity.y -= invMass1 * this.m_ptpImpulse.y;\r\n\t\t\t//b1.m_angularVelocity -= invI1 * (b2Math.b2CrossVV(r1, this.m_ptpImpulse) + this.m_motorImpulse + this.m_limitImpulse);\r\n\t\t\tb1.m_angularVelocity -= invI1 * ((r1X * this.m_ptpImpulse.y - r1Y * this.m_ptpImpulse.x) + this.m_motorImpulse + this.m_limitImpulse);\r\n\r\n\t\t\t//b2.m_linearVelocity.Add( b2Math.MulFV( invMass2 , this.m_ptpImpulse ));\r\n\t\t\tb2.m_linearVelocity.x += invMass2 * this.m_ptpImpulse.x;\r\n\t\t\tb2.m_linearVelocity.y += invMass2 * this.m_ptpImpulse.y;\r\n\t\t\t//b2.m_angularVelocity += invI2 * (b2Math.b2CrossVV(r2, this.m_ptpImpulse) + this.m_motorImpulse + this.m_limitImpulse);\r\n\t\t\tb2.m_angularVelocity += invI2 * ((r2X * this.m_ptpImpulse.y - r2Y * this.m_ptpImpulse.x) + this.m_motorImpulse + this.m_limitImpulse);\r\n\t\t}\r\n\t\telse{\r\n\t\t\tthis.m_ptpImpulse.SetZero();\r\n\t\t\tthis.m_motorImpulse = 0.0;\r\n\t\t\tthis.m_limitImpulse = 0.0;\r\n\t\t}\r\n\r\n\t\tthis.m_limitPositionImpulse = 0.0;\r\n\t};\r\n\r\n\r\n\tthis.SolveVelocityConstraints = function(step){\r\n\t\tvar b1 = this.m_body1;\r\n\t\tvar b2 = this.m_body2;\r\n\r\n\t\tvar tMat;\r\n\r\n\t\t//var r1 = b2Math.b2MulMV(b1.m_R, this.m_localAnchor1);\r\n\t\ttMat = b1.m_R;\r\n\t\tvar r1X = tMat.col1.x * this.m_localAnchor1.x + tMat.col2.x * this.m_localAnchor1.y;\r\n\t\tvar r1Y = tMat.col1.y * this.m_localAnchor1.x + tMat.col2.y * this.m_localAnchor1.y;\r\n\t\t//var r2 = b2Math.b2MulMV(b2.m_R, this.m_localAnchor2);\r\n\t\ttMat = b2.m_R;\r\n\t\tvar r2X = tMat.col1.x * this.m_localAnchor2.x + tMat.col2.x * this.m_localAnchor2.y;\r\n\t\tvar r2Y = tMat.col1.y * this.m_localAnchor2.x + tMat.col2.y * this.m_localAnchor2.y;\r\n\r\n\t\tvar oldLimitImpulse;\r\n\r\n\t\t// Solve point-to-point constraint\r\n\t\t//b2Vec2 ptpCdot = b2.m_linearVelocity + b2Cross(b2.m_angularVelocity, r2) - b1.m_linearVelocity - b2Cross(b1.m_angularVelocity, r1);\r\n\t\tvar ptpCdotX = b2.m_linearVelocity.x + (-b2.m_angularVelocity * r2Y) - b1.m_linearVelocity.x - (-b1.m_angularVelocity * r1Y);\r\n\t\tvar ptpCdotY = b2.m_linearVelocity.y + (b2.m_angularVelocity * r2X) - b1.m_linearVelocity.y - (b1.m_angularVelocity * r1X);\r\n\r\n\t\t//b2Vec2 ptpImpulse = -b2Mul(this.m_ptpMass, ptpCdot);\r\n\t\tvar ptpImpulseX = -(this.m_ptpMass.col1.x * ptpCdotX + this.m_ptpMass.col2.x * ptpCdotY);\r\n\t\tvar ptpImpulseY = -(this.m_ptpMass.col1.y * ptpCdotX + this.m_ptpMass.col2.y * ptpCdotY);\r\n\t\tthis.m_ptpImpulse.x += ptpImpulseX;\r\n\t\tthis.m_ptpImpulse.y += ptpImpulseY;\r\n\r\n\t\t//b1->m_linearVelocity -= b1->m_invMass * ptpImpulse;\r\n\t\tb1.m_linearVelocity.x -= b1.m_invMass * ptpImpulseX;\r\n\t\tb1.m_linearVelocity.y -= b1.m_invMass * ptpImpulseY;\r\n\t\t//b1->m_angularVelocity -= b1->m_invI * b2Cross(r1, ptpImpulse);\r\n\t\tb1.m_angularVelocity -= b1.m_invI * (r1X * ptpImpulseY - r1Y * ptpImpulseX);\r\n\r\n\t\t//b2->m_linearVelocity += b2->m_invMass * ptpImpulse;\r\n\t\tb2.m_linearVelocity.x += b2.m_invMass * ptpImpulseX;\r\n\t\tb2.m_linearVelocity.y += b2.m_invMass * ptpImpulseY;\r\n\t\t//b2->m_angularVelocity += b2->m_invI * b2Cross(r2, ptpImpulse);\r\n\t\tb2.m_angularVelocity += b2.m_invI * (r2X * ptpImpulseY - r2Y * ptpImpulseX);\r\n\r\n\t\tif (this.m_enableMotor && this.m_limitState != b2Joint.e_equalLimits)\r\n\t\t{\r\n\t\t\tvar motorCdot = b2.m_angularVelocity - b1.m_angularVelocity - this.m_motorSpeed;\r\n\t\t\tvar motorImpulse = -this.m_motorMass * motorCdot;\r\n\t\t\tvar oldMotorImpulse = this.m_motorImpulse;\r\n\t\t\tthis.m_motorImpulse = b2Math.b2Clamp(this.m_motorImpulse + motorImpulse, -step.dt * this.m_maxMotorTorque, step.dt * this.m_maxMotorTorque);\r\n\t\t\tmotorImpulse = this.m_motorImpulse - oldMotorImpulse;\r\n\t\t\tb1.m_angularVelocity -= b1.m_invI * motorImpulse;\r\n\t\t\tb2.m_angularVelocity += b2.m_invI * motorImpulse;\r\n\t\t}\r\n\r\n\t\tif (this.m_enableLimit && this.m_limitState != b2Joint.e_inactiveLimit)\r\n\t\t{\r\n\t\t\tvar limitCdot = b2.m_angularVelocity - b1.m_angularVelocity;\r\n\t\t\tvar limitImpulse = -this.m_motorMass * limitCdot;\r\n\r\n\t\t\tif (this.m_limitState == b2Joint.e_equalLimits)\r\n\t\t\t{\r\n\t\t\t\tthis.m_limitImpulse += limitImpulse;\r\n\t\t\t}\r\n\t\t\telse if (this.m_limitState == b2Joint.e_atLowerLimit)\r\n\t\t\t{\r\n\t\t\t\toldLimitImpulse = this.m_limitImpulse;\r\n\t\t\t\tthis.m_limitImpulse = b2Math.b2Max(this.m_limitImpulse + limitImpulse, 0.0);\r\n\t\t\t\tlimitImpulse = this.m_limitImpulse - oldLimitImpulse;\r\n\t\t\t}\r\n\t\t\telse if (this.m_limitState == b2Joint.e_atUpperLimit)\r\n\t\t\t{\r\n\t\t\t\toldLimitImpulse = this.m_limitImpulse;\r\n\t\t\t\tthis.m_limitImpulse = b2Math.b2Min(this.m_limitImpulse + limitImpulse, 0.0);\r\n\t\t\t\tlimitImpulse = this.m_limitImpulse - oldLimitImpulse;\r\n\t\t\t}\r\n\r\n\t\t\tb1.m_angularVelocity -= b1.m_invI * limitImpulse;\r\n\t\t\tb2.m_angularVelocity += b2.m_invI * limitImpulse;\r\n\t\t}\r\n\t};\r\n\r\n\r\n\tthis.SolvePositionConstraints = function(){\r\n\r\n\t\tvar oldLimitImpulse;\r\n\t\tvar limitC;\r\n\r\n\t\tvar b1 = this.m_body1;\r\n\t\tvar b2 = this.m_body2;\r\n\r\n\t\tvar positionError = 0.0;\r\n\r\n\t\tvar tMat;\r\n\r\n\t\t// Solve point-to-point position error.\r\n\t\t//var r1 = b2Math.b2MulMV(b1.m_R, this.m_localAnchor1);\r\n\t\ttMat = b1.m_R;\r\n\t\tvar r1X = tMat.col1.x * this.m_localAnchor1.x + tMat.col2.x * this.m_localAnchor1.y;\r\n\t\tvar r1Y = tMat.col1.y * this.m_localAnchor1.x + tMat.col2.y * this.m_localAnchor1.y;\r\n\t\t//var r2 = b2Math.b2MulMV(b2.m_R, this.m_localAnchor2);\r\n\t\ttMat = b2.m_R;\r\n\t\tvar r2X = tMat.col1.x * this.m_localAnchor2.x + tMat.col2.x * this.m_localAnchor2.y;\r\n\t\tvar r2Y = tMat.col1.y * this.m_localAnchor2.x + tMat.col2.y * this.m_localAnchor2.y;\r\n\r\n\t\t//b2Vec2 p1 = b1->m_position + r1;\r\n\t\tvar p1X = b1.m_position.x + r1X;\r\n\t\tvar p1Y = b1.m_position.y + r1Y;\r\n\t\t//b2Vec2 p2 = b2->m_position + r2;\r\n\t\tvar p2X = b2.m_position.x + r2X;\r\n\t\tvar p2Y = b2.m_position.y + r2Y;\r\n\r\n\t\t//b2Vec2 ptpC = p2 - p1;\r\n\t\tvar ptpCX = p2X - p1X;\r\n\t\tvar ptpCY = p2Y - p1Y;\r\n\r\n\t\t//float32 positionError = ptpC.Length();\r\n\t\tpositionError = Math.sqrt(ptpCX*ptpCX + ptpCY*ptpCY);\r\n\r\n\t\t// Prevent overly large corrections.\r\n\t\t//b2Vec2 dpMax(b2_maxLinearCorrection, b2_maxLinearCorrection);\r\n\t\t//ptpC = b2Clamp(ptpC, -dpMax, dpMax);\r\n\r\n\t\t//float32 invMass1 = b1->m_invMass, invMass2 = b2->m_invMass;\r\n\t\tvar invMass1 = b1.m_invMass;\r\n\t\tvar invMass2 = b2.m_invMass;\r\n\t\t//float32 invI1 = b1->m_invI, invI2 = b2->m_invI;\r\n\t\tvar invI1 = b1.m_invI;\r\n\t\tvar invI2 = b2.m_invI;\r\n\r\n\t\t//b2Mat22 this.K1;\r\n\t\tthis.K1.col1.x = invMass1 + invMass2;\tthis.K1.col2.x = 0.0;\r\n\t\tthis.K1.col1.y = 0.0;\t\t\t\t\tthis.K1.col2.y = invMass1 + invMass2;\r\n\r\n\t\t//b2Mat22 this.K2;\r\n\t\tthis.K2.col1.x =  invI1 * r1Y * r1Y;\tthis.K2.col2.x = -invI1 * r1X * r1Y;\r\n\t\tthis.K2.col1.y = -invI1 * r1X * r1Y;\tthis.K2.col2.y =  invI1 * r1X * r1X;\r\n\r\n\t\t//b2Mat22 this.K3;\r\n\t\tthis.K3.col1.x =  invI2 * r2Y * r2Y;\t\tthis.K3.col2.x = -invI2 * r2X * r2Y;\r\n\t\tthis.K3.col1.y = -invI2 * r2X * r2Y;\t\tthis.K3.col2.y =  invI2 * r2X * r2X;\r\n\r\n\t\t//b2Mat22 this.K = this.K1 + this.K2 + this.K3;\r\n\t\tthis.K.SetM(this.K1);\r\n\t\tthis.K.AddM(this.K2);\r\n\t\tthis.K.AddM(this.K3);\r\n\t\t//b2Vec2 impulse = this.K.Solve(-ptpC);\r\n\t\tthis.K.Solve(b2RevoluteJoint.tImpulse, -ptpCX, -ptpCY);\r\n\t\tvar impulseX = b2RevoluteJoint.tImpulse.x;\r\n\t\tvar impulseY = b2RevoluteJoint.tImpulse.y;\r\n\r\n\t\t//b1.m_position -= b1.m_invMass * impulse;\r\n\t\tb1.m_position.x -= b1.m_invMass * impulseX;\r\n\t\tb1.m_position.y -= b1.m_invMass * impulseY;\r\n\t\t//b1.m_rotation -= b1.m_invI * b2Cross(r1, impulse);\r\n\t\tb1.m_rotation -= b1.m_invI * (r1X * impulseY - r1Y * impulseX);\r\n\t\tb1.m_R.Set(b1.m_rotation);\r\n\r\n\t\t//b2.m_position += b2.m_invMass * impulse;\r\n\t\tb2.m_position.x += b2.m_invMass * impulseX;\r\n\t\tb2.m_position.y += b2.m_invMass * impulseY;\r\n\t\t//b2.m_rotation += b2.m_invI * b2Cross(r2, impulse);\r\n\t\tb2.m_rotation += b2.m_invI * (r2X * impulseY - r2Y * impulseX);\r\n\t\tb2.m_R.Set(b2.m_rotation);\r\n\r\n\r\n\t\t// Handle limits.\r\n\t\tvar angularError = 0.0;\r\n\r\n\t\tif (this.m_enableLimit && this.m_limitState != b2Joint.e_inactiveLimit)\r\n\t\t{\r\n\t\t\tvar angle = b2.m_rotation - b1.m_rotation - this.m_intialAngle;\r\n\t\t\tvar limitImpulse = 0.0;\r\n\r\n\t\t\tif (this.m_limitState == b2Joint.e_equalLimits)\r\n\t\t\t{\r\n\t\t\t\t// Prevent large angular corrections\r\n\t\t\t\tlimitC = b2Math.b2Clamp(angle, -b2Settings.b2_maxAngularCorrection, b2Settings.b2_maxAngularCorrection);\r\n\t\t\t\tlimitImpulse = -this.m_motorMass * limitC;\r\n\t\t\t\tangularError = b2Math.b2Abs(limitC);\r\n\t\t\t}\r\n\t\t\telse if (this.m_limitState == b2Joint.e_atLowerLimit)\r\n\t\t\t{\r\n\t\t\t\tlimitC = angle - this.m_lowerAngle;\r\n\t\t\t\tangularError = b2Math.b2Max(0.0, -limitC);\r\n\r\n\t\t\t\t// Prevent large angular corrections and allow some slop.\r\n\t\t\t\tlimitC = b2Math.b2Clamp(limitC + b2Settings.b2_angularSlop, -b2Settings.b2_maxAngularCorrection, 0.0);\r\n\t\t\t\tlimitImpulse = -this.m_motorMass * limitC;\r\n\t\t\t\toldLimitImpulse = this.m_limitPositionImpulse;\r\n\t\t\t\tthis.m_limitPositionImpulse = b2Math.b2Max(this.m_limitPositionImpulse + limitImpulse, 0.0);\r\n\t\t\t\tlimitImpulse = this.m_limitPositionImpulse - oldLimitImpulse;\r\n\t\t\t}\r\n\t\t\telse if (this.m_limitState == b2Joint.e_atUpperLimit)\r\n\t\t\t{\r\n\t\t\t\tlimitC = angle - this.m_upperAngle;\r\n\t\t\t\tangularError = b2Math.b2Max(0.0, limitC);\r\n\r\n\t\t\t\t// Prevent large angular corrections and allow some slop.\r\n\t\t\t\tlimitC = b2Math.b2Clamp(limitC - b2Settings.b2_angularSlop, 0.0, b2Settings.b2_maxAngularCorrection);\r\n\t\t\t\tlimitImpulse = -this.m_motorMass * limitC;\r\n\t\t\t\toldLimitImpulse = this.m_limitPositionImpulse;\r\n\t\t\t\tthis.m_limitPositionImpulse = b2Math.b2Min(this.m_limitPositionImpulse + limitImpulse, 0.0);\r\n\t\t\t\tlimitImpulse = this.m_limitPositionImpulse - oldLimitImpulse;\r\n\t\t\t}\r\n\r\n\t\t\tb1.m_rotation -= b1.m_invI * limitImpulse;\r\n\t\t\tb1.m_R.Set(b1.m_rotation);\r\n\t\t\tb2.m_rotation += b2.m_invI * limitImpulse;\r\n\t\t\tb2.m_R.Set(b2.m_rotation);\r\n\t\t}\r\n\r\n\t\treturn positionError <= b2Settings.b2_linearSlop && angularError <= b2Settings.b2_angularSlop;\r\n\t};\r\n});\r\n\r\nb2RevoluteJoint.tImpulse = new b2Vec2();\r\nexports = b2RevoluteJoint;\r\n","pre":true},"./src/box2d/collision/b2BroadPhase.js":{"path":"./src/box2d/collision/b2BroadPhase.js","friendlyPath":"..collision.b2BroadPhase","directory":"./src/box2d/collision/","filename":"b2BroadPhase.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\n\r\n\r\n\r\n/*\r\nThis broad phase uses the Sweep and Prune algorithm in:\r\nCollision Detection in Interactive 3D Environments by Gino van den Bergen\r\nAlso, some ideas, such integral values for fast compares comes from\r\nBullet (http:/www.bulletphysics.com).\r\n*/\r\n\r\n\r\n// Notes:\r\n// - we use bound arrays instead of linked lists for cache coherence.\r\n// - we use quantized integral values for fast compares.\r\n// - we use short indices rather than pointers to save memory.\r\n// - we use a stabbing count for fast overlap queries (less than order N).\r\n// - we also use a time stamp on each proxy to speed up the registration of\r\n//   overlap query results.\r\n// - where possible, we compare bound indices instead of values to reduce\r\n//   cache misses (TODO_ERIN).\r\n// - no broadphase is perfect and neither is this one: it is not great for huge\r\n//   worlds (use a multi-SAP instead), it is not great for large objects.\r\n\r\njsio(\"import ..common.b2Settings as b2Settings\");\r\njsio(\"import ..common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import ..common.math.b2Math as b2Math\");\r\n\r\njsio(\"import .b2Pair as b2Pair\");\r\njsio(\"import .b2PairManager as b2PairManager\");\r\njsio(\"import .b2Bound as b2Bound\");\r\njsio(\"import .b2Proxy as b2Proxy\");\r\njsio(\"import .b2BoundValues as b2BoundValues\");\r\n\r\n\r\nb2BroadPhase=__class__;var b2BroadPhase=b2BroadPhase(function b2BroadPhase(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\tthis.init = function(worldAABB, callback){\r\n\t\t// initialize instance variables for references\r\n\t\tthis.m_proxyCount = 0;\r\n\t\tthis.m_pairManager = new b2PairManager();\r\n\t\tthis.m_proxyPool = new Array(b2Settings.b2_maxPairs);\r\n\t\tthis.m_freeProxy = 0;\r\n\t\tthis.m_bounds = new Array(2*b2Settings.b2_maxProxies);\r\n\t\tthis.m_queryResults = new Array(b2Settings.b2_maxProxies);\r\n\t\tthis.m_quantizationFactor = new b2Vec2();\r\n\t\tthis.m_queryResultCount = 0;\r\n\t\tthis.m_timeStamp = 0;\r\n\r\n\r\n\t\t//b2Settings.b2Assert(worldAABB.IsValid());\r\n\t\tvar i = 0;\r\n\r\n\t\tthis.m_pairManager.Initialize(this, callback);\r\n\r\n\t\tthis.m_worldAABB = worldAABB;\r\n\r\n\r\n\t\t// query results\r\n\t\tfor (i = 0; i < b2Settings.b2_maxProxies; i++){\r\n\t\t\tthis.m_queryResults[i] = 0;\r\n\t\t}\r\n\r\n\t\t// bounds array\r\n\t\tthis.m_bounds = new Array(2);\r\n\t\tfor (i = 0; i < 2; i++){\r\n\t\t\tthis.m_bounds[i] = new Array(2*b2Settings.b2_maxProxies);\r\n\t\t\tfor (var j = 0; j < 2*b2Settings.b2_maxProxies; j++){\r\n\t\t\t\tthis.m_bounds[i][j] = new b2Bound();\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t//var d = b2Math.SubtractVV(worldAABB.maxVertex, worldAABB.minVertex);\r\n\t\tvar dX = worldAABB.maxVertex.x;\r\n\t\tvar dY = worldAABB.maxVertex.y;\r\n\t\tdX -= worldAABB.minVertex.x;\r\n\t\tdY -= worldAABB.minVertex.y;\r\n\r\n\t\tthis.m_quantizationFactor.x = b2Settings.USHRT_MAX / dX;\r\n\t\tthis.m_quantizationFactor.y = b2Settings.USHRT_MAX / dY;\r\n\r\n\t\tvar tProxy;\r\n\t\tfor (i = 0; i < b2Settings.b2_maxProxies - 1; ++i)\r\n\t\t{\r\n\t\t\ttProxy = new b2Proxy();\r\n\t\t\tthis.m_proxyPool[i] = tProxy;\r\n\t\t\ttProxy.SetNext(i + 1);\r\n\t\t\ttProxy.timeStamp = 0;\r\n\t\t\ttProxy.overlapCount = b2BroadPhase.b2_invalid;\r\n\t\t\ttProxy.userData = null;\r\n\t\t}\r\n\t\ttProxy = new b2Proxy();\r\n\t\tthis.m_proxyPool[b2Settings.b2_maxProxies-1] = tProxy;\r\n\t\ttProxy.SetNext(b2Pair.b2_nullProxy);\r\n\t\ttProxy.timeStamp = 0;\r\n\t\ttProxy.overlapCount = b2BroadPhase.b2_invalid;\r\n\t\ttProxy.userData = null;\r\n\t\tthis.m_freeProxy = 0;\r\n\r\n\t\tthis.m_timeStamp = 1;\r\n\t\tthis.m_queryResultCount = 0;\r\n\t};\r\n\r\n\t//~b2BroadPhase();\r\n\r\n\t// Use this to see if your proxy is in range. If it is not in range,\r\n\t// it should be destroyed. Otherwise you may get O(m^2) pairs, where m\r\n\t// is the number of proxies that are out of range.\r\n\tthis.InRange = function(aabb){\r\n\t\t//var d = b2Math.b2MaxV(b2Math.SubtractVV(aabb.minVertex, this.m_worldAABB.maxVertex), b2Math.SubtractVV(this.m_worldAABB.minVertex, aabb.maxVertex));\r\n\t\tvar dX;\r\n\t\tvar dY;\r\n\t\tvar d2X;\r\n\t\tvar d2Y;\r\n\r\n\t\tdX = aabb.minVertex.x;\r\n\t\tdY = aabb.minVertex.y;\r\n\t\tdX -= this.m_worldAABB.maxVertex.x;\r\n\t\tdY -= this.m_worldAABB.maxVertex.y;\r\n\r\n\t\td2X = this.m_worldAABB.minVertex.x;\r\n\t\td2Y = this.m_worldAABB.minVertex.y;\r\n\t\td2X -= aabb.maxVertex.x;\r\n\t\td2Y -= aabb.maxVertex.y;\r\n\r\n\t\tdX = b2Math.b2Max(dX, d2X);\r\n\t\tdY = b2Math.b2Max(dY, d2Y);\r\n\r\n\t\treturn b2Math.b2Max(dX, dY) < 0.0;\r\n\t};\r\n\r\n\t// Get a single proxy. Returns NULL if the id is invalid.\r\n\tthis.GetProxy = function(proxyId){\r\n\t\tif (proxyId == b2Pair.b2_nullProxy || this.m_proxyPool[proxyId].IsValid() == false)\r\n\t\t{\r\n\t\t\treturn null;\r\n\t\t}\r\n\r\n\t\treturn this.m_proxyPool[ proxyId ];\r\n\t};\r\n\r\n\t// Create and destroy proxies. These call Flush first.\r\n\tthis.CreateProxy = function(aabb, userData){\r\n\t\tvar index = 0;\r\n\t\tvar proxy;\r\n\r\n\t\t//b2Settings.b2Assert(this.m_proxyCount < b2_maxProxies);\r\n\t\t//b2Settings.b2Assert(this.m_freeProxy != b2Pair.b2_nullProxy);\r\n\r\n\t\tvar proxyId = this.m_freeProxy;\r\n\t\tproxy = this.m_proxyPool[ proxyId ];\r\n\t\tthis.m_freeProxy = proxy.GetNext();\r\n\r\n\t\tproxy.overlapCount = 0;\r\n\t\tproxy.userData = userData;\r\n\r\n\t\tvar boundCount = 2 * this.m_proxyCount;\r\n\r\n\t\tvar lowerValues = new Array();\r\n\t\tvar upperValues = new Array();\r\n\t\tthis.ComputeBounds(lowerValues, upperValues, aabb);\r\n\r\n\t\tfor (var axis = 0; axis < 2; ++axis)\r\n\t\t{\r\n\t\t\tvar bounds = this.m_bounds[axis];\r\n\t\t\tvar lowerIndex = 0;\r\n\t\t\tvar upperIndex = 0;\r\n\t\t\tvar lowerIndexOut = [lowerIndex];\r\n\t\t\tvar upperIndexOut = [upperIndex];\r\n\t\t\tthis.Query(lowerIndexOut, upperIndexOut, lowerValues[axis], upperValues[axis], bounds, boundCount, axis);\r\n\t\t\tlowerIndex = lowerIndexOut[0];\r\n\t\t\tupperIndex = upperIndexOut[0];\r\n\r\n\t\t\t// Replace memmove calls\r\n\t\t\t//memmove(bounds + upperIndex + 2, bounds + upperIndex, (edgeCount - upperIndex) * sizeof(b2Bound));\r\n\t\t\tvar tArr = new Array();\r\n\t\t\tvar j = 0;\r\n\t\t\tvar tEnd = boundCount - upperIndex\r\n\t\t\tvar tBound1;\r\n\t\t\tvar tBound2;\r\n\t\t\t// make temp array\r\n\t\t\tfor (j = 0; j < tEnd; j++){\r\n\t\t\t\ttArr[j] = new b2Bound();\r\n\t\t\t\ttBound1 = tArr[j];\r\n\t\t\t\ttBound2 = bounds[upperIndex+j];\r\n\t\t\t\ttBound1.value = tBound2.value;\r\n\t\t\t\ttBound1.proxyId = tBound2.proxyId;\r\n\t\t\t\ttBound1.stabbingCount = tBound2.stabbingCount;\r\n\t\t\t}\r\n\t\t\t// move temp array back in to bounds\r\n\t\t\ttEnd = tArr.length;\r\n\t\t\tvar tIndex = upperIndex+2;\r\n\t\t\tfor (j = 0; j < tEnd; j++){\r\n\t\t\t\t//bounds[tIndex+j] = tArr[j];\r\n\t\t\t\ttBound2 = tArr[j];\r\n\t\t\t\ttBound1 = bounds[tIndex+j]\r\n\t\t\t\ttBound1.value = tBound2.value;\r\n\t\t\t\ttBound1.proxyId = tBound2.proxyId;\r\n\t\t\t\ttBound1.stabbingCount = tBound2.stabbingCount;\r\n\t\t\t}\r\n\t\t\t//memmove(bounds + lowerIndex + 1, bounds + lowerIndex, (upperIndex - lowerIndex) * sizeof(b2Bound));\r\n\t\t\t// make temp array\r\n\t\t\ttArr = new Array();\r\n\t\t\ttEnd = upperIndex - lowerIndex;\r\n\t\t\tfor (j = 0; j < tEnd; j++){\r\n\t\t\t\ttArr[j] = new b2Bound();\r\n\t\t\t\ttBound1 = tArr[j];\r\n\t\t\t\ttBound2 = bounds[lowerIndex+j];\r\n\t\t\t\ttBound1.value = tBound2.value;\r\n\t\t\t\ttBound1.proxyId = tBound2.proxyId;\r\n\t\t\t\ttBound1.stabbingCount = tBound2.stabbingCount;\r\n\t\t\t}\r\n\t\t\t// move temp array back in to bounds\r\n\t\t\ttEnd = tArr.length;\r\n\t\t\ttIndex = lowerIndex+1;\r\n\t\t\tfor (j = 0; j < tEnd; j++){\r\n\t\t\t\t//bounds[tIndex+j] = tArr[j];\r\n\t\t\t\ttBound2 = tArr[j];\r\n\t\t\t\ttBound1 = bounds[tIndex+j]\r\n\t\t\t\ttBound1.value = tBound2.value;\r\n\t\t\t\ttBound1.proxyId = tBound2.proxyId;\r\n\t\t\t\ttBound1.stabbingCount = tBound2.stabbingCount;\r\n\t\t\t}\r\n\r\n\t\t\t// The upper index has increased because of the lower bound insertion.\r\n\t\t\t++upperIndex;\r\n\r\n\t\t\t// Copy in the new bounds.\r\n\t\t\tbounds[lowerIndex].value = lowerValues[axis];\r\n\t\t\tbounds[lowerIndex].proxyId = proxyId;\r\n\t\t\tbounds[upperIndex].value = upperValues[axis];\r\n\t\t\tbounds[upperIndex].proxyId = proxyId;\r\n\r\n\t\t\tbounds[lowerIndex].stabbingCount = lowerIndex == 0 ? 0 : bounds[lowerIndex-1].stabbingCount;\r\n\t\t\tbounds[upperIndex].stabbingCount = bounds[upperIndex-1].stabbingCount;\r\n\r\n\t\t\t// Adjust the stabbing count between the new bounds.\r\n\t\t\tfor (index = lowerIndex; index < upperIndex; ++index)\r\n\t\t\t{\r\n\t\t\t\tbounds[index].stabbingCount++;\r\n\t\t\t}\r\n\r\n\t\t\t// Adjust the all the affected bound indices.\r\n\t\t\tfor (index = lowerIndex; index < boundCount + 2; ++index)\r\n\t\t\t{\r\n\t\t\t\tvar proxy2 = this.m_proxyPool[ bounds[index].proxyId ];\r\n\t\t\t\tif (bounds[index].IsLower())\r\n\t\t\t\t{\r\n\t\t\t\t\tproxy2.lowerBounds[axis] = index;\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tproxy2.upperBounds[axis] = index;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t++this.m_proxyCount;\r\n\r\n\t\t//b2Settings.b2Assert(this.m_queryResultCount < b2Settings.b2_maxProxies);\r\n\r\n\t\tfor (var i = 0; i < this.m_queryResultCount; ++i)\r\n\t\t{\r\n\t\t\t//b2Settings.b2Assert(this.m_queryResults[i] < b2_maxProxies);\r\n\t\t\t//b2Settings.b2Assert(this.m_proxyPool[this.m_queryResults[i]].IsValid());\r\n\r\n\t\t\tthis.m_pairManager.AddBufferedPair(proxyId, this.m_queryResults[i]);\r\n\t\t}\r\n\r\n\t\tthis.m_pairManager.Commit();\r\n\r\n\t\t// Prepare for next query.\r\n\t\tthis.m_queryResultCount = 0;\r\n\t\tthis.IncrementTimeStamp();\r\n\r\n\t\treturn proxyId;\r\n\t};\r\n\r\n\tthis.DestroyProxy = function(proxyId){\r\n\r\n\t\t//b2Settings.b2Assert(0 < this.m_proxyCount && this.m_proxyCount <= b2_maxProxies);\r\n\r\n\t\tvar proxy = this.m_proxyPool[ proxyId ];\r\n\t\t//b2Settings.b2Assert(proxy.IsValid());\r\n\r\n\t\tvar boundCount = 2 * this.m_proxyCount;\r\n\r\n\t\tfor (var axis = 0; axis < 2; ++axis)\r\n\t\t{\r\n\t\t\tvar bounds = this.m_bounds[axis];\r\n\r\n\t\t\tvar lowerIndex = proxy.lowerBounds[axis];\r\n\t\t\tvar upperIndex = proxy.upperBounds[axis];\r\n\t\t\tvar lowerValue = bounds[lowerIndex].value;\r\n\t\t\tvar upperValue = bounds[upperIndex].value;\r\n\r\n\t\t\t// replace memmove calls\r\n\t\t\t//memmove(bounds + lowerIndex, bounds + lowerIndex + 1, (upperIndex - lowerIndex - 1) * sizeof(b2Bound));\r\n\t\t\tvar tArr = new Array();\r\n\t\t\tvar j = 0;\r\n\t\t\tvar tEnd = upperIndex - lowerIndex - 1;\r\n\t\t\tvar tBound1;\r\n\t\t\tvar tBound2;\r\n\t\t\t// make temp array\r\n\t\t\tfor (j = 0; j < tEnd; j++){\r\n\t\t\t\ttArr[j] = new b2Bound();\r\n\t\t\t\ttBound1 = tArr[j];\r\n\t\t\t\ttBound2 = bounds[lowerIndex+1+j];\r\n\t\t\t\ttBound1.value = tBound2.value;\r\n\t\t\t\ttBound1.proxyId = tBound2.proxyId;\r\n\t\t\t\ttBound1.stabbingCount = tBound2.stabbingCount;\r\n\t\t\t}\r\n\t\t\t// move temp array back in to bounds\r\n\t\t\ttEnd = tArr.length;\r\n\t\t\tvar tIndex = lowerIndex;\r\n\t\t\tfor (j = 0; j < tEnd; j++){\r\n\t\t\t\t//bounds[tIndex+j] = tArr[j];\r\n\t\t\t\ttBound2 = tArr[j];\r\n\t\t\t\ttBound1 = bounds[tIndex+j]\r\n\t\t\t\ttBound1.value = tBound2.value;\r\n\t\t\t\ttBound1.proxyId = tBound2.proxyId;\r\n\t\t\t\ttBound1.stabbingCount = tBound2.stabbingCount;\r\n\t\t\t}\r\n\t\t\t//memmove(bounds + upperIndex-1, bounds + upperIndex + 1, (edgeCount - upperIndex - 1) * sizeof(b2Bound));\r\n\t\t\t// make temp array\r\n\t\t\ttArr = new Array();\r\n\t\t\ttEnd = boundCount - upperIndex - 1;\r\n\t\t\tfor (j = 0; j < tEnd; j++){\r\n\t\t\t\ttArr[j] = new b2Bound();\r\n\t\t\t\ttBound1 = tArr[j];\r\n\t\t\t\ttBound2 = bounds[upperIndex+1+j];\r\n\t\t\t\ttBound1.value = tBound2.value;\r\n\t\t\t\ttBound1.proxyId = tBound2.proxyId;\r\n\t\t\t\ttBound1.stabbingCount = tBound2.stabbingCount;\r\n\t\t\t}\r\n\t\t\t// move temp array back in to bounds\r\n\t\t\ttEnd = tArr.length;\r\n\t\t\ttIndex = upperIndex-1;\r\n\t\t\tfor (j = 0; j < tEnd; j++){\r\n\t\t\t\t//bounds[tIndex+j] = tArr[j];\r\n\t\t\t\ttBound2 = tArr[j];\r\n\t\t\t\ttBound1 = bounds[tIndex+j]\r\n\t\t\t\ttBound1.value = tBound2.value;\r\n\t\t\t\ttBound1.proxyId = tBound2.proxyId;\r\n\t\t\t\ttBound1.stabbingCount = tBound2.stabbingCount;\r\n\t\t\t}\r\n\r\n\t\t\t// Fix bound indices.\r\n\t\t\ttEnd = boundCount - 2;\r\n\t\t\tfor (var index = lowerIndex; index < tEnd; ++index)\r\n\t\t\t{\r\n\t\t\t\tvar proxy2 = this.m_proxyPool[ bounds[index].proxyId ];\r\n\t\t\t\tif (bounds[index].IsLower())\r\n\t\t\t\t{\r\n\t\t\t\t\tproxy2.lowerBounds[axis] = index;\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tproxy2.upperBounds[axis] = index;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// Fix stabbing count.\r\n\t\t\ttEnd = upperIndex - 1;\r\n\t\t\tfor (var index2 = lowerIndex; index2 < tEnd; ++index2)\r\n\t\t\t{\r\n\t\t\t\tbounds[index2].stabbingCount--;\r\n\t\t\t}\r\n\r\n\t\t\t// this.Query for pairs to be removed. lowerIndex and upperIndex are not needed.\r\n\t\t\t// make lowerIndex and upper output using an array and do this for others if compiler doesn't pick them up\r\n\t\t\tthis.Query([0], [0], lowerValue, upperValue, bounds, boundCount - 2, axis);\r\n\t\t}\r\n\r\n\t\t//b2Settings.b2Assert(this.m_queryResultCount < b2Settings.b2_maxProxies);\r\n\r\n\t\tfor (var i = 0; i < this.m_queryResultCount; ++i)\r\n\t\t{\r\n\t\t\t//b2Settings.b2Assert(this.m_proxyPool[this.m_queryResults[i]].IsValid());\r\n\r\n\t\t\tthis.m_pairManager.RemoveBufferedPair(proxyId, this.m_queryResults[i]);\r\n\t\t}\r\n\r\n\t\tthis.m_pairManager.Commit();\r\n\r\n\t\t// Prepare for next query.\r\n\t\tthis.m_queryResultCount = 0;\r\n\t\tthis.IncrementTimeStamp();\r\n\r\n\t\t// Return the proxy to the pool.\r\n\t\tproxy.userData = null;\r\n\t\tproxy.overlapCount = b2BroadPhase.b2_invalid;\r\n\t\tproxy.lowerBounds[0] = b2BroadPhase.b2_invalid;\r\n\t\tproxy.lowerBounds[1] = b2BroadPhase.b2_invalid;\r\n\t\tproxy.upperBounds[0] = b2BroadPhase.b2_invalid;\r\n\t\tproxy.upperBounds[1] = b2BroadPhase.b2_invalid;\r\n\r\n\t\tproxy.SetNext(this.m_freeProxy);\r\n\t\tthis.m_freeProxy = proxyId;\r\n\t\t--this.m_proxyCount;\r\n\t};\r\n\r\n\r\n\t// Call this.MoveProxy times like, then when you are done\r\n\t// call this.Commit to finalized the proxy pairs (for your time step).\r\n\tthis.MoveProxy = function(proxyId, aabb){\r\n\t\tvar axis = 0;\r\n\t\tvar index = 0;\r\n\t\tvar bound;\r\n\t\tvar prevBound\r\n\t\tvar nextBound\r\n\t\tvar nextProxyId = 0;\r\n\t\tvar nextProxy;\r\n\r\n\t\tif (proxyId == b2Pair.b2_nullProxy || b2Settings.b2_maxProxies <= proxyId)\r\n\t\t{\r\n\t\t\t//b2Settings.b2Assert(false);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (aabb.IsValid() == false)\r\n\t\t{\r\n\t\t\t//b2Settings.b2Assert(false);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tvar boundCount = 2 * this.m_proxyCount;\r\n\r\n\t\tvar proxy = this.m_proxyPool[ proxyId ];\r\n\t\t// Get new bound values\r\n\t\tvar newValues = new b2BoundValues();\r\n\t\tthis.ComputeBounds(newValues.lowerValues, newValues.upperValues, aabb);\r\n\r\n\t\t// Get old bound values\r\n\t\tvar oldValues = new b2BoundValues();\r\n\t\tfor (axis = 0; axis < 2; ++axis)\r\n\t\t{\r\n\t\t\toldValues.lowerValues[axis] = this.m_bounds[axis][proxy.lowerBounds[axis]].value;\r\n\t\t\toldValues.upperValues[axis] = this.m_bounds[axis][proxy.upperBounds[axis]].value;\r\n\t\t}\r\n\r\n\t\tfor (axis = 0; axis < 2; ++axis)\r\n\t\t{\r\n\t\t\tvar bounds = this.m_bounds[axis];\r\n\r\n\t\t\tvar lowerIndex = proxy.lowerBounds[axis];\r\n\t\t\tvar upperIndex = proxy.upperBounds[axis];\r\n\r\n\t\t\tvar lowerValue = newValues.lowerValues[axis];\r\n\t\t\tvar upperValue = newValues.upperValues[axis];\r\n\r\n\t\t\tvar deltaLower = lowerValue - bounds[lowerIndex].value;\r\n\t\t\tvar deltaUpper = upperValue - bounds[upperIndex].value;\r\n\r\n\t\t\tbounds[lowerIndex].value = lowerValue;\r\n\t\t\tbounds[upperIndex].value = upperValue;\r\n\r\n\t\t\t//\r\n\t\t\t// Expanding adds overlaps\r\n\t\t\t//\r\n\r\n\t\t\t// Should we move the lower bound down?\r\n\t\t\tif (deltaLower < 0)\r\n\t\t\t{\r\n\t\t\t\tindex = lowerIndex;\r\n\t\t\t\twhile (index > 0 && lowerValue < bounds[index-1].value)\r\n\t\t\t\t{\r\n\t\t\t\t\tbound = bounds[index];\r\n\t\t\t\t\tprevBound = bounds[index - 1];\r\n\r\n\t\t\t\t\tvar prevProxyId = prevBound.proxyId;\r\n\t\t\t\t\tvar prevProxy = this.m_proxyPool[ prevBound.proxyId ];\r\n\r\n\t\t\t\t\tprevBound.stabbingCount++;\r\n\r\n\t\t\t\t\tif (prevBound.IsUpper() == true)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif (this.TestOverlap(newValues, prevProxy))\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tthis.m_pairManager.AddBufferedPair(proxyId, prevProxyId);\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tprevProxy.upperBounds[axis]++;\r\n\t\t\t\t\t\tbound.stabbingCount++;\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tprevProxy.lowerBounds[axis]++;\r\n\t\t\t\t\t\tbound.stabbingCount--;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tproxy.lowerBounds[axis]--;\r\n\r\n\t\t\t\t\t// swap\r\n\t\t\t\t\t//var temp = bound;\r\n\t\t\t\t\t//bound = prevEdge;\r\n\t\t\t\t\t//prevEdge = temp;\r\n\t\t\t\t\tbound.Swap(prevBound);\r\n\t\t\t\t\t//b2Math.b2Swap(bound, prevEdge);\r\n\t\t\t\t\t--index;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// Should we move the upper bound up?\r\n\t\t\tif (deltaUpper > 0)\r\n\t\t\t{\r\n\t\t\t\tindex = upperIndex;\r\n\t\t\t\twhile (index < boundCount-1 && bounds[index+1].value <= upperValue)\r\n\t\t\t\t{\r\n\t\t\t\t\tbound = bounds[ index ];\r\n\t\t\t\t\tnextBound = bounds[ index + 1 ];\r\n\t\t\t\t\tnextProxyId = nextBound.proxyId;\r\n\t\t\t\t\tnextProxy = this.m_proxyPool[ nextProxyId ];\r\n\r\n\t\t\t\t\tnextBound.stabbingCount++;\r\n\r\n\t\t\t\t\tif (nextBound.IsLower() == true)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif (this.TestOverlap(newValues, nextProxy))\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tthis.m_pairManager.AddBufferedPair(proxyId, nextProxyId);\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tnextProxy.lowerBounds[axis]--;\r\n\t\t\t\t\t\tbound.stabbingCount++;\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tnextProxy.upperBounds[axis]--;\r\n\t\t\t\t\t\tbound.stabbingCount--;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tproxy.upperBounds[axis]++;\r\n\t\t\t\t\t// swap\r\n\t\t\t\t\t//var temp = bound;\r\n\t\t\t\t\t//bound = nextEdge;\r\n\t\t\t\t\t//nextEdge = temp;\r\n\t\t\t\t\tbound.Swap(nextBound);\r\n\t\t\t\t\t//b2Math.b2Swap(bound, nextEdge);\r\n\t\t\t\t\tindex++;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t//\r\n\t\t\t// Shrinking removes overlaps\r\n\t\t\t//\r\n\r\n\t\t\t// Should we move the lower bound up?\r\n\t\t\tif (deltaLower > 0)\r\n\t\t\t{\r\n\t\t\t\tindex = lowerIndex;\r\n\t\t\t\twhile (index < boundCount-1 && bounds[index+1].value <= lowerValue)\r\n\t\t\t\t{\r\n\t\t\t\t\tbound = bounds[ index ];\r\n\t\t\t\t\tnextBound = bounds[ index + 1 ];\r\n\r\n\t\t\t\t\tnextProxyId = nextBound.proxyId;\r\n\t\t\t\t\tnextProxy = this.m_proxyPool[ nextProxyId ];\r\n\r\n\t\t\t\t\tnextBound.stabbingCount--;\r\n\r\n\t\t\t\t\tif (nextBound.IsUpper())\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif (this.TestOverlap(oldValues, nextProxy))\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tthis.m_pairManager.RemoveBufferedPair(proxyId, nextProxyId);\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tnextProxy.upperBounds[axis]--;\r\n\t\t\t\t\t\tbound.stabbingCount--;\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tnextProxy.lowerBounds[axis]--;\r\n\t\t\t\t\t\tbound.stabbingCount++;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tproxy.lowerBounds[axis]++;\r\n\t\t\t\t\t// swap\r\n\t\t\t\t\t//var temp = bound;\r\n\t\t\t\t\t//bound = nextEdge;\r\n\t\t\t\t\t//nextEdge = temp;\r\n\t\t\t\t\tbound.Swap(nextBound);\r\n\t\t\t\t\t//b2Math.b2Swap(bound, nextEdge);\r\n\t\t\t\t\tindex++;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// Should we move the upper bound down?\r\n\t\t\tif (deltaUpper < 0)\r\n\t\t\t{\r\n\t\t\t\tindex = upperIndex;\r\n\t\t\t\twhile (index > 0 && upperValue < bounds[index-1].value)\r\n\t\t\t\t{\r\n\t\t\t\t\tbound = bounds[index];\r\n\t\t\t\t\tprevBound = bounds[index - 1];\r\n\r\n\t\t\t\t\tprevProxyId = prevBound.proxyId;\r\n\t\t\t\t\tprevProxy = this.m_proxyPool[ prevProxyId ];\r\n\r\n\t\t\t\t\tprevBound.stabbingCount--;\r\n\r\n\t\t\t\t\tif (prevBound.IsLower() == true)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif (this.TestOverlap(oldValues, prevProxy))\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tthis.m_pairManager.RemoveBufferedPair(proxyId, prevProxyId);\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tprevProxy.lowerBounds[axis]++;\r\n\t\t\t\t\t\tbound.stabbingCount--;\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tprevProxy.upperBounds[axis]++;\r\n\t\t\t\t\t\tbound.stabbingCount++;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tproxy.upperBounds[axis]--;\r\n\t\t\t\t\t// swap\r\n\t\t\t\t\t//var temp = bound;\r\n\t\t\t\t\t//bound = prevEdge;\r\n\t\t\t\t\t//prevEdge = temp;\r\n\t\t\t\t\tbound.Swap(prevBound);\r\n\t\t\t\t\t//b2Math.b2Swap(bound, prevEdge);\r\n\t\t\t\t\tindex--;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\tthis.Commit = function() {\r\n\t\tthis.m_pairManager.Commit();\r\n\t};\r\n\r\n\t// this.Query an AABB for overlapping proxies, returns the user data and\r\n\t// the count, up to the supplied maximum count.\r\n\tthis.QueryAABB = function(aabb, userData, maxCount) {\r\n\t\tvar lowerValues = new Array();\r\n\t\tvar upperValues = new Array();\r\n\t\tthis.ComputeBounds(lowerValues, upperValues, aabb);\r\n\r\n\t\tvar lowerIndex = 0;\r\n\t\tvar upperIndex = 0;\r\n\t\tvar lowerIndexOut = [lowerIndex];\r\n\t\tvar upperIndexOut = [upperIndex];\r\n\t\tthis.Query(lowerIndexOut, upperIndexOut, lowerValues[0], upperValues[0], this.m_bounds[0], 2*this.m_proxyCount, 0);\r\n\t\tthis.Query(lowerIndexOut, upperIndexOut, lowerValues[1], upperValues[1], this.m_bounds[1], 2*this.m_proxyCount, 1);\r\n\r\n\t\t//b2Settings.b2Assert(this.m_queryResultCount < b2Settings.b2_maxProxies);\r\n\r\n\t\tvar count = 0;\r\n\t\tfor (var i = 0; i < this.m_queryResultCount && count < maxCount; ++i, ++count)\r\n\t\t{\r\n\t\t\t//b2Settings.b2Assert(this.m_queryResults[i] < b2Settings.b2_maxProxies);\r\n\t\t\tvar proxy = this.m_proxyPool[ this.m_queryResults[i] ];\r\n\t\t\t//b2Settings.b2Assert(proxy.IsValid());\r\n\t\t\tuserData[i] = proxy.userData;\r\n\t\t}\r\n\r\n\t\t// Prepare for next query.\r\n\t\tthis.m_queryResultCount = 0;\r\n\t\tthis.IncrementTimeStamp();\r\n\r\n\t\treturn count;\r\n\t},\r\n\r\n\tthis.Validate = function(){\r\n\t\tvar pair;\r\n\t\tvar proxy1;\r\n\t\tvar proxy2;\r\n\t\tvar overlap;\r\n\r\n\t\tfor (var axis = 0; axis < 2; ++axis)\r\n\t\t{\r\n\t\t\tvar bounds = this.m_bounds[axis];\r\n\r\n\t\t\tvar boundCount = 2 * this.m_proxyCount;\r\n\t\t\tvar stabbingCount = 0;\r\n\r\n\t\t\tfor (var i = 0; i < boundCount; ++i)\r\n\t\t\t{\r\n\t\t\t\tvar bound = bounds[i];\r\n\t\t\t\t//b2Settings.b2Assert(i == 0 || bounds[i-1].value <= bound->value);\r\n\t\t\t\t//b2Settings.b2Assert(bound->proxyId != b2_nullProxy);\r\n\t\t\t\t//b2Settings.b2Assert(this.m_proxyPool[bound->proxyId].IsValid());\r\n\r\n\t\t\t\tif (bound.IsLower() == true)\r\n\t\t\t\t{\r\n\t\t\t\t\t//b2Settings.b2Assert(this.m_proxyPool[bound.proxyId].lowerBounds[axis] == i);\r\n\t\t\t\t\tstabbingCount++;\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t//b2Settings.b2Assert(this.m_proxyPool[bound.proxyId].upperBounds[axis] == i);\r\n\t\t\t\t\tstabbingCount--;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t//b2Settings.b2Assert(bound.stabbingCount == stabbingCount);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t};\r\n\r\n//private:\r\n\tthis.ComputeBounds = function(lowerValues, upperValues, aabb)\r\n\t{\r\n\t\t//b2Settings.b2Assert(aabb.maxVertex.x > aabb.minVertex.x);\r\n\t\t//b2Settings.b2Assert(aabb.maxVertex.y > aabb.minVertex.y);\r\n\r\n\t\t//var minVertex = b2Math.b2ClampV(aabb.minVertex, this.m_worldAABB.minVertex, this.m_worldAABB.maxVertex);\r\n\t\tvar minVertexX = aabb.minVertex.x;\r\n\t\tvar minVertexY = aabb.minVertex.y;\r\n\t\tminVertexX = b2Math.b2Min(minVertexX, this.m_worldAABB.maxVertex.x);\r\n\t\tminVertexY = b2Math.b2Min(minVertexY, this.m_worldAABB.maxVertex.y);\r\n\t\tminVertexX = b2Math.b2Max(minVertexX, this.m_worldAABB.minVertex.x);\r\n\t\tminVertexY = b2Math.b2Max(minVertexY, this.m_worldAABB.minVertex.y);\r\n\r\n\t\t//var maxVertex = b2Math.b2ClampV(aabb.maxVertex, this.m_worldAABB.minVertex, this.m_worldAABB.maxVertex);\r\n\t\tvar maxVertexX = aabb.maxVertex.x;\r\n\t\tvar maxVertexY = aabb.maxVertex.y;\r\n\t\tmaxVertexX = b2Math.b2Min(maxVertexX, this.m_worldAABB.maxVertex.x);\r\n\t\tmaxVertexY = b2Math.b2Min(maxVertexY, this.m_worldAABB.maxVertex.y);\r\n\t\tmaxVertexX = b2Math.b2Max(maxVertexX, this.m_worldAABB.minVertex.x);\r\n\t\tmaxVertexY = b2Math.b2Max(maxVertexY, this.m_worldAABB.minVertex.y);\r\n\r\n\t\t// Bump lower bounds downs and upper bounds up. This ensures correct sorting of\r\n\t\t// lower/upper bounds that would have equal values.\r\n\t\t// TODO_ERIN implement fast float to uint16 conversion.\r\n\t\tlowerValues[0] = /*uint*/(this.m_quantizationFactor.x * (minVertexX - this.m_worldAABB.minVertex.x)) & (b2Settings.USHRT_MAX - 1);\r\n\t\tupperValues[0] = (/*uint*/(this.m_quantizationFactor.x * (maxVertexX - this.m_worldAABB.minVertex.x))& 0x0000ffff) | 1;\r\n\r\n\t\tlowerValues[1] = /*uint*/(this.m_quantizationFactor.y * (minVertexY - this.m_worldAABB.minVertex.y)) & (b2Settings.USHRT_MAX - 1);\r\n\t\tupperValues[1] = (/*uint*/(this.m_quantizationFactor.y * (maxVertexY - this.m_worldAABB.minVertex.y))& 0x0000ffff) | 1;\r\n\t};\r\n\r\n\t// This one is only used for validation.\r\n\tthis.TestOverlapValidate = function(p1, p2){\r\n\r\n\t\tfor (var axis = 0; axis < 2; ++axis)\r\n\t\t{\r\n\t\t\tvar bounds = this.m_bounds[axis];\r\n\r\n\t\t\t//b2Settings.b2Assert(p1.lowerBounds[axis] < 2 * this.m_proxyCount);\r\n\t\t\t//b2Settings.b2Assert(p1.upperBounds[axis] < 2 * this.m_proxyCount);\r\n\t\t\t//b2Settings.b2Assert(p2.lowerBounds[axis] < 2 * this.m_proxyCount);\r\n\t\t\t//b2Settings.b2Assert(p2.upperBounds[axis] < 2 * this.m_proxyCount);\r\n\r\n\t\t\tif (bounds[p1.lowerBounds[axis]].value > bounds[p2.upperBounds[axis]].value)\r\n\t\t\t\treturn false;\r\n\r\n\t\t\tif (bounds[p1.upperBounds[axis]].value < bounds[p2.lowerBounds[axis]].value)\r\n\t\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\treturn true;\r\n\t};\r\n\r\n\tthis.TestOverlap = function(b, p)\r\n\t{\r\n\t\tfor (var axis = 0; axis < 2; ++axis)\r\n\t\t{\r\n\t\t\tvar bounds = this.m_bounds[axis];\r\n\r\n\t\t\t//b2Settings.b2Assert(p.lowerBounds[axis] < 2 * this.m_proxyCount);\r\n\t\t\t//b2Settings.b2Assert(p.upperBounds[axis] < 2 * this.m_proxyCount);\r\n\r\n\t\t\tif (b.lowerValues[axis] > bounds[p.upperBounds[axis]].value)\r\n\t\t\t\treturn false;\r\n\r\n\t\t\tif (b.upperValues[axis] < bounds[p.lowerBounds[axis]].value)\r\n\t\t\t\treturn false;\r\n\t\t}\r\n\r\n\t\treturn true;\r\n\t};\r\n\r\n\tthis.Query = function(lowerQueryOut, upperQueryOut, lowerValue, upperValue, bounds, boundCount, axis){\r\n\r\n\t\tvar lowerQuery = b2BroadPhase.BinarySearch(bounds, boundCount, lowerValue);\r\n\t\tvar upperQuery = b2BroadPhase.BinarySearch(bounds, boundCount, upperValue);\r\n\r\n\t\t// Easy case: lowerQuery <= lowerIndex(i) < upperQuery\r\n\t\t// Solution: search query range for min bounds.\r\n\t\tfor (var j = lowerQuery; j < upperQuery; ++j)\r\n\t\t{\r\n\t\t\tif (bounds[j].IsLower())\r\n\t\t\t{\r\n\t\t\t\tthis.IncrementOverlapCount(bounds[j].proxyId);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Hard case: lowerIndex(i) < lowerQuery < upperIndex(i)\r\n\t\t// Solution: use the stabbing count to search down the bound array.\r\n\t\tif (lowerQuery > 0)\r\n\t\t{\r\n\t\t\tvar i = lowerQuery - 1;\r\n\t\t\tvar s = bounds[i].stabbingCount;\r\n\r\n\t\t\t// Find the s overlaps.\r\n\t\t\twhile (s)\r\n\t\t\t{\r\n\t\t\t\t//b2Settings.b2Assert(i >= 0);\r\n\r\n\t\t\t\tif (bounds[i].IsLower())\r\n\t\t\t\t{\r\n\t\t\t\t\tvar proxy = this.m_proxyPool[ bounds[i].proxyId ];\r\n\t\t\t\t\tif (lowerQuery <= proxy.upperBounds[axis])\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tthis.IncrementOverlapCount(bounds[i].proxyId);\r\n\t\t\t\t\t\t--s;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t--i;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tlowerQueryOut[0] = lowerQuery;\r\n\t\tupperQueryOut[0] = upperQuery;\r\n\t};\r\n\r\n\r\n\tthis.IncrementOverlapCount = function(proxyId){\r\n\t\tvar proxy = this.m_proxyPool[ proxyId ];\r\n\t\tif (proxy.timeStamp < this.m_timeStamp)\r\n\t\t{\r\n\t\t\tproxy.timeStamp = this.m_timeStamp;\r\n\t\t\tproxy.overlapCount = 1;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tproxy.overlapCount = 2;\r\n\t\t\t//b2Settings.b2Assert(this.m_queryResultCount < b2Settings.b2_maxProxies);\r\n\t\t\tthis.m_queryResults[this.m_queryResultCount] = proxyId;\r\n\t\t\t++this.m_queryResultCount;\r\n\t\t}\r\n\t};\r\n\tthis.IncrementTimeStamp = function(){\r\n\t\tif (this.m_timeStamp == b2Settings.USHRT_MAX)\r\n\t\t{\r\n\t\t\tfor (var i = 0; i < b2Settings.b2_maxProxies; ++i)\r\n\t\t\t{\r\n\t\t\t\tthis.m_proxyPool[i].timeStamp = 0;\r\n\t\t\t}\r\n\t\t\tthis.m_timeStamp = 1;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t++this.m_timeStamp;\r\n\t\t}\r\n\t};\r\n});\r\n\r\nb2BroadPhase.s_validate = false;\r\nb2BroadPhase.b2_invalid = b2Settings.USHRT_MAX;\r\nb2BroadPhase.b2_nullEdge = b2Settings.USHRT_MAX;\r\n\r\nb2BroadPhase.BinarySearch = function(bounds, count, value)\r\n{\r\n\tvar low = 0;\r\n\tvar high = count - 1;\r\n\twhile (low <= high)\r\n\t{\r\n\t\tvar mid = Math.floor((low + high) / 2);\r\n\t\tif (bounds[mid].value > value)\r\n\t\t{\r\n\t\t\thigh = mid - 1;\r\n\t\t}\r\n\t\telse if (bounds[mid].value < value)\r\n\t\t{\r\n\t\t\tlow = mid + 1;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\treturn /*uint*/(mid);\r\n\t\t}\r\n\t}\r\n\r\n\treturn /*uint*/(low);\r\n};\r\n\r\nexports = b2BroadPhase;\r\n","pre":true},"./src/box2d/collision/b2PairManager.js":{"path":"./src/box2d/collision/b2PairManager.js","friendlyPath":".b2PairManager","directory":"./src/box2d/collision/","filename":"b2PairManager.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n// The pair manager is used by the broad-phase to quickly add/remove/find pairs\r\n// of overlapping proxies. It is based closely on code provided by Pierre Terdiman.\r\n// http:\r\n\r\n\r\njsio(\"import .b2BroadPhase as b2BroadPhase\");\r\njsio(\"import .b2BufferedPair as b2BufferedPair\");\r\njsio(\"import .b2Pair as .b2Pair\");\r\njsio(\"import ..common.b2Settings as b2Settings\");\r\n\r\n\r\nb2PairManager=__class__;var b2PairManager=b2PairManager(function b2PairManager(){return this.init&&this.init.apply(this,arguments)},function() {\r\n//public:\r\n\tthis.init = function(){\r\n\t\tthis.m_broadPhase = null;\r\n\t\tthis.m_callback = null;\r\n\t\tthis.m_pairs = null;\r\n\t\tthis.m_freePair = 0;\r\n\t\tthis.m_pairCount = 0;\r\n\r\n\t\tthis.m_pairBuffer = null;\r\n\t\tthis.m_pairBufferCount = 0;\r\n\r\n\t\tthis.m_hashTable = null;\r\n\r\n\t\tvar i = 0;\r\n\t\t//b2Settings.b2Assert(b2Math.b2IsPowerOfTwo(b2Pair.b2_tableCapacity) == true);\r\n\t\t//b2Settings.b2Assert(b2Pair.b2_tableCapacity >= b2Settings.b2_maxPairs);\r\n\t\tthis.m_hashTable = new Array(b2Pair.b2_tableCapacity);\r\n\t\tfor (i = 0; i < b2Pair.b2_tableCapacity; ++i)\r\n\t\t{\r\n\t\t\tthis.m_hashTable[i] = b2Pair.b2_nullPair;\r\n\t\t}\r\n\t\tthis.m_pairs = new Array(b2Settings.b2_maxPairs);\r\n\t\tfor (i = 0; i < b2Settings.b2_maxPairs; ++i)\r\n\t\t{\r\n\t\t\tthis.m_pairs[i] = new b2Pair();\r\n\t\t}\r\n\t\tthis.m_pairBuffer = new Array(b2Settings.b2_maxPairs);\r\n\t\tfor (i = 0; i < b2Settings.b2_maxPairs; ++i)\r\n\t\t{\r\n\t\t\tthis.m_pairBuffer[i] = new b2BufferedPair();\r\n\t\t}\r\n\r\n\t\tfor (i = 0; i < b2Settings.b2_maxPairs; ++i)\r\n\t\t{\r\n\t\t\tthis.m_pairs[i].proxyId1 = b2Pair.b2_nullProxy;\r\n\t\t\tthis.m_pairs[i].proxyId2 = b2Pair.b2_nullProxy;\r\n\t\t\tthis.m_pairs[i].userData = null;\r\n\t\t\tthis.m_pairs[i].status = 0;\r\n\t\t\tthis.m_pairs[i].next = (i + 1);\r\n\t\t}\r\n\t\tthis.m_pairs[b2Settings.b2_maxPairs-1].next = b2Pair.b2_nullPair;\r\n\t\tthis.m_pairCount = 0;\r\n\t};\r\n\t//~b2PairManager();\r\n\r\n\tthis.Initialize = function(broadPhase, callback){\r\n\t\tthis.m_broadPhase = broadPhase;\r\n\t\tthis.m_callback = callback;\r\n\t};\r\n\r\n\t/*\r\n\tAs proxies are created and moved, many pairs are created and destroyed. Even worse, the same\r\n\tpair may be added and removed multiple times in a single time step of the physics engine. To reduce\r\n\ttraffic in the pair manager, we try to avoid destroying pairs in the pair manager until the\r\n\tend of the physics step. This is done by buffering all the this.RemovePair requests. this.AddPair\r\n\trequests are processed immediately because we need the hash table entry for quick lookup.\r\n\r\n\tAll user user callbacks are delayed until the buffered pairs are confirmed in this.Commit.\r\n\tThis is very important because the user callbacks may be very expensive and client logic\r\n\tmay be harmed if pairs are added and removed within the same time step.\r\n\r\n\tBuffer a pair for addition.\r\n\tWe may add a pair that is not in the pair manager or pair buffer.\r\n\tWe may add a pair that is already in the pair manager and pair buffer.\r\n\tIf the added pair is not a new pair, then it must be in the pair buffer (because this.RemovePair was called).\r\n\t*/\r\n\tthis.AddBufferedPair = function(proxyId1, proxyId2){\r\n\t\t//b2Settings.b2Assert(id1 != b2_nullProxy && id2 != b2_nullProxy);\r\n\t\t//b2Settings.b2Assert(this.m_pairBufferCount < b2_maxPairs);\r\n\r\n\t\tvar pair = this.AddPair(proxyId1, proxyId2);\r\n\r\n\t\t// If this pair is not in the pair buffer ...\r\n\t\tif (pair.IsBuffered() == false)\r\n\t\t{\r\n\t\t\t// This must be a newly added pair.\r\n\t\t\t//b2Settings.b2Assert(pair.IsFinal() == false);\r\n\r\n\t\t\t// Add it to the pair buffer.\r\n\t\t\tpair.SetBuffered();\r\n\t\t\tthis.m_pairBuffer[this.m_pairBufferCount].proxyId1 = pair.proxyId1;\r\n\t\t\tthis.m_pairBuffer[this.m_pairBufferCount].proxyId2 = pair.proxyId2;\r\n\t\t\t++this.m_pairBufferCount;\r\n\r\n\t\t\t//b2Settings.b2Assert(this.m_pairBufferCount <= this.m_pairCount);\r\n\t\t}\r\n\r\n\t\t// Confirm this pair for the subsequent call to this.Commit.\r\n\t\tpair.ClearRemoved();\r\n\r\n\t\tif (b2BroadPhase.s_validate)\r\n\t\t{\r\n\t\t\tthis.ValidateBuffer();\r\n\t\t}\r\n\t};\r\n\r\n\t// Buffer a pair for removal.\r\n\tthis.RemoveBufferedPair = function(proxyId1, proxyId2){\r\n\t\t//b2Settings.b2Assert(id1 != b2_nullProxy && id2 != b2_nullProxy);\r\n\t\t//b2Settings.b2Assert(this.m_pairBufferCount < b2_maxPairs);\r\n\r\n\t\tvar pair = this.Find(proxyId1, proxyId2);\r\n\r\n\t\tif (pair == null)\r\n\t\t{\r\n\t\t\t// The pair never existed. This is legal (due to collision filtering).\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// If this pair is not in the pair buffer ...\r\n\t\tif (pair.IsBuffered() == false)\r\n\t\t{\r\n\t\t\t// This must be an old pair.\r\n\t\t\t//b2Settings.b2Assert(pair.IsFinal() == true);\r\n\r\n\t\t\tpair.SetBuffered();\r\n\t\t\tthis.m_pairBuffer[this.m_pairBufferCount].proxyId1 = pair.proxyId1;\r\n\t\t\tthis.m_pairBuffer[this.m_pairBufferCount].proxyId2 = pair.proxyId2;\r\n\t\t\t++this.m_pairBufferCount;\r\n\r\n\t\t\t//b2Settings.b2Assert(this.m_pairBufferCount <= this.m_pairCount);\r\n\t\t}\r\n\r\n\t\tpair.SetRemoved();\r\n\r\n\t\tif (b2BroadPhase.s_validate)\r\n\t\t{\r\n\t\t\tthis.ValidateBuffer();\r\n\t\t}\r\n\t};\r\n\r\n\tthis.Commit = function(){\r\n\t\tvar i = 0;\r\n\r\n\t\tvar removeCount = 0;\r\n\r\n\t\tvar proxies = this.m_broadPhase.m_proxyPool;\r\n\r\n\t\tfor (i = 0; i < this.m_pairBufferCount; ++i)\r\n\t\t{\r\n\t\t\tvar pair = this.Find(this.m_pairBuffer[i].proxyId1, this.m_pairBuffer[i].proxyId2);\r\n\t\t\t//b2Settings.b2Assert(pair.IsBuffered());\r\n\t\t\tpair.ClearBuffered();\r\n\r\n\t\t\t//b2Settings.b2Assert(pair.proxyId1 < b2Settings.b2_maxProxies && pair.proxyId2 < b2Settings.b2_maxProxies);\r\n\r\n\t\t\tvar proxy1 = proxies[ pair.proxyId1 ];\r\n\t\t\tvar proxy2 = proxies[ pair.proxyId2 ];\r\n\r\n\t\t\t//b2Settings.b2Assert(proxy1.IsValid());\r\n\t\t\t//b2Settings.b2Assert(proxy2.IsValid());\r\n\r\n\t\t\tif (pair.IsRemoved())\r\n\t\t\t{\r\n\t\t\t\t// It is possible a pair was added then removed before a commit. Therefore,\r\n\t\t\t\t// we should be careful not to tell the user the pair was removed when the\r\n\t\t\t\t// the user didn't receive a matching add.\r\n\t\t\t\tif (pair.IsFinal() == true)\r\n\t\t\t\t{\r\n\t\t\t\t\tthis.m_callback.PairRemoved(proxy1.userData, proxy2.userData, pair.userData);\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// Store the ids so we can actually remove the pair below.\r\n\t\t\t\tthis.m_pairBuffer[removeCount].proxyId1 = pair.proxyId1;\r\n\t\t\t\tthis.m_pairBuffer[removeCount].proxyId2 = pair.proxyId2;\r\n\t\t\t\t++removeCount;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t//b2Settings.b2Assert(this.m_broadPhase.TestOverlap(proxy1, proxy2) == true);\r\n\r\n\t\t\t\tif (pair.IsFinal() == false)\r\n\t\t\t\t{\r\n\t\t\t\t\tpair.userData = this.m_callback.PairAdded(proxy1.userData, proxy2.userData);\r\n\t\t\t\t\tpair.SetFinal();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor (i = 0; i < removeCount; ++i)\r\n\t\t{\r\n\t\t\tthis.RemovePair(this.m_pairBuffer[i].proxyId1, this.m_pairBuffer[i].proxyId2);\r\n\t\t}\r\n\r\n\t\tthis.m_pairBufferCount = 0;\r\n\r\n\t\tif (b2BroadPhase.s_validate)\r\n\t\t{\r\n\t\t\tthis.ValidateTable();\r\n\t\t}\r\n\t};\r\n\r\n//private:\r\n\r\n\t// Add a pair and return the new pair. If the pair already exists,\r\n\t// no new pair is created and the old one is returned.\r\n\tthis.AddPair = function(proxyId1, proxyId2){\r\n\r\n\t\tif (proxyId1 > proxyId2){\r\n\t\t\tvar temp = proxyId1;\r\n\t\t\tproxyId1 = proxyId2;\r\n\t\t\tproxyId2 = temp;\r\n\t\t\t//b2Math.b2Swap(p1, p2);\r\n\t\t}\r\n\r\n\t\tvar hash = b2PairManager.Hash(proxyId1, proxyId2) & b2Pair.b2_tableMask;\r\n\r\n\t\t//var pairIndex = this.FindHash(proxyId1, proxyId2, hash);\r\n\t\tvar pair = pair = this.FindHash(proxyId1, proxyId2, hash);\r\n\r\n\t\tif (pair != null)\r\n\t\t{\r\n\t\t\treturn pair;\r\n\t\t}\r\n\r\n\t\t//b2Settings.b2Assert(this.m_pairCount < b2Settings.b2_maxPairs && this.m_freePair != b2_nullPair);\r\n\r\n\t\tvar pIndex = this.m_freePair;\r\n\t\tpair = this.m_pairs[pIndex];\r\n\t\tthis.m_freePair = pair.next;\r\n\r\n\t\tpair.proxyId1 = proxyId1;\r\n\t\tpair.proxyId2 = proxyId2;\r\n\t\tpair.status = 0;\r\n\t\tpair.userData = null;\r\n\t\tpair.next = this.m_hashTable[hash];\r\n\r\n\t\tthis.m_hashTable[hash] = pIndex;\r\n\r\n\t\t++this.m_pairCount;\r\n\r\n\t\treturn pair;\r\n\t};\r\n\r\n\t// Remove a pair, return the pair's userData.\r\n\tthis.RemovePair = function(proxyId1, proxyId2){\r\n\r\n\t\t//b2Settings.b2Assert(this.m_pairCount > 0);\r\n\r\n\t\tif (proxyId1 > proxyId2){\r\n\t\t\tvar temp = proxyId1;\r\n\t\t\tproxyId1 = proxyId2;\r\n\t\t\tproxyId2 = temp;\r\n\t\t\t//b2Math.b2Swap(proxyId1, proxyId2);\r\n\t\t}\r\n\r\n\t\tvar hash = b2PairManager.Hash(proxyId1, proxyId2) & b2Pair.b2_tableMask;\r\n\r\n\t\tvar node = this.m_hashTable[hash];\r\n\t\tvar pNode = null;\r\n\r\n\t\twhile (node != b2Pair.b2_nullPair)\r\n\t\t{\r\n\t\t\tif (b2PairManager.Equals(this.m_pairs[node], proxyId1, proxyId2))\r\n\t\t\t{\r\n\t\t\t\tvar index = node;\r\n\r\n\t\t\t\t//*node = this.m_pairs[*node].next;\r\n\t\t\t\tif (pNode){\r\n\t\t\t\t\tpNode.next = this.m_pairs[node].next;\r\n\t\t\t\t}\r\n\t\t\t\telse{\r\n\t\t\t\t\tthis.m_hashTable[hash] = this.m_pairs[node].next;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar pair = this.m_pairs[ index ];\r\n\t\t\t\tvar userData = pair.userData;\r\n\r\n\t\t\t\t// Scrub\r\n\t\t\t\tpair.next = this.m_freePair;\r\n\t\t\t\tpair.proxyId1 = b2Pair.b2_nullProxy;\r\n\t\t\t\tpair.proxyId2 = b2Pair.b2_nullProxy;\r\n\t\t\t\tpair.userData = null;\r\n\t\t\t\tpair.status = 0;\r\n\r\n\t\t\t\tthis.m_freePair = index;\r\n\t\t\t\t--this.m_pairCount;\r\n\t\t\t\treturn userData;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\t//node = &this.m_pairs[*node].next;\r\n\t\t\t\tpNode = this.m_pairs[node];\r\n\t\t\t\tnode = pNode.next;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t//b2Settings.b2Assert(false);\r\n\t\treturn null;\r\n\t};\r\n\r\n\tthis.Find = function(proxyId1, proxyId2){\r\n\r\n\t\tif (proxyId1 > proxyId2){\r\n\t\t\tvar temp = proxyId1;\r\n\t\t\tproxyId1 = proxyId2;\r\n\t\t\tproxyId2 = temp;\r\n\t\t\t//b2Math.b2Swap(proxyId1, proxyId2);\r\n\t\t}\r\n\r\n\t\tvar hash = b2PairManager.Hash(proxyId1, proxyId2) & b2Pair.b2_tableMask;\r\n\r\n\t\treturn this.FindHash(proxyId1, proxyId2, hash);\r\n\t};\r\n\tthis.FindHash = function(proxyId1, proxyId2, hash){\r\n\t\tvar index = this.m_hashTable[hash];\r\n\r\n\t\twhile( index != b2Pair.b2_nullPair && b2PairManager.Equals(this.m_pairs[index], proxyId1, proxyId2) == false)\r\n\t\t{\r\n\t\t\tindex = this.m_pairs[index].next;\r\n\t\t}\r\n\r\n\t\tif ( index == b2Pair.b2_nullPair )\r\n\t\t{\r\n\t\t\treturn null;\r\n\t\t}\r\n\r\n\t\t//b2Settings.b2Assert(index < b2_maxPairs);\r\n\r\n\t\treturn this.m_pairs[ index ];\r\n\t};\r\n\r\n\tthis.ValidateBuffer = function(){\r\n\t\t// DEBUG\r\n\t};\r\n\r\n\tthis.ValidateTable = function(){\r\n\t\t// DEBUG\r\n\t};\r\n});\r\n\r\n// static\r\n\t// Thomas Wang's hash, see: http:\r\nb2PairManager.Hash = function(proxyId1, proxyId2)\r\n\t{\r\n\t\tvar key = ((proxyId2 << 16) & 0xffff0000) | proxyId1;\r\n\t\tkey = ~key + ((key << 15) & 0xFFFF8000);\r\n\t\tkey = key ^ ((key >> 12) & 0x000fffff);\r\n\t\tkey = key + ((key << 2) & 0xFFFFFFFC);\r\n\t\tkey = key ^ ((key >> 4) & 0x0fffffff);\r\n\t\tkey = key * 2057;\r\n\t\tkey = key ^ ((key >> 16) & 0x0000ffff);\r\n\t\treturn key;\r\n\t};\r\nb2PairManager.Equals = function(pair, proxyId1, proxyId2)\r\n\t{\r\n\t\treturn (pair.proxyId1 == proxyId1 && pair.proxyId2 == proxyId2);\r\n\t};\r\nb2PairManager.EqualsPair = function(pair1, pair2)\r\n\t{\r\n\t\treturn pair1.proxyId1 == pair2.proxyId1 && pair1.proxyId2 == pair2.proxyId2;\r\n\t};\r\n\r\nexports = b2PairManager;\r\n","pre":true},"./src/box2d/collision/b2BufferedPair.js":{"path":"./src/box2d/collision/b2BufferedPair.js","friendlyPath":".b2BufferedPair","directory":"./src/box2d/collision/","filename":"b2BufferedPair.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\n\r\nvar src_box2d_collision_b2BufferedPair=__class__;var b2BufferedPair = exports=src_box2d_collision_b2BufferedPair(function src_box2d_collision_b2BufferedPair(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\r\n\tthis.init = function() {\r\n\t\tthis.proxyId1 = 0;\r\n\t\tthis.proxyId2 = 0;\r\n\t};\r\n});\r\n","pre":true},"./src/box2d/collision/b2Bound.js":{"path":"./src/box2d/collision/b2Bound.js","friendlyPath":".b2Bound","directory":"./src/box2d/collision/","filename":"b2Bound.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\n\r\nvar src_box2d_collision_b2Bound=__class__;var b2Bound = exports=src_box2d_collision_b2Bound(function src_box2d_collision_b2Bound(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\tthis.init = function() {\r\n\t\tthis.value = 0;\r\n\t\tthis.proxyId = 0;\r\n\t\tthis.stabbingCount = 0;\r\n\t};\r\n\r\n\tthis.IsLower = function(){ return (this.value & 1) == 0; };\r\n\tthis.IsUpper = function(){ return (this.value & 1) == 1; };\r\n\tthis.Swap = function(b){\r\n\t\tvar tempValue = this.value;\r\n\t\tvar tempProxyId = this.proxyId;\r\n\t\tvar tempStabbingCount = this.stabbingCount;\r\n\r\n\t\tthis.value = b.value;\r\n\t\tthis.proxyId = b.proxyId;\r\n\t\tthis.stabbingCount = b.stabbingCount;\r\n\r\n\t\tb.value = tempValue;\r\n\t\tb.proxyId = tempProxyId;\r\n\t\tb.stabbingCount = tempStabbingCount;\r\n\t};\r\n});\r\n","pre":true},"./src/box2d/collision/b2Proxy.js":{"path":"./src/box2d/collision/b2Proxy.js","friendlyPath":".b2Proxy","directory":"./src/box2d/collision/","filename":"b2Proxy.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\njsio(\"import .b2BroadPhase as b2BroadPhase\");\r\n\r\nvar src_box2d_collision_b2Proxy=__class__;var b2Proxy = exports=src_box2d_collision_b2Proxy(function src_box2d_collision_b2Proxy(){return this.init&&this.init.apply(this,arguments)}, function() {\r\n\tthis.GetNext = function(){ return this.lowerBounds[0]; };\r\n\tthis.SetNext = function(next) { this.lowerBounds[0] = next /*& 0x0000ffff*/; };\r\n\r\n\tthis.IsValid = function(){ return this.overlapCount != b2BroadPhase.b2_invalid; };\r\n\r\n\tthis.lowerBounds = [/*uint*/(0), /*uint*/(0)];\r\n\tthis.upperBounds = [/*uint*/(0), /*uint*/(0)];\r\n\tthis.overlapCount = 0;\r\n\tthis.timeStamp = 0;\r\n\r\n\tthis.userData = null;\r\n\r\n\tthis.init = function() {\r\n\t\t// initialize instance variables for references\r\n\t\tthis.lowerBounds = [/*uint*/(0), /*uint*/(0)];\r\n\t\tthis.upperBounds = [/*uint*/(0), /*uint*/(0)];\r\n\t};\r\n});\r\n","pre":true},"./src/box2d/collision/b2BoundValues.js":{"path":"./src/box2d/collision/b2BoundValues.js","friendlyPath":".b2BoundValues","directory":"./src/box2d/collision/","filename":"b2BoundValues.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\n\r\nvar src_box2d_collision_b2BoundValues=__class__;var b2BoundValues = exports=src_box2d_collision_b2BoundValues(function src_box2d_collision_b2BoundValues(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\r\n\tthis.init = function() {\r\n\t\t// initialize instance variables for references\r\n\t\tthis.lowerValues = [0,0];\r\n\t\tthis.upperValues = [0,0];\r\n\t};\r\n});\r\n","pre":true},"./src/demos/util.js":{"path":"./src/demos/util.js","friendlyPath":"src.demos.util","directory":"./src/demos/","filename":"util.js","src":"\r\njsio(\"import ..box2d.common.math.b2Math as b2Math\");\r\njsio(\"import ..box2d.common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import ..box2d.dynamics.joints.b2Joint as b2Joint\");\r\njsio(\"import ..box2d.dynamics.joints.b2RevoluteJointDef as b2RevoluteJointDef\");\r\njsio(\"import ..box2d.dynamics.b2BodyDef as b2BodyDef\");\r\njsio(\"import ..box2d.collision.shapes.b2CircleDef as b2CircleDef\");\r\njsio(\"import ..box2d.collision.shapes.b2PolyDef as b2PolyDef\");\r\njsio(\"import ..box2d.collision.shapes.b2Shape as b2Shape\");\r\njsio(\"import ..box2d.collision.shapes.b2BoxDef as b2BoxDef\");\r\n\r\nb2Util=__class__;var b2Util=b2Util(function b2Util(){return this.init&&this.init.apply(this,arguments)},function() {});;\r\n\r\nb2Util.createCircle = function(world, x, y, rad, fixed) {\r\n\tvar ballSd = new b2CircleDef();\r\n\tif (!fixed) ballSd.density = 1.0;\r\n\tballSd.radius = rad || 10;\r\n\tballSd.restitution = 0.2;\r\n\tvar ballBd = new b2BodyDef();\r\n\tballBd.AddShape(ballSd);\r\n\tballBd.position.Set(x,y);\r\n\treturn world.CreateBody(ballBd);\r\n};\r\n\r\nb2Util.createRect = function(world, x, y, width, height, fixed) {\r\n\tif (typeof(fixed) == 'undefined') fixed = true;\r\n\tvar boxSd = new b2BoxDef();\r\n\tif (!fixed) boxSd.density = 1.0;\r\n\tboxSd.extents.Set(width, height);\r\n\tvar boxBd = new b2BodyDef();\r\n\tboxBd.AddShape(boxSd);\r\n\tboxBd.position.Set(x,y);\r\n\treturn world.CreateBody(boxBd)\r\n};\r\n\r\nb2Util.createPoly = function(world, x, y, points, fixed) {\r\n\tvar polySd = new b2PolyDef();\r\n\tif (!fixed) polySd.density = 1.0;\r\n\tpolySd.vertexCount = points.length;\r\n\tfor (var i = 0; i < points.length; i++) {\r\n\t\tpolySd.vertices[i].Set(points[i][0], points[i][1]);\r\n\t}\r\n\tvar polyBd = new b2BodyDef();\r\n\tpolyBd.AddShape(polySd);\r\n\tpolyBd.position.Set(x,y);\r\n\treturn world.CreateBody(polyBd)\r\n};\r\n\r\nb2Util.drawJoint = function(world, joint, context) {\r\n\tvar b1 = joint.m_body1;\r\n\tvar b2 = joint.m_body2;\r\n\tvar x1 = b1.m_position;\r\n\tvar x2 = b2.m_position;\r\n\tvar p1 = joint.GetAnchor1();\r\n\tvar p2 = joint.GetAnchor2();\r\n\tcontext.strokeStyle = '#00eeee';\r\n\tcontext.beginPath();\r\n\tswitch (joint.m_type) {\r\n\tcase b2Joint.e_distanceJoint:\r\n\t\tcontext.moveTo(p1.x, p1.y);\r\n\t\tcontext.lineTo(p2.x, p2.y);\r\n\t\tbreak;\r\n\r\n\tcase b2Joint.e_pulleyJoint:\r\n\t\t// TODO\r\n\t\tbreak;\r\n\r\n\tdefault:\r\n\t\tif (b1 == world.m_groundBody) {\r\n\t\t\tcontext.moveTo(p1.x, p1.y);\r\n\t\t\tcontext.lineTo(x2.x, x2.y);\r\n\t\t}\r\n\t\telse if (b2 == world.m_groundBody) {\r\n\t\t\tcontext.moveTo(p1.x, p1.y);\r\n\t\t\tcontext.lineTo(x1.x, x1.y);\r\n\t\t}\r\n\t\telse {\r\n\t\t\tcontext.moveTo(x1.x, x1.y);\r\n\t\t\tcontext.lineTo(p1.x, p1.y);\r\n\t\t\tcontext.lineTo(x2.x, x2.y);\r\n\t\t\tcontext.lineTo(p2.x, p2.y);\r\n\t\t}\r\n\t\tbreak;\r\n\t}\r\n\tcontext.stroke();\r\n}\r\n\r\nb2Util.drawShape = function(shape, context) {\r\n\tcontext.strokeStyle = '#ffffff';\r\n\tcontext.beginPath();\r\n\tswitch (shape.m_type) {\r\n\tcase b2Shape.e_circleShape:\r\n\t\t{\r\n\t\t\tvar circle = shape;\r\n\t\t\tvar pos = circle.m_position;\r\n\t\t\tvar r = circle.m_radius;\r\n\t\t\tvar segments = 16.0;\r\n\t\t\tvar theta = 0.0;\r\n\t\t\tvar dtheta = 2.0 * Math.PI / segments;\r\n\t\t\t// draw circle\r\n\t\t\tcontext.moveTo(pos.x + r, pos.y);\r\n\t\t\tfor (var i = 0; i < segments; i++) {\r\n\t\t\t\tvar d = new b2Vec2(r * Math.cos(theta), r * Math.sin(theta));\r\n\t\t\t\tvar v = b2Math.AddVV(pos, d);\r\n\t\t\t\tcontext.lineTo(v.x, v.y);\r\n\t\t\t\ttheta += dtheta;\r\n\t\t\t}\r\n\t\t\tcontext.lineTo(pos.x + r, pos.y);\r\n\t\r\n\t\t\t// draw radius\r\n\t\t\tcontext.moveTo(pos.x, pos.y);\r\n\t\t\tvar ax = circle.m_R.col1;\r\n\t\t\tvar pos2 = new b2Vec2(pos.x + r * ax.x, pos.y + r * ax.y);\r\n\t\t\tcontext.lineTo(pos2.x, pos2.y);\r\n\t\t}\r\n\t\tbreak;\r\n\tcase b2Shape.e_polyShape:\r\n\t\t{\r\n\t\t\tvar poly = shape;\r\n\t\t\tvar tV = b2Math.AddVV(poly.m_position, b2Math.b2MulMV(poly.m_R, poly.m_vertices[0]));\r\n\t\t\tcontext.moveTo(tV.x, tV.y);\r\n\t\t\tfor (var i = 0; i < poly.m_vertexCount; i++) {\r\n\t\t\t\tvar v = b2Math.AddVV(poly.m_position, b2Math.b2MulMV(poly.m_R, poly.m_vertices[i]));\r\n\t\t\t\tcontext.lineTo(v.x, v.y);\r\n\t\t\t}\r\n\t\t\tcontext.lineTo(tV.x, tV.y);\r\n\t\t}\r\n\t\tbreak;\r\n\t}\r\n\tcontext.stroke();\r\n}\r\nb2Util.drawWorld = function(world, context) {\r\n\tfor (var j = world.m_jointList; j; j = j.m_next) {\r\n\t\tb2Util.drawJoint(world, j, context);\r\n\t}\r\n\tfor (var b = world.m_bodyList; b; b = b.m_next) {\r\n\t\tfor (var s = b.GetShapeList(); s != null; s = s.GetNext()) {\r\n\t\t\tb2Util.drawShape(s, context);\r\n\t\t}\r\n\t}\r\n}\r\nb2Util.initWorld = function(world) {\r\n\tb2Util.createCircle(world, 100, 300, 25, true);\r\n\tb2Util.createPoly(world, 100, 100, [[0, 0], [10, 30], [-10, 30]], true);\r\n\tb2Util.createPoly(world, 150, 150, [[0, 0], [10, 30], [-10, 30]], true);\r\n\tvar pendulum = b2Util.createRect(world, 150, 100, 20, 20, false);\r\n\tvar jointDef = new b2RevoluteJointDef();\r\n\tjointDef.body1 = pendulum;\r\n\tjointDef.body2 = world.GetGroundBody();\r\n\tjointDef.anchorPoint = pendulum.GetCenterPosition();\r\n\tworld.CreateJoint(jointDef);\r\n\r\n\tvar seesaw = b2Util.createPoly(world, 250, 200, [[0, 0], [50, 30], [-50, 30]]);\r\n\tjointDef.body1 = seesaw;\r\n\tjointDef.anchorPoint = seesaw.GetCenterPosition();\r\n\tworld.CreateJoint(jointDef);\r\n};\r\n\r\nexports = b2Util;\r\n","pre":true},"./src/box2d/dynamics/joints/b2RevoluteJointDef.js":{"path":"./src/box2d/dynamics/joints/b2RevoluteJointDef.js","friendlyPath":"..box2d.dynamics.joints.b2RevoluteJointDef","directory":"./src/box2d/dynamics/joints/","filename":"b2RevoluteJointDef.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\njsio(\"import ...common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import .b2Joint as b2Joint\");\r\njsio(\"import .b2JointDef as b2JointDef\");\r\n\r\nvar src_box2d_dynamics_joints_b2RevoluteJointDef=__class__;var b2RevoluteJointDef = exports=src_box2d_dynamics_joints_b2RevoluteJointDef(function src_box2d_dynamics_joints_b2RevoluteJointDef(){return this.init&&this.init.apply(this,arguments)},b2JointDef, function(supr){\r\n\tthis.init = function()\r\n\t{\r\n\t\tsupr(this, 'init');\r\n\t\t// The constructor for b2JointDef\r\n\t\tthis.type = b2Joint.e_unknownJoint;\r\n\t\tthis.userData = null;\r\n\t\tthis.body1 = null;\r\n\t\tthis.body2 = null;\r\n\t\tthis.collideConnected = false;\r\n\t\t//\r\n\r\n\t\tthis.type = b2Joint.e_revoluteJoint;\r\n\t\tthis.anchorPoint = new b2Vec2(0.0, 0.0);\r\n\t\tthis.lowerAngle = 0.0;\r\n\t\tthis.upperAngle = 0.0;\r\n\t\tthis.motorTorque = 0.0;\r\n\t\tthis.motorSpeed = 0.0;\r\n\t\tthis.enableLimit = false;\r\n\t\tthis.enableMotor = false;\r\n\t};\r\n});\r\n\r\n","pre":true},"./src/box2d/dynamics/joints/b2JointDef.js":{"path":"./src/box2d/dynamics/joints/b2JointDef.js","friendlyPath":".b2JointDef","directory":"./src/box2d/dynamics/joints/","filename":"b2JointDef.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\njsio(\"import .b2Joint as b2Joint\");\r\n\r\nvar src_box2d_dynamics_joints_b2JointDef=__class__;var b2JointDef = exports=src_box2d_dynamics_joints_b2JointDef(function src_box2d_dynamics_joints_b2JointDef(){return this.init&&this.init.apply(this,arguments)},function() {\r\n\tthis.init = function()\r\n\t{\r\n\t\tthis.type = b2Joint.e_unknownJoint;\r\n\t\tthis.userData = null;\r\n\t\tthis.body1 = null;\r\n\t\tthis.body2 = null;\r\n\t\tthis.collideConnected = false;\r\n\t};\r\n});\r\n","pre":true},"./src/box2d/collision/shapes/b2CircleDef.js":{"path":"./src/box2d/collision/shapes/b2CircleDef.js","friendlyPath":"..box2d.collision.shapes.b2CircleDef","directory":"./src/box2d/collision/shapes/","filename":"b2CircleDef.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\n\r\n\r\njsio(\"import .b2ShapeDef as b2ShapeDef\");\r\njsio(\"import .b2Shape as b2Shape\");\r\njsio(\"import ...common.math.b2Vec2 as b2Vec2\");\r\n\r\n\r\nvar src_box2d_collision_shapes_b2CircleDef=__class__;var b2CircleDef = exports=src_box2d_collision_shapes_b2CircleDef(function src_box2d_collision_shapes_b2CircleDef(){return this.init&&this.init.apply(this,arguments)},b2ShapeDef, function(supr) {\r\n\tthis.init = function()\r\n\t{\r\n\t\tsupr(this, 'init');\r\n\t\t// The constructor for b2ShapeDef\r\n\t\tthis.type = b2Shape.e_unknownShape;\r\n\t\tthis.userData = null;\r\n\t\tthis.localPosition = new b2Vec2(0.0, 0.0);\r\n\t\tthis.localRotation = 0.0;\r\n\t\tthis.friction = 0.2;\r\n\t\tthis.restitution = 0.0;\r\n\t\tthis.density = 0.0;\r\n\t\tthis.categoryBits = 0x0001;\r\n\t\tthis.maskBits = 0xFFFF;\r\n\t\tthis.groupIndex = 0;\t\r\n\t\t//\r\n\r\n\t\tthis.type = b2Shape.e_circleShape;\r\n\t\tthis.radius = 1.0;\r\n\t};\r\n});\r\n\r\n","pre":true},"./src/box2d/collision/shapes/b2PolyDef.js":{"path":"./src/box2d/collision/shapes/b2PolyDef.js","friendlyPath":"..box2d.collision.shapes.b2PolyDef","directory":"./src/box2d/collision/shapes/","filename":"b2PolyDef.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\n\r\njsio(\"import ...common.b2Settings as b2Settings\");\r\njsio(\"import ...common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import .b2ShapeDef as b2ShapeDef\");\r\njsio(\"import .b2Shape as b2Shape\");\r\n\r\n\r\nvar src_box2d_collision_shapes_b2PolyDef=__class__;var b2PolyDef = exports=src_box2d_collision_shapes_b2PolyDef(function src_box2d_collision_shapes_b2PolyDef(){return this.init&&this.init.apply(this,arguments)},b2ShapeDef, function(supr) {\r\n\tthis.init = function(){\r\n\t\tsupr(this, 'init');\r\n\t\t// The constructor for b2ShapeDef\r\n\t\tthis.type = b2Shape.e_unknownShape;\r\n\t\tthis.userData = null;\r\n\t\tthis.localPosition = new b2Vec2(0.0, 0.0);\r\n\t\tthis.localRotation = 0.0;\r\n\t\tthis.friction = 0.2;\r\n\t\tthis.restitution = 0.0;\r\n\t\tthis.density = 0.0;\r\n\t\tthis.categoryBits = 0x0001;\r\n\t\tthis.maskBits = 0xFFFF;\r\n\t\tthis.groupIndex = 0;\t\r\n\t\t//\r\n\r\n\t\t// initialize instance variables for references\r\n\t\tthis.vertices = new Array(b2Settings.b2_maxPolyVertices);\r\n\t\t//\r\n\r\n\t\tthis.type = b2Shape.e_polyShape;\r\n\t\tthis.vertexCount = 0;\r\n\r\n\t\tfor (var i = 0; i < b2Settings.b2_maxPolyVertices; i++){\r\n\t\t\tthis.vertices[i] = new b2Vec2();\r\n\t\t}\r\n\t};\r\n});\r\n","pre":true},"./src/demos/crank.js":{"path":"./src/demos/crank.js","friendlyPath":"src.demos.crank","directory":"./src/demos/","filename":"crank.js","src":"\r\njsio(\"import ..box2d.common.math.b2Math as b2Math\");\r\njsio(\"import ..box2d.common.math.b2Mat22 as b2Mat22\");\r\njsio(\"import ..box2d.common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import ..box2d.dynamics.joints.b2Joint as b2Joint\");\r\njsio(\"import ..box2d.dynamics.joints.b2PrismaticJointDef as b2PrismaticJointDef\");\r\njsio(\"import ..box2d.dynamics.joints.b2RevoluteJointDef as b2RevoluteJointDef\");\r\njsio(\"import ..box2d.dynamics.b2BodyDef as b2BodyDef\");\r\njsio(\"import ..box2d.collision.shapes.b2CircleDef as b2CircleDef\");\r\njsio(\"import ..box2d.collision.shapes.b2PolyDef as b2PolyDef\");\r\njsio(\"import ..box2d.collision.shapes.b2Shape as b2Shape\");\r\njsio(\"import ..box2d.collision.shapes.b2BoxDef as b2BoxDef\");\r\n\r\ncrank=__class__;var crank=crank(function crank(){return this.init&&this.init.apply(this,arguments)},function() {} );\r\n\r\ncrank.initWorld = function(world) {\r\n\tvar ground = world.m_groundBody;\r\n\r\n\t// Define crank.\r\n\tvar sd = new b2BoxDef();\r\n\tsd.extents.Set(5, 25);\r\n\tsd.density = 1.0;\r\n\r\n\tvar bd = new b2BodyDef();\r\n\tbd.AddShape(sd);\r\n\t\r\n\tvar rjd = new b2RevoluteJointDef();\r\n\r\n\tvar prevBody = ground;\r\n\tvar x = 150;\r\n\r\n\tbd.position.Set(x, 210);\r\n\tvar body = world.CreateBody(bd);\r\n\r\n\trjd.anchorPoint.Set(x, 235);\r\n\trjd.body1 = prevBody;\r\n\trjd.body2 = body;\r\n\trjd.motorSpeed = -1.0 * Math.PI;\r\n\trjd.motorTorque = 500000000.0;\r\n\trjd.enableMotor = true;\r\n\tworld.CreateJoint(rjd);\r\n\r\n\tprevBody = body;\r\n\r\n\t// Define follower.\r\n\tsd.extents.Set(5, 45);\r\n\tbd.position.Set(x, 140);\r\n\tbody = world.CreateBody(bd);\r\n\r\n\trjd.anchorPoint.Set(x, 185);\r\n\trjd.body1 = prevBody;\r\n\trjd.body2 = body;\r\n\trjd.enableMotor = false;\r\n\tworld.CreateJoint(rjd);\r\n\r\n\tprevBody = body;\r\n\r\n\t// Define piston\r\n\tsd.extents.Set(20, 20);\r\n\tbd.position.Set(x, 95);\r\n\tbody = world.CreateBody(bd);\r\n\r\n\trjd.anchorPoint.Set(x, 95);\r\n\trjd.body1 = prevBody;\r\n\trjd.body2 = body;\r\n\tworld.CreateJoint(rjd);\r\n\r\n\tvar pjd = new b2PrismaticJointDef();\r\n\tpjd.anchorPoint.Set(x, 95);\r\n\tpjd.body1 = ground;\r\n\tpjd.body2 = body;\r\n\tpjd.axis.Set(0.0, 1.0);\r\n\tpjd.motorSpeed = 0.0; // joint friction\r\n\tpjd.motorForce = 100000.0;\r\n\tpjd.enableMotor = true;\r\n\r\n\tworld.CreateJoint(pjd);\r\n\r\n\t// Create a payload\r\n\tsd.density = 2.0;\r\n\tbd.position.Set(x, 10);\r\n\tworld.CreateBody(bd);\r\n}\r\n\r\nexports = crank;\r\n","pre":true},"./src/box2d/dynamics/joints/b2PrismaticJointDef.js":{"path":"./src/box2d/dynamics/joints/b2PrismaticJointDef.js","friendlyPath":"..box2d.dynamics.joints.b2PrismaticJointDef","directory":"./src/box2d/dynamics/joints/","filename":"b2PrismaticJointDef.js","src":"﻿/*\r\n* Copyright (c) 2006-2007 Erin Catto http:\r\n*\r\n* This software is provided 'as-is', without any express or implied\r\n* warranty.  In no event will the authors be held liable for any damages\r\n* arising from the use of this software.\r\n* Permission is granted to anyone to use this software for any purpose,\r\n* including commercial applications, and to alter it and redistribute it\r\n* freely, subject to the following restrictions:\r\n* 1. The origin of this software must not be misrepresented; you must not\r\n* claim that you wrote the original software. If you use this software\r\n* in a product, an acknowledgment in the product documentation would be\r\n* appreciated but is not required.\r\n* 2. Altered source versions must be plainly marked, and must not be\r\n* misrepresented the original software.\r\n* 3. This notice may not be removed or altered from any source distribution.\r\n*/\r\n\r\njsio(\"import ...common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import .b2Joint as b2Joint\");\r\njsio(\"import .b2JointDef as b2JointDef\");\r\n\r\nvar src_box2d_dynamics_joints_b2PrismaticJointDef=__class__;var b2PrismaticJointDef = exports=src_box2d_dynamics_joints_b2PrismaticJointDef(function src_box2d_dynamics_joints_b2PrismaticJointDef(){return this.init&&this.init.apply(this,arguments)},b2JointDef, function(supr) {\r\n\tthis.init = function()\r\n\t{\r\n\t\tsupr(this, 'init');\r\n\t\t// The constructor for b2JointDef\r\n\t\tthis.type = b2Joint.e_unknownJoint;\r\n\t\tthis.userData = null;\r\n\t\tthis.body1 = null;\r\n\t\tthis.body2 = null;\r\n\t\tthis.collideConnected = false;\r\n\t\t//\r\n\r\n\t\tthis.type = b2Joint.e_prismaticJoint;\r\n\t\tthis.anchorPoint = new b2Vec2(0.0, 0.0);\r\n\t\tthis.axis = new b2Vec2(0.0, 0.0);\r\n\t\tthis.lowerTranslation = 0.0;\r\n\t\tthis.upperTranslation = 0.0;\r\n\t\tthis.motorForce = 0.0;\r\n\t\tthis.motorSpeed = 0.0;\r\n\t\tthis.enableLimit = false;\r\n\t\tthis.enableMotor = false;\r\n\t};\r\n});\r\n","pre":true},"./src/demos/compound.js":{"path":"./src/demos/compound.js","friendlyPath":"src.demos.compound","directory":"./src/demos/","filename":"compound.js","src":"\r\njsio(\"import ..box2d.common.math.b2Math as b2Math\");\r\njsio(\"import ..box2d.common.math.b2Mat22 as b2Mat22\");\r\njsio(\"import ..box2d.common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import ..box2d.dynamics.joints.b2Joint as b2Joint\");\r\njsio(\"import ..box2d.dynamics.joints.b2RevoluteJointDef as b2RevoluteJointDef\");\r\njsio(\"import ..box2d.dynamics.b2BodyDef as b2BodyDef\");\r\njsio(\"import ..box2d.collision.shapes.b2CircleDef as b2CircleDef\");\r\njsio(\"import ..box2d.collision.shapes.b2PolyDef as b2PolyDef\");\r\njsio(\"import ..box2d.collision.shapes.b2Shape as b2Shape\");\r\njsio(\"import ..box2d.collision.shapes.b2BoxDef as b2BoxDef\");\r\n\r\ncompound=__class__;var compound=compound(function compound(){return this.init&&this.init.apply(this,arguments)},function() {});\r\n\r\ncompound.createCompoundCircle = function(world, x, y) {\r\n\tvar ballSd1 = new b2CircleDef();\r\n\tballSd1.density = 1.0;\r\n\tballSd1.radius = 20;\r\n\tballSd1.restitution = 0.2;\r\n\tballSd1.localPosition.Set(-20, 0);\r\n\tvar ballSd2 = new b2CircleDef();\r\n\tballSd2.density = 1.0;\r\n\tballSd2.radius = 20;\r\n\tballSd2.restitution = 0.2;\r\n\tballSd2.localPosition.Set(20, 0);\r\n\tvar ballBd = new b2BodyDef();\r\n\tballBd.AddShape(ballSd1);\r\n\tballBd.AddShape(ballSd2);\r\n\tballBd.position.Set(x, y);\r\n\treturn world.CreateBody(ballBd);\r\n}\r\n\r\ncompound.createCompoundPoly = function(world, x, y) {\r\n\tvar points = [[-30, 0], [30, 0], [0, 15]];\r\n\tvar polySd1 = new b2PolyDef();\r\n\tpolySd1.vertexCount = points.length;\r\n\tfor (var i = 0; i < points.length; i++) {\r\n\t\tpolySd1.vertices[i].Set(points[i][0], points[i][1]);\r\n\t}\r\n\tpolySd1.localRotation = 0.3524 * Math.PI;\r\n\tvar R1 = new b2Mat22(polySd1.localRotation);\r\n\tpolySd1.localPosition = b2Math.b2MulMV(R1, new b2Vec2(30, 0));\r\n\tpolySd1.density = 1.0;\r\n\tvar polySd2 = new b2PolyDef();\r\n\tpolySd2.vertexCount = points.length;\r\n\tfor (var i = 0; i < points.length; i++) {\r\n\t\tpolySd2.vertices[i].Set(points[i][0], points[i][1]);\r\n\t}\r\n\tpolySd2.localRotation = -0.3524 * Math.PI;\r\n\tvar R2 = new b2Mat22(polySd2.localRotation);\r\n\tpolySd2.localPosition = b2Math.b2MulMV(R2, new b2Vec2(-30, 0));\r\n\tvar polyBd = new b2BodyDef();\r\n\tpolyBd.AddShape(polySd1);\r\n\tpolyBd.AddShape(polySd2);\r\n\tpolyBd.position.Set(x,y);\r\n\treturn world.CreateBody(polyBd)\r\n}\r\n\r\ncompound.initWorld = function(world) {\r\n\tvar i;\r\n\tfor (i = 1; i <= 4; i++) {\r\n\t\tcompound.createCompoundPoly(world, 50 + 3 * Math.random(), 40 * i);\r\n\t}\r\n\tfor (i = 1; i <= 4; i++) {\r\n\t\tcompound.createCompoundCircle(world, 200 + 3 * Math.random(), 45 * i);\r\n\t}\r\n}\r\n\r\nexports = compound; \r\n","pre":true},"./src/demos/pendulum.js":{"path":"./src/demos/pendulum.js","friendlyPath":"src.demos.pendulum","directory":"./src/demos/","filename":"pendulum.js","src":"jsio(\"import ..box2d.common.math.b2Math as b2Math\");\r\njsio(\"import ..box2d.common.math.b2Mat22 as b2Mat22\");\r\njsio(\"import ..box2d.common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import ..box2d.dynamics.joints.b2Joint as b2Joint\");\r\njsio(\"import ..box2d.dynamics.joints.b2PrismaticJointDef as b2PrismaticJointDef\");\r\njsio(\"import ..box2d.dynamics.joints.b2RevoluteJointDef as b2RevoluteJointDef\");\r\njsio(\"import ..box2d.dynamics.b2BodyDef as b2BodyDef\");\r\njsio(\"import ..box2d.collision.shapes.b2CircleDef as b2CircleDef\");\r\njsio(\"import ..box2d.collision.shapes.b2PolyDef as b2PolyDef\");\r\njsio(\"import ..box2d.collision.shapes.b2Shape as b2Shape\");\r\njsio(\"import ..box2d.collision.shapes.b2BoxDef as b2BoxDef\");\r\n\r\npendulum=__class__;var pendulum=pendulum(function pendulum(){return this.init&&this.init.apply(this,arguments)},function() {});\r\n\r\npendulum.createCircle = function(world, x, y, rad, fixed) {\r\n\tvar ballSd = new b2CircleDef();\r\n\tif (!fixed) ballSd.density = 1.0;\r\n\tballSd.radius = rad || 10;\r\n\tballSd.restitution = 0.2;\r\n\tvar ballBd = new b2BodyDef();\r\n\tballBd.AddShape(ballSd);\r\n\tballBd.position.Set(x,y);\r\n\treturn world.CreateBody(ballBd);\r\n};\r\n\r\npendulum.initWorld = function(world) {\r\n\tvar ground = world.GetGroundBody();\r\n\tvar jointDef = new b2RevoluteJointDef();\r\n\tvar anchorPt1 = 70;\r\n\tvar l = 100;\r\n\tvar x = 150;\r\n\tvar y = 300;\r\n\tvar radius = 20;\r\n\r\n\t// swinging pendulum\r\n\tjointDef.anchorPoint.Set(x - radius*2, y-l);\r\n\tjointDef.body1 = ground;\r\n\tjointDef.body2 = pendulum.createCircle(world, x-radius*2-l, y-l, radius);\r\n\tworld.CreateJoint(jointDef);\r\n\r\n\t// stationary pendulums\r\n\tfor (var i = 0; i < 2; i++) {\r\n\t\tx = 150+(radius*2)*i;\r\n\t\tjointDef.anchorPoint.Set(x, y-l);\r\n\t\tjointDef.body1 = ground;\r\n\t\tjointDef.body2 = pendulum.createCircle(world, x, y, radius);\r\n\t\tworld.CreateJoint(jointDef);\r\n\t}\r\n}\r\n\r\nexports = pendulum;\r\n","pre":true},"./src/demos/stack.js":{"path":"./src/demos/stack.js","friendlyPath":"src.demos.stack","directory":"./src/demos/","filename":"stack.js","src":"\r\njsio(\"import ..box2d.common.math.b2Math as b2Math\");\r\njsio(\"import ..box2d.common.math.b2Mat22 as b2Mat22\");\r\njsio(\"import ..box2d.common.math.b2Vec2 as b2Vec2\");\r\njsio(\"import ..box2d.dynamics.joints.b2Joint as b2Joint\");\r\njsio(\"import ..box2d.dynamics.joints.b2PrismaticJointDef as b2PrismaticJointDef\");\r\njsio(\"import ..box2d.dynamics.joints.b2RevoluteJointDef as b2RevoluteJointDef\");\r\njsio(\"import ..box2d.dynamics.b2BodyDef as b2BodyDef\");\r\njsio(\"import ..box2d.collision.shapes.b2CircleDef as b2CircleDef\");\r\njsio(\"import ..box2d.collision.shapes.b2PolyDef as b2PolyDef\");\r\njsio(\"import ..box2d.collision.shapes.b2Shape as b2Shape\");\r\njsio(\"import ..box2d.collision.shapes.b2BoxDef as b2BoxDef\");\r\n\r\nstack=__class__;var stack=stack(function stack(){return this.init&&this.init.apply(this,arguments)},function() {});\r\n\r\nstack.initWorld = function(world) {\r\n\tvar sd = new b2BoxDef();\r\n\tvar bd = new b2BodyDef();\r\n\tbd.AddShape(sd);\r\n\tsd.density = 1.0;\r\n\tsd.friction = 0.5;\r\n\tsd.extents.Set(10, 10);\r\n\r\n\tvar x = 150;\r\n\tvar y = 430;\r\n\tvar i;\r\n\tfor (i = 0; i < 8; i++) {\r\n\t\tbd.position.Set(x-Math.random()*2-1, (y-5-i*22));\r\n\t\tworld.CreateBody(bd);\r\n\t}\r\n\tfor (i = 0; i < 8; i++) {\r\n\t\tbd.position.Set(x-100-Math.random()*5+i, (y-5-i*22));\r\n\t\tworld.CreateBody(bd);\r\n\t}\r\n\tfor (i = 0; i < 8; i++) {\r\n\t\tbd.position.Set(x+100+Math.random()*5-i, (y-5-i*22));\r\n\t\tworld.CreateBody(bd);\r\n\t}\r\n}\r\n\r\nexports = stack;\r\n\r\n\r\n","pre":true}});; jsio("import gc.browser.launchClient");